Configuring an ECMP Mode
========================

Configuring an ECMP Mode

#### Context

Devices support load balancing for IP and tunnel packets.


#### Procedure

1. Enter the system view.
   
   
   ```
   [system-view](cmdqueryname=system-view)
   ```
2. Enter the ECMP view.
   
   
   ```
   [load-balance ecmp](cmdqueryname=load-balance+ecmp)
   ```
3. Configure an ECMP mode.
   
   
   
   **Table 1** Configuring an ECMP mode
   | Operation | Command | Description |
   | --- | --- | --- |
   | Configure a load balancing mode for IP packets. | [**ip**](cmdqueryname=ip) [ **src-ip** | **dst-ip** | **vlan** | **l4-src-port** | **l4-dst-port** | **protocol** | **flow-label** | **src-interface**] \* | IP packets can be balanced based on any combination of a source IP address, destination IP address, VLAN ID, transport-layer source port, transport-layer destination port, protocol, flow label, and physical source port. The device uses the hash algorithm to calculate a value based on the configured combination and selects a link to forward packets based on the value. |
   | Configure a hash mode for load balancing for the CE6866, CE6860-SAN, CE6866K, CE6860-HAM, CE8851-32CQ8DQ-P, CE8850-SAN, CE8851K, CE8850-HAM . | [**hashmode**](cmdqueryname=hashmode) *value1* | You can select an appropriate algorithm for load balancing based on a traffic model. Different load balancing results will be achieved using different hash algorithms. You can select an appropriate hash mode for load balancing based on a traffic model. The polynomial calculation result is closely related to the change rules of packet characteristics, number of ECMP members, and number of packets. The following conclusions are for reference only: * To configure distribution of packets with the same source and destination addresses, you are advised to set the hash mode to 1. * If the source IP address changes, you are advised to set the hash mode to 0 or 2. * If the source port changes, you are advised to set the hash mode to 0 or 2. * If the destination port changes, you are advised to set the hash mode to 0 or 2. * If the source and destination IP addresses change, you are advised to set the hash mode to 0 or 2. * If the source and destination ports change, you are advised to set the hash mode to 0 or 2. In conclusion, you are advised to set the hash mode to 0 or 2 unless you need to configure distribution of packets with the same source and destination addresses. |
   | Configure a hash mode for load balancing for the CE6820H, CE6820H-K, CE6863H, CE6863H-K, CE6881H, CE6881H-K, CE6820S. | [**hashmode**](cmdqueryname=hashmode) *value2* | You can select an appropriate algorithm for load balancing based on a traffic model. Different load balancing results will be achieved using different hash algorithms. You can select an appropriate hash mode for load balancing based on a traffic model. The polynomial calculation result is closely related to the change rules of packet characteristics, number of ECMP members, and number of packets. The following conclusions are for reference only: * To configure distribution of packets with the same source and destination addresses, you are advised to set the hash mode to 1. * If per-packet load balancing is required, you are advised to set the hash mode to 2. |
   | Configure a hash mode for load balancing for the CE8855, CE8851-32CQ4BQ, CE6855-48XS8CQ, CE6885, CE6885-SAN, CE6885-LL, CE6885-T, CE6863E-48S8CQ. | [**hashmode**](cmdqueryname=hashmode)  **{ overlay|underlay }** *value3* | In ECMP load balancing scenarios, if the hash result is uneven, you can run the **hashmode** command to change the hash mode, making the result more even. Different load balancing results will be achieved using different hash algorithms. You can select an appropriate hash mode for load balancing based on a traffic model.  Overlay load balancing:  If the destination IP address changes, you are advised to set the hash mode to 2 or 14.  If the source IP address changes, you are advised to set the hash mode to 4 or 15.  If the source port changes, you are advised to set the hash mode to 0.  If the destination port changes, you are advised to set the hash mode to 15.  If the source and destination IP addresses change, you are advised to set the hash mode to 1.  If the source and destination ports change, you are advised to set the hash mode to 15.  Underlay load balancing:  If the destination IP address changes, you are advised to set the hash mode to 3 or 15.  If the source IP address changes, you are advised to set the hash mode to 0 or 5.  If the source port changes, you are advised to set the hash mode to 1.  If the destination port changes, you are advised to set the hash mode to 0.  If the source and destination IP addresses change, you are advised to set the hash mode to 2.  If the source and destination ports change, you are advised to set the hash mode to 0. |
   | Configure a start hash value for the seed hash algorithm for load balancing for the CE6866, CE6860-SAN, CE6866K, CE6860-HAM, CE8851-32CQ8DQ-P, CE8850-SAN, CE8851K, CE8850-HAM . | [**ecmp seed**](cmdqueryname=ecmp+seed) *seed-data* | If a lower-level device uses the same hash algorithm as an upper-level device, the hash results are uneven or the hash operation fails. To prevent this issue, configure a start hash value for the seed hash algorithm for ECMP on the lower-level device. This ensures that the lower-level device uses the start hash value to hash traffic in addition to the hash algorithm. |
   | Configure a start hash value for the seed hash algorithm for load balancing for the CE8855, CE8851-32CQ4BQ, CE6855-48XS8CQ, CE6885, CE6885-SAN, CE6885-LL, CE6885-T, CE6863E-48S8CQ. | [**ecmp { overlay|underlay } seed**](cmdqueryname=ecmp+%7B+overlay%7Cunderlay+%7D+seed) *seed-data* | If a lower-level device uses the same hash algorithm as an upper-level device, the hash results are uneven or the hash operation fails. To prevent this issue, configure a start hash value for the seed hash algorithm for ECMP on the lower-level device. This ensures that the lower-level device uses the start hash value to hash traffic in addition to the hash algorithm. |
   | Configure a load balancing mode for tunnel packets for the CE6866, CE6860-SAN, CE6866K, CE6860-HAM, CE8851-32CQ8DQ-P, CE8850-SAN, CE8851K, CE8850-HAM, and CE8855, CE8851-32CQ4BQ, CE6855-48XS8CQ, CE6885, CE6885-SAN, CE6885-LL, CE6885-T, CE6863E-48S8CQ. | [**ip-tunnel**](cmdqueryname=ip-tunnel+inner-src-ip+inner-dst-ip+inner-l4-sport) { **inner-src-ip** | **inner-dst-ip** | **inner-l4-sport** | **inner-l4-dport** | **inner-protocol** | **src-interface** | **include-erspan** } \* | Tunnel packets can be balanced based on any combination of an inner source IP address, inner destination IP address, inner source port number, inner destination port number, and inbound interface number. The device uses the hash algorithm to calculate a value based on the configured combination and selects a link to forward packets based on the value. |
   | Configure a load balancing mode for tunnel packets for the CE6820H, CE6820H-K, CE6863H, CE6863H-K, CE6881H, CE6881H-K, CE6820S. | [**ip-tunnel**](cmdqueryname=ip-tunnel+inner-src-ip+inner-dst-ip+inner-l4-sport) { **inner-src-ip** | **inner-dst-ip** | **inner-l4-sport** | **inner-l4-dport** | **src-mac** | **dst-mac** } \* | Tunnel packets can be balanced based on any combination of an inner source IP address, inner destination IP address, inner source port number, inner destination port number, and inbound interface number. The device uses the hash algorithm to calculate a value based on the configured combination and selects a link to forward packets based on the value. |
   | Configure a load balancing mode for GTP packets. | **gtp teid** | When GTP packets are forwarded based on the hash factors configured in the system, the packets may be unevenly load-balanced. To resolve this problem, run the **gtp teid** command to enable TEID-based hashing for GTP packets. (TEID is a field in GTP packets.) |
   | Configure a hash algorithm offset for ECMP load balancing for the CE6820H, CE6820H-K, CE6863H, CE6863H-K, CE6881H, CE6881H-K, CE6820S. | [**ecmp universal-id**](cmdqueryname=ecmp+universal-id)  *universal-id1* | If there are multiple equal-cost routes to the same destination, a device uses the hash algorithm to select a forwarding path based on information such as the IP address, MAC address, and port number of received packets. If there are four equal-cost routes to the destination IP address on the device, all traffic destined for the IP address will be evenly balanced among the four forwarding paths. By default, if packets have the same information such as IP addresses, MAC addresses, and port numbers, the forwarding paths calculated using the hash algorithm are the same. The hash algorithm offset affects the forwarding path calculated by the hash algorithm. Specifically, if the hash algorithm offsets of two devices are different, the outbound interfaces calculated by the hash algorithm for the same traffic on the two devices are also different. If you want to select different forwarding paths for the same traffic on different devices, configure different hash algorithm offsets on the devices. |
   | Configure a hash algorithm offset for ECMP load balancing for the CE8855, CE8851-32CQ4BQ, CE6855-48XS8CQ, CE6885, CE6885-SAN, CE6885-LL, CE6885-T, CE6863E-48S8CQ. | [**ecmp { overlay|underlay } universal-id**](cmdqueryname=ecmp+%7B+overlay%7Cunderlay+%7D+universal-id)  *universal-id2* | If there are multiple equal-cost routes to the same destination, a device uses the hash algorithm to select a forwarding path based on information such as the IP address, MAC address, and port number of received packets. If there are four equal-cost routes to the destination IP address on the device, all traffic destined for the IP address will be evenly balanced among the four forwarding paths. By default, if packets have the same information such as IP addresses, MAC addresses, and port numbers, the forwarding paths calculated using the hash algorithm are the same. The hash algorithm offset affects the forwarding path calculated by the hash algorithm. Specifically, if the hash algorithm offsets of two devices are different, the outbound interfaces calculated by the hash algorithm for the same traffic on the two devices are also different. If you want to select different forwarding paths for the same traffic on different devices, configure different hash algorithm offsets on the devices. |
   | For the CE6863H, CE6863H-K, CE6881H, and CE6881H-K, enable traffic to be preferentially forwarded from a local chip. | [**local-preference enhanced**](cmdqueryname=local-preference+enhanced) | If a device has multiple chips for traffic forwarding, the hash algorithm may select an inter-chip outbound interface, increasing the consumption of inter-chip bandwidth resources. To resolve this issue, run this command so that traffic is preferentially forwarded from a local chip. Specifically, a chip preferentially forwards received traffic through its outbound interface. This effectively saves inter-chip bandwidth resources and improves the forwarding efficiency of traffic. |
4. Commit the configuration.
   
   
   ```
   [commit](cmdqueryname=commit)
   ```