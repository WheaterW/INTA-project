Example for Configuring Redirection to Implement Route Selection
================================================================

Example for Configuring Redirection to Implement Route Selection

#### Networking Requirements

In [Figure 1](#EN-US_TASK_0000001512850602__fig766814017525), the PC needs to access the server through link A, link B, and link C (is used by default) in descending order of priority.

**Figure 1** Network diagram for configuring redirection to implement route selection![](public_sys-resources/note_3.0-en-us.png) 

In this example, interface 1, interface 2, and interface 3 represent 100GE 1/0/1, 100GE 1/0/2, and 100GE 1/0/3, respectively.


  
![](figure/en-us_image_0000001564010413.png)

#### Configuration Roadmap

The configuration roadmap is as follows:

1. Configure a dynamic routing protocol to generate a route or configure a static route destined for the server and specify 10.1.1.2/24 as the next-hop address so that packets pass through link A.
2. Redirect the packets that match the network segment where the server resides to the next-hop address 10.1.2.2/24 and allow the packets to pass through link B; specify **low-preference** for redirection to a next-hop address; configure a high priority for the traffic classifier when binding the traffic classifier and the traffic behavior to the traffic policy. In this way, packets preferentially pass through link A.
3. Configure a default route and specify 10.1.3.2/24 as the next-hop address so that packets pass through link C.
4. After the configuration is complete, DeviceA handles packets in one of the following ways (listed in descending order of priority): forwards packets according to the route generated by a routing protocol or static route > redirects packets matching the network segment where the server resides to a next-hop address > forwards packets to a next-hop address according to the default route if no matching route is found.


#### Procedure

1. Create VLANs and configure interfaces.
   
   
   
   # Create VLANs 10, 20, and 30 on DeviceA.
   
   ```
   <HUAWEI> system-view
   [~HUAWEI] sysname DeviceA
   [*HUAWEI] [commit](cmdqueryname=commit)
   [~DeviceA] vlan batch 10 20 30
   [*DeviceA] [commit](cmdqueryname=commit)
   ```
   
   # Configure 100GE 1/0/1, 100GE 1/0/2, and 100GE 1/0/3 on DeviceA as trunk interfaces and add them to VLAN 10, VLAN 20, and VLAN 30, respectively.
   
   ```
   [~DeviceA] interface 100ge 1/0/1
   [~DeviceA-100GE1/0/1] portswitch
   [~DeviceA-100GE1/0/1] port link-type trunk
   [*DeviceA-100GE1/0/1] port trunk allow-pass vlan 10
   [*DeviceA-100GE1/0/1] quit
   [*DeviceA] interface 100ge 1/0/2
   [*DeviceA-100GE1/0/2] portswitch
   [*DeviceA-100GE1/0/2] port link-type trunk
   [*DeviceA-100GE1/0/2] port trunk allow-pass vlan 20
   [*DeviceA-100GE1/0/2] quit
   [*DeviceA] interface 100ge 1/0/3
   [*DeviceA-100GE1/0/3] portswitch
   [*DeviceA-100GE1/0/3] port link-type trunk
   [*DeviceA-100GE1/0/3] port trunk allow-pass vlan 30
   [*DeviceA-100GE1/0/3] quit
   [*DeviceA] [commit](cmdqueryname=commit)
   ```
   
   # Create VLANIF 10, VLANIF 20, and VLANIF 30 and configure IP addresses for them.
   
   ```
   [~DeviceA] interface vlanif 10
   [*DeviceA-Vlanif10] ip address 10.1.1.1 24
   [*DeviceA-Vlanif10] quit
   [*DeviceA] interface vlanif 20
   [*DeviceA-Vlanif20] ip address 10.1.2.1 24
   [*DeviceA-Vlanif20] quit
   [*DeviceA] interface vlanif 30
   [*DeviceA-Vlanif30] ip address 10.1.3.1 24
   [*DeviceA-Vlanif30] quit
   [*DeviceA] [commit](cmdqueryname=commit)
   ```
2. Configure a static route and a default route to the server.
   
   
   
   # Configure a static route to the server and specify 10.1.1.2 as the next-hop address.
   
   ```
   [~DeviceA] ip route-static 10.1.4.0 24 10.1.1.2
   [*DeviceA] [commit](cmdqueryname=commit)
   ```
   
   
   
   # Configure a default route to the server and specify 10.1.3.2 as the next-hop address.
   
   ```
   [~DeviceA] ip route-static 0.0.0.0 0 10.1.3.2
   [*DeviceA] [commit](cmdqueryname=commit)
   ```
3. Configure a traffic classifier.
   
   
   
   # On DeviceA, create ACL 3001 to allow packets destined for the network segment 10.1.4.0/24 to pass through.
   
   ```
   [~DeviceA] acl 3001
   [*DeviceA-acl4-advance-3001] rule permit ip destination 10.1.4.0 0.0.0.255
   [*DeviceA-acl4-advance-3001] quit
   ```
   
   # On DeviceA, create a traffic classifier **c1** and configure a matching rule based on ACL 3001.
   
   ```
   [~DeviceA] traffic classifier c1
   [*DeviceA-classifier-c1] if-match acl 3001
   [*DeviceA-classifier-c1] quit
   [*DeviceA] [commit](cmdqueryname=commit)
   ```
4. Configure a traffic behavior.
   
   
   
   # On DeviceA, create a traffic behavior **b1**, specify 10.1.2.2 as the next-hop address to which packets are redirected, and specify **low-preference** so that the priority of redirection to the next-hop address is lower than that of the route generated by a dynamic routing protocol or a static route.
   
   ```
   [~DeviceA] traffic behavior b1
   [*DeviceA-behavior-b1] redirect nexthop 10.1.2.2 low-precedence
   [*DeviceA-behavior-b1] quit
   [*DeviceA] [commit](cmdqueryname=commit)
   ```
5. Configure a traffic policy.
   
   
   
   # On DeviceA, create a traffic policy **p1** and bind the traffic classifier to the traffic behavior in the traffic policy.
   
   ```
   [~DeviceA] traffic policy p1
   [*DeviceA-trafficpolicy-p1] classifier c1 behavior b1 precedence 5
   [*DeviceA-trafficpolicy-p1] quit
   [*DeviceA] [commit](cmdqueryname=commit)
   ```
   
   # Apply the traffic policy **p1** to the system. After the configuration is complete, all packets received by DeviceA match the traffic policy **p1**.
   
   ```
   [~DeviceA] traffic-policy p1 global inbound
   [*DeviceA] [commit](cmdqueryname=commit)
   [~DeviceA] quit
   ```

#### Verifying the Configuration

# Check the ACL configuration.

```
<DeviceA> display acl 3001
Advanced ACL 3001, 1 rule                                                                                                           
ACL's step is 5                                                                                                                     
 rule 5 permit ip destination 10.1.4.0 0.0.0.255 (0 times matched)
```

# Check the traffic classifier configuration.

```
<DeviceA> display traffic classifier
  Traffic Classifier Information:
    Classifier: c1
      Type: OR
      Rule(s):
        if-match acl 3001

Total classifier number is 1 
```

# Check the traffic policy configuration.

```
<DeviceA> display traffic policy
  Traffic Policy Information:
    Policy: p1                                                                                                                      
      Classifier: c1                                                                                                                
        Type: OR                                                                                                                    
      Behavior: b1                                                                                                                  
        Redirect:                                                                                                                   
          Redirect nexthop                                                                                                          
          10.1.2.2 low-precedence                                                                                                                  
Total policy number is 1
```

# Check the traffic policy application records.

```
<DeviceA> display traffic-policy applied-record
Total records : 1 
--------------------------------------------------------------------------------                                                    
Policy Type/Name                     Apply Parameter            Slot  State                                                         
--------------------------------------------------------------------------------                                                    
p1                                   Global(IN)                 1     success                                                       
--------------------------------------------------------------------------------  
```

#### Configuration Scripts

DeviceA
```
#
sysname DeviceA
#
vlan batch 10 20 30
#
traffic-policy p1 global inbound
#
acl number 3001
 rule 5 permit ip destination 10.1.4.0 0.0.0.255
#
traffic classifier c1 type or
 if-match acl 3001
#
traffic behavior b1
 redirect nexthop 10.1.2.2 low-precedence
#
traffic policy p1
 classifier c1 behavior b1 precedence 5
#
interface Vlanif10
 ip address 10.1.1.1 255.255.255.0
#
interface Vlanif20
 ip address 10.1.2.1 255.255.255.0
#
interface Vlanif30
 ip address 10.1.3.1 255.255.255.0
#
interface 100GE1/0/1
 port link-type trunk
 port trunk allow-pass vlan 10
#
interface 100GE1/0/2
 port link-type trunk
 port trunk allow-pass vlan 20
#
interface 100GE1/0/3
 port link-type trunk
 port trunk allow-pass vlan 30
#
ip route-static 10.1.4.0 255.255.255.0 10.1.1.2
ip route-static 0.0.0.0 0 10.1.3.2
#
return
```