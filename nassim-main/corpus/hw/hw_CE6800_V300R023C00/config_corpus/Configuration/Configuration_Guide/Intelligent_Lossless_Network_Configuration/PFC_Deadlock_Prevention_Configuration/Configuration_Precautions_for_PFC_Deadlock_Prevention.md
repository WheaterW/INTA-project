Configuration Precautions for PFC Deadlock Prevention
=====================================================

Configuration Precautions for PFC Deadlock Prevention

#### Licensing Requirements

PFC deadlock prevention is not under license control.


#### Hardware Requirements

**Table 1** Hardware requirements
| Series | Models |
| --- | --- |
| CE6800 series | CE6855-48XS8CQ/CE6860-HAM/CE6860-SAN/CE6866-48S8CQ-K/CE6866-48S8CQ-P/CE6885-48YS8CQ/CE6863E-48S8CQ/CE6885-LL-56F (standard forwarding mode)/CE6885-48YS8CQ-T/CE6885-LL-56F (low latency mode)/CE6885-SAN-56F |
| CE8800 series | CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE8855-32CQ4BQ/CE8851-32CQ4BQ |



#### Feature Requirements

**Table 2** Feature requirements
| Feature Requirements | Series | Models |
| --- | --- | --- |
| For the CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE6860-HAM/CE6860-SAN/CE6866-48S8CQ-K/CE6866-48S8CQ-P:  1. Currently, the intelligent lossless network uses the Clos architecture. The PFC deadlock prevention function needs to be enabled for both a two-stage and three-stage Clos network, enabled on leaf nodes for the former and on both leaf and spine nodes for the latter.  2. For uplink interfaces in a Clos network, PFC deadlock prevention is supported only when the IP addresses are configured on the main interfaces of the uplink interfaces. If the IP address is not configured on a main interface, PFC deadlock prevention does not take effect. Instead, PFC deadlock detection enabled by default prevents PFC deadlocks.  3. PFC deadlock prevention applies only to the scenario where the outbound interface of a route is an uplink interface and the uplink interface is a physical main interface or Eth-Trunk. It does not apply to the scenario where the uplink interface is a logical interface such as a sub-interface, VLANIF interface, or VBDIF interface.  4. An interface cannot be added to two uplink interface groups at the same time.  5. In V300R021C10 and later versions, if physical interfaces that have been added to an Eth-Trunk are added to a PFC uplink interface group, PFC deadlock prevention takes effect on the Eth-Trunk.  For the CE8855-32CQ4BQ/CE8851-32CQ4BQ/CE6855-48XS8CQ/CE6885-48YS8CQ/CE6863E-48S8CQ/CE6885-LL-56F (standard forwarding mode)/CE6885-48YS8CQ-T/CE6885-LL-56F (low latency mode)/CE6885-SAN-56F:  1. Currently, the intelligent lossless network uses the Clos network. The PFC deadlock prevention function needs to be enabled for both a two-stage and three-stage Clos network, enabled on leaf nodes for the former and on both leaf and spine nodes for the latter.  2. PFC deadlock prevention takes effect on physical interfaces. | CE6800 series  CE8800 series | CE6855-48XS8CQ/CE6860-HAM/CE6860-SAN/CE6866-48S8CQ-K/CE6866-48S8CQ-P/CE6885-48YS8CQ/CE6863E-48S8CQ/CE6885-LL-56F (standard forwarding mode)/CE6885-48YS8CQ-T/CE6885-LL-56F (low latency mode)/CE6885-SAN-56F  CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE8855-32CQ4BQ/CE8851-32CQ4BQ |
| After the PFC deadlock prevention function takes effect, the hook-shaped flow switches the queue. When congestion occurs, the priority of the PFC frames sent to the uplink device changes to the new priority. Therefore, the traffic in the queue before the switching is still sent to the local device at the original rate, the congestion on the local device may be aggravated, or even PFC backpressure or device-level backpressure may be triggered. As a result, packet loss occurs.  The PFC deadlock prevention function can only prevent PFC deadlocks, but cannot prevent packet loss before and after a switching. | CE6800 series  CE8800 series | CE6860-HAM/CE6860-SAN/CE6866-48S8CQ-K/CE6866-48S8CQ-P  CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P |
| For the CE6800 Series:  Priority for DSCP value adjustment to take effect  For the CE6860-HAM/CE6860-SAN/CE6866-48S8CQ-K/CE6866-48S8CQ-P:  The action of adjusting the DSCP value provided by deadlock prevention has a higher priority than the traffic policy applied globally and a lower priority than other traffic policies.  The action of adjusting the DSCP value provided by deadlock prevention has a lower priority than PHB mapping for outgoing packets.  For the CE6855-48XS8CQ/CE6885-48YS8CQ/CE6863E-48S8CQ/CE6885-LL-56F (standard forwarding mode)/CE6885-48YS8CQ-T/CE6885-LL-56F (low latency mode)/CE6885-SAN-56F:  The action of adjusting the DSCP value provided by deadlock prevention has a higher priority than the traffic policy applied globally.  The action of adjusting the DSCP value provided by deadlock prevention has a lower priority than PHB mapping for outgoing packets.  For the CE8800 Series:  Priority for DSCP value adjustment to take effect  For the CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P:  The action of adjusting the DSCP value provided by deadlock prevention has a higher priority than the traffic policy applied globally and a lower priority than other traffic policies.  The action of adjusting the DSCP value provided by deadlock prevention has a lower priority than PHB mapping for outgoing packets.  For the CE8855-32CQ4BQ/CE8851-32CQ4BQ:  The action of adjusting the DSCP value provided by deadlock prevention has a higher priority than the traffic policy applied globally.  The action of adjusting the DSCP value provided by deadlock prevention has a lower priority than PHB mapping for outgoing packets. | CE6800 series  CE8800 series | CE6855-48XS8CQ/CE6860-HAM/CE6860-SAN/CE6866-48S8CQ-K/CE6866-48S8CQ-P/CE6885-48YS8CQ/CE6863E-48S8CQ/CE6885-LL-56F (standard forwarding mode)/CE6885-48YS8CQ-T/CE6885-LL-56F (low latency mode)/CE6885-SAN-56F  CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE8855-32CQ4BQ/CE8851-32CQ4BQ |
| If the uplink interface group has ECMP outbound interfaces, all the outbound interfaces must be added to the uplink interface group. Otherwise, Layer 3 traffic of interfaces that are not in the uplink interface group will be incorrectly switched to another queue and the DSCP value will be changed. | CE6800 series  CE8800 series | CE6860-HAM/CE6860-SAN/CE6866-48S8CQ-K/CE6866-48S8CQ-P  CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P |
| When the adjust command is configured, the internal priority mapped based on the adjusted DSCP value of packets on the downstream device must be the same as the priority of the queue on the local device. This ensures that the packets in a hook-shaped flow are still forwarded through the specified queue on the downstream device. | CE6800 series  CE8800 series | CE6855-48XS8CQ/CE6860-HAM/CE6860-SAN/CE6866-48S8CQ-K/CE6866-48S8CQ-P/CE6885-48YS8CQ/CE6863E-48S8CQ/CE6885-LL-56F (standard forwarding mode)/CE6885-48YS8CQ-T/CE6885-LL-56F (low latency mode)/CE6885-SAN-56F  CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE8855-32CQ4BQ/CE8851-32CQ4BQ |
| A PFC uplink interface group supports two adjust command configurations to switch hook-shaped flows to backup queues (one lossless backup queue and one lossy backup queue) based on matching conditions. You need to plan the backup queues in advance.  At least one queue must be reserved. If a lossy queue is reserved, packet loss cannot be prevented using mechanisms such as PFC. | CE6800 series  CE8800 series | CE6855-48XS8CQ/CE6860-HAM/CE6860-SAN/CE6866-48S8CQ-K/CE6866-48S8CQ-P/CE6885-48YS8CQ/CE6863E-48S8CQ/CE6885-LL-56F (standard forwarding mode)/CE6885-48YS8CQ-T/CE6885-LL-56F (low latency mode)/CE6885-SAN-56F  CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE8855-32CQ4BQ/CE8851-32CQ4BQ |
| Deadlock prevention takes effect only for known unicast RoCE traffic. | CE6800 series  CE8800 series | CE6855-48XS8CQ/CE6860-HAM/CE6860-SAN/CE6866-48S8CQ-K/CE6866-48S8CQ-P/CE6885-48YS8CQ/CE6863E-48S8CQ/CE6885-LL-56F (standard forwarding mode)/CE6885-48YS8CQ-T/CE6885-LL-56F (low latency mode)/CE6885-SAN-56F  CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE8855-32CQ4BQ/CE8851-32CQ4BQ |