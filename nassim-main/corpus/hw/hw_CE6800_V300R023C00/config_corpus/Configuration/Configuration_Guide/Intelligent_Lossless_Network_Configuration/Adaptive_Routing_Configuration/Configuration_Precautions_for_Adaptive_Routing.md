Configuration Precautions for Adaptive Routing
==============================================

Configuration Precautions for Adaptive Routing

#### Licensing Requirements

Adaptive Routing is under license control (CE-LIC-AdaRoute).


#### Hardware Requirements

**Table 1** Hardware requirements
| Series | Models |
| --- | --- |
| CE8800 series | CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE8855-32CQ4BQ/CE8851-32CQ4BQ |



#### Feature Requirements

**Table 2** Feature requirements
| Feature Requirements | Series | Models |
| --- | --- | --- |
| For the CE8800 Series:  1. A physical interface or physical sub-interface can be configured with an IP address as the next-hop outbound interface. An Eth-Trunk interface, VLANIF interface, or VBDIF interface cannot.  2. The 802.1p priorities or priorities mapped from the DSCP values configured on the access-side interfaces must be the same.  3. PFC needs to be configured on the access side.  4. On the dragonfly network, the global and local ports need to be configured with adaptive routing and dragonfly deadlock prevention.  5. On the dragonfly network, the adaptive routing threshold and dragonfly deadlock prevention-enabled queue switching configurations must be the same on all devices.  6. Adaptive routing cannot be configured on interfaces resulting from a split.  For the CE8851-32CQ8DQ-P, CE8850-HAM, CE8851-32CQ8DQ-K, and CE8850-SAN, the constraints on the dragonfly network are as follows:  1. The global and local ports need to be configured with dragonfly antilocking PFC.  2. The dragonfly antilocking PFC-enabled queue configurations must be the same on all devices.  3. Dragonfly antilocking PFC must be enabled for service traffic queues on both the global and local ports. | CE8800 series | CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE8855-32CQ4BQ/CE8851-32CQ4BQ |
| For the CE8800 Series:  1. Adaptive routing applies only to dragonfly networks, including small-, medium-, and large-scale networks.  2. Redundant gateways, M-LAG, stacking, and dual-homing access through link bundling are not supported. | CE8800 series | CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE8855-32CQ4BQ/CE8851-32CQ4BQ |
| For the CE8800 Series:  1. Multi-tenant is not supported.  2. Only IPv4 forwarding is supported.  3. Mixed traffic transmission in multiple queues (on the access side) is not supported.  4. When congestion occurs, there is a possibility that the congested path is selected during path switching in adaptive routing due to the limitation of flow table specifications.  5. The bottom layer sends congestion switching information and congestion message sending and receiving records to the CPU for recording. When messages are discarded due to CAR restriction, the log records are lost.  6. In the direct topology, the all-to-all traffic model cannot ensure zero packet loss. | CE8800 series | CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE8855-32CQ4BQ/CE8851-32CQ4BQ |
| For the CE8800 Series:  1. Dragonfly antilocking PFC implements flow control using a mechanism of continuously adjusting the sending and pausing of a small amount of traffic at a high frequency within a short period. Therefore, the Xoff threshold of the traditional PFC is set to 30000 KB so that it does not take effect.  2. When unknown unicast, broadcast, and multicast traffic is congested on an interface enabled with dragonfly antilocking PFC, PFC is not triggered and PFC frames are not sent to the upstream device. For unicast and multicast hybrid traffic in the same lossless queue, multicast traffic is directly discarded when the buffer drop threshold is reached.  3. When the device receives PFC frames with a priority, both unicast and multicast queues with the priority respond to PFC frames and the device stops sending traffic in the queues.  4. On an interface, dragonfly antilocking PFC for queue 1 is mutually exclusive with differentiated flow scheduling in any queue. The same queue on the same interface cannot have both dragonfly antilocking PFC and differentiated flow scheduling enabled.  5. Dragonfly antilocking PFC on an interface is mutually exclusive with PFC and antilocking PFC on the interface. (Dragonfly antilocking PFC can be enabled on an interface when dragonfly antilocking PFC is enabled in the global dragonfly profile and adaptive routing is enabled on the interface.)  6. When dragonfly antilocking PFC is configured while traffic is being transmitted (including enabling dragonfly antilocking PFC and modifying the buffer threshold for the queues where dragonfly antilocking PFC will be enabled) , transient packet loss may occur. You are advised to stop the traffic before configuring dragonfly antilocking PFC. | CE8800 series | CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P |
| For the CE8800 Series:  1. This function and PFC deadlock prevention for uplink interfaces are mutually exclusive globally.  2. Deadlock prevention takes effect only for known unicast RoCE traffic.  3. Dragonfly deadlock prevention is supported only in DSCP mapping mode.  4. The action of adjusting the DSCP value provided by dragonfly deadlock prevention has a lower priority than PHB mapping for outgoing packets.  5. In ECMP scenarios, if both the inbound and outbound interfaces are local ports, a deadlock prevention ACL is delivered only when all ECMP outbound interfaces are local ports.  6. The priority queue mapped to the DSCP value of packets after switching on the downstream device must be the same as the priority queue mapped on the current device. This ensures that packets are still mapped to the specified priority queue on the downstream device.  7. In addition to the original queue, you need to reserve two queues for queue switching in deadlock prevention.  8. When dragonfly deadlock prevention takes effect on an interface, the mapping between DSCP values and priorities that takes effect on the interface must be the same as that configured for dragonfly deadlock prevention.  9. Only two deadlock prevention rules can be configured. Backpressure based on the original queue can be implemented for dragonfly deadlock prevention only when rules of switching from queue A to queue B and from queue B to queue C are configured.  10. Dragonfly deadlock prevention is configured for queue A to queue B. The number of PFC frames sent by queue A depends on the larger value of the inbound interface buffer sizes of queues A and B.  For the CE8851-32CQ8DQ-P, CE8850-HAM, CE8851-32CQ8DQ-K, and CE8850-SAN, the restrictions are as follows:  1. This function depends on dragonfly antilocking PFC enabled on a queue.  2. Dragonfly deadlock prevention is supported only when an IP address is configured on a main interface or a sub-interface of the main interface. Otherwise, dragonfly deadlock prevention does not take effect, and dragonfly deadlock detection enabled by default prevents deadlocks.  3. The action of adjusting the DSCP value provided by dragonfly deadlock prevention has a higher priority than the traffic policy applied globally and has a lower priority than other traffic policies. | CE8800 series | CE8850-HAM/CE8850-SAN/CE8851-32CQ8DQ-K/CE8851-32CQ8DQ-P/CE8855-32CQ4BQ/CE8851-32CQ4BQ |