Configuring OSPF Between an MCE and a PE
========================================

Configuring OSPF Between an MCE and a PE

#### Prerequisites

Before configuring MCE, you have completed the following tasks:

* Configure a VPN instance for each service on the MCE and its connected PE. For details, see [Configuring an IPv4 VPN Instance on a PE](vrp_L3VPNv4_cfg_0007.html).
* Configure link and network layer protocols for LAN interfaces, and connect the LAN interface for each type of service to the MCE.
* Bind each MCE interface and the PE interface connecting to the MCE to the VPN instance, and configure IP addresses for the interfaces. For detailed configurations, see [Binding an Interface to an IPv4 VPN Instance](vrp_L3VPNv4_cfg_0008.html).

#### Context

Deleting a VPN instance or disabling a VPN instance IPv4 address family will delete all the OSPF processes bound to the VPN instance and the VPN instance IPv4 address family.


#### Procedure

* Configure the PE.
  1. Enter the system view.
     
     
     ```
     [system-view](cmdqueryname=system-view)
     ```
  2. Create an OSPF process and enter the OSPF view.
     
     
     ```
     [ospf](cmdqueryname=ospf) process-id [ router-id router-id ] vpn-instance vpnname
     ```
     
     An OSPF process can be bound to only one VPN instance.
     
     A router ID needs to be specified when an OSPF process is started after it is bound to a VPN instance. The router ID must be different from the public network router ID configured in the system view. If the router ID is not specified, OSPF selects the IP address of one of the interfaces bound to the VPN instance as the router ID based on a certain rule.
  3. (Optional) Configure a domain ID.
     
     
     ```
     [domain-id](cmdqueryname=domain-id) domain-id [ secondary ]
     ```
     
     The domain ID can be an integer or in dotted decimal notation.
     
     Two domain IDs can be configured for each OSPF process. Different processes can have the same domain ID. There are no restrictions on the domain IDs of the OSPF processes for different VPNs on a PE. The OSPF processes of the same VPN must be configured with the same domain ID to ensure correct route advertisement.
     
     The domain ID of an OSPF process is contained in the routes generated by the process. When OSPF routes are imported into the BGP routing table, the domain ID is added to BGP VPN routes and advertised as a BGP extended community attribute.
  4. Enter the OSPF area view.
     
     
     ```
     [area](cmdqueryname=area) area-id
     ```
  5. Enable OSPF on the network segment where an interface bound to the VPN instance resides.
     
     
     ```
     [network](cmdqueryname=network) address wildcard-mask
     ```
     
     
     
     A network segment can belong to only one area. In other words, you need to specify an area for each interface running OSPF.
     
     OSPF can properly run on an interface only when both of the following conditions are met:
     
     + The IP address mask length of the interface is longer than or equal to that specified in the [**network**](cmdqueryname=network) command.
     + The interface's primary IP address belongs to the network segment specified in the [**network**](cmdqueryname=network) command.
     
     On a loopback interface, by default, OSPF advertises its IP address in the form of a 32-bit host route, independent of the mask length of the IP address on the interface.
  6. Return to the OSPF view.
     
     
     ```
     [quit](cmdqueryname=quit)
     ```
  7. Import BGP routes.
     
     
     ```
     [import-route](cmdqueryname=import-route) bgp [ cost cost | route-policy route-policy-name | tag tag | type type ] *
     ```
  8. Return to the system view.
     
     
     ```
     [quit](cmdqueryname=quit)
     ```
  9. Enter the BGP view.
     
     
     ```
     [bgp](cmdqueryname=bgp) as-number
     ```
  10. Enter the BGP VPN instance IPv4 address family view.
      
      
      ```
      [ipv4-family](cmdqueryname=ipv4-family) vpn-instance vpn-instance-name
      ```
  11. Import OSPF routes into the routing table of the BGP VPN instance IPv4 address family.
      
      
      ```
      [import-route](cmdqueryname=import-route) ospf process-id [ med med-value | route-policy route-policy-name ] *
      ```
  12. Commit the configuration.
      
      
      ```
      [commit](cmdqueryname=commit)
      ```
* Configure the MCE.
  1. Enter the system view.
     
     
     ```
     [system-view](cmdqueryname=system-view)
     ```
  2. Create an OSPF process and enter the OSPF view.
     
     
     ```
     [ospf](cmdqueryname=ospf) process-id [ router-id router-id ] vpn-instance vpnname
     ```
     
     
     
     An OSPF process can be bound to only one VPN instance. The same OSPF process must be configured on the MCE and its connected PE.
     
     A router ID needs to be specified when an OSPF process is started after it is bound to a VPN instance. The router ID must be different from the public network router ID configured in the system view. If the router ID is not specified, OSPF selects the IP address of one of the interfaces bound to the VPN instance as the router ID based on a certain rule.
  3. (Optional) Configure a domain ID.
     
     
     ```
     [domain-id](cmdqueryname=domain-id) domain-idvalue [ secondary ]
     ```
     
     The domain ID can be an integer or in dotted decimal notation.
     
     Two domain IDs can be configured for each OSPF process. Different processes can have the same domain ID. There are no restrictions on the domain IDs of the OSPF processes for different VPNs on a PE. The OSPF processes of the same VPN must be configured with the same domain ID to ensure correct route advertisement.
     
     The domain ID of an OSPF process is contained in the routes generated by the process. When OSPF routes are imported into the BGP routing table, the domain ID is added to BGP VPN routes and advertised as a BGP extended community attribute.
  4. Disable routing loop detection.
     
     
     ```
     [vpn-instance-capability simple](cmdqueryname=vpn-instance-capability+simple)
     ```
     
     If OSPF VPN multi-instance has been deployed on the MCE and PE, the PE sends the MCE a link-state advertisement (LSA) with the Down (DN) bit set to 1. Because VPN instances have been configured on the MCE, the MCE has routing loop detection enabled. If the MCE detects that the LSA contains the DN bit with value 1, this LSA cannot be used to calculate routes. Run the [**vpn-instance-capability simple**](cmdqueryname=vpn-instance-capability+simple) command to disable OSPF routing loop detection. When OSPF routing loop detection is disabled, the MCE calculates all OSPF routes without checking the DN bit or route tag.
  5. Enter the OSPF area view.
     
     
     ```
     [area](cmdqueryname=area) area-id
     ```
  6. Enable OSPF on the network segment where an interface bound to the VPN instance resides.
     
     
     ```
     [network](cmdqueryname=network) address wildcard-mask
     ```
     
     
     
     A network segment can belong to only one area. In other words, you need to specify an area for each interface running OSPF.
     
     OSPF can properly run on an interface only when both of the following conditions are met:
     
     + The IP address mask length of the interface is longer than or equal to that specified in the [**network**](cmdqueryname=network) command.
     + The interface's primary IP address belongs to the network segment specified in the [**network**](cmdqueryname=network) command.
     
     On a loopback interface, by default, OSPF advertises its IP address in the form of a 32-bit host route, independent of the mask length of the IP address on the interface.
  7. Commit the configuration.
     
     
     ```
     [commit](cmdqueryname=commit)
     ```