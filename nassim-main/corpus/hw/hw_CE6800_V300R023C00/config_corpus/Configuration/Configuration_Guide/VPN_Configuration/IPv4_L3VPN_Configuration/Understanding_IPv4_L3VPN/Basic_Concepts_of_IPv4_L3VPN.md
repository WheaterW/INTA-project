Basic Concepts of IPv4 L3VPN
============================

Basic Concepts of IPv4 L3VPN

#### Related Concepts

* Site
  
  Site is often mentioned when VPN is discussed. The meaning of site can be understood from the following aspects:
  
  A site means a group of IP systems with IP connectivity. Such IP connectivity does not need to be achieved by the SP network.
  
  As shown in the left part of [Figure 1](#EN-US_CONCEPT_0000001130621662__fig_dc_vrp_mpls-l3vpn-v4_feature_002502), Company X has its HQ network at Site A in City A and its branch network at Site B in City B. IP devices within each site can communicate without using the SP network.
  
  **Figure 1** Sites  
  ![](figure/en-us_image_0000001386321373.png)
  
  Sites are divided based on topological connections between devices, rather than the geographical locations, even though devices at a site are geographically adjacent to one another. If two geographically separated IP systems are connected over a private line instead of an SP network, the two systems compose a site.
  
  As shown in [Figure 1](#EN-US_CONCEPT_0000001130621662__fig_dc_vrp_mpls-l3vpn-v4_feature_002502), if the branch network in City B connects to the HQ network in City A over a private line instead of the SP network, the branch network and HQ network form a site.
  
  Devices at a site can belong to multiple VPNs. In other words, a site can belong to more than one VPN.
  
  As shown in [Figure 2](#EN-US_CONCEPT_0000001130621662__fig199461915357), in Company X, the decision-making department in City A (Site A) needs to be configured to communicate with the R&D department in City B (Site B) and the financial department in City C (Site C). Site B and Site C, however, are not allowed to communicate. In this scenario, two VPNs can be created: VPN 1 for sites A and B and VPN 2 for sites A and C. Site A is configured to belong to multiple VPNs.
  
  **Figure 2** One site belonging to more than one VPN  
  ![](figure/en-us_image_0000001386801241.png)
  
  A site connects to an SP network through a CE and may contain multiple CEs, but one CE can belong to only one site. Determine the devices to be used as CEs based on site conditions:
  
  + If the site contains a single host, use the host as the CE.
  + If the site contains a subnet, use switches as CEs.
  + If the site contains multiple subnets, use high-performance devices as CEs.
  
  Sites connecting to the same SP network can be categorized into different sets based on configured policies. Sites can access one another only when they belong to the same set. Such a set is a VPN.
* Address Space Overlapping
  
  As a private network, a VPN independently manages an address space. Address spaces of different VPNs may overlap. For example, address space overlapping occurs if both VPN 1 and VPN 2 use addresses on network segment 10.110.10.0/24.
  
  ![](public_sys-resources/note_3.0-en-us.png) 
  
  Two VPNs can use overlapped address spaces in the following situations:
  
  + The two VPNs do not cover the same site.
  + The two VPNs cover the same site, but the devices at such a site do not communicate with the devices using overlapped address spaces in the VPNs.
* VPN Instance
  
  CEs are user-side devices and need to send only local VPN routes to PEs, irrespective of whether the PEs connect to the public network or other VPNs. Generally, a PE of an SP network connects to multiple CEs of different VPNs. Therefore, the PE receives routes from different VPNs. Because address spaces used by these VPNs may overlap, routes sent from these VPNs may carry the same destination address. If a PE maintains only one routing and forwarding table, this table will retain only one of the routes from different VPNs and with the same destination address, causing route loss. This is where VPN instances come into play.
  
  A VPN instance is also called a VPN routing and forwarding (VRF) table. A PE has multiple routing and forwarding tables, including a public routing and forwarding table and one or more VRF tables. In other words, a PE has multiple instances, including a public network instance and one or more VPN instances, as shown in [Figure 3](#EN-US_CONCEPT_0000001130621662__fig_dc_vrp_mpls-l3vpn-v4_feature_002504). Each VPN instance maintains routes from the corresponding VPN, and the public network instance maintains public network routes. This enables a PE to keep all routes from VPNs, preventing route loss stemming from destination address overlapping.
  
  **Figure 3** VPN instances  
  ![](figure/en-us_image_0000001336481272.png)
  
  The differences between a public routing and forwarding table and a VRF table are as follows:
  
  + A public routing table contains the IPv4 routes advertised by all backbone network devices. These IPv4 routes include configured static routes or routes generated by routing protocols on the backbone network.
  + A VPN routing table contains routes of all sites in a VPN instance, and these routes are obtained through the exchange of VPN routing information between CEs and PEs, or between PEs.
  + Based on route management policies, a public forwarding table contains the minimum forwarding information extracted from the corresponding public routing table, whereas a VPN forwarding table contains the minimum forwarding information extracted from the corresponding VPN routing table.
    
    The VPN instances on a PE are independent of each other and are independent of the public routing and forwarding table.
    
    Each VPN instance can be considered as a virtual device, which maintains a separate address space and has one or more interfaces connected to the device.
    
    In related standards, VPN instances are called per-site forwarding tables. As the name implies, a VPN instance corresponds to sites. To be specific, every connection between a CE and PE corresponds to a VPN instance, but this is not a one-to-one mapping. The VPN instance is manually bound to the PE interface that directly connects to the CE.
    
    A VPN instance uses a route distinguisher (RD) to identify an independent address space and uses VPN targets to manage VPN memberships and routing rules of directly connected sites and remote sites.
* Relationships Between the VPN, Site, and VPN Instance
  
  The relationships between the VPN, site, and VPN instance are as follows:
  
  + A VPN consists of multiple sites. A site may belong to multiple VPNs.
  + Each site is associated with a VPN instance on a PE. A VPN instance is a set of VPN members and routing rules of associated sites. Multiple sites compose a VPN based on the rules of the VPN instance.
* RD and VPN-IPv4 Address
  
  Conventional BGP cannot process the routes of VPNs with overlapped address spaces. Assume that VPN 1 and VPN 2 use addresses on network segment 10.110.10.0/24, and each of them advertises a route destined for this network segment. The local PE identifies the two VPN routes based on VPN instances and sends them to the remote PE. Because routes from different VPNs cannot work in load-balancing mode, the remote PE adds only one of the two routes to its VRF table based on BGP route selection rules.
  
  This is because BGP cannot distinguish VPN routes with the same IP address prefix. To solve this problem, IPv4 L3VPN uses the VPN-IPv4 address family.
  
  A VPN-IPv4 address consists of 12 bytes, where the left-most 8 bytes represent an RD and the right-most 4 bytes represent an IPv4 address prefix. [Figure 4](#EN-US_CONCEPT_0000001130621662__fig_dc_vrp_mpls-l3vpn-v4_feature_002505) shows the format of a VPN-IPv4 address.
  
  **Figure 4** VPN-IPv4 address format  
  ![](figure/en-us_image_0000001336161392.png)
  
  RDs are used to distinguish IPv4 prefixes using the same address space. The format of RDs enables SPs to allocate RDs independently. An RD must be unique on the entire network to ensure correct routing in CE dual-homing scenarios. IPv4 addresses with RDs are called VPN-IPv4 addresses. After receiving IPv4 routes from a CE, a PE converts the routes to globally unique VPN-IPv4 routes and advertises these routes over the public network.
* VPN Target
  
  A VPN uses 64-bit BGP extended community attributes, namely, VPN targets (also called route targets), to control the advertisement of VPN routes.
  
  A VPN instance is associated with one or more VPN targets, which are of the following types:
  
  + Export target (ERT): After learning an IPv4 route from a directly connected site, a PE converts the route to a VPN-IPv4 route, sets the ERT for the route, and advertises the route carrying the ERT attribute as a BGP extended community attribute.
  + Import target (IRT): After receiving a VPN-IPv4 route distributed by another PE, the PE checks the ERT attribute of the route. If the ERT is identical with the IRT of a VPN instance on the PE, the PE adds the route to the routing table of the VPN instance.
  
  That is, the VPN target attribute defines the sites to which routes can be advertised and the sites whose routes can be accepted.
  
  After receiving a route from a directly connected CE, a PE adds one or more ERTs to the route. The PE then uses BGP to advertise the route with ERTs to related PEs. After receiving the route, the related PEs compare the received ERTs with the local IRTs of all their VPN instances. If an ERT is identical with an IRT, the route is installed into the routing table of the corresponding VPN instance.
  
  The reasons for using VPN targets instead of RDs as BGP extended community attributes are as follows:
  
  + A VPN-IPv4 route has only one RD, but can be associated with multiple VPN targets. With multiple extended community attributes, BGP can greatly improve network flexibility and expansibility.
  + VPN targets are used to control route advertisement between different VPNs on a PE using matching VPN targets.
  
  On a PE, different VPNs have different RDs, but the extended community attributes allowed by BGP are limited. Using RDs for route import limits network scalability.
  
  On a VPN, VPN targets are used to control the import and export of VPN routes between sites. ERTs and IRTs are independent of each other and multiple ERTs and IRTs can be set for one VPN instance, helping implement flexible VPN access control and diversified VPN networking modes.