Configuring the Mode for Connecting a Device to the SSH Server for the First Time
=================================================================================

Configuring the Mode for Connecting a Device to the SSH Server for the First Time

#### Context

When a device functioning as an SSH client connects to the SSH server for the first time, the client cannot check the validity of the SSH server because the client does not have the server's public key or has no related PKI certificate bound. As a result, the connection fails.

You can use any of the following methods based on requirements:

* Enable the first login function for the SSH client. The client will not perform a validity check on the SSH server, meaning that the first connection is set up successfully. The client then automatically assigns a public key to the server and saves it for subsequent authentication.
* Bind the public key of the SSH server to the SSH client. The public key generated on the server will be saved on the client, ensuring that the client can successfully validate the server upon the first connection.
* Bind the PKI realm used for authentication with the server to the client to ensure that the certificate of the SSH server is valid when the client connects to the server for the first time.

The first method is simple, and the other two methods are complex but more secure.

![](public_sys-resources/note_3.0-en-us.png) 

* To ensure security, you are advised to periodically change the key.
* For security purposes, do not use the RSA algorithm whose length is less than 3072 digits. You are advised to use the ECC authentication algorithm instead.


#### Procedure

1. Enter the system view.
   
   
   ```
   [system-view](cmdqueryname=system-view)
   ```
2. (Optional) Generate a local key pair.
   
   
   
   Perform this step only when the device connects to the SSH server through RSA, DSA, or ECC authentication. This step is not required if password authentication is used.
   
   * Generate a local RSA key pair.
     ```
     [rsa local-key-pair create](cmdqueryname=rsa+local-key-pair+create)
     ```
   * Generate a DSA key pair.
     ```
     [dsa local-key-pair create](cmdqueryname=dsa+local-key-pair+create)
     ```
   * Generate an ECC key pair.
     ```
     [ecc local-key-pair create](cmdqueryname=ecc+local-key-pair+create)
     ```
   
   After a key pair is generated, you can run the [**display rsa local-key-pair public**](cmdqueryname=display+rsa+local-key-pair+public), [**display dsa local-key-pair public**](cmdqueryname=display+dsa+local-key-pair+public), or [**display ecc local-key-pair public**](cmdqueryname=display+ecc+local-key-pair+public) command to view information about the RSA, DSA, or ECC public key in the local key pair.
   
   If you no longer need the local DSA or ECC key pairs, run the **dsa local-key-pair destroy** or [**ecc local-key-pair destroy**](cmdqueryname=ecc+local-key-pair+destroy) command to destroy all the local DSA or ECC key pairs. After this command is run, the file that stores the corresponding keys on the device is cleared. Exercise caution when running this command.
3. Configure the mode for connecting a device to the SSH server for the first time.
   
   
   * Enable the first login function for the SSH client.
     ```
     [ssh client first-time enable](cmdqueryname=ssh+client+first-time+enable)
     ```
     
     By default, the first login function for the SSH client is disabled.
   * Bind the public key of the SSH server to the SSH client.
     1. Enter the RSA, DSA, SM2, or ECC public key view.
        + Enter the RSA public key view.
          ```
          [rsa peer-public-key](cmdqueryname=rsa+peer-public-key) key-name [ encoding-type enc-type ]
          ```
        + Enter the DSA public key view.
          ```
          [dsa peer-public-key](cmdqueryname=dsa+peer-public-key) key-name encoding-type enc-type
          ```
        + Enter the ECC public key view.
          ```
          [ecc peer-public-key](cmdqueryname=ecc+peer-public-key) key-name [ encoding-type enc-type ]
          ```
        + Enter the SM2 public key view.
          ```
          sm2 peer-public-key key-name
          ```
     2. Enter the public key editing view.
        ```
        [public-key-code begin](cmdqueryname=public-key-code+begin)
        ```
        
        By default, no key pair exists in the system.
     3. Edit the public key.
        ```
        hex-data
        ```
        + The public key must be a hexadecimal character string in the public key encoding format, and that is randomly generated by the SSH server.
        + After entering the public key editing view, enter the RSA, DSA, or ECC public key on the client (this key is generated on the server).
     4. Exit the public key editing view.
        ```
        [public-key-code end](cmdqueryname=public-key-code+end)
        ```
        + If *hex-data* is invalid, the key cannot be generated after you run this command.
        + If the key specified by *key-name* has been deleted, the system displays a message indicating that the key does not exist and directly returns to the system view when you run this command.
     5. Return to the system view from the public key view.
        ```
        [peer-public-key end](cmdqueryname=peer-public-key+end)
        ```
     6. Bind the RSA, DSA, or ECC public key to the SSH server.
        ```
        [ssh client peer](cmdqueryname=ssh+client+peer) server-name assign { rsa-key | dsa-key | ecc-key | sm2-key } key-name
        ```
        
        By default, no public key is assigned to an SSH server.
        
        If the SSH server public key saved on the SSH client becomes invalid, run the [**undo ssh client peer**](cmdqueryname=undo+ssh+client+peer) *server-name* **assign** { **rsa-key** | **dsa-key** | **ecc-key** | **sm2-key** } command to cancel the binding between the SSH server and RSA, DSA, or ECC public key. Then, run this command again to assign a new RSA, DSA, or ECC public key to the SSH server.
   * Bind the SSH client to the PKI realm or host key that is used for authentication with the SSH server.
     ```
     [ssh client assign](cmdqueryname=ssh+client+assign) { sm2-host-key key-name | pki pki-domain }
     ```
     
     By default, no PKI realm is bound to an SSH client.
     
     By default, no SM2 host key is assigned to an SSH client.
4. Configure a public key algorithm for the SSH client.
   
   
   ```
   [ssh client publickey](cmdqueryname=ssh+client+publickey) { dsa | ecc | rsa | sm2 | rsa_sha2_256 | rsa_sha2_512 | x509v3-ssh-rsa | x509v3-rsa2048-sha256 } *
   ```
   By default:
   * When a device boots with the factory defaults, the RSA\_SHA2\_256 and RSA\_SHA2\_512 public key algorithms are enabled.
   * When a device starts with a configuration file which does not contain the [**ssh client publickey**](cmdqueryname=ssh+client+publickey) command configuration, the ECC, RSA\_SHA2\_256, and RSA\_SHA2\_512 public key algorithms are enabled.
   
   This command enables you to use a more secure public key algorithm when logging in to the device, while rejects other public key algorithms, thereby improving device security. You are advised to use the RSA\_SHA2\_256 or RSA\_SHA2\_512 public key algorithm.
   
   * If the [**ssh client first-time enable**](cmdqueryname=ssh+client+first-time+enable) command is executed, a message is displayed asking you to save the server's public key when the client connects to the server. During the saving process, the SSH client automatically selects a public key algorithm that can ensure successful negotiation among all public key algorithms configured using the [**ssh client publickey**](cmdqueryname=ssh+client+publickey), and allocates the selected algorithm to the SSH server.
   * If the [**ssh client first-time enable**](cmdqueryname=ssh+client+first-time+enable) command is not executed, you must run the [**ssh client peer assign**](cmdqueryname=ssh+client+peer+assign) command to allocate a public key algorithm to the SSH server. Ensure that the SSH server can use the allocated public key algorithm to successfully negotiate with the SSH client for which the public key algorithm is configured using the [**ssh client publickey**](cmdqueryname=ssh+client+publickey) command. Otherwise, the SSH server's public key fails to be authenticated by the SSH client.![](public_sys-resources/note_3.0-en-us.png) 
   
   Parameters **dsa**, **ecc**, and **rsa** in the command can be used only after the weak security algorithm/protocol feature package is installed by running the **install feature-software WEAKEA** command.
5. Commit the configuration.
   
   
   ```
   [commit](cmdqueryname=commit)
   ```