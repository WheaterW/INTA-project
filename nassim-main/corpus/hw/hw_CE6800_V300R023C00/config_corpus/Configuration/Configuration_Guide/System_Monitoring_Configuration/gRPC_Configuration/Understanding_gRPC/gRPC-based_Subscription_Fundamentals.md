gRPC-based Subscription Fundamentals
====================================

In both dial-in and dial-out modes, gRPC supports the subscription function (subscribe operation) using telemetry.

Telemetry is a technology that remotely collects data from physical or virtual devices at a high speed. Devices periodically send interface traffic statistics, CPU usage, and memory usage to collectors in push mode. Compared with the traditional pull mode (question-answer interaction), the push mode used by telemetry collects device data at the level of subseconds. In [Figure 1](#EN-US_CONCEPT_0000001564125893__fig183182151492), a gRPC connection is established between the NMS and the device so that the NMS can subscribe to data of a specified module on the device. Telemetry supports dynamic subscription and static subscription, which are used in dial-in and dial-out modes, respectively.

**Figure 1** Network diagram of gRPC-based telemetry function  
![](figure/en-us_image_0000001563885797.png)
#### gRPC-based Telemetry Fundamentals

**Telemetry implementation**:

1. A user defines a static telemetry subscription or dynamic telemetry subscription.
   * Static telemetry subscription: defined in the **huawei-grpc-dialout.proto** file.
   * Dynamic telemetry subscription: defined in the **huawei-grpc-dialin.proto** file.
2. The user encodes collected information in GPB or JSON format and defines key information including the sampling path and timestamp in the **huawei-telemetry.proto** file.
   * If the GPB format is used, the value of the **encoding** field in the **huawei-telemetry.proto** file is **0** (GPB encoding), the **data\_gpb** field carries sampled data in GPB format, and the **data\_str** field is empty.
   * If the JSON format is used, the value of the **encoding** field in the **huawei-telemetry.proto** file is **1** (JSON encoding), the **data\_str** field carries sampled data in JSON format.
3. The device transmits data to the collector, decodes the data, and analyzes the decoded data.
   * The **data\_gpb** field in the **huawei-telemetry.proto** file needs to be decoded using the .proto file of the corresponding service, which is determined by the **sensor\_path** field in the **huawei-telemetry.proto** file. For example, if the value of the **sensor\_path** field is **huawei-ifm:ifm/interfaces/interface**, the .proto file is **huawei-ifm.proto**.
   * If the pure JSON encoding format (both the telemetry layer and data model layer use the JSON encoding format) is used, you only need to decode the **huawei-grpc-dialout.proto** or **huawei-grpc-dialin.proto** file. If the hybrid JSON encoding format (the telemetry layer and data model layer use the GPB and JSON encoding formats, respectively) is used, you only need to decode the **huawei-grpc-dialout.proto** or **huawei-grpc-dialin.proto** file and the **huawei-telemetry.proto** file. The .proto file of a service is not required.

#### Proto Files

* The **huawei-grpc-dialout.proto** file is the RPC header file, which defines the RPC interface in dial-out mode. [Table 1](#EN-US_CONCEPT_0000001564125893__table1516419419364) describes the file content and meaning.
  
  **Table 1** huawei-grpc-dialout.proto file
  | huawei-grpc-dialout.proto |
  | --- |
  | ``` syntax = "proto3";                          //The .proto file version is defined as v3. package huawei_dialout;                     //The package name is huawei_dialout. service gRPCDataservice {                   //The service name is gRPCDataservice.     rpc dataPublish(stream serviceArgs) returns(stream serviceArgs) {};                 //The method is dataPublish, which is used to push data. The method uses the bidirectional streaming mode. The input parameter is the serviceArgs data flow. } message serviceArgs {                       //Message format description.     int64 ReqId = 1;                        //Request ID.     oneof MessageData {         bytes data = 2;         //Sampled data in GPB format is carried.         string data_json = 4;   //Sampled data in JSON format is carried.         bytes packed_data = 5; //Sampled data in GPB encoding format after packet combination.         string packed_data_json = 6; //Sampled data in JSON encoding format after packet combination.     }     string errors = 3;         //Error description. } ``` |
* The **huawei-grpc-dialin.proto** file is the RPC header file, which defines the RPC interface in dial-in mode. [Table 2](#EN-US_CONCEPT_0000001564125893__table18908162018391) describes the file content and meaning.
  
  **Table 2** huawei-grpc-dialin.proto file
  | huawei-grpc-dialin.proto |
  | --- |
  | ``` syntax = "proto3";                          //The .proto file version is defined as v3. package huawei_dialin;                     //The package name is huawei_dialin. service gRPCConfigOper {                   //The service name is gRPCConfigOper.     rpc Subscribe (SubsArgs) returns (stream SubsReply) {}; //The method is Subscribe, which is used for dynamic subscription. The method uses the server streaming mode. The input parameter SubsArgs includes the parameters to be subscribed.     rpc Cancel (CancelArgs) returns (CancelReply) {}; //The method is Cancel, which is used for canceling dynamic subscription. The method uses the query and response mode. The input parameter CancelArgs includes the parameters to be unsubscribed. } message Path {                //Path message structure.     string path = 1;          //Subscribed sampling path.     uint32 depth = 2;         //Sampling depth of the sampling path. The value 1 indicates the current level, and the value 2 indicates the current level and its sub-level, and so on. } message SubsArgs {            //Subscription request parameters.     uint64 request_id = 1;    //Request ID, which is transferred by the caller.     uint32 encoding = 2;      //Encoding type. The value 0 indicates GPB encoding, and the value 1 indicates JSON encoding. Currently, this parameter can only be set to 0.     repeated Path path = 5;   //Subscribed path structure.     uint64 sample_interval = 6; //Sampling interval.     uint64 heartbeat_interval = 7; //Redundancy suppression interval. This parameter is valid only when suppress_redundant is set to 1.     oneof Suppress {         bool suppress_redundant = 8;  //Redundancy suppression. The sampled data is not reported if the data content remains unchanged. 0: disabled; 1: enabled.         uint64 delay_time = 9;        //Delay, which ranges from 100 ms to 60000 ms. When data changes, the latest data will be reported after this delay. This prevents frequent reporting of massive data generated due to service flapping.     } } message SubsReply {            //Subscription response parameters.     uint32 subscription_id = 1; //If the subscription is successful, a subscription ID is returned. If the subscription fails, the value 0 is returned.     uint64 request_id = 2;        //ID of the subscription request.     string response_code = 3; //Return code. The value 200 indicates a success.     oneof MessageData {         bytes message = 4;        //If an error occurs, the error description is returned. If no error occurs, the data in GPB format is returned.         string message_json = 5;  //If no error occurs, the data in JSON format is returned.      } } message CancelArgs {            //Unsubscription request parameters.     uint64 request_id = 1;    //Request ID, which is transferred by the caller.     uint32 subscription_id = 2;   //ID of the subscription to be canceled. } message CancelReply {            //Unsubscription response parameters.     uint64 request_id = 1;    //Request ID, which is transferred by the caller.     string response_code = 2; //Return code. The value 200 indicates a success.     string message = 3;            //Error description. } ``` |
* **huawei-telemetry.proto** is the telemetry header file, which defines the header for the sampled data to be reported, including key information such as the sampling path and sampling timestamp. [Table 3](#EN-US_CONCEPT_0000001564125893__table5256101511412) describes the file content and meaning.
  
  **Table 3** huawei-telemetry.proto file
  | huawei-telemetry.proto |
  | --- |
  | ``` syntax = "proto3";                           //The .proto file version is defined as v3. package telemetry;                          //The package name is telemetry. message TelemetryPacked {     repeated Telemetry telemetry = 1; } message Telemetry {                           //Telemetry message structure definition.    string node_id_str = 1;                     //Device name.    string subscription_id_str = 2;             //Static subscription name.    string sensor_path = 3;                     //Sampling path.    string proto_path = 13;                    //Sampling path corresponding to the message path defined in the .proto file.    uint64 collection_id = 4;                   //Sampling round.    uint64 collection_start_time = 5;           //Start time of a sampling round.    uint64 msg_timestamp = 6;                   //Timestamp when the message is generated.    TelemetryGPBTable data_gpb = 7;             //Carried data is defined by TelemetryGPBTable.    uint64 collection_end_time = 8;                   //End time of a sampling round.    uint32 current_period = 9;                  //Sampling precision, in milliseconds.    string except_desc = 10;        //Exception description, which is reported when a sampling exception occurs.    string product_name = 11;       //Product name.    enum Encoding {     Encoding_GPB = 0;        //GPB encoding format.     Encoding_JSON = 1;       //JSON encoding format.   };   Encoding encoding = 12;   //Data encoding format. If the GPB encoding format is used, the data_gpb field is valid. Otherwise, the data_str field is valid.   string data_str = 14;   //This field is valid only when a non-GPB encoding format is used.   string ne_id = 15;               //Unique NE ID, which identifies the NE to which data belongs in the gateway scenario.   string software_version = 16;    //Software version number.   string mac_address = 17;    //System MAC address.   string esn = 18;    //Device ESN. } message TelemetryGPBTable {                 //TelemetryGPBTable message structure definition.   repeated TelemetryRowGPB row = 1;           //TelemetryRowGPB data.   repeated DataPath delete = 2;      //Delete a data path.   Generator generator = 3;           //Data source description, which applies to the OnChange+ service that requires high reliability. }  message Generator {    uint64 generator_id = 1;         //Data source ID. Multiple data sources can provide data concurrently and maintain their own reliability.    uint32 generator_sn = 2;         //Message sequence number. The sequence numbers of messages sent by each data source must be consecutive. If the sequence numbers are not consecutive, data out-of-synchronization occurs. In this case, the collector must be automatically disconnected from the device and re-connected. Values are assigned from 0 up to 0xFFFFFFFF, after which it starts from 0 again.    bool generator_sync = 3;         //Data source synchronization. The value true indicates that full OnChange data is being synchronized. If the value is true and no data is contained, the synchronization is complete. } message TelemetryRowGPB {     uint64 timestamp = 1;                       //Timestamp of the current sampling instance.    Path path = 2;                    //Data tree node, which contains only the data path and key field information.    bytes content = 11;                         //Sampling instance data carried. It is used with the sensor_path field to determine which .proto file is used for encoding. } message DataPath {    uint64 timestamp = 1;                //Timestamp of the current sampling instance.    Path path = 2;                       //Data tree node, which contains only the data path and key field information. } message Path {    repeated PathElem node = 1;          //Data tree node, which contains only the data path and key field information. }                                        message PathElem {                         string name = 1;                      //Name of the data tree node.   map<string, string> key = 2;          //key field name and value mapping table of the data tree node. }  message TelemetrySelfDefinedEvent {   string path = 1;         //Sampling path that triggers the customized event, which describes the method of parsing the content.   string proto_path = 13;  //Sampling path corresponding to the message path defined in the .proto file.   uint32 level = 2;        //Level of the customized event.   string description = 3;  //Description of the customized event.   string fieldName = 4; //Name of the field that triggers the customized event.   uint64 fieldValue = 5;   //Value of the field that triggers the customized event.   TelemetrySelfDefineThresTable data_threshold = 6; //Threshold filter criteria when the customized event is triggered.   enum ThresholdRelation {       ThresholdRelation_INVALID = 0; //The relationship between thresholds is not configured.       ThresholdRelation_AND = 1; //The relationship between thresholds is And.       ThresholdRelation_OR = 2; //The relationship between thresholds is Or.   }   ThresholdRelation thresholdRelation = 7; //Relationship between threshold filter criteria when the customized event is triggered.   bytes content = 8; //Sampled data that triggers the customized event. } message TelemetrySelfDefineThresTable {   repeated TelemetryThreshold row = 1; //Multiple thresholds are included. } message TelemetryThreshold {   uint64 thresholdValue = 1; //Delivered threshold.   enum ThresholdOpType {       ThresholdOpType_EQ = 0; //The actual value in the data sent is equal to the configured data threshold.       ThresholdOpType_GT = 1; //The actual value in the data sent is greater than the configured data threshold.       ThresholdOpType_GE = 2; //The actual value in the data sent is greater than or equal to the configured data threshold.       ThresholdOpType_LT = 3; //The actual value in the data sent is less than the configured data threshold.       ThresholdOpType_LE = 4; //The actual value in the data sent is less than or equal to the configured data threshold.   }   ThresholdOpType thresholdOpType = 2; //Threshold on the device. } ``` |
* A service data file describes the detailed service data formats. For details, see the sampling paths supported by telemetry.