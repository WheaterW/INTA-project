
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Configuring a Spanning Tree Protocol">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../dc/dc_cfg_m-lag_0020.html">
<meta name="DC.Relation" scheme="URI" content="../dc/dc_cfg_m-lag_0008.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation">
<meta name="DC.Publisher" content="20230413">
<meta name="featurename" content="M-LAG">
<meta name="featuretype" content="High Availability">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="M-LAG">
<meta name="featuretype" content="High Availability">
<meta name="featurename" content="M-LAG">
<meta name="featuretype" content="High Availability">
<meta name="featuretype" content="High Availability">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0000001563769161">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../public_sys-resources/commonltr.css">
<link rel="stylesheet" type="text/css" href="../public_sys-resources/mediaQuery.css">
<script language="javascript" type="text/javascript" src="../public_sys-resources/browseVersion.js"></script>
<title>Configuring a Spanning Tree Protocol</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0000001563769161"></a><a name="EN-US_TASK_0000001563769161"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Configuring a Spanning Tree Protocol</h1>
<div class="taskbody"><div class="context"><a name="EN-US_TASK_0000001563769161__1.3.1"></a><a name="1.3.1"></a><h4 class="sectiontitle">Context</h4>
<div class="p"><p>To prevent loops on an M-LAG network, two M-LAG member devices are considered as one device for STP calculation and can work in root bridge mode, Virtual Spanning Tree Protocol (V-STP) mode, or Virtual VLAN-based Spanning Tree (V-VBST) mode. <a href="#EN-US_TASK_0000001563769161__table115834618389">Table 1</a> describes the differences between the three modes.</p>

<div class="tableBorder"><a name="EN-US_TASK_0000001563769161__table115834618389"></a><a name="table115834618389"></a><table cellpadding="4" cellspacing="0" summary="" id="EN-US_TASK_0000001563769161__table115834618389" frame="border" border="1" rules="all"><caption><b>Table 1 </b><span>Comparison between the root bridge, V-STP, and V-VBST modes</span></caption><thead align="left"><tr><th align="left" class="cellrowborder" valign="top" width="10.66893310668933%" id="mcps1.3.1.2.2.5.1.1" liSelected="liSelected"><p>Mode</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="25.72742725727427%" id="mcps1.3.1.2.2.5.1.2" liSelected="liSelected"><p>Application Scenario</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="32.776722327767224%" id="mcps1.3.1.2.2.5.1.3" liSelected="liSelected"><p>Configuration Method</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="30.826917308269174%" id="mcps1.3.1.2.2.5.1.4" liSelected="liSelected"><p>Application Limitations</p>
</th>
</tr>
</thead>
<tbody><tr><td class="cellrowborder" valign="top" width="10.66893310668933%" headers="mcps1.3.1.2.2.5.1.1 "><p>Root bridge mode</p>
</td>
<td class="cellrowborder" valign="top" width="25.72742725727427%" headers="mcps1.3.1.2.2.5.1.2 "><p>Applicable to scenarios where M-LAG master and backup devices function as root bridges on a Layer 2 network.</p>
</td>
<td class="cellrowborder" valign="top" width="32.776722327767224%" headers="mcps1.3.1.2.2.5.1.3 "><p>Configure the M-LAG master and backup devices as root bridges with the same bridge ID on the network running a spanning tree protocol so that the two devices are simulated into one root bridge. Set the root priority to the highest to ensure that the M-LAG is the root node.</p>
</td>
<td class="cellrowborder" valign="top" width="30.826917308269174%" headers="mcps1.3.1.2.2.5.1.4 "><ul><li>In this mode, only STP, RSTP, and MSTP are supported, and STP multi-process is not supported.</li><li>Multi-level M-LAG in root bridge mode is not supported.</li><li><p>Because the M-LAG master and backup devices need to be simulated into one root bridge, you need to disable STP on peer-link interfaces to ensure that the directly connected interfaces are not blocked.</p>
</li></ul>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="10.66893310668933%" headers="mcps1.3.1.2.2.5.1.1 "><p>V-STP mode</p>
</td>
<td class="cellrowborder" valign="top" width="25.72742725727427%" headers="mcps1.3.1.2.2.5.1.2 "><ul><li>Applicable to scenarios where an M-LAG connects to a network running a spanning tree protocol.</li><li>This mode applies to multi-level M-LAG deployment.</li></ul>
</td>
<td class="cellrowborder" valign="top" width="32.776722327767224%" headers="mcps1.3.1.2.2.5.1.3 "><p>After the V-STP function is enabled, the spanning tree protocol status is synchronized between the M-LAG master and backup devices so that they are simulated into one device to perform STP calculation.</p>
</td>
<td class="cellrowborder" valign="top" width="30.826917308269174%" headers="mcps1.3.1.2.2.5.1.4 "><ul><li>In this mode, only STP and RSTP are supported, and STP multi-process is supported.</li><li>The M-LAG member interface configurations on the M-LAG master and backup devices must be the same.</li><li>Because the M-LAG master and backup devices need to exchange packets through the peer-link to perform STP virtualization calculation, you need to enable STP on peer-link interfaces. The STP configurations on the peer-link interfaces of the two devices must be the same.</li></ul>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="10.66893310668933%" headers="mcps1.3.1.2.2.5.1.1 "><p>V-VBST mode</p>
</td>
<td class="cellrowborder" valign="top" width="25.72742725727427%" headers="mcps1.3.1.2.2.5.1.2 "><ul><li>Applicable to scenarios where an M-LAG connects to a network running VBST.</li><li>This mode applies to multi-level M-LAG deployment.</li></ul>
</td>
<td class="cellrowborder" valign="top" width="32.776722327767224%" headers="mcps1.3.1.2.2.5.1.3 "><p>After the V-VBST function is enabled, the VBST status is synchronized between the M-LAG master and backup devices so that they are simulated into one device to perform VBST calculation.</p>
</td>
<td class="cellrowborder" valign="top" width="30.826917308269174%" headers="mcps1.3.1.2.2.5.1.4 "><ul><li>Only VBST is supported in this mode.</li><li>The M-LAG member interface configurations on the M-LAG master and backup devices must be the same.</li><li>Because the M-LAG master and backup devices need to exchange packets through the peer-link to perform STP virtualization calculation, you need to enable VBST on peer-link interfaces.</li></ul>
</td>
</tr>
</tbody>
</table>
</div>
<p>As shown in <a href="#EN-US_TASK_0000001563769161__fig84229095120">Figure 1</a>, DeviceA and DeviceB set up an M-LAG, so do DeviceC and DeviceD. The two M-LAGs are connected, simplifying the networking and allowing more servers to be dual-homed to the network. Multi-level M-LAG must be configured based on V-STP or V-VBST.</p>
<div class="fignone" id="EN-US_TASK_0000001563769161__fig84229095120"><a name="EN-US_TASK_0000001563769161__fig84229095120"></a><a name="fig84229095120"></a><span class="figcap"><b>Figure 1 </b>Multi-level M-LAG networking</span><br><span><img class="vsd" src="figure/en-us_image_0000001513168942.png" width="NaN" height="NaN"></span></div>
</div></div>
<div class="steps-unordered"><a name="EN-US_TASK_0000001563769161__1.3.2"></a><a name="1.3.2"></a><h4 class="sectiontitle">Procedure</h4>
<ul><li><span>Configure the root bridge mode.</span><ol><li class="substepexpand"><span>Enter the system view.</span><p><pre class="screen"><a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></pre>
</p></li><li class="substepexpand"><span>Configure the device as the root bridge.</span><p><pre class="screen"><a href="cmdqueryname=stp+root"><b><span class="cmdname">stp</span></b></a> [ <strong><span>instance</span></strong> <i><span class="varname">instance-id</span></i> ] <strong><span>root primary</span></strong></pre>
<div class="p">By default, a device does not function as the root bridge of any spanning tree. After the configuration is complete, the device's priority in a spanning tree is 0, which cannot be changed.<div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If <strong><span>instance</span></strong> is not specified, the device is the root bridge in MSTI 0.</p>
</div></div>
</div>
</p></li><li class="substepexpand"><span>Configure the bridge MAC address used by the device for spanning tree calculation.</span><p><pre class="screen"><a href="cmdqueryname=stp+bridge-address"><b><span class="cmdname">stp bridge-address</span></b></a> <i><span class="varname">mac-address</span></i></pre>
<p>By default, a device uses its MAC address as the bridge MAC address for spanning tree calculation. You are advised to use the smaller MAC address of the M-LAG master and backup device as the bridge MAC address for spanning tree calculation.</p>
</p></li><li class="substepexpand"><span>Commit the configuration.</span><p><pre class="screen" id="EN-US_TASK_0000001563769161__en-us_task_0228023023_screen14848162118611"><a href="cmdqueryname=commit"><b><span class="cmdname" id="EN-US_TASK_0000001563769161__en-us_task_0228023023_cmdname1784862115612">commit</span></b></a></pre>
</p></li></ol>
</li><li><span>Configure the V-STP mode.</span><ol><li class="substepexpand"><span>Enter the system view.</span><p><pre class="screen"><a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></pre>
</p></li><li class="substepexpand"><span>Configure the device to work in STP or RSTP mode.</span><p><pre class="screen"><a href="cmdqueryname=stp+mode"><b><span class="cmdname">stp mode</span></b></a> { <a href="cmdqueryname=stp"><b><span class="cmdname">stp</span></b></a> | <a href="cmdqueryname=rstp"><b><span class="cmdname">rstp</span></b></a> }</pre>
<p>By default, a device works in MSTP mode.</p>
</p></li><li class="substepexpand"><span>(Optional) Configure the bridge MAC address used by the device for spanning tree calculation.</span><p><pre class="screen"><a href="cmdqueryname=stp+bridge-address"><b><span class="cmdname">stp bridge-address</span></b></a> <i><span class="varname">mac-address</span></i></pre>
<p>By default, a device uses its MAC address as the bridge MAC address for spanning tree calculation.</p>
<div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>To prevent network flapping caused by device restart or DFS master/backup switchover and ensure switchback performance, you are advised to set a larger bridge MAC address for the M-LAG backup device when the M-LAG master and backup devices have the same priority.</p>
</div></div>
</p></li><li class="substepexpand"><span>Enable the V-STP mode.</span><p><pre class="screen"><a href="cmdqueryname=stp+v-stp+enable"><b><span class="cmdname">stp v-stp enable</span></b></a></pre>
<p>By default, the V-STP mode is disabled.</p>
</p></li><li class="substepexpand"><span>(Optional) Configure the M-LAG member interface to send BPDUs with an extended port ID.</span><p><pre class="screen"><a href="cmdqueryname=stp+v-stp+port-id-extension+enable"><b><span class="cmdname">stp v-stp port-id-extension enable</span></b></a> </pre>
<p>By default, the port ID carried in BPDUs sent by the M-LAG member interface in V-STP mode is 1.</p>
<div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>After the interface on the downstream device is configured to transparently transmit packets, BPDUs sent by M-LAG member interfaces are looped back to the two V-STP-enabled upstream devices. In this case, the system MAC address and port ID in BPDUs received by the M-LAG member interfaces on the upstream devices are the same as those of the interfaces. As a result, the M-LAG member interfaces are incorrectly blocked. You can run this command to change the port ID so that the port ID carried in BPDUs sent by the M-LAG member interface is different from the port ID of the interface, avoiding this problem.</p>
</div></div>
</p></li><li class="substepexpand"><span>Commit the configuration.</span><p><pre class="screen" id="EN-US_TASK_0000001563769161__en-us_task_0228023023_screen14848162118611_1"><a href="cmdqueryname=commit"><b><span class="cmdname" id="EN-US_TASK_0000001563769161__en-us_task_0228023023_cmdname1784862115612_1">commit</span></b></a></pre>
</p></li></ol>
<p><div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><ul><li>In a V-STP scenario, you are advised to configure M-LAG and connect cables in the following sequence:<ol><li>Configure V-STP.</li><li>Configure a DFS group, DAD, and peer-link interfaces.</li><li>Connect peer-link interfaces of M-LAG master and backup devices.</li><li>Configure M-LAG member interfaces and use cables to connect M-LAG master and backup devices to user-side devices.</li></ol>
</li><li>In a V-STP scenario, if uplink interfaces of the devices are VLANIF interfaces, disable STP on physical uplink interfaces or configure the physical uplink interfaces to work in Layer 3 mode. Otherwise, some interfaces may be incorrectly blocked, causing traffic interruption. In a virtual peer-link scenario, DFS group pairing fails.</li></ul>
</div></div>
</p></li><li><span>Configure the V-VBST mode.</span><ol><li class="substepexpand"><span>Enter the system view.</span><p><pre class="screen"><a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></pre>
</p></li><li class="substepexpand"><span>Configure the device to work in VBST mode.</span><p><pre class="screen"><a href="cmdqueryname=stp+mode+vbst"><b><span class="cmdname">stp mode vbst</span></b></a></pre>
<p>By default, a device works in MSTP mode.</p>
<div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The VBST mode is mutually exclusive with the STP, RSTP, and MSTP modes.</p>
<p>If 1:<em>N</em> (<em>N</em> &gt; 1) mapping between instances and VLANs has been configured on the device, you must delete the mapping before changing the spanning tree protocol mode to VBST mode.</p>
</div></div>
</p></li><li class="substepexpand"><span>Enable VBST.</span><p><pre class="screen"><a href="cmdqueryname=stp+enable"><b><span class="cmdname">stp enable</span></b></a></pre>
</p></li><li class="substepexpand"><span>Enable VBST in a VLAN.</span><p><pre class="screen"><a href="cmdqueryname=stp+vlan+disable"><b><span class="cmdname">undo stp vlan</span></b></a> <i><span class="varname">vlan-id</span></i>1 [ <strong><span>to</span></strong> <i><span class="varname">vlan-id</span></i>2 ] [ <i><span class="varname">vlan-id3</span></i> [ <strong><span>to</span></strong> <i><span class="varname">vlan-id4</span></i> ] ] &amp;&lt;1-9&gt; <strong><span>disable</span></strong></pre>
<p>By default, a spanning tree protocol is enabled in all VLANs on the device.</p>
</p></li><li class="substepexpand"><span>Enter the interface view.</span><p><pre class="screen"><a href="cmdqueryname=interface"><b><span class="cmdname">interface</span></b></a> <i><span class="varname">interface-type interface-number</span></i></pre>
</p></li><li class="substepexpand"><span>Enable VBST on the interface.</span><p><pre class="screen"><a href="cmdqueryname=stp+enable"><b><span class="cmdname">stp enable</span></b></a></pre>
<p>By default, a spanning tree protocol is enabled on an interface of the device.</p>
</p></li><li class="substepexpand"><span>Commit the configuration.</span><p><pre class="screen" id="EN-US_TASK_0000001563769161__en-us_task_0228023023_screen14848162118611_2"><a href="cmdqueryname=commit"><b><span class="cmdname" id="EN-US_TASK_0000001563769161__en-us_task_0228023023_cmdname1784862115612_2">commit</span></b></a></pre>
</p></li></ol>
<p><div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><ul><li>After the <a href="cmdqueryname=stp+mode+vbst"><b><span class="cmdname">stp mode vbst</span></b></a> command and the peer-link interface are configured, the device automatically enables the V-VBST function.</li><li>In a V-VBST scenario, you are advised to configure M-LAG and connect cables in the following sequence:<ol><li>Configure V-VBST.</li><li>Configure a DFS group, DAD, and peer-link interfaces.</li><li>Connect peer-link interfaces of M-LAG master and backup devices.</li><li>Configure M-LAG member interfaces and use cables to connect M-LAG master and backup devices to user-side devices.</li></ol>
</li><li>In a V-VBST scenario, if uplink interfaces of the devices are VLANIF interfaces, disable STP on physical uplink interfaces or configure the physical uplink interfaces to work in Layer 3 mode. Otherwise, some interfaces may be incorrectly blocked, causing traffic interruption. In a virtual peer-link scenario, DFS group pairing fails.</li></ul>
</div></div>
</p></li></ul></div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../dc/dc_cfg_m-lag_0020.html">Configuring an M-LAG
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="copyrightBottomBar_responsive">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../dc/dc_cfg_m-lag_0008.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>