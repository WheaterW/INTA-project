
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring IPv4 Layer 3 Multicast over VXLAN (Inter-AS)">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="vrp_ipv4_multi_over_vxlan_cfg_0010.html">
<meta name="DC.Relation" scheme="URI" content="vrp_ipv4_multi_over_vxlan_cfg_0018.html">
<meta name="DC.Relation" scheme="URI" content="vrp_ipv4_multi_over_vxlan_cfg_0020.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation">
<meta name="DC.Publisher" content="20230413">
<meta name="featurename" content="IPv4 Layer 3 Multicast over VXLAN">
<meta name="featuretype" content="IP Multicast">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="IPv4 Layer 3 Multicast over VXLAN">
<meta name="featuretype" content="IP Multicast">
<meta name="featurename" content="IPv4 Layer 3 Multicast over VXLAN">
<meta name="featuretype" content="IP Multicast">
<meta name="featuretype" content="IP Multicast">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0000001136013618">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="public_sys-resources/commonltr.css">
<link rel="stylesheet" type="text/css" href="public_sys-resources/mediaQuery.css">
<script language="javascript" type="text/javascript" src="public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring IPv4 Layer 3 Multicast over VXLAN (Inter-AS)</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0000001136013618"></a><a name="EN-US_TASK_0000001136013618"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring IPv4 Layer 3 Multicast over VXLAN (Inter-AS)</h1>
<div class="taskbody"><div class="context"><a name="EN-US_TASK_0000001136013618__1.3.1"></a><a name="1.3.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>In <a href="#EN-US_TASK_0000001136013618__fig_dc_vrp_multicast_cfg_007401">Figure 1</a>, Leaf 1, Leaf 2, and Leaf 3 are deployed as distributed VXLAN gateways on the IPv4 network. Leaf 1 is in AS 100, whereas Leaf 2 and Leaf 3 are in AS 200. The three leaf nodes all use AS 300 as the BGP EVPN multi-instance process ID to establish BGP EVPN peer relationships.</p>
<p>The multicast source accesses the VXLAN network through a Layer 2 sub-interface that belongs to BD10 on Leaf 1. Receiver 1 accesses the VXLAN network through a Layer 2 sub-interface that belongs to BD20 on Leaf 1. Receiver 2 accesses Leaf 2 through a CE. VPN Layer 3 multicast is deployed between the CE and Leaf 2. Leaf 2 is directly connected to the CE through a common Layer 3 interface. Receivers 3 and 4 access the VXLAN network through Layer 2 sub-interfaces on Leaf 3, which belong to BD10 and BD20, respectively. The source, Receiver 1, Receiver 3, and Receiver 4 are on the VXLAN overlay network, and Receiver 2 is on an external network. Receiver 1, receiver 2, and receiver 3 each order a program with a multicast source specified, and the related multicast group addresses are 232.1.1.1, 232.1.1.2, and 232.1.1.3, respectively. Receiver 4 orders a program with no multicast source specified, and the related multicast group address is 225.1.1.1.</p>
<p>In this case, you need to configure IPv4 Layer 3 multicast on the VXLAN network where distributed gateways are deployed.</p>
<div class="fignone" id="EN-US_TASK_0000001136013618__fig_dc_vrp_multicast_cfg_007401"><a name="EN-US_TASK_0000001136013618__fig_dc_vrp_multicast_cfg_007401"></a><a name="fig_dc_vrp_multicast_cfg_007401"></a><span class="figcap"><b>Figure 1 </b>Configuring IPv4 Layer 3 multicast over VXLAN (inter-AS)</span><div class="note"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>In this example, interface1, interface2, interface3, and interface4 represent <span>100GE</span><span>1/0/1</span>, <span>100GE</span><span>1/0/2</span>, <span>100GE</span><span>1/0/3</span>, and <span>100GE</span><span>1/0/4</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0000001211800308.png"></span></div>

<div class="tableBorder"><table cellpadding="4" cellspacing="0" summary="" frame="border" border="1" rules="all"><caption><b>Table 1 </b>Device interface information</caption><thead align="left"><tr><th align="left" class="cellrowborder" valign="top" width="9.31093109310931%" id="mcps1.3.1.6.2.4.1.1" liSelected="liSelected"><p>Device</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="19.99199919991999%" id="mcps1.3.1.6.2.4.1.2" liSelected="liSelected"><p>Interface</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="70.6970697069707%" id="mcps1.3.1.6.2.4.1.3" liSelected="liSelected"><p>IP Address</p>
</th>
</tr>
</thead>
<tbody><tr><td class="cellrowborder" rowspan="7" valign="middle" width="9.31093109310931%" headers="mcps1.3.1.6.2.4.1.1 "><p>Leaf1</p>
</td>
<td class="cellrowborder" valign="top" width="19.99199919991999%" headers="mcps1.3.1.6.2.4.1.2 "><p><span>100GE</span><span>1/0/1</span></p>
</td>
<td class="cellrowborder" valign="top" width="70.6970697069707%" headers="mcps1.3.1.6.2.4.1.3 "><p>10.1.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p><span>100GE</span><span>1/0/2</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>10.1.2.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>VBDIF10</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>192.168.10.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>VBDIF20</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>192.168.20.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>LoopBack1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>1.1.1.1/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>LoopBack2</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>1.1.1.9/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>LoopBack3</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>1.1.1.10/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="6" valign="middle" width="9.31093109310931%" headers="mcps1.3.1.6.2.4.1.1 "><p>Leaf2</p>
</td>
<td class="cellrowborder" valign="top" width="19.99199919991999%" headers="mcps1.3.1.6.2.4.1.2 "><p><span>100GE</span><span>1/0/1</span></p>
</td>
<td class="cellrowborder" valign="top" width="70.6970697069707%" headers="mcps1.3.1.6.2.4.1.3 "><p>10.1.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p><span>100GE</span><span>1/0/2</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>10.1.3.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p><span>100GE</span><span>1/0/3</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>192.168.30.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>VBDIF10</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>192.168.10.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>LoopBack1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>2.2.2.2/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>LoopBack2</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>2.2.2.9/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="6" valign="middle" width="9.31093109310931%" headers="mcps1.3.1.6.2.4.1.1 "><p>Leaf3</p>
</td>
<td class="cellrowborder" valign="top" width="19.99199919991999%" headers="mcps1.3.1.6.2.4.1.2 "><p><span>100GE</span><span>1/0/1</span></p>
</td>
<td class="cellrowborder" valign="top" width="70.6970697069707%" headers="mcps1.3.1.6.2.4.1.3 "><p>10.1.2.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p><span>100GE</span><span>1/0/2</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>10.1.3.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>VBDIF10</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>192.168.10.3/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>VBDIF20</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>192.168.20.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>LoopBack1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>3.3.3.3/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p>LoopBack2</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>3.3.3.9/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="2" valign="middle" width="9.31093109310931%" headers="mcps1.3.1.6.2.4.1.1 "><p>CE</p>
</td>
<td class="cellrowborder" valign="top" width="19.99199919991999%" headers="mcps1.3.1.6.2.4.1.2 "><p><span>100GE</span><span>1/0/1</span></p>
</td>
<td class="cellrowborder" valign="top" width="70.6970697069707%" headers="mcps1.3.1.6.2.4.1.3 "><p>192.168.30.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.1 "><p><span>100GE</span><span>1/0/2</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.3.1.6.2.4.1.2 "><p>192.168.40.1/24</p>
</td>
</tr>
</tbody>
</table>
</div>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001136013618__1.3.2"></a><a name="1.3.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><div class="p">The configuration roadmap is as follows:<ol><li><p>Configure each leaf node to set up VXLAN tunnels using BGP EVPN, deploy distributed gateways, and implement Layer 3 communication between Leaf-side hosts through VPN routes.</p>
</li><li><p>Configure BUM multicast replication for the Layer 3 VNI of the L3VPN instance on each leaf.</p>
</li><li><p>Establish a BGP MVPN peer relationship between any two of Leaf 1, Leaf 2, and Leaf 3.</p>
</li><li><p>Configure a VXLAN I-PMSI tunnel on each leaf node.</p>
</li><li><p>Enable PIM-SM on the interface bound to the L3VPN instance on each leaf node to establish a C-multicast routing table.</p>
</li><li><p>Configure IGMP on each VBDIF interface, and on each physical interface connected to user network segments.</p>
</li><li><p>Configure VPN Layer 3 multicast between Leaf 2 and the CE.</p>
</li></ol>
</div>
</div></div>
<div class="steps"><a name="EN-US_TASK_0000001136013618__1.3.3"></a><a name="1.3.3"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure IP addresses for interfaces on each device. The configurations of Leaf 2, Leaf 3, and CE are similar to the configuration of Leaf 1. For detailed configurations, see Configuration Scripts.</span><p><pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname Leaf1</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>Leaf1-LoopBack1] <strong>ip address 1.1.1.1 32</strong>
[<span class="keyword">*</span>Leaf1-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>interface loopback 2</strong>
[<span class="keyword">*</span>Leaf1-LoopBack2] <strong>ip address 1.1.1.9 32</strong>
[<span class="keyword">*</span>Leaf1-LoopBack2] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>interface loopback 3</strong>
[<span class="keyword">*</span>Leaf1-LoopBack3] <strong>ip address 1.1.1.10 32</strong>
[<span class="keyword">*</span>Leaf1-LoopBack3] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>interface <span>100ge</span> <span>1/0/1</span></strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/1</span>] <strong>undo portswitch</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/1</span>] <strong>ip address 10.1.1.1 24</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/1</span>] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>interface <span>100ge</span> <span>1/0/2</span></strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/2</span>] <strong>undo portswitch</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/2</span>] <strong>ip address 10.1.2.1 24</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/2</span>] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
</p></li><li><span>Configure VXLAN.</span><p><p># Configure BGP on the VXLAN underlay network.</p>
<ul><li>Configure Leaf 1.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>bgp 100</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>peer 10.1.1.2 as-number 200</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>peer 10.1.2.2 as-number 200</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>network 1.1.1.1 32</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>network 1.1.1.9 32</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
</li><li>Configure Leaf 2.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2] <strong>bgp 200</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>peer 10.1.1.1 as-number 100</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>peer 10.1.3.2 as-number 200</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>network 2.2.2.2 32</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>network 2.2.2.9 32</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2] <strong>commit</strong></pre>
</li><li>Configure Leaf 3.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3] <strong>bgp 200</strong>
[<span class="keyword">*</span>Leaf3-bgp] <strong>peer 10.1.2.1 as-number 100</strong>
[<span class="keyword">*</span>Leaf3-bgp] <strong>peer 10.1.3.1 as-number 200</strong>
[<span class="keyword">*</span>Leaf3-bgp] <strong>network 3.3.3.3 32</strong>
[<span class="keyword">*</span>Leaf3-bgp] <strong>network 3.3.3.9 32</strong>
[<span class="keyword">*</span>Leaf3-bgp] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3] <strong>commit</strong></pre>
</li></ul>
<p># Configure service access points on Leaf 1 and Leaf 3. The configuration of Leaf 3 is similar to the configuration of Leaf 1. For detailed configurations, see Configuration Scripts. Because Leaf 2 is directly connected to the CE through a common Layer 3 interface, you do not need to configure a service access point on Leaf 2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>bridge-domain 10</strong>
[<span class="keyword">*</span>Leaf1-bd10] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>interface <span>100ge</span> <span>1/0/3</span>.1 mode l2</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/3</span>.1] <strong>undo portswitch</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/3</span>.1] <strong>encapsulation dot1q vid 10</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/3</span>.1] <strong>bridge-domain 10</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/3</span>.1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>bridge-domain 20</strong>
[<span class="keyword">*</span>Leaf1-bd20] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>interface <span>100ge</span> <span>1/0/4</span>.1 mode l2</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/4</span>.1] <strong>undo portswitch</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/4</span>.1] <strong>encapsulation dot1q vid 20</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/4</span>.1] <strong>bridge-domain 20</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/4</span>.1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
<p>Configure BGP EVPN on each leaf node as a VXLAN control plane protocol. The configurations of Leaf 2 and Leaf 3 are similar to the configuration of Leaf 1. For detailed configurations, see Configuration Scripts.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>evpn-overlay enable</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
<p># Establish BGP EVPN peer relationships between the leaf nodes. The configurations of Leaf 2 and Leaf 3 are similar to the configuration of Leaf 1. For detailed configurations, see Configuration Scripts.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>bgp 300 instance evpn1</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1] <strong>peer 2.2.2.9 as-number 300</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1] <strong>peer 2.2.2.9 connect-interface LoopBack2</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1] <strong>peer 3.3.3.9 as-number 300</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1] <strong>peer 3.3.3.9 connect-interface LoopBack2</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1] <strong>l2vpn-family evpn</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1-af-evpn] <strong>peer 2.2.2.9 enable</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1-af-evpn] <strong>peer 3.3.3.9 enable</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1-af-evpn] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
<p># Configure L3VPN and EVPN instances on each leaf node. The configurations of Leaf 2 and Leaf 3 are similar to the configuration of Leaf 1. For detailed configurations, see Configuration Scripts.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>ip vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1] <strong>vxlan vni 5010</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1] <strong>ipv4-family</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4] <strong>route-distinguisher 1:1</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4] <strong>vpn-target 1:1</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4] <strong>vpn-target 13:1 evpn</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>bridge-domain 10</strong>
[<span class="keyword">*</span>Leaf1-bd10] <strong>vxlan vni 10</strong>
[<span class="keyword">*</span>Leaf1-bd10] <strong>evpn</strong>
[<span class="keyword">*</span>Leaf1-bd10-evpn] <strong>route-distinguisher 11:1</strong>
[<span class="keyword">*</span>Leaf1-bd10-evpn] <strong>vpn-target 12:1</strong>
[<span class="keyword">*</span>Leaf1-bd10-evpn] <strong>vpn-target 13:1</strong>
[<span class="keyword">*</span>Leaf1-bd10-evpn] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1-bd10] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>bridge-domain 20</strong>
[<span class="keyword">*</span>Leaf1-bd20] <strong>vxlan vni 20</strong>
[<span class="keyword">*</span>Leaf1-bd20] <strong>evpn</strong>
[<span class="keyword">*</span>Leaf1-bd20-evpn] <strong>route-distinguisher 11:2</strong>
[<span class="keyword">*</span>Leaf1-bd20-evpn] <strong>vpn-target 12:2</strong>
[<span class="keyword">*</span>Leaf1-bd20-evpn] <strong>vpn-target 13:1</strong>
[<span class="keyword">*</span>Leaf1-bd20-evpn] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1-bd20] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
<p># Configure ingress replication on each leaf node. The configurations of Leaf 2 and Leaf 3 are similar to the configuration of Leaf 1. For detailed configurations, see Configuration Scripts.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>interface nve 1</strong>
[<span class="keyword">*</span>Leaf1-Nve1] <strong>source 1.1.1.9</strong>
[<span class="keyword">*</span>Leaf1-Nve1] <strong>vni 10 head-end peer-list protocol bgp</strong>
[<span class="keyword">*</span>Leaf1-Nve1] <strong>vni 20 head-end peer-list protocol bgp</strong>
[<span class="keyword">*</span>Leaf1-Nve1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
<p># Configure a Layer 3 VXLAN gateway on each leaf node.</p>
<ul><li>Configure Leaf 1 as a Layer 3 VXLAN gateway.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>interface vbdif 10</strong>
[<span class="keyword">*</span>Leaf1-Vbdif10] <strong>ip binding vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf1-Vbdif10] <strong>ip address 192.168.10.1 24</strong>
[<span class="keyword">*</span>Leaf1-Vbdif10] <strong>vxlan anycast-gateway enable</strong>
[<span class="keyword">*</span>Leaf1-Vbdif10] <strong>arp collect host enable</strong>
[<span class="keyword">*</span>Leaf1-Vbdif10] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>interface vbdif 20</strong>
[<span class="keyword">*</span>Leaf1-Vbdif20] <strong>ip binding vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf1-Vbdif20] <strong>ip address 192.168.20.1 24</strong>
[<span class="keyword">*</span>Leaf1-Vbdif20] <strong>vxlan anycast-gateway enable</strong>
[<span class="keyword">*</span>Leaf1-Vbdif20] <strong>arp collect host enable</strong>
[<span class="keyword">*</span>Leaf1-Vbdif20] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
</li><li>Configure Leaf 2 as a Layer 3 VXLAN gateway. Because Receiver 2 accesses Leaf 2 through the CE, Leaf 2 does not need to advertise host routes. As such, the <a href="cmdqueryname=arp+collect+host+enable"><b><span class="cmdname">arp collect host enable</span></b></a> command does not need to be run on Leaf 2 for host information collection.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2] <strong>interface vbdif 10</strong>
[<span class="keyword">*</span>Leaf2-Vbdif10] <strong>ip binding vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf2-Vbdif10] <strong>ip address 192.168.10.2 24</strong>
[<span class="keyword">*</span>Leaf2-Vbdif10] <strong>vxlan anycast-gateway enable</strong>
[<span class="keyword">*</span>Leaf2-Vbdif10] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2] <strong>commit</strong></pre>
</li><li>Configure Leaf 3 as a Layer 3 VXLAN gateway.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3] <strong>interface vbdif 10</strong>
[<span class="keyword">*</span>Leaf3-Vbdif10] <strong>ip binding vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf3-Vbdif10] <strong>ip address 192.168.10.3 24</strong>
[<span class="keyword">*</span>Leaf3-Vbdif10] <strong>vxlan anycast-gateway enable</strong>
[<span class="keyword">*</span>Leaf3-Vbdif10] <strong>arp collect host enable</strong>
[<span class="keyword">*</span>Leaf3-Vbdif10] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3] <strong>interface vbdif 20</strong>
[<span class="keyword">*</span>Leaf3-Vbdif20] <strong>ip binding vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf3-Vbdif20] <strong>ip address 192.168.20.2 24</strong>
[<span class="keyword">*</span>Leaf3-Vbdif20] <strong>vxlan anycast-gateway enable</strong>
[<span class="keyword">*</span>Leaf3-Vbdif20] <strong>arp collect host enable</strong>
[<span class="keyword">*</span>Leaf3-Vbdif20] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3] <strong>commit</strong></pre>
</li></ul>
<p># Configure Leaf 1 and Leaf 3 to advertise IRB routes to their BGP peers.</p>
<ul><li>Configure Leaf 1.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>bgp 300 instance evpn1</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1-bgp-instance-evpn1] <strong>l2vpn-family evpn</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1-bgp-instance-evpn1-af-evpn] <strong>peer 2.2.2.9 advertise irb</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1-af-evpn] <strong>peer 3.3.3.9 advertise irb</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1-af-evpn] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1-bgp-instance-evpn1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
</li><li>Configure Leaf 3.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3] <strong>bgp 300 instance evpn1</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3-bgp-instance-evpn1] <strong>l2vpn-family evpn</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3-bgp-instance-evpn1-af-evpn] <strong>peer 1.1.1.9 advertise irb</strong>
[<span class="keyword">*</span>Leaf3-bgp-instance-evpn1-af-evpn] <strong>peer 2.2.2.9 advertise irb</strong>
[<span class="keyword">*</span>Leaf3-bgp-instance-evpn1-af-evpn] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3-bgp-instance-evpn1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3] <strong>commit</strong></pre>
</li></ul>
<p># Configure Leaf 1 and Leaf 2 to advertise prefix routes to their BGP peers.</p>
<ul><li>Configure Leaf 1.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>bgp 100</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1-bgp] <strong>ipv4-family vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf1-bgp-mcast1] <strong>import-route direct</strong>
[<span class="keyword">*</span>Leaf1-bgp-mcast1] <strong>advertise l2vpn evpn</strong>
[<span class="keyword">*</span>Leaf1-bgp-mcast1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
</li><li>Configure Leaf 2.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2] <strong>bgp 200</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2-bgp] <strong>ipv4-family vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf2-bgp-mcast1] <strong>advertise l2vpn evpn</strong>
[<span class="keyword">*</span>Leaf2-bgp-mcast1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2] <strong>commit</strong></pre>
</li></ul>
<div class="p"># Configure public network Layer 3 multicast on each leaf node. The configurations of Leaf 2 and Leaf 3 are similar to the configuration of Leaf 1. For detailed configurations, see Configuration Scripts.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>multicast routing-enable</strong>
[<span class="keyword">*</span>Leaf1] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>Leaf1-LoopBack1] <strong>pim sm</strong>
[<span class="keyword">*</span>Leaf1-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>interface <span>100ge</span> <span>1/0/1</span></strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/1</span>] <strong>pim sm</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/1</span>] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>interface <span>100ge</span> <span>1/0/2</span></strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/2</span>] <strong>pim sm</strong>
[<span class="keyword">*</span>Leaf1-<span>100GE</span><span>1/0/2</span>] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>pim</strong>
[<span class="keyword">*</span>Leaf1-pim] <strong>static-rp 1.1.1.1</strong>
[<span class="keyword">*</span>Leaf1-pim] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
</div>
<div class="p"># Configure BUM multicast replication for the Layer 3 VNI of the L3VPN instance on each leaf node. The configurations of Leaf 2 and Leaf 3 are similar to the configuration of Leaf 1. For detailed configurations, see Configuration Scripts.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>interface nve 1</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1-Nve1] <strong>vni 5010 mcast-group 225.0.0.1</strong>
[<span class="keyword">*</span>Leaf1-Nve1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
</div>
<p>After the preceding configurations are complete, VXLAN tunnels can be established between the leaf nodes. You can run the <a href="cmdqueryname=display+vxlan+tunnel"><b><span class="cmdname">display vxlan tunnel</span></b></a> command to view VXLAN tunnel information. For example, in the command output on Leaf 1, the <span class="parmname"><b>State</b></span> field is <strong>up</strong>, indicating that the VXLAN tunnel is reachable. If the value of the <span class="parmname"><b>Type</b></span> field is <strong>static</strong>, the destination IP address is statically configured. If the value is <strong>dynamic</strong>, the destination IP address is dynamically learned through a protocol.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>display vxlan tunnel</strong>
Number of vxlan tunnel : 3
Tunnel ID   Source                Destination           State  Type     Uptime
-----------------------------------------------------------------------------------
4026531841  1.1.1.9               225.0.0.1             up     static   04:30:52  
4026531843  1.1.1.9               3.3.3.9               up     dynamic  04:30:52  
4026531845  1.1.1.9               2.2.2.9               up     dynamic  04:30:52 </pre>
</p></li><li><span>Establish BGP MVPN peer relationships on each leaf node.</span><p><p># Configure Leaf 1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>bgp 100</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1-bgp] <strong>peer 2.2.2.2 as-number 200</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>peer 2.2.2.2 connect-interface LoopBack1</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>peer 2.2.2.2 ebgp-max-hop 255</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>peer 3.3.3.3 as-number 200</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>peer 3.3.3.3 connect-interface LoopBack1</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>peer 3.3.3.3 ebgp-max-hop 255</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>ipv4-family mvpn</strong>
[<span class="keyword">*</span>Leaf1-bgp-af-mvpn] <strong>peer 2.2.2.2 enable</strong>
[<span class="keyword">*</span>Leaf1-bgp-af-mvpn] <strong>peer 3.3.3.3 enable</strong>
[<span class="keyword">*</span>Leaf1-bgp-af-mvpn] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
<p># Configure Leaf 2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2] <strong>bgp 200</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2-bgp] <strong>peer 1.1.1.1 as-number 100</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>peer 1.1.1.1 connect-interface LoopBack1</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>peer 1.1.1.1 ebgp-max-hop 255</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>peer 3.3.3.3 as-number 200</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>peer 3.3.3.3 connect-interface LoopBack1</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>ipv4-family mvpn</strong>
[<span class="keyword">*</span>Leaf2-bgp-af-mvpn] <strong>peer 1.1.1.1 enable</strong>
[<span class="keyword">*</span>Leaf2-bgp-af-mvpn] <strong>peer 3.3.3.3 enable</strong>
[<span class="keyword">*</span>Leaf2-bgp-af-mvpn] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2] <strong>commit</strong></pre>
<p># Configure Leaf 3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3] <strong>bgp 200</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3-bgp] <strong>peer 1.1.1.1 as-number 100</strong>
[<span class="keyword">*</span>Leaf3-bgp] <strong>peer 1.1.1.1 connect-interface LoopBack1</strong>
[<span class="keyword">*</span>Leaf3-bgp] <strong>peer 1.1.1.1 ebgp-max-hop 255</strong>
[<span class="keyword">*</span>Leaf3-bgp] <strong>peer 2.2.2.2 as-number 200</strong>
[<span class="keyword">*</span>Leaf3-bgp] <strong>peer 2.2.2.2 connect-interface LoopBack1</strong>
[<span class="keyword">*</span>Leaf3-bgp] <strong>ipv4-family mvpn</strong>
[<span class="keyword">*</span>Leaf3-bgp-af-mvpn] <strong>peer 1.1.1.1 enable</strong>
[<span class="keyword">*</span>Leaf3-bgp-af-mvpn] <strong>peer 2.2.2.2 enable</strong>
[<span class="keyword">*</span>Leaf3-bgp-af-mvpn] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3-bgp] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3] <strong>commit</strong></pre>
</p></li><li><span>Configure a VXLAN I-PMSI tunnel on each leaf node.</span><p><p># Configure Leaf 1. The MVPN ID configured on a distributed VXLAN gateway must be the VTEP IP address of the gateway.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>multicast mvpn 1.1.1.9</strong>
[<span class="keyword">*</span>Leaf1] <strong>ip vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1] <strong>ipv4-family</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4] <strong>multicast routing-enable</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4] <strong>multicast mvpn route-import local-admin-id 1</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4] <strong>mvpn</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4-mvpn] <strong>c-multicast signaling bgp</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4-mvpn] <strong>auto-discovery inter-as</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4-mvpn] <strong>spt-only mode</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4-mvpn] <strong>ipmsi-tunnel</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4-mvpn-ipmsi] <strong>vxlan static</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4-mvpn-ipmsi] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4-mvpn] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1-vpn-instance-mcast1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
<p># Configure Leaf 2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2] <strong>multicast mvpn 2.2.2.9</strong>
[<span class="keyword">*</span>Leaf2] <strong>ip vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1] <strong>ipv4-family</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1-af-ipv4] <strong>multicast routing-enable</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1-af-ipv4] <strong>multicast mvpn route-import local-admin-id 1</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1-af-ipv4] <strong>mvpn</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1-af-ipv4-mvpn] <strong>c-multicast signaling bgp</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1-af-ipv4-mvpn] <strong>auto-discovery inter-as</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1-af-ipv4-mvpn] <strong>ipmsi-tunnel</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1-af-ipv4-mvpn-ipmsi] <strong>vxlan static</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1-af-ipv4-mvpn-ipmsi] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1-af-ipv4-mvpn] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2-vpn-instance-mcast1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2] <strong>commit</strong></pre>
<p># Configure Leaf 3. Because Leaf 3-side Receiver 4 has no multicast source specified, Receiver 4 uses the (*, G) mode to join a multicast group. In this case, a PIM-SM RPT setup mode must be specified for Leaf 3 and source-side Leaf 1. In this example, the setup mode is not across the public network (<strong>spt-only mode</strong>).</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3] <strong>multicast mvpn 3.3.3.9</strong>
[<span class="keyword">*</span>Leaf3] <strong>ip vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1] <strong>ipv4-family</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1-af-ipv4] <strong>multicast routing-enable</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1-af-ipv4] <strong>multicast mvpn route-import local-admin-id 1</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1-af-ipv4] <strong>mvpn</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1-af-ipv4-mvpn] <strong>c-multicast signaling bgp</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1-af-ipv4-mvpn] <strong>auto-discovery inter-as</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1-af-ipv4-mvpn] <strong>spt-only mode</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1-af-ipv4-mvpn] <strong>ipmsi-tunnel</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1-af-ipv4-mvpn-ipmsi] <strong>vxlan static</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1-af-ipv4-mvpn-ipmsi] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1-af-ipv4-mvpn] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3-vpn-instance-mcast1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3] <strong>commit</strong></pre>
</p></li><li><span>Configure PIM-SM and IGMP on VBDIF interfaces.</span><p><p># Configure Leaf 1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>interface vbdif 10</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1-Vbdif10] <strong>pim sm</strong>
[<span class="keyword">*</span>Leaf1-Vbdif10] <strong>igmp enable</strong>
[<span class="keyword">*</span>Leaf1-Vbdif10] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>interface vbdif 20</strong>
[<span class="keyword">*</span>Leaf1-Vbdif20] <strong>pim sm</strong>
[<span class="keyword">*</span>Leaf1-Vbdif20] <strong>igmp enable</strong>
[<span class="keyword">*</span>Leaf1-Vbdif20] <strong>igmp version 3</strong>
[<span class="keyword">*</span>Leaf1-Vbdif20] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
<p># Configure Leaf 2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2] <strong>interface vbdif 10</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2-Vbdif10] <strong>pim sm</strong>
[<span class="keyword">*</span>Leaf2-Vbdif10] <strong>igmp enable</strong>
[<span class="keyword">*</span>Leaf2-Vbdif10] <strong>igmp version 3</strong>
[<span class="keyword">*</span>Leaf2-Vbdif10] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2] <strong>commit</strong></pre>
<p># Configure Leaf 3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3] <strong>interface vbdif 10</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3-Vbdif10] <strong>pim sm</strong>
[<span class="keyword">*</span>Leaf3-Vbdif10] <strong>igmp enable</strong>
[<span class="keyword">*</span>Leaf3-Vbdif10] <strong>igmp version 3</strong>
[<span class="keyword">*</span>Leaf3-Vbdif10] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3] <strong>interface vbdif 20</strong>
[<span class="keyword">*</span>Leaf3-Vbdif20] <strong>pim sm</strong>
[<span class="keyword">*</span>Leaf3-Vbdif20] <strong>igmp enable</strong>
[<span class="keyword">*</span>Leaf3-Vbdif20] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3] <strong>commit</strong></pre>
</p></li><li><span>Configure Leaf 1 and Leaf 3 as VPN static RPs.</span><p><div class="p"># Configure Leaf 1.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>interface loopback 3</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1-LoopBack3] <strong>ip binding vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf1-LoopBack3] <strong>ip address 1.1.1.10 32</strong>
[<span class="keyword">*</span>Leaf1-LoopBack3] <strong>pim sm</strong>
[<span class="keyword">*</span>Leaf1-LoopBack3] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>pim vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf1-pim-mcast1] <strong>static-rp 1.1.1.10</strong>
[<span class="keyword">*</span>Leaf1-pim-mcast1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf1] <strong>commit</strong></pre>
</div>
<div class="p"># Configure Leaf 3.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3] <strong>pim vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf3-pim-mcast1] <strong>static-rp 1.1.1.10</strong>
[<span class="keyword">*</span>Leaf3-pim-mcast1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf3] <strong>commit</strong></pre>
</div>
</p></li><li><span>Configure VPN Layer 3 multicast between Leaf 2 and the CE connected to it.</span><p><div class="p"># Configure Leaf 2.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2] <strong>interface <span>100ge</span> <span>1/0/3</span></strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2-<span>100GE</span><span>1/0/3</span>] <strong>undo portswitch</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2-<span>100GE</span><span>1/0/3</span>] <strong>ip binding vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf2-<span>100GE</span><span>1/0/3</span>] <strong>ip address 192.168.30.1 24</strong>
[<span class="keyword">*</span>Leaf2-<span>100GE</span><span>1/0/3</span>] <strong>pim sm</strong>
[<span class="keyword">*</span>Leaf2-<span>100GE</span><span>1/0/3</span>] <strong>igmp enable</strong>
[<span class="keyword">*</span>Leaf2-<span>100GE</span><span>1/0/3</span>] <strong>igmp version 3</strong>
[<span class="keyword">*</span>Leaf2-<span>100GE</span><span>1/0/3</span>] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2] <strong>ip route-static vpn-instance mcast1 192.168.40.1 24 <span>100ge</span> <span>1/0/3</span></strong>
[<span class="keyword">*</span>Leaf2] <strong>bgp 200</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>ipv4-family vpn-instance mcast1</strong>
[<span class="keyword">*</span>Leaf2-bgp-mcast1] <strong>import-route static</strong>
[<span class="keyword">*</span>Leaf2-bgp-mcast1] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2-bgp] <strong>quit</strong>
[<span class="keyword">*</span>Leaf2] <strong>commit</strong></pre>
</div>
<p># Configure the CE.</p>
</p><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE] <strong>multicast routing-enable</strong>
[<span class="keyword">*</span>CE] <strong>interface <span>100ge</span> <span>1/0/1</span></strong>
[<span class="keyword">*</span>CE-<span>100GE</span><span>1/0/1</span>] <strong>undo portswitch</strong>
[<span class="keyword">*</span>CE-<span>100GE</span><span>1/0/1</span>] <strong>pim sm</strong>
[<span class="keyword">*</span>CE-<span>100GE</span><span>1/0/1</span>] <strong>quit</strong>
[<span class="keyword">*</span>CE] <strong>interface <span>100ge</span> <span>1/0/2</span></strong>
[<span class="keyword">*</span>CE-<span>100GE</span><span>1/0/2</span>] <strong>undo portswitch</strong>
[<span class="keyword">*</span>CE-<span>100GE</span><span>1/0/2</span>] <strong>pim sm</strong>
[<span class="keyword">*</span>CE-<span>100GE</span><span>1/0/2</span>] <strong>igmp enable</strong>
[<span class="keyword">*</span>CE-<span>100GE</span><span>1/0/2</span>] <strong>igmp version 3</strong>
[<span class="keyword">*</span>CE-<span>100GE</span><span>1/0/2</span>] <strong>quit</strong>
[<span class="keyword">*</span>CE] <strong>ip route-static 192.168.10.1 24 <span>100ge</span> <span>1/0/1</span></strong>
[<span class="keyword">*</span>CE] <strong>commit</strong></pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0000001136013618__1.3.4"></a><a name="1.3.4"></a><h4 class="sectiontitle">Verifying the Configuration</h4><p># Run the <strong>display bgp mvpn all peer</strong> command on each leaf node to query BGP MVPN peer information. For example, the command output on Leaf 1 is as follows:</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>display bgp mvpn all peer</strong>
 BGP local router ID        : 1.1.1.1
 Local AS number            : 100
 Total number of peers      : 2
 Peers in established state : 2

  Peer            V          AS  MsgRcvd  MsgSent  OutQ  Up/Down       State  PrefRcv
  2.2.2.2         4         100     1860     1859     0 04:43:30 Established        1
  3.3.3.3         4         100     3219     3221     0 04:43:39 Established        1</pre>
<p># After the receivers initiate requests to join a multicast group, run the <strong>display pim vpn-instance mcast1 routing-table</strong> command on each leaf node to query information about its VPN instance PIM routing table.</p>
<ul><li>According to the command output on Leaf 1, Receiver 1 joins a multicast group through IGMP, and Receivers 2 and 3 join multicast groups through BGP.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf1] <strong>display pim vpn-instance mcast1 routing-table</strong>
 VPN-Instance: mcast1
 Total 1 (*, G) entry; 4 (S, G) entries

 (*, 225.1.1.1)
     RP: 1.1.1.10 (local)
     Protocol: <strong>pim-sm</strong>, Flag: WC
     UpTime: 04:43:57
     Upstream interface: Register
         Upstream neighbor: NULL
         RPF prime neighbor: NULL
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: pseudo
             Protocol: <strong>BGP</strong>, UpTime: 04:43:57, Expires: -
 
 (192.168.10.9, 225.1.1.1)
     RP: 1.1.1.10 (local)
     Protocol: <strong>pim-sm</strong>, Flag: SPT LOC ACT
     UpTime: 04:43:57
     Upstream interface: <span>100GE</span><span>1/0/3</span>.1
         Upstream neighbor: NULL
         RPF prime neighbor: NULL
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: pseudo
             Protocol: <strong>pim-sm</strong>, UpTime: 04:43:57, Expires: -

 (192.168.10.9, 232.1.1.1)
     Protocol: <strong>pim-ssm</strong>, Flag: SPT LOC ACT SG_RCVR 
     UpTime: 04:44:12
     Upstream interface: Vbdif10
         Upstream neighbor: NULL
         RPF prime neighbor: NULL
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: Vbdif20
             Protocol: <strong>igmp</strong>, UpTime: 04:44:12, Expires: -

 (192.168.10.9, 232.1.1.2)
     Protocol: <strong>pim-ssm</strong>, Flag: SPT LOC ACT
     UpTime: 04:44:12
     Upstream interface: Vbdif10
         Upstream neighbor: NULL
         RPF prime neighbor: NULL
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: pseudo
             Protocol: <strong>BGP</strong>, UpTime: 04:44:12, Expires: -
                
 (192.168.10.9, 232.1.1.3)
     Protocol: <strong>pim-ssm</strong>, Flag: SPT LOC ACT
     UpTime: 04:43:52
     Upstream interface: Vbdif10
         Upstream neighbor: NULL
         RPF prime neighbor: NULL
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: pseudo
             Protocol: <strong>BGP</strong>, UpTime: 04:43:52, Expires: -</pre>
</li><li>According to Leaf 2's PIM VPN routing entry that corresponds to Receiver 2, the upstream interface is Through-BGP and the downstream outbound interface is <span>100GE</span><span>1/0/3</span>.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf2] <strong>display pim vpn-instance mcast1 routing-table</strong>
 VPN-Instance: mcast1
 Total 1 (S, G) entry
 
 (192.168.10.9, 232.1.1.2)
     Protocol: <strong>pim-ssm</strong>, Flag: SPT ACT 
     UpTime: 04:43:52
     Upstream interface: <strong>through-BGP</strong>
         Upstream neighbor: 1.1.1.1
         RPF prime neighbor: 1.1.1.1
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: <strong><span>100GE</span></strong><strong><span>1/0/3</span></strong>
             Protocol: igmp, UpTime: 04:43:52, Expires: -</pre>
</li><li>According to Leaf 3's PIM VPN routing entry for Receiver 3, the upstream interface is Through-BGP and the downstream outbound interface is VBDIF10. Receiver 4 has no multicast source specified. Therefore, the PIM VPN routing entry for Receiver 4 is an (*, G) entry, with the downstream outbound interface being VBDIF20.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Leaf3] <strong>display pim vpn-instance mcast1 routing-table</strong>
 VPN-Instance: mcast1
 Total 1 (*, G) entry; 2 (S, G) entries
 
 (*, 225.1.1.1)
     RP: <strong>1.1.1.10</strong> 
     Protocol: <strong>pim-sm</strong>, Flag: WC
     UpTime: 04:43:57
     Upstream interface: <strong>through-BGP</strong>
         Upstream neighbor: 1.1.1.1
         RPF prime neighbor: 1.1.1.1
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: <strong>Vbdif20</strong>
             Protocol: igmp, UpTime: 04:43:57, Expires: -
 
 (192.168.10.9, 225.1.1.1)
     RP: <strong>1.1.1.10</strong> 
     Protocol: <strong>pim-sm</strong>, Flag: SPT ACT
     UpTime: 04:43:57
     Upstream interface: <strong>through-BGP</strong>
         Upstream neighbor: 1.1.1.1
         RPF prime neighbor: 1.1.1.1
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: <strong>Vbdif20</strong>
             Protocol: pim-sm, UpTime: 04:43:57, Expires: -
 
 (192.168.10.9, 232.1.1.3)
     Protocol: <strong>pim-ssm</strong>, Flag: SPT ACT
     UpTime: 104:44:50
     Upstream interface: <strong>through-BGP</strong>
         Upstream neighbor: 1.1.1.1
         RPF prime neighbor: 1.1.1.1
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: <strong>Vbdif10</strong>
             Protocol: igmp, UpTime: 04:44:50, Expires: -</pre>
</li></ul>
</div>
<div class="postreq"><a name="EN-US_TASK_0000001136013618__1.3.5"></a><a name="1.3.5"></a><h4 class="sectiontitle">Configuration Scripts</h4><ul><li><p>Leaf1</p>
<pre class="screen">#
sysname Leaf1
#
evpn-overlay enable
#
multicast routing-enable
#
multicast mvpn 1.1.1.9
#
ip vpn-instance mcast1
 ipv4-family
  route-distinguisher 1:1
  vpn-target 1:1 export-extcommunity
  vpn-target 13:1 export-extcommunity evpn
  vpn-target 1:1 import-extcommunity
  vpn-target 13:1 import-extcommunity evpn
  multicast routing-enable
  multicast mvpn route-import local-admin-id 1
  mvpn          
   c-multicast signaling bgp
   spt-only mode
   auto-discovery inter-as
   ipmsi-tunnel 
    vxlan static
 vxlan vni 5010 
#               
bridge-domain 10
 vxlan vni 10   
 evpn           
  route-distinguisher 11:1
  vpn-target 12:1 export-extcommunity
  vpn-target 13:1 export-extcommunity
  vpn-target 12:1 import-extcommunity
  vpn-target 13:1 import-extcommunity
#               
bridge-domain 20
 vxlan vni 20   
 evpn           
  route-distinguisher 11:2
  vpn-target 12:2 export-extcommunity
  vpn-target 13:1 export-extcommunity
  vpn-target 12:2 import-extcommunity
  vpn-target 13:1 import-extcommunity
#
interface Vbdif10
 ip binding vpn-instance mcast1
 ip address 192.168.10.1 255.255.255.0
 pim sm         
 igmp enable    
 vxlan anycast-gateway enable
 arp collect host enable
#               
interface Vbdif20
 ip binding vpn-instance mcast1
 ip address 192.168.20.1 255.255.255.0
 pim sm         
 igmp enable    
 igmp version 3    
 vxlan anycast-gateway enable
 arp collect host enable
#
interface <span>100GE</span><span>1/0/1</span>
 undo portswitch
 ip address 10.1.1.1 255.255.255.0
 pim sm         
#
interface <span>100GE</span><span>1/0/2</span>
 undo portswitch
 ip address 10.1.2.1 255.255.255.0
 pim sm         
#
interface <span>100GE</span><span>1/0/3</span>.1 mode l2
 encapsulation dot1q vid 10
 bridge-domain 10
#
interface <span>100GE</span><span>1/0/4</span>.1 mode l2
 encapsulation dot1q vid 20
 bridge-domain 20
#
interface LoopBack1
 ip address 1.1.1.1 255.255.255.255
 pim sm
#
interface LoopBack2
 ip address 1.1.1.9 255.255.255.255
#
interface LoopBack3
 ip binding vpn-instance mcast1
 ip address 1.1.1.10 255.255.255.255
 pim sm
#                
interface Nve1  
 source 1.1.1.9 
 vni 10 head-end peer-list protocol bgp
 vni 20 head-end peer-list protocol bgp
 vni 5010 mcast-group 225.0.0.1
#
bgp 100         
 peer 2.2.2.2 as-number 200
 peer 2.2.2.2 ebgp-max-hop 255
 peer 2.2.2.2 connect-interface LoopBack1
 peer 3.3.3.3 as-number 200
 peer 3.3.3.3 ebgp-max-hop 255
 peer 3.3.3.3 connect-interface LoopBack1
 peer 10.1.1.2 as-number 200
 peer 10.1.2.2 as-number 200
 #              
 ipv4-family unicast
  network 1.1.1.1 255.255.255.255
  network 1.1.1.9 255.255.255.255
  peer 2.2.2.2 enable
  peer 3.3.3.3 enable
  peer 10.1.1.2 enable
  peer 10.1.2.2 enable
 #              
 ipv4-family mvpn
  policy vpn-target
  peer 2.2.2.2 enable
  peer 3.3.3.3 enable
 #               
 ipv4-family vpn-instance mcast1
  import-route direct
  advertise l2vpn evpn
 #              
bgp 300 instance evpn1
 peer 2.2.2.9 as-number 300
 peer 2.2.2.9 connect-interface LoopBack2
 peer 3.3.3.9 as-number 300
 peer 3.3.3.9 connect-interface LoopBack2
 #
 l2vpn-family evpn
  policy vpn-target
  peer 2.2.2.9 enable
  peer 2.2.2.9 advertise irb
  peer 3.3.3.9 enable
  peer 3.3.3.9 advertise irb
#
pim
 static-rp 1.1.1.1
#
pim vpn-instance mcast1
 static-rp 1.1.1.10
#
return</pre>
</li><li><p>Leaf2</p>
<pre class="screen">#
sysname Leaf2
#
evpn-overlay enable
#
multicast routing-enable
#
multicast mvpn 2.2.2.9
#
ip vpn-instance mcast1
 ipv4-family
  route-distinguisher 1:1
  vpn-target 1:1 export-extcommunity
  vpn-target 13:1 export-extcommunity evpn
  vpn-target 1:1 import-extcommunity
  vpn-target 13:1 import-extcommunity evpn
  multicast routing-enable
  multicast mvpn route-import local-admin-id 1
  mvpn          
   c-multicast signaling bgp
   auto-discovery inter-as
   ipmsi-tunnel 
    vxlan static
 vxlan vni 5010 
#               
bridge-domain 10
 vxlan vni 10   
 evpn           
  route-distinguisher 11:1
  vpn-target 12:1 export-extcommunity
  vpn-target 13:1 export-extcommunity
  vpn-target 12:1 import-extcommunity
  vpn-target 13:1 import-extcommunity
#               
interface Vbdif10
 ip binding vpn-instance mcast1
 ip address 192.168.10.2 255.255.255.0
 pim sm         
 igmp enable    
 igmp version 3    
 vxlan anycast-gateway enable
#
interface <span>100GE</span><span>1/0/1</span>
 undo portswitch
 ip address 10.1.1.2 255.255.255.0
 pim sm         
#
interface <span>100GE</span><span>1/0/2</span>
 undo portswitch
 ip address 10.1.3.1 255.255.255.0
 pim sm         
#
interface <span>100GE</span><span>1/0/3</span>
 undo portswitch
 ip binding vpn-instance mcast1
 ip address 192.168.30.1 255.255.255.0
 pim sm
 igmp enable
 igmp version 3    
#
interface LoopBack1
 ip address 2.2.2.2 255.255.255.255
#               
interface LoopBack2
 ip address 2.2.2.9 255.255.255.255
#
interface Nve1  
 source 2.2.2.9 
 vni 10 head-end peer-list protocol bgp
 vni 5010 mcast-group 225.0.0.1
#
bgp 200         
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 ebgp-max-hop 255
 peer 1.1.1.1 connect-interface LoopBack1
 peer 3.3.3.3 as-number 200
 peer 3.3.3.3 connect-interface LoopBack1
 peer 10.1.1.1 as-number 100
 peer 10.1.3.2 as-number 200
 #              
 ipv4-family unicast
  network 2.2.2.2 255.255.255.255
  network 2.2.2.9 255.255.255.255
  peer 1.1.1.1 enable
  peer 3.3.3.3 enable
  peer 10.1.1.1 enable
  peer 10.1.3.2 enable
 #              
 ipv4-family mvpn
  policy vpn-target
  peer 1.1.1.1 enable
  peer 3.3.3.3 enable
 #              
 ipv4-family vpn-instance mcast1
  import-route static
  advertise l2vpn evpn
 #              
bgp 300 instance evpn1
 peer 1.1.1.9 as-number 300
 peer 1.1.1.9 connect-interface LoopBack2
 peer 3.3.3.9 as-number 300
 peer 3.3.3.9 connect-interface LoopBack2
 #
 l2vpn-family evpn
  policy vpn-target
  peer 1.1.1.9 enable
  peer 3.3.3.9 enable
#
pim
 static-rp 1.1.1.1
#               
ip route-static vpn-instance mcast1 192.168.40.0 255.255.255.0 <span>100GE</span><span>1/0/3</span>
#
return</pre>
</li><li><p>Leaf3</p>
<pre class="screen">#
sysname Leaf3
#
evpn-overlay enable
#
multicast routing-enable
#
multicast mvpn 3.3.3.9
#
ip vpn-instance mcast1
 ipv4-family
  route-distinguisher 1:1
  vpn-target 1:1 export-extcommunity
  vpn-target 13:1 export-extcommunity evpn
  vpn-target 1:1 import-extcommunity
  vpn-target 13:1 import-extcommunity evpn
  multicast routing-enable
  multicast mvpn route-import local-admin-id 1
  mvpn          
   c-multicast signaling bgp
   spt-only mode
   auto-discovery inter-as
   ipmsi-tunnel 
    vxlan static
 vxlan vni 5010 
#
bridge-domain 10
 vxlan vni 10   
 evpn           
  route-distinguisher 11:1
  vpn-target 12:1 export-extcommunity
  vpn-target 13:1 export-extcommunity
  vpn-target 12:1 import-extcommunity
  vpn-target 13:1 import-extcommunity
#               
bridge-domain 20
 vxlan vni 20   
 evpn           
  route-distinguisher 11:2
  vpn-target 12:2 export-extcommunity
  vpn-target 13:1 export-extcommunity
  vpn-target 12:2 import-extcommunity
  vpn-target 13:1 import-extcommunity
#
interface Vbdif10
 ip binding vpn-instance mcast1
 ip address 192.168.10.3 255.255.255.0
 pim sm         
 igmp enable
 igmp version 3    
 vxlan anycast-gateway enable
 arp collect host enable
#               
interface Vbdif20
 ip binding vpn-instance mcast1
 ip address 192.168.20.2 255.255.255.0
 pim sm         
 igmp enable    
 vxlan anycast-gateway enable
 arp collect host enable
#
interface <span>100GE</span><span>1/0/1</span>
 undo portswitch
 ip address 10.1.2.2 255.255.255.0
 pim sm         
#
interface <span>100GE</span><span>1/0/2</span>
 undo portswitch
 ip address 10.1.3.2 255.255.255.0
 pim sm         
#
interface <span>100GE</span><span>1/0/3</span>.1 mode l2
 encapsulation dot1q vid 10
 bridge-domain 10
#
interface <span>100GE</span><span>1/0/4</span>.1 mode l2
 encapsulation dot1q vid 20
 bridge-domain 20
#
interface LoopBack1
 ip address 3.3.3.3 255.255.255.255
#               
interface LoopBack2
 ip address 3.3.3.9 255.255.255.255
#
interface Nve1  
 source 3.3.3.9 
 vni 10 head-end peer-list protocol bgp
 vni 20 head-end peer-list protocol bgp
 vni 5010 mcast-group 225.0.0.1
#               
bgp 200         
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 ebgp-max-hop 255
 peer 1.1.1.1 connect-interface LoopBack1
 peer 2.2.2.2 as-number 200
 peer 2.2.2.2 connect-interface LoopBack1
 peer 10.1.2.1 as-number 100
 peer 10.1.3.1 as-number 200
 #              
 ipv4-family unicast
  network 3.3.3.3 255.255.255.255
  network 3.3.3.9 255.255.255.255
  peer 1.1.1.1 enable
  peer 2.2.2.2 enable
  peer 10.1.2.1 enable
  peer 10.1.3.1 enable
 #              
 ipv4-family mvpn
  policy vpn-target
  peer 1.1.1.1 enable
  peer 2.2.2.2 enable
 #              
bgp 300 instance evpn1
 peer 1.1.1.9 as-number 300
 peer 1.1.1.9 connect-interface LoopBack2
 peer 2.2.2.9 as-number 300
 peer 2.2.2.9 connect-interface LoopBack2
 #
 l2vpn-family evpn
  policy vpn-target
  peer 1.1.1.9 enable
  peer 1.1.1.9 advertise irb
  peer 2.2.2.9 enable
  peer 2.2.2.9 advertise irb
#               
pim
 static-rp 1.1.1.1
#
pim vpn-instance mcast1
 static-rp 1.1.1.10
#
return</pre>
</li><li><p>CE</p>
<pre class="screen">#
sysname CE
#
multicast routing-enable
#
interface <span>100GE</span><span>1/0/3</span>
 undo portswitch
 ip address 192.168.30.2 255.255.255.0
 pim sm         
#
interface <span>100GE</span><span>1/0/2</span>
 undo portswitch
 ip address 192.168.40.1 255.255.255.0
 pim sm         
 igmp enable
 igmp version 3    
#
ip route-static 192.168.10.0 255.255.255.0 <span>100GE</span><span>1/0/3</span>
#
return</pre>
</li></ul>
</div></div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="vrp_ipv4_multi_over_vxlan_cfg_0010.html">Configuring IPv4 Layer 3 Multicast over VXLAN
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="copyrightBottomBar_responsive">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="vrp_ipv4_multi_over_vxlan_cfg_0018.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="vrp_ipv4_multi_over_vxlan_cfg_0020.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>