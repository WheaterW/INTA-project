
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Applying for and Updating a Local Certificate in Online Mode Using CMPv2">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="security_pki_cfg_0044.html">
<meta name="DC.Relation" scheme="URI" content="security_pki_cfg_0045.html">
<meta name="DC.Relation" scheme="URI" content="security_pki_cfg_0060.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation">
<meta name="DC.Publisher" content="20230413">
<meta name="featurename" content="PKI">
<meta name="featuretype" content="Security">
<meta name="featuretype" content="Security Protection">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="PKI">
<meta name="featuretype" content="Security">
<meta name="featuretype" content="Security Protection">
<meta name="featurename" content="PKI">
<meta name="featuretype" content="Security">
<meta name="featuretype" content="Security Protection">
<meta name="featuretype" content="Security">
<meta name="featuretype" content="Security Protection">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0000001513046006">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="public_sys-resources/commonltr.css">
<link rel="stylesheet" type="text/css" href="public_sys-resources/mediaQuery.css">
<script language="javascript" type="text/javascript" src="public_sys-resources/browseVersion.js"></script>
<title>Applying for and Updating a Local Certificate in Online Mode Using CMPv2</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0000001513046006"></a><a name="EN-US_TASK_0000001513046006"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Applying for and Updating a Local Certificate in Online Mode Using CMPv2</h1>
<div class="taskbody"><div class="prereq" style="margin-left:0"><a name="EN-US_TASK_0000001513046006__1.3.1"></a><a name="1.3.1"></a><h4 class="sectiontitle">Prerequisites</h4>
<div class="p"><p>You have completed the preconfiguration for a certificate application. For details, see <a href="security_pki_cfg_0041.html">Preconfiguration for Certificate Application</a>.</p>
</div></div>
<div class="steps"><a name="EN-US_TASK_0000001513046006__1.3.2"></a><a name="1.3.2"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Enter the system view.</span><p><pre class="screen"><span><a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span></pre>
</p></li><li><span>Configure the file format in which the device stores the certificate.</span><p><pre class="screen"><a href="cmdqueryname=pki+file-format"><b><span class="cmdname">pki file-format</span></b></a> { <strong><span>der</span></strong> | <strong><span>pem</span></strong> }</pre>
</p></li><li><span>Enter the CMP session view. If no CMP session exists, create one first.</span><p><pre class="screen"><a href="cmdqueryname=pki+cmp+session"><b><span class="cmdname">pki cmp session</span></b></a> <i><span class="varname">session-name</span></i></pre>
</p><p><p>A CMP session is locally available. It is not available to the CA and other devices.</p>
</p></li><li><span>Configure the PKI entity name used for CMPv2-based certificate application.</span><p><pre class="screen"><a href="cmdqueryname=cmp-request+entity"><b><span class="cmdname">cmp-request entity</span></b></a> <i><span class="varname">entity-name</span></i></pre>
</p></li><li><span>Configure a CA name for the CMP session.</span><p><pre class="screen"><a href="cmdqueryname=cmp-request+ca-name"><b><span class="cmdname">cmp-request ca-name</span></b></a> <i><span class="varname">ca-name</span></i></pre>
</p><p><p>The field sequence in the CA name must be the same as that in the CA certificate; otherwise, the CMPv2 server considers the CA name invalid.</p>
</p></li><li><span>Configure the CMPv2 server URL.</span><p><pre class="screen"><a href="cmdqueryname=cmp-request+server+url"><b><span class="cmdname">cmp-request server url</span></b></a> [ <strong><span>esc</span></strong> ] <i><span class="varname">url-addr</span></i> </pre>
</p></li><li><span>Configure the RSA key pair used for CMPv2-based certificate application.</span><p><pre class="screen"><span><a href="cmdqueryname=cmp-request+rsa+local-key-pair"><b><span class="cmdname">cmp-request rsa local-key-pair</span></b></a> <i><span class="varname">key-name</span></i> [ <strong><span>regenerate</span></strong> [ <i><span class="varname">key-bit</span></i> ] ]</span></pre>
</p><p><p>If the <strong><span>regenerate</span></strong> parameter is specified, the system generates a new RSA key pair to apply for a new certificate and uses the new certificate and RSA key pair to replace the previous ones during automatic certificate update. If <strong><span>regenerate</span></strong> is not specified, the system uses the original RSA key pair during automatic certificate update.</p>
</p></li><li><strong>Optional: </strong><span>Configure the source IP address used to establish a TCP connection.</span><p><pre class="screen"><a href="cmdqueryname=source"><b><span class="cmdname">source</span></b></a> { <strong><span>interface</span></strong> <i><span class="varname">interface-type interface-number</span></i> | <i><span class="varname">ip-address</span></i> }</pre>
</p><p><p>If the <strong><span>interface</span></strong> parameter is specified, ensure that the interface is a Layer 3 interface and has an IP address configured.</p>
</p></li><li><strong>Optional: </strong><span>Configure the encryption mode of CMPv2-based certificate application packets.</span><p><pre class="screen"><a href="cmdqueryname=cmp-request+integrity-algorithm"><b><span class="cmdname">cmp-request integrity-algorithm</span></b></a> { <strong><span>hmac-sha256</span></strong> | <strong><span>hmac-sha1</span></strong> }</pre>
<p>When CMPv2 is used to apply for a certificate, packets need to be encrypted using the hash algorithm. By default, the encryption algorithm SHA256 is used when CMPv2 is used to apply for a certificate.</p>
<div class="note"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>For security purpose,you are not advised to use the weak security algorithm or weak security protocols provided by this feature. If you need to use the weak security algorithm or protocols, run the <strong id="EN-US_TASK_0000001513046006__en-us_topic_0198441389_b7309427153513">install feature-software WEAKEA</strong> command to install the weak security algorithm or protocol feature package WEAKEA. By default, the device provides the weak security algorithm or protocol feature package WEAKEA. For details about how to install or uninstall the feature package, see "Upgrade Maintenance Configuration" in <span>Configuration Guide</span> &gt; System Management Configuration.</p>
</div></div>
</p></li><li><strong>Optional: </strong><span>Configure the certificate file used to verify the CA response signature.</span><p><p>Perform this step when applying for a local certificate in signature mode, in which case the device needs to check whether the local certificate is issued by a valid CA. Skip this step if the message authentication code is used.</p>
</p><p><pre class="screen"><a href="cmdqueryname=cmp-request+verification-cert"><b><span class="cmdname">cmp-request verification-cert</span></b></a> <i><span class="varname">cert-file-name</span></i></pre>
<ul><li>If this command is configured and the CMPv2 server signs its certificate response, the device uses the certificate (<i><span class="varname">cert-file-name</span></i>) configured using this command to verify the CMPv2 server's response signature. The configured certificate is a CA certificate used to verify a CA's identity.<div class="note"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If an RA exists and the certificate enrollment request is issued by the RA, <i><span class="varname">cert-file-name</span></i> must be set to the CA certificate of the RA. Otherwise, the certificate verification fails, which in turn causes the certificate application to fail.</p>
</div></div>
</li><li>If this command is not configured and the CMPv2 server signs its certificate response, the device uses the certificates on the device and in the CMPv2 server's response to build a certificate chain, and then verifies the CMPv2 server's response signature based on the certificate chain.</li></ul>
</p></li><li><span>Configure the mode for applying for a local certificate based on the site requirements.</span><p><ul><li>Initial local certificate application (IR) using a message authentication code<ol type="a"><li>Configure the authentication mode of CMPv2-based initial local certificate application.<pre class="screen"><a href="cmdqueryname=cmp-request+origin-authentication-method"><b><span class="cmdname">cmp-request origin-authentication-method</span></b></a> <strong><span>message-authentication-code</span></strong> </pre>
<p>By default, the authentication mode of CMPv2-based initial local certificate application is message authentication code.</p>
</li><li>Configure the reference value and secret value of the message authentication code.<pre class="screen"><a href="cmdqueryname=cmp-request+message-authentication-code"><b><span class="cmdname">cmp-request message-authentication-code</span></b></a> <i><span class="varname">reference-value</span></i> [ <i><span class="varname">secret-value</span></i> ]
<a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
<div class="p"><div class="note"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The secret value of the message authentication code is the value of <span class="parmname"><b>CMP secret key</b></span> on the web UI of the CMPv2 server. The reference value is configurable, and must be a string of case-sensitive characters excluding question marks (?). The value is a string of 1 to 128 characters in clear text or a string of 48 to 188 characters in ciphertext.</p>
</div></div>
</div>
</li><li>In the system view, submit an initial certificate enrollment request to the CMPv2 server based on the CMP session configuration.<pre class="screen"><a href="cmdqueryname=pki+cmp+initial-request+session"><b><span class="cmdname">pki cmp initial-request session</span></b></a> <i><span class="varname">session-name</span></i></pre>
<p>After this command is configured, the system first checks the CMP session configuration to determine whether the certificate application condition is met. If the condition is not met, an error message is displayed. If the condition is met, the system initiates an initial certificate enrollment request according to the configuration. The certificate obtained is saved in a file to the device storage without being imported to the memory. If the server provides a CA certificate in a response, the CA certificate is also saved in a file.</p>
</li></ol>
</li><li>Initial local certificate application (IR) using a signature<ol type="a"><li>Configure the authentication mode of CMPv2-based initial local certificate application.<pre class="screen"><a href="cmdqueryname=cmp-request+origin-authentication-method"><b><span class="cmdname">cmp-request origin-authentication-method</span></b></a> <strong><span>signature</span></strong></pre>
</li><li>Configure the certificate carried in a CMPv2 request for identity authentication.<pre class="screen"><a href="cmdqueryname=cmp-request+authentication-cert"><b><span class="cmdname">cmp-request authentication-cert</span></b></a> <i><span class="varname">cert-name</span></i>
<a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
<p>This certificate is an additional certificate (known as the external identity certificate) and must be issued by another trusted CA.</p>
</li><li>In the system view, submit an initial certificate enrollment request to the CMPv2 server based on the CMP session configuration.<pre class="screen"><a href="cmdqueryname=pki+cmp+initial-request+session"><b><span class="cmdname">pki cmp initial-request session</span></b></a> <i><span class="varname">session-name</span></i></pre>
<p>After this command is configured, the system first checks the CMP session configuration to determine whether the certificate application condition is met. If the condition is not met, an error message is displayed. If the condition is met, the system initiates an initial certificate enrollment request according to the configuration. The obtained certificate is saved in a file to the <strong>flash:/pki/public</strong> directory without being imported to the memory. If the server provides a CA certificate in a response, the CA certificate is also saved in a file.</p>
</li></ol>
</li><li>Signature-based non-initial local certificate application (CR)<ol type="a"><li>Configure the certificate carried in a CMPv2 request for identity authentication.<pre class="screen"><a href="cmdqueryname=cmp-request+authentication-cert"><b><span class="cmdname">cmp-request authentication-cert</span></b></a> <i><span class="varname">cert-name</span></i>
<a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
<p>This certificate is an additional certificate (known as the external identity certificate) and must be issued by another trusted CA.</p>
</li><li>In the system view, submit a certificate enrollment request to the CMPv2 server based on the CMP session configuration.<pre class="screen"><a href="cmdqueryname=pki+cmp+certificate-request+session"><b><span class="cmdname">pki cmp certificate-request session</span></b></a> <i><span class="varname">session-name</span></i></pre>
<p>After this command is configured, the system first checks the CMP session configuration to determine whether the certificate application condition is met. If the condition is not met, an error message is displayed. If the condition is met, the system initiates a certificate enrollment request according to the configuration. The certificate obtained is saved in a file to the device storage without being imported to the memory.</p>
</li></ol>
</li></ul>
</p></li><li><span>Configure the mode for updating the local certificate based on the site requirements.</span><p><ul><li>Manual update<ol type="a"><li>Enter the CMP session view and configure the certificate for identity authentication in a CMPv2 request.<pre class="screen"><a href="cmdqueryname=pki+cmp+session"><b><span class="cmdname">pki cmp session</span></b></a> <i><span class="varname">session-name</span></i>
<a href="cmdqueryname=cmp-request+authentication-cert"><b><span class="cmdname">cmp-request authentication-cert</span></b></a> <i><span class="varname">cert-name</span></i>
<a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
<p>This certificate is the local certificate that the CA has issued to the device and needs to be replaced by a new local certificate.</p>
</li><li>In the system view, submit a Key Update Request (KUR) to the CMPv2 server based on the CMP session configuration.<pre class="screen"><a href="cmdqueryname=pki+cmp+keyupdate-request+session"><b><span class="cmdname">pki cmp keyupdate-request session</span></b></a> <i><span class="varname">session-name</span></i></pre>
<p>When the device requests to update the key with the CMPv2 server, it also applies for a new local certificate.</p>
<p>After this command is configured, the system first checks the CMP session configuration to determine whether the certificate update condition is met. If the condition is not met, an error message is displayed. If the condition is met, the system initiates a certificate update request according to the configuration. The certificate obtained is saved in a file to the device storage without being imported to the memory.</p>
</li></ol>
</li><li>Automatic update<ol type="a"><li>Enter the CMP session view and configure the certificate for identity authentication in a CMPv2 request.<pre class="screen"><a href="cmdqueryname=pki+cmp+session"><b><span class="cmdname">pki cmp session</span></b></a> <i><span class="varname">session-name</span></i>
<a href="cmdqueryname=cmp-request+authentication-cert"><b><span class="cmdname">cmp-request authentication-cert</span></b></a> <i><span class="varname">cert-name</span></i></pre>
<p>This certificate is the local certificate that the CA has issued to the device and needs to be replaced by a new local certificate.</p>
</li><li>Enable CMPv2-based automatic certificate update.<pre class="screen"><strong>certificate auto-update enable</strong></pre>
</li><li>Configure the time when the local certificate is updated automatically. The value is expressed as the percentage of the certificate validity period.<pre class="screen"><strong>certificate update expire-time</strong><em> valid-percent</em>
<a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
<p>By default, the certificate update time is 50% of the certificate validity period.</p>
<p>After this command is configured, the system initiates a certificate update request and determines whether to create an RSA key pair according to the <strong>cmp-request rsa local-key-pair</strong> command configuration when finding that the automatic certificate update time reaches the value specified by <em>valid-percent</em>. After the new certificate is obtained, the system replaces the previous certificate and RSA key pair with the new ones.</p>
</li></ol>
</li></ul>
</p></li><li><span>Commit the configuration.</span><p><pre class="screen" id="EN-US_TASK_0000001513046006__en-us_task_0232035842_screen163801330213"><a href="cmdqueryname=commit"><b><span class="cmdname" id="EN-US_TASK_0000001513046006__en-us_task_0232035842_zh-cn_concept_0141113565_cmdname1667501373175340">commit</span></b></a></pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0000001513046006__1.3.3"></a><a name="1.3.3"></a><h4 class="sectiontitle">Verifying the Configuration</h4><p>Run the <a href="cmdqueryname=display+pki+cmp+statistics"><b><span class="cmdname">display pki cmp statistics</span></b></a> [ <strong><span>session</span></strong> <i><span class="varname">session-name</span></i> ] command to check CMP session statistics.</p>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="security_pki_cfg_0044.html">Applying for and Updating Certificates in Online Mode Using CMPv2
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="copyrightBottomBar_responsive">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="security_pki_cfg_0045.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="security_pki_cfg_0060.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>