
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Configuring Segment VXLAN for Layer 3 Interworking">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../vrp/dc_vrp_vxlan_cfg_1231.html">
<meta name="DC.Relation" scheme="URI" content="../vrp/dc_vrp_vxlan_cfg_1260.html">
<meta name="DC.Relation" scheme="URI" content="../vrp/dc_vrp_vxlan_cfg_1262.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation">
<meta name="DC.Publisher" content="20230413">
<meta name="featurename" content="VXLAN">
<meta name="featuretype" content="VXLAN">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="VXLAN">
<meta name="featuretype" content="VXLAN">
<meta name="featurename" content="VXLAN">
<meta name="featuretype" content="VXLAN">
<meta name="featurename" content="VXLAN">
<meta name="featuretype" content="VXLAN">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0000001560704188">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../public_sys-resources/commonltr.css">
<link rel="stylesheet" type="text/css" href="../public_sys-resources/mediaQuery.css">
<script language="javascript" type="text/javascript" src="../public_sys-resources/browseVersion.js"></script>
<title>Configuring Segment VXLAN for Layer 3 Interworking</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0000001560704188"></a><a name="EN-US_TASK_0000001560704188"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Configuring Segment VXLAN for Layer 3 Interworking</h1>
<div class="taskbody"><div class="prereq" style="margin-left:0"><a name="EN-US_TASK_0000001560704188__1.3.1"></a><a name="1.3.1"></a><h4 class="sectiontitle">Prerequisites</h4>
<div class="p"><p>Before configuring segment VXLAN for Layer 3 interworking, you have completed the following tasks:</p>
<ul><li>Configure BGP EVPN to establish one VXLAN tunnel in DC A and another one in DC B.<ul><li>If the underlay network is an IPv4 network, see <a href="../dc/dc_vrp_vxlan_cfg_1066.html">Establishing VXLAN Tunnels in BGP EVPN Mode (Distributed VXLAN Gateway)</a>.</li><li>If the underlay network is an IPv6 network, see <a href="../dc/dc_vrp_vxlan6_cfg_1066.html">Establishing IPv6 VXLAN Tunnels in BGP EVPN Mode (Distributed VXLAN Gateway)</a>.</li></ul>
</li><li>Configure BGP EVPN between border leaf nodes in DCs to establish an inter-DC VXLAN tunnel.<ul><li>If the underlay network is an IPv4 network, see <a href="../dc/dc_vrp_vxlan_cfg_1066.html">Establishing VXLAN Tunnels in BGP EVPN Mode (Distributed VXLAN Gateway)</a>.</li><li>If the underlay network is an IPv6 network, see <a href="../dc/dc_vrp_vxlan6_cfg_1066.html">Establishing IPv6 VXLAN Tunnels in BGP EVPN Mode (Distributed VXLAN Gateway)</a>.</li></ul>
<div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>When configuring a VXLAN tunnel between border leaf nodes in DCs, you do not need to create a BD or perform BD-related configurations. This does not affect the establishment of the VXLAN tunnel between the border leaf nodes. However, in this scenario, VMs attached to border leaf nodes cannot access the network through Layer 2 sub-interfaces associated with a BD.</p>
</div></div>
</li></ul>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001560704188__1.3.2"></a><a name="1.3.2"></a><h4 class="sectiontitle">Context</h4>
<div class="p"><p>In <a href="#EN-US_TASK_0000001560704188__fig_dc_vrp_vxlan_cfg_108501">Figure 1</a>, BGP EVPN is configured between distributed gateways in DC A and DC B to create VXLAN tunnels and configured between Leaf2 and Leaf3 to create another VXLAN tunnel. To implement Layer 3 interworking between VMs on different subnets in DC A and DC B, you need to configure segment VXLAN on Leaf2 and Leaf3 at the edge.</p>
<div class="fignone" id="EN-US_TASK_0000001560704188__fig_dc_vrp_vxlan_cfg_108501"><a name="EN-US_TASK_0000001560704188__fig_dc_vrp_vxlan_cfg_108501"></a><a name="fig_dc_vrp_vxlan_cfg_108501"></a><span class="figcap"><b>Figure 1 </b>Configuring segment VXLAN for Layer 3 interworking</span><br><span><img class="vsd" src="figure/en-us_image_0000001611502917.png" width="NaN" height="NaN"></span></div>
</div></div>
<div class="steps"><a name="EN-US_TASK_0000001560704188__1.3.3"></a><a name="1.3.3"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure Leaf2 and Leaf3 to advertise re-originated EVPN routes to their BGP EVPN peers.</span><ol type="a"><li class="substepexpand"><span>Enter the system view.</span><p><pre class="screen"><a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></pre>
</p></li><li class="substepexpand"><span>Enter the BGP view.</span><p><pre class="screen"><a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></pre>
</p></li><li class="substepexpand"><span>Enter the BGP EVPN address family view.</span><p><pre class="screen"><a href="cmdqueryname=l2vpn-family"><b><span class="cmdname">l2vpn-family</span></b></a> <strong><span>evpn</span></strong></pre>
</p></li><li class="substepexpand"><span>Configure the device to add a re-origination flag to routes received from BGP EVPN peers or peer groups.</span><p><pre class="screen"><a href="cmdqueryname=peer"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv4-address</span></i> | <i><span class="varname">ipv6-address</span></i> | <i><span class="varname">group-name</span></i> } <strong><span>import</span></strong> <strong><span>reoriginate</span></strong></pre>
</p></li><li class="substepexpand"><span>Configure the device to advertise re-originated EVPN routes to BGP EVPN peers or peer groups on one end.</span><p><pre class="screen"><a href="cmdqueryname=peer"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv4-address</span></i> | <i><span class="varname">ipv6-address</span></i> | <i><span class="varname">group-name</span></i> } <strong><span>advertise</span></strong> <strong><span>route-reoriginated</span></strong> <strong><span>evpn</span></strong> { <strong><span>mac</span></strong> | <strong><span>mac-ip</span></strong> | <strong><span>ip</span></strong><span> | <strong><span>mac-ipv6</span></strong> | <strong><span>ipv6</span></strong></span> }</pre>
<p>After this step is performed, Leaf2 or Leaf3 changes the next hop of a received EVPN route to itself, replaces the router MAC address in the gateway MAC address attribute with its own router MAC address, and replaces the L3VNI with its local VPN instance's L3VNI.</p>
</p></li><li class="substepexpand"><span>(Optional) Configure the device to advertise the MED attribute to its EBGP EVPN peer or peer group.</span><p><pre class="screen"><a href="cmdqueryname=peer"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">peerIpv4Addr</span></i>  | <i><span class="varname">peerGroupName</span></i> } <strong><span>transit-med-to-ebgp</span></strong></pre>
<p>By default, the MED attribute of EVPN routes is not advertised to EBGP EVPN peers. If the VXLAN gateways in a DC work in active/standby mode and an active/standby service switchover needs to be implemented by changing the cost value, perform this step so that the device can advertise the MED attribute of the local EVPN route to its EBGP EVPN peer.</p>
</p></li><li class="substepexpand"><span>Return to the BGP view.</span><p><pre class="screen"><a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
</p></li><li class="substepexpand"><span>Return to the system view.</span><p><pre class="screen"><a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
</p></li><li class="substepexpand"><span>Commit the configuration.</span><p><pre class="screen" id="EN-US_TASK_0000001560704188__en-us_task_0234857734_screen14848162118611"><a href="cmdqueryname=commit"><b><span class="cmdname" id="EN-US_TASK_0000001560704188__en-us_task_0234857734_cmdname1784862115612">commit</span></b></a></pre>
</p></li></ol>
</li><li><span>(Optional) Enable the asymmetric mode for IRB/IRBv6 routes on Leaf2 and Leaf3.</span><ol type="a"><li class="substepexpand"><span>Enter the BGP view.</span><p><pre class="screen"><a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></pre>
</p></li><li class="substepexpand"><span>Enter the BGP VPN instance's IPv4/IPv6 address family view.</span><p><pre class="screen"><a href="cmdqueryname=ipv4-family"><b><span class="cmdname">ipv4-family</span></b></a> <strong><span>vpn-instance</span></strong> <i><span class="varname">vpn-instance-name</span></i> or <a href="cmdqueryname=ipv6-family"><b><span class="cmdname">ipv6-family</span></b></a> <strong><span>vpn-instance</span></strong> <i><span class="varname">vpn-instance-name</span></i></pre>
</p></li><li class="substepexpand"><span>Enable the asymmetric mode for IRB/IRBv6 routes.</span><p><pre class="screen"><a href="cmdqueryname=irb+asymmetric"><b><span class="cmdname">irb asymmetric</span></b></a> <strong><span>route-policy</span></strong> <i><span class="varname">route-policy-name</span></i></pre>
<p>Before running this command, you need to create a route-policy to filter out the IRB/IRBv6 routes received by Leaf2 from Leaf1.</p>
<p>If you want the Leaf4-to-Leaf1 traffic to be forwarded to other devices (such as firewalls) after reaching Leaf2 instead of being directly sent to Leaf1, enable the asymmetric mode for IRB/IRBv6 routes on Leaf2. In this manner, forwarding entries are not delivered for the IRB/IRBv6 routes received by Leaf2 from Leaf1, but the routes received by Leaf2 from Leaf3 are not affected.</p>
</p></li><li class="substepexpand"><span>Return to the BGP view.</span><p><pre class="screen"><a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
</p></li><li class="substepexpand"><span>Return to the system view.</span><p><pre class="screen"><a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
</p></li><li class="substepexpand"><span>Commit the configuration.</span><p><pre class="screen" id="EN-US_TASK_0000001560704188__en-us_task_0234857734_screen14848162118611_1"><a href="cmdqueryname=commit"><b><span class="cmdname" id="EN-US_TASK_0000001560704188__en-us_task_0234857734_cmdname1784862115612_1">commit</span></b></a></pre>
</p></li></ol>
</li><li><span>(Optional) Disable Leaf2 and Leaf3 from re-originating IRB routes when no BD is configured.</span><ol type="a"><li class="substepexpand"><span>Enter the global EVPN configuration view.</span><p><pre class="screen"><a href="cmdqueryname=evpn"><b><span class="cmdname">evpn</span></b></a></pre>
</p></li><li class="substepexpand"><span>The function to re-originate IRB routes when no BD is configured is disabled.</span><p><pre class="screen"><a href="cmdqueryname=irb-reoriginated+without-bridge-domain+disable"><b><span class="cmdname">irb-reoriginated without-bridge-domain disable</span></b></a></pre>
<p>By default, when no BD is configured, Leaf2 and Leaf3 can re-originate IRB routes for inter-DC VXLAN tunnel creation. To prevent IRB routes from being re-originated again after a BD is configured for Leaf2 and Leaf3, perform this step.</p>
</p></li><li class="substepexpand"><span>Return to the system view.</span><p><pre class="screen"><a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
</p></li><li class="substepexpand"><span>Commit the configuration.</span><p><pre class="screen" id="EN-US_TASK_0000001560704188__en-us_task_0234857734_screen14848162118611_2"><a href="cmdqueryname=commit"><b><span class="cmdname" id="EN-US_TASK_0000001560704188__en-us_task_0234857734_cmdname1784862115612_2">commit</span></b></a></pre>
</p></li></ol>
</li><li><span>(Optional) Disable on Leaf2 and Leaf3 the function to advertise re-originated IRB routes without being restricted by a split horizon group (SHG).</span><ol type="a"><li class="substepexpand"><span>Enter the global EVPN configuration view.</span><p><pre class="screen"><a href="cmdqueryname=evpn"><b><span class="cmdname">evpn</span></b></a></pre>
</p></li><li class="substepexpand"><span>Disable the function to advertise re-originated IRB routes without being restricted by an SHG.</span><p><pre class="screen"><a href="cmdqueryname=irb-reoriginated+without-split-group+disable"><b><span class="cmdname">irb-reoriginated without-split-group disable</span></b></a></pre>
<p>By default, re-originated IRB routes are advertised without being restricted by an SHG.</p>
<p>In scenarios where segment VXLAN tunnels are used for DCI, BGP EVPN peer-based SHGs are introduced to prevent BUM traffic forwarding from causing loops during Layer 2 interconnection. If no BGP EVPN peer-based SHGs are specified on transit leaf nodes (edge devices interconnecting DCs), all BGP EVPN peers belong to the default system SHG. In this case, after a transit leaf node re-originates IRB routes received from an intra-DC device, the node cannot advertise the re-originated IRB routes to the peer DC's transit leaf node. This is because both of the transit leaf nodes belong to the default system SHG. As a result, Layer 3 traffic forwarding is affected.</p>
<p>To prevent this problem, a device advertises re-originated IRB routes without being restricted by an SHG by default. If SHGs are specified for all BGP EVPN peers on transit leaf nodes, perform this step to disable the function to advertise re-originated IRB routes without being restricted by an SHG.</p>
</p></li><li class="substepexpand"><span>Return to the system view.</span><p><pre class="screen"><a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
</p></li><li class="substepexpand"><span>Commit the configuration.</span><p><pre class="screen" id="EN-US_TASK_0000001560704188__en-us_task_0234857734_screen14848162118611_3"><a href="cmdqueryname=commit"><b><span class="cmdname" id="EN-US_TASK_0000001560704188__en-us_task_0234857734_cmdname1784862115612_3">commit</span></b></a></pre>
</p></li></ol>
</li><li><span>(Optional) Configure Leaf2 and Leaf3 to re-originate IRB/IRBv6 routes as IP prefix routes.</span><ol type="a"><li class="substepexpand"><span>Enter the VPN instance view.</span><p><pre class="screen"><a href="cmdqueryname=ip+vpn-instance"><b><span class="cmdname">ip vpn-instance</span></b></a> <i><span class="varname">vpn-instance-name</span></i></pre>
</p></li><li class="substepexpand"><span>Enter the VPN instance's IPv4 or IPv6 address family view.</span><p><pre class="screen"><a href="cmdqueryname=ipv4-family"><b><span class="cmdname">ipv4-family</span></b></a> or <a href="cmdqueryname=ipv6-family"><b><span class="cmdname">ipv6-family</span></b></a></pre>
</p></li><li class="substepexpand"><span>Configure IRB/IRBv6 routes to be re-originated as IP prefix routes.</span><p><pre class="screen"><a href="cmdqueryname=irb-reoriginate+irb2ip"><b><span class="cmdname">irb-reoriginate irb2ip</span></b></a> <strong><span>enable</span></strong></pre>
<p>If you want Leaf2 and Leaf3 to communicate through IP prefix routes, enable the function to re-originate IRB/IRBv6 routes as IP prefix routes.</p>
</p></li><li class="substepexpand"><span>Return to the system view.</span><p><pre class="screen"><a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></pre>
</p></li><li class="substepexpand"><span>Commit the configuration.</span><p><pre class="screen" id="EN-US_TASK_0000001560704188__en-us_task_0234857734_screen14848162118611_4"><a href="cmdqueryname=commit"><b><span class="cmdname" id="EN-US_TASK_0000001560704188__en-us_task_0234857734_cmdname1784862115612_4">commit</span></b></a></pre>
</p></li></ol>
</li></ol></div>
<div class="example"><a name="EN-US_TASK_0000001560704188__1.3.4"></a><a name="1.3.4"></a><h4 class="sectiontitle">Verifying the Configuration</h4><p>After completing the configuration, run the following commands to verify it.</p>
<ul><li>Run the <a href="cmdqueryname=display+bgp+evpn+peer"><b><span class="cmdname">display bgp evpn peer</span></b></a> command to check BGP EVPN peer information.</li><li>Run the <a href="cmdqueryname=display+vxlan+peer"><b><span class="cmdname">display vxlan peer</span></b></a> [ <strong><span>vni</span></strong> <i><span class="varname">vni-id</span></i> ] command to check the ingress replication lists of all VNIs or a specified VNI.</li><li>Run the <a href="cmdqueryname=display+vxlan+tunnel"><b><span class="cmdname">display vxlan tunnel</span></b></a> [ <i><span class="varname">tunnel-id</span></i> ] [ <strong><span>verbose</span></strong> ] command to check VXLAN tunnel information.</li><li>Run the <a href="cmdqueryname=display+vxlan+vni"><b><span class="cmdname">display vxlan vni</span></b></a> [ <i><span class="varname">vni-id</span></i> [ <strong><span>verbose</span></strong> ] ] command to check VXLAN configuration and VNI state information.</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../vrp/dc_vrp_vxlan_cfg_1231.html">Configuring Segment VXLAN for Layer 3 Interworking
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="copyrightBottomBar_responsive">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../vrp/dc_vrp_vxlan_cfg_1260.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../vrp/dc_vrp_vxlan_cfg_1262.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>