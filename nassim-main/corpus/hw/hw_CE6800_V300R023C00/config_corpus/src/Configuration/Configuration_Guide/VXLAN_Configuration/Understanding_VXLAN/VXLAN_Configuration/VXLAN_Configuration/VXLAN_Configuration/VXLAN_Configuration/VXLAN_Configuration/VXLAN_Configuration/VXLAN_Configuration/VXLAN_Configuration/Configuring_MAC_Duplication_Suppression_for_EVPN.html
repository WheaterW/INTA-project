
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Configuring MAC Duplication Suppression for EVPN">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../toctopics/en-us_topic_0000001130784304.html">
<meta name="DC.Relation" scheme="URI" content="../dc/dc_vrp_vxlan_cfg_1231.html">
<meta name="DC.Relation" scheme="URI" content="../vrp/dc_vrp_vxlan_cfg_1230.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation">
<meta name="DC.Publisher" content="20230413">
<meta name="featurename" content="VXLAN">
<meta name="featuretype" content="VXLAN">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="VXLAN">
<meta name="featuretype" content="VXLAN">
<meta name="featurename" content="VXLAN">
<meta name="featuretype" content="VXLAN">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0000001176664043">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../public_sys-resources/commonltr.css">
<link rel="stylesheet" type="text/css" href="../public_sys-resources/mediaQuery.css">
<script language="javascript" type="text/javascript" src="../public_sys-resources/browseVersion.js"></script>
<title>Configuring MAC Duplication Suppression for EVPN</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0000001176664043"></a><a name="EN-US_TASK_0000001176664043"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Configuring MAC Duplication Suppression for EVPN</h1>
<div class="taskbody"><div class="prereq" style="margin-left:0"><a name="EN-US_TASK_0000001176664043__1.3.1"></a><a name="1.3.1"></a><h4 class="sectiontitle">Prerequisites</h4>
<div class="p"><div class="p">Before configuring MAC duplication suppression for EVPN, you have completed one of the following tasks:<ul><li><a href="dc_vrp_vxlan_cfg_1072.html">Establishing VXLAN Tunnels in BGP EVPN Mode (Centralized VXLAN Gateway)</a></li><li><a href="dc_vrp_vxlan_cfg_1066.html">Establishing VXLAN Tunnels in BGP EVPN Mode (Distributed VXLAN Gateway)</a></li></ul>
</div>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001176664043__1.3.2"></a><a name="1.3.2"></a><h4 class="sectiontitle">Context</h4>
<div class="p"><p>On the EVPN VXLAN shown in <a href="#EN-US_TASK_0000001176664043__fig_dc_vrp_evpn_cfg_008901">Figure 1</a>, the two PEs are interconnected through both network-side and access-side links. The network encounters both BUM traffic loops and MAC route flapping. To resolve these problems, a local PE uses the MAC duplication suppression function, which is enabled by default. With this function, the system checks the number of times a MAC entry flaps within a detection period. If the number exceeds the upper threshold, the PE considers the MAC route to have flapped. In this case, the PE suppresses the flapping MAC route, and no longer sends the route to the remote PE over the BGP EVPN peer relationship.</p>
<div class="fignone" id="EN-US_TASK_0000001176664043__fig_dc_vrp_evpn_cfg_008901"><a name="EN-US_TASK_0000001176664043__fig_dc_vrp_evpn_cfg_008901"></a><a name="fig_dc_vrp_evpn_cfg_008901"></a><span class="figcap"><b>Figure 1 </b>MAC duplication suppression for EVPN</span><br><span><img class="vsd" src="figure/en-us_image_0000001176743985.png" width="NaN" height="NaN"></span></div>
<p>If the default parameter settings of the MAC duplication suppression function do not meet requirements, you can set the parameters as needed.</p>
<div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If the parameters are set in both the EVPN MAC-duplication view and EVPN instance MAC-duplication view, the configuration in the EVPN instance MAC-duplication view takes priority.</p>
</div></div>
</div></div>
<div class="steps-unordered"><a name="EN-US_TASK_0000001176664043__1.3.3"></a><a name="1.3.3"></a><h4 class="sectiontitle">Procedure</h4>
<ul><li><span>Configure MAC duplication suppression for all EVPN instances.</span><ol><li class="substepexpand"><span>Enter the system view.</span><p><pre class="screen"><a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></pre>
</p></li><li class="substepexpand"><span>Enter the global EVPN configuration view.</span><p><pre class="screen"><a href="cmdqueryname=evpn"><b><span class="cmdname">evpn</span></b></a></pre>
</p></li><li class="substepexpand"><span>Enter the EVPN MAC-duplication view.</span><p><pre class="screen"><a href="cmdqueryname=mac-duplication"><b><span class="cmdname">mac-duplication</span></b></a></pre>
</p></li><li class="substepexpand"><span>Configure loop detection parameters for MAC duplication suppression, including the detection period and the threshold for the number of MAC entry flaps within a detection period.</span><p><pre class="screen"><a href="cmdqueryname=detect+loop-times"><b><span class="cmdname">detect loop-times</span></b></a> <i><span class="varname">loop-times</span></i> <strong><span>detect-cycle</span></strong> <i><span class="varname">detect-cycle-time</span></i></pre>
<p>By default, the loop detection period for MAC duplication suppression is 180s, and the threshold for MAC entry flaps within a detection period is 5.</p>
</p></li><li class="substepexpand"><span>Configure a hold-off time to unsuppress MAC routes.</span><p><pre class="screen"><a href="cmdqueryname=retry-cycle"><b><span class="cmdname">retry-cycle</span></b></a> <i><span class="varname">retry-times</span></i></pre>
<p>By default, the hold-off time to unsuppress MAC duplication is 540s.</p>
</p></li><li class="substepexpand"><span>Commit the configuration.</span><p><pre class="screen" id="EN-US_TASK_0000001176664043__en-us_task_0234857734_screen14848162118611"><a href="cmdqueryname=commit"><b><span class="cmdname" id="EN-US_TASK_0000001176664043__en-us_task_0234857734_cmdname1784862115612">commit</span></b></a></pre>
</p></li></ol>
</li><li><span>Configure MAC duplication suppression for a specified EVPN instance.</span><ol><li class="substepexpand"><span>Enter the system view.</span><p><pre class="screen"><a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></pre>
</p></li><li class="substepexpand"><span>Enter the BD view.</span><p><pre class="screen"><a href="cmdqueryname=bridge-domain"><b><span class="cmdname">bridge-domain</span></b></a> <i><span class="varname">bd-id</span></i></pre>
</p></li><li class="substepexpand"><span>Enter the BD-EVPN instance view.</span><p><pre class="screen"><a href="cmdqueryname=evpn"><b><span class="cmdname">evpn</span></b></a></pre>
</p></li><li class="substepexpand"><span>Enter the BD-EVPN instance MAC-duplication view.</span><p><pre class="screen"><a href="cmdqueryname=mac-duplication"><b><span class="cmdname">mac-duplication</span></b></a></pre>
</p></li><li class="substepexpand"><span>Configure loop detection parameters for MAC duplication suppression, including the detection period and the threshold for the number of MAC entry flaps within a detection period.</span><p><pre class="screen"><a href="cmdqueryname=detect+loop-times"><b><span class="cmdname">detect loop-times</span></b></a> <i><span class="varname">loop-times</span></i> <strong><span>detect-cycle</span></strong> <i><span class="varname">detect-cycle-time</span></i></pre>
<p>By default, the loop detection period for MAC duplication suppression is 180s, and the threshold for MAC entry flaps within a detection period is 5.</p>
</p></li><li class="substepexpand"><span>Configure a hold-off time to unsuppress MAC routes.</span><p><pre class="screen"><a href="cmdqueryname=retry-cycle"><b><span class="cmdname">retry-cycle</span></b></a> <i><span class="varname">retry-times</span></i></pre>
<p>By default, the hold-off time to unsuppress MAC duplication is 540s.</p>
</p></li><li class="substepexpand"><span>(Optional) Set flapping MAC routes to blackhole MAC routes.</span><p><pre class="screen"><a href="cmdqueryname=black-hole-dup-mac"><b><span class="cmdname">black-hole-dup-mac</span></b></a></pre>
<p>By default, flapping MAC routes are not set to blackhole MAC routes. After this step, if the source or destination MAC address of the forwarded traffic is the same as the MAC address of a blackhole MAC route, the traffic is discarded.</p>
</p></li><li class="substepexpand"><span>(Optional) Configure a whitelist to filter received MAC routes. MAC duplication suppression is not performed on MAC addresses that match a specified ACL rule.</span><p><pre class="screen"><a href="cmdqueryname=filter-policy"><b><span class="cmdname">filter-policy</span></b></a> { <i><span class="varname">acl-number</span></i> | <strong><span>acl-name</span></strong> <i><span class="varname">acl-name-value</span></i> }</pre>
<p>By default, the received MAC routes are not filtered against a whitelist. When MAC duplication suppression is configured, to prevent the specified MAC address from being affected, perform this step to add the specified MAC address to the whitelist using an ACL rule.</p>
<div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Before performing this step, you need to configure the ACL rule.</p>
<p>When the <strong>rule</strong> command is used to configure a filtering rule for a named ACL, only the source address range specified by <strong>source</strong> and time period specified by <strong>time-range</strong> take effect.</p>
</div></div>
</p></li><li class="substepexpand"><span>Commit the configuration.</span><p><pre class="screen" id="EN-US_TASK_0000001176664043__en-us_task_0234857734_screen14848162118611_1"><a href="cmdqueryname=commit"><b><span class="cmdname" id="EN-US_TASK_0000001176664043__en-us_task_0234857734_cmdname1784862115612_1">commit</span></b></a></pre>
</p></li></ol>
</li></ul></div>
<div class="example"><a name="EN-US_TASK_0000001176664043__1.3.4"></a><a name="1.3.4"></a><h4 class="sectiontitle">Verifying the Configuration</h4><ul><li>Run the <a href="cmdqueryname=display+evpn+vpn-instance"><b><span class="cmdname">display evpn vpn-instance</span></b></a> <strong><span>name</span></strong> <i><span class="varname">vpn-instance-name</span></i> <strong><span>mac-duplication</span></strong> [ <strong><span>bridge-domain</span></strong> <i><span class="varname">bd-id</span></i> ] [ <strong><span>mac-address</span></strong> <i><span class="varname">mac-address</span></i> ] command to check information about MAC duplication suppression, including the involved parameters related to MAC duplication suppression and information about the suppressed MAC routes.</li><li>Run the <a href="cmdqueryname=display+evpn+mac-duplication"><b><span class="cmdname">display evpn mac-duplication</span></b></a> command to check information about MAC duplication suppression in all EVPN instances.</li><li>Run the <a href="cmdqueryname=display+evpn+mac-duplication+statistics"><b><span class="cmdname">display evpn mac-duplication statistics</span></b></a> command to check statistics about MAC duplication suppression in all EVPN instances.</li><li>Run the <a href="cmdqueryname=display+evpn+vpn-instance+mac-duplication+history"><b><span class="cmdname">display evpn vpn-instance mac-duplication history</span></b></a> command to check historical records of MAC duplication suppression.</li></ul>
</div>
<div class="postreq"><a name="EN-US_TASK_0000001176664043__1.3.5"></a><a name="1.3.5"></a><h4 class="sectiontitle">Follow-up Procedure</h4>
<div class="p"><p>If a MAC route or a BD's MAC route no longer flaps and you want to restore it immediately instead of waiting for the configured hold-off timer to expire, you can manually clear the suppression state of the MAC route.</p>
<pre class="screen"><a href="cmdqueryname=reset+evpn+vpn-instance+mac-duplication"><b><span class="cmdname">reset evpn vpn-instance mac-duplication</span></b></a> [ <strong><span>bridge-domain</span></strong> <i><span class="varname">bd-id</span></i> ] [ <strong><span>mac-address</span></strong> <i><span class="varname">mac-address</span></i> ]</pre>
<div class="p">If MAC routes of all EVPN instances no longer flap and you want to restore them immediately instead of waiting for the configured hold-off timer to expire, you can manually clear the suppression state of the MAC routes.<pre class="screen"><a href="cmdqueryname=reset+evpn+mac-duplication"><b><span class="cmdname">reset evpn mac-duplication</span></b></a></pre>
</div>
<p>A MAC route is automatically unsuppressed if a static MAC address is configured for the route, or if a MAC address carrying the static flag is received by the EVPN instance and the received MAC address is the same as that of the MAC route.</p>
</div></div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../toctopics/en-us_topic_0000001130784304.html">VXLAN Configuration
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="copyrightBottomBar_responsive">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../dc/dc_vrp_vxlan_cfg_1231.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../vrp/dc_vrp_vxlan_cfg_1230.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>