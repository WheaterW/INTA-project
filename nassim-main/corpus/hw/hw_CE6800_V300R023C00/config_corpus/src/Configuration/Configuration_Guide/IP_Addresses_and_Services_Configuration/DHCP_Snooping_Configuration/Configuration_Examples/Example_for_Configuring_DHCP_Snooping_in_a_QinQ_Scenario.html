
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring DHCP Snooping in a QinQ Scenario">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="toctopics/en-us_concept_0000002056501870.html">
<meta name="DC.Relation" scheme="URI" content="dc_cfg_dhcp-snooping_0002.html">
<meta name="DC.Relation" scheme="URI" content="toctopics/en-us_task_0000001512681146.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation">
<meta name="DC.Publisher" content="20230413">
<meta name="featurename" content="DHCP Snooping">
<meta name="featurename" content="VLAN">
<meta name="featurename" content="VLAN Mapping">
<meta name="featuretype" content="IP Addresses and Services">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="DHCP Snooping">
<meta name="featurename" content="VLAN">
<meta name="featurename" content="VLAN Mapping">
<meta name="featuretype" content="IP Addresses and Services">
<meta name="featuretype" content="IP Addresses and Services">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_XTASK_0000001564000565">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="public_sys-resources/commonltr.css">
<link rel="stylesheet" type="text/css" href="public_sys-resources/mediaQuery.css">
<script language="javascript" type="text/javascript" src="public_sys-resources/browseVersion.js"></script>
<link rel="stylesheet" type="text/css" href="public_sys-resources/imagePopup.css">
<script language="javascript" type="text/javascript" src="public_sys-resources/customQuery.js"></script>
<script language="javascript" type="text/javascript" src="public_sys-resources/imagePopup.js"></script>
<title>Example for Configuring DHCP Snooping in a QinQ Scenario</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_XTASK_0000001564000565"></a><a name="EN-US_XTASK_0000001564000565"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring DHCP Snooping in a QinQ Scenario</h1>
<div><div class="section"><h4 class="sectiontitle">Networking Requirements</h4>
<div class="p"><p>As shown in <a href="#EN-US_XTASK_0000001564000565__fig_dc_cfg_qinq_003001">Figure 1</a>, two enterprises obtain IPv4 addresses through DHCP, and both of them have two branches. The offices of the two enterprises are connected to DeviceA and DeviceB of the ISP network. A non-Huawei device on the ISP network uses the TPID value of 0x9100 in the outer VLAN tag.</p>
<div class="p">The requirements are as follows:<ul><li>Enterprise 1 and enterprise 2 use independently planned VLANs that do not affect each other.</li><li>Traffic is transparently transmitted between each enterprise's branches through the ISP network. Users accessing the same service in each enterprise are allowed to communicate, and users accessing different services are isolated.</li><li>The devices defend against DHCP attacks on the network and provide better services for DHCP users.</li></ul>
QinQ and DHCP snooping can be configured to meet the preceding requirements. VLAN 100 and VLAN 200 provided by the ISP network can be used to transmit traffic for enterprise 1 and enterprise 2, respectively. This enables communication within an enterprise while isolating the two enterprises from each other. To implement interworking with a non-Huawei device, change the TPID value in the outer VLAN tag on the interfaces of the Huawei devices connected to the non-Huawei device. Configure DHCP snooping on DeviceA and DeviceB to defend against DHCP attacks.</div>
<div class="fignone" id="EN-US_XTASK_0000001564000565__fig_dc_cfg_qinq_003001"><a name="EN-US_XTASK_0000001564000565__fig_dc_cfg_qinq_003001"></a><a name="fig_dc_cfg_qinq_003001"></a><span class="figcap"><b>Figure 1 </b>Network diagram of configuring basic DHCP snooping functions in a QinQ scenario</span><div class="note"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>In this example, interfaces 1, 2, and 3 represent <span>100GE</span> <span>1/0/1</span>, <span>100GE</span> <span>1/0/2</span>, and <span>100GE</span> <span>1/0/3</span>, respectively.</p>
</div></div>
<br><span><img class="imgResize" src="figure/en-us_image_0000001564120473.png" width="465.50003325" title="Click to enlarge"></span></div>
</div>
</div>
<div class="section"><h4 class="sectiontitle">Configuration Roadmap</h4>
<div class="p"><p>The configuration roadmap is as follows:</p>
<ol><li><p>Create VLAN 100 and VLAN 200 on both DeviceA and DeviceB, configure the interfaces connected to enterprise devices as QinQ ones, and add them to VLAN 100 and VLAN 200. In this way, different outer VLAN tags are added for different services.</p>
</li><li><p>Add the interfaces of DeviceA and DeviceB connected to the ISP network to VLAN 100 and VLAN 200, allowing the packets from the two VLANs to pass through.</p>
</li><li><p>On the interfaces of DeviceA and DeviceB connected to the ISP network, set the TPID in the outer VLAN tag to the value used on the non-Huawei device, allowing DeviceA and DeviceB to interwork with the non-Huawei device.</p>
</li><li>Configure DHCP snooping on DeviceA and DeviceB to defend against DHCP attacks.<div class="note"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p><span>DHCP snooping can process DHCP messages with up to two VLAN tags. If DHCP snooping is configured to process messages with more than two VLAN tags, such messages will be discarded, negatively affecting user experience.</span></p>
</div></div>
</li></ol>
</div>
</div>
<div class="section"><h4 class="sectiontitle">Procedure</h4><ol><li><span>Create VLANs.</span><p><p># Create VLAN 100 and VLAN 200 on DeviceA. The configuration of DeviceB is similar to that of DeviceA.</p>
<pre class="screen">&lt;HUAWEI&gt; <strong>system-view</strong> 
[<font style="font-size:8pt" Face="Courier New" >~</font>HUAWEI] <strong>sysname DeviceA</strong>
[*DeviceA] <strong>vlan batch 100 200</strong>
[*<span class="keyword">DeviceA</span>] <strong>commit</strong></pre>
</p></li><li><span>Configure interfaces as QinQ ones.</span><p><p># On DeviceA, configure <span>100GE</span> <span>1/0/1</span> and <span>100GE</span> <span>1/0/2</span> as QinQ interfaces, and set the default VLANs of <span>100GE</span> <span>1/0/1</span> and <span>100GE</span> <span>1/0/2</span> to VLAN 100 and VLAN 200, respectively.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>DeviceA] <strong>interface <span>100GE</span> <span>1/0/1</span></strong>
[*DeviceA-<span>100GE</span><span>1/0/1</span>] <strong>port link-type dot1q-tunnel</strong>
[*DeviceA-<span>100GE</span><span>1/0/1</span>] <strong>port default vlan 100</strong>
[*DeviceA-<span>100GE</span><span>1/0/1</span>] <strong>quit</strong>
[*DeviceA] <strong>interface <span>100GE</span> <span>1/0/2</span></strong>
[*DeviceA-<span>100GE</span><span>1/0/2</span>] <strong>port link-type dot1q-tunnel</strong>
[*DeviceA-<span>100GE</span><span>1/0/2</span>] <strong>port default vlan 200</strong>
[*DeviceA-<span>100GE</span><span>1/0/2</span>] <strong>quit</strong>
[*<span class="keyword">DeviceA</span>] <strong>commit</strong></pre>
</p></li><li><span>Configure the interfaces of the devices connected to the ISP network.</span><p><p># Add <span>100GE</span> <span>1/0/3</span> on DeviceA to VLAN 100 and VLAN 200.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>DeviceA] <strong>interface <span>100GE</span> <span>1/0/3</span></strong>
[*DeviceA-<span>100GE</span><span>1/0/3</span>] <strong>port link-type trunk</strong>
[*DeviceA-<span>100GE</span><span>1/0/3</span>] <strong>port trunk allow-pass vlan 100 200</strong></pre>
</p></li><li><span>Configure the TPID value in the outer VLAN tag.</span><p><p># On DeviceA, set the TPID value in the outer VLAN tag to 0x9100.</p>
<pre class="screen">[*DeviceA-<span>100GE</span><span>1/0/3</span>] <strong>qinq protocol 9100</strong>
[*DeviceA-<span>100GE</span><span>1/0/3</span>] <strong>quit</strong>
[*<span class="keyword">DeviceA</span>] <strong>commit</strong></pre>
</p></li><li><span>Configure DHCP snooping.</span><p><p># Enable DHCP snooping globally on DeviceA.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>DeviceA] <strong>dhcp enable </strong>
[*DeviceA] <strong>dhcp snooping enable</strong>
[*<span class="keyword">DeviceA</span>] <strong>commit</strong></pre>
</p></li><li><span>Enable DHCP snooping on the interfaces.</span><p><p># Enable DHCP snooping on the user-side interfaces of DeviceA.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>DeviceA] <strong>interface <span>100GE</span> <span>1/0/1</span></strong>
[*DeviceA-<span>100GE</span><span>1/0/1</span>] <strong>dhcp snooping enable</strong>
[*DeviceA-<span>100GE</span><span>1/0/1</span>] <strong>quit</strong>
[*DeviceA] <strong>interface <span>100GE</span> <span>1/0/2</span></strong>
[*DeviceA-<span>100GE</span><span>1/0/2</span>] <strong>dhcp snooping enable</strong>
[*DeviceA-<span>100GE</span><span>1/0/2</span>] <strong>quit</strong>
[*<span class="keyword">DeviceA</span>] <strong>commit</strong></pre>
</p></li><li><span>Configure the interface as a trusted one.</span><p><p># Configure the interface connected to the DHCP server as a trusted one.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>DeviceA] <strong>interface <span>100GE</span> <span>1/0/3</span></strong>
[*DeviceA-<span>100GE</span><span>1/0/3</span>] <strong>dhcp snooping trusted</strong>
[*DeviceA-<span>100GE</span><span>1/0/3</span>] <strong>quit</strong>
[*<span class="keyword">DeviceA</span>] <strong>commit</strong></pre>
</p></li><li><span>Verify the configuration.</span><p><p># Check the DHCP snooping configuration.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>DeviceA] <strong>display dhcp snooping configuration</strong>
#                                                                               
dhcp snooping enable                                                          
#                                                                               
interface <span>100GE</span><span>1/0/1</span>                                                  
 dhcp snooping enable                                                          
#                                                                               
interface <span>100GE</span><span>1/0/2</span>                                                  
 dhcp snooping enable                                                          
#                                                                               
interface <span>100GE</span><span>1/0/3</span>
 dhcp snooping trusted                                                          
#</pre>
<p># Check the information about the DHCP snooping binding table.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>DeviceA] <strong>display dhcp snooping user-bind all</strong>
DHCP Dynamic Bind-table:
Flags:O - outer vlan ,I - inner vlan   
IP Address       MAC Address     VLAN(O/I)/(BD-VLAN)        Interface          Lease            
------------------------------------------------------------------------------------------------------- 
10.1.1.141      00e0-fc12-3456    100 /--  /--              <span>100GE</span><span>1/0/1</span>       2022.03.27-07:31
10.1.1.137      00e0-fc12-3457    200 /--  /--              <span>100GE</span><span>1/0/2</span>       2022.03.27-07:31
------------------------------------------------------------------------------------------------------- 
Print count:           2          Total count:           2 </pre>
<p>In enterprise 1, use a PC in a VLAN of one branch to ping a PC in the same VLAN but of the other branch. If the ping operation is successful, internal users of enterprise 1 can communicate.</p>
<p>Repeat this operation for enterprise 2. If the ping operation is successful, internal users of enterprise 2 can communicate.</p>
<p>Next, use a PC in a VLAN of an enterprise 1 branch to ping a PC in the same VLAN but of an enterprise 2 branch. The ping operation should fail, indicating that the users in enterprise 1 and enterprise 2 are isolated.</p>
</p></li></ol>
</div>
<div class="section"><h4 class="sectiontitle">Configuration Scripts</h4>
<div class="p"><ul><li>DeviceA<pre class="screen">#
sysname DeviceA
#
vlan batch 100 200
#
dhcp enable
#
dhcp snooping enable
#
interface <span>100GE</span><span>1/0/1</span> 
 port link-type dot1q-tunnel
 port default vlan 100
 dhcp snooping enable 
#
interface <span>100GE</span><span>1/0/2</span>
 port link-type dot1q-tunnel
 port default vlan 200
 dhcp snooping enable
#
interface <span>100GE</span><span>1/0/3</span>
 qinq protocol 9100
 port link-type trunk
 port trunk allow-pass vlan 100 200
 dhcp snooping trusted
#
return</pre>
</li><li>DeviceB<pre class="screen">#
sysname DeviceA
#
vlan batch 100 200
#
dhcp enable
#
dhcp snooping enable
#
interface <span>100GE</span><span>1/0/1</span> 
 port link-type dot1q-tunnel
 port default vlan 100
 dhcp snooping enable 
#
interface <span>100GE</span><span>1/0/2</span>
 port link-type dot1q-tunnel
 port default vlan 200
 dhcp snooping enable
#
interface <span>100GE</span><span>1/0/3</span>
 qinq protocol 9100
 port link-type trunk
 port trunk allow-pass vlan 100 200
 dhcp snooping trusted
#
return</pre>
</li></ul>
</div>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="toctopics/en-us_concept_0000002056501870.html">Configuration Examples
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="copyrightBottomBar_responsive">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="dc_cfg_dhcp-snooping_0002.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="toctopics/en-us_task_0000001512681146.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>

<script language="JavaScript">
<!--
initImageViewer('.imgResize');
var msg_imageMax = "view original image";
var msg_imageClose = "close";
//--></script></body>
</html>