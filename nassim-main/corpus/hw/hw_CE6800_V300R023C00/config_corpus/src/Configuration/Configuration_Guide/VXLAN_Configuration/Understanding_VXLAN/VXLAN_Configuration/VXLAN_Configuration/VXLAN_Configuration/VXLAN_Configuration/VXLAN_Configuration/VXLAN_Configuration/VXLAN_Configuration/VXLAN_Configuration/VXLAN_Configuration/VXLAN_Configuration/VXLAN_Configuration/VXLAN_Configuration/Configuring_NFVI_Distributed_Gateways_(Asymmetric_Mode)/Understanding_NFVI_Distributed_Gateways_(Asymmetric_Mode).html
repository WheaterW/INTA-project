
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="concept">
<meta name="DC.Title" content="Understanding NFVI Distributed Gateways (Asymmetric Mode)">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../vrp/dc_vrp_vxlan_cfg_1238.html">
<meta name="DC.Relation" scheme="URI" content="../vrp/dc_vrp_vxlan_cfg_1240.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation">
<meta name="DC.Publisher" content="20230413">
<meta name="featurename" content="VXLAN">
<meta name="featuretype" content="VXLAN">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="VXLAN">
<meta name="featuretype" content="VXLAN">
<meta name="featurename" content="VXLAN">
<meta name="featuretype" content="VXLAN">
<meta name="featurename" content="VXLAN">
<meta name="featuretype" content="VXLAN">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_CONCEPT_0000001224785285">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../public_sys-resources/commonltr.css">
<link rel="stylesheet" type="text/css" href="../public_sys-resources/mediaQuery.css">
<script language="javascript" type="text/javascript" src="../public_sys-resources/browseVersion.js"></script>
<title>Understanding NFVI Distributed Gateways (Asymmetric Mode)</title>
</head>
<body><a name="EN-US_CONCEPT_0000001224785285"></a><a name="EN-US_CONCEPT_0000001224785285"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Understanding NFVI Distributed Gateways (Asymmetric Mode)</h1>
<div><p>Huawei's network functions virtualization infrastructure (NFVI) telco cloud solution incorporates Data Center Interconnect (DCI) and data center network (DCN) solutions. A large volume of UE traffic enters the DCN and accesses its vUGW and vMSE. After being processed by the vUGW and vMSE, UE traffic (IPv4 or IPv6) is forwarded over the Internet through the DCN to the destination devices. Response traffic sent over the Internet from the destination devices to the UE also undergoes this process. To ensure that the UE traffic is load-balanced within the DCN in this process, you need to deploy the NFVI distributed gateway function on DCN devices.</p>
<div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The vUGW is a unified packet gateway developed based on Huawei's CloudEdge solution. It can be used for 3rd Generation Partnership Project (3GPP) access in general packet radio service (GPRS), Universal Mobile Telecommunications System (UMTS), and Long Term Evolution (LTE) modes. The vUGW can function as a gateway GPRS support node (GGSN), serving gateway (S-GW), or packet data network gateway (P-GW) to meet carriers' various networking requirements in different phases and operational scenarios.</p>
<p>The vMSE is developed based on Huawei's multi-service engine (MSE). A carrier's network has many entities that provide different functions, including firewall, video acceleration, header enrichment, and URL filtering. All functions are added through patch installation. Over time, the network becomes increasingly slow, complicating service rollout and maintenance. To solve this problem, the vMSE integrates these different functions and manages them in a unified manner, providing value-added services for the data services initiated by users.</p>
</div></div>
<div class="section"><h4 class="sectiontitle">Networking Description</h4><p><a href="#EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001501">Figure 1</a> shows NFVI distributed gateway networking. The DC gateways are the DCN's border gateways, which exchange Internet routes with the external network through PEs. L2GW/L3GW1 and L2GW/L3GW2 connect to virtualized network functions (VNFs). VNF1 and VNF2, as virtualized NEs, can be deployed to respectively provide vUGW and vMSE functions and connect to L2GW/L3GW1 and L2GW/L3GW2 through interface processing units (IPUs).</p>
<div class="p">This networking combines the distributed gateway function and the VXLAN active-active gateway function:<ul><li><p>The VXLAN active-active gateway function is deployed on DC gateways. Specifically, a bypass VXLAN tunnel is established between DC gateways. Both DC gateways use the same virtual anycast VTEP address to establish VXLAN tunnels with L2GW/L3GW1 and L2GW/L3GW2.</p>
</li><li><p>The distributed gateway function is deployed on L2GW/L3GW1 and L2GW/L3GW2, and a VXLAN tunnel is established between L2GW/L3GW1 and L2GW/L3GW2.</p>
</li></ul>
</div>
<div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>In the NFVI distributed gateway (asymmetric mode) scenario, CloudEngine switches can only function as L2GWs/L3GWs. Each L2GW/L3GW in <a href="#EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001501">Figure 1</a> represents two devices on the live network. Multichassis link aggregation (M-LAG) active-active is configured on the devices for them to function as one, which improves network reliability.</p>
</div></div>
<div class="fignone" id="EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001501"><a name="EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001501"></a><a name="fig_dc_vrp_evpn_feature_001501"></a><span class="figcap"><b>Figure 1 </b>NFVI distributed gateway networking (with active-active DC gateways)</span><br><span><img class="vsd" src="figure/en-us_image_0000001224870939.png"></span></div>
</div>
<div class="section"><h4 class="sectiontitle">Function Deployment</h4><div class="p">On the network shown in <a href="#EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001501">Figure 1</a>, the number of bridge domains (BDs) must be planned according to the number of subnets to which the IPUs belong. For example, if five IP addresses planned for five IPUs are allocated to four subnets, you need to plan four different BDs. You also need to configure all BDs and VBDIF interfaces on each of the DC gateways and L2GWs/L3GWs, and bind all VBDIF interfaces to the same L3VPN instance. In addition, deploy the following functions on the network:<ul><li><p>A VPN BGP peer relationship is set up between each VNF and DC gateway, so that the VNF can advertise UE routes (UE IP addresses) to the DC gateway.</p>
</li><li><p>VPN static routes are configured on L2GW/L3GW1 and L2GW/L3GW2 for them to access VNFs. The routes' destination IP addresses are the VNFs' IP addresses, and the next hop addresses are the IP addresses of the IPUs.</p>
</li><li><p>Establish BGP EVPN peer relationships between any two of the DC gateways and L2GWs/L3GWs. L2GWs/L3GWs can then advertise static routes to VNFs to other devices through BGP EVPN peer relationships. DC gateways can advertise local loopback routes and default routes to L2GWs/L3GWs through BGP EVPN peer relationships.</p>
</li><li><p>Traffic forwarded between the UE and Internet through VNFs is called north-south traffic, and traffic forwarded between VNF1 and VNF2 is called east-west traffic. To balance both types of traffic, you need to configure load balancing on DC gateways and L2GWs/L3GWs.</p>
</li></ul>
</div>
</div>
<div class="section"><h4 class="sectiontitle">Generation of Forwarding Entries</h4><p>In the NFVI distributed gateway networking, all traffic is forwarded at Layer 2 from DC gateways to VNFs after entering the DCN, regardless of whether it is from UEs to the Internet or vice versa. However, after traffic leaves the DCN, it is forwarded at Layer 3 from VNFs to DC gateways. This prevents traffic loops between DC gateways and L2GWs/L3GWs. On the network shown in <a href="#EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001502">Figure 2</a>, IPUs connect to multiple L2GWs/L3GWs. If Layer 3 forwarding is used between DC gateways and VNFs, some traffic forwarded by an L2GW/L3GW to the VNF will be forwarded to another L2GW/L3GW due to load balancing. For example, L2GW/L3GW2 forwards some of the traffic to L2GW/L3GW1 and vice versa. As a result, a traffic loop occurs. If Layer 2 forwarding is used, the L2GW/L3GW does not forward the Layer 2 traffic received from another L2GW/L3GW back, preventing traffic loops.</p>
<div class="fignone" id="EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001502"><a name="EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001502"></a><a name="fig_dc_vrp_evpn_feature_001502"></a><span class="figcap"><b>Figure 2 </b>Traffic loop</span><br><span><img class="vsd" src="figure/en-us_image_0000001179233752.png"></span></div>
<div class="p">Forwarding entries are generated on each DC gateway and L2GW/L3GW through the following process:<ol><li><p>BDs are deployed on each L2GW/L3GW and bound to links connecting to the IPU interfaces on the associated network segments. Then, VBDIF interfaces are configured as the gateways of these IPU interfaces. The number of BDs is the same as the number of network segments to which the IPU interfaces belong. A VPN static route is configured on each L2GW/L3GW, so that the L2GW/L3GW can generate a route forwarding entry with the destination address being the VNF address, next hop being the IPU address, and outbound interface being the associated VBDIF interface.</p>
<div class="fignone"><span class="figcap"><b>Figure 3 </b>Static route forwarding entry on an L2GW/L3GW</span><br><span><img class="vsd" src="figure/en-us_image_0000001179717924.png"></span></div>
</li><li>An L2GW/L3GW learns IPU MAC address and ARP information through the data plane, and then advertises the information as an EVPN route to DC gateways. The information is then used to generate an ARP entry and MAC forwarding entry for Layer 2 forwarding.<ul><li>The destination MAC addresses in MAC forwarding entries on the L2GW/L3GW are the MAC addresses of the IPUs. For IPUs directly connecting to an L2GW/L3GW (for example, in <a href="#EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001501">Figure 1</a>, IPU1, IPU2, and IPU3 directly connect to L2GW/L3GW1), these IPUs are used as outbound interfaces in the MAC forwarding entries on the L2GW/L3GW. For IPUs connecting to the other L2GW/L3GW (for example, IPU4 and IPU5 connect to L2GW/L3GW2 in <a href="#EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001501">Figure 1</a>), the MAC forwarding entries use the VTEP address of the other L2GW/L3GW (L2GW/L3GW2) as the next hop and carry the L2VNI used for Layer 2 forwarding.</li><li>In MAC forwarding entries on a DC gateway, the destination MAC address is the IPU MAC address, and the next hop is the L2GW/L3GW VTEP address. These MAC forwarding entries also store the L2 VNI information of the corresponding BDs.</li></ul>
<div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>For incoming traffic to be forwarded only at Layer 2, you are advised to configure devices so that they only advertise ARP routes to each other. In this way, the DCGW and L2GW/L3GW do not generate IP prefix routes based on IP addresses. If the devices are configured to advertise IRB routes to each other, enable the IRB asymmetric mode on the devices that receive routes.</p>
</div></div>
<div class="fignone"><span class="figcap"><b>Figure 4 </b>MAC forwarding entries on the DC gateway and L2GW/L3GW</span><br><span><img class="vsd" src="figure/en-us_image_0000001179557992.png"></span></div>
</li><li>After VPN static routes are configured on the L2GW/L3GW, they are imported into the BGP EVPN routing table and then sent as IP prefix routes to the DC gateway through the BGP EVPN peer relationship.<div class="note"><img src="../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>There are multiple links and static routes between the L2GW/L3GW and VNF. To implement load balancing, you need to enable the Add-Path function when configuring static routes to be imported to the BGP EVPN routing table.</p>
</div></div>
</li><li>By default, the next hop address of an IP prefix route received by the DC gateway is the IP address of the L2GW/L3GW, and the route recurses to a VXLAN tunnel. In this case, incoming traffic is forwarded at Layer 3. To forward incoming traffic at Layer 2, a routing policy must be configured on the L2GW/L3GW to add the Gateway IP attribute to the static routes destined for the DC gateway. Gateway IP addresses are the IP addresses of IPU interfaces. After receiving an IP prefix route carrying the Gateway IP attribute, the DC gateway does not recurse the route to a VXLAN tunnel. Instead, it performs IP recursion. Finally, the destination address of a route forwarding entry on the DC gateway is the IP address of the VNF, the next hop is the IP address of an IPU interface, and the outbound interface is the VBDIF interface corresponding to the network segment on which the IPU resides. If traffic needs to be sent to the VNF, the forwarding entry can be used to find the corresponding VBDIF interface, which then can be used to find the corresponding ARP entry and MAC entry for Layer 2 forwarding.<div class="fignone"><span class="figcap"><b>Figure 5 </b>Forwarding entries on the DC gateway and L2GW/L3GW (1)</span><br><span><img class="vsd" src="figure/en-us_image_0000001179241180.png"></span></div>
</li><li>To establish a VPN BGP peer relationship with the VNF, the DC gateway needs to advertise its loopback address to the L2GW/L3GW. In addition, because the DC gateway uses the anycast VTEP address for the L2GW/L3GW, the VNF1-to-DCGW1 loopback protocol packets may be sent to DCGW2. Therefore, the DC gateway needs to advertise its loopback address to the other DC gateway. Finally, each L2GW/L3GW has a forwarding entry for the VPN route to the loopback addresses of DC gateways, and each DC gateway has a forwarding entry for the VPN route to the loopback address of the other DC gateway. After the VNF and DC gateways establish BGP peer relationships, the VNF can send UE routes to the DC gateways. The next hops of these routes are the VNF IP address.<div class="fignone"><span class="figcap"><b>Figure 6 </b>Forwarding entries on the DC gateway and L2GW/L3GW (2)</span><br><span><img class="vsd" src="figure/en-us_image_0000001179560128.png"></span></div>
</li><li>The DCN does not need to be aware of external routes. Therefore, a route policy must be configured on the DC gateway, so that the DC gateway can send default routes and loopback routes to the L2GW/L3GW.<div class="fignone"><span class="figcap"><b>Figure 7 </b>Forwarding entries on the DC gateway and L2GW/L3GW (3)</span><br><span><img class="vsd" src="figure/en-us_image_0000001179724428.png"></span></div>
</li><li>As the border gateway of the DCN, the DC gateway can exchange Internet routes with external PEs, such as routes to server addresses on the Internet.<div class="fignone"><span class="figcap"><b>Figure 8 </b>Forwarding entries on the DC gateway and L2GW/L3GW (4)</span><br><span><img class="vsd" src="figure/en-us_image_0000001225126285.png"></span></div>
</li><li><p>To implement load balancing during traffic transmission, load balancing and Add-Path can be configured on the DC gateway and L2GW/L3GW. This balances both north-south and east-west traffic.</p>
<ul><li><p>North-south traffic balancing: Use DCGW1 in <a href="#EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001501">Figure 1</a> as an example. DCGW1 can receive EVPN routes to VNF2 from L2GW/L3GW1 and L2GW/L3GW2. By default, after load balancing is configured, DCGW1 sends half of all traffic destined for VNF2 to L2GW/L3GW1 and sends the other half to L2GW/L3GW2. However, L2GW/L3GW1 has only one link to VNF2, whereas L2GW/L3GW2 has two links to VNF2. As a result, the traffic is not evenly balanced. To address this issue, the Add-Path function must be configured on the L2GW/L3GWs. After Add-Path is configured, L2GW/L3GW2 advertises two routes with the same destination address to DCGW1 to implement load balancing.</p>
</li><li><p>East-west traffic balancing: Take L2GW/L3GW1 in <a href="#EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001501">Figure 1</a> as an example. Because Add-Path is configured on L2GW/L3GW2, L2GW/L3GW1 receives two EVPN routes from L2GW/L3GW2. In addition, L2GW/L3GW1 has a static route with the next hop being IPU3. The destination address of these three routes is the IP address of VNF2. To implement load balancing, load balancing among static and EVPN routes must be configured.</p>
</li></ul>
</li></ol>
</div>
</div>
<div class="section"><h4 class="sectiontitle">Traffic Forwarding Process</h4><div class="p"><a href="#EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001509">Figure 9</a> shows the process of forwarding north-south traffic (from a UE to the Internet).<ol><li><p>Upon receipt of UE traffic, the base station encapsulates the packets and redirect them to a GPRS tunneling protocol (GTP) tunnel whose destination address is the VNF address. The encapsulated packets reach the DC gateway through IP forwarding.</p>
</li><li><p>Upon receipt, the DC gateway searches its virtual routing and forwarding (VRF) table and finds a matching forwarding entry whose next hop is an IPU IP address and outbound interface is a VBDIF interface. Therefore, the received packets match the network segment on which the VBDIF interface resides. The DC gateway searches for the desired ARP entry on the network segment, finds a matching MAC forwarding entry based on the ARP entry, and recurses the route to a VXLAN tunnel based on the MAC forwarding entry. Then, the packets are forwarded to the L2GW/L3GW over a VXLAN tunnel.</p>
</li><li><p>Upon receipt, the L2GW/L3GW finds the target BD based on the L2VNI, searches for a matching MAC forwarding entry in the BD, and then forwards the packets to the VNF based on the MAC forwarding entry.</p>
</li><li><p>After receiving the packets, the VNF removes their GTP tunnel header, searches the routing table based on their destination addresses, and forwards them to the L2GW/L3GW through the VNF's default gateway.</p>
</li><li><p>After receiving the packets, the L2GW/L3GW searches their VRF table for a matching forwarding entry. According to the default route advertised by the DC gateway to the L2GW/L3GW, the packets are encapsulated with the L3VNI and then forwarded to the DC gateway through the VXLAN tunnel.</p>
</li><li><p>Upon receipt, the DC gateway searches the corresponding VRF table for a matching forwarding entry based on the L3VNI and forwards these packets to the Internet.</p>
</li></ol>
</div>
<div class="fignone" id="EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001509"><a name="EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001509"></a><a name="fig_dc_vrp_evpn_feature_001509"></a><span class="figcap"><b>Figure 9 </b>Process of forwarding north-south traffic from a UE to the Internet</span><br><span><img class="vsd" src="figure/en-us_image_0000001179406896.png"></span></div>
<div class="p">The preceding figure shows the process of forwarding north-south traffic (from the Internet to a UE through the VNF):<ol><li><p>A device on the Internet sends response traffic to a UE. The destination address of the response traffic is the destination address of the UE route. The route is advertised by the VNF to the DC gateway through the VPN BGP peer relationship, and the DC gateway in turn advertises the route to the Internet. Therefore, the response traffic must first be forwarded to the VNF.</p>
</li><li><p>Upon receipt, the DC gateway searches the routing table for a forwarding entry that matches the UE route. The route is advertised over the VPN BGP peer relationship between the DC gateway and VNF and recurses to one or more VBDIF interfaces. Traffic is load-balanced among these VBDIF interfaces. A matching MAC forwarding entry is found based on the ARP information on these VBDIF interfaces. Based on the MAC forwarding entry, the response packets are encapsulated with the L2VNI and then forwarded to the L2GW/L3GW over a VXLAN tunnel.</p>
</li><li><p>Upon receipt, the L2GW/L3GW finds the target BD based on the L2 VNI, searches for a matching MAC forwarding entry in the BD, obtains the outbound interface information from the MAC forwarding entry, and forwards these packets to the VNF.</p>
</li><li><p>Upon receipt, the VNF processes the packets and finds the base station corresponding to the destination address of the UE. The VNF then encapsulates tunnel information into these packets (with the base station as the destination) and forwards them to the L2GW/L3GW through the default gateway.</p>
</li><li><p>Upon receipt, the L2GW/L3GW searches its VRF table for the default route advertised by the DC gateway to the L2GW/L3GW. Then, the L2GW/L3GW encapsulates the packets with the L3VNI and forwards them to the DC gateway over a VXLAN tunnel.</p>
</li><li><p>Upon receipt, the DC gateway searches its VRF table for the default (or specific) route based on the L3VNI and forwards these packets to the destination base station. The base station then decapsulates these packets and sends them to the target UE.</p>
</li></ol>
</div>
<div class="fignone"><span class="figcap"><b>Figure 10 </b>Process of forwarding north-south traffic from the Internet to a UE</span><br><span><img class="vsd" src="figure/en-us_image_0000001179725514.png"></span></div>
<div class="p">During this process, the VNF may (based on the packet information) send the received packets to another VNF for value-added service processing. In this case, east-west traffic is generated. <a href="#EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001511">Figure 11</a> shows the process of forwarding east-west traffic (from VNF1 to VNF2), which differs from the north-south traffic forwarding process in packet processing after packets reach VNF1:<ol><li><p>VNF1 sends a received packet to VNF2 for processing. VNF2 re-encapsulates the packet by using its own address as the destination address of the packet and sends the packet to the L2GW/L3GW over the default route.</p>
</li><li><p>Upon receipt, the L2GW/L3GW searches its VRF table and finds that multiple load-balancing forwarding entries exist. Some entries use the IPU as the outbound interface, and some entries use the L2GW/L3GW as the next hop.</p>
</li><li><p>If the path to the other L2GW/L3GW (L2GW/L3GW2) is selected preferentially, the packet is encapsulated with the L2VNI and forwarded to L2GW/L3GW2 over a VXLAN tunnel. L2GW/L3GW2 finds the target BD based on the L2 VNI and the destination MAC address, and forwards the packet to VNF2.</p>
</li><li><p>Upon receipt, VNF2 processes the packet and forwards it to the Internet server. The subsequent forwarding process is the same as the process for forwarding north-south traffic.</p>
</li></ol>
</div>
<div class="fignone" id="EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001511"><a name="EN-US_CONCEPT_0000001224785285__fig_dc_vrp_evpn_feature_001511"></a><a name="fig_dc_vrp_evpn_feature_001511"></a><span class="figcap"><b>Figure 11 </b>Process of forwarding east-west traffic (from VNF1 to VNF2)</span><br><span><img class="vsd" src="figure/en-us_image_0000001179565608.png"></span></div>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../vrp/dc_vrp_vxlan_cfg_1238.html">Configuring NFVI Distributed Gateways (Asymmetric Mode)
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="copyrightBottomBar_responsive">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../vrp/dc_vrp_vxlan_cfg_1240.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>