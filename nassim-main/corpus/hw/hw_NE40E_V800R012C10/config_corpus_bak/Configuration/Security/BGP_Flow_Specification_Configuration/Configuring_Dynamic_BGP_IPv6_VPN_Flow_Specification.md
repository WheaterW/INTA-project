Configuring Dynamic BGP IPv6 VPN Flow Specification
===================================================

Dynamic BGP IPv6 VPN Flow Specification refers to the traffic control mode in which a traffic analysis server generates BGP IPv6 VPN Flow Specification routes to control traffic in an IPv6 VPN domain.

#### Usage Scenario

When deploying dynamic BGP IPv6 VPN Flow Specification, a BGP IPv6 VPN Flow Specification peer relationship needs to be established between the traffic analysis server and each ingress of the network to transmit BGP IPv6 VPN Flow Specification routes.

In an AS with multiple ingresses, a Flow RR can be deployed to reduce the number of BGP IPv6 VPN Flow Specification peer relationships and save network resources.

If you want to filter traffic based on the address prefix but the BGP IPv6 VPN Flow Specification route carrying the filtering rule cannot pass validation, disable validation of BGP IPv6 VPN Flow Specification routes received from a specified peer.


#### Pre-configuration Tasks

Before configuring dynamic BGP IPv6 VPN Flow Specification, complete the following tasks:

* [Configure a VPN instance](dc_vrp_mpls-l3vpn-v6_cfg_2058.html) and [bind interfaces to the VPN instance](dc_vrp_mpls-l3vpn-v6_cfg_2059.html).

#### Procedure

1. Establish a BGP IPv6 VPN Flow Specification peer relationship.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**vpn-instance**](cmdqueryname=vpn-instance) *vpn-instance-name*
      
      
      
      A BGP-VPN instance is created, and the BGP-VPN instance view is displayed.
   4. Run [**peer**](cmdqueryname=peer+as-number) { *ipv4-address* | *ipv6-address* } **as-number** *as-number*
      
      
      
      A peer IP address and the number of the AS where the peer resides are specified.
   5. Run [**quit**](cmdqueryname=quit)
      
      
      
      The BGP view is displayed.
   6. Run [**ipv6-flow vpn-instance**](cmdqueryname=ipv6-flow+vpn-instance) *vpn-instance-name*
      
      
      
      The BGP-Flow VPN instance IPv6 address family is enabled, and the BGP-Flow VPN instance IPv6 address family view is displayed.
   7. Run [**peer**](cmdqueryname=peer) { *ipv4-address* | *ipv6-address* } [**enable**](cmdqueryname=enable)
      
      
      
      A BGP IPv6 VPN Flow Specification peer relationship is established.
      
      
      
      After the peer relationship is established in the BGP-Flow VPN instance IPv6 address family view, the BGP IPv6 VPN Flow Specification route generated by the traffic analysis server is imported automatically to the BGP routing table and then sent to the peer.
   8. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
2. (Optional) Configure a Flow RR.
   
   
   
   Before configuring a Flow RR, establish a BGP IPv6 VPN Flow Specification peer relationship between the Flow RR and traffic analysis server, and between the Flow RR and each network ingress.
   
   
   
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv6-flow vpn-instance**](cmdqueryname=ipv6-flow+vpn-instance) *vpn-instance-name*
      
      
      
      The BGP-Flow VPN instance IPv6 address family view is displayed.
   4. Run [**peer**](cmdqueryname=peer) { *ipv4-address* | *ipv6-address* } [**reflect-client**](cmdqueryname=reflect-client)
      
      
      
      A Flow RR is configured, and clients are specified for it.
      
      
      
      The Router on which the [**peer reflect-client**](cmdqueryname=peer+reflect-client) command is run functions as a Flow RR, and the network ingress and traffic analysis server function as clients.
   5. (Optional) Run [**undo reflect between-clients**](cmdqueryname=undo+reflect+between-clients)
      
      
      
      Route reflection between clients through the RR is disabled.
      
      
      
      If the clients of a Flow RR are fully meshed, you can run the [**undo reflect between-clients**](cmdqueryname=undo+reflect+between-clients) command on the Flow RR to disable route reflection between clients through the RR, which reduces costs.
   6. (Optional) Run [**reflector cluster-id**](cmdqueryname=reflector+cluster-id) { *cluster-id-value* | *cluster-id-ipv4* }
      
      
      
      A cluster ID is configured for the Flow RR.
      
      
      
      If a cluster has multiple flow RRs, run this command to set the same *cluster-id* for these RRs.
      
      ![](../../../../public_sys-resources/note_3.0-en-us.png) 
      
      The [**reflector cluster-id**](cmdqueryname=reflector+cluster-id) command is applicable only to Flow RRs.
   7. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
3. (Optional) Configure the device to check the AS\_Path attribute during BGP IPv6 VPN Flow Specification route validation.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv6-flow vpn-instance**](cmdqueryname=ipv6-flow+vpn-instance) *vpn-instance-name*
      
      
      
      The BGP-Flow VPN instance IPv6 address family view is displayed.
   4. Run [**route validation-mode include-as**](cmdqueryname=route+validation-mode+include-as)
      
      
      
      The device is configured to check the AS\_Path attribute during BGP IPv6 VPN Flow Specification route validation.
      
      
      
      BGP Flow Specification route validation is performed in either of the following modes:
      * Validation mode 1: After receiving a BGP Flow Specification route with a destination address-based filtering rule, the device checks the validity of the route using the rules described in [Figure 1](#EN-US_TASK_0172372350__en-us_cliref_0172383989_fig_route_validation-mode_include-as01). The route is considered valid only if the validation succeeds.
      * Validation mode 2: After receiving a BGP Flow Specification route with a destination address-based filtering rule, the device checks the validity of the route by checking whether the AS\_Path attribute of the route carries the AS\_Set and AS\_Sequence fields. The route is considered valid only if its AS\_Path attribute does not carry the AS\_Set or AS\_Sequence field.Validation mode 2 is configured using the [**route validation-mode include-as**](cmdqueryname=route+validation-mode+include-as) command. If this command is configured, the device checks the validity of a BGP Flow Specification route using mode 2 first.
      * If the validation succeeds, the BGP Flow Specification route is considered valid, and mode 1 is not used.
      * If the validation fails, the device checks the validity of the BGP Flow Specification route using mode 1.If this command is not run, the device uses mode 1 to check the validity of BGP Flow Specification routes.**Figure 1** BGP Flow Specification validation rules  
      ![](figure/en-us_image_0000001228664695.png)
   5. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
4. (Optional) Disable BGP IPv6 VPN Flow Specification route validation.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv6-flow vpn-instance**](cmdqueryname=ipv6-flow+vpn-instance) *vpn-instance-name*
      
      
      
      The BGP-Flow VPN instance IPv6 address family view is displayed.
   4. Run [**peer**](cmdqueryname=peer+validation-disable) { *ipv4-address* | *ipv6-address* } **validation-disable**
      
      
      
      The device is disabled from validating BGP IPv6 VPN Flow Specification routes received from a specified peer.
   5. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
5. (Optional) Disable BGP Flow Specification protection.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**flowspec protocol-protect**](cmdqueryname=flowspec+protocol-protect+ipv4+ipv6+disable) { **ipv4** | **ipv6** } **disable**
      
      
      
      BGP Flow Specification protection is disabled.
   3. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
6. (Optional) Configure the device to redirect traffic to a specified IPv6 next hop after receiving a BGP VPN IPv6 Flow Specification route from a peer.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv6-flow vpn-instance**](cmdqueryname=ipv6-flow+vpn-instance) *vpn-instance-name*
      
      
      
      The BGP-Flow VPN instance IPv6 address family view is displayed.
   4. Run [**peer**](cmdqueryname=peer+redirect+ipv6+recursive-lookup+ip) { *ipv4-address* | *ipv6-address* } **redirect ipv6 recursive-lookup ip**
      
      
      
      The device is configured to redirect traffic to a specified IPv6 next hop after receiving a BGP VPN IPv6 Flow Specification route from a peer.
   5. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
7. (Optional) Allow the device to recurse the BGP VPN IPv6 Flow Specification routes received from a peer to a tunnel.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run **[**tunnel-selector**](cmdqueryname=tunnel-selector)** **name** **matchMode** ****node**** **node**
      
      
      
      A tunnel selector is created and its view is displayed.
   3. Run [**quit**](cmdqueryname=quit)
      
      
      
      The system view is displayed.
   4. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
   5. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   6. Run [**ipv6-flow vpn-instance**](cmdqueryname=ipv6-flow+vpn-instance) *vpn-instance-name*
      
      
      
      The BGP-Flow VPN instance IPv6 address family view is displayed.
   7. Run [**peer**](cmdqueryname=peer+redirect+ipv6+recursive-lookup+tunnel+tunnel-selector) { *ipv4-address* | *ipv6-address* } **redirect ipv6 recursive-lookup tunnel** **tunnel-selector** *tunnel-selector-name*
      
      
      
      The device is allowed to recurse the BGP VPN IPv6 Flow Specification routes received from a peer to a tunnel.
   8. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
8. (Optional) Disable the device from validating the redirection next-hop attribute carried in the routes that are received from an EBGP peer.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv6-flow vpn-instance**](cmdqueryname=ipv6-flow+vpn-instance) *vpn-instance-name*
      
      
      
      The BGP-Flow VPN instance IPv6 address family view is displayed.
   4. Run [**peer**](cmdqueryname=peer+redirect+ipv6+validation-disable) { *ipv4-address* | *ipv6-address* } **redirect ipv6 validation-disable**
      
      
      
      The device is disabled from validating the next-hop attribute of the routes carrying the redirection next-hop attribute that are received from the specified EBGP peer.
   5. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
9. (Optional) Enable the route policy distribution (RPD) capability for a BGP peer to support the BGP Flow Specification routes carrying the RPD attribute and delivered by the controller to forwarders.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv6-flow vpn-instance**](cmdqueryname=ipv6-flow+vpn-instance) *vpn-instance-name*
      
      
      
      The BGP-Flow VPN instance IPv6 address family view is displayed.
   4. Run **peer** *peerIPv6Addr* **capability-advertise** **route-policy-distribute** **receive**
      
      
      
      The RPD capability is enabled for the BGP peer.
   5. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
10. (Optional) Enable the DSCP-based BGP IPv6 Flow Specification traffic filtering rule.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**flowspec allow ipv6 dscp**](cmdqueryname=flowspec+allow+ipv6+dscp)
       
       
       
       The DSCP-based BGP IPv6 Flow Specification traffic filtering rule is enabled.
    3. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
11. (Optional) Enable BGP Flow Specification to match inner packet information about the packets that leave an SRv6 TE Policy or SRv6 BE egress.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**flowspec match srv6-inner-ip enable**](cmdqueryname=flowspec+match+srv6-inner-ip+enable)
       
       
       
       BGP Flow Specification is enabled to match inner packet information about the packets that leave an SRv6 TE Policy or SRv6 BE egress.
    3. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
12. (Optional) Enable BGP IPv6 Flow Specification to match the internal protocol number in the header of an IPv6 fragment.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**flowspec match ipv6 fragment-inner-protocol enable**](cmdqueryname=flowspec+match+ipv6+fragment-inner-protocol+enable)
       
       
       
       BGP IPv6 Flow Specification is enabled to match the internal protocol number in the header of an IPv6 fragment.
    3. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.

#### Verifying the Configuration

After the configuration is complete, verify the configuration.

* Run the [**display bgp flow**](cmdqueryname=display+bgp+flow+vpnv6+vpn-instance+peer+verbose) **vpnv6** **vpn-instance** *vpn-instance-name* **peer** [ [ *ipv4-address* | *ipv6-address* ] **verbose** ] command to check information about BGP IPv6 VPN Flow Specification peers.
* Run the [**display bgp flow**](cmdqueryname=display+bgp+flow+vpnv6+vpn-instance+routing-table) **vpnv6** **vpn-instance** *vpn-instance-name* **routing-table** command to check information about BGP IPv6 VPN Flow Specification routes.
* Run the [**display bgp flow**](cmdqueryname=display+bgp+flow+vpnv6+vpn-instance+routing-table+peer) **vpnv6** **vpn-instance** *vpn-instance-name* **routing-table** [ **peer** { *ipv4-address* | *ipv6-address* } { **advertised-routes** | **received-routes** [ **active** ] } ] **statistics** command to check statistics about BGP IPv6 VPN Flow Specification routes.
* Run the [**display flowspec**](cmdqueryname=display+flowspec+ipv6+rule+slot) **ipv6** **rule** *reindex-value* **slot** *slot-id* command to check information about combined rules in the BGP IPv6 Flow Specification route rule table.
* Run the [**display flowspec**](cmdqueryname=display+flowspec+ipv6+rule+statistics+slot) **ipv6** **rule statistics slot** *slot-id* command to check statistics about the rules for BGP IPv6 Flow Specification routes to take effect.
* Run the [**display flowspec resource rule**](cmdqueryname=display+flowspec+resource+rule+ipv4+ipv6+slot) { **ipv4** | **ipv6** } [ **slot** *slot-id* ] command to check the resource usage information about BGP Flow Specification route rules.