Configuration Precautions for IPsec
===================================

Configuration_Precautions_for_IPsec

#### Feature Requirements

**Table 1** Feature requirements
| Feature Requirements | Series | Models |
| --- | --- | --- |
| In a VXLAN over IPsec scenario, the pre-fragmentation function is enabled on the IPsec encryption side. The VSUP-100 subcard, which resides on the IPsec decryption side, can reassemble only a maximum of two VXLAN packet fragments after packets leave the IPsec tunnel. If the number of fragments exceeds two, the reassembly fails. | NE40E-M2 | NE40E-M2K/NE40E-M2K-B |
| The principle of IPsec conflict check is as follows: When a tunnel is established, all service boards check whether the protected traffic overlaps. In addition, the tunnel can be established for only one traffic flow. The new traffic (normal traffic) is preferentially ensured, and the traffic that is established later (conflict traffic) cannot be established.  The flow conflict function has the following restrictions:  1. The flow conflict check only checks whether the destination address range of the protected flows overlaps, regardless of the port and source address of the protected flows.  2. Only the protected flows between different IKE tunnels are checked. The conflict check is not peformed for the protected flows under the same IKE tunnel.  3. The flow conflict check function supports only the template mode, and policy check is not supported.  4. When the flow conflict check function is used in manual board migration, if conflicting traffic persists for negotiation, the board migration may fail. In this case, you need to solve the traffic conflict problem, re-specificate the network address, and then perform the migration.  5. When conflicting traffic and normal services are load balanced on different service boards, conflicting traffic may be permitted for a short period of time, and established service traffic may be interrupted for a short period of time.  6. When conflicting traffic is continuously created, there is a low probability that existing services are preempted by conflicting traffic.  7. In the dual-device active/standby scenario, if the master device that normally establishes a tunnel performs board migration, the tunnel on the backup device may be preempted.  8. In NAT traversal scenarios, if the peer addresses of conflicting traffic are the same but the ports are different, do not specify a port for board migration on the template side. Otherwise, normal traffic may be preempted, and conflicting tunnels may be successfully established. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| Only the primary IP address statically configured on an IPsec tunnel interface can be borrowed. Dynamic IP addresses obtained through DHCP or other methods are not supported. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| GRE over IPsec does not support dual-device hot backup or path MTU.  Impact: User traffic cannot be forwarded. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| In IPsec over L2TP scenarios, only L2TPv2 is supported. The device can function as an LNS, but not an LAC. In addition, it does not support dual-device hot backup.  Impact: User traffic cannot be forwarded. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| If an IPsec tunnel interface borrows the address of another interface, the numbered interface cannot carry other services because it cannot receive or send multicast or broadcast packets.  Impact: Services on the numbered interface are affected.  Workaround: Properly plan the network and do not configure other services using the borrowed address. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| IKE IPsec supports only the tunnel mode, and manual IPsec supports only the transport mode.  Impact: Traffic cannot be forwarded.  Workaround: Select a correct tunnel mode. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| IPsec does not support traffic forwarding on management interfaces or global VE interfaces.  Impact: User traffic cannot be forwarded.  Workaround: Plan the network properly. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| The ACL and IKE peer must be configured in the IPsec policy. The VPN configured in the ACL rule must be the same as that bound to the IKE peer.  Impact: IPsec traffic fails to be forwarded when the configurations are inconsistent.  Workaround: Ensure that the VPN bound to the IKE peer is the same as that configured in the ACL rule. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| ACL rules used for IPsec negotiation, filtering, or mirroring do not support discontinuous masks (where 0s or 1s are discontinuous, such as 255.0.255.0).  Impact: IPsec negotiation, filtering, and mirroring do not take effect. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| In IPSec negotiation, the ACL rules referenced by traffic filtering and traffic mirroring support only 5-tuple and VPN instance rules.  Only the EQ mode is supported for port matching. When port matching is configured, fragmented packets (only the first fragment carries port information and can match the ACL) cannot match the ACL.  Impact:  ACL rules that are not based on 5-tuple or VPN instances cannot be used for IPsec traffic filtering or mirroring.  When the EQ mode is configured on an interface, fragmented packets cannot be matched.  Port matching in a non-EQ mode does not take effect. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| The IPsec tunnel route and the route to the peer through the IPsec tunnel do not support load balancing among multiple routes.  Impact: IPsec traffic forwarding is affected.  Workaround: Do not configure multiple routes to the local tunnel. | NE40E-M2 | NE40E-M2K/NE40E-M2K-B |
| When IPsec gateways support the plug-and-play function, only IPv4 single-next-hop routes can be used for forwarding on the ciphertext side. If a route has different next hops, one outbound interface is selected for forwarding.  The plug-and-play function supports only interconnection with Huawei base stations and does not support renegotiation or negotiation of multiple IPsec SAs under one IKE SA.  MPLS forwarding is not supported. Plug-and-play supports only the following outbound interfaces on the ciphertext side: Ethernet physical interfaces, Ethernet physical sub-interfaces, Eth-Trunk interfaces, and Eth-Trunk sub-interfaces. Plug-and-play does not support dual-device hot backup, the on-board mode, or the non-template mode.  Impact: Only fixed scenarios are used.  Workaround: Use the VPN isolation mode. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| During a version downgrade, if certificates have been imported and then deleted or keys have been created and then deleted in the target version, delete the certificates and keys of the device before the downgrade. Functions are normal after the downgrade only when the ca\_config.ini file is empty.  Impact: If the certificates and keys are not deleted before the downgrade and the ca\_config.ini file remains, after the system is rolled back to a version earlier than V800R010C00, the certificates and keys created and deleted subsequently cannot be updated to the ca\_config.ini file. As a result, the certificate and key files are lost after the device restart. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| In load balancing scenarios, if a VSU fails, IPsec tunnels on the VSU must be re-established on the other VSUs, and IPsec traffic is balanced among the other VSUs.  Impact: The VSU may carry excessive traffic, affecting IPsec services on the VSU. After the faulty board recovers, services are not switched back, causing IPsec service boards not to evenly balance traffic.  Workaround: If IPsec dual-device hot backup is deployed on multiple VSUs, configure IPsec to track the VSU status. | NE40E-M2 | NE40E-M2K/NE40E-M2K-B |
| When performing a ping test on the protection tunnel of an IPsec gateway, you need to specify the source IP address through the -a parameter. Specifying the peer tunnel interface as the next-hop address (through the -nexthop parameter) to perform a ping test on the protection tunnel is not supported.  Impact: After the next hop is specified, packets are forwarded based on the next-hop address. As a result, packets cannot enter the IPsec tunnel to reach the destination.  Workaround: Do not specify the peer tunnel interface as the next-hop address (through the -nexthop parameter) when performing a ping test on the protection tunnel of an IPsec gateway. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| When configuring a static route to guide IPsec traffic into an IPsec tunnel, you need to specify an IPsec tunnel interface as the outbound interface of the static route and specify the peer address as the next hop.  Impact: User traffic cannot be forwarded. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| After the local IPsec tunnel address borrows the IP address of another interface, the configuration of the interface cannot be deleted.  Impact: The configuration cannot be deleted.  Workaround: Correct the configuration. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| When multiple initiators negotiate with the same responder, the ACL rules configured on the initiators cannot overlap.  Impact: If overlapping exists, some overlapping traffic cannot be correctly encrypted, causing service loss.  Workaround: Modify the traffic protection rule of the initiator that has a conflict. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| In a BFD for IPsec scenario, if the BFD interval is set to a small value and manual board migration is performed, the BFD link may be disconnected, affecting services. | NE40E-M2 | NE40E-M2K/NE40E-M2K-B |