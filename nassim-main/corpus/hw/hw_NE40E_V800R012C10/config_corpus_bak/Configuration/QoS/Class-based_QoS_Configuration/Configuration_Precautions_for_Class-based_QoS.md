Configuration Precautions for Class-based QoS
=============================================

Configuration_Precautions_for_Class-based_QoS

#### Feature Requirements

**Table 1** Feature requirements
| Feature Requirements | Series | Models |
| --- | --- | --- |
| After the traffic-policy ucl upstream match-source-ip command is run in the AAA domain view, the configuration does not take effect for users that are already online and takes effect only for users newly going online.  After a new user goes online, the following features do not take effect because they depend on user-group:  Distributed NAT, distributed DS-Lite,NAT service chain, web redirection, and DAA | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| In the following service scenarios, MF classification or QPPB policies cannot match QoS local IDs when downstream packets are looped back:  1. Services enter the GRE tunnel.  2. Services enter the VXLAN tunnel.  3. Services enter SRv6 tunnels in the following scenarios:  3.1. The list has only one layer and the first SID is a local End.X SID.  3.2. The first SID is a binding SID or a local End SID.  3.3. Services recurse to an SRv6 Policy or flow group in shortcut mode.  3.4. The locator route on the BE ingress node recurses to an SRv6 Policy in shortcut mode in an L3VPNv4/L3VPNv6 over SRv6 BE, EVPN L3VPNv4/L3VPNv6 over SRv6, or public network IPv4/IPv6 over SRv6 BE scenario.  3.5. The route to the first-hop SID is unreachable.  3.6. The backup link for traffic switching is a TI-LFA link.  3.7. Switchover microloop avoidance takes effect.  3.8. Switchback microloop avoidance takes effect.  3.9. TE FRR is triggered.  4. Services are deployed on VE interfaces.  5. Services enter a 4over6 tunnel.  6. Services enter an L2TP tunnel. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| For NE40E-M2E/NE40E-M2F/NE40E-M2H boards, IPv6 UCLs support only IPv6 addresses in prefix mode. When the traffic-policy ipv6-address-rule match mask command is run in the slot view, IPv6 UCLs that match IPv6 addresses in prefix mode do not take effect. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| When the access type of a BAS interface is Layer 2 common user, Layer 3 common user, Layer 2 VPN leased line user, or Layer 2 leased line user, a multi-field classification policy can be applied but does not take effect. | NE40E-M2 | NE40E-M2F/NE40E-M2K/NE40E-M2K-B |
| UCLs may not take effect in Layer 2 service scenarios. Therefore, you are advised to configure ACLs in Layer 2 service scenarios. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| 1, ACL sampling does not support traffic policies in shared mode. Sampling can be configured in the traffic policy using commands but does not take effect.  2, ACL sampling is supported only on common sub-interfaces. It can be configured on other sub-interfaces using commands but does not take effect. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| 1. Traffic on the inbound VLANIF interface:  If a traffic policy is configured on both the inbound VLANIF interface and its member interfaces, the traffic policy does not take effect on the member interfaces, regardless of whether QPPB is enabled. Traffic matches the BGP flow policy, global traffic policy (ACL), traffic policy on the VLANIF interface, and QPPB policy for incoming traffic in sequence. If the actions defined in the policies are the same, the later policy takes effect. If the actions defined in the policies are different, all the policies take effect.  2. Traffic on the outbound VLANIF interface:  (1) If QPPB is enabled for incoming traffic and a traffic policy is configured on both the inbound and outbound VLANIF interfaces, the traffic policy does not take effect on the inbound interface. Traffic matches the BGP flow policy, global traffic policy (ACL), traffic policy on the VLANIF interface, and QPPB policy for incoming traffic in sequence. If the actions defined in the policies are the same, the later policy takes effect. If the actions defined in the policies are different, all the policies take effect.  (2) If QPPB is not enabled for incoming traffic and a traffic policy is configured on both the outbound VLANIF interface and the inbound interface of the device, both traffic policies take effect. Traffic matches the BGP flow policy, global traffic policy (ACL), traffic policy on the inbound interface of the device, traffic policy on the VLANIF interface, and QPPB policy for incoming traffic in sequence. If the actions defined in the policies are the same, the later one takes effect. If the actions defined in the policies are different, all the policies take effect. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| When both QPPB and interface-based ACL are configured on an interface, there are restrictions in the following scenarios:  1. If the traffic behavior car is configured for both QPPB and an interface-based ACL and traffic matches both QPPB and the interface-based ACL, the smaller bandwidth value takes effect.  2. If the same non-forwarding actions (except deny and redirection) are configured at the same time, the actions specified in QPPB take effect in the upstream direction and the actions specified in the interface-based ACL take effect in the downstream direction.  3. If different non-forwarding actions (except deny and redirection) are configured for QPPB and interface ACL, both the interface ACL and QPPB actions take effect.  4. If the redirection or deny action is configured in the inbound direction of an interface ACL, the QPPB action does not take effect. If the deny action is configured in the downstream direction of QPPB, the interface-based ACL does not take effect. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| After ARP-MAC association is disabled, downstream MF classification does not take effect on VLANIF interfaces. (ARP-MAC association is enabled by default.) | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| A traffic policy in shared mode cannot be bound to a BAS interface. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| An MF classification policy in the BAS interface view is mutually exclusive with that in the view of the interface where BAS resides. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| When BRAS PUPP is configured, if the policy rule content contains any of the following types, the rule processing method is as follows:  1, When the rule content contains the IPv4 TTL field, VPN-instance, or IPv6 fragment, commands can be configured, but the entire rule does not take effect.  2, When the rule content contains the IPv6 TOS or IPv6 TCP-Flag, commands can be configured. This field does not take effect, but the fields of the other types take effect. | NE40E-M2 | NE40E-M2F/NE40E-M2H |
| The BRAS PUPP feature allows the actions other than permit/deny/remark/match termination to be configured in the policy, but such actions do not take effect. | NE40E-M2 | NE40E-M2F/NE40E-M2H |
| When BRAS PUPP is configured, only advanced IPv4 and IPv6 rules in the policy take effect. Non-advanced IPv4 and IPv6 rules can be configured but do not take effect. | NE40E-M2 | NE40E-M2F/NE40E-M2H |
| The BRAS PUPP feature allows classifiers in AND mode to be configured in the policy, but the classifiers in AND mode do not take effect. | NE40E-M2 | NE40E-M2F/NE40E-M2H |
| CAR in color-aware mode is not supported on an IPv6 GRE tunnel interface. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| Only MF classification in ip-layer mode (default mode) is supported on an IPv6 GRE tunnel interface.If link-layer or all-layer is specified for MF classification on IPv6 GRE tunnel interfaces, Layer 2 rules cannot be matched. If mpls-layer is specified, MPLS rules cannot be matched. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| MIBs and NMS do not support level-2 ACL sub-policy statistics query and clearing. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| The traffic-policy match-mpls-layer { mpls-push | mpls-pop } \* command has the following mutually exclusive relationships:  The traffic-policy match-mpls-layer mpls-pop mpls-push and traffic-policy match-ip-layer { mpls-push | mpls-pop } commands are mutually exclusive.  The traffic-policy match-mpls-layer mpls-pop mpls-push and traffic-policy match-rule packet-type commands are mutually exclusive. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| Downstream MF classification on a VLANIF interface does not support IPv6 rules. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| A shared MF classification policy cannot be authorized to users through an RADIUS server. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| Hierarchical CAR and QPPB Policy CAR are mutually exclusive. If both functions are configured on the same interface, QPPB Policy CAR takes effect, and only second-level ACL in hierarchical CAR takes effect. First-level ACL CAR does not take effect. However, if hierarchical CAR is enabled and MF classification contains only level-1 CAR, both QPPB Policy CAR and hierarchical CAR take effect.  1, When hierarchical CAR and QPPB policy CAR are both configured on an interface and level-2 CAR is configured for hierarchical CAR, QPPB policy CAR takes effect, and only CAR for the second-level ACL takes effect. First-level ACL CAR does not take effect.  2, When hierarchical CAR and QPPB policy CAR are configured on an interface and one CAR (CAR is configured in a parent or child policy) is configured for hierarchical CAR, QPPB policy CAR takes effect, and the one CAR for hierarchical CAR also takes effect.  Configuring only one of hierarchical CAR and CAR in ar QPPB Policy on one interface is recommended. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| When rate limiting based on Layer 3 packets is configured in a traffic policy, CAR based on the packet rate or CAR based on packet length compensation cannot be configured. Otherwise, rate limiting based on Layer 3 packets does not take effect. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| When address pool-, port pool-, or port range-based rules are configured in a traffic policy, if the number of addresses or ports in the pool decreases or the port range is shortened, the rules with lower priorities become invalid temporarily. The number of rules that become temporarily invalid is determined by the number of deleted rules. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| In the scenario where traffic enters an SRv6 tunnel/VXLAN tunnel/MPLS LDP LSP, a traffic policy is applied to an inbound interface of the tunnel/LSP's egress. If an ACL rule for matching the tunnel header is configured in the traffic policy, the traffic policy can take effect on the traffic received on the egress. After a QPPB policy is configured on the inbound interface, the traffic policy cannot match the tunnel header. As a result, the traffic policy becomes invalid. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| For a Layer 3 private line user, if a UCL rule for matching the source and destination IP addresses is configured in the traffic policy applied in the system view, the UCL rule becomes invalid when an EDSG service policy is applied to the user.  To apply a traffic policy that contains an ACL rule for matching the source and destination IP addresses to the Layer 3 private line user's network-to-network traffic, configure the traffic policy in the interface view. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| 1. VLANs may not be specified in the traffic-policy command on VLAN stacking interfaces, but must be specified on other Layer 2 interfaces.  2. The traffic-policy command is configured on a VLAN stacking interface. After the VLAN stacking configuration is deleted, the traffic-policy command takes effect as follows:  (1) The traffic-policy command with VLANs specified takes effect on the packets with the specified VLANs.  (2) The traffic-policy command with no VLANs specified takes effect on the packets without VLAN information. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| 1. VLANs may not be specified in a behavior aggregate classification configuration on a VLAN stacking interface, but must be specified on other Layer 2 interfaces.  2. Behavior aggregate classification is configured on a VLAN stacking interface. After the VLAN stacking interface configuration is deleted, the behavior aggregate classification configuration takes effect as follows:  (1) The behavior aggregate classification configuration with VLANs specified takes effect on the packets with the specified VLANs.  (2) The behavior aggregate classification configuration with no VLANs specified takes effect on the packets without VLAN information.  If the trust upstream (inbound or outbound may or may not be specified) or qos phb enable default command is configured on an interface, behavior aggregate classification is configured. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| When a traffic policy is applied to the outbound direction of a VLANIF/VBDIF interface, the traffic policy takes effect on the board where the inbound interface of traffic resides.  (1) If a traffic policy is configured on the inbound interface and the traffic behavior is discard, the traffic does not match the traffic policy of the VLANIF/VBDIF interface.  (2) If a traffic policy is applied to the inbound interface and the traffic behavior is CAR, and a traffic policy is applied to the outbound direction of the VLANIF/VBDIF interface and the traffic behavior is CAR, the VLANIF/VBDIF interface's CAR and the inbound interface's CAR are performed for the traffic in sequence. In this case, the number of packets matching the traffic policy of the VLANIF/VBDIF interface is the number of matching packets before the inbound interface's CAR is performed. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| A device functions as the ingress of a VXLAN tunnel. When the well-known VXLAN port number is not explicitly specified in a global ACL rule for upstream traffic, the number of packets that travel the device through the VXLAN tunnel and match the global ACL rule is doubled.  Configure rules to distinguish well-known VXLAN port numbers from non-well-known VXLAN port numbers, place them in different traffic classifiers, and associate traffic behaviors with the traffic classifiers. This workaround doubles the configuration workload and hardware TCAM resource usage. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| After MF classification is applied to an interface, the user type can be configured only as Layer 3 leased line users. | NE40E-M2 | NE40E-M2F/NE40E-M2H |
| After a detection OAM service is configured, the function of adding QoS policy IDs to VXLAN packets and the function of matching packets based on QoS policy IDs do not take effect. | NE40E-M2 | NE40E-M2H |
| When an IPv6 packet has multiple extension headers, MF classification supports the matching of only the first IPv6 extension header or the first option field in the first IPv6 extension header. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| Hop-by-hop traffic can match an IPv6 hop-by-hop rule only after the rule is explicitly configured in an MF classification policy. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| If an IPv6 hop-by-hop extension header rule is configured in a PUPP policy, the rule does not take effect. | NE40E-M2 | NE40E-M2F/NE40E-M2H |
| In an L3VPN accessing SRv6 TE Policy scenario, after a traffic policy is applied to upstream traffic sent out of the SRv6 tunnel in the L3VPN view, ACL rules cannot be used to match user IP addresses in SRv6 tunnel headers. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| When traffic enters a GRE tunnel, MF classification does not take effect in the inbound direction of the GRE tunnel interface. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| In L2VXLAN scenarios, the function of adding a QoS policy ID to VXLAN packets and matching packets based on the QoS policy ID takes effect only for known unicast traffic.  Do not configure this function for other types of traffic in L2VXLAN scenarios. | NE40E-M2 | NE40E-M2H |
| After the number of incrementally configured rules in a traffic policy exceeds the ACL capacity, the rules that have been delivered to the hardware continue to take effect, but the rules that have not been delivered to the hardware do not take effect. After the board is restarted, all rules in the traffic policy do not take effect. Before the configuration, check the remaining ACL capacity on the device to ensure that the new ACL capacity is within the allowed range. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| UCL rules cannot match user IP addresses in MPLS packets in the inbound and outbound directions of the ingress and egress PEs on an MPLS network. | NE40E-M2 | NE40E-M2F/NE40E-M2H |
| One or more next-hop IP addresses are specified for the redirection action, and the outbound interface is specified as a trunk member interface. When the working next-hop trunk member interface goes Down, traffic is interrupted, regardless of whether the route-forward keyword is configured. The outbound interface of the redirection policy must be a Layer 3 interface. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| In the following scenarios, if URPF in strict mode is configured in a traffic behavior, the URPF in loose mode is automatically changed to the URPF in strict mode.  1. Dot1q, QinQ, and flexible sub-interfaces;  2. EVC dot1q and QinQ interfaces | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| For multicast traffic sent from the network side to the user side, BA classification configured in the AAA domain does not take effect, and the PHB configured on the BAS interface does not take effect. Multicast traffic from the network side to the user side can enter queues only based on BA classification on the network interface, but cannot enter queues based on BA classification in the AAA domain. In addition, PHB reverse mapping is not performed for outgoing packets. If the outgoing interface is a sub-interface, the 802.1p value is 0. | NE40E-M2 | NE40E-M2F/NE40E-M2H |
| After an if-match offset rule is configured for an MF traffic policy, you can only run the display traffic policy statistics verbose rule-based command to query statistics based on the rule, but cannot run the display traffic policy statistics [ verbose classifier-based ] command to query statistics based on the policy or classifier.  When statistics are queried based on the policy or classifier, the traffic matching the offset rule is not counted. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| Run the "traffic-policy" command in the traffic behavior view to configure a cascaded traffic policy and enable matching of SRv6 inner packets. If a local End SID, a local End.X with only one SID, a local BSID, TE FRR, TI-LFA, or anti-microloop is configured in an SRv6 forwarding scenario or remote routes are withdrawn instantaneously, the function of matching inner packets in the downstream direction of the ingress PE does not take effect, and the corresponding action is not performed. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| The "traffic-policy <policy-name> [ ip-layer srv6-inner | link-layer srv6-inner ]" command is run in the traffic behavior view to configure a cascaded traffic policy and enable matching of SRv6 inner packets. The re-mark action is configured in the traffic behavior of the cascaded traffic policy, and does not take effect for inner packets but takes effect for outer SRv6 tunnel headers. The re-mark action for DSCP is configured based on the rule type of the cascaded sub-policy. That is, remark dscp is configured for IPv4 rules, and remark ipv6 dscp is configured for IPv6 rules. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| A hoport rule can be configured in an advanced ACL IPv6 profile for MF classification on an interface to match the Hop-by-Hop extension header in IPv6 packets. If a packet matches the rule, the packet is forwarded or discarded. If any of the QPPB, UCL, and PUPP functions is configured, the function of matching IPv6 packets based on the Hop-by-Hop extension header does not take effect on an interface, and packets with the Hop-by-Hop extension header are sent to the CPU by default. In this case, the configured traffic action (pass or discard action) does not take effect. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |