Configuring the NAT Log Function
================================

You can configure the NAT log function to record NAT operation information in real time, which strengthens device maintainability.

#### Context

NAT logs are generated by a NAT device during NAT operation. The information contains basic user information and system information generated during NAT operation. NAT logs also record intranet users' access to external networks and external users' access to intranet servers. When intranet users access an external network through the NAT device, they share an external network address. For this reason, the users cannot be located. The log function helps record intranet users' access to external networks in real time, enhancing network maintainability.

![](../../../../public_sys-resources/note_3.0-en-us.png) 

Only NE40E-M2K and NE40E-M2K-B support the configuration of user logs, TCP-based log sending, and log host backup.



#### Procedure

1. Run [**system-view**](cmdqueryname=system-view)
   
   
   
   The system view is displayed.
2. (Optional) Configure an IPsec tunnel. For details, see [Configuration > Security > IPsec Configuration](../vrp/dc_vrp_ipsec_cfg_0001.html).
   
   
   
   For the sake of security, you are advised to configure an IPsec tunnel to implement encrypted NAT log transfer. Particularly, IPsec must be configured on both the master and backup devices in inter-chassis backup scenarios.
3. (Optional) Run [**nat log tcp start-port**](cmdqueryname=nat+log+tcp+start-port) *port*
   
   
   
   The start port number used by the NAT device to send user logs to a log host through TCP is set.
   
   
   
   To establish a TCP connection between a NAT device and a log host, run this command to set the start port number used in the TCP connection.
4. (Optional) Run [**nat log user keepalive enable syslog type3**](cmdqueryname=nat+log+user+keepalive+enable+syslog+type3)
   
   
   
   The Keepalive log function is enabled for NAT users, with the type 3 log format.
5. (Optional) Run [**nat log user keepalive interval**](cmdqueryname=nat+log+user+keepalive+interval) *interval-num*
   
   
   
   The interval for sending Keepalive logs for NAT users is set.
6. Run [**nat log rate**](cmdqueryname=nat+log+rate) *rate-value*
   
   
   
   The rate at which NAT logs are sent is set.
7. (Optional) Run [**nat log host detect enable**](cmdqueryname=nat+log+host+detect+enable)
   
   
   
   Heartbeat detection for the NAT log server is enabled.
   
   
   
   * To set the detection interval and the maximum number of consecutive detection failures for an ICMP log server, run the [**nat log host detect icmp**](cmdqueryname=nat+log+host+detect+icmp+interval+failed-times+interval) { **interval** *interval-value* | **failed-times** *detect-failed-times* | **interval** *interval-value* **failed-times** *detect-failed-times* } command on the NAT device.
   * To set the detection interval and the maximum number of detection recovery times for a UDP log server, run the [**nat log host detect udp**](cmdqueryname=nat+log+host+detect+udp+interval+recovery-times+interval) { **interval** *interval-value* | **recovery-times** *recovery-times-value* | **interval** *interval-value* **recovery-times** *recovery-times-value* } command on the NAT device.
8. Run [**commit**](cmdqueryname=commit)
   
   
   
   The configuration is committed.
9. Run [**nat instance**](cmdqueryname=nat+instance+id) *instance-name* [ **id** *id* ]
   
   
   
   The NAT instance view is displayed.
10. Run [**nat log session enable**](cmdqueryname=nat+log+session+enable+elog+syslog+netstream) [ { **elog** | **syslog** | **netstream** } [ **secondary** { **elog** | **syslog** | **netstream** } ] ]
    
    
    
    The NAT log function is enabled.
11. Run [**nat log user enable**](cmdqueryname=nat+log+user+enable+syslog+netstream+secondary+syslog+netstream) [ { **syslog** | **netstream** } [ **secondary** { **syslog** | **netstream** } ] ]
    
    
    
    The NAT user log function is enabled.
12. Configure NAT log host information.
    
    
    * To enable the NAT device to send logs to a log host using UDP, run the [**nat log host**](cmdqueryname=nat+log+host+source+name+vpn-instance) *host-ip-address* *host-port* **source** *source-ip-address* *source-port* [ **name** *name* ] [ **vpn-instance** *vpn-instance-name* ] [ **inside-vpn** *inside-vpn-instance-name* ] [ **secondary** ] command.![](../../../../public_sys-resources/note_3.0-en-us.png) 
      
      The **inside-vpn** and **secondary** parameters are supported only in NE40E-M2K and NE40E-M2K-B dedicated board modes.
    * To enable the NAT device to send logs to a log host using TCP for the NE40E-M2K and NE40E-M2K-B, run the [**nat log tcp**](cmdqueryname=nat+log+tcp+host+source+name+vpn-instance) **host** *host-ip-address* *host-port* **source** *source-ip-address* [ **name** *name* ] [ **vpn-instance** *vpn-instance-name* ] command.
      
      ![](../../../../public_sys-resources/note_3.0-en-us.png) 
      
      This command is mutually exclusive with the [**nat log host**](cmdqueryname=nat+log+host) command. Only one user log transmission mode can be configured in a NAT instance.
      
      Only one log host can be configured in a NAT instance to receive user syslogs in TCP format.
      
      This command takes effect only on [dedicated boards](dc_ne_nat_feature_0008.html#EN-US_CONCEPT_0172359138__li1033371595).
13. (Optional) Run [**nat log host select-mode match-inside-vpn**](cmdqueryname=nat+log+host+select-mode+match-inside-vpn)
    
    
    
    The device is enabled to select a log server based on the user-side VPN in the NAT instance.
14. (Optional) Run [**nat session-log elog-version v2**](cmdqueryname=nat+session-log+elog-version+v2)
    
    
    
    The function of sending flow logs in version 2 format is enabled.
15. Run [**nat log radius enable**](cmdqueryname=nat+log+radius+enable)
    
    
    
    The NAT device is enabled to send a real-time accounting packet to a RADIUS server to inform the server of a port range change.
    
    
    
    If the semi-dynamic port pre-allocation mode is configured, the available port range is automatically extended after the initial port range is exhausted. In this situation, if the device needs to send RADIUS logs, the function of semi-dynamic allocation of RADIUS logs must be enabled.
16. (Optional) Run [**nat log send-mode**](cmdqueryname=nat+log+send-mode+session-start-only+session-end-only) { **session-start-only** | **session-end-only** | **session-inbound** | **session-outbound**}
    
    
    
    A NAT log sending mode is configured.
    
    
    
    ![](../../../../public_sys-resources/note_3.0-en-us.png) 
    
    The **session-inbound** and **session-outbound** parameters are supported only in NE40E-M2K and NE40E-M2K-B dedicated board modes.
17. (Optional) Configure a flexible NAT log template.
    
    ![](../../../../public_sys-resources/note_3.0-en-us.png) 
    
    In the following steps, the **user** parameter is supported only on the NE40E-M2K and NE40E-M2K-B.
    
    
    
    1. Run [**quit**](cmdqueryname=quit)
       
       Return to the system view.
    2. Run [**nat syslog flexible template**](cmdqueryname=nat+syslog+flexible+template+session) { **user** | **session** }
       
       A NAT syslog flexible template is created, and its view is displayed.
    3. (Optional) Run [**nat time local**](cmdqueryname=nat+time+local)
       
       The local time is displayed in the logs.
    4. (Optional) Run [**nat time**](cmdqueryname=nat+time) { **endtime-second-dec** | **endtime-second-hex** | **starttime-second-dec** | **starttime-second-hex** | **starttime** | **timestamp-second-dec** | **timestamp-second-hex** | **timestamp** } { **local** | **utc** }
       
       The end time, start time, or timestamp in the log is set to the local time or UTC time.
       
       ![](../../../../public_sys-resources/note_3.0-en-us.png) 
       
       The time format configured using the **nat time** command takes precedence over that configured using the **nat time local** command in the flexible log template view. If the **nat time** command is run, the time format of the end time, start time, or timestamp takes effect according to the configured format. If the **nat time** command is not run, the **nat time local** command takes effect. If neither the **nat time** command nor the **nat time local** command is run, the default UTC time takes effect.
    5. Run [**nat position**](cmdqueryname=nat+position)
       
       A flexible NAT log template is configured.
    6. Run [**quit**](cmdqueryname=quit)
       
       Return to the system view.
    7. Run [**nat syslog descriptive format flexible template**](cmdqueryname=nat+syslog+descriptive+format+flexible+template+session) { **session** | **user** }
       
       A flexible log template type is specified.
18. (Optional) Run [**nat syslog descriptive format**](cmdqueryname=nat+syslog+descriptive+format+cn+type2+type3+local-timezone) { **cn** | **type2** | **type3** [ **local-timezone** ] | **type4** | **type5** | **type6** [ **dual-sequence** ] }
    
    
    
    NAT syslogs are configured to be in the extended format.
19. Run [**commit**](cmdqueryname=commit)
    
    
    
    The configuration is committed.