
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring Inter-AS NG MVPN in Option B Mode">
<meta name="abstract" content="In the scenario where the backbone network spans multiple ASs, ASBRs advertise labeled VPN IPv4 routes through MP-EBGP.">
<meta name="description" content="In the scenario where the backbone network spans multiple ASs, ASBRs advertise labeled VPN IPv4 routes through MP-EBGP.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0012.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0101.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0074.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="z00603461,w00606909,w00447999">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="IPv4 Multicast VPN_NG MVPN">
<meta name="featuretype" content="IP Multicast">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="IPv4 Multicast VPN_NG MVPN">
<meta name="featuretype" content="IP Multicast">
<meta name="featurename" content="IPv4 Multicast VPN_NG MVPN">
<meta name="featuretype" content="IP Multicast">
<meta name="featurename" content="IPv4 Multicast VPN_NG MVPN">
<meta name="featuretype" content="IP Multicast">
<meta name="OWNER" content="w00447999">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="w00447999">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0000001270153525">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/jquery.min.idp.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/RowOrColfreezeSupport.js"></script>

<script type="text/javascript">
setTimeout(function(){
	jQueryHW(document).ready(function(){
		jQueryHW("table[rowfreeze='yes']").rowfreeze();
		jQueryHW("table[colfreeze='yes']").colfreeze();
	});
},500);
</script>
<title>Example for Configuring Inter-AS NG MVPN in Option B Mode</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0000001270153525"></a><a name="EN-US_TASK_0000001270153525"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring Inter-AS NG MVPN in Option B Mode</h1>
<div class="taskbody"><p>In the scenario where the backbone network spans multiple ASs, ASBRs advertise labeled VPN IPv4 routes through MP-EBGP.</p>
<div class="context"><a name="EN-US_TASK_0000001270153525__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>As shown in <a href="#EN-US_TASK_0000001270153525__fig_dc_vrp_cfg_ngmvpn_007301">Figure 1</a>, the inter-AS NG MVPN is deployed on an Option B network. PE1 connects to the multicast source, and PE2 connects to the multicast receiver. CE1 and CE2 belong to different VPN instances, and devices of the VPN instances communicate across AS100 and AS200. The VPN configuration does not need to be deployed on the ASBRs. The ASBRs only need to forward VPNv4 routes to peer ASBRs. An MP-IBGP relationship is established between each PE and ASBR within an AS domain. An MP-EBGP relationship is established between ASBRs.</p>
<div class="fignone" id="EN-US_TASK_0000001270153525__fig_dc_vrp_cfg_ngmvpn_007301"><a name="EN-US_TASK_0000001270153525__fig_dc_vrp_cfg_ngmvpn_007301"></a><a name="fig_dc_vrp_cfg_ngmvpn_007301"></a><span class="figcap"><b>Figure 1 </b>Configuring inter-AS NG MVPN in option B mode</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1, 2, 3, and 4 in this example represent GE <span>0/1/0</span>, GE <span>0/1/1</span>, GE <span>0/1/2</span>, and GE<span>0/1/3</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0000001225833660.png"></span></div>

<div class="tableBorder"><table cellpadding="4" cellspacing="0" summary="" rowfreeze="yes" frame="border" border="1" rules="all"><thead align="left"><tr><th align="left" class="cellrowborder" valign="top" width="13.24867513248675%" id="mcps1.4.1.4.1.4.1.1" liSelected="liSelected"><p>Device Name</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="37.08629137086292%" id="mcps1.4.1.4.1.4.1.2" liSelected="liSelected"><p>Interface Name</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="49.66503349665034%" id="mcps1.4.1.4.1.4.1.3" liSelected="liSelected"><p>IP Address</p>
</th>
</tr>
</thead>
<tbody><tr><td class="cellrowborder" rowspan="2" valign="top" width="13.24867513248675%" headers="mcps1.4.1.4.1.4.1.1 "><p>CE1</p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="37.08629137086292%" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="49.66503349665034%" headers="mcps1.4.1.4.1.4.1.3 "><p>10.1.4.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/2</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.3 "><p>192.168.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" valign="top" width="13.24867513248675%" headers="mcps1.4.1.4.1.4.1.1 "><p>PE1</p>
<p></p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="37.08629137086292%" headers="mcps1.4.1.4.1.4.1.2 "><p>LoopBack0</p>
</td>
<td class="cellrowborder" valign="top" width="49.66503349665034%" headers="mcps1.4.1.4.1.4.1.3 "><p>1.1.1.1/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/2</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.3 "><p>192.168.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/3</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.3 "><p>10.1.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" valign="top" width="13.24867513248675%" headers="mcps1.4.1.4.1.4.1.1 "><p>ASBR1</p>
<p></p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="37.08629137086292%" headers="mcps1.4.1.4.1.4.1.2 "><p>LoopBack0</p>
</td>
<td class="cellrowborder" valign="top" width="49.66503349665034%" headers="mcps1.4.1.4.1.4.1.3 "><p>2.2.2.2/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/1</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.3 "><p>10.1.2.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/3</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.3 "><p>10.1.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" valign="top" width="13.24867513248675%" headers="mcps1.4.1.4.1.4.1.1 "><p>ASBR2</p>
<p></p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="37.08629137086292%" headers="mcps1.4.1.4.1.4.1.2 "><p>LoopBack0</p>
</td>
<td class="cellrowborder" valign="top" width="49.66503349665034%" headers="mcps1.4.1.4.1.4.1.3 "><p>3.3.3.3/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/2</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.3 "><p>10.1.2.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/3</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.3 "><p>10.1.3.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" valign="top" width="13.24867513248675%" headers="mcps1.4.1.4.1.4.1.1 "><p>PE2</p>
<p></p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="37.08629137086292%" headers="mcps1.4.1.4.1.4.1.2 "><p>Loopback1</p>
</td>
<td class="cellrowborder" valign="top" width="49.66503349665034%" headers="mcps1.4.1.4.1.4.1.3 "><p>4.4.4.4/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/2</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.3 "><p>10.1.3.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/3</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.3 "><p>192.168.2.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="2" valign="top" width="13.24867513248675%" headers="mcps1.4.1.4.1.4.1.1 "><p>CE2</p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="37.08629137086292%" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="49.66503349665034%" headers="mcps1.4.1.4.1.4.1.3 "><p>10.1.6.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.2 "><p>GigabitEthernet<span>0/1/3</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.1.4.1.3 "><p>192.168.2.1/24</p>
</td>
</tr>
</tbody>
</table>
</div>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001270153525__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Precautions</h4><p>During the configuration, pay attention to the following:</p>
<ul><li><p>Configure an MP-EBGP peer relationship between the ASBRs in different ASs. Configure an MP-IBGP peer relationship between each PE and ASBR in the same AS.</p>
</li><li><p>The ASBRs do not filter received VPNv4 routes based on VPN targets.</p>
</li></ul>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001270153525__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure an IGP in each AS for interworking among devices in the same AS; set up an MPLS LDP LSP between the ASBR and PE in the same AS.</p>
</li><li><p>Set up an MP-EBGP peer relationship between the ASBRs in different ASs; set up an MP-IBGP peer relationship between the PE and ASBR in the same AS.</p>
</li><li><p>Configure a VPN instance on each PE and bind the interface that connects a PE to a CE to the VPN instance on that PE.</p>
</li><li><p>Enable MPLS on the interfaces that connect the ASBRs, establish an MP-EBGP peer relationship between the ASBRs, and configure the ASBRs not to filter received VPNv4 routes based on VPN targets.</p>
</li><li><p>Configure BGP peers.</p>
</li><li><p>Configure multicast traffic transmission over P2MP tunnels.</p>
</li><li><p>Configure PIM.</p>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001270153525__1.4.4"></a><a name="1.4.4"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li><p>MPLS LSR IDs of PEs and ASBRs (1.1.1.1, 2.2.2.2, 3.3.3.3, and 4.4.4.4)</p>
</li><li><p>VPN instance names (ng), RDs (100:1 and 200:1), and VPN targets of VPN instances (1:1)</p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0000001270153525__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>On the MPLS backbone network in each AS, configure an IGP to interconnect the devices in the same AS.</span><p><p>This example uses OSPF as the IGP. For configuration details, see Configuration Files in this section.</p>
<p>After the configurations are complete, the OSPF neighbor relationship can be established between the devices in the same AS. Run the <strong>display ospf peer</strong> command. The command output shows that the neighbor relationship is in the <strong>Full</strong> state. The devices in the same AS can learn and ping the IP address of each other's loopback interface.</p>
</p></li><li><span>Configure basic MPLS functions and MPLS LDP, and set up LDP LSPs on the MPLS backbone network of each AS.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls lsr-id 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface GigabitEthernet<span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/3</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/3</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/3</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<p>The configuration of PE2 is similar to the configuration of PE1. For configuration details, see Configuration Files in this section.</p>
<p># Configure ASBR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>mpls lsr-id 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1] <strong>interface </strong><strong>GigabitEthernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/1</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/1</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1] <strong>interface GigabitEthernet<span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/3</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/3</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/3</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<p>The configuration of ASBR2 is similar to the configuration of ASBR1. For configuration details, see Configuration Files in this section.</p>
<p>After the configurations are complete, LDP peer relationships can be established between each PE and the corresponding ASBR and between the ASBRs. Run the <strong>display mpls ldp session</strong> command on each <span class="keyword">router</span>. The command output shows that the <strong>Status</strong> field is <strong>Operational</strong>. The command output on PE1 is used as an example.</p>
<pre class="screen">&lt;PE1&gt;<strong> display mpls ldp session</strong></pre>
<pre class="screen"> LDP Session(s) in Public Network
 Codes: LAM(Label Advertisement Mode), SsnAge Unit(DDDD:HH:MM)
 An asterisk (*) before a session means the session is being deleted.
</pre>
<pre class="screen"> -------------------------------------------------------------------------</pre>
<pre class="screen"> PeerID             Status      LAM  SsnRole  SsnAge      KASent/Rcv</pre>
<pre class="screen"> -------------------------------------------------------------------------</pre>
<pre class="screen"> 2.2.2.2          <strong>Operational</strong> DU   Passive  0000:00:01  5/5</pre>
<pre class="screen"> -------------------------------------------------------------------------</pre>
<pre class="screen"> TOTAL: 1 session(s) Found.</pre>
</p></li><li><span>Configure automatic mLDP P2MP tunnels on PEs and ASBRs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-mpls-ldp] <strong>mldp p2mp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls-ldp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-mpls-ldp] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-mpls-ldp] <strong>mldp p2mp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls-ldp] <strong>mldp recursive-fec</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls-ldp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-mpls-ldp] <strong>quit</strong></pre>
<p># Configure ASBR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-mpls-ldp] <strong>mldp p2mp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-mpls-ldp] <strong>mldp recursive-fec</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-mpls-ldp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-mpls-ldp] <strong>quit</strong></pre>
<p>The configuration of ASBR2 is similar to the configuration of ASBR1. For configuration details, see <a href="#EN-US_TASK_0000001270153525__example1680602931214042">Configuration Files</a> in this section.</p>
</p></li><li><span>Configure BGP areas, and set up an MP-IBGP peer relationship between the PE and ASBR in the same AS.</span><p><p># On CE1, configure BGP.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>bgp 65003</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>peer 192.168.1.2 as-number 100</strong></pre>
<p>The configuration of CE2 is similar to the configuration of CE1. For configuration details, see Configuration Files in this section.</p>
<p># On PE1, set up an MP-IBGP peer relationship between the PE and the ASBR in the same AS.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 2.2.2.2 connect-interface loopback 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>quit</strong></pre>
<p># On ASBR1, set up an MP-IBGP peer relationship between it and the PE in the same AS.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp] <strong>peer 1.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp] <strong>peer 1.1.1.1 connect-interface loopback 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp-af-vpnv4] <strong>peer 1.1.1.1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp] <strong>quit</strong></pre>
<p>The configurations of devices in AS200 are similar to the configurations of devices in AS100. For configuration details, see Configuration Files in this section.</p>
<p>After completing the configurations, run the <strong>display bgp vpnv4 all peer</strong> command on the PE or ASBR. The command output shows that an MP-IBGP peer relationship has been established between the PE and ASBR in the same AS. The following example uses the command output on PE1.</p>
<pre class="screen">&lt;PE1&gt; <strong>display bgp vpnv4 all peer</strong>

 BGP local router ID : 1.1.1.1
 Local AS number : 100
 Total number of peers : 1         Peers in established state : 1

  Peer            V          AS  MsgRcvd  MsgSent  OutQ  Up/Down       State  PrefRcv

  2.2.2.2        4         100    18970    19008     0 91:51:24   <strong>Established</strong>    0
</pre>
</p></li><li><span>Configure VPN instances on PEs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance ng</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4] <strong>vpn-target 1:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface GigabitEthernet<span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/2</span>] <strong>ip binding vpn-instance ng</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/2</span>] <strong>ip address 192.168.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance ng</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng-af-ipv4] <strong>route-distinguisher 200:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng-af-ipv4] <strong>vpn-target 1:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface GigabitEthernet<span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/3</span>] <strong>ip binding vpn-instance ng</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/3</span>] <strong>ip address 192.168.2.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/3</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<p>After the configuration is complete, run the <strong>display ip vpn-instance verbose</strong> command on the PEs to check VPN instance configurations.</p>
<pre class="screen">&lt;PE1&gt; <strong>display ip vpn-instance verbose</strong></pre>
<pre class="screen"> Total VPN-Instances configured : 1</pre>
<pre class="screen"> Total IPv4 VPN-Instances configured : 1 
 Total IPv6 VPN-Instances configured : 0</pre>
<pre class="screen"> </pre>
<pre class="screen"> VPN-Instance Name and ID : ng, 1</pre>
<pre class="screen">  Interfaces : GigabitEthernet<span>0/1/2</span></pre>
<pre class="screen"> Address family ipv4 </pre>
<pre class="screen">  Create date : 2017/03/18 11:30:35</pre>
<pre class="screen">  Up time : 0 days, 00 hours, 05 minutes and 19 seconds</pre>
<pre class="screen">  Route Distinguisher : 100:1</pre>
<pre class="screen">  Export VPN Targets :  1:1</pre>
<pre class="screen">  Import VPN Targets :  1:1</pre>
<pre class="screen">  Label policy: label per route</pre>
<pre class="screen">  The diffserv-mode Information is : uniform</pre>
<pre class="screen">  The ttl-mode Information is : pipe</pre>
</p></li><li><span>Set up an MP-EBGP peer relationship between ASBRs across ASs, and disable VPN-target-based filtering on received VPNv4 routes.</span><p><p># On ASBR1, enable MPLS on GigabitEthernet<span>0/1/1</span>, which is connected to ASBR2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>interface GigabitEthernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-GigabitEthernet<span>0/1/1</span>] <strong>ip address 10.1.2.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/1</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/1</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<p># On ASBR2, enable MPLS on GigabitEthernet<span>0/1/2</span>, which is connected to ASBR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2] <strong>interface GigabitEthernet<span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2-GigabitEthernet<span>0/1/2</span>] <strong>ip address 10.1.2.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR2-GigabitEthernet<span>0/1/2</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR2-GigabitEthernet<span>0/1/2</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR2-GigabitEthernet<span>0/1/2</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong></pre>
<p># On ASBR1, establish an MP-EBGP peer relationship with ASBR2, and disable ASBR1 from filtering received VPNv4 routes based on VPN targets.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp] <strong>peer 10.1.2.2 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp-af-vpnv4] <strong>peer 10.1.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp-af-vpnv4] <strong>undo policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp] <strong>quit</strong></pre>
<p># On ASBR2, establish an MP-EBGP peer relationship with ASBR1, and disable ASBR2 from filtering received VPNv4 routes based on VPN targets.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2] <strong>bgp 200</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2-bgp] <strong>peer 10.1.2.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR2-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR2-bgp-af-vpnv4] <strong>peer 10.1.2.1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR2-bgp-af-vpnv4] <strong>undo policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR2-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2-bgp] <strong>quit</strong></pre>
<p>After completing the configurations, run the <strong>display bgp vpnv4 all peer</strong> command. The command output shows that an MP-EBGP peer relationship has been established between the ASBRs. The following example uses the command output on ASBR1.</p>
<pre class="screen">&lt;ASBR1&gt; <strong>display bgp vpnv4 all peer</strong>

 BGP local router ID : 2.2.2.2
 Local AS number : 100
 Total number of peers : 2         Peers in established state : 2

  Peer            V          AS  MsgRcvd  MsgSent  OutQ  Up/Down       State  PrefRcv

  1.1.1.1        4         100    17533    17554     0 127:24:5 Established    1
  3.3.3.3        4         200    12343    34554     0 127:24:5 Established    1</pre>
</p></li><li><span>Configure a unicast peer and a BGP MVPN peer relationship.</span><p><p># Configure CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>bgp 65003</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-bgp] <strong>ipv4-family unicast</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-bgp-af-ipv4] <strong>undo synchronization</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp-af-ipv4] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp-af-ipv4] <strong>peer 192.168.1.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-bgp-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-bgp] <strong>quit</strong></pre>
<p>The configuration of CE2 is similar to the configuration of CE1. For configuration details, see Configuration Files in this section.</p>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>ipv4-family unicast</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-ipv4] <strong>undo synchronization</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-ipv4] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>ipv4-family vpn-instance ng</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-vpn-ng] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpn-ng] <strong>peer 192.168.1.1 as-number 65003</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpn-ng] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-vpn-ng] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>ipv4-family mvpn</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-mvpn] <strong>policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-mvpn] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-mvpn] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>quit</strong></pre>
<p>The configuration of PE2 is similar to the configuration of PE1. For configuration details, see Configuration Files in this section.</p>
<p># Configure ASBR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp] <strong>ipv4-family unicast</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp-af-ipv4] <strong>undo synchronization</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp-af-ipv4] <strong>peer 10.1.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp-af-ipv4] <strong>peer 1.1.1.1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp] <strong>ipv4-family mvpn</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp-af-mvpn] <strong>undo policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp-af-mvpn] <strong>peer 10.1.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp-af-mvpn] <strong>peer 1.1.1.1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ASBR1-bgp-af-mvpn] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp-af-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1-bgp] <strong>quit</strong></pre>
<p>The configuration of ASBR2 is similar to the configuration of ASBR1. For configuration details, see Configuration Files in this section.</p>
</p></li><li><span>Configure MSDP peers on CEs and PEs.</span><p><p># Configure CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>msdp</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-msdp] <strong>peer 192.168.1.2 connect-interface GigabitEthernet<span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-msdp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-msdp] <strong>quit</strong></pre>
<p>The configuration of CE2 is similar to the configuration of CE1. For configuration details, see Configuration Files in this section.</p>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>msdp vpn-instance ng</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-msdp-ng] <strong>peer 192.168.1.1 connect-interface GigabitEthernet<span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-msdp-ng] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-msdp-ng] <strong>quit</strong></pre>
<p>The configuration of PE2 is similar to the configuration of PE1. For configuration details, see Configuration Files in this section.</p>
</p></li><li><span>Configure PEs to use P2MP tunnels to carry multicast traffic.</span><p><p># Configure PE1 as a sender PE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>multicast mvpn 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance ng</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-ng] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-ng-af-ipv4] <strong>multicast routing-enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4] <strong>mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4-mvpn] <strong>sender-enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4-mvpn] <strong>c-multicast signaling bgp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4-mvpn] <strong>spt-only mode</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4-mvpn] <strong>import</strong> <strong>msdp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4-mvpn] <strong>auto-discovery inter-as</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4-mvpn] <strong>ipmsi-tunnel</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4-mvpn-ipmsi] <strong>mldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4-mvpn-ipmsi] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-ng] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-ng] <strong>quit</strong></pre>
<p># Configure PE2 as a receiver PE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>multicast mvpn 4.4.4.4</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance ng</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-ng] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-ng-af-ipv4] <strong>multicast routing-enable</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-ng-af-ipv4] <strong>mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng-af-ipv4-mvpn] <strong>c-multicast signaling bgp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng-af-ipv4-mvpn] <strong>spt-only mode</strong>
[<span class="keyword">*</span>PE2-vpn-instance-ng-af-ipv4-mvpn] <strong>export</strong> <strong>msdp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng-af-ipv4-mvpn] <strong>auto-discovery inter-as</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng-af-ipv4-mvpn] <strong>ipmsi-tunnel</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng-af-ipv4-mvpn-ipmsi] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng-af-ipv4-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-ng] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-ng] <strong>quit</strong></pre>
</p></li><li><span>Configure PIM.</span><p><p># Configure CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>pim</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-pim] <strong>static-rp 192.168.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-pim] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-pim] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>multicast routing-enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1] <strong>interface GigabitEthernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/0</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>interface GigabitEthernet<span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-GigabitEthernet<span>0/1/2</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/2</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong></pre>
<p># Configure CE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>pim</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2-pim] <strong>static-rp 192.168.2.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-pim] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2-pim] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>multicast routing-enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2] <strong>interface GigabitEthernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/0</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/0</span>] <strong>igmp enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>interface GigabitEthernet<span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-GigabitEthernet<span>0/1/3</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/3</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>pim vpn-instance ng</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-pim-ng] <strong>static-rp 192.168.1.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-pim-ng] <strong>source-lifetime 60</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-pim-ng] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-pim-ng] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface GigabitEthernet<span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/1/2</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/2</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong></pre>
<p>The configuration of PE2 is similar to the configuration of PE1. For configuration details, see Configuration Files in this section.</p>
</p></li><li><span>Verify the configuration.</span><p><p>After completing the configurations, CE1 and CE2 can ping each other.</p>
<p>The following example uses the command output on CE1.</p>
<pre class="screen">&lt;CE1&gt; <strong>display ip routing-table</strong></pre>
<pre class="screen"><span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span></pre>
<pre class="screen">------------------------------------------------------------------------------</pre>
<pre class="screen">Routing Tables _public_</pre>
<pre class="screen">         Destinations : 9        Routes : 9</pre>
<pre class="screen">Destination/Mask    Proto  Pre  Cost     Flags NextHop         Interface</pre>
<pre class="screen">       192.168.1.0/24  Direct 0    0           D   192.168.1.1       GigabitEthernet<span>0/1/2</span></pre>
<pre class="screen">       192.168.1.1/32  Direct 0    0           D  127.0.0.1       GigabitEthernet<span>0/1/2</span></pre>
<pre class="screen">     192.168.1.255/32  Direct 0    0           D  127.0.0.1       GigabitEthernet<span>0/1/2</span></pre>
<pre class="screen">      <strong>192.168.2.0/24</strong>  EBGP   255  0           D  192.168.1.2        GigabitEthernet<span>0/1/2</span></pre>
<pre class="screen">      127.0.0.0/8   Direct 0    0           D  127.0.0.1       InLoopBack0</pre>
<pre class="screen">      127.0.0.1/32  Direct 0    0           D  127.0.0.1       InLoopBack0</pre>
<pre class="screen">127.255.255.255/32  Direct 0    0           D  127.0.0.1       InLoopBack0</pre>
<pre class="screen">255.255.255.255/32  Direct 0    0           D  127.0.0.1       InLoopBack0</pre>
<pre class="screen">&lt;CE1&gt; <strong>ping -a 192.168.1.1 192.168.2.1</strong></pre>
<pre class="screen">  PING 192.168.2.1: 56  data bytes, press CTRL_C to break</pre>
<pre class="screen">    Reply from 192.168.2.1: bytes=56 Sequence=1 ttl=252 time=120 ms</pre>
<pre class="screen">    Reply from 192.168.2.1: bytes=56 Sequence=2 ttl=252 time=73 ms</pre>
<pre class="screen">    Reply from 192.168.2.1: bytes=56 Sequence=3 ttl=252 time=111 ms</pre>
<pre class="screen">    Reply from 192.168.2.1: bytes=56 Sequence=4 ttl=252 time=86 ms</pre>
<pre class="screen">    Reply from 192.168.2.1: bytes=56 Sequence=5 ttl=252 time=110 ms</pre>
<pre class="screen">  --- 192.168.2.1 ping statistics ---</pre>
<pre class="screen">    5 packet(s) transmitted</pre>
<pre class="screen">    5 packet(s) received</pre>
<pre class="screen">    0.00% packet loss</pre>
<pre class="screen">    round-trip min/avg/max = 73/100/120 ms </pre>
<p>Run the <strong>display bgp vpnv4 all routing-table</strong> command on ASBRs to see the VPNv4 routes.</p>
<p>The following example uses the command output on ASBR1.</p>
<pre class="screen">&lt;ASBR1&gt;<strong> display bgp vpnv4 all routing-table</strong></pre>
<pre class="screen"> BGP Local router ID is 2.2.2.2
 Status codes: * - valid, &gt; - best, d - damped, x - best external, a - add path,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete
 RPKI validation codes: V - valid, I - invalid, N - not-found


 Total number of routes from all PE: 2
 Route Distinguisher: 100:1


      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *&gt;i  192.168.1.1/32        1.1.1.1       0          100        0      ?
 Route Distinguisher: 200:1


      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *&gt;   192.168.2.1/32       10.1.2.2                             0      200?</pre>
<p>If CE2 has multicast users, CE2 can receive multicast data from CE1.</p>
</p></li></ol></div>
<div class="example" id="EN-US_TASK_0000001270153525__example1680602931214042"><a name="EN-US_TASK_0000001270153525__example1680602931214042"></a><a name="example1680602931214042"></a><a name="EN-US_TASK_0000001270153525__1.4.6"></a><a name="1.4.6"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>CE1 configuration file</p>
<pre class="screen">#
sysname CE1
#
multicast routing-enable
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.4.1 255.255.255.0
 pim sm
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 192.168.1.1 255.255.255.0
 pim sm
#
bgp 65003
 peer 192.168.1.2 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 192.168.1.2 enable
#
pim
 static-rp 192.168.1.1
#
msdp
 peer 192.168.1.2 connect-interface GigabitEthernet<span>0/1/2</span>
#
return</pre>
</li><li><p>PE1 configuration file</p>
<pre class="screen">#
 sysname PE1
#
multicast mvpn 1.1.1.1
#
ip vpn-instance ng
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance 
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
  multicast routing-enable
  mvpn
   sender-enable
   c-multicast signaling bgp
   import msdp
   spt-only mode
   auto-discovery inter-as
   ipmsi-tunnel
    mldp
#
mpls lsr-id 1.1.1.1
#
mpls
#
mpls ldp
 mldp p2mp
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip binding vpn-instance ng
 ip address 192.168.1.2 255.255.255.0
 pim sm
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack0
 ip address 1.1.1.1 255.255.255.255
#
bgp 100
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo synchronization
  peer 2.2.2.2 enable
 #
 ipv4-family mvpn
  policy vpn-target
  peer 2.2.2.2 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 2.2.2.2 enable
 #
 ipv4-family vpn-instance ng
  import-route direct
  peer 192.168.1.1 as-number 65003
#
ospf 1
 area 0.0.0.0
  network 10.1.1.0 0.0.0.255
  network 1.1.1.1 0.0.0.0
#
pim vpn-instance ng
 static-rp 192.168.1.2
 source-lifetime 60
#
msdp vpn-instance ng
 peer 192.168.1.1 connect-interface GigabitEthernet<span>0/1/2</span>
#
return</pre>
</li><li><p>ASBR1 configuration file</p>
<pre class="screen">#
 sysname ASBR1
#
mpls lsr-id 2.2.2.2
#
mpls
#
mpls ldp
 mldp p2mp
 mldp recursive-fec
#
interface GigabitEthernet<span>0/1/1</span> 
 undo shutdown
 ip address 10.1.2.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
 ip address 10.1.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack0
 ip address 2.2.2.2 255.255.255.255
bgp 100
 peer 10.1.2.2 as-number 200
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo synchronization
  peer 10.1.2.2 enable
  peer 1.1.1.1 enable
 #
 ipv4-family mvpn
  undo policy vpn-target
  peer 10.1.2.2 enable
  peer 1.1.1.1 enable
 #
 ipv4-family vpnv4
  undo policy vpn-target
  peer 10.1.2.2 enable
  peer 1.1.1.1 enable
#
ospf 1
 area 0.0.0.0
  network 10.1.1.0 0.0.0.255
  network 2.2.2.2 0.0.0.0
#
ip route-static 3.3.3.3 255.255.255.255 10.1.2.2
#
return</pre>
</li><li><p>ASBR2 configuration file</p>
<pre class="screen">#
 sysname ASBR2
#
mpls lsr-id 3.3.3.3
#
mpls
#
mpls ldp
 mldp p2mp
 mldp recursive-fec
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 10.1.2.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
 ip address 10.1.3.1 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack0
 ip address 3.3.3.3 255.255.255.255
bgp 200
 peer 10.1.2.1 as-number 100
 peer 4.4.4.4 as-number 200
 peer 4.4.4.4 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo synchronization
  peer 10.1.2.1 enable
  peer 4.4.4.4 enable
 #
 ipv4-family mvpn
  undo policy vpn-target
  peer 10.1.2.1 enable
  peer 4.4.4.4 enable
 #
 ipv4-family vpnv4
  undo policy vpn-target
  peer 10.1.2.1 enable
  peer 4.4.4.4 enable
#
ospf 1
 area 0.0.0.0
  network 10.1.3.0 0.0.0.255
  network 3.3.3.3 0.0.0.0
#
ip route-static 2.2.2.2 255.255.255.255 10.1.2.1
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
multicast mvpn 4.4.4.4
#
ip vpn-instance ng
 #
 ipv4-family
  route-distinguisher 200:1
  apply-label per-instance
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
  multicast routing-enable
  mvpn
   c-multicast signaling bgp
   export msdp
   spt-only mode
   auto-discovery inter-as
   ipmsi-tunnel
#
mpls lsr-id 4.4.4.4
#
mpls
#
mpls ldp
 mldp p2mp
 mldp recursive-fec
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 10.1.3.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
 ip binding vpn-instance ng
 ip address 192.168.2.2 255.255.255.0
 pim sm
#
interface LoopBack0
 ip address 4.4.4.4 255.255.255.255
#
bgp 200
 peer 3.3.3.3 as-number 200
 peer 3.3.3.3 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo synchronization
  peer 3.3.3.3 enable
 #
 ipv4-family mvpn
  policy vpn-target
  peer 3.3.3.3 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 3.3.3.3 enable
 #
 ipv4-family vpn-instance ng
  import-route direct
  peer 192.168.2.1 as-number 65004
#
ospf 1
 area 0.0.0.0
  network 10.1.3.0 0.0.0.255
  network 4.4.4.4 0.0.0.0
#
pim vpn-instance ng
 static-rp 192.168.2.2
 source-lifetime 60
#
msdp vpn-instance ng
 peer 192.168.2.1 connect-interface GigabitEthernet<span>0/1/3</span>
#
return</pre>
</li><li><p>CE2 configuration file</p>
<pre class="screen">#
sysname CE2
#
multicast routing-enable
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.6.1 255.255.255.0
 pim sm
 igmp enable
#
interface GigabitEthernet<span>0/1/3</span>
  undo shutdown
 ip address 192.168.2.1 255.255.255.0
 pim sm
#
bgp 65004
 peer 192.168.2.2 as-number 200
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 192.168.2.2 enable
#
pim
 static-rp 192.168.2.1
#
msdp
 peer 192.168.2.2 connect-interface GigabitEthernet<span>0/1/3</span>
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0012.html">Configuration Examples for NG MVPN
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0101.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0074.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>