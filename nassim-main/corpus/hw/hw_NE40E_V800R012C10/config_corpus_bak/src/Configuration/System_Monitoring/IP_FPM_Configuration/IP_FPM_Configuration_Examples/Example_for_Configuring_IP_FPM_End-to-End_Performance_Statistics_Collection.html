
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring IP FPM End-to-End Performance Statistics Collection">
<meta name="abstract" content="This section provides an example for configuring IP FPM end-to-end packet loss and delay measurement on an IP RAN.">
<meta name="description" content="This section provides an example for configuring IP FPM end-to-end packet loss and delay measurement on an IP RAN.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipfpm_cfg_0012.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipfpm_cfg_0014.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00606909">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="IP FPM">
<meta name="featuretype" content="System Monitor">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="IP FPM">
<meta name="featuretype" content="System Monitor">
<meta name="featurename" content="IP FPM">
<meta name="featuretype" content="System Monitor">
<meta name="featurename" content="IP FPM">
<meta name="featuretype" content="System Monitor">
<meta name="OWNER" content="l00425560">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="c00511010">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172372899">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/jquery.min.idp.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/RowOrColfreezeSupport.js"></script>

<script type="text/javascript">
setTimeout(function(){
	jQueryHW(document).ready(function(){
		jQueryHW("table[rowfreeze='yes']").rowfreeze();
		jQueryHW("table[colfreeze='yes']").colfreeze();
	});
},500);
</script>
<title>Example for Configuring IP FPM End-to-End Performance Statistics Collection</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172372899"></a><a name="EN-US_TASK_0172372899"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring IP FPM End-to-End Performance Statistics Collection</h1>
<div class="taskbody"><p>This section provides an example for configuring IP FPM end-to-end packet loss and delay measurement on an IP RAN.</p>
<div class="context"><a name="EN-US_TASK_0172372899__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><div class="p">Various value-added services, such as IPTV, video conferencing, and Voice over Internet Protocol (VoIP) are widely used on networks. As these services rely heavily on high speed and robust networks, link connectivity and network performance are essential to service transmission.<ul><li><p>When voice services are deployed, users will not detect any change in the voice quality if the packet loss rate on links is lower than 5%. If the packet loss rate is higher than 10%, the voice quality will deteriorate significantly.</p>
</li><li><p>Real-time services, such as VoIP, online games, and video conferencing, require a delay lower than 100 ms, or even 50 ms. As the delay increases, user experience worsens.</p>
</li></ul>
To meet higher quality requirements for real-time services, such as VoIP, online gaming, and online video, it is required that the packet loss and delay of links be monitored in real time so that the carrier can promptly respond to service quality deterioration.</div>
<p>The IP RAN shown in <a href="#EN-US_TASK_0172372899__fig_dc_vrp_ipfpm_cfg_001301">Figure 1</a> transmits voice services. Voice flows are symmetrical and bidirectional, and therefore one voice flow can be divided into two unidirectional service flows. The forward service flow enters the network through the UPE, travels across SPE1, and leaves the network through the NPE. The backward service flow enters the network through the NPE, also travels across SPE1, and leaves the network through the UPE.</p>
<p>To meet users' service quality requirements and take measures when service quality deteriorates, configure IP FPM end-to-end performance statistics collection to monitor the packet loss and delay of the links between the UPE and NPE in real time.</p>
<div class="fignone" id="EN-US_TASK_0172372899__fig_dc_vrp_ipfpm_cfg_001301"><a name="EN-US_TASK_0172372899__fig_dc_vrp_ipfpm_cfg_001301"></a><a name="fig_dc_vrp_ipfpm_cfg_001301"></a><span class="figcap"><b>Figure 1 </b>IP FPM end-to-end performance statistics collection</span><br><span><img class="vsd" src="images/fig_dc_vrp_ipfpm_cfg_001301.png" width="NaN" height="NaN"></span></div>

<div class="tableBorder"><a name="EN-US_TASK_0172372899__tab_dc_vrp_ipfpm_cfg_001301"></a><a name="tab_dc_vrp_ipfpm_cfg_001301"></a><table cellpadding="4" cellspacing="0" summary="" rowfreeze="yes" id="EN-US_TASK_0172372899__tab_dc_vrp_ipfpm_cfg_001301" frame="border" border="1" rules="all"><caption><b>Table 1 </b>Interfaces connecting devices and their IP addresses</caption><thead align="left"><tr><th align="left" class="cellrowborder" char="." valign="top" width="18.04819518048195%" id="mcps1.4.1.6.2.6.1.1" liSelected="liSelected"><p>Device (Role)</p>
</th>
<th align="left" class="cellrowborder" char="." valign="top" width="24.997500249975%" id="mcps1.4.1.6.2.6.1.2" liSelected="liSelected"><p>Interface Name</p>
</th>
<th align="left" class="cellrowborder" char="." valign="top" width="24.997500249975%" id="mcps1.4.1.6.2.6.1.3" liSelected="liSelected"><p>Interface</p>
</th>
<th align="left" class="cellrowborder" char="." valign="top" width="16.91830816918308%" id="mcps1.4.1.6.2.6.1.4" liSelected="liSelected"><p>Remote Device (Role)</p>
</th>
<th align="left" class="cellrowborder" char="." valign="top" width="15.038496150384962%" id="mcps1.4.1.6.2.6.1.5" liSelected="liSelected"><p>IP Address</p>
</th>
</tr>
</thead>
<tbody><tr><td class="cellrowborder" rowspan="4" char="." valign="top" width="18.04819518048195%" headers="mcps1.4.1.6.2.6.1.1 "><p>UPE (DCP1/MCP)</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.6.2.6.1.2 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.6.2.6.1.3 "><p>Loopback1</p>
</td>
<td class="cellrowborder" char="." valign="top" width="16.91830816918308%" headers="mcps1.4.1.6.2.6.1.4 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="15.038496150384962%" headers="mcps1.4.1.6.2.6.1.5 "><p>1.1.1.1/32</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface1</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/0</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>eNodeB</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>192.168.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface2</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/1</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>SPE1</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>172.16.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface3</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/2</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>SPE2</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>172.16.2.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="4" char="." valign="top" width="18.04819518048195%" headers="mcps1.4.1.6.2.6.1.1 "><p>SPE1</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.6.2.6.1.2 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.6.2.6.1.3 "><p>Loopback1</p>
</td>
<td class="cellrowborder" char="." valign="top" width="16.91830816918308%" headers="mcps1.4.1.6.2.6.1.4 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="15.038496150384962%" headers="mcps1.4.1.6.2.6.1.5 "><p>2.2.2.2/32</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface1</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/1</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>UPE (DCP1/MCP)</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>172.16.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface2</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/2</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>NPE (DCP2)</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>172.16.4.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface3</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/3</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>SPE2</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>172.16.3.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="4" char="." valign="top" width="18.04819518048195%" headers="mcps1.4.1.6.2.6.1.1 "><p>SPE2</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.6.2.6.1.2 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.6.2.6.1.3 "><p>Loopback1</p>
</td>
<td class="cellrowborder" char="." valign="top" width="16.91830816918308%" headers="mcps1.4.1.6.2.6.1.4 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="15.038496150384962%" headers="mcps1.4.1.6.2.6.1.5 "><p>3.3.3.3/32</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface1</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/1</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>NPE (DCP2)</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>172.16.5.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface2</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/2</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>UPE (DCP1/MCP)</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>172.16.2.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface3</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/3</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>SPE1</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>172.16.3.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="4" char="." valign="top" width="18.04819518048195%" headers="mcps1.4.1.6.2.6.1.1 "><p>NPE (DCP2)</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.6.2.6.1.2 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.6.2.6.1.3 "><p>Loopback1</p>
</td>
<td class="cellrowborder" char="." valign="top" width="16.91830816918308%" headers="mcps1.4.1.6.2.6.1.4 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="15.038496150384962%" headers="mcps1.4.1.6.2.6.1.5 "><p>4.4.4.4/32</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface1</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/1</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>SPE2</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>172.16.5.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface2</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/2</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>SPE1</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>172.16.4.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.2 "><p>interface3</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.3 "><p>GE<span>0/1/3</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.4 "><p>EPC</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.6.2.6.1.5 "><p>192.168.2.1/24</p>
</td>
</tr>
</tbody>
</table>
</div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172372899__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><div class="p">The configuration roadmap is as follows:<ol><li><p>Configure an IP address and a routing protocol for each interface so that all provider edge devices (PEs) can communicate at the network layer. This example uses Open Shortest Path First (OSPF) as the routing protocol.</p>
</li><li><p>Configure MPLS functions and public network tunnels to carry L3VPN services. In this example, RSVP-TE tunnels are established between the UPE and SPEs, and Label Distribution Protocol (LDP) LSPs are established between the SPEs and between the NPE and SPEs.</p>
</li><li><p>Create a VPN instance on the UPE and NPE and import the local direct routes on the UPE and NPE to their respective VPN instance routing tables.</p>
</li><li><p>Establish MP-IBGP peer relationships between the UPE and SPEs and between the NPE and SPEs.</p>
</li><li><p>Configure the SPEs as route reflectors (RRs) and specify the UPE and NPE as RR clients.</p>
</li><li><p>Configure VPN FRR on the UPE and NPE.</p>
</li><li><p>Configure the Network Time Protocol (NTP) to synchronize the clocks of the UPE, SPE1, and the NPE.</p>
</li><li><p>Configure proactive packet loss and delay measurement on the UPE and NPE to collect packet loss and delay statistics at intervals.</p>
</li><li><p>Configure the packet loss and two-way delay alarm thresholds and clear alarm thresholds on the UPE.</p>
</li></ol>
</div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172372899__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><div class="p">To complete the configuration, you need the following data:<ul><li><p>IP address of each interface listed in <a href="#EN-US_TASK_0172372899__tab_dc_vrp_ipfpm_cfg_001301">Table 1</a></p>
</li><li><p>IGP type (OSPF), process ID (1), and area ID (0)</p>
</li><li><p>Label switching router (LSR) IDs of the UPE (1.1.1.1), SPE1 (2.2.2.2), and SPE2 (3.3.3.3)</p>
</li><li><p>Tunnel interface names (Tunnel11), tunnel IDs (20), and tunnel interface addresses (loopback interface addresses) for the unidirectional tunnels between the UPE and SPE1</p>
</li><li><p>Tunnel interface names (Tunnel12), tunnel IDs (200), and tunnel interface addresses (loopback interface addresses) for the unidirectional tunnels between the UPE and SPE2</p>
</li><li><p>Tunnel policy names (policy1) for the tunnels between the UPE and SPEs and tunnel selector names (BindTE) on the SPEs</p>
</li><li><p>Name (vpna), RD (100:1), and VPN targets (1:1) of the VPN instances on the UPE and NPE</p>
</li><li><p>UPE's NTP stratum (1); clock synchronization interval (180s) for the UPE, SPEs, and the NPE; offset (50s) between the clock server and client; maximum polling time (64s)</p>
</li><li><p>UPE's DCP ID and MCP ID (both 1.1.1.1); NPE's MCP ID (4.4.4.4)</p>
</li><li><p>IP FPM instance ID (1) and statistical period (10s)</p>
</li><li><p>Forward target flow's source IP address (10.1.1.1) and destination IP address (10.2.1.1); backward target flow's source IP address (10.2.1.1) and destination IP address (10.1.1.1)</p>
</li><li><p>Measurement points (TLP100 and TLP310)</p>
</li><li><div class="p">Loss and delay measurement flags (respectively the third and fourth bits in the ToS field of the IPv4 packet header)<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Before you deploy IP FPM for packet loss and delay measurement, if two or more bits in the IPv4 packet header have not been planned for other purposes, they can be used for packet loss and delay measurement at the same time. If only one bit in the IPv4 packet header has not been planned, it can be used for either packet loss or delay measurement in one IP FPM instance.</p>
</div></div>
</div>
</li><li><p>Authentication mode (HMAC-SHA256), password (YsHsjx_202206), key ID (1), and UDP port number (2048) on the UPE and NPE.</p>
</li><li><p>Packet loss alarm threshold and its clear alarm threshold (respectively 10% and 5%); two-way delay alarm threshold and its clear alarm threshold (respectively 100 ms and 50 ms)</p>
</li></ul>
</div>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172372899__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure interface IP addresses.</span><p><p>Assign an IP address to each interface according to <a href="#EN-US_TASK_0172372899__tab_dc_vrp_ipfpm_cfg_001301">Table 1</a> and create a loopback interface on each node. For configuration details, see <a href="#EN-US_TASK_0172372899__section_05">Configuration Files</a> in this section.</p>
</p></li><li><span>Configure OSPF.</span><p><p>Configure OSPF on each node to allow the nodes to communicate at the network layer. For detailed configurations, see <a href="#EN-US_TASK_0172372899__section_05">Configuration Files</a> in this section.</p>
</p></li><li><span>Configure basic MPLS functions and public network tunnels.</span><p><ul><li><p>Configure basic MPLS functions and enable MPLS TE, RSVP-TE, and Constraint Shortest Path First (CSPF).</p>
<p># Configure the UPE.</p>
<pre class="screen">&lt;UPE&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>mpls lsr-id 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-mpls] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-mpls] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-mpls] <strong>mpls te cspf</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>interface gigabitethernet <span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/1</span>] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/1</span>] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>interface gigabitethernet <span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/2</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/2</span>] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/2</span>] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-ospf-1] <strong>opaque-capability enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-ospf-1-area-0.0.0.0] <strong>mpls-te enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-ospf-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
<p># Configure SPE1.</p>
<pre class="screen">&lt;SPE1&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE1] <strong>mpls lsr-id 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-mpls] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-mpls] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-mpls] <strong>mpls te cspf</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>interface gigabitethernet <span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-GigabitEthernet<span>0/1/1</span>] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-GigabitEthernet<span>0/1/1</span>] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>interface gigabitethernet <span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-GigabitEthernet<span>0/1/3</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-GigabitEthernet<span>0/1/3</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-ospf-1] <strong>opaque-capability enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-ospf-1-area-0.0.0.0] <strong>mpls-te enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-ospf-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>commit</strong></pre>
<p># Configure SPE2.</p>
<pre class="screen">&lt;SPE2&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE2] <strong>mpls lsr-id 3.3.3.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-mpls] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-mpls] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-mpls] <strong>mpls te cspf</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2] <strong>interface gigabitethernet <span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-GigabitEthernet<span>0/1/2</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-GigabitEthernet<span>0/1/2</span>] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-GigabitEthernet<span>0/1/2</span>] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2] <strong>interface gigabitethernet <span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-GigabitEthernet<span>0/1/3</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-GigabitEthernet<span>0/1/3</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-ospf-1] <strong>opaque-capability enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-ospf-1-area-0.0.0.0] <strong>mpls-te enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-ospf-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2] <strong>commit</strong></pre>
<p># Configure NPE.</p>
<pre class="screen">&lt;NPE&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE] <strong>mpls lsr-id 4.4.4.4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE] <strong>interface gigabitethernet <span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-GigabitEthernet<span>0/1/1</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE] <strong>interface gigabitethernet <span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-GigabitEthernet<span>0/1/2</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-GigabitEthernet<span>0/1/2</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE] <strong>commit</strong></pre>
</li><li><p>Enable the egress of each unidirectional tunnel to be created to assign a non-null label to the penultimate hop.</p>
<div class="p"># Configure the UPE.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-mpls] <strong>label advertise non-null</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
</div>
<div class="p"># Configure SPE1.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-mpls] <strong>label advertise non-null</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>commit</strong></pre>
</div>
<div class="p"># Configure SPE2.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-mpls] <strong>label advertise non-null</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2] <strong>commit</strong></pre>
</div>
</li><li><p>Configure MPLS TE tunnel interfaces.</p>
<p># Configure the UPE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>interface Tunnel 11</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel11] <strong>ip address unnumbered interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel11] <strong>tunnel-protocol mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel11] <strong>destination 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel11] <strong>mpls te tunnel-id 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel11] <strong>mpls te signal-protocol rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel11] <strong>mpls te reserved-for-binding</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel11] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>interface Tunnel 12</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel12] <strong>ip address unnumbered interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel12] <strong>tunnel-protocol mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel12] <strong>destination 3.3.3.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel12] <strong>mpls te tunnel-id 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel12] <strong>mpls te signal-protocol rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel12] <strong>mpls te reserved-for-binding</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-Tunnel12] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
<p># Configure SPE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE1] <strong>interface Tunnel 11</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-Tunnel11] <strong>ip address unnumbered interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-Tunnel11] <strong>tunnel-protocol mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-Tunnel11] <strong>destination 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-Tunnel11] <strong>mpls te tunnel-id 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-Tunnel11] <strong>mpls te signal-protocol rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-Tunnel11] <strong>mpls te reserved-for-binding</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-Tunnel11] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>commit</strong></pre>
<p># Configure SPE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE2] <strong>interface Tunnel 12</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-Tunnel12] <strong>ip address unnumbered interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-Tunnel12] <strong>tunnel-protocol mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-Tunnel12] <strong>destination 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-Tunnel12] <strong>mpls te tunnel-id 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-Tunnel12] <strong>mpls te signal-protocol rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-Tunnel12] <strong>mpls te reserved-for-binding</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-Tunnel12] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2] <strong>commit</strong></pre>
</li><li><p>Configure tunnel policies.</p>
<p># Configure the UPE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>tunnel-policy policy1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-tunnel-policy-policy1] <strong>tunnel binding destination 2.2.2.2 te Tunnel 11</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-tunnel-policy-policy1] <strong>tunnel binding destination 3.3.3.3 te Tunnel 12</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-tunnel-policy-policy1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
<p># Configure SPE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE1] <strong>tunnel-policy policy1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-tunnel-policy-policy1] <strong>tunnel binding destination 1.1.1.1 te Tunnel 11</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-tunnel-policy-policy1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>commit</strong></pre>
<p># Configure SPE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE2] <strong>tunnel-policy policy1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-tunnel-policy-policy1] <strong>tunnel binding destination 1.1.1.1 te Tunnel 12</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2-tunnel-policy-policy1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE2] <strong>commit</strong></pre>
</li></ul>
</p></li><li><span>Create a VPN instance on the UPE and NPE and import the local direct routes on the UPE and NPE to their respective VPN instance routing tables.</span><p><p># Configure the UPE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-vpn-instance-vpna-af-ipv4] <strong>vpn-target 1:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE]<strong> interface gigabitethernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/0</span>] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/0</span>] <strong>ip address 192.168.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp]<strong> ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp-vpna] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
<p># Configure the NPE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-vpn-instance-vpna-af-ipv4] <strong>vpn-target 1:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE]<strong> interface gigabitethernet <span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-GigabitEthernet<span>0/1/3</span>] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-GigabitEthernet<span>0/1/3</span>] <strong>ip address 192.168.2.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp]<strong> ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp-vpna]<strong> import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE] <strong>commit</strong></pre>
</p></li><li><span>Establish MP-IBGP peer relationships between the UPE and SPEs and between the NPE and SPEs.</span><p><p># Configure the UPE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp] <strong>router-id 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp]<strong> peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp]<strong> peer 2.2.2.2 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp]<strong> peer 3.3.3.3 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp]<strong> peer 3.3.3.3 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp]<strong> ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp-af-vpnv4]<strong> peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp-af-vpnv4]<strong> peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp-af-vpnv4]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE]<strong> commit</strong></pre>
<p># Configure SPE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE1]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp] <strong>router-id 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp]<strong> peer 1.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp]<strong> peer 1.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp]<strong> peer 3.3.3.3 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp]<strong> peer 3.3.3.3 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp]<strong> peer 4.4.4.4 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp]<strong> peer 4.4.4.4 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp]<strong> ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4]<strong> undo policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4]<strong> peer 1.1.1.1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4]<strong> peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4]<strong> peer 4.4.4.4 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1]<strong> commit</strong></pre>
<p>The configuration of SPE2 is similar to the configuration of SPE1. For configuration details, see <a href="#EN-US_TASK_0172372899__section_05">Configuration Files</a> in this section.</p>
<p># Configure the NPE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp] <strong>router-id 4.4.4.4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp]<strong> peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp]<strong> peer 2.2.2.2 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp]<strong> peer 3.3.3.3 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp]<strong> peer 3.3.3.3 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp]<strong> ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp-af-vpnv4]<strong> peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp-af-vpnv4]<strong> peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp-af-vpnv4]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-bgp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE]<strong> commit</strong></pre>
</p></li><li><span>Configure SPEs as RRs and specify UPEs and NPEs as RR clients. This step uses SPE1 as an example.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE1]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp]<strong> ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4]<strong> peer 1.1.1.1 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4]<strong> peer 1.1.1.1 next-hop-local</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4]<strong> peer 4.4.4.4 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4]<strong> peer 4.4.4.4 next-hop-local</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1]<strong> commit</strong></pre>
<p>The configuration of SPE2 is similar to the configuration of SPE1. For configuration details, see <a href="#EN-US_TASK_0172372899__section_05">Configuration Files</a> in this section.</p>
</p></li><li><span>Apply the tunnel policy on the UPE and configure a tunnel selector on each SPE because SPEs do not have VPN instances, so that the UPE and SPEs use RSVP-TE tunnels to transmit traffic.</span><p><p># Apply the tunnel policy on the UPE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-vpn-instance-vpna-af-ipv4] <strong>tnl-policy policy1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
<p># Configure a tunnel selector on SPE1 to use TE tunnels to transmit traffic.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE1] <strong>tunnel-selector bindTE permit node 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-tunnel-selector] <strong>apply tunnel-policy policy1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-tunnel-selector] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4] <strong>tunnel-selector bindTE</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>commit</strong></pre>
<p>The configuration of SPE2 is similar to the configuration of SPE1. For configuration details, see <a href="#EN-US_TASK_0172372899__section_05">Configuration Files</a> in this section.</p>
</p></li><li><span>Configure VPN FRR on the UPE and NPE.</span><p><p># Configure the UPE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp-vpna] <strong>auto-frr</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
</p><p><div class="p">After completing the configurations, run the <a href="cmdqueryname=display+bgp+vpnv4+vpn-instance+vpna+routing-table"><b><span class="cmdname">display bgp vpnv4 vpn-instance vpna routing-table</span></b></a> command on the UPE and NPE to view detailed information about received routes.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>display bgp vpnv4 vpn-instance vpna routing-table</strong></pre>
<pre class="screen"> BGP Local router ID is 1.1.1.1
 Status codes: * - valid, &gt; - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete
<span> RPKI validation codes: V - valid, I - invalid, N - not-found</span>


 VPN-Instance vpna, Router ID 1.1.1.1:

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *&gt;   192.168.1.0/24       0.0.0.0         0                     0      ?
 *&gt;   192.168.1.1/32       0.0.0.0         0                     0      ?
 *&gt;i  192.168.2.0/24       2.2.2.2        0           100        0      ?
 * i                       3.3.3.3         0          100        0      ? </pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE] <strong>display bgp vpnv4 vpn-instance vpna routing-table</strong></pre>
<pre class="screen"> BGP Local router ID is 4.4.4.4
 Status codes: * - valid, &gt; - best, d - damped,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete
<span> RPKI validation codes: V - valid, I - invalid, N - not-found</span>


 VPN-Instance vpna, Router ID 4.4.4.4:

 Total Number of Routes: 4
      Network            NextHop        MED        LocPrf    PrefVal Path/Ogn

 *&gt;i  192.168.1.0/24       2.2.2.2        0           100        0      ?
 * i                       3.3.3.3         0          100        0      ?
 *&gt;   192.168.2.0/24       0.0.0.0         0                     0      ?
 *&gt;   192.168.2.1/32       0.0.0.0         0                     0      ?</pre>
</div>
<p>The command output shows that the UPE and NPE both preferentially select the routes advertised by SPE1 and use UPE-SPE1-NPE as the primary path.</p>
</p></li><li><span>Configure NTP to synchronize the clocks of the UPE, SPE1, and the NPE.</span><p><div class="p"># Configure the UPE.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>ntp-service sync-interval 180</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>ntp-service refclock-master 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
</div>
<div class="p"># Configure SPE1.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE1] <strong>ntp-service sync-interval 180</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>ntp-service unicast-server 172.16.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>SPE1] <strong>commit</strong></pre>
</div>
<div class="p"># Configure the NPE.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE] <strong>ntp-service sync-interval 180</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE] <strong>ntp-service unicast-server 172.16.4.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE] <strong>commit</strong></pre>
</div>
<p>After completing the configurations, run the <a href="cmdqueryname=display+ntp-service+status"><b><span class="cmdname">display ntp-service status</span></b></a> command on the UPE, SPE1, and NPE to view information about clock synchronization.</p>
<div class="p">Check the NTP status on the UPE. The command output shows that the clock status is <strong>synchronized</strong>, meaning that synchronization is complete.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>display ntp-service status</strong></pre>
<pre class="screen"> clock status: synchronized
 clock stratum: 1
 reference clock ID: LOCAL(0)
 nominal frequency: 64.0000 Hz
 actual frequency: 64.0000 Hz
 clock precision: 2^7
 clock offset: 0.0000 ms
 root delay: 0.00 ms
 root dispersion: 26.49 ms
 peer dispersion: 10.00 ms
 reference time: 08:55:35.000 UTC Apr 2 2013(D5051B87.0020C49B)
 synchronization state: clock synchronized</pre>
</div>
<div class="p">Run the <strong>display ntp-service status</strong> command on SPE1 to check its NTP status. The command output shows that the clock status is synchronized and the clock stratum is 2, which is one stratum lower than that of the UPE.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>SPE1] <strong>display ntp-service status</strong></pre>
<pre class="screen"> clock status: synchronized
 clock stratum: 2
 reference clock ID: 172.16.1.1
 nominal frequency: 64.0000 Hz
 actual frequency: 64.0000 Hz
 clock precision: 2^7
 clock offset: -0.0099 ms
 root delay: 0.08 ms
 root dispersion: 51.00 ms
 peer dispersion: 34.30 ms
 reference time: 08:56:45.000 UTC Apr 2 2013(D5051BCD.00346DC5)
 synchronization state: clock synchronized</pre>
</div>
<div class="p">Run the <strong>display ntp-service status</strong> command on the NPE to check its NTP status. The command output shows that the clock status is <strong>synchronized</strong> and the clock stratum is 3, which is one stratum lower than that of SPE1.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE] <strong>display ntp-service status</strong></pre>
<pre class="screen"> clock status: synchronized
 clock stratum: 3
 reference clock ID: 172.16.4.1
 nominal frequency: 64.0000 Hz
 actual frequency: 64.0000 Hz
 clock precision: 2^7
 clock offset: -0.0192 ms
 root delay: 0.18 ms
 root dispersion: 201.41 ms
 peer dispersion: 58.64 ms
 reference time: 08:56:47.000 UTC Apr 2 2013(D5051BCF.001E2584)
 synchronization state: clock synchronized</pre>
</div>
</p></li><li><span>Configure proactive packet loss and delay measurement on the UPE and NPE; configure the UPE as the MCP and also a DCP and configure TLP310 on the UPE; configure the NPE as a DCP and configure TLP100 on the NPE.</span><p><div class="p"># Configure the UPE.<ul><li><div class="p">Configure the MCP.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>nqa ipfpm mcp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp] <strong>mcp id 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp] <strong>protocol udp port 2048</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp] <strong>authentication-mode hmac-sha256 key-id 1 cipher YsHsjx_202206</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp] <strong>instance 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp-instance-1] <strong>dcp 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp-instance-1] <strong>dcp 4.4.4.4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp-instance-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
</div>
<div class="p">After completing the configuration, run the <a href="cmdqueryname=display+ipfpm+mcp"><b><span class="cmdname">display ipfpm mcp</span></b></a> command on the UPE. The command output shows MCP configurations on the UPE.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>display ipfpm mcp</strong></pre>
<pre class="screen">Specification Information:
 Max Instance Number                       :64
 Max DCP Number Per Instance               :256
 Max ACH Number Per Instance               :16
 Max TLP Number Per ACH                    :16

Configuration Information:
 MCP ID                                    :1.1.1.1
 Status                                    :Active
 Protocol Port                             :2048
 Current Instance Number                   :1 </pre>
</div>
</li><li><div class="p">Configure a DCP.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>nqa ipfpm dcp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp] <strong>dcp id 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp] <strong>authentication-mode hmac-sha256 key-id 1 cipher YsHsjx_202206</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp] <strong>color-flag loss-measure tos-bit 3 delay-measure tos-bit 4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp] <strong>mcp 1.1.1.1 port 2048</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp] <strong>instance 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp-instance-1] <strong>interval 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp-instance-1] <strong>flow bidirectional source 10.1.1.1 destination 10.2.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp-instance-1] <strong>tlp 100 in-point ingress</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp-instance-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
</div>
<div class="p">After completing the configuration, run the <a href="cmdqueryname=display+ipfpm+dcp"><b><span class="cmdname">display ipfpm dcp</span></b></a> command on the UPE. The command output shows DCP configurations on the UPE.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>display ipfpm dcp</strong></pre>
<pre class="screen">Specification Information(Main Board):
 Max Instance Number                       :64
 Max 10s Instance Number                   :64
 Max 1s Instance Number                    :--
 Max TLP Number                            :512
 Max TLP Number Per Instance               :8

Configuration Information:
 DCP ID                                    : 1.1.1.1
 Loss-measure Flag                         : tos-bit3
 Delay-measure Flag                        : tos-bit4
 
 Authentication Mode                       : hmac-sha256
 Test Instances MCP ID                     : 1.1.1.1
 Test Instances MCP Port                   : 2048
 Current Instance Number                   : 1 </pre>
</div>
</li><li><div class="p">Bind the TLP to an interface.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>interface GigabitEthernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE-GigabitEthernet<span>0/1/0</span>] <strong>ipfpm tlp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
</div>
</li><li><div class="p">Enable packet loss and delay measurement.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>nqa ipfpm dcp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp] <strong>instance 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp-instance-1] <strong>loss-measure enable continual</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp-instance-1] <strong>delay-measure enable two-way tlp 100 continual</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp-instance-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-dcp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE] <strong>commit</strong></pre>
</div>
</li></ul>
</div>
<div class="p"># Configure the NPE.<ul><li><div class="p">Configure a DCP.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE] <strong>nqa ipfpm dcp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp] <strong>dcp id 4.4.4.4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp] <strong>authentication-mode hmac-sha256 key-id 1 cipher YsHsjx_202206</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp] <strong>color-flag loss-measure tos-bit 3 delay-measure tos-bit 4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp] <strong>mcp 1.1.1.1 port 2048</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp] <strong>instance 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp-instance-1] <strong>interval 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp-instance-1] <strong>flow bidirectional source 10.1.1.1 destination 10.2.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp-instance-1] <strong>tlp 310 out-point egress</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp-instance-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE] <strong>commit</strong></pre>
</div>
<div class="p">After completing the configuration, run the <a href="cmdqueryname=display+ipfpm+dcp"><b><span class="cmdname">display ipfpm dcp</span></b></a> command on the NPE. The command output shows DCP configurations on the NPE.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE] <strong>display ipfpm dcp</strong></pre>
<pre class="screen">Specification Information(Main Board):
 Max Instance Number                       :64
 Max 10s Instance Number                   :64
 Max 1s Instance Number                    :--
 Max TLP Number                            :512
 Max TLP Number Per Instance               :8

Configuration Information:
 DCP ID                                    : 4.4.4.4
 Loss-measure Flag                         : tos-bit3
 Delay-measure Flag                        : tos-bit4
 
 Authentication Mode                       : hmac-sha256
 Test Instances MCP ID                     : 1.1.1.1
 Test Instances MCP Port                   : 2048
 Current Instance Number                   : 1</pre>
</div>
</li><li><div class="p">Bind the TLP to an interface.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE] <strong>interface GigabitEthernet<span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE-GigabitEthernet<span>0/1/3</span>] <strong>ipfpm tlp 310</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE] <strong>commit</strong></pre>
</div>
</li><li><div class="p">Enable proactive packet loss and delay measurement.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE] <strong>nqa ipfpm dcp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp] <strong>instance 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp-instance-1] <strong>loss-measure enable continual</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp-instance-1] <strong>delay-measure enable two-way tlp 310 continual</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-nqa-ipfpm-dcp-instance-1] <strong>commit</strong></pre>
</div>
</li></ul>
</div>
</p></li><li><span>Configure alarm thresholds and clear alarm thresholds for IP FPM performance counters on the UPE.</span><p><div class="p"># Configure the packet loss alarm threshold and its clear alarm threshold.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>nqa ipfpm mcp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp] <strong>instance 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp-instance-1] <strong>loss-measure ratio-threshold upper-limit 10 lower-limit 5</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp-instance-1] <strong>commit</strong></pre>
</div>
<div class="p"># Configure the two-way delay alarm threshold and its clear alarm threshold.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE-nqa-ipfpm-mcp-instance-1] <strong>delay-measure two-way delay-threshold upper-limit 100000 lower-limit 50000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-nqa-ipfpm-mcp-instance-1] <strong>commit</strong></pre>
</div>
</p></li><li><span>Verify the configuration.</span><p><div class="p">Run the <a href="cmdqueryname=display+ipfpm+statistic-type"><b><span class="cmdname">display ipfpm statistic-type</span></b></a> { <strong><span>loss</span></strong> | <strong><span>twoway-delay</span></strong> } <strong><span>instance</span></strong> <i><span class="varname">instance-id</span></i> command on the UPE to check the performance statistics for a specified IP FPM instance.<ul><li><p># The following example uses the packet loss statistics for IP FPM instance 1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>display ipfpm statistic-type loss instance 1</strong></pre>
<pre class="screen">Latest loss statistics of forward flow:
Unit: p - packet, b - byte      
------------------------------------------------------------------------------------------ 
 Period               Loss(p)              LossRatio(p)  Loss(b)              LossRatio(b) 
------------------------------------------------------------------------------------------ 
 136118757            20                      20.000000% 2000                   20.000000%
 136118756            20                      20.000000% 2000                   20.000000%
 136118755            20                      20.000000% 2000                   20.000000%
 136118753            20                      20.000000% 2000                   20.000000%
 136118752            20                      20.000000% 2000                   20.000000%
 136118751            20                      20.000000% 2000                   20.000000%
 136118750            20                      20.000000% 2000                   20.000000%
 136118749            20                      20.000000% 2000                   20.000000%
 136118748            20                      20.000000% 2000                   20.000000%
 136118747            20                      20.000000% 2000                   20.000000%
 136118746            20                      20.000000% 2000                   20.000000%
 136118745            20                      20.000000% 2000                   20.000000%

Latest loss statistics of backward flow:
Unit: p - packet, b - byte      
------------------------------------------------------------------------------------------ 
 Period               Loss(p)              LossRatio(p)  Loss(b)              LossRatio(b) 
------------------------------------------------------------------------------------------ 
 136118757            20                      20.000000% 2000                   20.000000%
 136118756            20                      20.000000% 2000                   20.000000%
 136118755            20                      20.000000% 2000                   20.000000%
 136118753            20                      20.000000% 2000                   20.000000%
 136118752            20                      20.000000% 2000                   20.000000%
 136118751            20                      20.000000% 2000                   20.000000%
 136118750            20                      20.000000% 2000                   20.000000%
 136118749            20                      20.000000% 2000                   20.000000%
 136118748            20                      20.000000% 2000                   20.000000%
 136118747            20                      20.000000% 2000                   20.000000%
 136118746            20                      20.000000% 2000                   20.000000%
 136118745            20                      20.000000% 2000                   20.000000%</pre>
</li><li># The following example uses the two-way delay statistics for IP FPM instance 1.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>display ipfpm statistic-type twoway-delay instance 1</strong></pre>
<pre class="screen">Latest two-way delay statistics:
--------------------------------------------------
 Period               Delay(usec) Delay
                                  Variation(usec)
--------------------------------------------------
 136118757            800         0
 136118756            800         0
 136118755            800         0
 136118753            800         0
 136118752            800         0
 136118751            800         0
 136118750            800         0
 136118749            800         0
 136118748            800         0
 136118747            800         0
 136118746            800         0
 136118745            800         0

Latest one-way delay statistics of bidirectional flow:
--------------------------------------------------------------------------------
 Period               Forward     ForwardDelay    Backward    BackwardDelay     
                      Delay(usec) Variation(usec) Delay(usec) Variation(usec)   
--------------------------------------------------------------------------------
 136118757            400         0               400         0
 136118756            400         0               400         0
 136118755            400         0               400         0
 136118753            400         0               400         0
 136118752            400         0               400         0
 136118751            400         0               400         0
 136118750            400         0               400         0
 136118749            400         0               400         0
 136118748            400         0               400         0
 136118747            400         0               400         0
 136118746            400         0               400         0
 136118745            400         0               400         0</pre>
</li></ul>
</div>
</p></li></ol></div>
<div class="example" id="EN-US_TASK_0172372899__section_05"><a name="EN-US_TASK_0172372899__section_05"></a><a name="section_05"></a><a name="EN-US_TASK_0172372899__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>UPE configuration file</p>
<pre class="screen">#    
sysname UPE         
#               
ip vpn-instance vpna          
 ipv4-family    
  route-distinguisher 100:1
  apply-label per-instance     
  tnl-policy policy1                  
  vpn-target 1:1 export-extcommunity                                            
  vpn-target 1:1 import-extcommunity                                            
#                                                                               
mpls lsr-id 1.1.1.1                                                             
mpls                                                                            
 mpls te                                                                        
 label advertise non-null                                                       
 mpls rsvp-te                                                                   
 mpls te cspf                                                                   
#                                                                               
ntp-service sync-interval 180
ntp-service refclock-master 1                                                   
#                                                                               
interface GigabitEthernet<span>0/1/0</span>        
 undo shutdown                                                                  
 ip binding vpn-instance vpna                                                   
 ip address 192.168.1.1 255.255.255.0                                             
 ipfpm tlp 100                                                                 
#                                                                               
interface GigabitEthernet<span>0/1/1</span>                                                  
 undo shutdown                                                                  
 ip address 172.16.1.1 255.255.255.0                                             
 mpls                                                                           
 mpls te                                                                        
 mpls rsvp-te                                                                   
#                                                                               
interface GigabitEthernet<span>0/1/2</span>                                                 
 undo shutdown                                                                  
 ip address 172.16.2.1 255.255.255.0                                             
 mpls                                                                           
 mpls te                                                                        
 mpls rsvp-te                                                                   
#                                                                               
interface LoopBack1                                                             
 ip address 1.1.1.1 255.255.255.255                                             
#                                                                               
interface Tunnel11                                                           
 ip address unnumbered interface LoopBack1                                      
 tunnel-protocol mpls te                                                        
 destination 2.2.2.2                                                            
 mpls te tunnel-id 100                                                          
 mpls te reserved-for-binding                                                   
#                                                                               
interface Tunnel12                                                           
 ip address unnumbered interface LoopBack1                                      
 tunnel-protocol mpls te                                                        
 destination 3.3.3.3                                                            
 mpls te tunnel-id 200                                                          
 mpls te reserved-for-binding                                                   
#                                                                               
bgp 100                                                                         
 router-id 1.1.1.1                                                              
 peer 2.2.2.2 as-number 100                                                     
 peer 2.2.2.2 connect-interface LoopBack1                                       
 peer 3.3.3.3 as-number 100                                                     
 peer 3.3.3.3 connect-interface LoopBack1                                       
 #                                                                              
 ipv4-family unicast                                                            
  undo synchronization
  peer 2.2.2.2 enable                                                           
  peer 3.3.3.3 enable                                                           
 #                                                                              
 ipv4-family vpnv4                                                              
  policy vpn-target                                                             
  peer 2.2.2.2 enable                                                           
  peer 3.3.3.3 enable                                                           
 #                                                                              
 ipv4-family vpn-instance vpna                                                  
  import-route direct                                                           
  auto-frr                                                                      
#                                                                               
ospf 1                                                                          
 opaque-capability enable                                                       
 area 0.0.0.0                                                                   
  network 1.1.1.1 0.0.0.0                                                       
  network 172.16.1.0 0.0.0.255                                                   
  network 172.16.2.0 0.0.0.255                                                   
  mpls-te enable                                                                
#                                                                               
tunnel-policy policy1                                                           
 tunnel binding destination 2.2.2.2 te Tunnel11                              
 tunnel binding destination 3.3.3.3 te Tunnel12                             
#                                                                               
nqa ipfpm dcp                                                                   
 dcp id 1.1.1.1                                                                 
 mcp 1.1.1.1 port 2048                                                          
 authentication-mode hmac-sha256 key-id 1 cipher <span>#%#%c^)+6\&amp;Xmec@('3&amp;m,d%1C,d%1C&lt;#%#%</span>
 color-flag loss-measure tos-bit 3 delay-measure tos-bit 4
 instance 1
  flow bidirectional source 10.1.1.1 destination 10.2.1.1
  tlp 100 in-point ingress
  loss-measure enable continual
  delay-measure enable two-way tlp 100 continual
#                                                                               
nqa ipfpm mcp                                                                   
 mcp id 1.1.1.1                                                                 
 protocol udp port 2048                                                         
 authentication-mode hmac-sha256 key-id 1 cipher <span>#%#%\8u;Ufa-'-+mtJG0r#:00dV[#%#%</span> 
 instance 1                                                                     
  dcp 1.1.1.1                                                                   
  dcp 4.4.4.4                                                                   
  loss-measure ratio-threshold upper-limit 10.000000 lower-limit 5.000000       
  delay-measure two-way delay-threshold upper-limit 100000 lower-limit 50000    
#                                                                               
return </pre>
</li><li><p>SPE1 configuration file</p>
<pre class="screen">#                                                                               
sysname SPE1                                                                 
#                                                                               
tunnel-selector bindTE permit node 10                                           
 apply tunnel-policy policy1                                                    
#                                                                               
mpls lsr-id 2.2.2.2                                                             
mpls                                                                            
 mpls te                                                                        
 label advertise non-null                                                       
 mpls rsvp-te                                                                   
 mpls te cspf                                                                   
#                                                                               
mpls ldp                                                                        
#                                                                               
ntp-service sync-interval 180
ntp-service unicast-server 172.16.1.1                                            
#                                                                               
interface GigabitEthernet<span>0/1/1</span>                                                  
 undo shutdown                                                                  
 ip address 172.16.1.2 255.255.255.0                                             
 mpls                                                                           
 mpls te                                                                        
 mpls rsvp-te                                                                   
#                                                                               
interface GigabitEthernet<span>0/1/2</span>                                                  
 undo shutdown                                                                  
 ip address 172.16.4.1 255.255.255.0                                             
 mpls                                                                           
 mpls ldp                                                                       
#                                                                               
interface GigabitEthernet<span>0/1/3</span>                                                  
 undo shutdown                                                                  
 ip address 172.16.3.1 255.255.255.0                                             
 mpls                                                                           
 mpls ldp                                                                       
#                                                                               
interface LoopBack1                                                             
 ip address 2.2.2.2 255.255.255.255                                                 
#                                                                               
interface Tunnel11                                                           
 ip address unnumbered interface LoopBack1                                      
 tunnel-protocol mpls te                                                        
 destination 1.1.1.1                                                            
 mpls te tunnel-id 100                                                          
 mpls te reserved-for-binding                                                   
#                                                                               
bgp 100                                                                         
 router-id 2.2.2.2                                                              
 peer 1.1.1.1 as-number 100                                                     
 peer 1.1.1.1 connect-interface LoopBack1                                       
 peer 3.3.3.3 as-number 100                                                     
 peer 3.3.3.3 connect-interface LoopBack1                                       
 peer 4.4.4.4 as-number 100                                                     
 peer 4.4.4.4 connect-interface LoopBack1                                       
 #                                                                              
 ipv4-family unicast                                                            
  undo synchronization
  peer 1.1.1.1 enable                                                           
  peer 3.3.3.3 enable                                                           
  peer 4.4.4.4 enable                                                           
 #                                                                              
 ipv4-family vpnv4                                                              
  undo policy vpn-target                                                        
  tunnel-selector bindTE                                                        
  peer 1.1.1.1 enable                                                           
  peer 1.1.1.1 reflect-client                                                   
  peer 1.1.1.1 next-hop-local                                                   
  peer 3.3.3.3 enable                                                           
  peer 4.4.4.4 enable                                                           
  peer 4.4.4.4 reflect-client                                                   
  peer 4.4.4.4 next-hop-local                                                   
#                                                                               
ospf 1                                                                          
 opaque-capability enable                                                       
 area 0.0.0.0                                                                   
  network 2.2.2.2 0.0.0.0                                                       
  network 172.16.1.0 0.0.0.255                                                   
  network 172.16.3.0 0.0.0.255                                                   
  network 172.16.4.0 0.0.0.255                                                   
  mpls-te enable                                                                
#                                                                               
tunnel-policy policy1                                                           
 tunnel binding destination 1.1.1.1 te Tunnel11                              
# 
return</pre>
</li><li><p>SPE2 configuration file</p>
<pre class="screen">#
sysname SPE2
#
tunnel-selector bindTE permit node 10
 apply tunnel-policy policy1
#
mpls lsr-id 3.3.3.3
mpls
 mpls te
 label advertise non-null
 mpls rsvp-te
 mpls te cspf
#
mpls ldp
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 172.16.5.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 172.16.2.2 255.255.255.0
 mpls
 mpls te
 mpls rsvp-te
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
 ip address 172.16.3.2 255.255.255.0
 mpls
 mpls te
 mpls ldp
#
interface LoopBack1
 ip address 3.3.3.3 255.255.255.255
#
interface Tunnel12
 ip address unnumbered interface LoopBack1
 tunnel-protocol mpls te
 destination 1.1.1.1
 mpls te tunnel-id 200
 mpls te reserved-for-binding
#
bgp 100
 router-id 3.3.3.3
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack1
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack1
 peer 4.4.4.4 as-number 100
 peer 4.4.4.4 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.1 enable
  peer 2.2.2.2 enable
  peer 4.4.4.4 enable
 #
 ipv4-family vpnv4
  undo policy vpn-target
  tunnel-selector bindTE
  peer 1.1.1.1 enable
  peer 1.1.1.1 reflect-client
  peer 1.1.1.1 next-hop-local
  peer 2.2.2.2 enable
  peer 4.4.4.4 enable
  peer 4.4.4.4 reflect-client
  peer 4.4.4.4 next-hop-local
#
ospf 1
 opaque-capability enable
 area 0.0.0.0
  network 3.3.3.3 0.0.0.0
  network 172.16.2.0 0.0.0.255
  network 172.16.3.0 0.0.0.255
  network 172.16.5.0 0.0.0.255
  mpls-te enable
#
tunnel-policy policy1
 tunnel binding destination 1.1.1.1 te Tunnel12
#
return</pre>
</li><li><p>NPE configuration file</p>
<pre class="screen">#
sysname NPE
#
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
mpls lsr-id 4.4.4.4
mpls
#
mpls ldp
#
ntp-service sync-interval 180
ntp-service unicast-server 172.16.4.1
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 172.16.5.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 172.16.4.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
 ip binding vpn-instance vpna
 ip address 192.168.2.1 255.255.255.0
 ipfpm tlp 310
#
interface LoopBack1
 ip address 4.4.4.4 255.255.255.255
#
bgp 100
 router-id 4.4.4.4
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack1
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 2.2.2.2 enable
  peer 3.3.3.3 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 2.2.2.2 enable
  peer 3.3.3.3 enable
 #
 ipv4-family vpn-instance vpna
  import-route direct
  auto-frr
#
ospf 1
 area 0.0.0.0
  network 4.4.4.4 0.0.0.0
  network 172.16.4.0 0.0.0.255
  network 172.16.5.0 0.0.0.255
#
nqa ipfpm dcp
 dcp id 4.4.4.4
 mcp 1.1.1.1 port 2048
 authentication-mode hmac-sha256 key-id 1 cipher <span>#%#%;\VV*UAUfP'8+uS{,4v+1Gjv#%#%</span>
 color-flag loss-measure tos-bit 3 delay-measure tos-bit 4
 instance 1
  flow bidirectional source 10.1.1.1 destination 10.2.1.1
  tlp 310 out-point egress
  loss-measure enable continual
  delay-measure enable two-way tlp 310 continual
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipfpm_cfg_0012.html">IP FPM Configuration Examples
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipfpm_cfg_0014.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>