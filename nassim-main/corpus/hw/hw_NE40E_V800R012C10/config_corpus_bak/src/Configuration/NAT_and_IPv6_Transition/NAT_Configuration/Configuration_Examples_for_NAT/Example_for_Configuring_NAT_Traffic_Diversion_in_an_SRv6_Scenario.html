
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring NAT Traffic Diversion in an SRv6 Scenario">
<meta name="abstract" content="This section provides an example for configuring NAT traffic diversion to implement mutual access between users in an SRv6 scenario.">
<meta name="description" content="This section provides an example for configuring NAT traffic diversion to implement mutual access between users in an SRv6 scenario.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0056.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0157.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="c00549182">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="OWNER" content="c00549182">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="m00390128">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0275817275">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring NAT Traffic Diversion in an SRv6 Scenario</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0275817275"></a><a name="EN-US_TASK_0275817275"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring NAT Traffic Diversion in an SRv6 Scenario</h1>
<div class="taskbody"><p>This section provides an example for configuring NAT traffic diversion to implement mutual access between users in an SRv6 scenario.</p>
<div class="context"><a name="EN-US_TASK_0275817275__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>In the SRv6 scenario shown in <a href="#EN-US_TASK_0275817275__fig_dc_ne_nat_cfg_015701">Figure 1</a>, CE1 and CE2 belong to VPN-A, and PE2 is a NAT device. PC1 needs to be able to communicate with PC2 after address translation on PE2, and NAT traffic diversion needs to be configured on the network-side inbound interface of the egress PE (PE2).</p>
<div class="fignone" id="EN-US_TASK_0275817275__fig_dc_ne_nat_cfg_015701"><a name="EN-US_TASK_0275817275__fig_dc_ne_nat_cfg_015701"></a><a name="fig_dc_ne_nat_cfg_015701"></a><span class="figcap"><b>Figure 1 </b>Configuring NAT traffic diversion in an SRv6 scenario</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interface 1 and interface 2 in this example represent GE <span>0/2/1</span> and GE <span>0/2/2</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0275817286.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0275817275__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li>Configure routing protocols to enable network connectivity.</li><li>Configure SRv6 to enable CEs to communicate with each other.</li><li>Create a service-location group and service-instance group.</li><li>Create a NAT instance and bind it to the service-instance group.</li><li>Configure a NAT traffic diversion policy.</li><li>Configure a NAT address pool and a NAT traffic conversion policy.</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0275817275__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><ul><li>IPv4 addresses of interfaces on the CEs, IPv6 address of interfaces on the PEs and P device, IS-IS process ID and level, and VPN instance names on the PEs</li><li>Index number of the service-location group: 1; name of the service-instance group: <strong>group1</strong>; slot ID of the service board: 1</li><li>NAT instance name and index number: <strong>nat1</strong> and 1</li><li>NAT address pool name: <strong>address-group1</strong>; address pool number: 1; IP address prefix</li><li>ACL number: 3001; traffic classifier name: <strong>c1</strong>; traffic behavior name: <strong>b1</strong>; traffic policy name: <strong>p1</strong></li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0275817275__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span># Assign IPv4 addresses to the interfaces on the CEs and PEs according to <a href="#EN-US_TASK_0275817275__fig_dc_ne_nat_cfg_015701">Figure 1</a>. For configuration details, see "Configuration Files" in this section.</span></li><li><span>Enable IPv6 forwarding and configure an IPv6 address for each interface. The following uses PE1 as an example. The configuration procedures on PE2 and P are the same.</span><p><pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname PE1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface GigabitEthernet <span>0/2/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/2</span>] <strong>ipv6 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/2</span>] <strong>ipv6 address 2001:db8:1::1 96</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1]<strong> interface LoopBack 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack0] <strong>ipv6 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack0] <strong>ipv6 address 2001:db8:10::1 64</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</p></li><li><span>Configure IS-IS.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>is-level level-1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>cost-style wide</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>network-entity 10.0000.0000.0001.00</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>ipv6 enable topology ipv6</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface GigabitEthernet <span>0/2/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/2</span>] <strong>isis ipv6 enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface LoopBack 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack0] <strong>isis ipv6 enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure the P device.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>isis 1</strong> </pre>
<pre class="screen">[<span class="keyword">*</span>P-isis-1] <strong>is-level level-1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-isis-1] <strong>cost-style wide</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-isis-1] <strong>network-entity 10.0000.0000.0002.00</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-isis-1] <strong>ipv6 enable topology ipv6</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P] <strong>interface GigabitEthernet <span>0/2/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/1</span>] <strong>isis ipv6 enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P] <strong>interface GigabitEthernet <span>0/2/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/2</span>] <strong>isis ipv6 enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P] <strong>interface LoopBack </strong><strong>0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-LoopBack0] <strong>isis ipv6 enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-LoopBack0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>is-level level-1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>cost-style wide</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>network-entity 10.0000.0000.0003.00</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>ipv6 enable topology ipv6</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface GigabitEthernet <span>0/2/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/2</span>] <strong>isis ipv6 enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface LoopBack 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack0] <strong>isis ipv6 enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</p></li><li><span>Configure a VPN instance on each PE, enable the IPv4 address family for the instance, and bind the interface that connects each PE to a CE to the VPN instance on that PE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface GigabitEthernet </strong><span>0/2/1</span></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/1</span>] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/1</span>] <strong>ip address 172.16.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface GigabitEthernet </strong><strong><span>0/2/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/1</span>] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/1</span>] <strong>ip address 172.16.5.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p>After completing the configuration, run the <strong>display ip vpn-instance verbose</strong> command on the PEs to check the VPN instance configuration. Each PE should be able to successfully ping its connected CE.</p>
</p></li><li><span>Establish an EBGP peer relationship between each PE and its connected CE.</span><p><p># Configure CE1.</p>
</p><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>peer 172.16.1.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1] <strong>commit</strong></pre>
<p># Configure CE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>bgp 400</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-bgp] <strong>peer 172.16.5.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-bgp] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2] <strong>commit</strong></pre>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>peer 172.16.1.1 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpna] <strong>peer 172.16.5.1 as-number 400</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpna] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>import-route</strong><strong> unr</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p>After the configuration is complete, run the <strong>display bgp vpnv4 vpn-instance peer</strong> command on the PEs to check whether BGP peer relationships have been established between the PEs and CEs. If the <strong>Established</strong> state is displayed in the command output, the BGP peer relationships have been established successfully.</p>
</p></li><li><span>Establish an MP-IBGP peer relationship between the PEs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>peer 2001:db8:30::1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 2001:db8:30::1 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 2001:db8:30::1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp] <strong>peer 2001:db8:10::1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 2001:db8:10::1 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 2001:db8:10::1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp] <strong>quit</strong></pre>
<p>After the configuration is complete, run the <strong>display bgp vpnv4 all peer</strong> command on the PEs to check whether a BGP peer relationship has been established between the PEs. If the <strong>Established</strong> state is displayed in the command output, the BGP peer relationships have been established successfully.</p>
</p></li><li><span>Establish SRv6 BE paths between the PEs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>segment-routing ipv6</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-ipv6] <strong>encapsulation source-address 2001:db8:10::1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-ipv6] <strong>locator as1 ipv6-prefix <span>2001:db8:40::</span> 64 static 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-ipv6-locator] <strong>opcode ::20 end-dt4 vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-ipv6-locator] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-ipv6] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 2001:db8:30::1 prefix-sid</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>segment-routing ipv6 best-effort</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>segment-routing ipv6 locator as1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>segment-routing ipv6 locator as1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>segment-routing ipv6</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-ipv6] <strong>encapsulation source-address 2001:db8:30::1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-ipv6] <strong>locator as1 ipv6-prefix 2001:db8:50:: 64 static 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-ipv6-locator] <strong>opcode ::20 end-dt4 vpn-instance </strong><strong>vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-ipv6-locator] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-ipv6] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 2001:db8:10::1 prefix-sid</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpna] <strong>segment-routing ipv6 best-effort</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpna] <strong>segment-routing ipv6 locator as1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>segment-routing ipv6 locator as1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p>Run the <strong>display ip routing-table</strong> <strong>vpn-instance</strong> command on the PEs to check that the VPN routing tables contain CE routes. CEs belonging to the same VPN should be able to successfully ping each other.</p>
</p></li><li><span>Create a service-location group and service-instance group on PE2, and bind the NAT service board to the service-location group. Create a NAT instance and bind it to the service-instance group.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>service-location 1 </strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-service-location-1] <strong>location<span> slot <span><span>3</span></span></span></strong><strong> </strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-service-location-1] <strong>quit </strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>service-instance-group group1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-service-instance-group-group1] <strong>service-location 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-service-instance-group-group1] <strong>quit </strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>nat instance nat1 id 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-nat-instance-nat1] <strong>service-instance-group group1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-nat-instance-nat1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</p></li><li><span>Configure an ACL-based traffic policy and apply the traffic policy to the VPN instance on PE2.</span><ol type="a"><li class="substepexpand"><span>Configure an ACL and specify an ACL rule.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>acl 3001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-acl-adv-3001] <strong>rule 1 permit ip source 10.1.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-acl-adv-3001] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-acl-adv-3001] <strong>quit</strong></pre>
</p></li><li class="substepexpand"><span>Configure a traffic classifier and define an ACL-based matching rule.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>traffic classifier c1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-classifier-c1] <strong>if-match acl 3001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-classifier-c1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-classifier-c1] <strong>quit</strong></pre>
</p></li><li class="substepexpand"><span>Define a traffic behavior, in which the action is binding NAT instance <strong>nat1</strong>.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>traffic behavior b1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-behavior-b1] <strong>nat bind instance nat1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-behavior-b1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-behavior-b1] <strong>quit</strong></pre>
</p></li><li class="substepexpand"><span>Define a traffic policy to associate the configured traffic classifier with the traffic behavior.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>traffic policy p1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-trafficpolicy-p1] <strong>classifier c1 behavior b1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-trafficpolicy-p1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-trafficpolicy-p1] <strong>quit</strong></pre>
</p></li><li class="substepexpand"><span>Apply the traffic policy in the VPN instance view.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>traffic-policy p1 network inbound</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpna] <strong>quit</strong></pre>
</p></li></ol>
</li><li><span>Configure a NAT address pool and NAT conversion policy on PE2 so that all the packets diverted to the NAT service board from the interface board are directly translated using the addresses in the NAT address pool.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>nat instance nat1 id 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-nat-instance-nat1] <strong>nat address-group address-group1 group-id 1 11.1.1.1 11.1.1.5 vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-nat-instance-nat1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-nat-instance-nat1] <strong>quit</strong></pre>
<p>Run the <strong>display nat session table</strong> command on PE2 to check that the desired NAT session entry is displayed.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>display nat session table slot </strong><strong><span><span>1</span></span></strong> 
This operation will take a few minutes. Press 'Ctrl+C' to break ... 
Slot: <strong><span><span>1</span></span></strong>  
Current total sessions: 1.   
  udp: 10.1.1.2:1234[11.1.1.1:2234]--&gt; 10.1.3.1:1024</pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0275817275__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li>PE1 configuration file<pre class="screen">#
sysname PE1
#
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 100:1
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#             
segment-routing ipv6
 encapsulation source-address 2001:db8:10::1
 locator as1 ipv6-prefix 2001:db8:40:: 64 static 32
 opcode ::20 end-dt4 vpn-instance vpna
#               
isis 1          
 is-level level-1
 cost-style wide
 network-entity 10.0000.0000.0001.00
 #              
 ipv6 enable topology ipv6
 segment-routing ipv6 locator as1
 #           
#               
interface GigabitEthernet<span>0/2/1</span>
 undo shutdown  
 ip binding vpn-instance vpna
 ip address 172.16.1.2 255.255.255.0
#               
interface GigabitEthernet<span>0/2/2</span>
 undo shutdown  
 ipv6 enable    
 ipv6 address 2001:db8:1::1/96
 isis ipv6 enable 1
#               
interface LoopBack0
 ipv6 enable    
 ipv6 address 2001:db8:10::1/64
 isis ipv6 enable 1
#               
bgp 100         
 router-id 1.1.1.1
 peer 2001:db8:30::1 as-number 100
 peer 2001:db8:30::1 connect-interface LoopBack0
 #              
 ipv4-family unicast
  undo synchronization
 #              
 ipv6-family unicast
  undo synchronization
 #              
 ipv4-family vpnv4
  policy vpn-target
  peer 2001:db8:30::1 enable
  peer 2001:db8:30::1 prefix-sid
 #              
 ipv4-family vpn-instance vpna
  import-route direct
  segment-routing ipv6 locator as1
  segment-routing ipv6 best-effort
  peer 172.16.1.1 as-number 200
#               
return</pre>
</li><li>P configuration file<pre class="screen">#
sysname P        
#               
isis 1          
 is-level level-1
 cost-style wide
 network-entity 10.0000.0000.0002.00
 #              
 ipv6 enable topology ipv6
 #
#               
interface GigabitEthernet<span>0/2/1</span>
 undo shutdown  
 ipv6 enable    
 ipv6 address 2001:db8:1::2/96
 isis ipv6 enable 1 
# 
interface GigabitEthernet<span>0/2/2</span>
 undo shutdown  
 ipv6 enable    
 ipv6 address 2001:db8:2::1/96
 isis ipv6 enable 1  
#               
interface LoopBack0
 ipv6 enable    
 ipv6 address 2001:db8:20::1/64
 isis ipv6 enable 1
#               
return </pre>
</li><li>PE2 configuration file<pre class="screen">#
 sysname PE2
#
service-location 1
 location<span> slot <span><span>3</span></span></span>
#
service-instance-group group1
 service-location 1
#
nat instance nat1 id 1
 service-instance-group group1
 nat address-group address-group1 group-id 1 11.1.1.1 11.1.1.5 vpn-instance vpna
#
acl 3001
 rule 1 permit ip source 10.1.1.0 0.0.0.255 
#
traffic classifier c1 operator or
 if-match acl 3001 precedence 1
#
traffic behavior b1
 nat bind instance nat1
#
traffic policy p1
 classifier c1 behavior b1 precedence 1
#
ip vpn-instance vpna
traffic-policy p1 network inbound
 ipv4-family
  route-distinguisher 100:1
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#               
segment-routing ipv6
 encapsulation source-address 2001:db8:30::1
 locator as1 ipv6-prefix 2001:db8:50:: 64 static 32
  opcode ::20 end-dt4 vpn-instance vpna
#               
isis 1          
 is-level level-1
 cost-style wide
 network-entity 10.0000.0000.0003.00
 #              
 ipv6 enable topology ipv6
 segment-routing ipv6 locator as1
 #              
#               
interface GigabitEthernet<span>0/2/1</span>
 undo shutdown  
 ip binding vpn-instance vpna
 ip address 172.16.5.2 255.255.255.0
#               
interface GigabitEthernet<span>0/2/2</span>
 undo shutdown  
 ipv6 enable    
 ipv6 address 2001:db8:2::2/96
 isis ipv6 enable 1
#               
interface LoopBack0
 ipv6 enable    
 ipv6 address 2001:db8:30::1/64
 isis ipv6 enable 1
#               
bgp 100         
 router-id 2.2.2.2
 peer 2001:db8:10::1 as-number 100
 peer 2001:db8:10::1 connect-interface LoopBack0
 #              
 ipv4-family unicast
  undo synchronization
 #              
 ipv6-family unicast
  undo synchronization
 #              
 ipv4-family vpnv4
  policy vpn-target
  peer 2001:db8:10::1 enable
  peer 2001:db8:10::1 prefix-sid
 #              
 ipv4-family vpn-instance vpna
  import-route direct
  segment-routing ipv6 locator as1
  segment-routing ipv6 best-effort
  peer 172.16.5.1 as-number 400
#               
return</pre>
</li><li>CE1 configuration file<pre class="screen">#
 sysname CE1
#
interface GigabitEthernet<span>0/2/1</span>
 undo shutdown
 ip address 172.16.1.1 255.255.255.0
#
bgp 200
 peer 172.16.1.2 as-number 100
 import-route direct
#
return</pre>
</li><li>CE2 configuration file<pre class="screen">#
 sysname CE2
#
interface GigabitEthernet<span>0/2/1</span>
 undo shutdown
 ip address 172.16.5.1 255.255.255.0
#
bgp 400
 peer 172.16.5.2 as-number 100
 import-route direct
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0056.html">Configuration Examples for NAT
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0157.html"><span class="font-st">&lt; </span>Previous topic</a>
</div>
</div>
</body>
</html>