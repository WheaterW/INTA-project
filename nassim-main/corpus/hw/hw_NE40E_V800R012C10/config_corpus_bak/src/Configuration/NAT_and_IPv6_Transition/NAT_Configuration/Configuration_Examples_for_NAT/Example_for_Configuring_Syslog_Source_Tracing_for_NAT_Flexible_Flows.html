
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring Syslog Source Tracing for NAT Flexible Flows">
<meta name="abstract" content="This section provides an example for configuring syslog source tracing for flexible NAT flows. The log function can be used to record information about intranet users' access to external networks in real time, improving network maintainability. A networking diagram is provided to help you understand the configuration procedure.">
<meta name="description" content="This section provides an example for configuring syslog source tracing for flexible NAT flows. The log function can be used to record information about intranet users' access to external networks in real time, improving network maintainability. A networking diagram is provided to help you understand the configuration procedure.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0056.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0098_1.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_atn_nat_cfg_0071_1.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="c00549182">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="OWNER" content="c00549182">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="c00549182">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0219369081">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring Syslog Source Tracing for NAT Flexible Flows</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0219369081"></a><a name="EN-US_TASK_0219369081"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring Syslog Source Tracing for NAT Flexible Flows</h1>
<div class="taskbody"><p>This section provides an example for configuring syslog source tracing for flexible NAT flows. The log function can be used to record information about intranet users' access to external networks in real time, improving network maintainability. A networking diagram is provided to help you understand the configuration procedure.</p>
<div class="context"><a name="EN-US_TASK_0219369081__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>In <a href="#EN-US_TASK_0219369081__fig323195820314">Figure 1</a>, the NAT device (NAT1) performs the NAT function to help PCs within an enterprise network access the Internet. The NAT device is connected to the enterprise network through GE <span>0/2/0</span> and to the Internet through GE <span>0/2/1</span>. The enterprise is assigned public IP addresses of 11.11.11.11/32 through 11.11.11.15/32. The router DeviceA is connected to the log server through GE <span>0/2/0</span> and to the external network through GE <span>0/2/1</span>. An IPsec tunnel is established between NAT1 and DeviceA to transfer syslogs for NAT flexible flows to the log server.</p>
<div class="p">The configuration requirements are as follows:<ul><li>Only PCs on the network segment of 192.168.10.0/24 can perform NAT and access the external network.</li><li>The syslog server can record the actions of users when they access Internet applications.</li><li>NAT1 and DeviceA support IPsec services.</li></ul>
</div>
<div class="fignone" id="EN-US_TASK_0219369081__fig323195820314"><a name="EN-US_TASK_0219369081__fig323195820314"></a><a name="fig323195820314"></a><span class="figcap"><b>Figure 1 </b>Networking of syslog source tracing for NAT flexible flows</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 and 2 in this example represent GE <span>0/2/0</span> and GE <span>0/2/1</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0000001340590342.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0219369081__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li>Configure basic NAT functions.</li><li>Configure a NAT traffic diversion policy.</li><li>Configure the syslog function for NAT flexible flows.</li><li>Configure an IPsec tunnel between NAT1 and DeviceA. Configure NAT1 and DeviceA to encrypt packets using the HMAC-SHA256 and AES-256 algorithms for authentication.</li><li>Configure a routing policy to ensure that the syslog server is reachable.</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0219369081__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><div class="p">To complete the configuration, you need the following data:<ul><li><p>Service-location group index: 1 and 2.</p>
</li><li><p>Service-instance group name: group1 and group2.</p>
</li><li><p>NAT instance name (nat1) and index (1)</p>
</li><li><p>NAT1's NAT address pool name (address-group1), address pool number (1), a range of public IP addresses (11.11.11.11 through 11.11.11.15)</p>
</li><li><p>ACL number: 3000 and 3001.</p>
</li><li><p>Name (GE <span>0/2/1</span>) and IP address (192.0.2.1/24) of an interface to which a NAT traffic diversion policy is applied</p>
</li><li>NAT syslog host address (198.51.100.1) and port number (514), and NAT device's source IP address (192.0.2.1) and source port number (514)</li></ul>
</div>
</div></div>
<div class="steps"><a name="EN-US_TASK_0219369081__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure basic NAT functions.</span><ol type="a"><li class="substepexpand"><span>Create a NAT instance named <strong>nat1</strong> and bind it to the service board.</span><p><pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname NAT1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>service-location 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-service-location-1] <strong>location slot <span>3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-service-location-1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-service-location-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>service-instance-group group1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-service-instance-group-group1] <strong>service-location 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-service-instance-group-group1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-service-instance-group-group1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>nat instance nat1 id 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-instance-nat1] <strong>service-instance-group group1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-instance-nat1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-nat-instance-nat1] <strong>quit</strong></pre>
</p></li><li class="substepexpand"><span>Configure a NAT address pool with addresses ranging from 11.11.11.11 to 11.11.11.15.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>nat instance nat1</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-nat-instance-nat1] <strong>nat address-group address-group1 group-id 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-instance-nat1-nat-address-group-address-group1] <strong>section 1 11.11.11.11 11.11.11.15</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-instance-nat1-nat-address-group-address-group1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-nat-instance-nat1-nat-address-group-address-group1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-nat-instance-nat1] <strong>quit</strong></pre>
</p></li></ol>
</li><li><span>Configure a NAT traffic diversion policy on an outbound interface.</span><p><ol type="a"><li><div class="p">Configure an ACL numbered <strong>3001</strong> and an ACL rule numbered <strong>1</strong> to allow hosts only within the network segment 192.168.10.0/24 to access the Internet.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>acl 3001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-acl4-advance-3001] <strong>rule 1 permit ip source 192.168.10.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-acl4-advance-3001] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-acl4-advance-3001] <strong>quit</strong></pre>
</div>
</li><li><div class="p">Apply the ACL-based traffic classification policy in the view of GE <span>0/2/1</span>.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>interface gigabitEthernet <span>0/2/1</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-GigabitEthernet<span>0/2/1</span>] <strong>ip address 192.0.2.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-GigabitEthernet<span>0/2/1</span>] <strong>nat bind acl 3001 instance nat1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-GigabitEthernet<span>0/2/1</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-GigabitEthernet<span>0/2/1</span>] <strong>quit</strong></pre>
</div>
</li><li><div class="p">Configure an IP address for GE <span>0/2/0</span>.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>interface gigabitEthernet <span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-GigabitEthernet<span>0/2/0</span>] <strong>ip address 192.168.10.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-GigabitEthernet<span>0/2/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
</div>
</li></ol>
</p></li><li><span>Configure the syslog function for NAT flexible flows.</span><ol type="a"><li class="substepexpand"><span>Enable the syslog function for NAT flexible flows in the NAT instance <strong>nat1</strong>.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>nat instance nat1</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-nat-instance-nat1] <strong>nat log session enable syslog</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-instance-nat1] <strong>nat log host 198.51.100.1 514 source 192.0.2.1 514 name NAT1 </strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-instance-nat1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-nat-instance-nat1] <strong>quit</strong></pre>
</p></li><li class="substepexpand"><span>Create a syslog template for NAT flexible flows, configure the template, and specify a flexible log template type.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>nat syslog </strong><strong>flexible template session</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 0 fixed-string  "&lt;134&gt; 1 "</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 1 timestamp-year " "</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 2 timestamp-month-en " "</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 3 timestamp-date " "</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 4 timestamp-hour ":"</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 5 timestamp-minute  ":"</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 6 timestamp-second " "</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 7 host-ip " "</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 8 app-name " - "</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 9 scene ":"</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 10 fixed-string  "SessionbasedA [" create</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 10 fixed-string  "SessionbasedW [" free</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 11 protocol " "</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 12 source-ip " - "</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 13 destination-ip " "</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 14 source-port " "</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>nat position 15 destination-port " -]"</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-nat-syslog-template-session] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>nat syslog descriptive format flexible template session</strong></pre>
</p></li></ol>
</li><li><span>Configure an IPsec tunnel on NAT1.</span><p><ol type="a"><li>Enable IPsec and configure the service board in slot <span>1</span> to support IPsec.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1]<strong> license</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-license] <strong>active ipsec slot <span>1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-license] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-license] <strong>quit</strong></pre>
</li><li>Create and configure a tunnel interface.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1]<strong> interface Tunnel 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-Tunnel10] <strong>tunnel-protocol ipsec</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-Tunnel10] <strong>ip address 192.168.1.1 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-Tunnel10] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-Tunnel10] <strong>quit</strong></pre>
</li><li>Configure ACL 3000.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>acl 3000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-acl-adv-3000] <strong>rule permit ip source 192.0.2.1 0 destination 198.51.100.1 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-acl-adv-3000] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-acl-adv-3000] <strong>quit</strong></pre>
</li><li>Configure an IPsec proposal named <strong>tran1</strong>.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>ipsec proposal tran1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ipsec-proposal-tran1] <strong>encapsulation-mode tunnel</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ipsec-proposal-tran1] <strong>transform esp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ipsec-proposal-tran1] <strong>esp authentication-algorithm sha2-256</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ipsec-proposal-tran1] <strong>esp encryption-algorithm aes 256</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ipsec-proposal-tran1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-ipsec-proposal-tran1] <strong>quit</strong></pre>
</li><li>Configure an IKE proposal numbered <strong>10</strong>.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>ike proposal 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ike-proposal-10] <strong>authentication-method pre-share</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ike-proposal-10] <strong>authentication-algorithm sha2-256</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ike-proposal-10] <strong>dh group14</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ike-proposal-10] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-ike-proposal-10] <strong>quit</strong></pre>
</li><li>Configure an IKE peer.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>ike peer b</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ike-peer-b] <strong>ike-proposal 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ike-peer-b] <strong>remote-address 192.168.1.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ike-peer-b] <strong>pre-shared-key abcde</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ike-peer-b] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-ike-peer-b] <strong>quit</strong></pre>
</li><li>Configure dead peer detection (DPD).<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>ike dpd 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1] <strong>commit</strong></pre>
</li><li>Configure IPsec policy <strong>map1</strong>.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>ipsec policy map1 10 isakmp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ipsec-policy-isakmp-map1-10] <strong>security acl 3000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ipsec-policy-isakmp-map1-10] <strong>proposal tran1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ipsec-policy-isakmp-map1-10] <strong>ike-peer a</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-ipsec-policy-isakmp-map1-10] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-ipsec-policy-isakmp-map1-10] <strong>quit</strong></pre>
</li><li>Configure an IPsec service-instance group.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>service-location 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-service-location-2] <strong>location slot <span>1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-service-location-2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-service-location-2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>service-instance-group group2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-service-instance-group-group2] <strong>service-location 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-service-instance-group-group2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-service-instance-group-group2] <strong>quit</strong></pre>
</li><li>Apply the IPsec policy to the tunnel interface.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>interface Tunnel 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-Tunnel10] <strong>ipsec policy map1 service-instance-group group2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1-Tunnel10] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1-Tunnel10] <strong>quit</strong></pre>
</li></ol>
</p></li><li><span>Configure an IPsec tunnel on <span class="keyword">Device</span> A.</span><p><ol type="a"><li>Configure IP addresses for interfaces.<pre class="screen">&lt;<span class="keyword">Device</span>A&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>interface gigabitethernet <span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-GigabitEthernet<span>0/2/0</span>] <strong>ip address 198.51.100.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/2/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>interface gigabitethernet <span>0/2/1</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-GigabitEthernet<span>0/2/1</span>] <strong>ip address 10.0.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/2/1</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-GigabitEthernet<span>0/2/1</span>] <strong>quit</strong></pre>
</li><li>Enable IPsec and configure the service board in slot <span>1</span> to support IPsec.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A]<strong> license</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-license] <strong>active ipsec slot <span>1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-license] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-license] <strong>quit</strong></pre>
</li><li>Create and configure a tunnel interface.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A]<strong> interface Tunnel 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel10] <strong>tunnel-protocol ipsec</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel10] <strong>ip address 192.168.1.2 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel10] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-Tunnel10] <strong>quit</strong></pre>
</li><li>Configure ACL 3000.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>acl 3000</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-acl-adv-3000] <strong>rule permit ip source 198.51.100.1 0 destination 192.0.2.1 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-acl-adv-3000] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-acl-adv-3000] <strong>quit</strong></pre>
</li><li>Configure an IPsec proposal named <strong>tran1</strong>.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>ipsec proposal tran1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-proposal-tran1] <strong>encapsulation-mode tunnel</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-proposal-tran1] <strong>transform esp</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-proposal-tran1] <strong>esp authentication-algorithm sha2-256</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-proposal-tran1] <strong>esp encryption-algorithm aes 256</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-proposal-tran1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-ipsec-proposal-tran1] <strong>quit</strong></pre>
</li><li>Configure an IKE proposal numbered <strong>10</strong>.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>ike proposal 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-proposal-10] <strong>authentication-method pre-share</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-proposal-10] <strong>authentication-algorithm sha2-256</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-proposal-10] <strong>dh group14</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-proposal-10] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-ike-proposal-10] <strong>quit</strong></pre>
</li><li>Configure an IKE peer.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>ike peer a</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-peer-a] <strong>ike-proposal 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-peer-a] <strong>remote-address 192.168.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-peer-a] <strong>pre-shared-key abcde</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-peer-a] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-ike-peer-a] <strong>quit</strong></pre>
</li><li>Configure DPD.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>ike dpd 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</li><li>Configure IPsec policy <strong>map1</strong>.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>ipsec policy map1 10 isakmp</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-policy-isakmp-map1-10] <strong>security acl 3000</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-policy-isakmp-map1-10] <strong>proposal tran1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-policy-isakmp-map1-10] <strong>ike-peer a</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-policy-isakmp-map1-10] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-ipsec-policy-isakmp-map1-10] <strong>quit</strong></pre>
</li><li>Configure an IPsec service-instance group.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>service-location 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-service-location-2] <strong>location slot <span>1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-service-location-2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-service-location-2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>service-instance-group group2</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-service-instance-group-group2] <strong>service-location 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-service-instance-group-group2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-service-instance-group-group2] <strong>quit</strong></pre>
</li><li>Apply the IPsec policy to the tunnel interface.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>interface Tunnel 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel10] <strong>ipsec policy map1 service-instance-group group2</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A1-Tunnel10] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-Tunnel10] <strong>quit</strong></pre>
</li></ol>
</p></li><li><span>Configure a static route to ensure that the log server is reachable. Set the next hop address of the route from the NAT device to the external network to 192.0.2.2/24 and the next hop address of the route from <span class="keyword">Device</span> A to the external network to 10.0.1.1/24. (The routing policy needs to be configured based on the actual networking.)</span><p><p># Configure NAT1.</p>
</p><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>ip route-static 198.51.100.1 0.0.0.0 tunnel 10 192.168.1.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1] <strong>ip route-static 192.168.1.2 255.255.255.255 192.0.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NAT1] <strong>commit</strong></pre>
<p># Configure DeviceA.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>ip route-static 192.0.2.1 0.0.0.0 tunnel 10 192.168.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A]<strong> </strong><strong>ip route-static</strong><strong> 192.168.1.1 255.255.255.255 10.0.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</p></li><li><span>Verify the configuration.</span><p><div class="p"># View the log format of the syslog template for NAT flexible flows.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NAT1] <strong>display nat syslog flexible session template</strong></pre>
<pre class="screen">Create Log:
  fixed_string&lt;134&gt; 1 timestamp_year timestamp_month_en timestamp_date timestamp_hour:timestamp_minute:timestamp_second host_ip app_name - scene:fixed_stringSessionbasedA [protocol source_ip - destination_ip source_port destination_port -]  
  Example: 
  &lt;134&gt; 1 2019 January 18 14:09:22 X.X.X.X cnelog - NAT444:SessionbasedA [17 X.X.X.X - X.X.X.X 1052 2000 -]
Free Log: 
  fixed_string&lt;134&gt; 1 timestamp_year timestamp_month_en timestamp_date timestamp_hour:timestamp_minute:timestamp_second host_ip app_name - scene:fixed_stringSessionbasedW [protocol source_ip - destination_ip source_port destination_port -]
  Example: 
  &lt;134&gt; 1 2019 January 18 14:09:22 X.X.X.X cnelog - NAT444:SessionbasedW [17 X.X.X.X - X.X.X.X 1052 2000 -]</pre>
</div>
</p><p><p># Display the IPsec tunnel negotiation status.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>display ike sa</strong></pre>
<pre class="screen">current sa Num :2
   Single-homing :2          Multi-homing M and M|B :0        Multi-homing S and S|B :0
   None-backup sa :2         Backup sa :0
Spu board <strong>slot <span>1</span></strong> , IKE SA Information:
Current IKE SA number: 2
------------------------------------------------------------------------------------
conn-id    peer                    flag                phase   bfd   ext    vpn
------------------------------------------------------------------------------------
2        192.168.1.2                 RD|ST               v2:2    -     -      -
1        192.168.1.2                 RD|ST               v2:1    -     -      -</pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0219369081__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>NAT1 configuration file</p>
<pre class="screen">#
sysname NAT1
#
 active ipsec slot <span>1</span>
#
ike dpd 100
service-location 1
 location slot <span>3</span>
# 
service-location 2
 location slot <span>1</span>
#
service-instance-group group1      
 service-location 1    
#
service-instance-group group2      
 service-location 2
#
nat instance nat1 id 1      
 service-instance-group group1      
 nat address-group address-group1 group-id 1 
  section 1 11.11.11.11 11.11.11.15  
 nat log host 198.51.100.1 514 source 192.0.2.1 514 name NAT1
 nat log session enable syslog
# 
acl number 3000 
 rule 5 permit ip source 192.0.2.1 0 destination 198.51.100.1 0
#
acl number 3001
 rule 1 permit ip source 192.168.10.0 0.0.0.255
#
ike proposal 10 
 encryption-algorithm des-cbc
 dh group14
 authentication-algorithm sha2-256
 integrity-algorithm hmac-sha2-256
# 
ike peer b 
 pre-shared-key cipher %^%#aRY4K;`"G=G{$z:d)#X;Y0Q,%@K|FF1/D=6k&lt;G&gt;;%^%#
 ike-proposal 10
 remote-address 192.168.1.2
# 
ipsec proposal tran1 
 esp authentication-algorithm sha2-256
 esp encryption-algorithm aes 256
# 
ipsec policy map1 10 isakmp 
 security acl 3000
 ike-peer b
 proposal tran1
#
interface GigabitEthernet <span>0/2/0</span>
 undo shutdown
 ip address 192.168.10.1 255.255.255.0
#
interface GigabitEthernet <span>0/2/1</span>
 undo shutdown
 ip address 192.0.2.1 255.255.255.0
 nat bind acl 3001 instance nat1
# 
interface Tunnel10 
 ip address 192.168.1.1 255.255.255.255 
 tunnel-protocol ipsec 
 ipsec policy map1 service-instance-group 2
#
nat syslog flexible template session
 nat position 0 fixed-string  "&lt;134&gt; 1 "
 nat position 1 timestamp-year " "
 nat position 2 timestamp-month-en " "
 nat position 3 timestamp-date " "
 nat position 4 timestamp-hour ":"
 nat position 5 timestamp-minute  ":"
 nat position 6 timestamp-second " "
 nat position 7 host-ip " "
 nat position 8 app-name " - "
 nat position 9 scene ":"
 nat position 10 fixed-string  "SessionbasedA [" create
 nat position 10 fixed-string  "SessionbasedW [" free
 nat position 11 protocol " "
 nat position 12 source-ip " - "
 nat position 13 destination-ip " "
 nat position 14 source-port " "
 nat position 15 destination-port " -]"
#
nat syslog descriptive format flexible template session
#
ip route-static 198.51.100.1 0.0.0.0 Tunnel10 192.168.1.2
ip route-static 192.168.1.2 255.255.255.255 192.0.2.2
#
return</pre>
</li><li>DeviceA configuration file<pre class="screen"># 
sysname DeviceA 
# 
license  
 active ipsec slot <span>1</span>   
# 
ike dpd 100
# 
service-location 2
 location slot <span>1</span>
# 
service-instance-group group2       
 service-location 2
# 
acl number 3000 
 rule 5 permit ip source 198.51.100.1 0 destination 192.0.2.1 0 
#
ike proposal 10 
 encryption-algorithm des-cbc
 dh group14
 authentication-algorithm sha2-256
 integrity-algorithm hmac-sha2-256
# 
ike peer a 
 pre-shared-key cipher %^%#aRY4K;`"G=G{$z:d)#X;Y0Q,%@K|FF1/D=6k&lt;G&gt;;%^%#
 ike-proposal 10
 remote-address 192.168.1.1
# 
ipsec proposal tran1 
 esp authentication-algorithm sha2-256
 esp encryption-algorithm aes 256
# 
ipsec policy map1 10 isakmp 
 security acl 3000
 ike-peer a
 proposal tran1
#
interface GigabitEthernet <span>0/2/0</span> 
 undo shutdown 
 ip address 192.51.100.2 255.255.255.0 
# 
interface GigabitEthernet <span>0/2/1</span> 
 undo shutdown 
 ip address 10.0.1.1 255.255.255.0 
# 
interface Tunnel10 
 ip address 192.168.1.2 255.255.255.255 
 tunnel-protocol ipsec 
 ipsec policy map1 service-instance-group 2 
# 
ip route-static 192.0.2.1 0.0.0.0 Tunnel10 192.168.1.1 
ip route-static 192.168.1.1 255.255.255.255 172.0.2.2 
# 
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0056.html">Configuration Examples for NAT
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0098_1.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_atn_nat_cfg_0071_1.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>