
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Configuring GRE over IPsec + OSPF for NAT Traversal">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipsec_cfg_all_0042.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_example_ipsec_0003.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,z00603461,ipsec,w00556928,w00606909,h00522387,l00455378,z00805567">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="OWNER" content="z00485179">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="z00485179">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172372524">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Configuring GRE over IPsec + OSPF for NAT Traversal</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172372524"></a><a name="EN-US_TASK_0172372524"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Configuring GRE over IPsec + OSPF for NAT Traversal</h1>
<div class="taskbody"><div class="context"><a name="EN-US_TASK_0172372524__1.3.1"></a><a name="1.3.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>On the network shown in <a href="#EN-US_TASK_0172372524__fig_dc_ar_cfg_vpn_04552301">Figure 1</a>, the headquarters provides IPsec VPN access to multiple branches, and NAT is configured on egress routers of the branches. The headquarters and branches perform NAT traversal. The headquarters uses a security template to establish GRE tunnels with the branches through loopback interfaces. The branches use ACL to establish GRE over IPsec tunnels with the headquarters and branches through loopback interfaces. Configure an IPsec proposal, set the security protocol used for the proposal to ESP, and specify the authentication algorithm SHA2-256 and the encryption algorithm AES 256 for ESP. In addition, configure an IKE proposal and set the authentication algorithm to SHA2-256, the encryption algorithm to AES-CBC-256, and the DH group identifier used for key negotiation to group14.</p>
<div class="fignone" id="EN-US_TASK_0172372524__fig_dc_ar_cfg_vpn_04552301"><a name="EN-US_TASK_0172372524__fig_dc_ar_cfg_vpn_04552301"></a><a name="fig_dc_ar_cfg_vpn_04552301"></a><span class="figcap"><b>Figure 1 </b>Configuring GRE over IPsec + OSPF for NAT traversal</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 and 2 in this example represent GE <span>0/1/1</span> and GE <span>0/1/2</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0257609448.png"></span></div>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172372524__1.3.2"></a><a name="1.3.2"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure <span class="keyword">Device</span>A.</span><p><pre class="screen">#
 sysname <span class="keyword">Device</span>A</pre>
<pre class="screen">#</pre>
<pre class="screen">service-location 1</pre>
<pre class="screen"> location slot <span>1</span></pre>
<pre class="screen">#</pre>
<pre class="screen">service-instance-group group1</pre>
<pre class="screen"> service-location 1</pre>
<pre class="screen">#
router id 172.16.0.1  //Configure a router ID for OSPF.
#
ike dpd interval 10 10     //You are suggested to deploy the DPD function.
#
acl number 3000  //Configure ACL 3000
 rule 0 permit gre source 172.16.0.1 0 destination 192.168.1.1 0
 rule 0 permit gre source 172.16.0.1 0 destination 192.168.2.1 0
#
ipsec proposal default  //Configure the default IPsec proposal.
 esp authentication-algorithm sha2-256
 esp encryption-algorithm aes 192
#
ike proposal 1  //Configure the IKE proposal.
 dh group14
#
ike peer branch   //Configure the IKE peer for the branch.
 ike-proposal 1
 pre-shared-key <span>cipher </span>%^%#JvZxR2g8c;a9<font style="font-size:8pt" Face="Courier New" >~</font>FPN<font style="font-size:8pt" Face="Courier New" >~</font>n'$7`DEV&amp;=G(=Et02P/%\*!%^%#  //Configure the PSK as <strong>123-branch</strong> in ciphertext.
 local-id-type ip
 nat traversal
#
ipsec policy-template branch 1  //Configure an IPsec policy template with the number of 1 for the branch.
 security acl 3000
 ike-peer branch
 proposal default
#
ipsec policy policy1 1 isakmp template branch    //Create IPsec policy 1 for the IPsec policy template of the branch.
#
interface gigabitethernet<span>0/1/2</span>  //Configure the external network interface of the headquarters.
 ip address 1.1.1.60 255.255.255.0
#
interface gigabitethernet<span>0/1/1</span>  //Configure the IP address of the internal network interface of the headquarters.
 ip address 172.16.1.1 255.255.255.0
#
interface LoopBack0  //Configure the loopback interface used for establishing a GRE connection.
 ip address 172.16.0.1 255.255.255.255
#
interface Tunnel0  //Configure a GRE tunnel for branch 1.
 ip address 192.168.0.1 255.255.255.252
 tunnel-protocol gre
 source LoopBack0
 destination 192.168.1.1
#
interface Tunnel1  //Configure a GRE tunnel for branch 2.
 ip address 192.168.0.5 255.255.255.252
 tunnel-protocol gre
 source LoopBack0
 destination 192.168.2.1
#
interface Tunnel2
ip address 10.0.1.60 24
tunnel-protocol ipsec
ipsec policy policy1<span> service-instance-group group1</span>
#
ospf 1  //Configure routes.
 area 0.0.0.0 
  network 192.168.0.1 0.0.0.3
  network 172.16.1.0 0.0.0.255
  network 192.168.0.5 0.0.0.3
#
ip route-static 10.0.1.2 255.255.255.255 1.1.1.61
ip route-static 10.0.2.2 255.255.255.255 1.1.1.61
#
return</pre>
</p></li><li><span>Configure <span class="keyword">Device</span>B.</span><p><pre class="screen">#
 sysname <span class="keyword">Device</span>B</pre>
<pre class="screen">#</pre>
<pre class="screen">service-location 1</pre>
<pre class="screen"> location slot <span>1</span></pre>
<pre class="screen">#</pre>
<pre class="screen">service-instance-group group1</pre>
<pre class="screen"> service-location 1</pre>
<pre class="screen">#
ike dpd interval 10 10     //You are suggested to deploy the DPD function.
#
acl number 3000
 rule 0 permit gre source 192.168.1.1 0 destination 172.16.0.1 0
#
ipsec proposal default  //Configure the default IPsec proposal.
 esp authentication-algorithm sha2-256
 esp encryption-algorithm aes 192
#
ike proposal 1  //Configure the IKE proposal.
 dh group14
#
ike peer center   //Configure the IKE peer for the headquarters.
 ike-proposal 1
 pre-shared-key <span>cipher </span>%^%#K{JG:rWVHPMnf;5\|,GW(Luq'qi8BT4nOj%5W5=)%^%#  //Configure the PSK as <strong>123-branch</strong> in ciphertext.
 local-id-type ip
 nat traversal
 remote-address 10.0.1.60
#
ipsec policy center 1 isakmp  //Configure an IPsec policy with the number of 1 for the headquarters.
 security acl 3000 
 ike-peer center
 proposal default
#
interface gigabitethernet<span>0/1/1</span>  //Configure the external network interface for branch 1.
 ip address 10.1.1.2 255.255.255.0
#
interface gigabitethernet<span>0/1/2</span>  //Configure the internal network interface for branch 1.
 ip address 192.168.11.1 255.255.255.0
#
interface LoopBack0  //Configure a loopback interface used for creating a GRE source and OSPF router ID for the headquarters.
 ip address 192.168.1.1 255.255.255.255 
#
interface Tunnel0  //Configure a GRE tunnel for the headquarters.
 ip address 192.168.0.2 255.255.255.252
 tunnel-protocol gre
 source LoopBack0
 destination 172.16.0.1
#
interface Tunnel1
 ip address 10.0.1.2 24
 tunnel-protocol ipsec
 ipsec policy center<span> service-instance-group group1</span>
#  //Configure OSPF routes.
ospf 1
 area 0.0.0.0
  network 192.168.11.0 0.0.0.255
  network 192.168.0.2 0.0.0.3
#
ip route-static 10.0.1.60 255.255.255.255 10.1.1.1
ip route-static 0.0.0.0 0.0.0.0 Tunnel1 10.0.1.1  //Configure the default route.
#
return</pre>
</p></li><li><span>Configure <span class="keyword">Device</span>C.</span><p><pre class="screen">#
 sysname <span class="keyword">Device</span>C</pre>
<pre class="screen">#</pre>
<pre class="screen">service-location 1</pre>
<pre class="screen"> location slot <span>1</span></pre>
<pre class="screen">#</pre>
<pre class="screen">service-instance-group group1</pre>
<pre class="screen"> service-location 1</pre>
<pre class="screen">#
 router id 192.168.2.1  //Configure a router ID for OSPF.
#
ike dpd interval 10 10     //You are suggested to deploy the DPD function.
#
acl number 3000
 rule 0 permit gre source 192.168.2.1 0 destination 172.16.0.1 0
#
ipsec proposal default  //Configure the default IPsec proposal.
 esp authentication-algorithm sha2-256
 esp encryption-algorithm aes 192
#
ike proposal 1  //Configure the IKE proposal.
 dh group14
#
ike peer center   //Configure the IKE peer for the headquarters.
 ike-proposal 1
 pre-shared-key <span>cipher </span>%^%#IRFGEiFPJ1$&amp;a'Qy,L*XQL_+*Grq-=yMb}ULZdS6%^%#  //Configure the PSK as <strong>123-branch</strong> in ciphertext.
 local-id-type ip
 nat traversal
 remote-address 10.0.1.60
#
ipsec policy center 1 isakmp  //Configure an IPsec policy with the number of 1 for the headquarters.
 security acl 3000
 ike-peer center
 proposal default
#
interface gigabitethernet<span>0/1/1</span>  //Configure the external network interface for branch 2.
 ip address 10.1.2.2 255.255.255.0
#
interface gigabitethernet<span>0/1/2</span>  //Configure the internal network interface for branch 2.
 ip address 192.168.12.1 255.255.255.0
#
interface LoopBack0  //Configure a loopback interface used for creating a GRE source and OSPF router ID for the headquarters.
 ip address 192.168.2.1 255.255.255.255
#
interface Tunnel0  //Configure a GRE tunnel for the headquarters.
 ip address 192.168.0.6 255.255.255.252
 tunnel-protocol gre
 source LoopBack0
 destination 172.16.0.1
#
interface Tunnel1
 ip address 10.0.2.2 24
 tunnel-protocol ipsec
 ipsec policy center<span> service-instance-group group1</span>
#  //Configure OSPF routes.
ospf 1
 area 0.0.0.0
  network 192.168.0.6 0.0.0.3
  network 192.168.12.0 0.0.0.255
#
ip route-static 10.0.1.60 255.255.255.255 10.1.2.1
ip route-static 0.0.0.0 0.0.0.0 Tunnel1 10.0.2.1  //Configure the default route.
#
return</pre>
</p></li><li><span>Configure NAT1.</span><p><pre class="screen">#
 sysname NAT1
#
 license
  active nat session-table size 2 slot 1 <strong></strong>
  active nat bandwidth-enhance 20 slot 1</pre>
<pre class="screen">#</pre>
<pre class="screen">service-location 1</pre>
<pre class="screen"> location slot <span>1</span></pre>
<pre class="screen">#</pre>
<pre class="screen">service-instance-group group1</pre>
<pre class="screen"> service-location 1</pre>
<pre class="screen">#
nat instance nat1 id 1
 service-instance-group group1
 nat address-group address-group1 group-id 1 11.11.11.1 11.11.11.10  //Configure a NAT address pool.
#
acl number 2000  //Configure the IP address for NAT implementation.
 rule 0 permit source 10.1.2.0 0.0.0.255
#
interface gigabitethernet<span>0/1/1</span>  //Configure an external network interface for NAT.
 ip address 3.3.3.3 255.255.255.0
 nat bind acl 2000 instance nat1
#
interface gigabitethernet<span>0/1/2</span>  //Configure the interface address of the router for branch 2.
 ip address 10.1.2.1 255.255.255.0
#
ip route-static 0.0.0.0 0.0.0.0 1.0.3.2  //Configure the default route.
#
return</pre>
</p></li><li><span>Configure NAT2.</span><p><pre class="screen">#
 sysname NAT2
#
 license
  active nat session-table size 2 slot 1 <strong></strong>
  active nat bandwidth-enhance 20 slot 1</pre>
<pre class="screen">#</pre>
<pre class="screen">service-location 1</pre>
<pre class="screen"> location slot <span>1</span></pre>
<pre class="screen">#</pre>
<pre class="screen">service-instance-group group1</pre>
<pre class="screen"> service-location 1</pre>
<pre class="screen">#
nat instance nat1 id 1
 service-instance-group group1
 nat address-group address-group1 group-id 1 12.12.12.1 12.12.12.10  //Configure a NAT address pool.
#
acl number 2000  //Configure the IP address for NAT implementation.
 rule 0 permit source 10.1.1.0 0.0.0.255
# 
interface gigabitethernet<span>0/1/1</span>  //Configure an external network interface for NAT.
 ip address 2.2.2.2 255.255.255.0
 nat bind acl 2000 instance nat1 
#
interface gigabitethernet<span>0/1/2</span>  //Configure the interface address of the router for branch 1.
 ip address 10.1.1.1 255.255.255.0
#
ip route-static 0.0.0.0 0.0.0.0 1.0.2.2  //Configure the default route.
#
return</pre>
</p></li><li><span>Verify the configuration.</span><p><p>On <span class="keyword">Device</span> A, <span class="keyword">Device</span> B, or <span class="keyword">Device</span> C, run the <strong>display ike sa</strong> command. The command output displays configurations of the IKE SA.</p>
<p>On <span class="keyword">Device</span> A or <span class="keyword">Device</span> B, run the <strong>display ip routing-table</strong> command. The command output displays information about routes from the tunnel interface to the user-side interface.</p>
<p>The headquarters and branches can communicate with each other.</p>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172372524__1.3.3"></a><a name="1.3.3"></a><h4 class="sectiontitle">Precautions</h4><ul><li>The deny rule cannot be configured for the ACL of the headquarters. Otherwise, data flows fail to be transmitted over the IPsec tunnel.</li><li>Only one IPsec policy can be created for the headquarters. Each sequence number corresponds to an IKE peer.</li><li>The external routes between the headquarters and branches must be reachable.</li><li><p>Configure DPD.</p>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipsec_cfg_all_0042.html">IPsec NAT Traversal Scenario
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_example_ipsec_0003.html"><span class="font-st">&lt; </span>Previous topic</a>
</div>
</div>
</body>
</html>