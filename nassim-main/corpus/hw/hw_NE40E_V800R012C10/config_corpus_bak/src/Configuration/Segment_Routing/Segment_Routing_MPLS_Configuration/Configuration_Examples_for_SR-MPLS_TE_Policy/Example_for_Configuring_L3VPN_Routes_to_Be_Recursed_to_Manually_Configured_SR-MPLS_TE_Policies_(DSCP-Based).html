
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring L3VPN Routes to Be Recursed to Manually Configured SR-MPLS TE Policies (DSCP-Based)">
<meta name="abstract" content="This section provides an example for configuring L3VPN routes to be recursed to manually configured SR-MPLS TE Policies based on the DSCP value to ensure secure communication between users of the same VPN.">
<meta name="description" content="This section provides an example for configuring L3VPN routes to be recursed to manually configured SR-MPLS TE Policies based on the DSCP value to ensure secure communication between users of the same VPN.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr_all_cfg_0099.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr_all_cfg_0077.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr_all_cfg_0083.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="segment_routing_vrp,w00604599,l00455378,l00587852,w00606909,w00800033">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="Segment Routing MPLS">
<meta name="featuretype" content="Segment Routing">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="Segment Routing MPLS">
<meta name="featuretype" content="Segment Routing">
<meta name="featurename" content="Segment Routing MPLS">
<meta name="featuretype" content="Segment Routing">
<meta name="featurename" content="Segment Routing MPLS">
<meta name="featuretype" content="Segment Routing">
<meta name="OWNER" content="l00468467">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="c00511010">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172368902">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring L3VPN Routes to Be Recursed to Manually Configured SR-MPLS TE Policies (DSCP-Based)</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172368902"></a><a name="EN-US_TASK_0172368902"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring L3VPN Routes to Be Recursed to Manually Configured SR-MPLS TE Policies (DSCP-Based)</h1>
<div class="taskbody"><p>This section provides an example for configuring L3VPN routes to be recursed to manually configured SR-MPLS TE Policies based on the DSCP value to ensure secure communication between users of the same VPN.</p>
<div class="context"><a name="EN-US_TASK_0172368902__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><div class="p">On the network shown in <a href="#EN-US_TASK_0172368902__fig_dc_vrp_sr_all_cfg_007701">Figure 1</a>:<ul><li><p>CE1 and CE2 belong to a VPN instance named <strong>vpna</strong>.</p>
</li><li><p>The VPN target used by <strong>vpna</strong> is 111:1.</p>
</li></ul>
</div>
<p>Configure L3VPN routes to be recursed to SR-MPLS TE Policies to ensure secure communication between users of the same VPN. Because multiple links exist between PEs on the public network, other links must be able to provide protection for the primary link.</p>
<div class="fignone" id="EN-US_TASK_0172368902__fig_dc_vrp_sr_all_cfg_007701"><a name="EN-US_TASK_0172368902__fig_dc_vrp_sr_all_cfg_007701"></a><a name="fig_dc_vrp_sr_all_cfg_007701"></a><span class="figcap"><b>Figure 1 </b>L3VPN route recursion to manually configured SR-MPLS TE Policies</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 through 3 in this example represent GE <span>0/1/0</span>, GE <span>0/2/0</span>, and GE <span>0/3/0</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="images/fig_dc_vrp_sr_all_cfg_007701.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172368902__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Precautions</h4><p>If an interface connecting a PE to a CE is bound to a VPN instance, Layer 3 configurations, such as the IP address and routing protocol configuration, on the interface will be deleted. Reconfigure them if needed.</p>
</div></div>
<div class="context"><a name="EN-US_TASK_0172368902__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure IS-IS on the backbone network for the PEs to communicate.</p>
</li><li><p>Enable MPLS and SR for each device on the backbone network, and configure static adjacency SIDs.</p>
</li><li><p>Configure an SR-MPLS TE Policy with primary and backup paths on each PE.</p>
</li><li><p>Establish an MP-IBGP peer relationship between PEs for them to exchange routing information.</p>
</li><li><p>Create a VPN instance and enable the IPv4 address family on each PE. Then, bind each PE's interface connecting the PE to a CE to the corresponding VPN instance.</p>
</li><li><p>Configure an SR-MPLS TE Policy group on each PE and define mappings between the color and DSCP values.</p>
</li><li><p>Configure a tunnel selection policy on each PE for the specified SR-MPLS TE Policy group to be preferentially selected.</p>
</li><li><p>Establish an EBGP peer relationship between each CE-PE pair for the CE and PE to exchange routing information.</p>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172368902__1.4.4"></a><a name="1.4.4"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li><p>MPLS LSR IDs of PEs and Ps</p>
</li><li><p>VPN target and RD of <strong>vpna</strong></p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172368902__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure interface IP addresses for each device on the backbone network.</span><p><p># Configure PE1.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname PE1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack1] <strong>ip address 1.1.1.9 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>ip address 10.13.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1]<strong> interface gigabitethernet<span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>ip address 10.11.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure P1.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname P1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-LoopBack1] <strong>ip address 2.2.2.9 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/1/0</span>] <strong>ip address 10.11.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1]<strong> interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.12.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname PE2</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack1] <strong>ip address 3.3.3.9 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> ip address 10.14.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> interface gigabitethernet<span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> ip address 10.12.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> commit</strong></pre>
<p># Configure P2.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname P2</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-LoopBack1] <strong>ip address 4.4.4.9 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/1/0</span>] <strong>ip address 10.13.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2]<strong> interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.14.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2] <strong>commit</strong></pre>
</p></li><li><span>Configure an IGP for each device on the backbone network to implement interworking between PEs and Ps. In this example, the IGP is IS-IS.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>is-level level-1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>network-entity 10.0000.0000.0001.00</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack1] <strong>isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1]<strong> interface gigabitethernet<span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure P1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-isis-1] <strong>is-level level-1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-isis-1] <strong>network-entity 10.0000.0000.0002.00</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-LoopBack1] <strong>isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/1/0</span>] <strong>isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1]<strong> interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/2/0</span>] <strong>isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>is-level level-1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>network-entity 10.0000.0000.0003.00</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack1] <strong>isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> interface gigabitethernet<span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> commit</strong></pre>
<p># Configure P2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-isis-1] <strong>is-level level-1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-isis-1] <strong>network-entity 10.0000.0000.0004.00</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-LoopBack1] <strong>isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/1/0</span>] <strong>isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2]<strong> interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/2/0</span>] <strong>isis enable 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2] <strong>commit</strong></pre>
</p></li><li><span>Configure basic MPLS functions for each device on the backbone network.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls lsr-id 1.1.1.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-mpls] <strong>quit</strong></pre>
<p># Configure P1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1] <strong>mpls lsr-id 2.2.2.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-mpls] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1-mpls] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls lsr-id 3.3.3.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-mpls]<strong> quit</strong></pre>
<p># Configure P2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2] <strong>mpls lsr-id 4.4.4.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-mpls] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2-mpls] <strong>quit</strong></pre>
</p></li><li><span>Enable SR for each device on the backbone network.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>segment-routing</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing] <strong>ipv4 adjacency local-ip-addr 10.11.1.1 remote-ip-addr 10.11.1.2 sid <span>330</span>000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing] <strong>ipv4 adjacency local-ip-addr 10.13.1.1 remote-ip-addr 10.13.1.2 sid <span>330</span>001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>cost-style wide</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>traffic-eng level-1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>segment-routing mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure P1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1] <strong>segment-routing</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-segment-routing] <strong>ipv4 adjacency local-ip-addr 10.11.1.2 remote-ip-addr 10.11.1.1 sid <span>330</span>003</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-segment-routing] <strong>ipv4 adjacency local-ip-addr 10.12.1.1 remote-ip-addr 10.12.1.2 sid <span>330</span>002</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-segment-routing] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-isis-1] <strong>cost-style wide</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-isis-1] <strong>traffic-eng level-1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-isis-1] <strong>segment-routing mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>segment-routing</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing] <strong>ipv4 adjacency local-ip-addr 10.12.1.2 remote-ip-addr 10.12.1.1 sid <span>330</span>000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing] <strong>ipv4 adjacency local-ip-addr 10.14.1.2 remote-ip-addr 10.14.1.1 sid <span>330</span>001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>cost-style wide</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>traffic-eng level-1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>segment-routing mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure P2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2] <strong>segment-routing</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-segment-routing] <strong>ipv4 adjacency local-ip-addr 10.13.1.2 remote-ip-addr 10.13.1.1 sid <span>330</span>002</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-segment-routing] <strong>ipv4 adjacency local-ip-addr 10.14.1.1 remote-ip-addr 10.14.1.2 sid <span>330</span>003</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-segment-routing] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2] <strong>isis 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-isis-1] <strong>cost-style wide</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-isis-1] <strong>traffic-eng level-1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-isis-1] <strong>segment-routing mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-isis-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2] <strong>commit</strong></pre>
</p></li><li><span>Configure SR-MPLS TE Policies.</span><p><p># Configure PE1. Deploy two SR-MPLS TE Policies (policy100 and policy200) from PE1 to PE2 to carry traffic with different DSCP values.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>segment-routing</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-segment-routing] <strong>segment-list pe1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-segment-list<span>-pe1</span>] <strong>index 10 sid label <span>330</span>000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-segment-list<span>-pe1</span>] <strong>index 20 sid label <span>330</span>002</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-segment-list<span>-pe1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing] <strong>segment-list pe1backup</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-segment-list<span>-pe1backup</span>] <strong>index 10 sid label <span>330</span>001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-segment-list<span>-pe1backup</span>] <strong>index 20 sid label <span>330</span>003</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-segment-list<span>-pe1backup</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing] <strong>sr-te policy policy100</strong> <strong>endpoint 3.3.3.9 color 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy100</span>] <strong>binding-sid 115</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy100</span>] <strong>mtu 1000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy100</span>] <strong>diffserv-mode pipe af1 green</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy100</span>] <strong>candidate-path preference 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy100</span>-path] <strong>segment-list pe1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy100</span>-path] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy100</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing] <strong>sr-te policy policy200</strong> <strong>endpoint 3.3.3.9 color 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy200</span>] <strong>binding-sid 125</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy200</span>] <strong>mtu 1000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy200</span>] <strong>diffserv-mode pipe cs7 red</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy200</span>] <strong>candidate-path preference 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy200</span>-path] <strong>segment-list pe1backup</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy200</span>-path] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy<span>-policy200</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2. Deploy two SR-MPLS TE Policies (policy100 and policy200) from PE2 to PE1 to carry traffic with different DSCP values.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>segment-routing</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-segment-routing] <strong>segment-list pe2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-segment-list<span>-pe2backup</span>] <strong>index 10 sid label <span>330</span>000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-segment-list<span>-pe2backup</span>] <strong>index 20 sid label <span>330</span>003</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-segment-list<span>-pe2backup</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing] <strong>segment-list pe2backup</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-segment-list<span>-pe2backup</span>] <strong>index 10 sid label <span>330</span>001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-segment-list<span>-pe2backup</span>] <strong>index 20 sid label <span>330</span>002</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-segment-list<span>-pe2backup</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing] <strong>sr-te policy policy100</strong> <strong>endpoint 1.1.1.9 color 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy100</span>] <strong>binding-sid 115</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy100</span>] <strong>mtu 1000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy100</span>] <strong>diffserv-mode pipe af1 green</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy100</span>] <strong>candidate-path preference 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy100</span>-path] <strong>segment-list pe2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy100</span>-path] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy100</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing] <strong>sr-te policy policy200</strong> <strong>endpoint 1.1.1.9 color 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy200</span>] <strong>binding-sid 125</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy200</span>] <strong>mtu 1000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy200</span>] <strong>diffserv-mode pipe cs7 red</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy200</span>] <strong>candidate-path preference 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy200</span>-path] <strong>segment-list pe2backup</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy200</span>-path] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy<span>-policy200</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p>After the configuration is complete, run the <a href="cmdqueryname=display+sr-te+policy"><b><span class="cmdname">display sr-te policy</span></b></a> command to check SR-MPLS TE Policy information. The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display sr-te policy</strong> <strong>policy-name</strong><strong> policy100</strong>
PolicyName : policy100
Endpoint             : 3.3.3.9              Color                : 100
TunnelId             : 1                    TunnelType           : SR-TE Policy
Binding SID          : 115                  MTU                  : 1000
Policy State         : Up                   State Change Time    : 2020-04-27 09:23:13
Admin State          : Up                   Traffic Statistics   : Disable
BFD                  : Disable              Backup Hot-Standby   : Disable
DiffServ-Mode        : Pipe, AF1, Green
Active IGP Metric    : -
Candidate-path Count : 1                    

Candidate-path Preference: 100
Path State           : Active               Path Type            : Primary
Protocol-Origin      : Configuration(30)    Originator           : 0, 0.0.0.0
Discriminator        : 100                  Binding SID          : 115
GroupId              : 2                    Policy Name          : policy100
Template ID          : -
Active IGP Metric    : -                              ODN Color            : -
Metric               :
 IGP Metric          : -                              TE Metric            : -
 Delay Metric        : -                              Hop Counts           : -
Segment-List Count   : 1
 Segment-List        : pe1
  Segment-List ID    : 129                  XcIndex              : 68
  List State         : Up                   BFD State            : -
  EXP                : -                    TTL                  : -
  DeleteTimerRemain  : -<span>                    Weight               : 1</span>
  Label : <span>330</span>000, <span>330</span>002</pre>
</p></li><li><span>Establish an MP-IBGP peer relationship between PEs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 3.3.3.9 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 3.3.3.9 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 3.3.3.9 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 1.1.1.9 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 1.1.1.9 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 1.1.1.9 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp] <strong>quit</strong></pre>
<p>After completing the configuration, run the <strong>display bgp peer</strong> or <strong>display bgp vpnv4 all peer</strong> command on each PE. The following example uses the command output on PE1. The command output shows that a BGP peer relationship has been established between the PEs and is in the Established state.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display bgp peer</strong></pre>
<pre class="screen"> BGP local router ID : 1.1.1.9
 Local AS number : 100
 Total number of peers : 1          Peers in established state : 1
  Peer            V    AS  MsgRcvd  MsgSent     OutQ  Up/Down    State        PrefRcv
  3.3.3.9         4   100        2        6     0     00:00:12   <strong>Established</strong>   0</pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display bgp vpnv4 all peer</strong></pre>
<pre class="screen"> BGP local router ID : 1.1.1.9
 Local AS number : 100
 Total number of peers : 1                 Peers in established state : 1
  Peer            V    AS  MsgRcvd  MsgSent    OutQ  Up/Down    State        PrefRcv
  3.3.3.9         4   100   12      18         0     00:09:38   <strong>Established</strong>   0</pre>
</p></li><li><span>Create a VPN instance and enable the IPv4 address family on each PE. Then, bind each PE's interface connecting the PE to a CE to the corresponding VPN instance.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.1.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 200:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.2.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</p></li><li><span>Configure a tunnel selection policy on each PE for the specified SR-MPLS TE Policy group to be preferentially selected.</span><p><p>Configure packets to enter different SR-MPLS TE Policies in the SR-MPLS TE Policy group based on DSCP values. In this example, packets carrying the DSCP value 20 enter policy100 with the color value 100, and those carrying the DSCP value 40 enter policy200 with the color value 200.</p>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>segment-routing</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-segment-routing] <strong>sr-te-policy group 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy-group-1] <strong>endpoint 3.3.3.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy-group-1] <strong>color 100 match dscp ipv4 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy-group-1] <strong>color 200 match dscp ipv4 40</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing-te-policy-group-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-segment-routing] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>tunnel-policy p1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-tunnel-policy-p1] <strong>tunnel binding destination 3.3.3.9 sr-te-policy group 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-tunnel-policy-p1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>tnl-policy p1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>segment-routing</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-segment-routing] <strong>sr-te-policy group 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy-group-1] <strong>endpoint 1.1.1.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy-group-1] <strong>color 100 match dscp ipv4 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy-group-1] <strong>color 200 match dscp ipv4 40</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing-te-policy-group-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-segment-routing] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>tunnel-policy p1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-tunnel-policy-p1] <strong>tunnel binding destination 1.1.1.9 sr-te-policy group 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-tunnel-policy-p1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>tnl-policy p1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p>After the configuration is complete, the headend implements recursion based on the destination address of packets and finds the associated SR-MPLS TE Policy group. According to the DSCP value of the packets, the headend finds the matching color value and then the SR-MPLS TE Policy configured with this color value in the SR-MPLS TE Policy group, thereby achieving DSCP-based traffic steering.</p>
<p>Run the <strong>display sr-te policy group 1</strong> command on each PE to check the SR-MPLS TE Policy group status. PE1 is used as an example.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display sr-te policy group 1</strong></pre>
<pre class="screen">                    SR-TE Policy Group Information
-------------------------------------------------------------------------------
GroupID   : 1                     GroupState  : UP
GTunnelID : 67                    GTunnelType : SR-TE Policy Group
Endpoint  : 3.3.3.9               UP/ALL Num  : 1/1
-------------------------------------------------------------------------------
TunnelId   AfType   Color    State    Dscp
-------------------------------------------------------------------------------
65         IPV4     100      UP       20
66         IPV4     200      UP       40
-------------------------------------------------------------------------------</pre>
</p></li><li><span>Establish an EBGP peer relationship between each CE-PE pair.</span><p><p># Configure CE1.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname CE1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-LoopBack1] <strong>ip address 10.11.1.1 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/0</span>] <strong>ip address 10.1.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1] <strong>bgp 65410</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>peer 10.1.1.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>network 10.11.1.1 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1] <strong>commit</strong></pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The configuration of CE2 is similar to the configuration of CE1. For detailed configurations, see Configuration Files.</p>
</div></div>
<p>After the configuration is complete, run the <strong>display ip vpn-instance verbose</strong> command on the PEs to check VPN instance configurations. Check that each PE can successfully ping its connected CE.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If a PE has multiple interfaces bound to the same VPN instance, use the <strong>-a</strong> <em>source-ip-address</em> parameter to specify a source IP address when running the <strong>ping -vpn-instance</strong> <em>vpn-instance-name</em> <strong>-a</strong> <em>source-ip-address dest-ip-address</em> command to ping the CE that is connected to the remote PE. If the source IP address is not specified, the ping operation may fail.</p>
</div></div>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>peer 10.1.1.1 as-number 65410</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>quit</strong></pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The configuration of PE2 is similar to the configuration of PE1. For detailed configurations, see Configuration Files.</p>
</div></div>
<p>After the configuration is complete, run the <strong>display bgp vpnv4 vpn-instance peer</strong> command on the PEs to check whether BGP peer relationships have been established between the PEs and CEs. If the <strong>Established</strong> state is displayed in the command output, the BGP peer relationships have been established successfully.</p>
<p>The following example uses the command output on PE1 to show that a BGP peer relationship has been established between PE1 and CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display bgp vpnv4 vpn-instance vpna peer</strong></pre>
<pre class="screen"> BGP local router ID : 1.1.1.9
 Local AS number : 100

 VPN-Instance vpna, Router ID 1.1.1.9:
 Total number of peers : 1                 Peers in established state : 1

  Peer            V          AS  MsgRcvd  MsgSent  OutQ  Up/Down       State  PrefRcv
  10.1.1.1        4       65410       91       90     0 01:15:39 <strong>Established</strong>        1</pre>
</p></li><li><span>Verify the configuration.</span><p><p>After completing the configuration, run the <strong>display ip routing-table vpn-instance</strong> <em>vpn-instance-name</em> command on each PE to check information about the loopback interface route toward a CE.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ip routing-table vpn-instance vpna</strong></pre>
<pre class="screen"><span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table: vpna
         Destinations : 7        Routes : 7
Destination/Mask    Proto  Pre  Cost     Flags NextHop         Interface
     10.1.1.0/24    Direct 0    0        D     10.1.1.2        GigabitEthernet<span>0/2/0</span>
     10.1.1.2/32    Direct 0    0        D     127.0.0.1       GigabitEthernet<span>0/2/0</span>
   10.1.1.255/32    Direct 0    0        D     127.0.0.1       GigabitEthernet<span>0/2/0</span>
    <strong>10.11.1.1/32</strong>     EBGP   255  0        RD    10.1.1.1        GigabitEthernet<span>0/2/0</span>
    <strong>10.22.2.2/32</strong>     IBGP   255  0        RD    3.3.3.9         SR-TE Policy Group
      127.0.0.0/8   Direct 0    0        D     127.0.0.1       InLoopBack0
255.255.255.255/32  Direct 0    0        D     127.0.0.1       InLoopBack0</pre>
<p>Run the <strong>display ip routing-table vpn-instance vpna verbose</strong> command on each PE to check details about the loopback interface route toward a CE.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ip routing-table vpn-instance vpna 10.22.2.2 verbose</strong></pre>
<pre class="screen"><span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : vpna
Summary Count : 1

Destination: 10.22.2.2/32         
     Protocol: IBGP               Process ID: 0              
   Preference: 255                      Cost: 0              
      NextHop: 3.3.3.9             Neighbour: 3.3.3.9
        State: Active Adv Relied         Age: 01h18m38s           
          Tag: 0                    Priority: low            
        Label: 48180                 QoSInfo: 0x0           
   IndirectID: 0x10000B9            Instance:                                 
 RelayNextHop: 0.0.0.0             <strong>Interface: SR-TE Policy</strong><strong> Group</strong>
     <strong>TunnelID: 0x000000003300000041 Flags: RD</strong></pre>
<p>The command output shows that the VPN route has been successfully recursed to the specified SR-MPLS TE Policy.</p>
<p>CEs in the same VPN can ping each other. For example, CE1 can ping CE2 at 10.22.2.2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>ping -a 10.11.1.1 10.22.2.2</strong></pre>
<pre class="screen">  PING 10.22.2.2: 56  data bytes, press CTRL_C to break
    Reply from 10.22.2.2: bytes=56 Sequence=1 ttl=251 time=72 ms
    Reply from 10.22.2.2: bytes=56 Sequence=2 ttl=251 time=34 ms
    Reply from 10.22.2.2: bytes=56 Sequence=3 ttl=251 time=50 ms
    Reply from 10.22.2.2: bytes=56 Sequence=4 ttl=251 time=50 ms
    Reply from 10.22.2.2: bytes=56 Sequence=5 ttl=251 time=34 ms
  --- 10.22.2.2 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 34/48/72 ms  </pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172368902__1.4.6"></a><a name="1.4.6"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>PE1 configuration file</p>
<pre class="screen">#
sysname PE1
#
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 100:1
  tnl-policy p1
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
mpls lsr-id 1.1.1.9
#               
mpls            
#               
segment-routing 
 ipv4 adjacency local-ip-addr 10.11.1.1 remote-ip-addr 10.11.1.2 sid <span>330</span>000
 ipv4 adjacency local-ip-addr 10.13.1.1 remote-ip-addr 10.13.1.2 sid <span>330</span>001
 segment-list pe1
  index 10 sid label <span>330</span>000
  index 20 sid label <span>330</span>002
 segment-list pe1backup
  index 10 sid label <span>330</span>001
  index 20 sid label <span>330</span>003
 sr-te-policy group 1
  endpoint 3.3.3.9
  color 100 match dscp ipv4 20
  color 200 match dscp ipv4 40
 sr-te policy policy100 endpoint 3.3.3.9 color 100
  diffserv-mode pipe af1 green
  binding-sid 115
  mtu 1000 
  candidate-path preference 100
   segment-list pe1
 sr-te policy policy200 endpoint 3.3.3.9 color 200
  diffserv-mode pipe cs7 red
  binding-sid 125
  mtu 1000
  candidate-path preference 100
   segment-list pe1backup
#
isis 1          
 is-level level-1
 cost-style wide
 network-entity 10.0000.0000.0001.00
 traffic-eng level-1
 segment-routing mpls
#               
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown  
 ip address 10.13.1.1 255.255.255.0
 isis enable 1  
#               
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown  
 ip binding vpn-instance vpna
 ip address 10.1.1.2 255.255.255.0
#               
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown  
 ip address 10.11.1.1 255.255.255.0
 isis enable 1  
#               
interface LoopBack1
 ip address 1.1.1.9 255.255.255.255
 isis enable 1  
#               
bgp 100         
 peer 3.3.3.9 as-number 100
 peer 3.3.3.9 connect-interface LoopBack1
 #              
 ipv4-family unicast
  undo synchronization
  peer 3.3.3.9 enable
 #              
 ipv4-family vpnv4
  policy vpn-target
  peer 3.3.3.9 enable
 #              
 ipv4-family vpn-instance vpna
  peer 10.1.1.1 as-number 65410
#               
tunnel-policy p1
 tunnel binding destination 3.3.3.9 sr-te-policy group 1
#
return</pre>
</li><li><p>P1 configuration file</p>
<pre class="screen">#
sysname P1
#
mpls lsr-id 2.2.2.9
#               
mpls            
#               
segment-routing 
 ipv4 adjacency local-ip-addr 10.12.1.1 remote-ip-addr 10.12.1.2 sid <span>330</span>002
 ipv4 adjacency local-ip-addr 10.11.1.2 remote-ip-addr 10.11.1.1 sid <span>330</span>003
#               
isis 1          
 is-level level-1
 cost-style wide
 network-entity 10.0000.0000.0002.00
 traffic-eng level-1
 segment-routing mpls
#               
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown  
 ip address 10.11.1.2 255.255.255.0
 isis enable 1  
#               
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown  
 ip address 10.12.1.1 255.255.255.0
 isis enable 1  
#               
interface LoopBack1
 ip address 2.2.2.9 255.255.255.255
 isis enable 1  
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 200:1
  tnl-policy p1
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
mpls lsr-id 3.3.3.9
#               
mpls            
#               
segment-routing 
 ipv4 adjacency local-ip-addr 10.12.1.2 remote-ip-addr 10.12.1.1 sid <span>330</span>000
 ipv4 adjacency local-ip-addr 10.14.1.2 remote-ip-addr 10.14.1.1 sid <span>330</span>001
 segment-list pe2
  index 10 sid label <span>330</span>000
  index 20 sid label <span>330</span>003
 segment-list pe2backup
  index 10 sid label <span>330</span>001
  index 20 sid label <span>330</span>002
 sr-te-policy group 1
  endpoint 1.1.1.9
  color 100 match dscp ipv4 20
  color 200 match dscp ipv4 40
 sr-te policy policy100 endpoint 1.1.1.9 color 100
  diffserv-mode pipe af1 green
  binding-sid 115
  mtu 1000  
  candidate-path preference 100
   segment-list pe2
 sr-te policy policy200 endpoint 1.1.1.9 color 200
  diffserv-mode pipe cs7 red
  binding-sid 125
  mtu 1000
  candidate-path preference 100
   segment-list pe2backup
#               
isis 1          
 is-level level-1
 cost-style wide
 network-entity 10.0000.0000.0003.00
 traffic-eng level-1
 segment-routing mpls
#               
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown  
 ip address 10.14.1.2 255.255.255.0
 isis enable 1  
#               
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown  
 ip binding vpn-instance vpna
 ip address 10.2.1.2 255.255.255.0
#               
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown  
 ip address 10.12.1.2 255.255.255.0
 isis enable 1  
#               
interface LoopBack1
 ip address 3.3.3.9 255.255.255.255
 isis enable 1  
#               
bgp 100         
 peer 1.1.1.9 as-number 100
 peer 1.1.1.9 connect-interface LoopBack1
 #              
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.9 enable
 #              
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.9 enable
 #              
 ipv4-family vpn-instance vpna
  peer 10.2.1.1 as-number 65420
#               
tunnel-policy p1
 tunnel binding destination 1.1.1.9 sr-te-policy group 1
#
return</pre>
</li><li><p>P2 configuration file</p>
<pre class="screen">#
sysname P2
#
mpls lsr-id 4.4.4.9
#               
mpls            
#               
segment-routing 
 ipv4 adjacency local-ip-addr 10.13.1.2 remote-ip-addr 10.13.1.1 sid <span>330</span>002
 ipv4 adjacency local-ip-addr 10.14.1.1 remote-ip-addr 10.14.1.2 sid <span>330</span>003
#               
isis 1          
 is-level level-1
 cost-style wide
 network-entity 10.0000.0000.0004.00
 traffic-eng level-1
 segment-routing mpls
#               
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown  
 ip address 10.13.1.2 255.255.255.0
 isis enable 1  
#               
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown  
 ip address 10.14.1.1 255.255.255.0
 isis enable 1  
#               
interface LoopBack1
 ip address 4.4.4.9 255.255.255.255
 isis enable 1  
#
return</pre>
</li><li><p>CE1 configuration file</p>
<pre class="screen">#
sysname CE1
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.0
#
interface LoopBack1
 ip address 10.11.1.1 255.255.255.255
#
bgp 65410
 peer 10.1.1.2 as-number 100
 #
 ipv4-family unicast
  network 10.11.1.1 255.255.255.255
  peer 10.1.1.2 enable
#
return</pre>
</li><li><p>CE2 configuration file</p>
<pre class="screen">#
sysname CE2
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.2.1.1 255.255.255.0
#
interface LoopBack1
 ip address 10.22.2.2 255.255.255.255
#
bgp 65420
 peer 10.2.1.2 as-number 100
 #
 ipv4-family unicast
  network 10.22.2.2 255.255.255.255
  peer 10.2.1.2 enable
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr_all_cfg_0099.html">Configuration Examples for SR-MPLS TE Policy
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr_all_cfg_0077.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr_all_cfg_0083.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>