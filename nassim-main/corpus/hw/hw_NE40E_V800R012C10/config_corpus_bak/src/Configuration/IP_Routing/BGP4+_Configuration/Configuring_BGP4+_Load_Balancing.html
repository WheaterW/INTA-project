
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Configuring BGP4+ Load Balancing">
<meta name="abstract" content="Configuring BGP4+ load balancing better utilizes network resources.">
<meta name="description" content="Configuring BGP4+ load balancing better utilizes network resources.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_0000.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_5019.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_5000.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="BGP IPv6">
<meta name="featuretype" content="IP Route">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="BGP IPv6">
<meta name="featuretype" content="IP Route">
<meta name="featurename" content="BGP">
<meta name="featuretype" content="IP Routing Basis">
<meta name="OWNER" content="l00425560">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00615954">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172366460">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Configuring BGP4+ Load Balancing</title>
</head>
<body><a name="EN-US_TASK_0172366460"></a><a name="EN-US_TASK_0172366460"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Configuring BGP4+ Load Balancing</h1>
<div class="taskbody"><p>Configuring BGP4+ load balancing better utilizes network resources.</p>
<div class="context"><a name="EN-US_TASK_0172366460__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Usage Scenario</h4><p>On large networks, there may be multiple valid routes to the same destination. BGP4+, however, advertises only the optimal route to its peers. This may result in traffic imbalance.</p>
<p>Either of the following methods can be used to resolve the traffic imbalance:</p>
<ul><li><p>Use BGP4+ route-policies for load balancing. For example, you can use a route-policy to modify the Local_Pref, AS_Path, Origin, or MED attribute of BGP4+ routes to control traffic forwarding paths, helping implement load balancing.</p>
</li><li><p>Use multiple paths to implement traffic load balancing. This method requires that multiple equal-cost routes exist and the number of routes allowed to participate in load balancing be set. Load balancing can be implemented globally or based on a specified peer.</p>
</li></ul>
</div></div>
<div class="context"><a name="EN-US_TASK_0172366460__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Pre-configuration Tasks</h4><p>Before configuring BGP4+ load balancing, <a href="dc_vrp_bgp6_cfg_0003.html">configure basic BGP4+ functions</a>.</p>
</div></div>
<div class="steps-unordered"><a name="EN-US_TASK_0172366460__1.4.3"></a><a name="1.4.3"></a><h4 class="sectiontitle">Procedure</h4>
<ul><li><span>Configure BGP4+ peer or peer group-based load balancing.</span><p><ol><li><p>Run <span><a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span></p>
<p>The system view is displayed.</p>
</li><li><p>Run <span><a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span></p>
<p>The BGP view is displayed.</p>
</li><li>Run <a href="cmdqueryname=ipv6-family"><b><span class="cmdname">ipv6-family</span></b></a> <strong><span>unicast</span></strong><p>The IPv6 unicast address family view is displayed.</p>
</li><li><p>Run <a href="cmdqueryname=peer+load-balancing+as-path-ignore+as-path-relax"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv4-address</span></i><span> | <i><span class="varname">ipv6âaddress</span></i></span> | <i><span class="varname">group-name</span></i> } <strong><span>load-balancing</span></strong> [ <strong><span>as-path-ignore</span></strong> | <strong><span>as-path-relax</span></strong> ]</p>
<p>BGP4+ peer or peer group-based load balancing is configured.</p>
<div class="p">After the <b><span class="cmdname" id="EN-US_TASK_0172366460__en-us_cliref_0172379925_cmdname842149223214504">peer load-balancing</span></b> command is run, BGP peer-based load balancing is implemented only when the following conditions are met:<ul id="EN-US_TASK_0172366460__en-us_cliref_0172379925_ul2107136481214504"><li id="EN-US_TASK_0172366460__en-us_cliref_0172379925_li56940185214504">The routes are received from the specified peer or peer group.</li><li id="EN-US_TASK_0172366460__en-us_cliref_0172379925_li1788359523214504">The optimal route and optimal equal-cost routes exist.</li><li id="EN-US_TASK_0172366460__en-us_cliref_0172379925_li1239035648214504">The AS_Path attribute is the same as that of the optimal route, or <strong><span id="EN-US_TASK_0172366460__en-us_cliref_0172379925_cmdparmname1220747176214504">as-path-ignore</span></strong> or <strong><span id="EN-US_TASK_0172366460__en-us_cliref_0172379925_cmdparmname515733087214504">as-path-relax</span></strong> is specified in the <b><span class="cmdname" id="EN-US_TASK_0172366460__en-us_cliref_0172379925_cmdname793010096214504">peer load-balancing</span></b> command.<ul id="EN-US_TASK_0172366460__en-us_cliref_0172379925_ul197556105214504"><li id="EN-US_TASK_0172366460__en-us_cliref_0172379925_li184423974214504">If <strong><span id="EN-US_TASK_0172366460__en-us_cliref_0172379925_cmdparmname1332584039214504">as-path-ignore</span></strong> is specified, the device ignores comparing AS_Path attributes when selecting routes for load balancing. In this case, routes can participate in load balancing even if their AS_Path attributes are different.</li><li id="EN-US_TASK_0172366460__en-us_cliref_0172379925_li166602571214504">If <strong><span id="EN-US_TASK_0172366460__en-us_cliref_0172379925_cmdparmname1478123328214504">as-path-relax</span></strong> is specified, the device ignores comparing the AS_Path attributes of the same length when selecting routes for load balancing. In this case, routes cannot participate in load balancing if their AS_Path attributes are of different lengths. For example, the AS_Path attribute of route A is <strong id="EN-US_TASK_0172366460__en-us_cliref_0172379925_b28006786214504">10</strong>, and the AS_Path attribute of route B is <strong id="EN-US_TASK_0172366460__en-us_cliref_0172379925_b1200824206214504">10, 20</strong>. Because the two AS_Path attributes are of different lengths, the two routes cannot participate in load balancing.</li></ul>
</li></ul>
</div>
</li><li><p>(Optional) Change load balancing rules.</p>
<ul><li>To prevent the device from comparing AS_Path attributes when selecting routes for load balancing, run the <a href="cmdqueryname=load-balancing+as-path-ignore"><b><span class="cmdname">load-balancing as-path-ignore</span></b></a> command.</li><li>To prevent the device from comparing the AS_Path attributes of the same length when selecting routes for load balancing, run the <a href="cmdqueryname=load-balancing+as-path-relax"><b><span class="cmdname">load-balancing as-path-relax</span></b></a> command.</li><li>To prevent the device from comparing IGP costs when selecting routes for load balancing, run the <a href="cmdqueryname=load-balancing+igp-metric-ignore"><b><span class="cmdname">load-balancing igp-metric-ignore</span></b></a> command.</li></ul>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The address family views supported by the preceding commands are different. When running any of the commands, ensure that the command is run in the correct address family view.</p>
<p>Change load balancing rules based on networking. Exercise caution when running the preceding commands.</p>
</div></div>
</li><li><p>Run <span><a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span></p>
<p>The configuration is committed.</p>
</li></ol>
</p></li><li><span>Configure global BGP4+ load balancing.</span><p><ul><li>Set the maximum number of BGP4+ routes for load balancing.<ol><li><p>Run <span><a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span></p>
<p>The system view is displayed.</p>
</li><li><p>Run <span><a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span></p>
<p>The BGP view is displayed.</p>
</li><li><p>Run <span><a href="cmdqueryname=ipv6-family"><b><span class="cmdname">ipv6-family</span></b></a> <strong><span>unicast</span></strong></span></p>
<p>The IPv6 unicast address family view is displayed.</p>
</li><li><p>Run <a href="cmdqueryname=maximum+load-balancing+ebgp+ibgp+ecmp-nexthop-changed"><b><span class="cmdname">maximum load-balancing</span></b></a> [ <strong><span>ebgp</span></strong> | <strong><span>ibgp</span></strong> ] <i><span class="varname">number</span></i> [ <strong><span>ecmp-nexthop-changed</span></strong> ]</p>
<p>The maximum number of BGP4+ equal-cost routes for load balancing is set.</p>
<ul><li><p><strong><span>ebgp</span></strong> indicates that load balancing is implemented only among EBGP routes.</p>
</li><li><p><strong><span>ibgp</span></strong> indicates that load balancing is implemented only among IBGP routes.</p>
</li><li><p>If neither <strong><span>ebgp</span></strong> nor <strong><span>ibgp</span></strong> is specified, EBGP and IBGP routes can compete for preferred routes to balance traffic, and the number of allowed load-balancing EBGP routes is the same as the number of allowed load-balancing IBGP routes.</p>
</li></ul>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If multiple routes with the same destination address exist on the public network, the system selects the optimal route first. If IBGP routes are optimal, only IBGP routes carry out load balancing. If EBGP routes are optimal, only EBGP routes carry out load balancing. This means that load balancing cannot be implemented using both IBGP and EBGP routes with the same destination address.</p>
</div></div>
</li><li><p>(Optional) Change load balancing rules.</p>
<ul><li>To prevent the device from comparing AS_Path attributes when selecting routes for load balancing, run the <a href="cmdqueryname=load-balancing+as-path-ignore"><b><span class="cmdname">load-balancing as-path-ignore</span></b></a> command.</li><li>To prevent the device from comparing the AS_Path attributes of the same length when selecting routes for load balancing, run the <a href="cmdqueryname=load-balancing+as-path-relax"><b><span class="cmdname">load-balancing as-path-relax</span></b></a> command.</li><li>To prevent the device from comparing IGP costs when selecting routes for load balancing, run the <a href="cmdqueryname=load-balancing+igp-metric-ignore"><b><span class="cmdname">load-balancing igp-metric-ignore</span></b></a> command.</li></ul>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The address family views supported by the preceding commands are different. When running any of the commands, ensure that the command is run in the correct address family view.</p>
<p>Change load balancing rules based on networking. Exercise caution when running the preceding commands.</p>
</div></div>
</li><li><p>Run <span><a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span></p>
<p>The configuration is committed.</p>
</li></ol>
</li></ul>
<ul><li><p>Set the maximum number of EBGP and IBGP routes for load balancing.</p>
<p>This configuration is used in a VPN where a CE is dual-homed to two PEs. When the CE resides in the same AS as only one of the PEs, you can set the maximum number of EBGP and IBGP routes for load balancing so that VPN traffic can be balanced among EBGP and IBGP routes.</p>
<ol><li><p>Run <span><a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span></p>
<p>The system view is displayed.</p>
</li><li><p>Run <span><a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span></p>
<p>The BGP view is displayed.</p>
</li><li><p>Run <span><a href="cmdqueryname=ipv6-family"><b><span class="cmdname">ipv6-family</span></b></a> <strong><span>vpn-instance</span></strong> <i><span class="varname">vpn-instance-name</span></i></span></p>
<p>The BGP-VPN instance IPv6 address family view is displayed.</p>
</li><li><p>Run <a href="cmdqueryname=maximum+load-balancing+eibgp+ecmp-nexthop-changed"><b><span class="cmdname">maximum load-balancing eibgp</span></b></a> <i><span class="varname">number</span></i> [ <strong><span>ecmp-nexthop-changed</span></strong> ]</p>
<p>The maximum number of EBGP and IBGP routes for load balancing is set.</p>
<p>After the <a href="cmdqueryname=maximum+load-balancing+eibgp"><b><span class="cmdname">maximum load-balancing eibgp</span></b></a> <i><span class="varname">number</span></i> command is run on a device, the device, by default, changes the next hop of each BGP4+ route to itself before advertising the route to a peer, regardless of whether the route is to be used for load balancing. However, in RR or BGP confederation scenarios, the device does not change the next hop addresses of non-local routes to be advertised to a local address. As a result, besides the routes for load-balancing, those routes that are not supposed to participate in load balancing divert traffic to the device, which overburdens the device. To address this problem, you can set <strong><span>ecmp-nexthop-changed</span></strong> so that the device changes the next hop of only the BGP4+ routes that are to be used for load balancing to itself before advertising them to peers.</p>
</li><li><p>(Optional) Change load balancing rules.</p>
<ul><li>To prevent the device from comparing AS_Path attributes when selecting routes for load balancing, run the <a href="cmdqueryname=load-balancing+as-path-ignore"><b><span class="cmdname">load-balancing as-path-ignore</span></b></a> command.</li><li>To prevent the device from comparing the AS_Path attributes of the same length when selecting routes for load balancing, run the <a href="cmdqueryname=load-balancing+as-path-relax"><b><span class="cmdname">load-balancing as-path-relax</span></b></a> command.</li><li>To prevent the device from comparing IGP costs when selecting routes for load balancing, run the <a href="cmdqueryname=load-balancing+igp-metric-ignore"><b><span class="cmdname">load-balancing igp-metric-ignore</span></b></a> command.</li></ul>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The address family views supported by the preceding commands are different. When running any of the commands, ensure that the command is run in the correct address family view.</p>
<p>Change load balancing rules based on networking. Exercise caution when running the preceding commands.</p>
</div></div>
</li><li><p>Run <span><a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span></p>
<p>The configuration is committed.</p>
</li></ol>
</li><li>Configure load balancing among VPN unicast routes and leaked routes.<p>This configuration is mainly used in an EIBGP load balancing scenario where a CE that is single-homed to a PE accesses a CE that is dual-homed to PEs. As shown in <a href="#EN-US_TASK_0172366460__fig9635181442219">Figure 1</a>, CE2 is dual-homed to PE1 and PE2. CE1 and CE2 are connected to PE1, and CE2 and CE3 are connected to PE2. When CE1 or CE3 needs to access CE2, you can configure load balancing among VPN unicast routes and leaked routes on PE1 and PE2. In this manner, when CE1 or CE3 accesses CE2, load balancing can be implemented through PE1 and PE2, that is, load balancing among VPN routes and leaked routes.</p>
<div class="fignone" id="EN-US_TASK_0172366460__fig9635181442219"><a name="EN-US_TASK_0172366460__fig9635181442219"></a><a name="fig9635181442219"></a><span class="figcap"><b>Figure 1 </b>Load balancing among VPN unicast routes and leaked routes</span><br><span><img class="vsd" src="figure/en-us_image_0000001159076430.png" width="NaN" height="NaN"></span></div>
<ol><li>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a><p>The system view is displayed.</p>
</li><li>Run <a href="cmdqueryname=ip+vpn-instance"><b><span class="cmdname">ip vpn-instance</span></b></a> <i><span class="varname">vpn-instance-name</span></i><p>A VPN instance is created, and its view is displayed.</p>
</li><li>Run <a href="cmdqueryname=route-distinguisher"><b><span class="cmdname">route-distinguisher</span></b></a> <i><span class="varname">route-distinguisher</span></i><p>An RD is configured for the VPN instance.</p>
</li><li>Run <a href="cmdqueryname=apply-label+per-nexthop+per-route+pop-go"><b><span class="cmdname">apply-label</span></b></a> {<strong> </strong><strong><span>per-nexthop</span></strong> | <strong><span>per-route</span></strong> } <strong><span>pop-go</span></strong><p>A label distribution mode is configured for the current VPN.</p>
</li><li><p>Run <a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></p>
<p>The VPN instance view is displayed.</p>
</li><li>Run <a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a><p>The system view is displayed.</p>
</li><li>Run <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i><p>The BGP view is displayed.</p>
</li><li>Run <a href="cmdqueryname=ipv6-family+vpn-instance"><b><span class="cmdname">ipv6-family</span></b></a> <strong><span>vpn-instance</span></strong> <i><span class="varname">vpn-instance-name</span></i><p>The BGP-VPN instance IPv6 address family view is displayed.</p>
</li><li><p>Run <a href="cmdqueryname=load-balancing++local-learning+cross"><b><span class="cmdname">load-balancing local-learning cross</span></b></a></p>
<p>Load balancing among VPN unicast routes and leaked routes is configured.</p>
<p>The <a href="cmdqueryname=load-balancing+local-learning+cross"><b><span class="cmdname">load-balancing local-learning cross</span></b></a> command can be run only after the <a href="cmdqueryname=apply-label+per-nexthop+per-route+pop-go"><b><span class="cmdname">apply-label</span></b></a> {<strong> </strong><strong><span>per-nexthop</span></strong> | <strong><span>per-route</span></strong> } <strong><span>pop-go</span></strong> command is run in the corresponding address family view of the VPN instance. If the <a href="cmdqueryname=apply-label+per-nexthop+per-route+pop-go"><b><span class="cmdname">apply-label</span></b></a> {<strong> </strong><strong><span>per-nexthop</span></strong> | <strong><span>per-route</span></strong> } <strong><span>pop-go</span></strong> command is not run, routing loops may occur between PEs.</p>
<p>The <a href="cmdqueryname=load-balancing+local-learning+cross"><b><span class="cmdname">load-balancing local-learning cross</span></b></a> command is mutually exclusive with the <a href="cmdqueryname=segment-routing+ipv6+locator+evpn"><b><span class="cmdname">segment-routing ipv6 locator evpn</span></b></a>, <a href="cmdqueryname=segment-routing+ipv6+locator"><b><span class="cmdname">segment-routing ipv6 locator</span></b></a>, <a href="cmdqueryname=vxlan+vni"><b><span class="cmdname">vxlan vni</span></b></a>, and <a href="cmdqueryname=evpn+mpls+routing-enable"><b><span class="cmdname">evpn mpls routing-enable</span></b></a> commands.</p>
</li><li>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a><p>The configuration is committed.</p>
</li></ol>
</li></ul>
</p></li></ul></div>
<div class="example"><a name="EN-US_TASK_0172366460__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Follow-up Procedure</h4><p>When BGP4+ routes carrying the link bandwidth extended community attribute are available for load balancing and they all recurse to IP routes or tunnels, you can run the <a href="cmdqueryname=load-balancing+ucmp"><b><span class="cmdname">load-balancing ucmp</span></b></a> command in the BGP-IPv6 unicast address family view to implement unequal-cost load balancing among BGP4+ routes based on the link bandwidth extended community attribute. With this function, when there are multiple egress devices to the destination, unequal-cost load balancing can be implemented based on the actual bandwidth capability of each egress device. The methods of configuring the link bandwidth extended community attribute are as follows:</p>
<ul><li>Use <a href="dc_vrp_xpl_cfg_0017.html#EN-US_CONCEPT_0172366625__section856910644816">XPL to configure the link bandwidth extended community attribute</a>.</li><li>Run the <a href="cmdqueryname=peer+generate-link-bandwidth"><b><span class="cmdname">peer generate-link-bandwidth</span></b></a> command to configure the local device to obtain the link bandwidth of a specified directly connected EBGP peer and generate the extended community attribute accordingly.</li></ul>
</div>
<div class="postreq"><a name="EN-US_TASK_0172366460__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Verifying the Configuration</h4><p>After the configuration is complete, verify it.</p>
<p>Run the <a href="cmdqueryname=display+bgp+ipv6+routing-table"><b><span class="cmdname">display bgp ipv6 routing-table</span></b></a> <i><span class="varname">ipv6-address</span></i> <i><span class="varname">prefix-length</span></i> command to check routes in the BGP4+ routing table.</p>
</div></div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_0000.html">BGP4+ Configuration
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_5019.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_5000.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>