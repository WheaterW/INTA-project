
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Setting the Next_Hop Attribute">
<meta name="abstract" content="BGP4+ route selection can be flexibly controlled by setting the Next_Hop attribute.">
<meta name="description" content="BGP4+ route selection can be flexibly controlled by setting the Next_Hop attribute.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_0019.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_0023.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_0025.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,bgpvrp,w00556928,w00606909,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="BGP IPv6">
<meta name="featuretype" content="IP Route">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="BGP IPv6">
<meta name="featuretype" content="IP Route">
<meta name="featurename" content="BGP IPv6">
<meta name="featuretype" content="IP Route">
<meta name="featurename" content="BGP">
<meta name="featuretype" content="IP Routing Basis">
<meta name="OWNER" content="w00604599">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00615954">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172366446">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Setting the Next_Hop Attribute</title>
</head>
<body><a name="EN-US_TASK_0172366446"></a><a name="EN-US_TASK_0172366446"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Setting the Next_Hop Attribute</h1>
<div class="taskbody"><p>BGP4+ route selection can be flexibly controlled by setting the Next_Hop attribute.</p>
<div class="context"><a name="EN-US_TASK_0172366446__1.4.1"></a><a name="1.4.1"></a><h4 class="sectiontitle">Context</h4>
<div class="p"><p>The Next_Hop attribute of BGP4+ is different from that of an IGP because it is not necessarily the IPv6 address of a neighboring <span class="keyword">Router</span>.</p>
</div></div>
<div class="steps-unordered"><a name="EN-US_TASK_0172366446__1.4.2"></a><a name="1.4.2"></a><h4 class="sectiontitle">Procedure</h4>
<ul><li><span>Change the next-hop address when advertising a route to an IBGP peer.</span><p><p>Perform the following steps on the IBGP <span class="keyword">Router</span>:</p>
</p><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span><p><p>The BGP view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv6-family"><b><span class="cmdname">ipv6-family</span></b></a> <strong><span>unicast</span></strong></span><p><p>The IPv6 unicast address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=peer"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv6-address</span></i> | <i><span class="varname">group-name</span></i> } <a href="cmdqueryname=next-hop-local"><b><span class="cmdname">next-hop-local</span></b></a></span><p><p>The device is configured to use its own IP address as the next-hop address of the routes when advertising them.</p>
</p><p><p>To ensure that an IBGP peer can find the correct next hop, you can configure the local device to use its own address as the next-hop address of each route when the local device advertises routes to the IBGP peer.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If BGP load balancing is configured, the local <span class="keyword">Router</span> changes the next-hop address of a route to its own IP address when advertising the route to an IBGP peer, regardless of whether the <a href="cmdqueryname=peer+next-hop-local"><b><span class="cmdname">peer next-hop-local</span></b></a> command is run.</p>
</div></div>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li><li><span>Configure a device to retain the original Next_Hop of imported IGP routes when the device advertises the routes to an IBGP peer.</span><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span><p><p>The BGP view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv6-family"><b><span class="cmdname">ipv6-family</span></b></a> <strong><span>unicast</span></strong></span><p><p>The IPv6 unicast address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=peer+next-hop-invariable+include-static-route"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">peerIpv6Addr</span></i> | <i><span class="varname">peerGroupName</span></i> } <strong><span>next-hop-invariable</span></strong> [ <strong><strong><span>include-static-route</span></strong></strong> | <strong><strong><span>include-unicast-route</span></strong></strong> ] <sup>*</sup></span><p><p>The device is configured not to change the next hop address of an imported IGP route when advertising the route.</p>
</p><p><p>If the <strong><span>peer next-hop-invariable include-static-route</span></strong> command is run, the BGP speaker retains the original next hop address of an imported public network static route when advertising the route to an IBGP peer under the condition that the original next hop address is valid; if the original next hop address of the static route is invalid, the public network static route recurses to a VPN route, or the public network static route is imported from a VPN instance, the BGP speaker uses its interface address as the next hop of the route.</p>
<p>If the <strong><span>peer next-hop-invariable include-unicast-route</span></strong> command is run, the BGP speaker does not change the next hop address when advertising to an EBGP peer the unicast routes learned from another peer.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li><li><span>Prevent an ASBR from changing the next hop address when advertising routes to an EBGP peer.</span><p><p>Perform the following steps on a PE:</p>
</p><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span><p><p>The BGP view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv6-family"><b><span class="cmdname">ipv6-family</span></b></a> <strong><span>vpnv6</span></strong> [ <strong><span>unicast</span></strong> ]</span><p><p>The BGP-VPNv6 unicast address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run the <a href="cmdqueryname=peer"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv6-address</span></i> | <i><span class="varname">group-name</span></i> } <a href="cmdqueryname=next-hop-invariable"><b><span class="cmdname">next-hop-invariable</span></b></a> command to configure the device not to change the next hop when advertising routes to the specified EBGP peer. Alternatively, run the <a href="cmdqueryname=peer+next-hop-invariable+include-static-route"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv6-address</span></i> | <i><span class="varname">group-name</span></i> } <strong><span>next-hop-invariable</span></strong>  [ <strong><span>include-static-route</span></strong> | <strong><span>include-unicast-route</span></strong> ]<sup> *</sup> command.</span><p><p>If the <strong><span>peer next-hop-invariable include-static-route</span></strong> command is run, the BGP speaker retains the original next hop address of an imported static route when it advertises the static route to the specified IBGP peer. However, the local interface address is used as the next hop in the following situations: (1) The imported static route is a public network static route, and its original next hop is invalid. (2) The imported static route is a public network static route, and its original next hop recurses to a VPN route. (3) The imported static route is a VPN static route and is imported from the public network instance.</p>
<p>If the <strong><span>peer next-hop-invariable include-unicast-route</span></strong> command is run, the BGP speaker does not change the next hop address when advertising to an EBGP peer the unicast routes learned from another peer.</p>
</p><p><div class="p">On the network shown in <a href="#EN-US_TASK_0172366446__fig434343516016">Figure 1</a>, a BGP LSP is established between PE1 and PE2. <span>VPNv6</span> routes are exchanged between PE1 and RR1, between RR1 and RR2, and between RR2 and PE2 through BGP <span>VPNv6</span> peer relationships.<div class="fignone" id="EN-US_TASK_0172366446__fig434343516016"><a name="EN-US_TASK_0172366446__fig434343516016"></a><a name="fig434343516016"></a><span class="figcap"><b>Figure 1 </b>Inter-AS VPN Option C networking with RRs deployed</span><br><span><img class="vsd" src="figure/en-us_image_0000001402412029.png" width="NaN" height="NaN"></span></div>
</div>
<div class="p">Assume that PE1 needs to advertise a <span>VPNv6</span> route to PE2. The route will be advertised through the following process:<ol type="a"><li>PE1 advertises the route to RR1, with the route next hop being PE1.</li><li>Upon receipt, RR1 changes the route next hop to itself and then advertises the route to RR2 through the EBGP peer relationship.</li><li>RR2 advertises the received route to its IBGP peer PE2. By default, the <span class="keyword">Router</span> changes the next hop of a labeled route received from an EBGP peer before advertising the route to an IBGP peer. Therefore, RR2 changes the next hop of the route to itself before advertising the route to PE2.</li></ol>
The next hop of the <span>VPNv6</span> route received by PE2 is RR2. However, the destination of the BGP LSP is PE1. As a result, the <span>VPNv6</span> route on PE2 cannot recurse to the BGP LSP, causing traffic interruption.</div>
<p>To solve the preceding problem, run the <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">peer next-hop-invariable</span></b></a> command on RR1 to ensure that RR1 does not change the next hop address when advertising routes to RR2. In addition, run the <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">peer next-hop-invariable</span></b></a> command on RR2 to ensure that the next hop of the route advertised by RR2 to PE2 is not changed. In this way, the next hop of the <span>VPNv6</span> route received by PE2 is PE1, and the route can recurse to the BGP LSP.</p>
<p>Similar to the preceding process, if PE2 also attempts to advertise a <span>VPNv6</span> route to PE1, run the <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">peer next-hop-invariable</span></b></a> command on both RR2 and RR1 so that RR2 does not change the next hop before advertising the route to RR1 and RR1 does not change the next hop before advertising the route to PE1. In this way, the <span>VPNv6</span> route received by PE1 is PE2, and the route can recurse to the BGP LSP.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li><li><span>Configure route-policy-based next hop recursion.</span><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span><p><p>The BGP view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv6-family"><b><span class="cmdname">ipv6-family</span></b></a> <strong><span>unicast</span></strong></span><p><p>The IPv6 unicast address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=nexthop+recursive-lookup+route-policy"><b><span class="cmdname">nexthop recursive-lookup</span></b></a> <span>{ </span><strong><span>route-policy</span></strong> <i><span class="varname">route-policy-name</span></i><span> | <strong><span>route-filter</span></strong> <i><span class="varname">route-filter-name</span></i> }</span></span><p><p>Route-policy-based next hop recursion is configured.</p>
</p><p><p>Next-hop recursion based on a specified route-policy can control the recursive next hop based on specific conditions. If a route fails to match the specified route-policy, the route recursion fails.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li><li><span>Prevent the device from changing the next hop address of a route to ensure that traffic is transmitted along the optimal route when the device advertises the route to a peer in the following scenarios:</span><p><ul><li>The route is learned from a directly connected peer and is to be advertised to a directly connected EBGP peer, the original next hop of the route resides on the same network segment as the local interface that is used to establish the BGP4+ peer relationship with the EBGP peer, and directly connected interfaces are broadcast interfaces.</li><li>The route is locally imported and is to be advertised to a directly connected IBGP or EBGP peer, the next hop to which the route recurses resides on the same network segment as the local interface that is used to establish the BGP4+ peer relationship with the IBGP or EBGP peer, and directly connected interfaces are broadcast interfaces.</li></ul>
</p><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span><p><p>The BGP view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv6-family"><b><span class="cmdname">ipv6-family</span></b></a> <strong><span>unicast</span></strong></span><p><p>The IPv6 unicast address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=nexthop+third-party"><b><span class="cmdname">nexthop third-party</span></b></a></span><p><p>The device is prevented from changing the next hop address of a route when the device advertises the route to a peer in the specified scenarios.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li></ul></div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_0019.html">Controlling BGP4+ Route Selection
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_0023.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp6_cfg_0025.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>