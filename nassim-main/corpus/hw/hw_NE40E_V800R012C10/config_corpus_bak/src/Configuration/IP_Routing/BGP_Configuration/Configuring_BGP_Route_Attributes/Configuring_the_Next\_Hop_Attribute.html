
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Configuring the Next_Hop Attribute">
<meta name="abstract" content="Configuring the Next_Hop attribute allows for flexible control of BGP route selection.">
<meta name="description" content="Configuring the Next_Hop attribute allows for flexible control of BGP route selection.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp_cfg_3010.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp_cfg_4014.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp_cfg_4016.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00606909">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="BGP">
<meta name="featuretype" content="IP Route">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="BGP">
<meta name="featuretype" content="IP Route">
<meta name="featurename" content="BGP">
<meta name="featuretype" content="IP Route">
<meta name="featurename" content="BGP">
<meta name="featuretype" content="IP Routing Basis">
<meta name="OWNER" content="l00425560">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00615954">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172366170">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Configuring the Next_Hop Attribute</title>
</head>
<body><a name="EN-US_TASK_0172366170"></a><a name="EN-US_TASK_0172366170"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Configuring the Next_Hop Attribute</h1>
<div class="taskbody"><p>Configuring the Next_Hop attribute allows for flexible control of BGP route selection.</p>
<div class="steps-unordered"><a name="EN-US_TASK_0172366170__1.4.1"></a><a name="1.4.1"></a><h4 class="sectiontitle">Procedure</h4>
<ul><li><span>Configure the device to change the next hop address of a route when the device advertises the route to an IBGP peer.</span><p><p>When an ASBR learns a route from an EBGP peer and forwards the route to IBGP peers, the ASBR does not change the next hop of the route by default. However, the next hop of the route sent by the EBGP peer is the peer address of the EBGP peer. After the IBGP peers in the AS to which the local peer belongs receive the route, the route is inactive because its next hop is unreachable. To address this problem, configure the ASBR to change the next hop of the route learned from an EBGP peer to the ASBR's own address before the ASBR advertises the route to an IBGP peer. As an IGP runs within the AS, the next hop of the route is reachable to the IBGP peer. As such, the route received by the IBGP peer is active.</p>
</p><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span><p><p>The BGP view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv4-family+unicast"><b><span class="cmdname">ipv4-family</span></b></a> <strong><span>unicast</span></strong></span><p><p>The IPv4 unicast address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=peer+next-hop-local"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv4-address</span></i> | <i><span class="varname">group-name</span></i> } <a href="cmdqueryname=peer+next-hop-local"><b><span class="cmdname">next-hop-local</span></b></a></span><p><p>The device is configured to change the next hop address of a route to the local address before the device advertises the route.</p>
</p><p><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If BGP load balancing is configured, the local device changes the next hop address of a route to the local address when advertising the route to an IBGP peer or peer group, regardless of whether the <a href="cmdqueryname=peer+next-hop-local"><b><span class="cmdname">peer next-hop-local</span></b></a> command is run.</p>
</div></div>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li><li><span>Configure a device to retain the original Next_Hop of imported IGP routes when the device advertises the routes to an IBGP peer.</span><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span><p><p>The BGP view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv4-family+unicast"><b><span class="cmdname">ipv4-family</span></b></a> <strong><span>unicast</span></strong></span><p><p>The IPv4 unicast address family view is displayed.</p>
</p></li><li class="substepexpand"><span>To configure the device not to change the next hop address of an imported IGP route when the device advertises the IGP route, run either of the following commands as required:</span><p><p>Run the <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv4-address</span></i> | <i><span class="varname">group-name</span></i> } <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">next-hop-invariable</span></b></a> command to configure the device not to change the next hop address of an imported IGP route when the device advertises the route to the specified peer.</p>
<p>Run the <a href="cmdqueryname=peer"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv4-address</span></i> | <i><span class="varname">group-name</span></i> } <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">next-hop-invariable</span></b></a><strong><span> include-static-route</span></strong> command to configure the BGP speaker to retain the original next hop address of an imported static route when it advertises the static route to the specified IBGP peer. However, the local interface address is used as the next hop in the following situations: (1) The imported static route is a public network static route, and its original next hop is invalid. (2) The imported static route is a public network static route, and its original next hop recurses to a VPN route. (3) The imported static route is a VPN static route and is imported from the public network instance.</p>
<p>Run the <a href="cmdqueryname=peer"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv4-address</span></i> | <i><span class="varname">group-name</span></i> } <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">next-hop-invariable</span></b></a><strong><span> include-unicast-route</span></strong> command to configure the BGP speaker not to change the next hop address when advertising a unicast route learned from a peer to the specified EBGP peer.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li><li><span>Prevent an ASBR from changing the next hop address of a route when the ASBR advertises the route to an EBGP peer.</span><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span><p><p>The BGP view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv4-family+vpnv4+unicast"><b><span class="cmdname">ipv4-family</span></b></a> <strong><span>vpnv4</span></strong> [ <strong><span>unicast</span></strong> ]</span><p><p>The BGP-VPNv4 address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">group-name</span></i> | <i><span class="varname">ipv4-address</span></i> } <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">next-hop-invariable</span></b></a></span><p><p>The device is configured not to change the next hop address of a route before the device advertises the route to an EBGP peer.</p>
</p><p><p>In an inter-AS VPN Option C scenario where an RR is deployed, the <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">peer next-hop-invariable</span></b></a> command needs to be run on the RR to prevent the RR from changing the next hop address of a route before the RR advertises the route to an EBGP peer. This ensures that the remote PE forwards traffic through the BGP LSP destined for the local PE.</p>
<div class="p">On the network shown in <a href="#EN-US_TASK_0172366170__fig_peer_next-hop-invariable">Figure 1</a>, a BGP LSP is established between PE1 and PE2. VPNv4 routes are exchanged through BGP-VPNv4 peer relationships established between PE1 and RR1, between RR1 and RR2, and between RR2 and PE2.<div class="fignone" id="EN-US_TASK_0172366170__fig_peer_next-hop-invariable"><a name="EN-US_TASK_0172366170__fig_peer_next-hop-invariable"></a><a name="fig_peer_next-hop-invariable"></a><span class="figcap"><b>Figure 1 </b>Inter-AS VPN Option C networking with RRs deployed</span><br><span><img class="vsd" src="figure/en-us_image_0206849170.png" width="NaN" height="NaN"></span></div>
</div>
<div class="p">If PE1 needs to advertise a VPNv4 route to PE2, the following process is implemented:<ol type="a"><li>PE1 advertises the route to RR1, and the route next hop is PE1.</li><li>Upon receipt, RR1 changes the route next hop to itself and then advertises the route to RR2 through the EBGP peer relationship.</li><li>RR2 advertises the received route to its IBGP peer PE2. By default, the <span class="keyword">Router</span> changes the next hop address of a labeled route received from an EBGP peer before advertising the labeled route to an IBGP peer. Therefore, RR2 changes the next hop address of the route to its own address before advertising the route to PE2.</li></ol>
The next hop of the VPNv4 route received by PE2 is RR2. However, the destination of the BGP LSP is PE1. As a result, the VPNv4 route on PE2 cannot recurse to the BGP LSP, causing traffic interruption.</div>
<p>To solve the preceding problem, run the <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">peer next-hop-invariable</span></b></a> command on RR1 to ensure that RR1 does not change the next hop address when advertising routes to RR2. In addition, run the <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">peer next-hop-invariable</span></b></a> command on RR2 to ensure that the next hop of the route advertised by RR2 to PE2 is not changed. In this way, the next hop of the route received by PE2 is PE1, and the VPNv4 route on PE2 can recurse to the BGP LSP properly.</p>
<p>Similar to the preceding process, if PE2 also attempts to advertise a VPNv4 route to PE1, run the <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">peer next-hop-invariable</span></b></a> command on both RR2 and RR1 so that RR2 does not change the next hop before advertising the route to RR1 and RR1 does not change the next hop before advertising the route to PE1. In this way, the next hop of the route received by PE1 is PE2, and the VPNv4 route on PE1 can recurse to the BGP LSP properly.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li><li><span>Configure route-policy-based next hop recursion.</span><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span><p><p>The BGP view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv4-family+unicast"><b><span class="cmdname">ipv4-family</span></b></a> <strong><span>unicast</span></strong></span><p><p>The IPv4 unicast address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=nexthop+recursive-lookup+route-policy"><b><span class="cmdname">nexthop recursive-lookup</span></b></a> <span>{ </span><strong><span>route-policy</span></strong> <i><span class="varname">route-policy-name</span></i><span> | <strong><span>route-filter</span></strong> <i><span class="varname">route-filter-name</span></i> }</span></span><p><p>Route-policy-based next hop recursion is configured.</p>
</p><p><p>Route-policy-based next hop recursion helps flexibly control the recursion result based on specific conditions. If a route does not match the specified route-policy, the route fails to recurse.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li><li><span>Prevent the device from changing the next hop address of a route to ensure that traffic is transmitted along the optimal route when the device advertises the route to a peer in the following scenarios:</span><p><ul><li>The route is learned from a directly connected peer and is to be advertised to a directly connected EBGP peer, the original next hop of the route resides on the same network segment as the local interface that is used to establish the BGP peer relationship with the EBGP peer, and all directly connected interfaces are broadcast interfaces.</li><li>The route is locally imported and is to be advertised to a directly connected IBGP or EBGP peer, the next hop to which the route recurses resides on the same network segment as the local interface that is used to establish the BGP peer relationship with the peer end, and all directly connected interfaces are broadcast interfaces.</li></ul>
</p><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i></span><p><p>The BGP view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv4-family+unicast"><b><span class="cmdname">ipv4-family</span></b></a> <strong><span>unicast</span></strong></span><p><p>The IPv4 unicast address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=nexthop+third-party"><b><span class="cmdname">nexthop third-party</span></b></a></span><p><p>The device is prevented from changing the next hop address of a route when the device advertises the route to a peer in the specified scenarios.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
<p><div class="p">On the network shown in <a href="#EN-US_TASK_0172366170__fig_nexthop_third-party">Figure 2</a>, <span class="keyword">Device</span>A establishes EBGP peer relationships with <span class="keyword">Device</span>B and <span class="keyword">Device</span>C. <span class="keyword">Device</span>B and <span class="keyword">Device</span>C do not establish a peer relationship with each other.<div class="fignone" id="EN-US_TASK_0172366170__fig_nexthop_third-party"><a name="EN-US_TASK_0172366170__fig_nexthop_third-party"></a><a name="fig_nexthop_third-party"></a><span class="figcap"><b>Figure 2 </b>Network diagram of Layer 2 transparent transmission</span><br><span><img class="vsd" src="figure/en-us_image_0206817756.png" width="NaN" height="NaN"></span></div>
</div>
<div class="p">Assume that <span class="keyword">Device</span>A receives an EBGP route 1.1.1.1 from <span class="keyword">Device</span>B. If the <a href="cmdqueryname=nexthop+third-party"><b><span class="cmdname">nexthop third-party</span></b></a> command is not run, the next hop address of the route is changed as follows:<ol><li>Before <span class="keyword">Device</span>B advertises the route 1.1.1.1 to <span class="keyword">Device</span>A, <span class="keyword">Device</span>B changes the next hop to 192.168.10.1.</li><li>Before <span class="keyword">Device</span>A advertises the route 1.1.1.1 to <span class="keyword">Device</span>C, <span class="keyword">Device</span>A changes the next hop to 192.168.10.2.</li></ol>
</div>
<p>When traffic is transmitted from <span class="keyword">Device</span>C to <span class="keyword">Device</span>B, the traffic passes through <span class="keyword">Device</span>A.</p>
<div class="p">After the <a href="cmdqueryname=nexthop+third-party"><b><span class="cmdname">nexthop third-party</span></b></a> command is run on <span class="keyword">Device</span>A, the next hop address of the route 1.1.1.1 is changed as follows:<ol><li>Before <span class="keyword">Device</span>B advertises the route 1.1.1.1 to <span class="keyword">Device</span>A, <span class="keyword">Device</span>B changes the route next hop to 192.168.10.1.</li><li>Before <span class="keyword">Device</span>A advertises the route to <span class="keyword">Device</span>C, <span class="keyword">Device</span>A detects that the address (192.168.10.2) of its local interface that is used to establish the BGP peer relationship with <span class="keyword">Device</span>C belongs to the same network segment as the original next hop address 192.168.10.1 of the route. Therefore, <span class="keyword">Device</span>A does not change the next hop address of the route. As a result, the next hop address of the BGP route 1.1.1.1 received by <span class="keyword">Device</span>C remains 192.168.10.1.</li></ol>
</div>
<p>In this way, traffic from <span class="keyword">Device</span>C can be directly forwarded to <span class="keyword">Device</span>B, without passing through <span class="keyword">Device</span>A.</p>
</p></li></ul></div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp_cfg_3010.html">Configuring BGP Route Attributes
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp_cfg_4014.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_bgp_cfg_4016.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>