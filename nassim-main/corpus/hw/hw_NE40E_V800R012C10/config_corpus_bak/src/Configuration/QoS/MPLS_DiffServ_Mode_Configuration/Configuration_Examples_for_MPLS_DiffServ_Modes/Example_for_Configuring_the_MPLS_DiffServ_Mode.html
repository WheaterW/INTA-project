
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring the MPLS DiffServ Mode">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_qos_cfg_2005.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,w00556928,w00606909,mplsmvrp,z00809835,m00390128,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="MPLS QoS">
<meta name="featuretype" content="QOS">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="MPLS QoS">
<meta name="featuretype" content="QOS">
<meta name="featurename" content="MPLS QoS">
<meta name="featuretype" content="QOS">
<meta name="featurename" content="MPLS Qos">
<meta name="featuretype" content="QOS">
<meta name="OWNER" content="m00390128,s00826690">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="m00390128">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172371593">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring the MPLS DiffServ Mode</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172371593"></a><a name="EN-US_TASK_0172371593"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring the MPLS DiffServ Mode</h1>
<div class="taskbody"><div class="context"><a name="EN-US_TASK_0172371593__1.3.1"></a><a name="1.3.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>As shown in <a href="#EN-US_TASK_0172371593__fig_dc_ne_qos_cfg_200601">Figure 1</a>, CE1 and CE3 belong to VPN-A, and CE2 and CE4 belong to VPN-B. The VPN-target attribute used by VPN-A is 111:1, and that used by VPN-B is 222:2. Users in different VPNs cannot communicate with each other. It is required to set the MPLS DiffServ mode to Pipe on PE1 and PE2 so that data services in the VPN are forwarded based on the priority configured by the carrier on the MPLS network, and the P node also needs to schedule the data services based on the priority.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 through 3 in this example represent GE <span>0/1/0</span>, GE <span>0/2/0</span>, and GE <span>0/3/0</span>, respectively.</p>
</div></div>
<div class="fignone" id="EN-US_TASK_0172371593__fig_dc_ne_qos_cfg_200601"><a name="EN-US_TASK_0172371593__fig_dc_ne_qos_cfg_200601"></a><a name="fig_dc_ne_qos_cfg_200601"></a><span class="figcap"><b>Figure 1 </b>Networking diagram of the MPLS DiffServ mode</span><br><span><img class="vsd" src="images/fig_dc_ne_qos_cfg_200601.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172371593__1.3.2"></a><a name="1.3.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure Open Shortest Path First (OSPF) on the backbone network to implement interworking between PEs.</p>
</li><li><p>Configure basic MPLS functions and MPLS LDP, and establish MPLS LSP.</p>
</li><li><p>Configure MP-IBGP between PEs to exchange VPN routing information.</p>
</li><li><p>Configure VPN instances on PEs and bind each interface that connects a PE to a CE to a VPN instance.</p>
</li><li><p>Configure EBGP between CEs and PEs to exchange VPN routing information.</p>
</li><li><p>Enable the Pipe mode on VPN-A and VPN-B, and apply different DiffServ domains to different VPN instances.</p>
</li><li>Configure BA classification on the P node.</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172371593__1.3.3"></a><a name="1.3.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li><p>MPLS LSR IDs of the PEs and P</p>
</li><li><p>Route distinguishers (RDs) of VPN-A and VPN-B</p>
</li><li><p>VPN targets of the routes sent and received by VPN-A and VPN-B</p>
</li><li><p>Different DiffServ domains configured on PE1 and PE2</p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172371593__1.3.4"></a><a name="1.3.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure an IGP on the MPLS backbone network so that PEs on the backbone network can communicate with the P.</span><p><p># Configure PE1.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname PE1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack1] <strong>ip address 1.1.1.9 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1]<strong> interface gigabitethernet <span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>ip address 172.21.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1]<strong> ospf</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>network 172.21.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>network 1.1.1.9 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-ospf-1] <strong>quit</strong></pre>
<p># Configure the P.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname P</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-LoopBack1] <strong>ip address 2.2.2.9 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-LoopBack1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P]<strong> interface gigabitethernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/1/0</span>] <strong>ip address 172.21.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/1/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P]<strong> interface gigabitethernet <span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/2/0</span>] <strong>ip address 172.22.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>ospf</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-ospf-1]<strong> area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-ospf-1-area-0.0.0.0] <strong>network 172.21.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-ospf-1-area-0.0.0.0] <strong>network 172.22.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-ospf-1-area-0.0.0.0] <strong>network 2.2.2.9 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-ospf-1-area-0.0.0.0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-ospf-1] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname PE2</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack1] <strong>ip address 3.3.3.9 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2]<strong> interface gigabitethernet <span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> ip address 172.22.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2]<strong> ospf</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1]<strong> area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>network 172.22.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>network 3.3.3.9 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-ospf-1] <strong>quit</strong></pre>
<p>After the configuration is complete, OSPF neighbor relationship is set up between PE1, the P, and PE2. Run the <strong>display ospf peer</strong> command. The command output shows that the neighbor status is <strong>Full</strong>. Run the <strong>display ip routing-table</strong> command. The command output shows that the PEs have learned the Loopback1 route of each other.</p>
<p>The command output on PE1 is used as an example.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ospf peer</strong>
(M) Indicates MADJ neighbor
          OSPF Process 1 with Router ID 1.1.1.9
                  Neighbors
 Area 0.0.0.0 interface 172.21.1.1(GigabitEthernet<span>0/3/0</span>)'s neighbors
 Router ID: 2.2.2.9           Address: 172.21.1.2
   State: <strong>Full</strong>       Mode:Nbr is  Master    Priority: 1
   DR: 172.21.1.1     BDR: 172.21.1.2       MTU: 0
   Dead timer due in 38  sec
   Retrans timer interval: 5
   Neighbor is up for 00h02m45s
   Neighbor Up Time : 2020-08-15 01:41:57
   Authentication Sequence: [ 0 ] 

[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ip routing-table</strong>
Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route
------------------------------------------------------------------------------
Routing Table: _public_
         Destinations : 8       Routes : 8

Destination/Mask  Proto  Pre  Cost             Flags NextHop         Interface
      1.1.1.9/32  Direct 0    0                D  127.0.0.1          LoopBack1
      2.2.2.9/32  OSPF   10   1                D  172.21.1.2         GigabitEthernet<span>0/3/0</span>
      3.3.3.9/32  OSPF   10   2                D  172.21.1.2         GigabitEthernet<span>0/3/0</span>
    127.0.0.0/8   Direct 0    0                D  127.0.0.1          InLoopBack0
    127.0.0.1/32  Direct 0    0                D  127.0.0.1          InLoopBack0
   172.21.1.0/24  Direct 0    0                D  172.21.1.1         GigabitEthernet<span>0/3/0</span>
   172.21.1.1/32  Direct 0    0                D  127.0.0.1          InLoopBack0
   172.22.1.0/24  OSPF   10   2                D  172.21.1.2         GigabitEthernet<span>0/3/0</span></pre>
</p></li><li><span>Configure basic MPLS functions, enable MPLS LDP, and establish LDP LSPs on the MPLS backbone network.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls lsr-id 1.1.1.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls-ldp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface gigabitethernet <span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>quit</strong></pre>
<p># Configure the P.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>mpls lsr-id 2.2.2.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-mpls] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-mpls-ldp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>interface gigabitethernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/1/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/1/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>interface gigabitethernet <span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/2/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls lsr-id 3.3.3.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-mpls]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls-ldp]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-mpls-ldp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface gigabitethernet <span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/3/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/3/0</span>] <strong>quit</strong></pre>
<p>After the configurations are complete, LDP sessions are set up between PE1 and the P and between PE2 and the P. Run the <strong>display mpls ldp session</strong> command. The command output shows that the LDP session status is <strong>Operational</strong>. Run the <strong>display mpls ldp lsp</strong> command. The command output shows LDP establishment.</p>
<p>The command output on PE1 is used as an example.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1]<strong> display mpls ldp session</strong>

 LDP Session(s) in Public Network
 Codes: LAM(Label Advertisement Mode), SsnAge Unit(DDDD:HH:MM)
 An asterisk (*) before a session means the session is being deleted.
 -------------------------------------------------------------------------
 PeerID             Status      LAM  SsnRole  SsnAge      KASent/Rcv
 -------------------------------------------------------------------------
 2.2.2.9:0          <strong>Operational</strong> DU  Passive  0000:00:01  5/5
 -------------------------------------------------------------------------
 TOTAL: 1 Session(s) Found.

[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display mpls ldp lsp</strong>
 LDP LSP Information
 -------------------------------------------------------------------------------
 Flag after Out IF: (I) - RLFA Iterated LSP, (I*) - Normal and RLFA Iterated LSP
 -------------------------------------------------------------------------------
 DestAddress/Mask   In/OutLabel   UpstreamPeer   NextHop         OutInterface
 -------------------------------------------------------------------------------
 1.1.1.9/32         3/NULL        2.2.2.9        127.0.0.1       Loopback1 
*1.1.1.9/32         Liberal/48061                DS/2.2.2.9
 2.2.2.9/32         NULL/3        -              172.21.1.2      GigabitEthernet<span>0/3/0</span>
 2.2.2.9/32        48061/3        2.2.2.9        172.21.1.2      GigabitEthernet<span>0/3/0</span>
 3.3.3.9/32         NULL/48062    -              172.21.1.2      GigabitEthernet<span>0/3/0</span>
 3.3.3.9/32       48062/48062     2.2.2.9        172.21.1.2      GigabitEthernet<span>0/3/0</span>
 -------------------------------------------------------------------------------
 TOTAL: 5 Normal LSP(s) Found.
 TOTAL: 1 Liberal LSP(s) Found.
 TOTAL: 0 FRR LSP(s) Found.
 An asterisk (*) before an LSP means the LSP is not established
 An asterisk (*) before a Label means the USCB or DSCB is stale
 An asterisk (*) before an UpstreamPeer means the session is stale
 An asterisk (*) before a DS means the session is stale
 An asterisk (*) before a NextHop means the LSP is FRR LSP</pre>
</p></li><li><span>Set up an MP-IBGP peer relationship between the PEs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 3.3.3.9 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 3.3.3.9 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 3.3.3.9 enable</strong>
Warning: This operation will reset the peer session. Continue? [Y/N]:<strong>y</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 1.1.1.9 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 1.1.1.9 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 1.1.1.9 enable</strong>
Warning: This operation will reset the peer session. Continue? [Y/N]:<strong>y</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp] <strong>quit</strong></pre>
<p>After the configurations are complete, run the <strong>display bgp peer</strong> or <strong>display bgp vpnv4 all peer</strong> command on the PEs. The command outputs show that the BGP peer relationship have been established between the PEs and are in the <strong>Established</strong> state. </p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display bgp vpnv4 all peer</strong></pre>
<pre class="screen">BGP local router ID : 1.1.1.9</pre>
<pre class="screen"> Local AS number : 100</pre>
<pre class="screen"> Total number of peers : 1                 Peers in established state : 1</pre>
<pre class="screen">  Peer            V    AS  MsgRcvd  MsgSent    OutQ  Up/Down    State        PrefRcv</pre>
<pre class="screen">  3.3.3.9         4   100   12      18         0     00:09:38   <strong>Established</strong>  0</pre>
</p></li><li><span>Configure a VPN instance on each PE for the access of the corresponding CE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance vpnb</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpnb] <strong>route-distinguisher 100:2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpnb-af-ipv4] <strong>vpn-target 222:2 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpnb-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-vpnb-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-vpnb] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface gigabitethernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>ip address 10.1.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface gigabitethernet <span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpnb</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.2.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>route-distinguisher 200:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2]<strong> ip vpn-instance vpnb</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpnb] <strong>route-distinguisher 200:2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpnb-af-ipv4] <strong>vpn-target 222:2 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpnb-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpnb-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpnb] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface gigabitethernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>ip address 10.3.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface gigabitethernet <span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpnb</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.4.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<p># Assign interface IP addresses to each CE according to <a href="#EN-US_TASK_0172371593__fig_dc_ne_qos_cfg_200601">Figure 1</a>. The configuration procedure is not described here.</p>
<p>After the configurations are complete, run the <strong>display ip vpn-instance verbose</strong> command on the PEs to view the configurations of VPN instances. Each PE can ping its connected CE.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If a PE has multiple interfaces bound to the same VPN instance, specify a source IP address using the <strong>-a</strong> <em>source-ip-address</em> parameter in the <strong>ping -vpn-instance</strong> <em>vpn-instance-name</em> <strong>-a</strong> <em>source-ip-address dest-ip-address</em> command to ping the CE that is connected to the remote PE. If the source IP address is not specified, the ping operation fails.</p>
</div></div>
<p>PE1 and CE1 are used as examples.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ip vpn-instance verbose</strong>
  Total VPN-Instances configured : 2
  Total IPv4 VPN-Instances configured : 2
  Total IPv6 VPN-Instances configured : 0

  VPN-Instance Name and ID : vpna, 4
  Interfaces : GigabitEthernet<span>0/1/0</span> 
Address family ipv4
  Create date : 2020/09/21 11:30:35
  Up time : 0 days, 00 hours, 05 minutes and 19 seconds
  Vrf Status : UP
  Route Distinguisher : 100:1
  Export VPN Targets :  111:1
  Import VPN Targets :  111:1
  Label Policy : label per route
  The diffserv-mode Information is : uniform
  The ttl-mode Information is : pipe
  Log Interval : 5
  Interfaces : GigabitEthernet<span>0/1/0</span>

  VPN-Instance Name and ID : vpnb, 5
  Interfaces : GigabitEthernet<span>0/2/0</span> 
Address family ipv4
  Create date : 2020/09/21 11:31:18
  Up time : 0 days, 00 hours, 04 minutes and 36 seconds
  Vrf Status : UP
  Route Distinguisher : 100:2
  Export VPN Targets :  222:2
  Import VPN Targets :  222:2
  Label Policy : label per route
  The diffserv-mode Information is : uniform
  The ttl-mode Information is : pipe
  Log Interval : 5
  Interfaces : GigabitEthernet<span>0/2/0</span>

[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ping -vpn-instance vpna 10.1.1.1</strong>
  PING 10.1.1.1: 56  data bytes, press CTRL_C to break
    Reply from 10.1.1.1: bytes=56 Sequence=1 ttl=255 time=56 ms
    Reply from 10.1.1.1: bytes=56 Sequence=2 ttl=255 time=4 ms
    Reply from 10.1.1.1: bytes=56 Sequence=3 ttl=255 time=4 ms
    Reply from 10.1.1.1: bytes=56 Sequence=4 ttl=255 time=52 ms
    Reply from 10.1.1.1: bytes=56 Sequence=5 ttl=255 time=3 ms

  --- 10.1.1.1 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 3/23/56 ms</pre>
</p></li><li><span>Establish EBGP peer relationships between the PEs and CEs and import VPN routes.</span><p><p># Configure CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>bgp 65410</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>peer 10.1.1.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>commit</strong></pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The configurations of CE2, CE3, and CE4 are similar to that of CE1, and the configuration procedure is not described here.</p>
</div></div>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>peer 10.1.1.1 as-number 65410</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp]<strong> ipv4-family vpn-instance vpnb</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpnb] <strong>peer 10.2.1.1 as-number 65420</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpnb] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpnb] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-vpnb] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>quit</strong></pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The configuration of PE2 is similar to that of PE1, and the configuration procedure is not described here.</p>
</div></div>
<p>After the configurations are complete, run the <strong>display bgp vpnv4 vpn-instance peer</strong> command on the PEs. The command outputs show that BGP peer relationships have been established between the PEs and CEs and are in the <strong>Established</strong> state.</p>
<p>The peer relationship between PE1 and CE1 is used as an example.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display bgp vpnv4 vpn-instance vpna peer</strong>

 BGP local router ID : 1.1.1.9
 Local AS number : 100
 VPN-Instance vpna, Router ID 1.1.1.9:
 Total number of peers : 1            Peers in established state : 1
  Peer            V    AS  MsgRcvd  MsgSent    OutQ  Up/Down    State        PrefRcv
  10.1.1.1        4   65410  11     9          0     00:06:37   <strong>Established</strong> 1</pre>
</p></li><li><span>Verify the configuration.</span><p><p>Run the <strong>display ip routing-table vpn-instance</strong> command on the PEs to view the routes to peer CEs.</p>
<p>The command output on PE1 is used as an example.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ip routing-table vpn-instance vpna</strong>
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table: vpna
         Destinations : 3        Routes : 3

Destination/Mask    Proto  Pre  Cost     Flags NextHop         Interface
     10.1.1.0/24    Direct 0    0        D     10.1.1.2        GigabitEthernet<span>0/1/0</span>
     10.1.1.2/32    Direct 0    0        D     127.0.0.1       GigabitEthernet<span>0/1/0</span>
     <strong>10.3.1.0/24</strong>   IBGP   255  0        RD    3.3.3.9         GigabitEthernet<span>0/3/0</span>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ip routing-table vpn-instance vpnb</strong>
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table: vpnb
         Destinations : 3        Routes : 3

Destination/Mask    Proto  Pre  Cost     Flags NextHop         Interface
     10.2.1.0/24    Direct 0    0        D     10.2.1.2        GigabitEthernet<span>0/2/0</span>
     10.2.1.2/32    Direct 0    0        D     127.0.0.1       GigabitEthernet<span>0/2/0</span>
     <strong>10.4.1.0/24</strong>   IBGP   255  0        RD    3.3.3.9         GigabitEthernet<span>0/3/0</span></pre>
<p>CEs in the same VPN can ping each other, but CEs in different VPNs cannot.</p>
<p>For example, CE1 can ping CE3 (10.3.1.1/24) but cannot ping CE4 (10.4.1.1/24).</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>ping 10.3.1.1</strong></pre>
<pre class="screen">  PING 10.3.1.1: 56  data bytes, press CTRL_C to break</pre>
<pre class="screen">    Reply from 10.3.1.1: bytes=56 Sequence=1 ttl=253 time=72 ms</pre>
<pre class="screen">    Reply from 10.3.1.1: bytes=56 Sequence=2 ttl=253 time=34 ms</pre>
<pre class="screen">    Reply from 10.3.1.1: bytes=56 Sequence=3 ttl=253 time=50 ms</pre>
<pre class="screen">    Reply from 10.3.1.1: bytes=56 Sequence=4 ttl=253 time=50 ms</pre>
<pre class="screen">    Reply from 10.3.1.1: bytes=56 Sequence=5 ttl=253 time=34 ms</pre>
<pre class="screen">  --- 10.3.1.1 ping statistics ---</pre>
<pre class="screen">    5 packet(s) transmitted</pre>
<pre class="screen">    5 packet(s) received</pre>
<pre class="screen">    0.00% packet loss</pre>
<pre class="screen">    round-trip min/avg/max = 34/48/72 ms  </pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>ping 10.4.1.1</strong></pre>
<pre class="screen">  PING 10.4.1.1: 56  data bytes, press CTRL_C to break</pre>
<pre class="screen">    Request time out</pre>
<pre class="screen">    Request time out</pre>
<pre class="screen">    Request time out</pre>
<pre class="screen">    Request time out</pre>
<pre class="screen">    Request time out</pre>
<pre class="screen">  --- 10.4.1.1 ping statistics ---</pre>
<pre class="screen">    5 packet(s) transmitted</pre>
<pre class="screen">    0 packet(s) received</pre>
<pre class="screen">    100.00% packet loss</pre>
</p></li><li><span>Configure the DiffServ mode on PE1 and PE2, and apply DiffServ domains to different VPN instances.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>diffserv-mode pipe af1<span> green</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance vpnb</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpnb]<strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpnb-af-ipv4] <strong>diffserv-mode pipe be<span> yellow</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpnb-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-vpnb-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-vpnb] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>diffserv-mode pipe af1<span> green</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance vpnb</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpnb] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpnb-af-ipv4] <strong>diffserv-mode pipe be<span> yellow</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpnb-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpnb-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpnb] <strong>quit</strong></pre>
</p></li><li><span>Configure BA classification on the P node.</span><p><p># Configure the P.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>interface gigabitethernet <span>0/1/0</span></strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/1/0</span>] <strong>trust upstream</strong> <strong>default</strong>
[<span class="keyword">*</span>P-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>P] <strong>interface gigabitethernet <span>0/2/0</span></strong>
[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/0</span>] <strong>trust upstream</strong> <strong>default</strong>
[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>P] <strong>commit</strong></pre>
</p></li><li><span>Verify the configuration.</span><p><p>Run the <strong>display ip vpn-instance verbose vpna</strong> command on a PE to view the DiffServ mode configured for the VPN instance.</p>
<p>The command output on PE1 is used as an example.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ip vpn-instance verbose vpna</strong></pre>
<pre class="screen">VPN-Instance Name and ID : vpna, 23
Address family ipv4
  Create date : 2020/09/21 11:08:12
  Up time : 0 days, 00 hours, 06 minutes and 32 seconds
  Vrf Status : UP
  Label Policy : label per route
  <strong>The diffserv-mode Information is : pipe af1 green</strong>
  The ttl-mode Information is : pipe
  Log Interval : 5</pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172371593__1.3.5"></a><a name="1.3.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>PE1 configuration file</p>
<pre class="screen">#
sysname PE1
#
ip vpn-instance vpna
  ipv4-family
  route-distinguisher 100:1
<span>  apply-label per-instance</span>
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
  diffserv-mode pipe af1<span> green</span>
#
ip vpn-instance vpnb
  ipv4-family
  route-distinguisher 100:2
<span>  apply-label per-instance</span>
  vpn-target 222:2 export-extcommunity
  vpn-target 222:2 import-extcommunity
  diffserv-mode pipe be<span> yellow</span>
#
mpls lsr-id 1.1.1.9
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip binding vpn-instance vpna
 ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip binding vpn-instance vpnb
 ip address 10.2.1.2 255.255.255.0
#
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown
 ip address 172.21.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 1.1.1.9 255.255.255.255
#
bgp 100
 peer 3.3.3.9 as-number 100
 peer 3.3.3.9 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 3.3.3.9 enable
#
 ipv4-family vpnv4
  policy vpn-target
  peer 3.3.3.9 enable
 #
 ipv4-family vpn-instance vpna
  import-route direct
  peer 10.1.1.1 as-number 65410
#
 ipv4-family vpn-instance vpnb
  import-route direct
  peer 10.2.1.1 as-number 65420
#
ospf 1
 area 0.0.0.0
  network 1.1.1.9 0.0.0.0
  network 172.21.1.0 0.0.0.255
#
return</pre>
</li><li><p>P configuration file</p>
<pre class="screen">#
sysname P
#
mpls lsr-id 2.2.2.9
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 172.21.1.2 255.255.255.0
 mpls
 mpls ldp
 trust upstream default
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 172.22.1.1 255.255.255.0
 mpls
 mpls ldp
 trust upstream default
#
interface LoopBack1
 ip address 2.2.2.9 255.255.255.255
#
ospf 1
 area 0.0.0.0
  network 2.2.2.9 0.0.0.0
  network 172.21.1.0 0.0.0.255
  network 172.22.1.0 0.0.0.255
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
ip vpn-instance vpna
  ipv4-family
  route-distinguisher 200:1
<span>  apply-label per-instance</span>
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
  diffserv-mode pipe af1<span> green</span>
#
ip vpn-instance vpnb
  ipv4-family
  route-distinguisher 200:2
<span>  apply-label per-instance</span>
  vpn-target 222:2 export-extcommunity
  vpn-target 222:2 import-extcommunity
  diffserv-mode pipe be<span> yellow</span>
#
mpls lsr-id 3.3.3.9
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip binding vpn-instance vpna
 ip address 10.3.1.2 255.255.255.0
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip binding vpn-instance vpnb
 ip address 10.4.1.2 255.255.255.0
#
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown
 ip address 172.22.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 3.3.3.9 255.255.255.255
#
bgp 100
 peer 1.1.1.9 as-number 100
 peer 1.1.1.9 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.9 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.9 enable
 #
 ipv4-family vpn-instance vpna
  peer 10.3.1.1 as-number 65430
  import-route direct
 #
 ipv4-family vpn-instance vpnb
  peer 10.4.1.1 as-number 65440
  import-route direct
#
ospf 1
 area 0.0.0.0
  network 3.3.3.9 0.0.0.0
  network 172.22.1.0 0.0.0.255
#
return</pre>
</li><li><p>CE1 configuration file</p>
<pre class="screen">#
sysname CE1
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.0
#
bgp 65410
 peer 10.1.1.2 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 10.1.1.2 enable
#
return</pre>
</li><li><p>CE2 configuration file</p>
<pre class="screen">#
sysname CE2
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.2.1.1 255.255.255.0
#
bgp 65420
 peer 10.2.1.2 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 10.2.1.2 enable
#
return</pre>
</li><li><p>CE3 configuration file</p>
<pre class="screen">#
sysname CE3
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.3.1.1 255.255.255.0
#
bgp 65430
 peer 10.3.1.2 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 10.3.1.2 enable
#
return</pre>
</li><li><p>CE4 configuration file</p>
<pre class="screen">#
sysname CE4
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.4.1.1 255.255.255.0
#
bgp 65440
 peer 10.4.1.2 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 10.4.1.2 enable
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_qos_cfg_2005.html">Configuration Examples for MPLS DiffServ Modes
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
</div>
</div>
</body>
</html>