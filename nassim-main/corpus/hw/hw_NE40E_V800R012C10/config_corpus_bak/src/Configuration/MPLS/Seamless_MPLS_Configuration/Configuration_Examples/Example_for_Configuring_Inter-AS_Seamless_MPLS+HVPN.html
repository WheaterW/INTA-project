
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring Inter-AS Seamless MPLS+HVPN">
<meta name="abstract" content="In the inter-AS seamless MPLS+HVPN networking, an HVPN connection between a CSG and AGG is established, and an inter-AS seamless MPLS LSP between an AGG and MASG is established. The inter-AS seamless MPLS+HVPN networking obtains the collective advantages of the inter-AS seamless MPLS network and HVPN.">
<meta name="description" content="In the inter-AS seamless MPLS+HVPN networking, an HVPN connection between a CSG and AGG is established, and an inter-AS seamless MPLS LSP between an AGG and MASG is established. The inter-AS seamless MPLS+HVPN networking obtains the collective advantages of the inter-AS seamless MPLS network and HVPN.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_seamless_mpls_cfg_0030.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_seamless_mpls_cfg_0032.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_seamless_mpls_cfg_0042.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,z00545680,w00556928,seamlessvrp,w00606909,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="Seamless MPLS">
<meta name="featuretype" content="MPLS">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="Seamless MPLS">
<meta name="featuretype" content="MPLS">
<meta name="featurename" content="Seamless MPLS">
<meta name="featuretype" content="MPLS">
<meta name="featurename" content="Seamless MPLS">
<meta name="featuretype" content="MPLS">
<meta name="OWNER" content="z00809835">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="b00896120">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172368692">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/thickbox.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/imageResize.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery-migrate-1.2.1.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery-ui.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery.mousewheel.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/thickbox.js"></script>
<title>Example for Configuring Inter-AS Seamless MPLS+HVPN</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172368692"></a><a name="EN-US_TASK_0172368692"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring Inter-AS Seamless MPLS+HVPN</h1>
<div class="taskbody"><p>In the inter-AS seamless MPLS+HVPN networking, an HVPN connection between a CSG and AGG is established, and an inter-AS seamless MPLS LSP between an AGG and MASG is established. The inter-AS seamless MPLS+HVPN networking obtains the collective advantages of the inter-AS seamless MPLS network and HVPN.</p>
<div class="context"><a name="EN-US_TASK_0172368692__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>In <a href="#EN-US_TASK_0172368692__fig_dc_vrp_seamless_mpls_cfg_003302">Figure 1</a>, the access and aggregation layers belong to AS 100, and the core layer belongs to AS 200. To provision VPN services, the inter-AS seamless MPLS+HVPN networking can be deployed. This networking allows base stations and the MME/SGW to communicate with each other and cuts networking construction costs with the use of HVPN. An HVPN connection for each CSG-and-AGG pair is established, and an inter-AS seamless MPLS LSP for each AGG-and-MASG pair is established.</p>
<div class="fignone" id="EN-US_TASK_0172368692__fig_dc_vrp_seamless_mpls_cfg_003302"><a name="EN-US_TASK_0172368692__fig_dc_vrp_seamless_mpls_cfg_003302"></a><a name="fig_dc_vrp_seamless_mpls_cfg_003302"></a><span class="figcap"><b>Figure 1 </b>Inter-AS seamless MPLS+HVPN networking (1)</span><br><span><img class="imgResize" src="images/fig_dc_vrp_seamless_mpls_cfg_003302.png" width="520.0566" height="303.3663942225" title="Click to enlarge"></span></div>
<p>Addresses of interfaces are planned for the CSGs, AGGs, AGG ASBRs, core ASBRs, and MASGs shown in <a href="#EN-US_TASK_0172368692__fig_dc_vrp_seamless_mpls_cfg_003301">Figure 2</a>.</p>
<div class="fignone" id="EN-US_TASK_0172368692__fig_dc_vrp_seamless_mpls_cfg_003301"><a name="EN-US_TASK_0172368692__fig_dc_vrp_seamless_mpls_cfg_003301"></a><a name="fig_dc_vrp_seamless_mpls_cfg_003301"></a><span class="figcap"><b>Figure 2 </b>Inter-AS seamless MPLS+HVPN networking (2)</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 and 2 in this example are GE<span>0/1/0</span> and GE<span>0/2/0</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="images/fig_dc_vrp_seamless_mpls_cfg_003301.png" width="NaN" height="NaN"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172368692__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure IGP protocols at the access, aggregation, and core layers to implement network connectivity at each layer.</p>
</li><li><p>Configure MPLS and MPLS LDP and establish MPLS LSPs at the access, aggregation, and core layers.</p>
</li><li><p>Establish IBGP peer relationships at the aggregation and core layers and enable devices to exchange labeled routes.</p>
</li><li><p>Configure an EBGP peer relationship for each AGG ASBR-and-core ASBR pair and enable these devices to exchange labeled routes across ASs.</p>
</li><li><p>Configure a routing policy to control label distribution for a BGP LSP to be established on each device, except CGSs. The egress of the BGP LSP to be established needs to assign an MPLS label to the route advertised to an upstream node. If a transit node receives a labeled IPv4 route from downstream, the downstream node must re-assign an MPLS label to the transit node.</p>
</li><li><p>Configure an MP-EBGP peer relationship between an AGG and MASG to allow these devices to exchange VPNv4 route information.</p>
</li><li><p>Configure an MP-IBGP peer relationship between a CSG and AGG to allow these devices to exchange VPNv4 route information.</p>
</li><li><p>Configure VPN instances on each CSG, AGG, and MASG.</p>
</li><li><p>Configure a default route and an IP address prefix list on each AGG so that the AGG only advertises the default route to its directly connected CSG.</p>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172368692__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li><p>OSPF process ID (1) at the access layer, IS-IS process ID (1) at the aggregation layer, and OSPF process ID (2) at the core layer</p>
</li><li><p>MPLS LSR IDs: 1.1.1.1 for the CSG, 2.2.2.2 for the AGG, 3.3.3.3 for the AGG ASBR, 4.4.4.4 for the core ASBR, and 5.5.5.5 for the MASG.</p>
</li><li><p>Name of a routing policy (policy1)</p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172368692__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Assign an IP address to each interface.</span><p><p>Configure interface IP addresses and masks; configure a loopback interface address as an LSR ID on every device shown in <a href="#EN-US_TASK_0172368692__fig_dc_vrp_seamless_mpls_cfg_003301">Figure 2</a>; configure OSPF and IS-IS to advertise the route to the network segment of each interface and a host route to each loopback interface address (LSR ID). For configuration details, see Configuration Files in this section.</p>
</p></li><li><span>Enable MPLS and LDP globally on each device.</span><p><p># Configure the CSG.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CSG]<strong> mpls lsr-id 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG]<strong> mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-mpls]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG] <strong>interface GigabitEthernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-GigabitEthernet<span>0/1/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG] <strong>commit</strong></pre>
<p># Configure the AGG.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG]<strong> mpls lsr-id 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG]<strong> mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-mpls]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>interface GigabitEthernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-GigabitEthernet<span>0/1/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>interface GigabitEthernet <span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-GigabitEthernet<span>0/2/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-GigabitEthernet<span>0/2/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>commit</strong></pre>
<p># Configure the AGG ASBR.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG ASBR]<strong> mpls lsr-id 3.3.3.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-mpls]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-mpls-ldp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR] <strong>interface GigabitEthernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-GigabitEthernet<span>0/1/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR] <strong>commit</strong></pre>
<p># Configure the core ASBR.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Core ASBR]<strong> mpls lsr-id 4.4.4.4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-mpls]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-mpls-ldp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR] <strong>interface GigabitEthernet <span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-GigabitEthernet<span>0/2/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-GigabitEthernet<span>0/2/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR] <strong>commit</strong></pre>
<p># Configure the MASG.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>MASG]<strong> mpls lsr-id 5.5.5.5</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-mpls]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-mpls-ldp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG] <strong>interface GigabitEthernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-GigabitEthernet<span>0/1/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG] <strong>commit</strong></pre>
</p></li><li><span>Establish IBGP peer relationships at the aggregation and core layers and enable devices to exchange labeled routes.</span><p><p># Configure the AGG.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>peer 3.3.3.3 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>peer 3.3.3.3 connect-interface LoopBack 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>peer 3.3.3.3 label-route-capability</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>network 2.2.2.2 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>commit</strong></pre>
<p># Configure the AGG ASBR.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG ASBR] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-bgp] <strong>peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-bgp] <strong>peer 2.2.2.2 connect-interface LoopBack 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-bgp] <strong>peer 2.2.2.2 label-route-capability</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR] <strong>commit</strong></pre>
<p># Configure the core ASBR.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Core ASBR] <strong>bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-bgp] <strong>peer 5.5.5.5 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-bgp] <strong>peer 5.5.5.5 connect-interface LoopBack 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-bgp] <strong>peer 5.5.5.5 label-route-capability</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR] <strong>commit</strong></pre>
<p># Configure the MASG.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>MASG] <strong>bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-bgp] <strong>peer 4.4.4.4 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-bgp] <strong>peer 4.4.4.4 connect-interface LoopBack 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-bgp] <strong>peer 4.4.4.4 label-route-capability</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-bgp] <strong>network 5.5.5.5 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG] <strong>commit</strong></pre>
</p></li><li><span>Establish an EBGP peer relationship for each AGG ASBR-and-core ASBR pair and enable these devices to exchange labeled routes.</span><p><p># Configure the AGG ASBR.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG ASBR] <strong>interface GigabitEthernet <span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG ASBR-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.3.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-GigabitEthernet<span>0/2/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-bgp] <strong>peer 10.3.1.2 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-bgp] <strong>peer 10.3.1.2 label-route-capability check-tunnel-reachable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR] <strong>commit</strong></pre>
<p># Configure the core ASBR.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Core ASBR] <strong>interface GigabitEthernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Core ASBR-GigabitEthernet<span>0/1/0</span>] <strong>ip address 10.3.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR] <strong>bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-bgp] <strong>peer 10.3.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-bgp] <strong>peer 10.3.1.1 label-route-capability check-tunnel-reachable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Core ASBR] <strong>commit</strong></pre>
</p></li><li><span>Configure an MP-EBGP peer relationship for each AGG-and-MASG pair.</span><p><p># Configure the AGG.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG-bgp] <strong>peer 5.5.5.5 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>peer 5.5.5.5 connect-interface LoopBack 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>peer 5.5.5.5 ebgp-max-hop 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp-af-vpnv4] <strong>peer 5.5.5.5 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>commit</strong></pre>
<p># Configure the MASG.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>MASG] <strong>bgp 200</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>MASG-bgp] <strong>peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-bgp] <strong>peer 2.2.2.2 connect-interface LoopBack 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-bgp] <strong>peer 2.2.2.2 ebgp-max-hop 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-bgp-af-vpnv4] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>MASG] <strong>commit</strong></pre>
</p></li><li><span>Configure a routing policy to establish a BGP LSP.</span><p><p># Configure a routing policy for advertising routes matching Route-Policy conditions to the AGG's BGP peer.</p>
<pre class="screen">&lt;AGG&gt; <strong>system-view </strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG] <strong>route-policy policy1 permit node 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-route-policy] <strong>apply mpls-label</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-route-policy] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>peer 3.3.3.3 route-policy policy1 export</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>commit</strong></pre>
<p>Repeat this step for the MASG. For configuration details, see Configuration Files in this section.</p>
<p># Configure a routing policy for advertising routes matching Route-Policy conditions to the AGG ASBR's BGP peer.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG ASBR] <strong>route-policy policy1 permit node 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-route-policy] <strong>if-match mpls-label</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-route-policy] <strong>apply mpls-label</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-route-policy]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-bgp] <strong>peer 2.2.2.2 route-policy policy1 export</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-bgp] <strong>peer 10.3.1.2 route-policy policy1 export</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG ASBR] <strong>commit</strong></pre>
<p>Repeat this step for the core ASBR. For configuration details, see Configuration Files in this section.</p>
<div class="p">After completing the preceding configurations, run the <strong>ping lsp</strong> command on an AGG or MASG. The command output shows that the AGG and MASG can ping each other. This indicates that the BGP LSP between the AGG and MASG has been established. The following example uses the command output on the AGG.<pre class="screen">&lt;AGG&gt; <strong>ping lsp bgp 5.5.5.5 32</strong></pre>
<pre class="screen">  LSP PING FEC: BGP LABLED IPV4 PREFIX 5.5.5.5/32/ : 100  data bytes, press CTRL_C to break
    Reply from 5.5.5.5: bytes=100 Sequence=1 time=870 ms
    Reply from 5.5.5.5: bytes=100 Sequence=2 time=40 ms
    Reply from 5.5.5.5: bytes=100 Sequence=3 time=110 ms
    Reply from 5.5.5.5: bytes=100 Sequence=4 time=80 ms
    Reply from 5.5.5.5: bytes=100 Sequence=5 time=110 ms

  --- FEC: BGP LABLED IPV4 PREFIX 5.5.5.5/32 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 40/242/870 ms</pre>
</div>
</p></li><li><span>Configure an MP-IBGP peer relationship for each CSG-and-AGG pair.</span><p><p># Configure the CSG.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CSG] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CSG-bgp] <strong>peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-bgp] <strong>peer 2.2.2.2 connect-interface LoopBack 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-bgp] <strong>network 1.1.1.1 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-bgp-af-vpnv4] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG] <strong>commit</strong></pre>
<p># Configure the AGG.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG-bgp] <strong>peer 1.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>peer 1.1.1.1 connect-interface LoopBack 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp-af-vpnv4] <strong>peer 1.1.1.1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>commit</strong></pre>
</p></li><li><span>Configure a VPN instance and bind an interface of each device to the VPN instance.</span><p><p># Configure the CSG.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CSG] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-vpn-instance-vpn1-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 1:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG] <strong>interface GigabitEthernet <span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.5.1.1 255.255.255.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-bgp] <strong>ipv4-family vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-bgp-vpn1] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-bgp-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CSG] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CSG] <strong>quit</strong></pre>
<p>Repeat this step for the MASG. For configuration details, see Configuration Files in this section.</p>
<p># Configure the AGG.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-vpn-instance-vpn1-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 1:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>commit</strong></pre>
</p></li><li><span>Configure a default route and an IP address prefix list on each AGG so that the AGG only advertises the default route to its directly connected CSG.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>AGG] <strong>ip route-static vpn-instance vpn1 0.0.0.0 0.0.0.0 NULL0 </strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>ip ip-prefix default index 10 permit 0.0.0.0 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp-af-vpnv4] <strong>peer 1.1.1.1 ip-prefix default export</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>ipv4-family vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp-vpn1] <strong>network 0.0.0.0 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>AGG] <strong>commit</strong></pre>
</p></li><li><span>Verify the configuration.</span><p><p>After completing the preceding configurations, run the <a href="cmdqueryname=display+ip+routing-table"><b><span class="cmdname">display ip routing-table</span></b></a> command on the CSG. The command output shows that the CSG has a default route with its directly connected AGG as the next hop, but does not have a VPN route to the MME or SGW. In addition, the CSG can ping the MME or SGW.</p>
<p>The following example uses the command output on the CSG.</p>
<pre class="screen">&lt;CSG&gt; <strong>display ip routing-table vpn-instance vpn1</strong></pre>
<pre class="screen"><span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : vpn1
         Destinations : 5        Routes : 5

Destination/Mask    Proto   Pre  Cost        Flags NextHop         Interface

        0.0.0.0/0   IBGP    255  0             RD 2.2.2.2         GigabitEthernet<span>0/2/0</span>
       10.5.1.0/24  Direct  0    0             D  10.5.1.1        GigabitEthernet<span>0/2/0</span>
       10.5.1.1/32  Direct  0    0             D  127.0.0.1       GigabitEthernet<span>0/2/0</span>
     10.5.1.255/32  Direct  0    0             D  127.0.0.1       GigabitEthernet<span>0/2/0</span>
255.255.255.255/32  Direct  0    0             D  127.0.0.1       InLoopBack0</pre>
<pre class="screen">&lt;CSG&gt; <strong>ping -vpn-instance vpn1 10.6.1.1</strong></pre>
<pre class="screen">  PING 10.6.1.0: 56  data bytes, press CTRL_C to break
    Reply from 10.6.1.0: bytes=56 Sequence=1 ttl=252 time=6 ms
    Reply from 10.6.1.0: bytes=56 Sequence=2 ttl=252 time=3 ms
    Reply from 10.6.1.0: bytes=56 Sequence=3 ttl=252 time=3 ms
    Reply from 10.6.1.0: bytes=56 Sequence=4 ttl=252 time=4 ms
    Reply from 10.6.1.0: bytes=56 Sequence=5 ttl=252 time=2 ms

  --- 10.6.1.1 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 2/3/6 ms</pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172368692__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>CSG configuration file</p>
<pre class="screen">#
sysname CSG
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
<span>  apply-label per-instance</span>
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
mpls lsr-id 1.1.1.1
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 10.5.1.1 255.255.255.0
#
interface LoopBack1
 ip address 1.1.1.1 255.255.255.255
#
bgp 100
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack1
 #
 ipv4-family unicast
  peer 2.2.2.2 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 2.2.2.2 enable
 #
 ipv4-family vpn-instance vpn1
  import-route direct
#
ospf 1
 area 0.0.0.0
  network 1.1.1.1 0.0.0.0
  network 10.1.1.0 0.0.0.255
#
return</pre>
</li><li><p>AGG configuration file</p>
<pre class="screen">#
sysname AGG
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
<span>  apply-label per-instance</span>
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
mpls lsr-id 2.2.2.2
#
mpls
#
mpls ldp
#
isis 1
 network-entity 10.0000.0000.0000.0010.00
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 10.2.1.1 255.255.255.0
 isis enable 1
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 2.2.2.2 255.255.255.255
 isis enable 1
#
bgp 100
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack1
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack1
 peer 5.5.5.5 as-number 200
 peer 5.5.5.5 ebgp-max-hop 10
 peer 5.5.5.5 connect-interface LoopBack1
 #
 ipv4-family unicast
  network 2.2.2.2 255.255.255.255
  peer 1.1.1.1 enable
  peer 3.3.3.3 enable
  peer 3.3.3.3 route-policy policy1 export
  peer 3.3.3.3 label-route-capability
  peer 5.5.5.5 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.1 enable
  peer 1.1.1.1 ip-prefix default export
  peer 5.5.5.5 enable
 #
 ipv4-family vpn-instance vpn1
  network 0.0.0.0
#
ospf 1
 area 0.0.0.0
  network 2.2.2.2 0.0.0.0
  network 10.1.1.0 0.0.0.255
#
route-policy policy1 permit node 1
 apply mpls-label
#
ip ip-prefix default index 10 permit 0.0.0.0 0
#
ip route-static vpn-instance vpn1 0.0.0.0 0.0.0.0 NULL0
#
return</pre>
</li><li><p>AGG ASBR configuration file</p>
<pre class="screen">#
sysname AGG ASBR
#
mpls lsr-id 3.3.3.3
#
mpls
#
mpls ldp
#
isis 1
 network-entity 10.0000.0000.0000.0020.00
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.2.1.2 255.255.255.0
 isis enable 1
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 10.3.1.1 255.255.255.0
 mpls
#
interface LoopBack1
 ip address 3.3.3.3 255.255.255.255
 isis enable 1
#
bgp 100
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack1
 peer 10.3.1.2 as-number 200
 #
 ipv4-family unicast
  peer 2.2.2.2 enable
  peer 2.2.2.2 route-policy policy1 export
  peer 2.2.2.2 label-route-capability
  peer 10.3.1.2 enable
  peer 10.3.1.2 route-policy policy1 export
  peer 10.3.1.2 label-route-capability check-tunnel-reachable
#
route-policy policy1 permit node 1
 if-match mpls-label
 apply mpls-label
#
return</pre>
</li><li><p>Core ASBR configuration file</p>
<pre class="screen">#
sysname Core ASBR
#
mpls lsr-id 4.4.4.4
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.3.1.2 255.255.255.0
 mpls
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 10.4.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 4.4.4.4 255.255.255.255
#
bgp 200
 peer 5.5.5.5 as-number 200
 peer 5.5.5.5 connect-interface LoopBack1
 peer 10.3.1.1 as-number 100
 #
 ipv4-family unicast
  peer 5.5.5.5 enable
  peer 5.5.5.5 route-policy policy1 export
  peer 5.5.5.5 label-route-capability
  peer 10.3.1.1 enable
  peer 10.3.1.1 route-policy policy1 export
  peer 10.3.1.1 label-route-capability check-tunnel-reachable
#
ospf 2
 area 0.0.0.0
  network 4.4.4.4 0.0.0.0
  network 10.4.1.0 0.0.0.255
#
route-policy policy1 permit node 1
 if-match mpls-label
 apply mpls-label
#
return</pre>
</li><li><p>MASG configuration file</p>
<pre class="screen">#
sysname MASG
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
<span>  apply-label per-instance</span>
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
mpls lsr-id 5.5.5.5
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 10.6.1.1 255.255.255.0
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 10.4.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 5.5.5.5 255.255.255.255
#
bgp 200
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 ebgp-max-hop 10
 peer 2.2.2.2 connect-interface LoopBack1
 peer 4.4.4.4 as-number 200
 peer 4.4.4.4 connect-interface LoopBack1
 #
 ipv4-family unicast
  network 5.5.5.5 255.255.255.255
  peer 2.2.2.2 enable
  peer 4.4.4.4 enable
  peer 4.4.4.4 route-policy policy1 export
  peer 4.4.4.4 label-route-capability
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 2.2.2.2 enable
 #
 ipv4-family vpn-instance vpn1
  import-route direct
#
ospf 2
 area 0.0.0.0
  network 5.5.5.5 0.0.0.0
  network 10.4.1.0 0.0.0.255
#
route-policy policy1 permit node 1
 apply mpls-label
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_seamless_mpls_cfg_0030.html">Configuration Examples
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_seamless_mpls_cfg_0032.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_seamless_mpls_cfg_0042.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>

<script language="JavaScript">
<!--
image_size('.imgResize');
var msg_imageMax = "view original image";
var msg_imageClose = "close";
//--></script></body>
</html>