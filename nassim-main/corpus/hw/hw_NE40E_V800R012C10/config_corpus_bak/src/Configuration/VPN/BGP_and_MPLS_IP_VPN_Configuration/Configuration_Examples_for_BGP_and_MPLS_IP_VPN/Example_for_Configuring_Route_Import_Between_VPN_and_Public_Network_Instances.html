
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring Route Import Between VPN and Public Network Instances">
<meta name="abstract" content="In a traffic cleaning scenario, you can configure route import between VPN and public network instances on a device, so that the device imports public network routes into the VPN instance to guide the forwarding of re-injected traffic.">
<meta name="description" content="In a traffic cleaning scenario, you can configure route import between VPN and public network instances on a device, so that the device imports public network routes into the VPN instance to guide the forwarding of re-injected traffic.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0101.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0110.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0320.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,l3vpnvrp,w00556928,l00468467,w00606909,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="h00847023">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00415692">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172369484">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/jquery.min.idp.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/RowOrColfreezeSupport.js"></script>

<script type="text/javascript">
setTimeout(function(){
	jQueryHW(document).ready(function(){
		jQueryHW("table[rowfreeze='yes']").rowfreeze();
		jQueryHW("table[colfreeze='yes']").colfreeze();
	});
},500);
</script>
<title>Example for Configuring Route Import Between VPN and Public Network Instances</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172369484"></a><a name="EN-US_TASK_0172369484"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring Route Import Between VPN and Public Network Instances</h1>
<div class="taskbody"><p>In a traffic cleaning scenario, you can configure route import between VPN and public network instances on a device, so that the device imports public network routes into the VPN instance to guide the forwarding of re-injected traffic.</p>
<div class="context"><a name="EN-US_TASK_0172369484__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>On the network shown in <a href="#EN-US_TASK_0172369484__fig_dc_vrp_l3vpn_cfg_00125">Figure 1</a>, Device A belongs to AS100, whereas Device B, Device C, and the traffic cleaning server (Server) belong to AS200. Device B is an ingress of AS200. AS200 communicates with AS100 through Device B.</p>
<p>If an attack originates in AS100, attack traffic will consume network resources in AS200 after being transmitted to AS200 through Device B. After a traffic analysis server is deployed, the attack traffic can be diverted to Server for cleaning. The cleaned traffic is injected back to the AS200 network through Device B. In this case, the public network routes destined for Device C need to be imported into the VPN routing table of Device B to forward the cleaned traffic to Device C. In addition, the public network routes sent by Server should not be imported into the VPN routing table. This prevents the re-injected traffic from being sent back to Server after reaching Device B, thereby preventing loops. To implement the preceding process, configure route import between VPN and public network instances on Device B, and configure a route-policy on Device B based on BGP peer relationships.</p>
<div class="fignone" id="EN-US_TASK_0172369484__fig_dc_vrp_l3vpn_cfg_00125"><a name="EN-US_TASK_0172369484__fig_dc_vrp_l3vpn_cfg_00125"></a><a name="fig_dc_vrp_l3vpn_cfg_00125"></a><span class="figcap"><b>Figure 1 </b>Configuring route import between VPN and public network instances</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 through 3 in this example represent GE<span>0/1/0</span>, GE<span>0/2/0</span>, and GE<span>0/3/0</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="images/fig_feature_image_0022433989.png" width="NaN" height="NaN"></span><br></div>

<div class="tableBorder"><table cellpadding="4" cellspacing="0" summary="" rowfreeze="yes" frame="border" border="1" rules="all"><thead align="left"><tr><th align="left" class="cellrowborder" valign="top" width="13.24867513248675%" id="mcps1.4.1.5.1.4.1.1" liSelected="liSelected"><p>Device</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="37.08629137086292%" id="mcps1.4.1.5.1.4.1.2" liSelected="liSelected"><p>Interface</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="49.66503349665034%" id="mcps1.4.1.5.1.4.1.3" liSelected="liSelected"><p>IP Address</p>
</th>
</tr>
</thead>
<tbody><tr><td class="cellrowborder" rowspan="2" valign="top" width="13.24867513248675%" headers="mcps1.4.1.5.1.4.1.1 "><p>Device A</p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="37.08629137086292%" headers="mcps1.4.1.5.1.4.1.2 "><p>Loopback 1</p>
</td>
<td class="cellrowborder" valign="top" width="49.66503349665034%" headers="mcps1.4.1.5.1.4.1.3 "><p>1.1.1.1/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.2 "><p>GE<span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.3 "><p>10.1.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="6" valign="top" width="13.24867513248675%" headers="mcps1.4.1.5.1.4.1.1 "><p>Device B</p>
<p></p>
<p></p>
<p></p>
<p></p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="37.08629137086292%" headers="mcps1.4.1.5.1.4.1.2 "><p>Loopback 1</p>
</td>
<td class="cellrowborder" valign="top" width="49.66503349665034%" headers="mcps1.4.1.5.1.4.1.3 "><p>2.2.2.2/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.2 "><p>GE<span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.3 "><p>10.1.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.2 "><p>GE<span>0/2/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.3 "><p>10.2.3.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.2 "><p>GE<span>0/2/0</span>.1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.3 "><p>10.2.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.2 "><p>GE<span>0/2/0</span>.2</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.3 "><p>10.2.2.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.2 "><p>GE<span>0/3/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.3 "><p>172.16.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="2" valign="top" width="13.24867513248675%" headers="mcps1.4.1.5.1.4.1.1 "><p>Device C</p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="37.08629137086292%" headers="mcps1.4.1.5.1.4.1.2 "><p>Loopback 1</p>
</td>
<td class="cellrowborder" valign="top" width="49.66503349665034%" headers="mcps1.4.1.5.1.4.1.3 "><p>3.3.3.3/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.2 "><p>GE<span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.3 "><p>172.16.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="4" valign="top" width="13.24867513248675%" headers="mcps1.4.1.5.1.4.1.1 "><p>Server</p>
<p></p>
<p></p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="37.08629137086292%" headers="mcps1.4.1.5.1.4.1.2 "><p>Loopback 1</p>
</td>
<td class="cellrowborder" valign="top" width="49.66503349665034%" headers="mcps1.4.1.5.1.4.1.3 "><p>4.4.4.4/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.2 "><p>GE<span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.3 "><p>10.2.3.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.2 "><p>GE<span>0/1/0</span>.1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.3 "><p>10.2.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.2 "><p>GE<span>0/1/0</span>.2</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.5.1.4.1.3 "><p>10.2.2.2/24</p>
</td>
</tr>
</tbody>
</table>
</div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369484__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure interface IP addresses.</p>
</li><li>Configure OSPF on Device B, Device C and Server.</li><li><p>Configure IBGP connections between Device B and Device C, and between Device B and Server.</p>
</li><li><p>Configure an EBGP connection between Device A and Device B.</p>
</li><li><p>Bind the Device B interface connected to Server to a VPN instance. Configure a route-policy on Device B to prevent routes sent by Server from being imported into the VPN routing table.</p>
</li><li>Configure a static route with a 16-bit mask on Device C and a static route with a 32-bit mask on Server. Import the static route into the BGP routing table. Divert traffic sent by Device A to Server to simulate the traffic cleaning process based on the longest match rule for route selection.</li><li><p>Configure route import between VPN and public network on Device B to import public network routes to the VPN routing table and guide the forwarding of re-injected traffic to Device C.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The traffic analysis server is a third-party device. In this example, Server has only basic BGP configurations, OSPF configurations, and configurations for static route import into the BGP routing table. The traffic cleaning configuration is beyond the scope of this document.</p>
</div></div>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369484__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><div class="p">To complete the configuration, you need the following data:<ul><li><p>Router IDs of Device A, Device B, and Device C</p>
</li><li><p>AS number (100) for Device A; AS number (200) for Device B, Device C, and Server</p>
</li><li><p>VPN targets of <strong>vpna</strong></p>
</li><li><p>Route-policy on Device B</p>
</li><li>Routes advertised by Device C and Server</li></ul>
</div>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172369484__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure interface IP addresses.</span><p><p>For configuration details, see the configuration files.</p>
</p></li><li><span>Configure OSPF.</span><p><p># Configure Device B.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceB]<strong> ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-ospf-1]<strong> area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-ospf-1-area-0.0.0.0]<strong> network 10.2.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-ospf-1-area-0.0.0.0]<strong> network 10.2.3.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-ospf-1-area-0.0.0.0]<strong> network 172.16.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-ospf-1-area-0.0.0.0]<strong> network 2.2.2.2 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-ospf-1-area-0.0.0.0]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceB-ospf-1-area-0.0.0.0]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceB-ospf-1]<strong> quit</strong></pre>
<p># Configure Device C.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceC]<strong> ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceC-ospf-1]<strong> area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceC-ospf-1-area-0.0.0.0]<strong> network 172.16.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceC-ospf-1-area-0.0.0.0]<strong> network 3.3.3.3 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceC-ospf-1-area-0.0.0.0]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceC-ospf-1-area-0.0.0.0]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceC-ospf-1]<strong> quit</strong></pre>
<p># Configure Server.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Server]<strong> ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Server-ospf-1]<strong> area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Server-ospf-1-area-0.0.0.0]<strong> network 4.4.4.4 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Server-ospf-1-area-0.0.0.0]<strong> network 10.2.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Server-ospf-1-area-0.0.0.0]<strong> network 10.2.2.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Server-ospf-1-area-0.0.0.0]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Server-ospf-1-area-0.0.0.0]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Server-ospf-1]<strong> quit</strong></pre>
</p></li><li><span>Configure IBGP connections.</span><p><p># Configure Device B.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceB]<strong> bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp]<strong> router-id 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp] <strong>peer 10.2.3.2 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp] <strong>peer 172.16.1.2 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp] <strong>import-route ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceB-bgp]<strong> quit</strong></pre>
<p># Configure Device C.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceC]<strong> bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceC-bgp]<strong> router-id 3.3.3.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceC-bgp]<strong> peer 172.16.1.1 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceC-bgp]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceC-bgp]<strong> quit</strong></pre>
<p># Configure Server.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Server]<strong> bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Server-bgp]<strong> router-id 4.4.4.4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Server-bgp]<strong> peer 10.2.3.1 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Server-bgp]<strong> import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Server-bgp]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Server-bgp]<strong> quit</strong></pre>
</p></li><li><span>Configure an EBGP connection.</span><p><p># Configure Device A.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceA]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceA-bgp]<strong> router-id 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceA-bgp] <strong>peer 10.1.1.2 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceA-bgp] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceA-bgp]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceA-bgp]<strong> quit</strong></pre>
<p># Configure Device B.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceB]<strong> bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp] <strong>peer 10.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceB-bgp]<strong> quit</strong></pre>
</p></li><li><span>Create a VPN instance, bind it to the Device B interface connected to Server, and configure a route-policy.</span><p><p># Configure Device B.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceB]<strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-vpn-instance-vpna-af-ipv4]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-vpn-instance-vpna]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB]<strong> interface GigabitEthernet<span>0/2/0</span>.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-GigabitEthernet<span>0/2/0</span>.2]<strong> ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-GigabitEthernet<span>0/2/0</span>.2]<strong> ip address 10.2.2.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-GigabitEthernet<span>0/2/0</span>.2]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB]<strong> ospf 2 vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-ospf-2]<strong> area 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-ospf-2-area-0.0.0.1]<strong> network 10.2.2.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-ospf-2-area-0.0.0.1]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-ospf-2]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB]<strong> ip community-filter basic serverRoute index 10 permit 100:100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB]<strong> route-policy noexportServer deny node 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-route-policy]<strong> if-match community-filter serverRoute</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-route-policy]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB]<strong> route-policy noexportServer permit node 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-route-policy]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB]<strong> route-policy setCom permit node 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-route-policy]<strong> apply community 100:100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-route-policy]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB]<strong> bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp]<strong> peer 10.2.3.2 route-policy setCom import</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB]<strong> commit</strong></pre>
</p></li><li><span>Configure Device C and Server to import a static route into the BGP routing table. The static routes are used to simulate traffic diversion to Server based on the longest match rule for route selection.</span><p><p># Configure Device C.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceC]<strong> ip route-static 33.33.0.0 16 NULL 0</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceC]<strong> bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceC-bgp] <strong>network 33.33.0.0 16</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceC-bgp]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceC-bgp]<strong> quit</strong></pre>
<p># Configure Server.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Server]<strong> ip route-static 33.33.33.33 32 NULL 0</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Server]<strong> bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Server-bgp]<strong> network 33.33.33.33 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>Server-bgp]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Server-bgp]<strong> quit</strong></pre>
</p></li><li><span>Enable Device B to import public network BGP routes into the VPN routing table. Routes are advertised to simulate traffic, so that re-injected traffic can be forwarded to Device C.</span><p><p># Configure Device B.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceB]<strong> bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp-vpna] <strong>import-rib public route-policy noexportServer</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DeviceB-bgp]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DeviceB-bgp]<strong> quit</strong></pre>
</p></li><li><span>Verify the configuration.</span><p><p># Check the BGP public network routing table on Device B. The command output shows the public network routes learned from Device A, Device C, and Server. Traffic to 33.33.0.0 is preferentially transmitted to Server along the route destined for 33.33.33.33/32 with the next hop address 10.2.3.2 according to the longest match rule.</p>
<pre class="screen">&lt;DeviceB&gt; <strong>display bgp routing-table</strong></pre>
<pre class="screen"> BGP Local router ID is 2.2.2.2
 Status codes: * - valid, &gt; - best, d - damped, x - best external, a - add path,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete
 RPKI validation codes: V - valid, I - invalid, N - not-found

 Total Number of Routes: 10
        Network            NextHop                       MED        LocPrf    PrefVal Path/Ogn


 *&gt;     1.1.1.1/32         10.1.1.1                       0                     0      100?
 *&gt;     2.2.2.2/32         0.0.0.0                        0                     0       ?
 *&gt;     3.3.3.3/32         0.0.0.0                        1                     0       ?
 *&gt;i    4.4.4.4/32         10.2.3.2                       0          100        0       ?
        10.1.1.0/24        10.1.1.1                       0                     0      100?
 *&gt;     10.2.3.0/24        0.0.0.0                        0                     0       ?
   i                       10.2.3.2                       0          100        0       ?
<strong> *&gt;i    33.33.0.0/16      172.16.1.2                     0          100        0       i</strong>
<strong> *&gt;i    33.33.33.33/32    10.2.3.2                       0          100        0       i</strong>
 *&gt;     172.16.1.0/24      0.0.0.0                        0                     0       ?</pre>
<p># Check the BGP VPN routing table on Device B. The command output shows that the public network BGP routes are imported into the VPN routing table and no public network routes are learned from Server. Server transmits traffic to Device C over the route destined for 33.33.0.0/16 with the next hop address 172.16.1.2.</p>
<pre class="screen">&lt;DeviceB&gt; <strong>display bgp vpnv4 vpn-instance vpna routing-table</strong></pre>
<pre class="screen"> BGP Local router ID is 2.2.2.2
 Status codes: * - valid, &gt; - best, d - damped, x - best external, a - add path,
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete
 RPKI validation codes: V - valid, I - invalid, N - not-found

 VPN-Instance vpna, Router ID 2.2.2.2:

 Total Number of Routes: 2
        Network            NextHop         MED        LocPrf      PrefVal   Path/Ogn

 *&gt;     1.1.1.1/32         10.1.1.1         0                        0        100?
 *&gt;i    <strong>33.33.0.0/16      172.16.1.2 </strong>      0          100           0         i</pre>
<p># Check the BGP VPN routing table on Device B. The next hop address in the route destined for 33.33.33.33 has been set to the address of Device C's outbound interface.</p>
<pre class="screen">&lt;DeviceB&gt; <strong>display bgp vpnv4 vpn-instance vpna routing-table 33.33.33.33 </strong></pre>
<pre class="screen"> BGP local router ID : 2.2.2.2
 Local AS number : 200

 VPN-Instance vpna, Router ID 2.2.2.2:
 Paths:   1 available, 1 best, 1 select, 0 best-external, 0 add-path
 BGP routing table entry information of 33.33.0.0/16:
 Route Distinguisher: 100:1
 <strong>From: 172.16.1.2 (3.3.3.3)</strong>
 Route Duration: 0d03h12m45s
 Relay IP Nexthop: 172.16.1.2
 Relay IP Out-Interface: GigabitEthernet<span>0/3/0</span>
 Original nexthop: 172.16.1.2
 Qos information : 0x0
 Primary Routing Table: public
 AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, select, pre 255
 Not advertised to any peer yet</pre>
<p>The public network routes to Device C are imported into the VPN routing table of Device B. The traffic from Server is injected back to Device C through Device B. In addition, public network routes to Server are not imported into the VPN routing table of Device B, thereby preventing loops.</p>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172369484__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>Device A configuration file</p>
<pre class="screen">#
sysname DeviceA
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.0
#
interface LoopBack1
 ip address 1.1.1.1 255.255.255.255
#
bgp 100
 router-id 1.1.1.1
 peer 10.1.1.2 as-number 200
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 10.1.1.2 enable
#
return</pre>
</li><li><p>Device B configuration file</p>
<pre class="screen">#
sysname DeviceB
#
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.1.2 255.255.255.0
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 10.2.3.1 255.255.255.0
#
interface GigabitEthernet<span>0/2/0</span>.1
 ip address 10.2.1.1 255.255.255.0
#
interface GigabitEthernet<span>0/2/0</span>.2
 ip binding vpn-instance vpna
 ip address 10.2.2.1 255.255.255.0
#
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown
 ip address 172.16.1.1 255.255.255.0
#
interface LoopBack1
 ip address 2.2.2.2 255.255.255.255
#
bgp 200
 router-id 2.2.2.2
 peer 10.1.1.1 as-number 100
 peer 10.2.3.2 as-number 200
 peer 172.16.1.2 as-number 200
 #
 ipv4-family unicast
  undo synchronization
  import-route ospf 1
  peer 10.1.1.1 enable
  peer 10.2.3.2 enable
  peer 10.2.3.2 route-policy setCom import
  peer 172.16.1.2 enable
 #
 ipv4-family vpn-instance vpna
  import-rib public route-policy noexportServer
#
ospf 1
 area 0.0.0.0
  network 2.2.2.2 0.0.0.0
  network 10.2.1.0 0.0.0.255
  network 10.2.3.0 0.0.0.255
  network 172.16.1.0 0.0.0.255
#
ospf 2 vpn-instance vpna
 area 0.0.0.1
  network 10.2.2.0 0.0.0.255
#
ip community-filter basic serverRoute index 10 permit 100:100
#
route-policy noexportServer deny node 10
 if-match community-filter serverRoute 
#
route-policy noexportServer permit node 100
#
route-policy setCom permit node 10
 apply community 100:100
#
return</pre>
</li><li><p>Device C configuration file</p>
<pre class="screen">sysname DeviceC
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 172.16.1.2 255.255.255.0
#
bgp 200
 router-id 3.3.3.3
 peer 172.16.1.1 as-number 200
 #
 ipv4-family unicast
  undo synchronization
  network 33.33.0.0 255.255.0.0
  peer 172.16.1.1 enable
#
ospf 1
 area 0.0.0.0
  network 3.3.3.3 0.0.0.0
  network 172.16.1.0 0.0.0.255
#
ip route-static 33.33.0.0 255.255.0.0 NULL0
#
return</pre>
</li><li><p>Server configuration file</p>
<pre class="screen">sysname Server
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.2.3.2 255.255.255.0
#
interface GigabitEthernet<span>0/1/0</span>.1
 ip address 10.2.1.2 255.255.255.0
#
interface GigabitEthernet<span>0/1/0</span>.2
 ip address 10.2.2.2 255.255.255.0
#
interface LoopBack1
 ip address 4.4.4.4 255.255.255.255
#
bgp 200
 router-id 4.4.4.4
 peer 10.2.3.1 as-number 200
 #
 ipv4-family unicast
  undo synchronization
  network 33.33.33.33 255.255.255.255
  import-route direct
  peer 10.2.3.1 enable
#
ospf 1
 area 0.0.0.0
  network 4.4.4.4 0.0.0.0
  network 10.2.1.0 0.0.0.255
  network 10.2.2.0 0.0.0.255
#
ip route-static 33.33.33.33 255.255.255.255 NULL0
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0101.html">Configuration Examples for BGP/MPLS IP VPN
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0110.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0320.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>