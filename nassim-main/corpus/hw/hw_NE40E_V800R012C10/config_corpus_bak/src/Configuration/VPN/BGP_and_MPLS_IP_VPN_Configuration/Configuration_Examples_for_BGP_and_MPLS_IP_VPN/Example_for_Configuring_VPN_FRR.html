
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring VPN FRR">
<meta name="abstract" content="In CE dual-homing networking, you can configure VPN FRR to quickly switch VPN services to another link if a PE fails.">
<meta name="description" content="In CE dual-homing networking, you can configure VPN FRR to quickly switch VPN services to another link if a PE fails.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0101.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0310.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_2014.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,l3vpnvrp,w00556928,l00468467,w00606909,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="h00847023">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="h00847023">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172369555">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring VPN FRR</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172369555"></a><a name="EN-US_TASK_0172369555"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring VPN FRR</h1>
<div class="taskbody"><p>In CE dual-homing networking, you can configure VPN FRR to quickly switch VPN services to another link if a PE fails.</p>
<div class="context"><a name="EN-US_TASK_0172369555__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>On the network shown in <a href="#EN-US_TASK_0172369555__fig_dc_vrp_mpls-l3vpn-v4_cfg_012601">Figure 1</a>, it is required that a backup next hop be configured on PE1 with PE3 serving as a backup to PE2, so that when PE2 fails, the traffic can be quickly switched to PE3.</p>
<div class="fignone" id="EN-US_TASK_0172369555__fig_dc_vrp_mpls-l3vpn-v4_cfg_012601"><a name="EN-US_TASK_0172369555__fig_dc_vrp_mpls-l3vpn-v4_cfg_012601"></a><a name="fig_dc_vrp_mpls-l3vpn-v4_cfg_012601"></a><span class="figcap"><b>Figure 1 </b>VPN FRR networking</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 through 3 in this example represent GE<span>0/1/0</span>, GE<span>0/2/0</span>, and GE<span>0/3/0</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="images/fig_dc_vrp_mpls-l3vpn-v4_cfg_012601.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369555__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Notes</h4><p>During the configuration process, note the following:</p>
<ul><li>When configuring VPN FRR, ensure that the CE is dual-homed to two PEs configured with VPN instances of different RDs.</li><li>In a VPN FRR scenario, after the primary path recovers, traffic switches back to this path. Because the order in which nodes undergo IGP convergence differs, packet loss may occur during the switchback. To resolve this problem, run the <a href="cmdqueryname=route-select+delay"><b><span class="cmdname">route-select delay</span></b></a> <em>delay-value</em> command to configure a route selection delay so that traffic is switched back only after forwarding entries on the devices along the primary path are updated. The delay specified using <em>delay-value</em> depends on various factors, such as the number of routes on the devices. Set a proper delay as needed.</li></ul>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369555__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure OSPF for PE1, PE2, and PE3 on the MPLS backbone network to communicate.</p>
</li><li><p>Configure MPLS and MPLS LDP both globally and per interface on each node and establish LDP LSPs on the MPLS backbone network.</p>
</li><li><p>Configure a VPN instance on each PE (PE1, PE2, and PE3) and bind the interfaces that connect PE2 and PE3 to CE1 to the VPN instances on PE2 and PE3.</p>
</li><li><p>Establish MP-EBGP peer relationships between each PE and CE1 to import VPN routes. Establish an MP-IBGP peer relationship between PE1 and PE2 and between PE1 and PE3.</p>
</li><li><p>Configure dynamic BFD for LDP tunnel on PE1, PE2, and PE3.</p>
</li><li><p>Configure BGP auto FRR on PE1.</p>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369555__1.4.4"></a><a name="1.4.4"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li><p>Number of the AS where the PEs reside (100) and number of the AS where the CE resides (65410)</p>
</li><li><p>Names of the VPN instances configured on PEs</p>
</li><li><p>The BFD configuration name, local discriminator, and remote discriminator.</p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172369555__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure interface IP addresses for devices on the MPLS backbone network and at VPN sites. For configuration details, see the configuration files.</span></li><li><span>Configure OSPF for PEs on the MPLS backbone network to communicate. For configuration details, see the configuration files.</span></li><li><span>Configure MPLS and MPLS LDP both globally and per interface on each node and establish LDP LSPs on the MPLS backbone network.</span><p><p># Configure PE1.</p>
<pre class="screen">&lt;PE1&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls lsr-id 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet<span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/3/0</span>]<strong> quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">&lt;PE2&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls lsr-id 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> quit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">&lt;PE3&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>mpls lsr-id 3.3.3.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>]<strong> mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3-GigabitEthernet<span>0/1/0</span>]<strong> quit</strong></pre>
<p>Run the <strong>display mpls lsp</strong> command on PEs. The command output shows that an LSP is established between PE1 and PE2 and between PE1 and PE3. The following example uses the command output on PE1.</p>
<pre class="screen">&lt;PE1&gt;<strong> display mpls lsp</strong></pre>
<pre class="screen">Flag after Out IF: (I) - RLFA Iterated LSP, (I*) - Normal and RLFA Iterated LSP                                                     
Flag after LDP FRR: (L) - Logic FRR LSP                                                                                             
-------------------------------------------------------------------------------                                                     
                 LSP Information: LDP LSP                                                                                           
-------------------------------------------------------------------------------
FEC                In/Out Label    In/Out IF                      Vrf Name
1.1.1.1/32         3/NULL          -/-
2.2.2.2/32         NULL/3          -/GE<span>0/2/0</span>
2.2.2.2/32         4096/3          -/GE<span>0/2/0</span>
3.3.3.3/32         NULL/3          -/GE<span>0/3/0</span>
3.3.3.3/32         4097/3          -/GE<span>0/3/0</span></pre>
</p></li><li><span>Configure a VPN instance on each PE and bind the interfaces that connect PE2 and PE3 to CE1 to the VPN instances on PE2 and PE3.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 111:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1-af-ipv4] <strong>route-distinguisher 100:2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 111:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>]<strong> ip address 10.1.1.2 30</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn1-af-ipv4] <strong>route-distinguisher 100:3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 111:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/2/0</span>]<strong> ip address 10.2.1.2 30</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/2/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
</p></li><li><span>Establish an MP-EBGP peer relationship between PE2 and the CE and between PE3 and the CE to import VPN routes destined for the CE's loopback interface.</span><p><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpn1]<strong> peer 10.1.1.1 as-number 65410</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpn1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp-vpn1] <strong>quit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword">*</span>PE3]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>ipv4-family vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-vpn1] <strong>peer 10.2.1.1 as-number 65410</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-vpn1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3-bgp-vpn1] <strong>quit</strong></pre>
<p># Configure the CE.</p>
<pre class="screen">[<span class="keyword">*</span>CE] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Loopback1] <strong>ip address 11.11.11.11 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Loopback1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE]<strong> bgp 65410</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp]<strong> peer 10.1.1.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp]<strong> peer 10.2.1.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp]<strong> network 11.11.11.11 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE]<strong> commit</strong></pre>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpn1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-vpn1] <strong>quit</strong></pre>
<p>After completing the configurations, run the <strong>display bgp vpnv4 vpn-instance peer</strong> command on PE2 and PE3. The command output shows that an EBGP peer relationship has been established between PE2 and the CE and between PE3 and the CE.</p>
<p>The following example uses the command output on PE2.</p>
<pre class="screen">&lt;PE2&gt; <strong>display bgp vpnv4 vpn-instance vpn1 peer</strong></pre>
<pre class="screen"> BGP local router ID : 10.10.1.2
 Local AS number : 100

 VPN-Instance vpn1, Router ID 10.10.1.2:
 Total number of peers : 1                 Peers in established state : 1

  Peer            V          AS  MsgRcvd  MsgSent  OutQ  Up/Down       State  PrefRcv
  10.1.1.1        4       65410       29       28     0 00:22:20 <strong>Established</strong>       1</pre>
</p></li><li><span>Establish an MP-IBGP peer relationship between PEs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp]<strong> peer 2.2.2.2 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 3.3.3.3 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp]<strong> peer 3.3.3.3 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-vpnv4] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp] <strong>peer 1.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp]<strong> peer 1.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 1.1.1.1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp-af-vpnv4] <strong>quit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3-bgp] <strong>peer 1.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 1.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-vpnv4]<strong> peer 1.1.1.1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3-bgp-af-vpnv4] <strong>quit</strong></pre>
<p>After completing the configurations, run the <strong>display bgp vpnv4 all peer</strong> command on PEs. The command output shows that the MP-IBGP peer relationships have been established.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">&lt;PE1&gt; <strong>display bgp vpnv4 all peer</strong></pre>
<pre class="screen"> BGP local router ID : 1.1.1.1
 Local AS number : 100
 Total number of peers : 2                 Peers in established state : 2

  Peer            V          AS  MsgRcvd  MsgSent  OutQ  Up/Down       State  PrefRcv
  2.2.2.2         4         100       43       30     0 00:21:55 <strong>Established</strong>       1
  3.3.3.3         4         100       36       25     0 00:18:12 <strong>Established</strong>       1</pre>
</p></li><li><span>Configure dynamic BFD for LDP tunnel.</span><p><p># Configure dynamic BFD for LDP tunnel on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bfd</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bfd] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>mpls bfd enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>mpls bfd-trigger-tunnel host</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure dynamic BFD for LDP tunnel on PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bfd</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bfd] <strong>mpls-passive</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bfd] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure dynamic BFD for LDP tunnel on PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>bfd</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bfd] <strong>mpls-passive</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bfd] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
<p># Run the <strong>display bfd session all verbose</strong> command on PE1 and PE2. The command output shows that the <strong>State</strong> field is displayed as <strong>Up</strong> and the <strong>BFD Bind Type</strong> field is displayed as <strong>LDP_TUNNEL</strong>.</p>
</p></li><li><span>Enable BGP auto FRR.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>ipv4-family vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpn1] <strong>auto-frr</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpn1] <strong>route-select delay 300</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># View the backup next hop, backup label, and backup tunnel ID.</p>
<pre class="screen">&lt;PE1&gt;<strong> display ip routing-table vpn-instance vpn1 11.11.11.11 verbose</strong></pre>
<pre class="screen"><span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : vpn1
Summary Count : 1

Destination: 11.11.11.11/32
     Protocol: IBGP            Process ID: 0
   Preference: 255                   Cost: 0
      <strong>NextHop: 2.2.2.2</strong>         Neighbour: 0.0.0.0
        State: Active Adv Relied      Age: 00h08m28s
          Tag: 0                 Priority: low
        Label: 4098               QoSInfo: 0x0
   IndirectID: 0x6400006D
 RelayNextHop: 10.10.1.2        Interface: GigabitEthernet<span>0/2/0</span>
     TunnelID: 0x0000000001004c4b42 Flags: RD
    <strong>BkNextHop: 3.3.3.3</strong>       BkInterface: GigabitEthernet<span>0/3/0</span>
      <strong>BkLabel: 4098</strong>          SecTunnelID: 0x0
 BkPETunnelID: 0x0000000001004c4b43 BkPESecTunnelID: 0x0
 BkIndirectID: 0x6400006F</pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172369555__1.4.6"></a><a name="1.4.6"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>PE1 configuration file</p>
<pre class="screen">#
sysname PE1
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
bfd
#
mpls lsr-id 1.1.1.1
#               
mpls
 mpls bfd enable
 mpls bfd-trigger-tunnel host
#
mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 10.10.1.1 255.255.255.252
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown
 ip address 10.20.1.1 255.255.255.252
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 1.1.1.1 255.255.255.255
#
bgp 100
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack1
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 2.2.2.2 enable
  peer 3.3.3.3 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 2.2.2.2 enable
  peer 3.3.3.3 enable
 #              
 ipv4-family vpn-instance vpn1
  auto-frr
  route-select delay 300
#
ospf 1
 area 0.0.0.0
  network 1.1.1.1 0.0.0.0
  network 10.10.1.0 0.0.0.3
  network 10.20.1.0 0.0.0.3
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:2
  apply-label per-instance
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
bfd
 mpls-passive
#
mpls lsr-id 2.2.2.2
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.10.1.2 255.255.255.252
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 10.1.1.2 255.255.255.252
#
interface LoopBack1
 ip address 2.2.2.2 255.255.255.255
#
bgp 100
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.1 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.1 enable
 #
 ipv4-family vpn-instance vpn1
  peer 10.1.1.1 as-number 65410
#
ospf 1
 area 0.0.0.0
  network 2.2.2.2 0.0.0.0
  network 10.10.1.0 0.0.0.3
#
return</pre>
</li><li><p>PE3 configuration file</p>
<pre class="screen">#
sysname PE3
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:3
  apply-label per-instance
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
bfd
 mpls-passive
#
mpls lsr-id 3.3.3.3
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.20.1.2 255.255.255.252
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown  
 ip binding vpn-instance vpn1
 ip address 10.2.1.2 255.255.255.252
#
interface LoopBack1
 ip address 3.3.3.3 255.255.255.255
#
bgp 100
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.1 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.1 enable
 #
 ipv4-family vpn-instance vpn1
  peer 10.2.1.1 as-number 65410
#
ospf 1
 area 0.0.0.0
  network 3.3.3.3 0.0.0.0
  network 10.20.1.0 0.0.0.3
#
return</pre>
</li><li><p>CE configuration file</p>
<pre class="screen">#
sysname CE
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.252
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 10.2.1.1 255.255.255.252
#
interface LoopBack1
 ip address 11.11.11.11 255.255.255.255
#
bgp 65410
 peer 10.1.1.2 as-number 100
 peer 10.2.1.2 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  network 11.11.11.11 255.255.255.255
  peer 10.1.1.2 enable
  peer 10.2.1.2 enable
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0101.html">Configuration Examples for BGP/MPLS IP VPN
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0310.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_2014.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>