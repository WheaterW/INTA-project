
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring Hybrid FRR for IP and VPNv4 Routes">
<meta name="abstract" content="On a network where a CE is dual-homed to two PEs, IP+VPNv4 hybrid FRR can be configured on PEs to protect the link between either PE and the CE. If the link between one PE and the CE fails, traffic destined for the CE can be switched to the other PE for transmission.">
<meta name="description" content="On a network where a CE is dual-homed to two PEs, IP+VPNv4 hybrid FRR can be configured on PEs to protect the link between either PE and the CE. If the link between one PE and the CE fails, traffic destined for the CE can be switched to the other PE for transmission.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0101.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_2014.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0128.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,l3vpnvrp,w00556928,l00468467,w00606909,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="h00847023">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00415692">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172369564">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring Hybrid FRR for IP and VPNv4 Routes</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172369564"></a><a name="EN-US_TASK_0172369564"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring Hybrid FRR for IP and VPNv4 Routes</h1>
<div class="taskbody"><p>On a network where a CE is dual-homed to two PEs, IP+VPNv4 hybrid FRR can be configured on PEs to protect the link between either PE and the CE. If the link between one PE and the CE fails, traffic destined for the CE can be switched to the other PE for transmission.</p>
<div class="context"><a name="EN-US_TASK_0172369564__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>A CE at a VPN site is dual-homed to two PEs, and a VPNv4 peer relationship is set up between the two PEs. To protect one of the PE-CE links, IP+VPNv4 hybrid FRR can be configured.</p>
<p>If one link fails, IP+VPNv4 hybrid FRR can quickly switch traffic destined for the CE to the backup next hop (the other PE).</p>
<p>As shown in <a href="#EN-US_TASK_0172369564__fig_dc_vrp_mpls-l3vpn-v4_cfg_201501">Figure 1</a>, a CE is dual-homed to PE2 and PE3; an MPLS public network tunnel and a VPNv4 peer relationship are set up between PE2 and PE3. OSPF is configured between PE2 and the CE and EBGP is configured between PE3 and the CE to exchange routing information. PE3 learns from the CE a route to the Loopback1 interface on the CE and sends the route to its VPNv4 peer. PE2 then has two BGP routes to the Loopback1 interface on the CE. One is learned using OSPF, and the other is a VPNv4 route sent from PE3 using MP-IBGP. PE2 preferentially selects the OSPF route sent from the CE because OSPF takes precedence over BGP. PE3 selects a route to the loopback interface on the CE from the routes sent from the CE and PE2 in a similar manner.</p>
<div class="p">The company requires that:<ul><li><p>PE2 must be configured to make the VPNv4 route sent from PE3 serve as a backup for the OSPF route sent from the CE.</p>
</li><li><p>PE3 must be configured to preferentially select the EBGP route sent from the CE and use the IBGP route sent from PE2 as a backup route.</p>
</li></ul>
</div>
<p>Then, if the link between a PE and the CE fails, downstream traffic can be switched to the other PE for transmission.</p>
<p>To meet the requirements, enable VPN IP FRR on PE2 and BGP auto FRR on PE3 to implement IP+VPNv4 hybrid FRR.</p>
<div class="fignone" id="EN-US_TASK_0172369564__fig_dc_vrp_mpls-l3vpn-v4_cfg_201501"><a name="EN-US_TASK_0172369564__fig_dc_vrp_mpls-l3vpn-v4_cfg_201501"></a><a name="fig_dc_vrp_mpls-l3vpn-v4_cfg_201501"></a><span class="figcap"><b>Figure 1 </b>Configuring IP+VPNv4 hybrid FRR</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>interface1, interface2, and interface3 in this example represent GE<span>0/1/0</span>, GE<span>0/2/0</span>, and GE<span>0/3/0</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="images/fig_dc_vrp_mpls-l3vpn-v4_cfg_201501.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369564__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Precautions</h4><p>In a VPN FRR scenario, after the primary path recovers, traffic switches back to this path. Because the order in which nodes undergo IGP convergence differs, packet loss may occur during the switchback. To resolve this problem, run the <a href="cmdqueryname=route-select+delay"><b><span class="cmdname">route-select delay</span></b></a> <em>delay-value</em> command to configure a route selection delay so that traffic is switched back only after forwarding entries on the devices along the primary path are updated. The delay specified using <em>delay-value</em> depends on various factors, such as the number of routes on the devices. Set an appropriate delay as needed.</p>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369564__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure OSPF for PE1, PE2, and PE3 on the MPLS backbone network to communicate.</p>
</li><li><p>Configure MPLS and MPLS LDP both globally and per interface on each node and establish LDP LSPs on the MPLS backbone network.</p>
</li><li><p>Establish an MP-IBGP peer relationship between PEs, including between PE2 and PE3.</p>
</li><li><p>Configure a VPN instance on each PE, and configure CE access to PE2 and PE3.</p>
</li><li><p>Configure routing protocols between the PEs and the CE.</p>
</li><li><p>Configure VPN IP FRR on PE2 and BGP auto FRR on PE3.</p>
</li></ol>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172369564__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure IP addresses for involved interfaces on the VPN backbone network and at the VPN site. </span></li><li><span>Configure OSPF on the MPLS backbone network for IP connectivity between PEs. </span></li><li><span>Configure basic MPLS functions, enable MPLS LDP, and establish LDP LSPs on the MPLS backbone network.</span><p><p># Configure PE1.</p>
<pre class="screen">&lt;PE1&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls lsr-id 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet<span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1]<strong> commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">&lt;PE2&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls lsr-id 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">&lt;PE3&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>mpls lsr-id 3.3.3.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>]<strong> mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface gigabitethernet<span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/3/0</span>]<strong> mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/3/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/3/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3]<strong> commit</strong></pre>
<p>Run the <strong>display mpls lsp</strong> command on the PEs. The command output shows that LSPs are established between PE1 and PE2 and between PE1 and PE3. The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1]<strong> display mpls lsp</strong>
----------------------------------------------------------------------
                 LSP Information: LDP LSP
----------------------------------------------------------------------
FEC                In/Out Label  In/Out IF                      Vrf Name
2.2.2.2/32         NULL/3        -/GE<span>0/2/0</span>
2.2.2.2/32         1024/3        -/GE<span>0/2/0</span>
3.3.3.3/32         NULL/3        -/GE<span>0/3/0</span>
3.3.3.3/32         1025/3        -/GE<span>0/3/0</span></pre>
</p></li><li><span>Set up an MP-IBGP peer relationship between PEs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp]<strong> peer 2.2.2.2 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 3.3.3.3 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp]<strong> peer 3.3.3.3 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 1.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp]<strong> peer 1.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 3.3.3.3 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp]<strong> peer 3.3.3.3 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 1.1.1.1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 1.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 1.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp]<strong> peer 2.2.2.2 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-vpnv4]<strong> peer 1.1.1.1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-vpnv4] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
<p>Run the <strong>display bgp vpnv4 all peer</strong> command on the PEs. The command output shows that the status of the MP-IBGP peer relationship between PEs is <strong>Established</strong>.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display bgp vpnv4 all peer</strong>

 BGP local router ID : 1.1.1.1
 Local AS number : 100
 Total number of peers : 2                 Peers in established state : 2

Peer            V    AS  MsgRcvd  MsgSent    OutQ  Up/Down       State PrefRcv

<strong>2.2.2.2</strong>         4   100       20       17       0 00:13:26 <strong>Established</strong>       0
<strong>3.3.3.3</strong>         4   100       24       19       0 00:17:18 <strong>Established</strong>       1</pre>
</p></li><li><span>Configure a VPN instance on each PE, and configure CE access to PE2 and PE3.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 111:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1-af-ipv4] <strong>route-distinguisher 100:2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 111:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>]<strong> ip address 192.168.1.1 30</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn1-af-ipv4] <strong>route-distinguisher 100:2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 111:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/2/0</span>]<strong> ip address 192.168.2.1 30</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</p></li><li><span>Configure an OSPF instance on PE2 and the CE and set up an EBGP peer relationship between PE3 and the CE.</span><p><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ospf 2 vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-2] <strong>import-route bgp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-2] <strong>area 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-2-area-0.0.0.1] <strong>network 192.168.1.0 0.0.0.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-2-area-0.0.0.1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpn1] <strong>import-route ospf 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>ipv4-family vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-vpn1] <strong>peer 192.168.2.2 as-number 65410</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-vpn1] <strong>peer 192.168.2.2 preferred-value 600</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-vpn1] <strong>bestroute as-path-ignore</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
<p># Configure the CE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE] <strong>bgp 65410</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp] <strong>peer 192.168.2.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp] <strong>network 22.22.22.22 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-ospf-1] <strong>area 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-ospf-1-area-0.0.0.1] <strong>network 192.168.1.0 0.0.0.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-ospf-1-area-0.0.0.1] <strong>network 22.22.22.22 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-ospf-1-area-0.0.0.1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-ospf-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE] <strong>commit</strong></pre>
<div class="p">After completing the configuration, run the <a href="cmdqueryname=display+ip+routing-table+vpn-instance+vpn1+22.22.22.22+verbose"><b><span class="cmdname">display ip routing-table vpn-instance vpn1 22.22.22.22 verbose</span></b></a> command on PE2. The command output shows that PE2 has learned routes to the loopback interface on the CE.<pre class="screen">&lt;PE2&gt; <strong>display ip routing-table vpn-instance vpn1 22.22.22.22 verbose</strong>

<span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : vpn1
Summary Count : 2

Destination: <strong>22.22.22.22/32</strong>          
     Protocol: <strong>OSPF</strong>            Process ID: 2              
   Preference: 10                    Cost: 1              
      NextHop: <strong>192.168.1.2</strong>      Neighbour: 0.0.0.0        
        State: <strong>Active Adv</strong>             Age: 00h11m08s           
          Tag: 0                 Priority: medium         
        Label: NULL               QoSInfo: 0x0            
   IndirectID: 0x76          
 RelayNextHop: 0.0.0.0          Interface: <strong>GigabitEthernet<span>0/2/0</span></strong>
     TunnelID: 0x0                  Flags: D              

Destination: 22.22.22.22/32          
     Protocol: <strong>IBGP</strong>            Process ID: 0              
   Preference: 255                   Cost: 0              
      NextHop: <strong>3.3.3.3</strong>          Neighbour: 0.0.0.0        
        State: <strong>Inactive Adv</strong>           Age: 00h13m25s           
          Tag: 0                 Priority: low            
        Label: 0x23               QoSInfo: 0x0            
   IndirectID: 0xb7          
 RelayNextHop: 10.11.1.2        Interface: <strong>GigabitEthernet<span>0/3/0</span></strong>
     TunnelID: 0x0000000001004c4c62 Flags: R   </pre>
</div>
<p>The command output shows that PE2 has learned from the CE using OSPF and from PE3 using BGP the routes to the loopback interface on the CE. Because OSPF takes precedence over BGP, PE2 preferentially selects the OSPF route advertised by PE3.</p>
</p></li><li><span>Enable IP auto FRR for the VPN instance IPv4 address family on PE2.</span><p><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1-af-ipv4] <strong>ip frr</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</p></li><li><span>Enable BGP auto FRR for the BGP-VPN instance IPv4 address family on PE3.</span><p><p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3-bgp] <strong>ipv4-family vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-vpn1] <strong>auto-frr</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-vpn1] <strong>route-select delay 300</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</p></li><li><span>Verify the configuration. </span><p><p>After completing the configuration, run the <strong>display ip routing-table vpn-instance verbose</strong> command on PE2 and PE3 to check the VPN instance routing table on each PE. </p>
<pre class="screen">&lt;PE2&gt; <strong>display ip routing-table vpn-instance vpn1 22.22.22.22 verbose</strong>
<span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : vpn1
Summary Count : 2

Destination: 22.22.22.22/32          
     Protocol: OSPF            Process ID: 2              
   Preference: 10                    Cost: 1              
      NextHop: 192.168.1.2         Neighbour: 0.0.0.0        
        State: Active Adv             Age: 00h26m40s           
          Tag: 0                 Priority: medium         
        Label: NULL               QoSInfo: 0x0            
   IndirectID: 0x76          
 RelayNextHop: 0.0.0.0          Interface: GigabitEthernet<span>0/2/0</span>
     TunnelID: 0x0                  Flags: D              
    <strong>BkNextHop: 3.3.3.3        BkInterface: GigabitEthernet<span>0/3/0</span>
      BkLabel: 0x23           SecTunnelID: 0x0              
 BkPETunnelID: 0x0000000001004c4c62 BkPESecTunnelID: 0x0              
 BkIndirectID: 0xb7</strong>          

Destination: 22.22.22.22/32          
     Protocol: IBGP            Process ID: 0              
   Preference: 255                   Cost: 0              
      NextHop: 3.3.3.3          Neighbour: 0.0.0.0        
        State: Inactive Adv           Age: 00h28m57s           
          Tag: 0                 Priority: low            
        Label: 0x23               QoSInfo: 0x0            
   IndirectID: 0xb7          
 RelayNextHop: 10.11.1.2        Interface: GigabitEthernet<span>0/3/0</span>
     TunnelID: 0x0000000001004c4c62 Flags: R </pre>
<pre class="screen">&lt;PE3&gt; <strong>display ip routing-table vpn-instance vpn1 22.22.22.22 verbose</strong> 
<span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : vpn1
Summary Count : 1

Destination: 22.22.22.22/32          
     Protocol: IBGP            Process ID: 0              
   Preference: 255                   Cost: 0              
      NextHop: 192.168.2.2      Neighbour: 0.0.0.0        
        State: Active Adv Relied      Age: 00h00m31s           
          Tag: 0                 Priority: low            
        Label: NULL               QoSInfo: 0x0            
   IndirectID: 0xa9          
 RelayNextHop: 192.168.2.2      Interface: GigabitEthernet<span>0/2/0</span>
     TunnelID: 0x0                  Flags: RD             
    <strong>BkNextHop: 2.2.2.2       BkInterface: GigabitEthernet<span>0/3/0</span>
      BkLabel: 0x27           SecTunnelID: 0x5000098        
 BkPETunnelID: 0x0        BkPESecTunnelID: 0x0              
 BkIndirectID: 0xaa</strong></pre>
<p>The command output shows that after IP FRR is enabled, both PE2 and PE3 have the primary and backup routes to the loopback interface on the CE, and the backup route recurses to an LDP LSP.</p>
<p>Run the <a href="cmdqueryname=shutdown"><b><span class="cmdname">shutdown</span></b></a> and then <strong>display ip routing-table vpn-instance verbose</strong> commands on GE<span>0/2/0</span> of PE2. The command output shows that the next hop to the loopback interface on the CE is changed to PE3.</p>
<pre class="screen">&lt;PE2&gt; <strong>display ip routing-table vpn-instance vpn1 22.22.22.22 verbose</strong> 
<span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : vpn1
Summary Count : 1

Destination: 22.22.22.22/32          
     Protocol: <strong>IBGP</strong>            Process ID: 0              
   Preference: 255                   Cost: 0              
      NextHop: 3.3.3.3          Neighbour: 0.0.0.0        
        State: Active Adv Relied      Age: 00h33m16s           
          Tag: 0                 Priority: low            
        Label: 0x23               QoSInfo: 0x0            
   IndirectID: 0xb7          
 RelayNextHop: 10.11.1.2        Interface:<strong>GigabitEthernet<span>0/3/0</span></strong>
     TunnelID: 0x0000000001004c4c62 Flags: RD</pre>
<p>Perform the same operations on PE3. The command output shows similar information.</p>
<p>It can be concluded that IP+VPNv4 hybrid FRR has taken effect on PE2 and PE3.</p>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172369564__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>PE1 configuration file</p>
<pre class="screen">#
sysname PE1
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
mpls lsr-id 1.1.1.1
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.252
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown
 ip address 10.20.1.1 255.255.255.252
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 1.1.1.1 255.255.255.255
#
interface LoopBack2
 ip binding vpn-instance vpn1
 ip address 11.11.11.11 255.255.255.255
#
bgp 100
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack1
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 2.2.2.2 enable
  peer 3.3.3.3 enable
#
 ipv4-family vpnv4
  policy vpn-target
  peer 2.2.2.2 enable
  peer 3.3.3.3 enable
#
 ipv4-family vpn-instance vpn1
 import-route direct
#
ospf 1
 area 0.0.0.0
  network 10.10.1.0 0.0.0.3
  network 10.20.1.0 0.0.0.3
  network 1.1.1.1 0.0.0.0
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:2
  apply-label per-instance
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
  ip frr
#
mpls lsr-id 2.2.2.2
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.1.2 255.255.255.252
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 192.168.1.1 255.255.255.252
#
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown
 ip address 10.11.1.1 255.255.255.252
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 2.2.2.2 255.255.255.255
#
bgp 100
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack1
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.1 enable
  peer 3.3.3.3 enable
#
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.1 enable
  peer 3.3.3.3 enable
#
 ipv4-family vpn-instance vpn1
   import-route ospf 2
#
ospf 1
 area 0.0.0.0
  network 10.10.1.0 0.0.0.3
  network 10.11.1.0 0.0.0.3
  network 2.2.2.2 0.0.0.0
#
ospf 2 vpn-instance vpn1
 import-route bgp
 area 0.0.0.1 
  network 192.168.1.0 0.0.0.3
#
return</pre>
</li><li><p>PE3 configuration file</p>
<pre class="screen">#
sysname PE3
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:2
  apply-label per-instance
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
mpls lsr-id 3.3.3.3
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.20.1.2 255.255.255.252
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 192.168.2.1 255.255.255.252
#
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown
 ip address 10.11.1.2 255.255.255.252
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 3.3.3.3 255.255.255.255
#
bgp 100
 peer 1.1.1.1 as-number 100 
 peer 1.1.1.1 connect-interface LoopBack1
 peer 2.2.2.2 as-number 100 
 peer 2.2.2.2 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.1 enable
  peer 2.2.2.2 enable
#
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.1 enable
  peer 2.2.2.2 enable
#
 ipv4-family vpn-instance vpn1
  bestroute as-path-ignore
  auto-frr
  route-select delay 300
  peer 192.168.2.2 as-number 65410
  peer 192.168.2.2 preferred-value 600
#
ospf 1
 area 0.0.0.0
  network 10.20.1.0 0.0.0.3
  network 10.11.1.0 0.0.0.3
  network 3.3.3.3 0.0.0.0
#
return</pre>
</li><li><p>CE configuration file</p>
<pre class="screen">#
sysname CE
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 192.168.1.2 255.255.255.252
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 192.168.2.2 255.255.255.252
#
interface LoopBack1
 ip address 22.22.22.22 255.255.255.255
#
bgp 65410
 peer 192.168.2.1 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  network 22.22.22.22 255.255.255.255
  peer 192.168.2.1 enable
#
ospf 1 
 area 0.0.0.1
  network 22.22.22.22 0.0.0.0
  network 192.168.1.0 0.0.0.3
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0101.html">Configuration Examples for BGP/MPLS IP VPN
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_2014.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0128.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>