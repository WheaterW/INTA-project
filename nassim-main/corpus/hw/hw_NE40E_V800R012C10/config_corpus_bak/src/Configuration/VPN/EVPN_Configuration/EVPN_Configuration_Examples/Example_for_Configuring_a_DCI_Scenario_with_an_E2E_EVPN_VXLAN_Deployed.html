
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring a DCI Scenario with an E2E EVPN VXLAN Deployed">
<meta name="abstract" content="This section provides an example for configuring a DCI scenario with E2E EVPN VXLAN deployed. In this example, an E2E VXLAN tunnel is established between DC gateways, and an L3VPN is deployed over the DCI backbone network to transmit VXLAN packets.">
<meta name="description" content="This section provides an example for configuring a DCI scenario with E2E EVPN VXLAN deployed. In this example, an E2E VXLAN tunnel is established between DC gateways, and an L3VPN is deployed over the DCI backbone network to transmit VXLAN packets.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0010.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_umr-example.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_dci_cfg_0013.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="wwx1238417">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="c00648116,w00437000">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00878323">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172363958">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/jquery.min.idp.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/RowOrColfreezeSupport.js"></script>

<script type="text/javascript">
setTimeout(function(){
	jQueryHW(document).ready(function(){
		jQueryHW("table[rowfreeze='yes']").rowfreeze();
		jQueryHW("table[colfreeze='yes']").colfreeze();
	});
},500);
</script>
<title>Example for Configuring a DCI Scenario with an E2E EVPN VXLAN Deployed</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172363958"></a><a name="EN-US_TASK_0172363958"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring a DCI Scenario with an E2E EVPN VXLAN Deployed</h1>
<div class="taskbody"><p>This section provides an example for configuring a DCI scenario with E2E EVPN VXLAN deployed. In this example, an E2E VXLAN tunnel is established between DC gateways, and an L3VPN is deployed over the DCI backbone network to transmit VXLAN packets.</p>
<div class="context"><a name="EN-US_TASK_0172363958__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>On the network shown in <a href="#EN-US_TASK_0172363958__fig_dc_vrp_dci_cfg_001101">Figure 1</a>, an end-to-end VXLAN tunnel can be established between Device1 and Device2 to implement communication between DC A and DC B. For example, VMa1 and VMb2 need to communicate with each other. To meet this requirement, establish a BGP EVPN peer relationship between Device1 and Device2 so that they can learn MAC and IP routes from each other. In addition, gateways GW1 and GW2 in the DCs are connected to DCI-PE1 and DCI-PE2, respectively, on the backbone network. An L3VPN based on an MPLS TE tunnel is established between DCI-PE1 and DCI-PE2 to transmit VXLAN packets (which can be considered as common IP packets).</p>
<div class="fignone" id="EN-US_TASK_0172363958__fig_dc_vrp_dci_cfg_001101"><a name="EN-US_TASK_0172363958__fig_dc_vrp_dci_cfg_001101"></a><a name="fig_dc_vrp_dci_cfg_001101"></a><span class="figcap"><b>Figure 1 </b>Configuring a DCI scenario with E2E EVPN VXLAN</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 and 2 in this example represent GE <span>0/1/0</span> and GE <span>0/2/0</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="images/fig_dc_vrp_dci_cfg_001101.png" width="NaN" height="NaN"></span></div>

<div class="tableBorder"><table cellpadding="4" cellspacing="0" summary="" rowfreeze="yes" frame="border" border="1" rules="all"><caption><b>Table 1 </b>Interface IP addresses</caption><thead align="left"><tr><th align="left" class="cellrowborder" valign="top" width="12.62126212621262%" id="mcps1.4.1.4.2.4.1.1" liSelected="liSelected"><p>Device</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="43.85438543854385%" id="mcps1.4.1.4.2.4.1.2" liSelected="liSelected"><p>Interface</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="43.52435243524352%" id="mcps1.4.1.4.2.4.1.3" liSelected="liSelected"><p>IP Address</p>
</th>
</tr>
</thead>
<tbody><tr><td class="cellrowborder" rowspan="3" valign="middle" width="12.62126212621262%" headers="mcps1.4.1.4.2.4.1.1 "><p>DCI-PE1</p>
</td>
<td class="cellrowborder" valign="top" width="43.85438543854385%" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="43.52435243524352%" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.20.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/2/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>LoopBack1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>1.1.1.1/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" valign="middle" width="12.62126212621262%" headers="mcps1.4.1.4.2.4.1.1 "><p>P</p>
</td>
<td class="cellrowborder" valign="top" width="43.85438543854385%" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="43.52435243524352%" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/2/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.10.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>LoopBack1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>2.2.2.2/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" valign="middle" width="12.62126212621262%" headers="mcps1.4.1.4.2.4.1.1 "><p>DCI-PE2</p>
</td>
<td class="cellrowborder" valign="top" width="43.85438543854385%" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="43.52435243524352%" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.30.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/2/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.10.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>LoopBack1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>3.3.3.3/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" valign="top" width="12.62126212621262%" headers="mcps1.4.1.4.2.4.1.1 "><p>GW1</p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="43.85438543854385%" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="43.52435243524352%" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.20.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/2/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.40.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>LoopBack1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>4.4.4.4/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" valign="top" width="12.62126212621262%" headers="mcps1.4.1.4.2.4.1.1 "><p>GW2</p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="43.85438543854385%" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="43.52435243524352%" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.30.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/2/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.50.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>LoopBack1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>7.7.7.7/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="2" valign="top" width="12.62126212621262%" headers="mcps1.4.1.4.2.4.1.1 "><p>Device1</p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="43.85438543854385%" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/2/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="43.52435243524352%" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.40.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>LoopBack1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>5.5.5.5/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="2" valign="top" width="12.62126212621262%" headers="mcps1.4.1.4.2.4.1.1 "><p>Device2</p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="43.85438543854385%" headers="mcps1.4.1.4.2.4.1.2 "><p>GigabitEthernet <span>0/2/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="43.52435243524352%" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.50.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>LoopBack1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>6.6.6.6/32</p>
</td>
</tr>
</tbody>
</table>
</div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172363958__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li>Configure an IGP in the data centers and on the DCI backbone network.</li><li>Configure an MPLS TE tunnel on the DCI backbone network.</li><li><p>Configure a VPN instance on each DCI-PE and bind the interface connected to a gateway to the VPN instance.</p>
</li><li><p>Establish an MP-IBGP peer relationship between DCI-PEs for them to exchange VPNv4 routes.</p>
</li><li><p>Configure EBGP between DCI-PEs and gateways to exchange VPNv4 routes.</p>
</li><li>Establish a BGP EVPN peer relationship between Device1 and Device2.</li><li>Configure an end-to-end VXLAN tunnel between Device1 and Device2.</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172363958__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li>VNIs on Device1 and Device2</li><li><p>MPLS LSR IDs of the DCI-PEs and P</p>
</li><li><p>VPN instance RD</p>
</li><li><p>VPN targets used for route import and export by the VPN instance</p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172363958__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure interface IP addresses, including loopback interface addresses, on each node.</span><p><p>For details about how to configure interface IP addresses and masks, see <a href="#EN-US_TASK_0172363958__dc_vrp_dci_cfg_0011_section">Configuration Files</a>.</p>
</p></li><li><span>Configure an IGP in the data centers and on the DCI backbone network. In this example, OSPF is used.</span><p><p>For detailed configurations, see <a href="#EN-US_TASK_0172363958__dc_vrp_dci_cfg_0011_section">Configuration Files</a>. On GW1 and GW2, import BGP routes to OSPF so that Device1 and Device2 can learn the IP routes destined for each other's VTEP address.</p>
</p></li><li><span>Configure an MPLS TE tunnel on the DCI backbone network.</span><p><p>For detailed configurations, see <a href="#EN-US_TASK_0172363958__dc_vrp_dci_cfg_0011_section">Configuration Files</a>.</p>
</p></li><li><span>Configure VPN instances on DCI-PEs, connect gateways to the DCI-PEs individually, and apply a tunnel policy.</span><p><p># Configure DCI-PE1.</p>
<pre class="screen">&lt;DCI-PE1&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DCI-PE1] <strong>tunnel-policy te-lsp1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-tunnel-policy-te-lsp1] <strong>tunnel select-seq cr-lsp load-balance-number 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-tunnel-policy-te-lsp1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-vpn-instance-vpn1-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-vpn-instance-vpn1-af-ipv4] <strong>tnl-policy te-lsp1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 111:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1] <strong>interface gigabitethernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-GigabitEthernet<span>0/1/0</span>] <strong>ip binding vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-GigabitEthernet<span>0/1/0</span>] <strong>ip address 192.168.20.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1] <strong>commit</strong></pre>
<p># Configure DCI-PE2.</p>
<pre class="screen">&lt;DCI-PE2&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DCI-PE2] <strong>tunnel-policy te-lsp1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-tunnel-policy-te-lsp1] <strong>tunnel select-seq cr-lsp load-balance-number 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-tunnel-policy-te-lsp1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-vpn-instance-vpn1-af-ipv4] <strong>route-distinguisher 200:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-vpn-instance-vpn1-af-ipv4] <strong>tnl-policy te-lsp1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 111:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2] <strong>interface gigabitethernet <span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-GigabitEthernet<span>0/1/0</span>] <strong>ip binding vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-GigabitEthernet<span>0/1/0</span>] <strong>ip address 192.168.30.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2] <strong>commit</strong></pre>
</p></li><li><span>Set up an EBGP peer relationship between each DCI-PE and its connected gateway.</span><p><p># Configure DCI-PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DCI-PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-bgp] <strong>ipv4-family vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-bgp-vpn1] <strong>peer 192.168.20.2 as-number 65410</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-bgp-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1] <strong>commit</strong></pre>
<p># Configure DCI-PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DCI-PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-bgp] <strong>ipv4-family vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-bgp-vpn1] <strong>peer 192.168.30.2 as-number 65420</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-bgp-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2] <strong>commit</strong></pre>
</p></li><li><span>Set up an MP-IBGP peer relationship between DCI-PEs.</span><p><p># Configure DCI-PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DCI-PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DCI-PE1-bgp] <strong>peer 3.3.3.3 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-bgp] <strong>peer 3.3.3.3 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-bgp-af-vpnv4] <strong>peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE1] <strong>commit</strong></pre>
<p># Configure DCI-PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DCI-PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>DCI-PE2-bgp] <strong>peer 1.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-bgp] <strong>peer 1.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-bgp-af-vpnv4] <strong>peer 1.1.1.1 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>DCI-PE2] <strong>commit</strong></pre>
</p></li><li><span>Establish a BGP EVPN peer relationship between Device1 and Device2.</span><p><p># Configure Device1.</p>
<pre class="screen">&lt;Device1&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Device1] <strong>bgp 65410</strong>
[<span class="keyword">*</span>Device1-bgp] <strong>peer 4.4.4.4 as-number 65410</strong>
[<span class="keyword">*</span>Device1-bgp] <strong>peer 4.4.4.4 connect-interface LoopBack1</strong>
[<span class="keyword">*</span>Device1-bgp] <strong>peer 6.6.6.6 as-number 65420</strong>
[<span class="keyword">*</span>Device1-bgp] <strong>peer 6.6.6.6 ebgp-max-hop 255</strong>
[<span class="keyword">*</span>Device1-bgp] <strong>peer 6.6.6.6 connect-interface LoopBack1</strong>
[<span class="keyword">*</span>Device1-bgp] <strong>l2vpn-family evpn</strong>
[<span class="keyword">*</span>Device1-bgp-bgp-af-evpn] <strong>peer </strong><strong>6.6.6.6 enable</strong>
[<span class="keyword">*</span>Device1-bgp-bgp-af-evpn] <strong>peer 6.6.6.6 next-hop-invariable</strong>
[<span class="keyword">*</span>Device1-bgp-bgp-af-evpn] <strong>peer 6.6.6.6 advertise encap-type vxlan</strong>
[<span class="keyword">*</span>Device1-bgp-bgp-af-evpn] <strong>quit</strong>
[<span class="keyword">*</span>Device1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>Device1] <strong>commit</strong></pre>
</p><p><p># Configure Device2.</p>
<pre class="screen">&lt;Device2&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Device2] <strong>bgp 65420</strong>
[<span class="keyword">*</span>Device2-bgp] <strong>peer 7.7.7.7 as-number 65420</strong>
[<span class="keyword">*</span>Device2-bgp] <strong>peer </strong><strong>7.7.7.7</strong><strong> connect-interface LoopBack1</strong>
[<span class="keyword">*</span>Device2-bgp] <strong>peer 5.5.5.5 as-number 65410</strong>
[<span class="keyword">*</span>Device2-bgp] <strong>peer 5.5.5.5 ebgp-max-hop 255</strong>
[<span class="keyword">*</span>Device2-bgp] <strong>peer 5.5.5.5 connect-interface LoopBack1</strong>
[<span class="keyword">*</span>Device2-bgp] <strong>l2vpn-family evpn</strong>
[<span class="keyword">*</span>Device2-bgp-bgp-af-evpn] <strong>peer </strong><strong>5.5.5.5</strong><strong> enable</strong>
[<span class="keyword">*</span>Device2-bgp-bgp-af-evpn] <strong>peer 5.5.5.5 next-hop-invariable</strong>
[<span class="keyword">*</span>Device2-bgp-bgp-af-evpn] <strong>peer 5.5.5.5 advertise encap-type vxlan</strong>
[<span class="keyword">*</span>Device2-bgp-bgp-af-evpn] <strong>quit</strong>
[<span class="keyword">*</span>Device2-bgp] <strong>quit</strong>
[<span class="keyword">*</span>Device2] <strong>commit</strong></pre>
<p># Configure GW1. To enable the remote Device2 to learn the IP route to the VTEP address on the local Device1, GW1 needs to import the involved OSPF route into BGP.</p>
<pre class="screen">&lt;GW1&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>GW1] <strong>bgp 65410</strong>
[<span class="keyword">*</span>GW1-bgp] <strong>peer 5.5.5.5 as-number 65410</strong>
[<span class="keyword">*</span>GW1-bgp] <strong>peer 5.5.5.5 connect-interface LoopBack1</strong>
[<span class="keyword">*</span>GW1-bgp] <strong>peer 192.168.20.1 as-number 100</strong>
[<span class="keyword">*</span>GW1-bgp] <strong>network 4.4.4.4 32</strong>
[<span class="keyword">*</span>GW1-bgp] <strong>import-route ospf 1</strong>
[<span class="keyword">*</span>GW1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>GW1] <strong>commit</strong></pre>
<p># Configure GW2. To enable the remote Device1 to learn the IP route to the VTEP address on the local Device2, GW2 needs to import the involved OSPF route into BGP.</p>
<pre class="screen">&lt;GW2&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>GW2] <strong>bgp 65420</strong>
[<span class="keyword">*</span>GW2-bgp] <strong>peer 6.6.6.6 as-number 65420</strong>
[<span class="keyword">*</span>GW2-bgp] <strong>peer 6.6.6.6 connect-interface LoopBack1</strong>
[<span class="keyword">*</span>GW2-bgp] <strong>peer 192.168.30.1 as-number 100</strong>
[<span class="keyword">*</span>GW2-bgp] <strong>network 7.7.7.7 32</strong>
[<span class="keyword">*</span>GW2-bgp] <strong>import-route ospf 1</strong>
[<span class="keyword">*</span>GW2-bgp] <strong>quit</strong>
[<span class="keyword">*</span>GW2] <strong>commit</strong></pre>
</p></li><li><span>Configure an EVPN instance on Device1 and Device2.</span><p><p># Configure Device1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Device1] <strong>evpn vpn-instance evrf1 bd-mode</strong>
[<span class="keyword">*</span>Device1-evpn-instance-evrf1] <strong>route-distinguisher 10:1</strong>
[<span class="keyword">*</span>Device1-evpn-instance-evrf1] <strong>vpn-target 11:1 both</strong>
[<span class="keyword">*</span>Device1-evpn-instance-evrf1] <strong>quit</strong>
[<span class="keyword">*</span>Device1] <strong>bridge-domain 10</strong>
[<span class="keyword">*</span>Device1-bd10] <strong>vxlan vni 10 split-horizon-mode</strong>
[<span class="keyword">*</span>Device1-bd10] <strong>evpn binding vpn-instance evrf1</strong>
[<span class="keyword">*</span>Device1-bd10] <strong>quit</strong>
[<span class="keyword">*</span>Device1] <strong>commit</strong></pre>
</p><p><p># Configure Device2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Device2] <strong>evpn vpn-instance evrf1 bd-mode</strong>
[<span class="keyword">*</span>Device2-evpn-instance-evrf1] <strong>route-distinguisher 20:1</strong>
[<span class="keyword">*</span>Device2-evpn-instance-evrf1] <strong>vpn-target 11:1 both</strong>
[<span class="keyword">*</span>Device2-evpn-instance-evrf1] <strong>quit</strong>
[<span class="keyword">*</span>Device2] <strong>bridge-domain 10</strong>
[<span class="keyword">*</span>Device2-bd10] <strong>vxlan vni 10 split-horizon-mode</strong>
[<span class="keyword">*</span>Device2-bd10] <strong>evpn binding vpn-instance evrf1</strong>
[<span class="keyword">*</span>Device2-bd10] <strong>quit</strong>
[<span class="keyword">*</span>Device2] <strong>commit</strong></pre>
</p></li><li><span>Configure a VXLAN tunnel between Device1 and Device2.</span><p><p># Configure Device1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Device1] <strong>interface nve 1</strong>
[<span class="keyword">*</span>Device1-Nve1] <strong>source 5.5.5.5</strong>
[<span class="keyword">*</span>Device1-Nve1] <strong>vni 10 head-end peer-list protocol bgp</strong>
[<span class="keyword">*</span>Device1-Nve1] <strong>quit</strong>
[<span class="keyword">*</span>Device1] <strong>commit</strong></pre>
</p><p><p># Configure Device2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Device2] <strong>interface nve 1</strong>
[<span class="keyword">*</span>Device2-Nve1] <strong>source 6.6.6.6</strong>
[<span class="keyword">*</span>Device2-Nve1] <strong>vni 10 head-end peer-list protocol bgp</strong>
[<span class="keyword">*</span>Device2-Nve1] <strong>quit</strong>
[<span class="keyword">*</span>Device2] <strong>commit</strong></pre>
</p></li><li><span>Configure service access points on Device1 and Device2 and connect them to VMs through Layer 2 sub-interfaces.</span><p><p># Configure Device1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Device1] <strong>interface gigabitethernet <span>0/1/0</span></strong><strong>.1 mode l2</strong>
[<span class="keyword">*</span>Device1-GigabitEthernet <span>0/1/0</span>.1] <strong>encapsulation dot1q vid 10</strong>
[<span class="keyword">*</span>Device1-GigabitEthernet <span>0/1/0</span>.1] <strong>rewrite pop single</strong>
[<span class="keyword">*</span>Device1-GigabitEthernet <span>0/1/0</span>.1] <strong>bridge-domain 10</strong>
[<span class="keyword">*</span>Device1-GigabitEthernet <span>0/1/0</span>.1] <strong>quit</strong>
[<span class="keyword">*</span>Device1] <strong>commit</strong></pre>
</p><p><p># Configure Device2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Device2] <strong>interface gigabitethernet <span>0/1/0</span></strong><strong>.1 mode l2</strong>
[<span class="keyword">*</span>Device2-GigabitEthernet <span>0/1/0</span>.1] <strong>encapsulation dot1q vid 10</strong>
[<span class="keyword">*</span>Device2-GigabitEthernet <span>0/1/0</span>.1] <strong>rewrite pop single</strong>
[<span class="keyword">*</span>Device2-GigabitEthernet <span>0/1/0</span>.1] <strong>bridge-domain 10</strong>
[<span class="keyword">*</span>Device2-GigabitEthernet <span>0/1/0</span>.1] <strong>quit</strong>
[<span class="keyword">*</span>Device2] <strong>commit</strong></pre>
</p></li><li><span>Verify the configuration.</span><p><p>Run the <strong>display bgp evpn peer</strong> command on Device1. The command output shows that Device1 has established a BGP EVPN peer relationship with Device2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Device1] <strong>display bgp evpn peer</strong>
 Total number of peers : 1                 Peers in established state : 1

  Peer                             V          AS  MsgRcvd  MsgSent  OutQ  Up/Down       State  PrefRcv
  6.6.6.6                          4       65420      711      711     0 10:14:35 Established        2</pre>
<p>Run the <strong>display vxlan tunnel</strong> command on Device1. The command output shows that an end-to-end VXLAN tunnel has been established between Device1 and Device2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Device1] <strong>display vxlan tunnel</strong>
Number of vxlan tunnel : 1
Tunnel ID   Source                Destination           State  Type     Uptime
-----------------------------------------------------------------------------------
4026531843  5.5.5.5               6.6.6.6               up     dynamic  10:17:15</pre>
</p></li></ol></div>
<div class="example" id="EN-US_TASK_0172363958__dc_vrp_dci_cfg_0011_section"><a name="EN-US_TASK_0172363958__dc_vrp_dci_cfg_0011_section"></a><a name="dc_vrp_dci_cfg_0011_section"></a><a name="EN-US_TASK_0172363958__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li>Device1 configuration file<pre class="screen">#
sysname Device1
#
evpn vpn-instance evrf1 bd-mode
 route-distinguisher 10:1
 vpn-target 11:1 export-extcommunity
 vpn-target 11:1 import-extcommunity
#
bridge-domain 10
 vxlan vni 10 split-horizon-mode
 evpn binding vpn-instance evrf1
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
#
interface GigabitEthernet<span>0/1/0</span>.1 mode l2
 encapsulation dot1q vid 10
 rewrite pop single
 bridge-domain 10
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 192.168.40.2 255.255.255.0
#
interface LoopBack1
 ip address 5.5.5.5 255.255.255.255
#
interface Nve1
 source 5.5.5.5
 vni 10 head-end peer-list protocol bgp
#
bgp 65410
 peer 4.4.4.4 as-number 65410
 peer 4.4.4.4 connect-interface LoopBack1
 peer 6.6.6.6 as-number 65420
 peer 6.6.6.6 ebgp-max-hop 255
 peer 6.6.6.6 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 4.4.4.4 enable
  peer 6.6.6.6 enable
 #
 l2vpn-family evpn
  policy vpn-target
  peer 6.6.6.6 enable
  peer 6.6.6.6 next-hop-invariable
  peer 6.6.6.6 advertise encap-type vxlan
#
ospf 1
 area 0.0.0.0
  network 5.5.5.5 0.0.0.0
  network 192.168.40.0 0.0.0.255
#
return</pre>
</li><li>Device2 configuration file<pre class="screen">#
sysname Device2
#
evpn vpn-instance evrf1 bd-mode
 route-distinguisher 20:1
 vpn-target 11:1 export-extcommunity
 vpn-target 11:1 import-extcommunity
#
bridge-domain 10
 vxlan vni 10 split-horizon-mode
 evpn binding vpn-instance evrf1
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
#
interface GigabitEthernet<span>0/1/0</span>.1 mode l2
 encapsulation dot1q vid 10
 rewrite pop single
 bridge-domain 10
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 192.168.50.2 255.255.255.0
#
interface LoopBack1
 ip address 6.6.6.6 255.255.255.255
#
interface Nve1
 source 6.6.6.6
 vni 10 head-end peer-list protocol bgp
#
bgp 65420
 peer 5.5.5.5 as-number 65410
 peer 5.5.5.5 ebgp-max-hop 255
 peer 5.5.5.5 connect-interface LoopBack1
 peer 7.7.7.7 as-number 65420
 peer 7.7.7.7 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 5.5.5.5 enable
  peer 7.7.7.7 enable
 #
 l2vpn-family evpn
  policy vpn-target
  peer 5.5.5.5 enable
  peer 5.5.5.5 next-hop-invariable
  peer 5.5.5.5 advertise encap-type vxlan
#
ospf 1
 area 0.0.0.0
  network 6.6.6.6 0.0.0.0
  network 192.168.50.0 0.0.0.255
#
return</pre>
</li><li>GW1 configuration file<pre class="screen">#
sysname GW1
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 192.168.20.2 255.255.255.0
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 192.168.40.1 255.255.255.0
#
interface LoopBack1
 ip address 4.4.4.4 255.255.255.255
#
bgp 65410
 peer 5.5.5.5 as-number 65410
 peer 5.5.5.5 connect-interface LoopBack1
 peer 192.168.20.1 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  network 4.4.4.4 255.255.255.255
  import-route ospf 1
  peer 5.5.5.5 enable
  peer 192.168.20.1 enable
#
ospf 1
 import-route bgp
 area 0.0.0.0
  network 4.4.4.4 0.0.0.0
  network 192.168.40.0 0.0.0.255
#
return</pre>
</li><li>GW2 configuration file<pre class="screen">#
sysname GW2
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 192.168.30.2 255.255.255.0
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 192.168.50.1 255.255.255.0
#
interface LoopBack1
 ip address 7.7.7.7 255.255.255.255
#
bgp 65420
 peer 6.6.6.6 as-number 65420
 peer 6.6.6.6 connect-interface LoopBack1
 peer 192.168.30.1 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  network 7.7.7.7 255.255.255.255
  import-route ospf 1
  peer 6.6.6.6 enable
  peer 192.168.30.1 enable
#
ospf 1
 import-route bgp
 area 0.0.0.0
  network 7.7.7.7 0.0.0.0
  network 192.168.50.0 0.0.0.255
#
return</pre>
</li><li><p>DCI-PE1 configuration file</p>
<pre class="screen">#
sysname DCI-PE1
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
<span>  apply-label per-instance</span>
  tnl-policy te-lsp1
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
mpls lsr-id 1.1.1.1
#
mpls
 mpls te
 mpls te cspf
 mpls rsvp-te
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 192.168.20.1 255.255.255.0
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 192.168.1.1 255.255.255.0
 mpls
 mpls te
 mpls rsvp-te
#
interface LoopBack1
 ip address 1.1.1.1 255.255.255.255
#
interface Tunnel10 
 ip address unnumbered interface LoopBack1
 tunnel-protocol mpls te
 destination 3.3.3.3
 mpls te tunnel-id 100
#
bgp 100
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack1
#
 ipv4-family unicast
  peer 3.3.3.3 enable
#
 ipv4-family vpnv4
  policy vpn-target
  peer 3.3.3.3 enable
 #
 ipv4-family vpn-instance vpn1
  peer 192.168.20.2 as-number 65410
#
ospf 1
 opaque-capability enable
 area 0.0.0.0
  network 1.1.1.1 0.0.0.0
  network 192.168.1.0 0.0.0.255
  mpls-te enable
#
tunnel-policy te-lsp1
 tunnel select-seq cr-lsp load-balance-number 1
#
return</pre>
</li><li><p>P configuration file</p>
<pre class="screen">#
sysname P
#
mpls lsr-id 2.2.2.2
#
mpls
 mpls te
 mpls te cspf
 mpls rsvp-te
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 192.168.1.2 255.255.255.0
 mpls
 mpls te
 mpls rsvp-te
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 192.168.10.1 255.255.255.0
 mpls
 mpls te
 mpls rsvp-te
#
interface LoopBack1
 ip address 2.2.2.2 255.255.255.255
#
ospf 1
 opaque-capability enable
 area 0.0.0.0
  network 2.2.2.2 0.0.0.0
  network 192.168.1.0 0.0.0.255
  network 192.168.10.0 0.0.0.255
  mpls-te enable
#
return</pre>
</li><li><p>DCI-PE2 configuration file</p>
<pre class="screen">#
sysname DCI-PE2
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 200:1
<span>  apply-label per-instance</span>
  tnl-policy te-lsp1
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
mpls lsr-id 3.3.3.3
#
mpls
 mpls te
 mpls te cspf
 mpls rsvp-te
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 192.168.30.1 255.255.255.0
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 192.168.10.2 255.255.255.0
 mpls
 mpls te
 mpls rsvp-te
#
interface LoopBack1
 ip address 3.3.3.3 255.255.255.255
#
interface Tunnel10 
 ip address unnumbered interface LoopBack1
 tunnel-protocol mpls te
 destination 1.1.1.1
 mpls te tunnel-id 100
#
bgp 100
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack1
 #
 ipv4-family unicast
  peer 1.1.1.1 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.1 enable
 #
 ipv4-family vpn-instance vpn1
  peer 192.168.30.2 as-number 65420
 #
ospf 1
 opaque-capability enable
 area 0.0.0.0
  network 3.3.3.3 0.0.0.0
  network 192.168.10.0 0.0.0.255
  mpls-te enable
#
tunnel-policy te-lsp1
 tunnel select-seq cr-lsp load-balance-number 1
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0010.html">EVPN Configuration Examples
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_umr-example.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_dci_cfg_0013.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>