
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Configuring an EVPN Instance in BD Mode">
<meta name="abstract" content="To implement service access based on a BD and manage EVPN routes, configure BD EVPN instances on PEs.">
<meta name="description" content="To implement service access based on a BD and manage EVPN routes, configure BD EVPN instances on PEs.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0065.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0012bd.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00606909">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="l00425560">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00878323">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172370451">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Configuring an EVPN Instance in BD Mode</title>
</head>
<body><a name="EN-US_TASK_0172370451"></a><a name="EN-US_TASK_0172370451"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Configuring an EVPN Instance in BD Mode</h1>
<div class="taskbody"><p>To implement service access based on a BD and manage EVPN routes, configure BD EVPN instances on PEs.</p>
<div class="context"><a name="EN-US_TASK_0172370451__1.4.1"></a><a name="1.4.1"></a><h4 class="sectiontitle">Context</h4>
<div class="p"><p>EVPN instances are used to isolate EVPN routes from public routes and isolate the routes of EVPN instances from each other.</p>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172370451__1.4.2"></a><a name="1.4.2"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li><span>Run <a href="cmdqueryname=evpn+vpn-instance"><b><span class="cmdname">evpn vpn-instance</span></b></a> <i><span class="varname">vpn-instance-name</span></i> <strong><span>bd-mode</span></strong></span><p><p>A BD EVPN instance is created, and its view is displayed.</p>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=description"><b><span class="cmdname">description</span></b></a> <i><span class="varname">description-information</span></i></span><p><p>A description is configured for the EVPN instance.</p>
<p>Similar to a hostname or an interface description, an EVPN instance description helps you memorize the EVPN instance.</p>
</p></li><li><span>Run <a href="cmdqueryname=route-distinguisher"><b><span class="cmdname">route-distinguisher</span></b></a> <i><span class="varname">route-distinguisher</span></i></span><p><p>An RD is configured for the EVPN instance.</p>
</p><p><p>An EVPN instance takes effect only after an RD is configured for it. The RDs of different EVPN instances on a PE must be different.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If you need to create a large number of EVPN instances and plan a large number of RDs, you can run the <strong>evpn route-distinguisher auto</strong> <em>rd-ip</em> command in the system view to enable automatic RD allocation, thereby avoiding RD conflicts. The <em>rd-ip</em> parameter specifies an IPv4 address, enabling a device to allocate RDs in the format of <em>X.X.X.X</em>:<em>index</em> to all EVPN instances that are not allocated RDs. <em>X.X.X.X</em> indicates a user-defined RD-IP value, and <em>index</em> is a 2-byte value automatically allocated by the system in the range from 1 to 65535.</p>
</div></div>
</p></li><li><span>Run <a href="cmdqueryname=vpn-target"><b><span class="cmdname">vpn-target</span></b></a> <i><span class="varname">vpn-target</span></i> &amp;&lt;1-8&gt; [ <strong><span>both</span></strong> | <strong><span>export-extcommunity</span></strong> | <strong><span>import-extcommunity</span></strong> ]</span><p><p>One or multiple VPN targets are set for the EVPN instance.</p>
</p><p><p>VPN targets are BGP extended community attributes used to control the acceptance and advertisement of EVPN routes. A maximum of eight import VPN targets and eight export VPN targets can be configured each time the <a href="cmdqueryname=vpn-target"><b><span class="cmdname">vpn-target</span></b></a> command is run. To configure more VPN targets for an EVPN instance address family, run the <a href="cmdqueryname=vpn-target"><b><span class="cmdname">vpn-target</span></b></a> command multiple times.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>An RT of an Ethernet segment route is generated using the middle 6 bytes of an ESI. For example, if the ESI is 0011.1001.1001.1001.1002, the Ethernet segment route uses 11.1001.1001.10 as its RT.</p>
</div></div>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=filter-policy"><b><span class="cmdname">filter-policy</span></b></a> { <i><span class="varname">acl-number</span></i> | <strong><span>acl-name</span></strong> <i><span class="varname">acl-name</span></i> } <strong><span>export</span></strong></span><p><p>The EVPN instance is configured to filter MAC advertisement routes to be advertised.</p>
<p>To precisely control EVPN routes, an export route-policy must be configured. An export route-policy filters routes that are to be advertised to other PEs.</p>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=filter-policy"><b><span class="cmdname">filter-policy</span></b></a> { <i><span class="varname">acl-number</span></i> | <strong><span>acl-name</span></strong> <i><span class="varname">acl-name</span></i> } <strong><span>import</span></strong></span><p><p>The EVPN instance is configured to filter received MAC advertisement routes.</p>
<p>To precisely control EVPN routes, an import route-policy must be configured. An import route-policy filters routes that are received from other PEs.</p>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=mac+limit"><b><span class="cmdname">mac limit</span></b></a> <i><span class="varname">number</span></i> [ <strong><span>simply-alert</span></strong> | <strong><span>mac-unchanged</span></strong> ]</span><p><p>The maximum number of MAC addresses allowed in the EVPN instance is set.</p>
</p><p><p>A device consumes more system resources as it learns more MAC addresses, meaning that the device may fail to operate when busy processing services. To limit the maximum number of MAC addresses allowed in an EVPN instance and thereby improve device security and reliability, run the <a href="cmdqueryname=mac+limit"><b><span class="cmdname">mac limit</span></b></a> command. After this configuration, if the number of MAC addresses exceeds the preset value, an alarm is triggered to prompt you to check the validity of existing MAC addresses.</p>
<p>After the maximum number of MAC addresses allowed by an EVPN instance is configured, you can run the <a href="cmdqueryname=mac+threshold-alarm"><b><span class="cmdname">mac threshold-alarm</span></b></a> <strong><span>upper-limit</span></strong> <i><span class="varname">upper-limit-value</span></i> <strong><span>lower-limit</span></strong> <i><span class="varname">lower-limit-value</span></i> command to configure an alarm threshold for MAC addresses allowed by the EVPN instance. The alarm generation and clearance help a device detect threshold-crossing events of MAC addresses.</p>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=tnl-policy"><b><span class="cmdname">tnl-policy</span></b></a> <i><span class="varname">policy-name</span></i></span><p><p>The EVPN instance is associated with a tunnel policy.</p>
<p>This configuration enables PEs to use TE<span> or SR</span> tunnels to transmit data packets.</p>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=bypass-vxlan"><b><span class="cmdname">bypass-vxlan</span></b></a> <strong><span>disable</span></strong></span><p><p>The inter-chassis VXLAN function is disabled for the instance.</p>
</p><p><p>After the <a href="cmdqueryname=bypass-vxlan+enable"><b><span class="cmdname">bypass-vxlan enable</span></b></a> command is run globally, only EVPN VXLAN functions can be deployed on the device. If you want to configure EVPN MPLS functions for some BD EVPN instances, perform this step.</p>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=control-word+enable"><b><span class="cmdname">control-word enable</span></b></a></span><p><p>The control word function is enabled for the EVPN instance.</p>
<p>In load balancing mode, out-of-order packets may be generated when the device performs in-depth parsing on MPLS packets. In this case, you can enable the control word function in the EVPN instances on both ends to reassemble MPLS packets.</p>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=mac-route+no-advertise"><b><span class="cmdname">mac-route no-advertise</span></b></a></span><p><p>The device is disabled from sending local MAC routes to its EVPN peer.</p>
</p><p><p>In scenarios that do not involve Layer 2 traffic forwarding, perform this step to disable local MAC routes from being advertised to the EVPN peer. This configuration prevents the EVPN peer from receiving MAC routes, thereby conserving device resources.</p>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=local+mac-only-route+no-generate"><b><span class="cmdname">local mac-only-route no-generate</span></b></a></span><p><p>The device is disabled from generating EVPN MAC routes when the local MAC address exists in both a MAC address entry and an ARP/ND entry.</p>
</p><p><p>If a MAC address entry and an ARP/ND entry on the device both contain the local MAC address, the device generates both an EVPN MAC/IP route and an EVPN MAC route by default. To optimize memory utilization, perform this step so that the device generates only EVPN MAC/IP routes. To ensure normal Layer 2 traffic forwarding, also run the <a href="cmdqueryname=mac-ip+route+generate-mac"><b><span class="cmdname">mac-ip route generate-mac</span></b></a> command on the peer device to enable the function to generate MAC entries based on MAC/IP routes.</p>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=mac-ip+route+generate-mac"><b><span class="cmdname">mac-ip route generate-mac</span></b></a></span><p><p>The function to generate MAC address entries based on MAC/IP routes is enabled.</p>
<p>If the peer device is configured not to advertise MAC routes (using the <strong>mac-route no-advertise</strong> command) or not to generate MAC routes (using the <a href="cmdqueryname=local+mac-only-route+no-generate"><b><span class="cmdname">local mac-only-route no-generate</span></b></a> command), the local device cannot generate MAC entries by default. To ensure normal Layer 2 traffic forwarding, perform this step on the local device to enable the function to generate MAC entries based on MAC/IP routes.</p>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=mac-keep+disable"><b><span class="cmdname">mac-keep disable</span></b></a></span><p><p>The device is disabled from retaining MAC routes.</p>
<p>In the MAC route withdrawal process, the device retains original MAC routes for a period of time by default after receiving MAC Withdraw messages. This function is used in fault recovery and switchback scenarios to prevent MAC route flapping. In the following scenarios, however, you need to perform this step on the remote PE to disable the remote PE from retaining MAC addresses:</p>
<ul><li>Interworking between traditional VPLS and EVPN VPLS</li><li>Dual-homing access to EVPN through Eth-Trunk interfaces (LACP)</li><li>No upstream traffic from a CE to two PEs when the CE is dual-homed to the two PEs</li></ul>
<p>In the preceding scenario, when the fault is rectified and services are switched back, the device on the backup path clears the MAC address, whereas the remote PE maintains the MAC address by default. As a result, traffic is still diverted to the device on the backup path, causing traffic loss.</p>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=timer+revert+delay"><b><span class="cmdname">timer revert delay</span></b></a> <i><span class="varname">delay-value</span></i></span><p><p>A switchback delay is set.</p>
</p><p><p>In dual-homing scenarios, if a fault on the access-side link of the active PE or the active PE is rectified, the active PE generates MAC routes and advertises these routes to the remote PE through a BGP EVPN peer relationship. After receiving the MAC routes and generating forwarding entries, the remote PE switches traffic from the path destined for the standby PE to the path destined for the active PE. In this case, a few packets may be lost on the active PE because some forwarding entries are not generated. To prevent this problem, run the <strong>timer revert delay</strong> <em>delay-value</em> command on the remote PE to configure a proper switchback delay. After receiving MAC routes, the remote PE delays generating forwarding entries. Specifically, the remote PE generates forwarding entries only after the forwarding entries on the active PE become stable. After the delay timer expires, the remote PE generates new forwarding entries and sends traffic to the active PE, preventing packet loss.</p>
</p></li><li><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol></div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0065.html">Configuring EVPN VPLS over MPLS (BD EVPN Instance)
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0012bd.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>