
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring Load Balancing Among Tunnels to Which Remotely Leaked VPN Routes Recurse">
<meta name="abstract" content="Load balancing can be configured if there are multiple tunnels between PE peers on the backbone network. This implementation can fully utilize network resources and enhance the reliability of VPN services on the backbone network.">
<meta name="description" content="Load balancing can be configured if there are multiple tunnels between PE peers on the backbone network. This implementation can fully utilize network resources and enhance the reliability of VPN services on the backbone network.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0101.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0320.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0112.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,l3vpnvrp,w00556928,l00468467,w00606909,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="h00847023">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00415692">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172369491">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring Load Balancing Among Tunnels to Which Remotely Leaked VPN Routes Recurse</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172369491"></a><a name="EN-US_TASK_0172369491"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring Load Balancing Among Tunnels to Which Remotely Leaked VPN Routes Recurse</h1>
<div class="taskbody"><p>Load balancing can be configured if there are multiple tunnels between PE peers on the backbone network. This implementation can fully utilize network resources and enhance the reliability of VPN services on the backbone network.</p>
<div class="context"><a name="EN-US_TASK_0172369491__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>If multiple tunnels, such as LDP LSPs and TE tunnels, exist between PE peers on the MPLS backbone network of a BGP/MPLS IP VPN, load balancing among tunnels can be configured to distribute VPN traffic to the tunnels and prevent network congestion.</p>
<p>On the network shown in <a href="#EN-US_TASK_0172369491__fig_dc_vrp_mpls-l3vpn-v4_cfg_201101">Figure 1</a>, two links exist between PE1 and PE2 in the basic BGP/MPLS IP VPN networking: an LDP LSP (PE1 &lt;-&gt; P1 &lt;-&gt; PE2) and a TE tunnel (PE1 &lt;-&gt; P2 &lt;-&gt; PE2). All VPN traffic is forwarded over the LSP according to the default tunnel policy, which may cause the link of PE1 &lt;-&gt; P1 &lt;-&gt; PE2 to be busy and the link of PE1 &lt;-&gt; P2 &lt;-&gt; PE2 to be idle.</p>
<p>To address this problem, load balancing among tunnels can be configured on the MPLS backbone network to distribute VPN traffic evenly to the two tunnels.</p>
<div class="fignone" id="EN-US_TASK_0172369491__fig_dc_vrp_mpls-l3vpn-v4_cfg_201101"><a name="EN-US_TASK_0172369491__fig_dc_vrp_mpls-l3vpn-v4_cfg_201101"></a><a name="fig_dc_vrp_mpls-l3vpn-v4_cfg_201101"></a><span class="figcap"><b>Figure 1 </b>Configuring load balancing among tunnels to which remotely leaked VPN routes recurse</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 through 3 in this example represent GE<span>0/1/0</span>, GE<span>0/2/0</span>, and GE<span>0/3/0</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="images/fig_dc_vrp_mpls-l3vpn-v4_cfg_201101.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369491__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Notes</h4><p>When configuring load balancing among tunnels to which remotely leaked VPN routes recurse, ensure that the tunnels existing in the system meet the requirements of the configured tunnel policy.</p>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369491__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure OSPF on the MPLS backbone network to ensure IP connectivity on the backbone network.</p>
</li><li><p>On the MPLS backbone network, enable MPLS and MPLS LDP to set up an LDP LSP.</p>
</li><li><p>Configure a VPN instance on each PE and bind the interface that connects CE to PE to the VPN instance on PE.</p>
</li><li><p>Establish a TE tunnel between PE1 and PE2 (with P2 as the transit node).</p>
</li><li><p>Create a tunnel policy on PE1 to distribute traffic to the LDP LSP and MPLS TE tunnel between PE1 and PE2.</p>
</li><li><p>Apply the tunnel policy to the VPN instance IPv4 address family on PE1.</p>
</li></ol>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172369491__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure a basic BGP/MPLS IP VPN.</span><p><p>For configuration details, see <a href="dc_vrp_mpls-l3vpn-v4_cfg_0102.html">Example for Configuring Basic BGP/MPLS IP VPN</a>. The main configurations are listed as follows:</p>
<ul><li><p>Configure OSPF on the MPLS backbone network so that the PEs can learn the routes to each other's loopback interface.</p>
</li><li><p>Configure MPLS and MPLS LDP both globally and per interface on PE1, P1, and PE2 to set up an LDP LSP along the PEs.</p>
</li><li><p>Establish a VPNv4 peer relationship between PEs.</p>
</li><li><p>Configure an IPv4-address-family-supporting VPN instance on each PE and bind the interface that connects a PE to a CE to the VPN instance on that PE.</p>
</li><li><p>Enable BGP between the PEs and CE, and import the routes to the loopback interface into BGP on the CE.</p>
</li></ul>
<p>After completing the configurations, run the <strong>display ip routing-table vpn-instance</strong> command on PE1. The command output shows that PE1 has learned the route to the loopback interface on CE2.</p>
<pre class="screen">&lt;PE1&gt; <strong>display ip routing-table vpn-instance vpn1</strong></pre>
<pre class="screen"><span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : vpn1
         Destinations : 4        Routes : 4         

Destination/Mask    Proto  Pre  Cost        Flags NextHop         Interface

    11.11.11.11/32  EBGP   255  0             D  192.168.2.2     GigabitEthernet<span>0/3/0</span>
    22.22.22.22/32  IBGP   255  0             RD 3.3.3.9         GigabitEthernet<span>0/2/0</span></pre>
<pre class="screen">&lt;PE1&gt; <strong>display ip routing-table vpn-instance vpn1 22.22.22.22 verbose</strong>
<span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : vpn1
Summary Count : 1

Destination: 22.22.22.22/32      
     Protocol: IBGP            Process ID: 0              
   Preference: 255                   Cost: 0              
      NextHop: 3.3.3.9          Neighbour: 0.0.0.0        
        State: Active Adv Relied      Age: 00h02m28s           
          Tag: 0                 Priority: low            
        Label: 0x1f               QoSInfo: 0x0            
   IndirectID: 0xb7          
<strong> RelayNextHop: 20.1.1.2         Interface: GigabitEthernet<span>0/2/0</span>
     TunnelID: 0x0000000001004c4b43 Flags: RD  </strong></pre>
<p>The command output shows that the route to 22.22.22.22/32 recurses only to one LSP on PE1 because no tunnel policy is applied to the VPN.</p>
</p></li><li><span>Establish a TE tunnel between PE1 and PE2 (with P2 as the transit node).</span><p><p>This example uses an RSVP-TE tunnel. For details, see <a href="dc_vrp_te-p2p_cfg_0094.html">Example for Configuring an RSVP-TE Tunnel</a>.</p>
</p></li><li><span>Apply a tunnel policy to the VPN on PE1.</span><p><p>Configure a tunnel policy in select-sequence mode to make tunnels be selected in the order of TE tunnels and LSPs and to set the number of tunnels participating in load balancing to 2.</p>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>tunnel-policy te-lsp-l2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-tunnel-policy-te-lsp-l2] <strong>tunnel select-seq cr-lsp lsp load-balance-number 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-tunnel-policy-te-lsp-l2] <strong>quit</strong></pre>
<p># Apply a tunnel policy to the VPN instance IPv4 address family.</p>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1-af-ipv4] <strong>tnl-policy te-lsp-l2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</p></li><li><span>Verify the configuration.</span><p><p>After completing the configurations, run the <strong>display ip routing-table vpn-instance verbose</strong> command on PE1. The command output shows that the route to the loopback interface on the CE recurses to two tunnels.</p>
<pre class="screen">&lt;PE1&gt; <strong>display ip routing-table vpn-instance vpn1 22.22.22.22 verbose</strong>
<span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : vpn1
Summary Count : 1

Destination: 22.22.22.22/32      
     Protocol: IBGP            Process ID: 0              
   Preference: 255                   Cost: 0              
      NextHop: 3.3.3.9          Neighbour: 0.0.0.0        
        State: Active Adv Relied      Age: 00h00m06s           
          Tag: 0                 Priority: low            
        Label: 0x1f               QoSInfo: 0x0            
   IndirectID: 0xbc          
<strong> RelayNextHop: 0.0.0.0          Interface: Tunnel10
     TunnelID: 0x000000000300000001 Flags: RD             
 RelayNextHop: 20.1.1.2         Interface: GigabitEthernet<span>0/2/0</span>
     TunnelID: 0x0000000001004c4b43 Flags: RD </strong></pre>
<p>Load balancing among tunnels to which remotely leaked routes recurse is successfully deployed on the VPN.</p>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172369491__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>PE1 configuration file</p>
<pre class="screen">#
sysname PE1
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance
  tnl-policy te-lsp-l2
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
mpls lsr-id 1.1.1.9
#
mpls
 mpls te
 mpls te cspf
 mpls rsvp-te
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 50.1.1.1 255.255.255.0
 mpls
 mpls te
 mpls rsvp-te
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 20.1.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 192.168.2.1 255.255.255.252
#
interface LoopBack1
 ip address 1.1.1.9 255.255.255.255
#
interface Tunnel10
 ip address unnumbered interface LoopBack1
 tunnel-protocol mpls te
 destination 3.3.3.9
 mpls te tunnel-id 100
#
bgp 100
 peer 3.3.3.9 as-number 100
 peer 3.3.3.9 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 3.3.3.9 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 3.3.3.9 enable
#
  ipv4-family vpn-instance vpn1
   peer 192.168.2.2 as-number 65420
#
ospf 1
 opaque-capability enable
 area 0.0.0.0
  mpls-te enable 
  network 1.1.1.9 0.0.0.0
  network 50.1.1.0 0.0.0.255
  network 20.1.1.0 0.0.0.255
#
tunnel-policy te-lsp-l2
 tunnel select-seq cr-lsp lsp load-balance-number 2
#
return</pre>
</li><li><p>P1 configuration file</p>
<pre class="screen">#
sysname P1
#
mpls lsr-id 2.2.2.9
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 20.1.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 30.1.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 2.2.2.9 255.255.255.255
#
ospf 1
 opaque-capability enable
 area 0.0.0.0
  mpls-te enable 
  network 2.2.2.9 0.0.0.0
  network 20.1.1.0 0.0.0.255
  network 30.1.1.0 0.0.0.255
#
return</pre>
</li><li><p>P2 configuration file</p>
<pre class="screen">#
sysname P2
#
mpls lsr-id 4.4.4.9
#
mpls
 mpls te
 mpls te cspf
 mpls rsvp-te
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 50.1.1.2 255.255.255.0
 mpls
 mpls te
 mpls rsvp-te
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 40.1.1.1 255.255.255.0
 mpls
 mpls te
 mpls rsvp-te
#
interface LoopBack1
 ip address 4.4.4.9 255.255.255.255
#
ospf 1
 opaque-capability enable
 area 0.0.0.0
  mpls-te enable 
  network 4.4.4.9 0.0.0.0
  network 50.1.1.0 0.0.0.255
  network 40.1.1.0 0.0.0.255
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
mpls lsr-id 3.3.3.9
#
mpls
 mpls te
 mpls te cspf
 mpls rsvp-te
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 40.1.1.2 255.255.255.0
 mpls
 mpls te
 mpls rsvp-te
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 30.1.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 192.168.1.1 255.255.255.252
#
interface LoopBack1
 ip address 3.3.3.9 255.255.255.255
#
bgp 100
 peer 1.1.1.9 as-number 100
 peer 1.1.1.9 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.9 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.9 enable
#
 ipv4-family vpn-instance vpn1
  peer 192.168.1.2 as-number 65410
#
ospf 1
 opaque-capability enable
 area 0.0.0.0
  mpls-te enable 
  network 3.3.3.9 0.0.0.0
  network 30.1.1.0 0.0.0.255
  network 40.1.1.0 0.0.0.255
#
return</pre>
</li><li><p>CE1 configuration file</p>
<pre class="screen">#
sysname CE1
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 192.168.2.2 255.255.255.252
#
interface LoopBack1
 ip address 11.11.11.11 255.255.255.255
#
bgp 65420
 peer 192.168.2.1 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  network 11.11.11.11 255.255.255.255
  peer 192.168.2.1 enable
#
return</pre>
</li><li><p>CE2 configuration file</p>
<pre class="screen">#
sysname CE2
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 192.168.1.2 255.255.255.252
#
interface LoopBack1
 ip address 22.22.22.22 255.255.255.255
#
bgp 65410
 peer 192.168.1.1 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  network 22.22.22.22 255.255.255.255
  peer 192.168.1.1 enable
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0101.html">Configuration Examples for BGP/MPLS IP VPN
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0320.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0112.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>