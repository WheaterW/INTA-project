
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring Inter-AS VPN Option C (Solution 2)">
<meta name="abstract" content="If no MP-IBGP peer relationship is established between PEs and ASBRs, you can use LDP to allocate labels for BGP and implement the inter-AS VPN Option C solution.">
<meta name="description" content="If no MP-IBGP peer relationship is established between PEs and ASBRs, you can use LDP to allocate labels for BGP and implement the inter-AS VPN Option C solution.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0101.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0151.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0181.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,l3vpnvrp,w00556928,l00468467,w00606909,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="h00847023">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00415692">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172369521">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring Inter-AS VPN Option C (Solution 2)</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172369521"></a><a name="EN-US_TASK_0172369521"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring Inter-AS VPN Option C (Solution 2)</h1>
<div class="taskbody"><p>If no MP-IBGP peer relationship is established between PEs and ASBRs, you can use LDP to allocate labels for BGP and implement the inter-AS VPN Option C solution.</p>
<div class="context"><a name="EN-US_TASK_0172369521__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>On the network shown in <a href="#EN-US_TASK_0172369521__fig_dc_vrp_mpls-l3vpn-v4_cfg_015201">Figure 1</a>, CE1 and CE2 belong to the same VPN. CE1 accesses AS 100 through PE1, and CE2 accesses AS 200 through PE2.</p>
<div class="fignone" id="EN-US_TASK_0172369521__fig_dc_vrp_mpls-l3vpn-v4_cfg_015201"><a name="EN-US_TASK_0172369521__fig_dc_vrp_mpls-l3vpn-v4_cfg_015201"></a><a name="fig_dc_vrp_mpls-l3vpn-v4_cfg_015201"></a><span class="figcap"><b>Figure 1 </b>Inter-AS VPN Option C (solution 2)</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>interface1 and interface2 in this example represent GE<span>0/1/0</span> and GE<span>0/2/0</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="images/fig_dc_vrp_mpls-l3vpn-v4_cfg_015201.png"></span></div>
<p>No IBGP peer relationship is needed between a PE and an ASBR. The ASBR learns the labeled BGP routes of the public network in the remote AS from the peer ASBR. These BGP routes are then imported to the IGP. In this manner, LDP can distribute labels for these routes and establish an inter-AS LDP LSP. The inter-AS BGP/MPLS IP VPN can then be implemented in Option C mode.</p>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369521__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Advertise the routes of the PEs within an AS to the remote ASBR through BGP, import these routes to the IGP on the remote ASBR, and then advertise these routes to the remote PE through the IGP.</p>
</li><li><p>Configure a route-policy on each ASBR, so that each ASBR assigns an MPLS label to the loopback interface route that is received from the PE in the same AS and is to be advertised to the remote ASBR.</p>
</li><li><p>Configure the local and remote ASBRs to exchange labeled IPv4 routes.</p>
</li><li><p>Configure LDP LSPs for the labeled BGP routes of the public network on ASBRs.</p>
</li><li><p>Establish an MP-EBGP peer relationship between the PEs of different ASs and specify the maximum hops allowed for an MP-EBGP connection between PEs.</p>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369521__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li>MPLS LSR IDs of PEs and ASBRs</li><li>VPN instance name, RD, and VPN target created on each PE</li><li>Route-policy on each ASBR</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172369521__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure IGP on the MPLS backbone networks in AS 100 and AS 200, so that PEs can communicate with ASBRs on each MPLS backbone network.</span><p><p>This example uses OSPF as IGP.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Advertise the 32-bit IP address of a loopback interface, that is, the LSR ID, using OSPF.</p>
</div></div>
<p>After the configurations are complete, the OSPF neighbor relationship can be established between the ASBR and PE in the same AS. Run the <strong>display ospf peer</strong> command. The command output shows that the status of the OSPF neighbor relationship is <strong>Full</strong>.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">&lt;PE1&gt; <strong>display ospf peer</strong></pre>
<pre class="screen">          OSPF Process 1 with Router ID 1.1.1.9
                  Neighbors

 Area 0.0.0.0 interface 172.16.1.2(GE<span>0/1/0</span>)'s neighbors
 Router ID: 2.2.2.9          Address: 172.16.1.1
   <strong>State: Full</strong>  Mode:Nbr is  Master  Priority: 1
   DR: 2.2.2.9   BDR: 1.1.1.9   MTU: 0
   Dead timer due in 28  sec
   Retrans timer interval: 5
   Neighbor is up for 00:01:04
   Authentication Sequence: [ 0 ]
</pre>
<p>The ASBR and PE in the same AS can learn the IP address of each other's Loopback1 interface and ping each other.</p>
</p></li><li><span>Establish an EBGP peer relationship between the ASBRs.</span><p><p># Configure ASBR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>bgp 100</strong>
[<span class="keyword">*</span>ASBR1-bgp] <strong>peer 192.168.1.2 as-number 200</strong>
[<span class="keyword">*</span>ASBR1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>ASBR1] <strong>commit</strong></pre>
<p># Configure ASBR2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2] <strong>bgp 200</strong>
[<span class="keyword">*</span>ASBR2-bgp] <strong>peer 192.168.1.1 as-number 100</strong>
[<span class="keyword">*</span>ASBR2-bgp] <strong>quit</strong>
[<span class="keyword">*</span>ASBR2] <strong>commit</strong></pre>
<p>After completing the configurations, run the <strong>display bgp peer</strong> command on each ASBR. The command output shows that the status of the EBGP peer relationship is <strong>Established</strong>.</p>
<p>The following example uses the command output on ASBR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>display bgp peer</strong></pre>
<pre class="screen"> BGP local router ID : 172.16.1.1
 Local AS number : 100
 Total number of peers : 1                 Peers in established state : 1

  Peer        V  AS    MsgRcvd  MsgSent  OutQ  Up/Down       State       PrefRcv

  192.168.1.2   4 200        129      134     0 01:39:21 Established             1
</pre>
</p></li><li><span>Advertise the routes of the PE in an AS to the PE in another AS.</span><p><p># On ASBR1, advertise the loopback address of PE1 to ASBR2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>bgp 100</strong>
[<span class="keyword">*</span>ASBR1-bgp] <strong>network 1.1.1.9 32</strong>
[<span class="keyword">*</span>ASBR1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>ASBR1] <strong>commit</strong></pre>
<p># On ASBR2, advertise the loopback address of PE2 to ASBR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2] <strong>bgp 200</strong>
[<span class="keyword">*</span>ASBR2-bgp] <strong>network 4.4.4.9 32</strong>
[<span class="keyword">*</span>ASBR2-bgp] <strong>quit</strong>
[<span class="keyword">*</span>ASBR2] <strong>commit</strong></pre>
<p># On ASBR1, import BGP routes to OSPF, and advertise the routes of PE2 to PE1 through OSPF.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>ospf 1</strong>
[<span class="keyword">*</span>ASBR1-ospf-1] <strong>import-route bgp</strong>
[<span class="keyword">*</span>ASBR1-ospf-1] <strong>quit</strong>
[<span class="keyword">*</span>ASBR1] <strong>commit</strong></pre>
<p># On ASBR2, import BGP routes to OSPF, and advertise the routes of PE1 to PE2 through OSPF.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2] <strong>ospf 1</strong>
[<span class="keyword">*</span>ASBR2-ospf-1] <strong>import-route bgp</strong>
[<span class="keyword">*</span>ASBR2-ospf-1] <strong>quit</strong>
[<span class="keyword">*</span>ASBR2] <strong>commit</strong></pre>
<p>After completing the configurations, run the <strong>display ip routing-table</strong> command on each PE. The command output shows routing table information. The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ip routing-table</strong>
<span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table: Public
         Destinations : 10        Routes : 10

Destination/Mask    Proto  Pre  Cost     Flags NextHop         Interface

        1.1.1.9/32  Direct 0    0           D  127.0.0.1       InLoopBack0
        2.2.2.9/32  OSPF   10   1           D  172.16.1.1      GigabitEthernet<span>0/1/0</span>
        4.4.4.9/32  O_ASE  150  1           D  172.16.1.1      GigabitEthernet<span>0/1/0</span>
      127.0.0.0/8   Direct 0    0           D  127.0.0.1       InLoopBack0
      127.0.0.1/32  Direct 0    0           D  127.0.0.1       InLoopBack0
127.255.255.255/32  Direct 0    0           D  127.0.0.1       InLoopBack0
     172.16.1.0/24  Direct 0    0           D  172.16.1.2      GigabitEthernet<span>0/1/0</span>
     172.16.1.1/32  Direct 0    0           D  127.0.0.1       GigabitEthernet<span>0/1/0</span>
   172.16.1.255/32  Direct 0    0           D  127.0.0.1       GigabitEthernet<span>0/1/0</span>
255.255.255.255/32  Direct 0    0           D  127.0.0.1       InLoopBack0</pre>
</p></li><li><span>Configure MPLS and MPLS LDP both globally and per interface on each node of the backbone networks in AS 100 and AS 200 to establish LDP LSPs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls lsr-id 1.1.1.9</strong>
[<span class="keyword">*</span>PE1] <strong>mpls</strong>
[<span class="keyword">*</span>PE1-mpls] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>mpls ldp</strong>
[<span class="keyword">*</span>PE1-mpls-ldp] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet <span>0/1/0</span></strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>mpls ldp</strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure ASBR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>mpls lsr-id 2.2.2.9</strong>
[<span class="keyword">*</span>ASBR1] <strong>mpls</strong>
[<span class="keyword">*</span>ASBR1-mpls] <strong>quit</strong>
[<span class="keyword">*</span>ASBR1] <strong>mpls ldp</strong>
[<span class="keyword">*</span>ASBR1-mpls-ldp] <strong>quit</strong>
[<span class="keyword">*</span>ASBR1] <strong>interface gigabitethernet <span>0/1/0</span></strong>
[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong>
[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/0</span>] <strong>mpls ldp</strong>
[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>ASBR1] <strong>commit</strong></pre>
<p># Configure ASBR2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2] <strong>mpls lsr-id 3.3.3.9</strong>
[<span class="keyword">*</span>ASBR2] <strong>mpls</strong>
[<span class="keyword">*</span>ASBR2-mpls] <strong>quit</strong>
[<span class="keyword">*</span>ASBR2] <strong>mpls ldp</strong>
[<span class="keyword">*</span>ASBR2-mpls-ldp] <strong>quit</strong>
[<span class="keyword">*</span>ASBR2] <strong>interface gigabitethernet <span>0/1/0</span></strong>
[<span class="keyword">*</span>ASBR2-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong>
[<span class="keyword">*</span>ASBR2-GigabitEthernet<span>0/1/0</span>] <strong>mpls ldp</strong>
[<span class="keyword">*</span>ASBR2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>ASBR2] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls lsr-id 4.4.4.9</strong>
[<span class="keyword">*</span>PE2] <strong>mpls</strong>
[<span class="keyword">*</span>PE2-mpls] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>mpls ldp</strong>
[<span class="keyword">*</span>PE2-mpls-ldp] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet <span>0/1/0</span></strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>mpls ldp</strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p>After the configurations are complete, the LDP sessions between PE1 and ASBR1, and between PE2 and ASBR2 are set up. Run the <strong>display mpls ldp session</strong> command. The command output shows that the LDP session status is <strong>Operational</strong>. Run the <strong>display mpls ldp lsp</strong> command. The command output shows whether LDP LSPs are set up.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display mpls ldp session</strong>

 LDP Session(s) in Public Network
 Codes: LAM(Label Advertisement Mode), SsnAge Unit(DDDD:HH:MM)
<span> An asterisk (*) before a session means the session is being deleted.</span>
 ------------------------------------------------------------------------------
 PeerID             Status      LAM  SsnRole  SsnAge      KASent/Rcv
 ------------------------------------------------------------------------------
 2.2.2.9:0          Operational DU   Passive  0000:00:01  5/5
 ------------------------------------------------------------------------------
 TOTAL: 1 session(s) Found.

</pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display mpls ldp lsp</strong>
 LDP LSP Information
 -------------------------------------------------------------------------------
 DestAddress/Mask   In/OutLabel   UpstreamPeer   NextHop         OutInterface
 -------------------------------------------------------------------------------
 1.1.1.9/32         3/NULL        2.2.2.9        127.0.0.1       InLoop0
*1.1.1.9/32         Liberal/1024                 DS/2.2.2.9
 2.2.2.9/32         NULL/3        -              172.16.1.1      GE<span>0/1/0</span>
 2.2.2.9/32         1024/3        2.2.2.9        172.16.1.1      GE<span>0/1/0</span>
 -------------------------------------------------------------------------------
 TOTAL: 3 Normal LSP(s) Found.
 TOTAL: 1 Liberal LSP(s) Found.
 TOTAL: 0 Frr LSP(s) Found.
<span> An asterisk (*) before an LSP means the LSP is not established
 An asterisk (*) before a Label means the USCB or DSCB is stale
 An asterisk (*) before an UpstreamPeer means the session is stale
 An asterisk (*) before a DS means the session is stale
 An asterisk (*) before a NextHop means the LSP is FRR LSP</span>
</pre>
</p></li><li><span>Configure the function to exchange labeled IPv4 routes on ASBRs.</span><p><p># <span>Enable MPLS on ASBR1's GE <span>0/2/0</span> that connects to ASBR2.</span></p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>interface gigabitethernet <span>0/2/0</span></strong>
[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/2/0</span>] <strong>ip address 192.168.1.1 24</strong>
<span>[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/2/0</span>] <strong>mpls</strong></span>
[<span class="keyword">*</span>ASBR1-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<p># Configure a route-policy on ASBR1.</p>
<pre class="screen">[<span class="keyword">*</span>ASBR1] <strong>route-policy policy1 permit node 1</strong>
[<span class="keyword">*</span>ASBR1-route-policy] <strong>apply mpls-label</strong>
[<span class="keyword">*</span>ASBR1-route-policy] <strong>quit</strong></pre>
<p># On ASBR1, apply the route-policy to the routes advertised to ASBR2 and enable the capability of exchanging labeled IPv4 routes with ASBR2.</p>
<pre class="screen">[<span class="keyword">*</span>ASBR1] <strong>bgp 100</strong>
[<span class="keyword">*</span>ASBR1-bgp] <strong>peer 192.168.1.2 route-policy policy1 export</strong>
[<span class="keyword">*</span>ASBR1-bgp] <strong>peer 192.168.1.2 label-route-capability</strong>
[<span class="keyword">*</span>ASBR1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>ASBR1] <strong>commit</strong></pre>
<p>The configuration of ASBR2 is similar to the configuration of ASBR1. For configuration details, see the configuration file.</p>
</p></li><li><span>Configure LDP LSPs for the labeled BGP routes of the public network on ASBRs.</span><p><p># Configure ASBR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>mpls</strong>
[<span class="keyword">*</span>ASBR1-mpls] <strong>lsp-trigger bgp-label-route</strong>
[<span class="keyword">*</span>ASBR1-mpls] <strong>quit</strong>
[<span class="keyword">*</span>ASBR1] <strong>commit</strong></pre>
<p># Configure ASBR2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR2] <strong>mpls</strong>
[<span class="keyword">*</span>ASBR2-mpls] <strong>lsp-trigger bgp-label-route</strong>
[<span class="keyword">*</span>ASBR2-mpls] <strong>quit</strong>
[<span class="keyword">*</span>ASBR2] <strong>commit</strong></pre>
</p></li><li><span>Configure a VPN instance on each PE and bind the interface that connects a PE to a CE to the VPN instance on that PE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance vpn1</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpn1] <strong>route-distinguisher 100:1</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpn1-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpn1] <strong>vpn-target 1:1 export-extcommunity</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpn1] <strong>vpn-target 1:1 import-extcommunity</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet <span>0/2/0</span></strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpn1</strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.1.1.2 24</strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance vpn1</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpn1] <strong>route-distinguisher 200:1</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpn1-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpn1] <strong>vpn-target 1:1 export-extcommunity</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpn1] <strong>vpn-target 1:1 import-extcommunity</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpn1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet <span>0/2/0</span></strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpn1</strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.2.1.2 24</strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p>After completing the configurations, run the <strong>display ip vpn-instance verbose</strong> command on PEs to check VPN instance configurations. Each PE can ping its connected CE.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ip vpn-instance verbose</strong>
 Total VPN-Instances configured : 1
 Total IPv4 VPN-Instances configured : 1
 Total IPv6 VPN-Instances configured : 0

 VPN-Instance Name and ID : vpn1, 1
  Interfaces : GigabitEthernet<span>0/2/0</span>
 Address family ipv4
  Create date : 2012/05/14 07:31:56
  Up time : 0 days, 08 hours, 26 minutes and 31 seconds
  Vrf Status : UP
  Route Distinguisher : 100:1
  Export VPN Targets : 1:1
  Import VPN Targets : 1:1
  Label Policy : label per route
  The diffserv-mode Information is : uniform
  The ttl-mode Information is : pipe  </pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ping -vpn-instance vpn1 10.1.1.1</strong>
  PING 10.1.1.1: 56  data bytes, press CTRL_C to break
    Reply from 10.1.1.1: bytes=56 Sequence=1 ttl=255 time=50 ms
    Reply from 10.1.1.1: bytes=56 Sequence=2 ttl=255 time=50 ms
    Reply from 10.1.1.1: bytes=56 Sequence=3 ttl=255 time=40 ms
    Reply from 10.1.1.1: bytes=56 Sequence=4 ttl=255 time=30 ms
    Reply from 10.1.1.1: bytes=56 Sequence=5 ttl=255 time=10 ms

  --- 10.1.1.1 ping statistics ---
    5 packet(s) transmitted
    4 packet(s) received
    20.00% packet loss
round-trip min/avg/max = 10/32/50 ms
</pre>
</p></li><li><span>Establish an MP-EBGP peer relationship between PE1 and PE2.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong>
[<span class="keyword">*</span>PE1-bgp] <strong>peer 4.4.4.9 as-number 200</strong>
[<span class="keyword">*</span>PE1-bgp] <strong>peer 4.4.4.9 connect-interface LoopBack 1</strong>
[<span class="keyword">*</span>PE1-bgp] <strong>peer 4.4.4.9 ebgp-max-hop 10</strong>
[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpnv4</strong>
[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 4.4.4.9 enable</strong>
[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>quit</strong>
[<span class="keyword">*</span>PE1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 200</strong>
[<span class="keyword">*</span>PE2-bgp] <strong>peer 1.1.1.9 as-number 100</strong>
[<span class="keyword">*</span>PE2-bgp] <strong>peer 1.1.1.9 connect-interface LoopBack 1</strong>
[<span class="keyword">*</span>PE2-bgp] <strong>peer 1.1.1.9 ebgp-max-hop 10</strong>
[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpnv4</strong>
[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 1.1.1.9 enable</strong>
[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>quit</strong>
[<span class="keyword">*</span>PE2-bgp] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</p></li><li><span>Set up EBGP peer relationships between PEs and CEs to import VPN routes.</span><p><p># Configure CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>bgp 65001</strong>
[<span class="keyword">*</span>CE1-bgp] <strong>peer 10.1.1.2 as-number 100</strong>
[<span class="keyword">*</span>CE1-bgp] <strong>import-route direct</strong>
[<span class="keyword">*</span>CE1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>CE1] <strong>commit</strong></pre>
<p># Configure CE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>bgp 65002</strong>
[<span class="keyword">*</span>CE2-bgp] <strong>peer 10.2.1.2 as-number 200</strong>
[<span class="keyword">*</span>CE2-bgp] <strong>import-route direct</strong>
[<span class="keyword">*</span>CE2-bgp] <strong>quit</strong>
[<span class="keyword">*</span>CE2] <strong>commit</strong></pre>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong>
[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpn-instance vpn1</strong>
[<span class="keyword">*</span>PE1-bgp-vpn1] <strong>peer 10.1.1.1 as-number 65001</strong>
[<span class="keyword">*</span>PE1-bgp-vpn1] <strong>import-route direct</strong>
[<span class="keyword">*</span>PE1-bgp-vpn1] <strong>quit</strong>
[<span class="keyword">*</span>PE1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 200</strong>
[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpn-instance vpn1</strong>
[<span class="keyword">*</span>PE2-bgp-vpn1] <strong>peer 10.2.1.1 as-number 65002</strong>
[<span class="keyword">*</span>PE2-bgp-vpn1] <strong>import-route direct</strong>
[<span class="keyword">*</span>PE2-bgp-vpn1] <strong>quit</strong>
[<span class="keyword">*</span>PE2-bgp] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p>After completing the configurations, run the <strong>display bgp vpnv4 vpn-instance peer</strong> command on each PE to view the BGP peer relationship between the PE and CE. The command output shows that the BGP peer relationship is in the <strong>Established</strong> state.</p>
<p>The following example uses the peer relationship between PE1 and CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display bgp vpnv4 vpn-instance vpn1 peer</strong>

 BGP local router ID : 1.1.1.9
 Local AS number : 100

 Total number of peers : 1                 Peers in established state : 1

  Peer            V    AS  MsgRcvd  MsgSent  OutQ  Up/Down       State PrefRcv
  10.1.1.1        4 65001        3        3     0 00:00:52 Established       1
</pre>
</p></li><li><span>Verify the configuration.</span><p><p>After the configurations are complete, CEs can learn the routes to each other' interface and ping each other.</p>
<p>The following example uses the command output on CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>display ip routing-table</strong>
<span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table: _public_
         Destinations : 8        Routes : 8
Destination/Mask    Proto  Pre  Cost    Flags  NextHop         Interface
   10.1.1.0/24      Direct 0    0           D  10.1.1.1        GigabitEthernet<span>0/1/0</span>
   10.1.1.1/32      Direct 0    0           D  127.0.0.1       GigabitEthernet<span>0/1/0</span>
 10.1.1.255/32      Direct 0    0           D  127.0.0.1       GigabitEthernet<span>0/1/0</span>
   10.2.1.0/24      EBGP   255  0           D  10.1.1.2        GigabitEthernet<span>0/1/0</span>
  127.0.0.0/8       Direct 0    0           D  127.0.0.1       InLoopBack0
  127.0.0.1/32      Direct 0    0           D  127.0.0.1       InLoopBack0
127.255.255.255/32  Direct 0    0           D  127.0.0.1       InLoopBack0
255.255.255.255/32  Direct 0    0           D  127.0.0.1       InLoopBack0
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>ping 10.2.1.1</strong>
  PING 10.2.1.1: 56  data bytes, press CTRL_C to break
    Reply from 10.2.1.1: bytes=56 Sequence=1 ttl=252 time=102 ms
    Reply from 10.2.1.1: bytes=56 Sequence=2 ttl=252 time=89 ms
    Reply from 10.2.1.1: bytes=56 Sequence=3 ttl=252 time=106 ms
    Reply from 10.2.1.1: bytes=56 Sequence=4 ttl=252 time=104 ms
    Reply from 10.2.1.1: bytes=56 Sequence=5 ttl=252 time=56 ms

  --- 10.2.1.1 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 56/91/106 ms

</pre>
<p>After completing the configurations, run the <strong>display ip routing-table</strong> <em>dest-ip-address</em> <strong>verbose</strong> command on ASBR1. The command output shows that the routes from ASBR1 to PE2 are labeled BGP routes of the public network. The routing table is <strong>Public</strong>, the protocol type is <strong>EBGP</strong>, and the label has a non-zero value.</p>
<p>The following example uses the command output on ASBR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>display ip routing-table 4.4.4.9 verbose</strong>
<span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : _public_
Summary Count : 1

 Destination	: 4.4.4.9/32
    Protocol	: EBGP           Process ID	: 0
  Preference	: 255                  Cost	: 1
     NextHop	: 192.168.1.2       Neighbour	: 192.168.1.2
       State	: Active Adv Relied       Age	: 00h12m53s
         Tag	: 0                Priority	: low
       Label	: 1024             QoSInfo	: 0x0</pre>
<pre class="screen">  IndirectID	: 0x2</pre>
<pre class="screen">RelayNextHop	: 192.168.1.2         Interface	: GigabitEthernet<span>0/2/0</span>
    TunnelID	: 0x6002006           Flags	: RD</pre>
<p>Run the <strong>display mpls lsp protocol ldp include</strong> <em>dest-ip-address</em> <strong>verbose</strong> on ASBR1 and PE2 respectively. The command output shows that an LDP LSP is established between ASBR1 and PE2. An ingress LDP LSP on a PE to the remote PE exists.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ASBR1] <strong>display mpls lsp protocol ldp include 4.4.4.9 32 verbose</strong>
----------------------------------------------------------------------
                 LSP Information: LDP LSP
----------------------------------------------------------------------
  No                  :  1
  VrfIndex            :
  Fec                 :  4.4.4.9/32
  Nexthop             :  192.168.1.2
  In-Label            :  1024
  Out-Label           :  NULL
  In-Interface        :  ----------
  Out-Interface       :  ----------
  LspIndex            :  5000003
  Type                :  Primary
  OutSegmentIndex     :  0
  LsrType             :  Egress
  Outgoing TunnelID   :  0x40000
  Label Operation     :  SWAPPUSH
  Mpls-Mtu            :  ------
  LspAge              :  16 sec
  Bfd-State           :  ------
</pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172369521__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>CE1 configuration file</p>
<pre class="screen">#
sysname CE1
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.0
#
bgp 65001
 peer 10.1.1.2 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 10.1.1.2 enable
#
return
</pre>
</li><li><p>PE1 configuration file</p>
<pre class="screen">#
sysname PE1
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
mpls lsr-id 1.1.1.9
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 172.16.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 10.1.1.2 255.255.255.0
#
interface LoopBack1
 ip address 1.1.1.9 255.255.255.255
#
bgp 100
 peer 4.4.4.9 as-number 200
 peer 4.4.4.9 ebgp-max-hop 10
 peer 4.4.4.9 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 4.4.4.9 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 4.4.4.9 enable
 #
 ipv4-family vpn-instance vpn1
  import-route direct
  peer 10.1.1.1 as-number 65001
#
ospf 1
 area 0.0.0.0
  network 1.1.1.9 0.0.0.0
  network 172.16.1.0 0.0.0.255
#
return
</pre>
</li><li><p>ASBR1 configuration file</p>
<pre class="screen">#
sysname ASBR1
#
mpls lsr-id 2.2.2.9
#
mpls
 lsp-trigger bgp-label-route
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 172.16.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 192.168.1.1 255.255.255.0
<span> mpls</span>
#
interface LoopBack1
 ip address 2.2.2.9 255.255.255.255
#
bgp 100
 peer 192.168.1.2 as-number 200
 #
 ipv4-family unicast
  undo synchronization
  network 1.1.1.9 255.255.255.255
  peer 192.168.1.2 enable
  peer 192.168.1.2 route-policy policy1 export
  peer 192.168.1.2 label-route-capability
#
ospf 1
 import-route bgp
 area 0.0.0.0
  network 2.2.2.9 0.0.0.0
  network 172.16.1.0 0.0.0.255
#
route-policy policy1 permit node 1
 apply mpls-label
#
return
</pre>
</li><li><p>ASBR2 configuration file</p>
<pre class="screen">#
sysname ASBR2
#
mpls lsr-id 3.3.3.9
#
mpls
 lsp-trigger bgp-label-route
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.162.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 192.168.1.2 255.255.255.0
<span> mpls</span>
#
interface LoopBack1
 ip address 3.3.3.9 255.255.255.255
#
bgp 200
 peer 192.168.1.1 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  network 4.4.4.9 255.255.255.255
  peer 192.168.1.1 enable
  peer 192.168.1.1 route-policy policy1 export
  peer 192.168.1.1 label-route-capability
#
ospf 1
 import-route bgp
 area 0.0.0.0
  network 3.3.3.9 0.0.0.0
  network 10.162.1.0 0.0.0.255
#
route-policy policy1 permit node 1
 apply mpls-label
#
return
</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 200:1
  apply-label per-instance
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
mpls lsr-id 4.4.4.9
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.162.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 10.2.1.2 255.255.255.0
#
interface LoopBack1
 ip address 4.4.4.9 255.255.255.255
#
bgp 200
 peer 1.1.1.9 as-number 100
 peer 1.1.1.9 ebgp-max-hop 10
 peer 1.1.1.9 connect-interface LoopBack1
#
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.9 enable
#
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.9 enable
 #
 ipv4-family vpn-instance vpn1
  import-route direct
  peer 10.2.1.1 as-number 65002
#
ospf 1
 area 0.0.0.0
  network 4.4.4.9 0.0.0.0
  network 10.162.1.0 0.0.0.255
#
return
</pre>
</li><li><p>CE2 configuration file</p>
<pre class="screen">#
sysname CE2
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.2.1.1 255.255.255.0
#
bgp 65002
 peer 10.2.1.2 as-number 200
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 10.2.1.2 enable
#
return
</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0101.html">Configuration Examples for BGP/MPLS IP VPN
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0151.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0181.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>