
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring a QinQ VLAN Tag Termination Sub-interface to Support the Local Connection">
<meta name="abstract" content="This example shows how to configure the QinQ VLAN tag termination sub-interface to support the local connection. This configuration enables CEs to communicate with each other after being connected to the same virtual switching instance (VSI) on a PE through the sub-interface.">
<meta name="description" content="This example shows how to configure the QinQ VLAN tag termination sub-interface to support the local connection. This configuration enables CEs to communicate with each other after being connected to the same virtual switching instance (VSI) on a PE through the sub-interface.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_qinq_cfg_0023_1.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_qinq_cfg_0035.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_qinq_cfg_0037.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="wwx1238417">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="QinQ">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="QinQ">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="featurename" content="QinQ">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="featurename" content="QinQ">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="OWNER" content="c00648116,w00437000">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="wwx1238417">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172363319">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring a QinQ VLAN Tag Termination Sub-interface to Support the Local Connection</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172363319"></a><a name="EN-US_TASK_0172363319"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring a QinQ VLAN Tag Termination Sub-interface to Support the Local Connection</h1>
<div class="taskbody"><p>This example shows how to configure the QinQ VLAN tag termination sub-interface to support the local connection. This configuration enables CEs to communicate with each other after being connected to the same virtual switching instance (VSI) on a PE through the sub-interface.</p>
<div class="context"><a name="EN-US_TASK_0172363319__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>On the network shown in <a href="#EN-US_TASK_0172363319__fig_dc_vrp_qinq_cfg_003601">Figure 1</a>, CE1 and CE2 are connected to PE1 through <span class="keyword">Router</span>s and access the virtual private LAN service (VPLS) network through PE1. The packets sent from <span class="keyword">Device</span>A to PE1 carry two VLAN tags and the outer VLAN tags are the same. Because the packets received by the user-side interface of PE1 have the same outer VLAN tag, this user-side interface does not forward these packets. As a result, users from different VLANs cannot communicate in the same VSI. QinQ VLAN tag termination sub-interfaces need to be configured to support the local connection on the PEs, ensuring communication between the CEs.</p>
<div class="fignone" id="EN-US_TASK_0172363319__fig_dc_vrp_qinq_cfg_003601"><a name="EN-US_TASK_0172363319__fig_dc_vrp_qinq_cfg_003601"></a><a name="fig_dc_vrp_qinq_cfg_003601"></a><span class="figcap"><b>Figure 1 </b>Typical networking for configuring the QinQ VLAN tag termination sub-interface to support the local connection</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>In this example, interfaces 1 through 3 and subinterface3.1 represent GE<span>0/1/1</span>, GE<span>0/1/2</span>, GE<span>0/1/3</span>, and GE<span>0/1/3</span>.1, respectively.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0000001591625034.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172363319__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Precautions</h4><p>If the packets received by the user-side interface of PE1 are forwarded through this interface, GE<span>0/1/3</span> and GE<span>0/1/1</span> on <span class="keyword">Device</span>A will learn the same MAC address and therefore cannot forward packets correctly. Therefore, MAC address learning must be disabled on the switch that is connected to the user-side interface of PE1.</p>
</div></div>
<div class="context"><a name="EN-US_TASK_0172363319__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure IP addresses for interfaces on the CEs. The packets sent from the CEs to the <span class="keyword">Router</span>s do not carry any VLAN tag.</p>
</li><li><p>Create VLANs and configure the Layer 2 forwarding function on <span class="keyword">Device</span>B and <span class="keyword">Device</span>C so that the packets sent from <span class="keyword">Device</span>B and <span class="keyword">Device</span>C to <span class="keyword">Device</span>A carry one VLAN tag.</p>
</li><li><p>Configure the QinQ and Layer 2 forwarding functions on <span class="keyword">Device</span>A so that the packets sent from <span class="keyword">Device</span>A to PE1 carry two VLAN tags.</p>
</li><li><p>Configure a QinQ VLAN tag termination sub-interface on PE1 and bind the sub-interface to a VSI to access the VPLS network. The sub-interface supports the local connection so that users in the same VSI can communicate.</p>
<ol type="a"><li><p>Configure a routing protocol on the PEs so that these devices can communicate on the Layer 3 network.</p>
<p>Open Shortest Path First (OSPF) is used in this example.</p>
</li><li>Configure basic Multiprotocol Label Switching (MPLS) functions and MPLS Label Distribution Protocol (LDP) on the PEs, and set up MPLS Label Switched Paths (LSPs) between these devices.</li><li>Enable MPLS L2VPN on the PEs globally.</li><li>Configure a QinQ VLAN tag termination sub-interface on PEs and bind the sub-interface to a VSI to access the VPLS network and configure the sub-interface to support the local connection so that users in the same VSI can communicate.</li></ol>
</li><li>Disable MAC address learning on <span class="keyword">Device</span>A to prevent two interfaces of <span class="keyword">Device</span>A from learning the same MAC address.</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172363319__1.4.4"></a><a name="1.4.4"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li>Users' VLAN IDs and IP addresses</li><li>Outer VLAN tag in the packets sent from <span class="keyword">Device</span>A to PE1.</li><li>Names of the interfaces that connect the <span class="keyword">Router</span>s and the CEs, names of the interfaces that connect the <span class="keyword">Router</span>s, and names of the interfaces that connect <span class="keyword">Router</span>A and PE1</li><li>MPLS LSR IDs, VSI ID, VSI name, and name and IP address of each interface bound to the VSI on the PEs</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172363319__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure IP addresses for interfaces on the CEs.</span><p><p># Configure CE1.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname CE1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>interface gigabitethernet <span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/3</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/3</span>] <strong>ip address 10.1.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1] <strong>commit</strong></pre>
<p># Configure CE2.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname CE2</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>interface gigabitethernet <span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/3</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/3</span>] <strong>ip address 10.1.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2] <strong>commit</strong></pre>
</p></li><li><span>Create VLANs and configure the Layer 2 forwarding function on <span class="keyword">Device</span>B and <span class="keyword">Device</span>C.</span><p><p># Configure <span class="keyword">Device</span>B.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname <span class="keyword">Device</span>B</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>vlan 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B-vlan10] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>interface gigabitethernet <span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/3</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/3</span>] <strong>portswitch</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/3</span>] <strong>port link-type access</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/3</span>] <strong>port default vlan 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>interface gigabitethernet <span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/1</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/1</span>] <strong>portswitch</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/1</span>] <strong>port link-type trunk</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/1</span>] <strong>port trunk allow-pass vlan 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
<p># Configure <span class="keyword">Device</span>C.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname <span class="keyword">Device</span>C</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>C] <strong>vlan 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C-vlan20] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C] <strong>interface gigabitethernet <span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C-GigabitEthernet<span>0/1/3</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C-GigabitEthernet<span>0/1/3</span>] <strong>portswitch</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C-GigabitEthernet<span>0/1/3</span>] <strong>port link-type access</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C-GigabitEthernet<span>0/1/3</span>] <strong>port default vlan 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C] <strong>interface gigabitethernet <span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C-GigabitEthernet<span>0/1/1</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C-GigabitEthernet<span>0/1/1</span>] <strong>portswitch</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C-GigabitEthernet<span>0/1/1</span>] <strong>port link-type trunk</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C-GigabitEthernet<span>0/1/1</span>] <strong>port trunk allow-pass vlan 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>C] <strong>commit</strong></pre>
</p></li><li><span>Configure the QinQ and Layer 2 forwarding functions on <span class="keyword">Device</span>A.</span><p><p># Configure <span class="keyword">Device</span>A.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname <span class="keyword">Device</span>A</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>vlan 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-vlan100] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>interface gigabitethernet <span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/1</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/1</span>] <strong>portswitch</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/1</span>] <strong>port vlan-stacking vlan 10 stack-vlan 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>interface gigabitethernet <span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/2</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/2</span>] <strong>portswitch</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/2</span>] <strong>port vlan-stacking vlan 20 stack-vlan 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>interface gigabitethernet <span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/3</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/3</span>] <strong>portswitch</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/3</span>] <strong>port link-type trunk</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/3</span>] <strong>port trunk allow-pass vlan 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p id="EN-US_TASK_0172363319__en-us_task_0172363299_p637825194214028">If the device does not support the <strong><span id="EN-US_TASK_0172363319__en-us_task_0172363299_cmdparmname516997901214028">port vlan-stacking</span></strong> command, you can run the <a href="cmdqueryname=port+link-type+dot1q-tunnel"><b><span class="cmdname" id="EN-US_TASK_0172363319__en-us_task_0172363299_cmdname1201003618214028">port link-type dot1q-tunnel</span></b></a> command and <a href="cmdqueryname=port+default+vlan"><b><span class="cmdname" id="EN-US_TASK_0172363319__en-us_task_0172363299_cmdname1581172039214028">port default vlan</span></b></a> command on the interface to configure the QinQ function.</p>
</div></div>
</p></li><li><span>Configure a VPLS network.</span><p><ol type="a"><li><p>Configure OSPF on the PEs.</p>
<p>Assign an IP address to each interface on each PE. After OSPF is enabled, the 32-bit loopback interface address of each PE must be advertised.</p>
<p># Configure PE1.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname PE1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack1] <strong>ip address 1.1.1.9 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet <span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>ip address 192.168.1.1 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>ospf</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>network 1.1.1.9 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>network 192.168.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname PE2</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface LoopBack 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack1] <strong>ip address 2.2.2.9 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet <span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>ip address 192.168.1.2 32</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>ospf</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>network 2.2.2.9 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>network 192.168.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p>After the configurations are complete, PE1 and PE2 both have routes, discovered by OSPF, to loopback1 of each other.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ip routing-table</strong></pre>
<pre class="screen"><span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : _public_
         Destinations : 6       Routes : 7
Destination/Mask    Proto  Pre  Cost     Flags NextHop         Interface

      1.1.1.9/32    Direct 0    0           D  127.0.0.1       LoopBack1
      2.2.2.9/32    OSPF   10   2           D  192.168.3.2     GigabitEthernet<span>0/1/1</span>
  192.168.1.0/30    Direct 0    0           D  192.168.1.1     GigabitEthernet<span>0/1/1</span>
  192.168.1.1/32    Direct 0    0           D  127.0.0.1       GigabitEthernet<span>0/1/1</span>
  192.168.1.2/32    Direct 0    0           D  192.168.1.2     GigabitEthernet<span>0/1/1</span>
     127.0.0.0/8    Direct 0    0           D  127.0.0.1       InLoopBack0
    127.0.0.1/32    Direct 0    0           D  127.0.0.1       InLoopBack0
</pre>
</li><li><p>Enable basic MPLS functions and MPLS LDP.</p>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls lsr-id 1.1.1.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet <span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls lsr-id 2.2.2.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p>After the configurations are complete, LDP sessions are set up between PEs, run the <strong>display mpls ldp session</strong> command. The command output shows that the LDP session status is <strong>Operational</strong>.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display mpls ldp session</strong></pre>
<pre class="screen">LDP Session(s) in Public Network
 Codes: LAM(Label Advertisement Mode), SsnAge Unit(DDDD:HH:MM)
<span> An asterisk (*) before a session means the session is being deleted. </span> ------------------------------------------------------------------------------
 PeerID             Status      LAM  SsnRole  SsnAge      KASent/Rcv
 ------------------------------------------------------------------------------
 2.2.2.9:0          <strong>Operational</strong> DU   Passive  0000:00:09  37/37
 ------------------------------------------------------------------------------
 TOTAL: 1 session(s) Found.</pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If PEs are not directly connected, run the <strong>mpls ldp remote-peer</strong> command and <strong>remote-ip</strong> command to set up a remote LDP session between PEs.</p>
</div></div>
</li><li><p>Enable MPLS L2VPN.</p>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls l2vpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-l2vpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls l2vpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-l2vpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</li><li><p>Bind the QinQ VLAN tag termination sub-interface to a VSI, and configure the sub-interface to support the local connection.</p>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>vsi ldp1 static</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vsi-ldp1] <strong>pwsignal ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vsi-ldp1-ldp] <strong>vsi-id 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vsi-ldp1-ldp] <strong>peer 2.2.2.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vsi-ldp1-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vsi-ldp1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet <span>0/1/3</span>.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/3</span>.1] <strong>control-vid 1 qinq-termination local-switch</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/3</span>.1] <strong>qinq termination pe-vid 100 ce-vid 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/3</span>.1] <strong>qinq termination pe-vid 100 ce-vid 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/3</span>.1] <strong>l2 binding vsi ldp1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/3</span>.1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2 in the same way as PE1.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p id="EN-US_TASK_0172363319__en-us_task_0172363307_p577660652214028">When you run the <strong id="EN-US_TASK_0172363319__en-us_task_0172363307_b990890360214028">qinq termination</strong> command on an interface, if the <em id="EN-US_TASK_0172363319__en-us_task_0172363307_i1562836517214028">pe-vid</em> values of the two different sub-interfaces are the same, make sure that the <em id="EN-US_TASK_0172363319__en-us_task_0172363307_i2074358658214028">ce-vid</em> values are different.</p>
</div></div>
<p>After the configuration is complete, run the <strong>display vsi</strong> command on PE1 and PE2. The command outputs show that the VSI status is <strong>up</strong>. The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display vsi</strong></pre>
<pre class="screen">Total VSI number is 1, 1 is up, 0 is down, 1 is LDP mode, 0 is BGP mode

Vsi                             Mem    PW   Mac       Encap     Mtu   Vsi
Name                            Disc   Type Learn     Type      Value State
--------------------------------------------------------------------------
ldp1                            static ldp  unqualify vlan      1500  <strong>up</strong></pre>
</li></ol>
</p></li><li><span>Disable MAC address learning on <span class="keyword">Device</span>A.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>interface gigabitethernet <span>0/1/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/3</span>] <strong>mac-address learning disable</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/3</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>undo mac-address</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</p></li><li><span>Verify the configuration.</span><p><p>After the configurations are complete, CE1 and CE2 can ping each other.</p>
<p>The following example uses the command output on CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>ping 10.1.1.2</strong></pre>
<pre class="screen">  PING 10.1.1.2: 56  data bytes, press CTRL_C to break
    Reply from 10.1.1.2: bytes=56 Sequence=1 ttl=255 time = 2 ms
    Reply from 10.1.1.2: bytes=56 Sequence=2 ttl=255 time = 2 ms
    Reply from 10.1.1.2: bytes=56 Sequence=3 ttl=255 time = 2 ms
    Reply from 10.1.1.2: bytes=56 Sequence=4 ttl=255 time = 2 ms
    Reply from 10.1.1.2: bytes=56 Sequence=5 ttl=255 time = 2 ms

  --- 10.1.1.2 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 2/2/2 ms</pre>
<p>Run the <strong>display mac-address</strong> command to check the MAC address entries on PE1. The command output shows that PE1 has learned the MAC addresses of GE<span>0/1/3</span> of CE1 and CE2 and the VLAN IDs in the outer and inner VLAN tags. In addition, the VLAN IDs (PE VLAN) in the outer VLAN tags are the same.</p>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>display mac-address dynamic</strong></pre>
<pre class="screen">MAC address table of slot <span>1</span>:
-------------------------------------------------------------------------------
MAC Address    VLAN<span>/BD</span>/       PEVLAN CEVLAN Port            Type      LSP/LSR-ID
               VSI/SI<span>/EVPN</span>                                             MAC-Tunnel
-------------------------------------------------------------------------------
00e0-fc12-3457 v1             100    20     GE<span>0/1/3</span>         dynamic   4/65546
00e0-fc12-3456 v1             100    10     GE<span>0/1/3</span>         dynamic   4/65556
-------------------------------------------------------------------------------
Total matching items on slot <span>1</span> displayed = 2</pre>
<p>Run the <strong>display arp interface</strong> command on the CEs, and you can find that the ARP entries of the CEs are correct.</p>
<p>The following example uses the command output on CE1.</p>
<pre class="screen">[<span class="keyword">*</span>CE1] <strong>display arp interface gigabitethernet <span>0/1/3</span></strong></pre>
<pre class="screen">ARP timeout:1200s
IP ADDRESS      MAC ADDRESS  EXPIRE(M) TYPE INTERFACE      VPN-INSTANCE
                                       VLAN PVC
------------------------------------------------------------------------------
10.1.1.1        00e0-fc12-3456         I    GigabitEthernet<span>0/1/3</span>
10.1.1.2        00e0-fc12-3457  14     D    GigabitEthernet<span>0/1/3</span>
------------------------------------------------------------------------------
Total:2         Dynamic:1       Static:0    Interface:1    Remote:0</pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172363319__1.4.6"></a><a name="1.4.6"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>PE1 configuration file</p>
<pre class="screen">#
 sysname PE1
#
 mpls lsr-id 1.1.1.9
 mpls
#
 mpls l2vpn
#
vsi ldp1 static
 pwsignal ldp
  vsi-id 1
  peer 2.2.2.9
#
mpls ldp
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
#
interface GigabitEthernet<span>0/1/3</span>.1
 encapsulation qinq-termination local-switch
 qinq termination pe-vid 100 ce-vid 10
 qinq termination pe-vid 100 ce-vid 20
 l2 binding vsi ldp1
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 192.168.1.1 255.255.255.252
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 1.1.1.9 255.255.255.255
#
ospf 1
 area 0.0.0.0
  network 1.1.1.9 0.0.0.0
  network 192.168.1.0 0.0.0.255
#
return</pre>
</li><li><p><span class="keyword">Device</span>A configuration file</p>
<pre class="screen">#
 sysname <span class="keyword">Device</span>A
#
 vlan batch 100
#
interface GigabitEthernet<span>0/1/3</span>
 portswitch
 mac-address learning disable
 undo shutdown
 undo mac-address
 port link-type trunk
 port trunk allow-pass vlan 100
#
interface GigabitEthernet<span>0/1/1</span>
 portswitch
 undo shutdown
 port vlan-stacking vlan 10 stack-vlan 100
#
interface GigabitEthernet<span>0/1/2</span>
 portswitch
 undo shutdown
 port vlan-stacking vlan 20 stack-vlan 100
#
return</pre>
</li><li><p><span class="keyword">Device</span>B configuration file</p>
<pre class="screen">#
 sysname <span class="keyword">Device</span>B
#
 vlan batch 10
#
interface GigabitEthernet<span>0/1/3</span>
 portswitch
 undo shutdown
 port link-type access
 port default vlan 10
#
interface GigabitEthernet<span>0/1/1</span>
 portswitch
 undo shutdown
 port link-type trunk
 port trunk allow-pass vlan 10
#
return</pre>
</li><li><p><span class="keyword">Device</span>C configuration file</p>
<pre class="screen">#
 sysname <span class="keyword">Device</span>C
#
 vlan batch 20
#
interface GigabitEthernet<span>0/1/3</span>
 portswitch
 undo shutdown
 port link-type access
 port default vlan 20
#
interface GigabitEthernet<span>0/1/1</span>
 portswitch
 undo shutdown
 port link-type trunk
 port trunk allow-pass vlan 20
#
return</pre>
</li><li><p>CE1 configuration file</p>
<pre class="screen">#
 sysname CE1
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
 mac-address learning disable
 ip address 10.1.1.1 255.255.255.0
#
return</pre>
</li><li><p>CE2 configuration file</p>
<pre class="screen">#
 sysname CE2
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
 ip address 10.1.1.2 255.255.255.0
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_qinq_cfg_0023_1.html">Configuration Examples for QinQ
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_qinq_cfg_0035.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_qinq_cfg_0037.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>