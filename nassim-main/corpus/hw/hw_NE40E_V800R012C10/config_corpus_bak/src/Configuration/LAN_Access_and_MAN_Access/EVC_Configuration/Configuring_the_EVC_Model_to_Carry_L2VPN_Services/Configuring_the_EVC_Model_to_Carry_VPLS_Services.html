
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Configuring the EVC Model to Carry VPLS Services">
<meta name="abstract" content="This section describes how to use the EVC model to carry virtual private LAN service (VPLS) services to reduce enterprise costs.">
<meta name="description" content="This section describes how to use the EVC model to carry virtual private LAN service (VPLS) services to reduce enterprise costs.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evc_cfg_0030.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evc_cfg_0032.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="h00847023,y00852169">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="EVC">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="EVC">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="featurename" content="EVC">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="featurename" content="EVC">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="OWNER" content="p00915595">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="p00915595">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172363386">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Configuring the EVC Model to Carry VPLS Services</title>
</head>
<body><a name="EN-US_TASK_0172363386"></a><a name="EN-US_TASK_0172363386"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Configuring the EVC Model to Carry VPLS Services</h1>
<div class="taskbody"><p>This section describes how to use the EVC model to carry virtual private LAN service (VPLS) services to reduce enterprise costs.</p>
<div class="context"><a name="EN-US_TASK_0172363386__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><div class="p"><h4 class="sectiontitle">Context</h4><p>In the traditional service model supported by the <span class="keyword">NE40E</span>, common sub-interfaces (VLAN type), dot1q VLAN tag termination sub-interfaces, or QinQ VLAN tag termination sub-interfaces are created on the user-side interfaces of PEs. These sub-interfaces are bound to different Virtual Switching Instances (VSIs) on the carrier network to isolate services in different departments of an enterprise. If the enterprise sets up another department, the enterprise must lease another VSI from the carrier to isolate the departments, which increases costs.</p>
<p>To allow the enterprise to dynamically adjust its departments and reduce costs, deploy the Ethernet Virtual Connection (EVC) model on the PEs to allow multiple Bridge Domains (BDs) to access the same VSI and also to be isolated from each other.</p>
<div class="p">A BD can access a VPLS network in either of the following modes:<ul><li><p>VSI pipe service mode</p>
<p>A VSI functions as a network-side pipe, and BDs function as service instances at the access layer. A VSI can carry service traffic from multiple BDs. The pseudowires (PWs) must work in tagged mode. The BDs must use VLAN IDs as service delimiters.</p>
<p>When a packet enters a PW from a BD, the ingress PE adds the BD ID to the packet as the outer tag (PW tag). When the packet leaves the PW, the egress PE searches for a VSI based on the VC label and searches for a BD based on the outer tag.</p>
</li><li><p>VSI-exclusive service mode</p>
<p>Each VSI provides access services for only one BD, and the BD exclusively consumes the VSI resources. The services in the VSI can be planned as needed. The PWs can work in either raw mode (with the VSI encapsulation type being Ethernet) or tagged mode (with the VSI encapsulation type being VLAN). The ingress PE adds a PW tag to packets that enter a PW only after the PW tag has been configured and the PW works in tagged mode. The egress PE does not verify the PW tag of packets that leave the PW. If the PW works in raw mode, the egress PE directly forwards the packets to the corresponding BD. If the PW works in tagged mode, the egress PE removes the outer tag before forwarding the packets to the corresponding BD.</p>
</li></ul>
</div>
<h4 class="sectiontitle">Precautions</h4><p>On the network shown in <a href="#EN-US_TASK_0172363386__fig_dc_vrp_evc_cfg_003101">Figure 1</a>, different user networks connect to PE1 through the same CE, and a BD is bound to a VSI for VPLS access. However, due to VPLS split horizon, the user-side interface on PE1 will not forward packets it receives, and therefore users in the same VSI cannot communicate. To allow users to communicate, run the <a href="cmdqueryname=local-switch+enable"><b><span class="cmdname">local-switch enable</span></b></a> command on the user-side Layer 2 sub-interface on PE1. This enables local switching for the EVC Layer 2 sub-interface.</p>
<div class="fignone" id="EN-US_TASK_0172363386__fig_dc_vrp_evc_cfg_003101"><a name="EN-US_TASK_0172363386__fig_dc_vrp_evc_cfg_003101"></a><a name="fig_dc_vrp_evc_cfg_003101"></a><span class="figcap"><b>Figure 1 </b>Local switching for an EVC Layer 2 sub-interface</span><br><span><img class="vsd" src="images/fig_dc_vrp_evc_cfg_003101.png" width="NaN" height="NaN"></span></div>
<h4 class="sectiontitle">Pre-configuration Tasks</h4><p>Before configuring the EVC model to carry VPLS services, create VSIs. VSI IDs are used to differentiate VSIs during PW signaling negotiation.</p>
<p>The VSIs for BDs must be configured using the <a href="cmdqueryname=vsi+bd-mode"><b><span class="cmdname">vsi bd-mode</span></b></a> command.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Ensure that MPLS L2VPN has been enabled on the device before you create VSIs.</p>
</div></div>
</div>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172363386__1.4.2"></a><a name="1.4.2"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Run <span><a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span></span><p><p>The system view is displayed.</p>
</p></li><li><span>Run <span><a href="cmdqueryname=bridge-domain"><b><span class="cmdname">bridge-domain</span></b></a> <i><span class="varname">bd-id</span></i></span></span><p><p>The BD view is displayed.</p>
</p></li><li><span>Run <a href="cmdqueryname=l2+binding"><b><span class="cmdname">l2 binding</span></b></a> <strong><span>vsi</span></strong> <i><span class="varname">vsi-name</span></i> [ <strong><span>pw-tag</span></strong> <i><span class="varname">pw-tag-value</span></i> ]</span><p><p>The BD is bound to a VSI.</p>
</p><p><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If the VSI pipe service mode is used, multiple BDs can access the same VSI. In this case, you must specify a PW tag so that the peer BD can receive packets from the BD with the same PW tag.</p>
</div></div>
</p></li><li><span>(Optional) Run <a href="cmdqueryname=reserve-interface+fast-switch+enable"><b><span class="cmdname">reserve-interface fast-switch enable</span></b></a></span><p><p>The reserve-interface fast switching function is enabled.</p>
<p>In a VPLS over EVC scenario where the public-network-and-private-network decoupling function is configured, to allow broadcast traffic to be rapidly switched to the slave interface board when the master interface board fails, perform this step.</p>
</p></li><li><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172363386__1.4.3"></a><a name="1.4.3"></a><h4 class="sectiontitle">Follow-up Procedure</h4><div class="p">In a VPLS over EVC scenario, each BD functions as an access-side service instance and EVC Layer 2 sub-interfaces join each BD as AC interfaces. The status of a BD is determined by the status of all EVC Layer 2 sub-interfaces in the BD and the VSI. A BD goes down only when all its EVC Layer 2 sub-interfaces and the VSI are both down. The EVC Layer 2 sub-interface status is independent of the VSI status. In a VPWS accessing VPLS scenario where a VSI VC is configured on the local end and a VPWS VC is configured on the remote end, if all EVC Layer 2 sub-interfaces in the BD are down, the remote VPWS VC cannot quickly detect the fault. As a result, traffic is interrupted. To solve this problem, run the <a href="cmdqueryname=response-ac-state"><b><span class="cmdname">response-ac-state</span></b></a> command, so that the VSI can learn the AC interface down event immediately after all EVC Layer 2 sub-interfaces in a BD go down. Then, the VSI will set the PW status to down.<ol><li><p>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></p>
<p>The system view is displayed.</p>
</li><li><p>Run <span><a href="cmdqueryname=vsi"><b><span class="cmdname">vsi</span></b></a> <i><span class="varname">vsi-name</span></i></span></p>
<p>The VSI view is displayed.</p>
</li><li><p>Run <span><a href="cmdqueryname=response-ac-state"><b><span class="cmdname">response-ac-state</span></b></a></span></p>
<p>The VSI is enabled to learn the AC interface down event when all EVC Layer 2 sub-interfaces in a BD are down.</p>
</li><li><p>Run <span><a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span></p>
<p>The configuration is committed.</p>
</li></ol>
</div>
<div class="p">A BD goes down after all EVC Layer 2 sub-interfaces leave the BD. By default, a PE sends MAC Withdraw messages with the 0x404 TLV type to all peers when a BD goes down. After the <a href="cmdqueryname=interface-status-change+mac-withdraw+enable"><b><span class="cmdname">interface-status-change mac-withdraw enable</span></b></a> command is run, a PE sends MAC Withdraw messages with the 0x406 TLV type to all its peers each time an EVC Layer 2 sub-interface leaves the BD. As a result, when a BD goes down, the PE will send MAC Withdraw messages twice. To solve this problem, perform the following steps:<ol><li><p>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></p>
<p>The system view is displayed.</p>
</li><li><p>Run <span><a href="cmdqueryname=vsi"><b><span class="cmdname">vsi</span></b></a> <i><span class="varname">vsi-name</span></i></span></p>
<p>The VSI view is displayed.</p>
</li><li><p>Run <span><a href="cmdqueryname=mac-withdraw+bd-status+down+disable"><b><span class="cmdname">mac-withdraw bd-status down disable</span></b></a></span></p>
<p>The PE is configured not to send MAC Withdraw messages with the 0x404 TLV type to all its peers when a BD goes down.</p>
</li><li><p>Run <span><a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span></p>
<p>The configuration is committed.</p>
</li></ol>
</div>
<div class="p">When the status of an EVC Layer 2 sub-interface changes, a PE sends MAC Withdraw messages that do not carry the PW tag to all its peers. When a peer receives this message, it clears MAC addresses in the VSI based on the message, causing the MAC addresses of other BDs to be deleted incorrectly. To solve this problem, perform the following steps:<ol><li><p>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></p>
<p>The system view is displayed.</p>
</li><li>Run <span><a href="cmdqueryname=interface"><b><span class="cmdname">interface</span></b></a> <i><span class="varname">interface-type interface-number.subnum</span></i> <strong><span>mode l2</span></strong></span><p>The EVC Layer 2 sub-interface view is displayed.</p>
</li><li><p>Run <a href="cmdqueryname=interface-status-change+%5B+up+%7C+down+%5D+mac-withdraw+enable"><b><span class="cmdname">interface-status-change [ up | down ] mac-withdraw enable</span></b></a></p>
<p>The PE is enabled to send a MAC Withdraw message to all its peers when the EVC Layer 2 sub-interface status changes.</p>
</li><li><p>Run <span><a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></span></p>
<p>Return to the system view.</p>
</li><li><p>Run <a href="cmdqueryname=vsi"><b><span class="cmdname">vsi</span></b></a> <i><span class="varname">vsi-name</span></i> <strong><span>bd-mode</span></strong></p>
<p>The BD VSI view is displayed.</p>
</li><li><p>Run <a href="cmdqueryname=mac-withdraw+enable"><b><span class="cmdname">mac-withdraw enable</span></b></a></p>
<p>MAC Withdraw is enabled.</p>
</li><li><p>Run <span><a href="cmdqueryname=mac-withdraw+bd+pw-tag+enable"><b><span class="cmdname">mac-withdraw bd pw-tag enable</span></b></a></span></p>
<p>The PE is configured to send MAC Withdraw messages that carry the PW tag to its peers when its AC interface status changes or the BD goes down.</p>
</li><li><p>Run <span><a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span></p>
<p>The configuration is committed.</p>
</li></ol>
</div>
<p>In EVC scenarios, when a BD accesses a VPLS network in VSI-exclusive service mode, PWs work in raw mode (with the VSI encapsulation type being VLAN). In this case, packets leaving PWs are directly forwarded without having the outer tag removed. To solve this problem, perform the following steps to configure the PWs to work in tagged mode, so that the outer tag is removed when the packets leave the PWs:</p>
<ol><li><p>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></p>
<p>The system view is displayed.</p>
</li><li>Run <a href="cmdqueryname=vsi"><b><span class="cmdname">vsi</span></b></a> <i><span class="varname">vsi-name</span></i> <strong><span>bd-mode</span></strong><p>The BD VSI view is displayed.</p>
</li><li><p>Run <a href="cmdqueryname=pwsignal+ldp"><b><span class="cmdname">pwsignal ldp</span></b></a></p>
<p>The VSI-LDP view is displayed.</p>
</li><li><p>Run <a href="cmdqueryname=vsi-id"><b><span class="cmdname">vsi-id</span></b></a> <i><span class="varname">vsi-id</span></i></p>
<p>A VSI ID is configured.</p>
</li><li><p>Run <a href="cmdqueryname=peer"><b><span class="cmdname">peer</span></b></a> <i><span class="varname">peer-address</span></i></p>
<p>A peer is specified for the current VSI.</p>
</li><li>Run <a href="cmdqueryname=peer"><b><span class="cmdname">peer</span></b></a> <i><span class="varname">peer-address</span></i> <strong><span>pw</span></strong> <i><span class="varname">pw-name</span></i><p>A PW is created for the VSI.</p>
</li><li>Run <a href="cmdqueryname=encapsulation+vlan+pass"><b><span class="cmdname">encapsulation vlan pass</span></b></a><p>The BD VPLS tagged mode is enabled.</p>
</li><li><p>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></p>
<p>The configuration is committed.</p>
</li></ol>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evc_cfg_0030.html">Configuring the EVC Model to Carry L2VPN Services
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evc_cfg_0032.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>