Configuration Precautions for HQoS
==================================

Configuration Precautions for HQoS

#### Feature Requirements

**Table 1** Feature requirements
| Feature Requirements | Series | Models |
| --- | --- | --- |
| When both SRv6 and HQoS are configured on a public network interface, HQoS rate limiting does not take effect. | NE40E-M2 | NE40E-M2E, NE40E-M2F, NE40E-M2H |
| SRv6 services are configured on a public network interface, and the port-queue outbound or port shaping command is run on the corresponding main interface. However, the actual traffic rate is greater than the bandwidth configured using the port-queue outbound or port shaping command. | NE40E-M2 | NE40E-M2E, NE40E-M2F, NE40E-M2H |
| 1. HQoS on vlan-type dot1q sub-interfaces shares microwave link bandwidth with vlan-type dot1q channelized sub-interface. Microwave bandwidth learning is triggered by the Y.1731 protocol. Therefore, the configuration page cannot detect the learning result and bandwidth verification cannot be performed. Users need to plan the bandwidth for channelized services and non-channelized services in advance based on the stable bandwidth of microwave links. The sum of the bandwidth for channelized services and the bandwidth for non-channelized services must be less than or equal to the stable microwave bandwidth. Otherwise, the bandwidth for channelized services cannot be guaranteed, and packet loss occurs on the downstream microwave device.  2. The bandwidth of channelized services and that of non-channelized services have been planned based on the stable bandwidth of microwave links. However, the bandwidth of channelized services and that of non-channelized services are statically configured, and the microwave bandwidth changes dynamically. If the microwave bandwidth decreases greatly, if the sum of channelized service bandwidth is greater than or equal to the advertised microwave bandwidth, the channelized service bandwidth cannot be guaranteed and packet loss occurs on the downstream microwave device. In this case, the system generates an alarm. The O&M personnel need to handle the alarm according to the actual situation. For example, switch some channelized services to the backup microwave link. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| When the scheduling tree of a trunk interface is split (including default scheduling tree splitting), traffic on each interface must be evenly hashed. If the hash result is uneven, the traffic rate may fail to reach the bandwidth configured using the port shaping command. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| After user CAR, user FQ, user SQ, user GQ, or user VLAN CAR is configured, the bandwidth doubles when user traffic crosses hardware resource groups (hardware rate limiting units). For example, a trunk interface has multiple inter-board member interfaces, and SQ rate limiting for leased line users is performed on multiple inter-board member interfaces. As a result, the bandwidth is doubled. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| After the flow-queue, user-queue, user-group-queue, or sub-port-queue command is run on an interface, the bandwidth doubles when traffic is transmitted across hardware resource groups (hardware rate limiting units). For example, a trunk interface has multiple member interfaces across forwarding modules, and user-queue limits the rate on multiple forwarding modules. As a result, the bandwidth is doubled. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| After the qos schedule-tree distribute-mode outbound command is run on a trunk interface to configure the scheduling tree distribute mode, each trunk member interface is a hardware resource group. When FQ/SQ/GQ/VI rate limiting is configured, the bandwidth is doubled based on the number of trunk member interfaces. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| The NE40E-M2E board has CQ entity queues, and port queues take effect for all traffic on the port. Other boards do not have CQ entity queues. The default FQ on a port is used to implement the port queue function, which takes effect only for non-SQ service traffic on the port. | NE40E-M2 | NE40E-M2E |
| The user-side bandwidth split function takes effect only for access user traffic and does not take effect for DAA or EDSG service traffic. DAA or EDSG service traffic still uses the configured bandwidth. If a user goes online through a trunk interface and the access user traffic crosses TM modules, DAA and EDSG service rate limit traffic is doubled. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| 1, In high-performance mode, when HQoS is configured for MPLS TE bandwidth on a subcard interface higher than 100G, traffic is limited using TE CAR, but different scheduling behaviors cannot be generated based on priorities.  2, In high-performance mode, when HQoS is configured for MPLS TE bandwidth on a subcard interface higher than 100G, which is trunk member interface, traffic is limited using TE CAR, but different scheduling behaviors cannot be generated based on priorities.  The HQoS function for MPLS TE bandwidth does not take effect, and CAR is used for rate limiting. | NE40E-M2 | NE40E-M2K/NE40E-M2K-B |
| 1, In non-convergence mode, when HQoS is configured for MPLS TE bandwidth on an interface numbered 30 to 37, traffic is limited using TE CAR but cannot be scheduled based priorities.  2, In non-convergence mode, when HQoS is configured for MPLS TE bandwidth on a trunk with a member interface numbered 30 to 37, traffic is limited using TE CAR but cannot be scheduled based priorities.  The HQoS function for MPLS TE bandwidth does not take effect, and CAR is used for rate limiting. | NE40E-M2 | NE40E-M2K/NE40E-M2K-B |
| 1. In convergence mode, the bandwidth of the entire system is 640 Gbit/s. Traffic on all interfaces (fixed interfaces and flexible subcard interfaces) is scheduled through the eTM. All interfaces have the outbound HQoS capability. Before traffic enters the eTM, the NP converges the traffic to 640 Gbit/s. When the actual traffic rate on the device exceeds 640 Gbit/s, the excess traffic is discarded based on priorities.  2. In non-convergence mode, the bandwidth of the device is 910 Gbit/s. The traffic on the flexible subcard with a capacity greater than 100 Gbit/s is not scheduled by the eTM and does not support the queue buffer and queue scheduling capability. Traffic on the subcards with the capacity of 100 Gbit/s or lower and on the fixed interfaces on the panel are scheduled through the eTM. If the device does not have a subcard with a capacity greater than 100 Gbit/s, the maximum bandwidth of the device is 710 Gbit/s (510 Gbit/s fixed interfaces + two 100 Gbit/s flexible subcards). However, the device still converges traffic to 640 Gbit/s. The excess traffic is discarded based on priorities.  Plan services properly. | NE40E-M2 | NE40E-M2K/NE40E-M2K-B |
| When member interfaces of a trunk reside on different TM/NP modules and traffic is not evenly balanced among trunk member interfaces using hash or traffic is not forwarded in load balancing mode, the rate limit on a single TM/NP module may be smaller than the configured value after bandwidth allocation. When load balancing among trunk member interfaces is uneven, packet loss may occur even if the traffic rate does not exceed the rate limit.  Do not configure inter-subcard member interfaces for a trunk. | NE40E-M2 | NE40E-M2K |
| The CIR of a port queue and share-shaping are mutually exclusive. If the CIR is configured for a port queue on an interface, share-shaping cannot be configured on the interface. If share-shaping is configured on an interface, the CIR cannot be configured for a port queue on the interface. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| The CS7, CS6, EF, AF4, AF3, AF2, AF1, and BE queues are serviced in descending order of priority. The low-latency feature of the three high-priority queues (CS7, CS6, and EF) is preferentially ensured. Low-latency services must be deployed in the three high-priority queues. If they are deployed in the other five low-priority queues, you must ensure that the three high-priority queues are not congested. Otherwise, the maximum latency of low-latency services in the five low-priority queues cannot be ensured.  For example:  In congestion scenarios, BE is configured with a low latency, and CS7 is not configured with a low latency. In this case, the maximum latency of BE queues cannot be ensured, but the average latency can be ensured. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| In high-performance mode, interfaces on the flexible subcard higher than 100 Gbit/s do not have the queue buffer and queue scheduling functions. When a large traffic burst occurs, the traffic rate on interfaces cannot reach the interface bandwidth.  You are advised to plan services properly. | NE40E-M2 | NE40E-M2K |
| By default, a CR5D00EEGF71 subcard supports user-side downstream HQoS only after the set service-mode port-extended command is run. After the set service-mode port-extended command is deleted, HQoS is forcibly switched to CAR in the downstream direction on the user side.  In this case, to support HQoS in the downstream direction on the user side, you need to run the access-user board-schedule enable outbound command in the slot view of the subcard. | NE40E-M2 | NE40E-M2F/NE40E-M2H |
| In high-performance mode, interfaces that pass through an ETM chip and interfaces that do not pass through an ETM chip cannot be added to the same trunk, regardless of whether HQoS is configured. (For an M2K, the interfaces with bandwidth greater than 100 Gbit/s do not pass through an ETM chip, and other interface pass through an ETM chip.)  You are advised to plan services properly. | NE40E-M2 | NE40E-M2K |
| If the qos schedule-tree distribute-mode outbound command has been run on an Eth-Trunk interface and the Eth-Trunk has member interfaces, services will be interrupted during configuration rollback. After the configuration rollback is complete, services are automatically restored.  When the scheduling tree split function is deleted, member interfaces in the trunk can be deleted only after they are removed from the trunk. As a result, services are affected. When the scheduling tree split function is rolled back, this operation can be implemented only after the member interfaces are removed from the trunk. Therefore, services are affected. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| An interface queue with a CIR configured and an interface queue with a low delay configured preempt resources. If an interface queue on an interface has a CIR configured, the interface queue preempts resources from the interface queue with a low delay configured, the preemption priority of traffic is the same as the priority of an interface queue. The CIR and low delay cannot be configured for the same interface queue. You are advised to plan services properly. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| The following boards support the CIR function for FQs and port queues: NE40E-M2H. CIR scheduling of low-priority queues is not supported, and the bandwidth of low-priority queues cannot be guaranteed. | NE40E-M2 | NE40E-M2H |
| On each SQ, a maximum of two FQs support the CIR configuration. On each interface, only two port queues support the CIR configuration. CIR scheduling of low-priority queues is not supported, and the bandwidth of low-priority queues cannot be guaranteed. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| A flow queue configured with CIR and a flow queue configured with low delay preempt traffic. If a flow queue in a user queue is configured with CIR, traffic in the flow queue preempts traffic from the flow queue configured with low delay, the preemption priority is the same as the priority of the flow queue. The CIR and low delay cannot be configured for the same flow queue at the same time. You are advised to plan services properly. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| CIR and share-shaping are mutually exclusive for flow queues. If CIR has been configured for a flow queue in a user queue, share-shaping cannot be configured for the user queue. If share-shaping has been configured for a flow queue in a user queue, CIR cannot be configured for the flow queue. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| Channelized sub-interface and IP hard pipe on the same main interface are mutually exclusive. You are advised to plan services properly. | NE40E-M2 | NE40E-M2F/NE40E-M2H |
| qos-profile and user-group-queue cannot be configured on the channelized sub-interface. You are advised to plan services properly. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| It is not recommended that rate limiting QoS be deployed on network-side forwarding interfaces of hard pipes. QoS configurations (CAR or ACL) on the main interface or sub-interface that is used for hard-pipe forwarding also apply to hard pipe traffic. For example, if CAR is configured in the inbound direction on a P, hard pipe traffic is also restricted according to the CAR configuration, which may cause hard pipe packet loss.  Do not deploy QoS CAR or a traffic policy containing CAR, user queue, or deny actions on a hard pipe-enabled network-side interface. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| The upstream buffer function is weak. The FQ uses the shaper bucket depth to control the input burst. When the traffic burst is large and the sum of weights of FQ services is large, if the shaper bucket depth is too small, packet loss occurs or WFQ scheduling is inaccurate.  A large bucket depth is required. You can use a specified PBS configuration tool to calculate a proper PBS value. | NE40E-M2 | NE40E-M2K/NE40E-M2K-B |
| If channelized sub-interface is configured on an interface, the interface and its sub-interfaces cannot be configured with user-group-queue. You are advised to plan services properly. | NE40E-M2 | NE40E-M2K/NE40E-M2K-B |
| After channelized sub-interface is configured on an interface, sub-port-queue cannot be configured on the interface and its sub-interfaces. You are advised to plan services properly. | NE40E-M2 | NE40E-M2F/NE40E-M2H |
| The user-side bandwidth split function requires even load balancing among trunk member interfaces. Otherwise, the user-side bandwidth is less than the expected rate limit. Properly plan user traffic. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| The upstream buffer function is weak. The FQ uses the shaper bucket depth to control the input burst. When the traffic burst is large and the sum of weights of FQ services is large, if the shaper bucket depth is too small, packet loss occurs or WFQ scheduling is inaccurate.  A large bucket depth is required. You can use a specified PBS configuration tool to calculate a proper PBS value. | NE40E-M2 | NE40E-M2K/NE40E-M2K-B |
| When traffic congestion occurs in the CS6 or CS7 queue on the main interface, the channelized bandwidth and delay cannot be ensured. Plan services properly. | NE40E-M2 | NE40E-M2E |
| Sufficient CIR bandwidth is a prerequisite for ensuring low delay. The default CIR of an interface is 10 Mbit/s. To ensure that low-delay port-queue traffic is greater than 10 Mbit/s, run the qos default user-queue command to change the default CIR of the interface to a value greater than or equal to the bandwidth of low-delay port-queue traffic. The bandwidth for low-delay services is greater than the CIR. Therefore, low-delay services cannot be ensured.  You are advised to run the qos default user-queue command to adjust the CIR of the default SQ on the interface. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| When SRv6, Layer 2 multicast, or BIER multicast services are deployed on a channelized sub-interface, rate limiting configured on the channelized sub-interface does not take effect for the services. Do not configure SRv6, Layer 2 multicast, or BIER multicast services on channelized sub-interfaces. | NE40E-M2 | NE40E-M2E |
| The "port-queue cs6" command and a channelized sub-interface cannot be configured together on a main interface. When a subcard is replaced or configurations are rolled back and both the "port-queue cs6" command and a channelized sub-interface are configured on a main interface, the bandwidth and delay of services on channelized sub-interfaces cannot be ensured. Plan services properly. | NE40E-M2 | NE40E-M2E |
| The SQ configured for downstream traffic on a global VE interface does not take effect. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| Consecutive VLANs and a QoS profile are configured on an interface. If two or more inconsecutive VLANs are deleted and committed at the same time, service flapping may occur and statistics may be lost.  You are advised to delete one or more consecutive VLANs and QoS profiles from the interface at a time and then commit the configuration. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| If user-queue is configured in a traffic policy applied to a channelized sub-interface, the user-queue bandwidth is restricted by the remaining unchannelized bandwidth on the main interface, not the channelized sub-interface bandwidth. Therefore, you are not advised to configure user-queue in a traffic policy applied to a channelized sub-interface. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| In a multicast pruning scenario, after channelized sub-interfaces are configured, Layer 2 multicast and BIER multicast traffic on a main interface and its sub-interfaces cannot reach the interface bandwidth. In worst scenarios, traffic may reach only half of the interface bandwidth. When both Layer 2 multicast/BIER multicast and channelized sub-interfaces are configured on a main interface, Layer 2 multicast/BIER multicast services cannot reach the actual interface bandwidth.  Do not configure both Layer 2 multicast/BIER multicast and channelized sub-interfaces on a main interface. | NE40E-M2 | NE40E-M2E |
| When SRv6, Layer 2 multicast, or BIER multicast services are deployed on a channelized sub-interface of NE40E-M2E and NE40E-M2F boards, rate limiting based on channelization is not supported. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E |
| The sum of the channelized sub-interface bandwidths configured on the same physical interface cannot exceed 98% of the physical interface bandwidth minus the maximum reservable bandwidth of the TE tunnel. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| When traffic congestion occurs in the CS6 or CS7 queue on a physical main interface of a NE40E-M2E board, the channelized bandwidth and delay cannot be ensured.  When traffic congestion occurs in the EF, CS6, or CS7 queue on a trunk main interface of a NE40E-M2E board, the channelized bandwidth and delay cannot be ensured. | NE40E-M2 | NE40E-M2E |
| Channelized sub-interface can be configured only on VLAN-type dot1q sub-interfaces or QinQ VLAN tag termination sub-interfaces of GE, XGE, 10GE, 25GE, 40GE, 50GE, 100GE, 200GE, and 400GE Ethernet physical interfaces, FlexE physical interfaces, and Eth-Trunk interfaces. You are advised to properly plan their functions for use. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| Channelized sub-interfaces cannot perform precise compensation based on services. If the maximum compensation value and precise shaper processing are used, the interface usage cannot reach 100%. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| The channelized sub-interface does not support the user-group-queue command. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| If channelized sub-interfaces are configured on a main interface, IP hard pipe cannot be configured for these channelized sub-interfaces. After IP hard pipe is configured on an interface, channelized sub-interfaces cannot be configured on the interface. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E/NE40E-M2F |
| Eth-Trunk channelized sub-interfaces cannot be configured on Eth-Trunk member interfaces that reside on the same board but have different TM types. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| If channelized sub-interfaces are configured on a main interface, the "sub-port-queue" and "user-group-queue" cannot be run on the main interface and its all sub-interfaces. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| If channelized sub-interfaces are configured on a main interface, the "qos default { sub-port-queue | user-group-queue }" command cannot be run on the main interface. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| Configuring channelized sub-interfaces on an Eth-Trunk interface is mutually exclusive with running the "port shaping" command on member interfaces of the Eth-Trunk interface. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| Channelized sub-interfaces do not support the "qos-profile," "user-queue," or "user-queue shaping ldp-traffic outbound" command. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| When Eth-Trunk member interfaces reside on different TMs, the bandwidth configured for channelization is delivered based on the weight and equal ratio of the same TM by default, and the bandwidth is not doubled. When the hash algorithm is uneven, the bandwidth and delay for channelization cannot be reached, and packet loss occurs. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| In channelization scenarios, the default compensation value applies only to a single typical scenario to ensure delay on the NE40E-M2E NE40E-M2F board equipped with a non-E subcard. For example, if the TM compensation value is set to 58 bytes, packet expansion may occur in some scenarios. As a result, packet loss occurs when traffic reaches the maximum bandwidth. For example, in IP forwarding scenarios, the smaller the compensation value, the greater the impact. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H |
| The port-queue cs6 and channelized sub-interface functions cannot be configured on the same physical interface of the NE40E-M2E board.  The port-queue ef, port-queue cs6, port-queue cs7, and channelized sub-interface functions cannot all be configured on the same trunk interface of the NE40E-M2E board. | NE40E-M2 | NE40E-M2E |
| The total bandwidth of trunk channelized sub-interfaces cannot exceed 98% of the Eth-Trunk interface bandwidth (total bandwidth of all Up interfaces) minus the maximum reservable bandwidth of the TE tunnel. | NE40E-M2 | NE40E-M2E |
| By default, Eth-Trunk channelized sub-interface splits the channelized bandwidth based on the TM weight ratio. When a member interface is added to or removed from an Eth-Trunk, the weight ratio of the TM to which each member interface belongs changes, and therefore the channelized bandwidth is updated. During this period, the channelized traffic cannot reach the limited bandwidth or delay, packet loss occurs. You are advised to properly plan the function. | NE40E-M2 | NE40E-M2E/NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| When traffic of an Eth-Trunk channelized sub-interface is unevenly balanced, its bandwidth cannot be ensured. After the mode channel bandwidth maximize command is run on the Eth-Trunk channelized sub-interface to enable the extension mode, the channelized bandwidth can be increased. If the involved interface is not congested, the delay can be ensured. However, if the involved interface is congested, the delay cannot be ensured.  Adjust the bandwidth of the channelized sub-interface to a value greater than the actual one to solve the congestion problem. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| When users in the same family go online through different sub-interfaces, if different compensation values are configured for the sub-interfaces, the configuration on the sub-interface where the last user goes online takes effect. You are advised to configure the same last-mile compensation value for all sub-interfaces. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |
| When a CoA message is used to deliver a QoS profile, if the modes are different (8-queue mode and 4-queue mode) before and after the QoS profile is delivered, the HQoS function does not take effect for users for a short period of time during switching. | NE40E-M2 | NE40E-M2K/NE40E-M2K-B |
| The session-limit configurations must be the same for a family. If the configurations are different, you cannot determine which configuration takes effect. | NE40E-M2 | NE40E-M2F/NE40E-M2H/NE40E-M2K/NE40E-M2K-B |