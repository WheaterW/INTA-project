Example for Configuring a Timestamp-Refresh Instance
====================================================

This section provides an example for configuring timestamp-refresh for time synchronization between input and output signals of a camera. After timestamp-refresh is deployed on a router, the timestamps in packets can be synchronized with the time of the router, eliminating the impact of the transmission duration.

#### Networking Requirements

The timestamp-refresh feature is deployed on a transit router to solve the problem that the clock of the stream producer is not synchronized with that of the router. On the network shown in [Figure 1](#EN-US_TASK_0000001394385958__fig11344539105117), after multicast streams arrive at the PE, on which timestamp-refresh is deployed, the PE calculates the timestamp-refresh offset value according to the timestamps in multicast stream packets and the local time and then uses the offset value to refresh the timestamps of the multicast streams in a unified manner.

**Figure 1** Networking diagram of timestamp-refresh![](../../../../public_sys-resources/note_3.0-en-us.png) 

In this example, interface1 and interface2 represent GE0/1/1 and GE0/1/0, respectively.


  
![](figure/en-us_image_0000001494768697.png)
#### Configuration Roadmap

The configuration roadmap is as follows:

1. Configure a timestamp-refresh instance.
2. Configure multicast NAT.
3. Configure an ACL.
4. Configure a traffic classifier.
5. Configure a traffic behavior and bind the traffic behavior to the timestamp-refresh instance and multicast NAT instance.
6. Configure a traffic policy.
7. Apply the traffic policy to the inbound interface of input streams.

#### Data Preparation

To complete the configuration, you need the following data.

* Format of video streams generated by the camera
* Sampling rate on the camera


#### Procedure

1. Configure a timestamp-refresh instance.
   
   
   ```
   <HUAWEI> system-view
   [~HUAWEI] sysname PE
   [*PE] commit
   [~PE] multicast timestamp-refresh instance one
   [*PE-mc-ts-rfsh-instance-one] mode common
   [*PE-mc-ts-rfsh-instance-one] type video-stream
   [*PE-mc-ts-rfsh-instance-one] commit
   [~PE-mc-ts-rfsh-instance-one] quit
   ```
2. Configure multicast NAT.
   
   
   1. Enable multicast NAT on the device.
      ```
      [~PE] multicast-nat enable
      [*PE] commit
      ```
   2. Create a multicast NAT instance on the device.
      ```
      [~PE] multicast-nat instance id 1 name stream1 
      [*PE-multicast-nat-instance-1] commit
      [~PE-multicast-nat-instance-1] quit
      ```
   3. Configure characteristics for output multicast streams.
      ```
      [~PE] interface GigabitEthernet 0/1/0
      [*PE-GigabitEthernet0/1/0] multicast-nat outbound id 1 name out1_1
      [*PE-GigabitEthernet0/1/0] commit
      [~PE-GigabitEthernet0/1/0] quit
      ```
   4. Bind the output multicast streams to the multicast NAT instance.
      ```
      [~PE] multicast-nat bind-list
      [*PE-multicast-nat-bind-list] multicast-nat outbound id 1 name out1_1 bind instance id 1 name stream1
      [*PE-multicast-nat-bind-list] commit
      [~PE-multicast-nat-bind-list] quit
      ```
3. Configure an ACL.
   
   
   ```
   [~PE] acl number 3001
   [*PE-acl4-advance-3001] rule 1 permit udp source 10.10.10.10 0 destination 239.0.0.1 0 destination-port eq 10000
   [*PE1-acl4-advance-3001] commit
   [~PE1-acl4-advance-3001] quit
   ```
4. Configure a traffic classifier.
   
   
   ```
   [~PE] traffic classifier rule_ip1
   [*PE-classifier-rule_ip1] if-match acl 3001
   [*PE-classifier-rule_ip1] commit
   [~PE-classifier-rule_ip1] quit
   ```
5. Configure a traffic behavior and bind the traffic behavior to the timestamp-refresh instance and multicast NAT instance.
   
   
   ```
   [~PE] traffic behavior rule_ip1
   [*PE-behavior-rule_ip1] multicast timestamp-refresh bind instance one
   [*PE-behavior-rule_ip1] multicast-nat bind instance id 1 name stream1
   [*PE-behavior-rule_ip1] commit
   [~PE-behavior-rule_ip1] quit
   ```
6. Configure a traffic policy.
   
   
   ```
   [~PE] traffic policy match1_ip_list1
   [*PE-trafficpolicy-match1_ip_list1] classifier rule_ip1 behavior rule_ip1
   [*PE-trafficpolicy-match1_ip_list1] commit
   [~PE-trafficpolicy-match1_ip_list1] quit
   ```
7. Apply the traffic policy to the inbound interface of input streams.
   
   
   ```
   [~PE] interface GigabitEthernet 0/1/1
   [*PE-GigabitEthernet0/1/1] traffic-policy match1_ip_list1 inbound
   [*PE-GigabitEthernet0/1/1] multicast-nat inbound enable
   [*PE-GigabitEthernet0/1/1] commit
   [~PE-GigabitEthernet0/1/1] quit
   ```
8. Verifying the Configuration
   
   
   
   # Run the [**display multicast timestamp-refresh**](cmdqueryname=display+multicast+timestamp-refresh)[ **instance** *instance-name* ] command to check the local and global timestamp-refresh offset values.
   
   ```
   [~PE] display multicast timestamp-refresh instance one
    Multicast timestamp-refresh instance one
     Timestamp offset local: 0x16ae63b1
     Timestamp offset global: 0x16ae63b1
   ```
   
   
   
   # Run the [**display current-configuration**](cmdqueryname=display+current-configuration) **configuration** *multicast-tsrefresh-instance* command to view the timestamp-refresh instance configuration.
   
   ```
   [~PE] [display current-configuration](cmdqueryname=display+current-configuration) configuration multicast-tsrefresh-instance
   #
   multicast timestamp-refresh instance one
    mode 2022-7
    type video-stream
   #
   
   return
   ```
   
   
   
   # Run the [**display current-configuration**](cmdqueryname=display+current-configuration)**configuration** [ *behavior* ] command to check the configuration result of binding a traffic behavior to a timestamp-refresh instance.
   
   ```
   [~PE] [display current-configuration](cmdqueryname=display+current-configuration) configuration behavior
   #
   traffic behavior 1
   #
   traffic behavior one
    multicast timestamp-refresh bind instance one
   #
   return
   ```

#### Configuration Files

* PE
  ```
  # 
  sysname PE 
  # 
  multicast-nat enable
  #
  multicast-nat instance id 1 name stream1
  #
  multicast timestamp-refresh instance one 
   mode common 
   type video-stream
  # 
  acl number 3001 
   rule 1 permit udp source 10.10.10.10 0 destination 239.0.0.1 0 destination-port eq 10000 
  # 
  traffic classifier rule_ip1 operator or 
   if-match acl 3001 precedence 1 
  # 
  traffic behavior rule_ip1 
   multicast-nat bind instance id 1 name stream1
   multicast timestamp-refresh bind instance one 
  # 
  traffic policy match1_ip_list1 
   share-mode 
   classifier rule_ip1 behavior rule_ip1 precedence 1 
  # 
  interface GigabitEthernet0/1/0 
   undo shutdown 
   multicast-nat outbound id 1 name out1_1 
   undo dcn 
  #
  interface GigabitEthernet0/1/1 
   undo shutdown 
   traffic-policy match1_ip_list1 inbound 
   undo dcn
   multicast-nat inbound enable 
  #
  multicast-nat bind-list
   multicast-nat outbound id 1 name out1_1 bind instance id 1 name stream1
  #
  ```