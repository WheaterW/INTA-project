Configuring Dynamic BGP Flow Specification
==========================================

Dynamic BGP Flow Specification allows a traffic analysis server to generate BGP Flow Specification routes to control traffic.

#### Usage Scenario

When deploying dynamic BGP Flow Specification, a BGP Flow Specification peer relationship needs to be established between the traffic analysis server and each ingress of the network to transmit BGP Flow Specification routes.

In an AS with multiple ingresses, a BGP Flow route reflector (Flow RR) can be deployed to reduce the number of BGP Flow Specification peer relationships to be established and save network resources.

If you want to filter traffic matching a specified address prefix but BGP Flow Specification routes matching the specified address prefix cannot pass validation, disable the validation of the BGP Flow Specification routes received from a specified peer.


#### Pre-configuration Tasks

Before configuring dynamic BGP Flow Specification, [configure a BGP peer.](dc_vrp_bgp_cfg_3006.html)


#### Procedure

1. Configure a BGP Flow Specification peer relationship.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
      
      
      
      The BGP-Flow address family view is displayed.
   4. Run [**peer**](cmdqueryname=peer) *ipv4-address* [**enable**](cmdqueryname=enable)
      
      
      
      A BGP Flow Specification peer relationship is established.
      
      
      
      After the BGP Flow Specification peer relationship is established in the BGP-Flow address family view, BGP Flow Specification routes generated by a traffic analysis server are automatically imported to the BGP routing table and then sent to the BGP Flow Specification peer.
   5. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
2. (Optional) Configure a Flow RR.
   
   
   
   Before configuring a Flow RR, establish a BGP Flow Specification peer relationship between the Flow RR with the traffic analysis server and every network ingress.
   
   
   
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
      
      
      
      The BGP-Flow address family view is displayed.
   4. Run [**peer**](cmdqueryname=peer) *ipv4-address* [**reflect-client**](cmdqueryname=reflect-client)
      
      
      
      A Flow RR is configured, and clients are specified for it.
      
      
      
      The Router on which the [**peer reflect-client**](cmdqueryname=peer+reflect-client) command is run functions as a Flow RR, and the network ingress and traffic analysis server function as clients.
   5. (Optional) Run [**undo reflect between-clients**](cmdqueryname=undo+reflect+between-clients)
      
      
      
      Route reflection between clients through the RR is disabled.
      
      
      
      If the clients of a Flow RR are fully meshed, you can run the [**undo reflect between-clients**](cmdqueryname=undo+reflect+between-clients) command on the Flow RR to disable route reflection between clients through the RR, which reduces costs.
   6. (Optional) Run [**reflector cluster-id**](cmdqueryname=reflector+cluster-id) { *cluster-id-value* | *cluster-id-ipv4* }
      
      
      
      A cluster ID is configured for the Flow RR.
      
      
      
      If a cluster has multiple Flow RRs, run this command to set the same *cluster-id* for these RRs.
      
      ![](../../../../public_sys-resources/note_3.0-en-us.png) 
      
      The [**reflector cluster-id**](cmdqueryname=reflector+cluster-id) command is applicable only to Flow RRs.
   7. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
3. (Optional) Configure the device to check the AS\_Path attribute during BGP Flow Specification route validation.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
      
      
      
      The BGP-Flow address family view is displayed.
   4. Run [**route validation-mode include-as**](cmdqueryname=route+validation-mode+include-as)
      
      
      
      The device is configured to check the AS\_Path attribute during BGP Flow Specification route validation.
      
      
      
      BGP Flow Specification route validation is performed in either of the following modes:
      * Validation mode 1: After receiving a BGP Flow Specification route with a destination address-based filtering rule, the device checks the validity of the route using the rules described in [Figure 1](#EN-US_TASK_0172372344__en-us_task_0172372345_en-us_cliref_0172383989_fig_route_validation-mode_include-as01). The route is considered valid only if the validation succeeds.
      * Validation mode 2: After receiving a BGP Flow Specification route with a destination address-based filtering rule, the device checks the validity of the route by checking whether the AS\_Path attribute of the route carries the AS\_Set and AS\_Sequence fields. The route is considered valid only if its AS\_Path attribute does not carry the AS\_Set or AS\_Sequence field.Validation mode 2 is configured using the [**route validation-mode include-as**](cmdqueryname=route+validation-mode+include-as) command. If this command is configured, the device checks the validity of a BGP Flow Specification route using mode 2 first.
      * If the validation succeeds, the BGP Flow Specification route is considered valid, and mode 1 is not used.
      * If the validation fails, the device checks the validity of the BGP Flow Specification route using mode 1.If this command is not run, the device uses mode 1 to check the validity of BGP Flow Specification routes.**Figure 1** BGP Flow Specification validation rules  
      ![](figure/en-us_image_0000001183343598.png)
   5. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
4. (Optional) Disable BGP Flow Specification route validation.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
      
      
      
      The BGP-Flow address family view is displayed.
   4. Run [**peer**](cmdqueryname=peer+validation-disable) *ipv4-address* **validation-disable**
      
      
      
      The device is disabled from validating the BGP Flow Specification routes received from a specified peer.
   5. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
5. (Optional) Disable the device from validating the next hop of each route that carries the redirection next-hop attribute and is received from a specified EBGP peer.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
      
      
      
      The BGP-Flow address family view is displayed.
   4. Run [**peer**](cmdqueryname=peer+redirect+ip+validation-disable) *ipv4-address* **redirect ip validation-disable**
      
      
      
      The device is disabled from validating the routes that carry a redirection extended community attribute and are received from a specified EBGP peer.
   5. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
6. (Optional) Configure a BGP peer to process the received routes that carry the redirection next-hop IPv6 address, color, and prefix SID attributes.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**bgp**](cmdqueryname=bgp) *as-number*
      
      
      
      The BGP view is displayed.
   3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
      
      
      
      The BGP-Flow address family view is displayed.
   4. Run [**peer**](cmdqueryname=peer+redirect+tunnelv6) *ipv4-address* **redirect tunnelv6**
      
      
      
      The BGP peer is configured to process the received routes that carry the next-hop IPv6 address, color, and prefix SID attributes.
   5. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
7. (Optional) Configure the redirection next-hop attribute ID for BGP Flow Specification routes.
   
   
   
   The redirection next-hop attribute ID can be 0x010C (defined in a related RFC) or 0x0800 (defined in a related draft). If a Huawei device needs to communicate with a non-Huawei device that does not support the redirection next-hop attribute ID of 0x010C or 0x0800, set the redirection next-hop attribute ID of BGP Flow Specification routes as required. Perform one of the following configurations based on the ID supported by non-Huawei devices:
   
   * Set the redirection next-hop attribute ID to 0x010C (defined in a related RFC) for BGP Flow Specification routes.
     
     1. Run [**system-view**](cmdqueryname=system-view)
        
        The system view is displayed.
     2. Run [**bgp**](cmdqueryname=bgp) *as-number*
        
        The BGP view is displayed.
     3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
        
        The BGP-Flow address family view is displayed.
     4. Run [**peer**](cmdqueryname=peer+redirect+ip+rfc-compatible) *ipv4-address* **redirect ip rfc-compatible**
        
        The redirection next-hop attribute ID of the BGP Flow Specification route is set to 0x010C (defined in a related RFC).
     5. Run [**commit**](cmdqueryname=commit)
        
        The configuration is committed.
   * Change the redirection next-hop attribute ID of BGP Flow Specification routes to 0x0800 (defined in a related draft).
     
     1. Run [**system-view**](cmdqueryname=system-view)
        
        The system view is displayed.
     2. Run [**bgp**](cmdqueryname=bgp) *as-number*
        
        The BGP view is displayed.
     3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
        
        The BGP-Flow address family view is displayed.
     4. Run [**peer**](cmdqueryname=peer+redirect+ip+draft-compatible) *ipv4-address* **redirect ip draft-compatible**
        
        The redirection next-hop attribute ID of BGP Flow Specification routes is changed to 0x0800 (defined in a related draft).
     5. Run [**commit**](cmdqueryname=commit)
        
        The configuration is committed.
8. (Optional) Configure the interface in the BGP Flow Specification as the traffic-injection interface of the cleaned traffic to prevent the injected traffic from matching the Flow Specification rules and being switched back to the cleaning device.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**interface**](cmdqueryname=interface) *interface-type* *interface-number*
      
      
      
      The interface view is displayed.
   3. Run [**flowspec refluence**](cmdqueryname=flowspec+refluence)
      
      
      
      The interface in BGP Flow Specification is configured as the traffic-injection interface for cleaning traffic.
      
      
      
      ![](../../../../public_sys-resources/note_3.0-en-us.png) 
      
      This configuration conflicts with MF classification. Therefore, after this command is configured on an interface, do not configure MF classification on the interface.
      
      This command cannot be configured on Eth-Trunk member interfaces. The configuration on a main interface also takes effect on its sub-interfaces.
   4. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
9. (Optional) Disable BGP Flow Specification on the interface.
   1. Run [**system-view**](cmdqueryname=system-view)
      
      
      
      The system view is displayed.
   2. Run [**interface**](cmdqueryname=interface) *interface-type* *interface-number*
      
      
      
      The interface view is displayed.
   3. Run [**flowspec disable**](cmdqueryname=flowspec+disable+ipv4+ipv6) [ **ipv4** | **ipv6** ]
      
      
      
      BGP Flow Specification is disabled on the interface.
      
      
      
      ![](../../../../public_sys-resources/note_3.0-en-us.png) 
      
      This command cannot be configured on Eth-Trunk member interfaces. The configuration on a main interface also takes effect on its sub-interfaces.
      
      If BGP Flow Specification does not need to be disabled on a sub-interface, run the [**flowspec disable**](cmdqueryname=flowspec+disable+ipv4+ipv6+sub-port-exclude) [ **ipv4** | **ipv6** ] **sub-port-exclude** command on the main interface to which the sub-interface belongs.
   4. Run [**commit**](cmdqueryname=commit)
      
      
      
      The configuration is committed.
10. (Optional) Configure the device to redirect traffic to a specified IPv6 next hop after receiving a BGP Flow Specification route from a peer.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**bgp**](cmdqueryname=bgp) *as-number*
       
       
       
       The BGP view is displayed.
    3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
       
       
       
       The BGP-Flow address family view is displayed.
    4. Run [**peer**](cmdqueryname=peer+redirect+ipv6) *ipv4-address* **redirect ipv6**
       
       
       
       The device is configured to redirect traffic to a specified IPv6 next hop after receiving a BGP Flow Specification route from a peer.
    5. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
11. (Optional) Allow the device to recurse the received routes that carry a redirection next hop IP address to tunnels.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**bgp**](cmdqueryname=bgp) *as-number*
       
       
       
       The BGP view is displayed.
    3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
       
       
       
       The BGP-Flow address family view is displayed.
    4. Run [**redirect ip recursive-lookup tunnel**](cmdqueryname=redirect+ip+recursive-lookup+tunnel+tunnel-selector) [ **tunnel-selector** *tunnel-selector-name* ]
       
       
       
       The device is allowed to recurse the received routes that carry a redirection next hop IP address to tunnels.
    5. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
12. (Optional) Allow the device to recurse received routes with the next-hop IPv6 address, color attribute, and prefix SID attributes to tunnels.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**bgp**](cmdqueryname=bgp) *as-number*
       
       
       
       The BGP view is displayed.
    3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
       
       
       
       The BGP-Flow address family view is displayed.
    4. Run [**redirect tunnelv6 tunnel-selector**](cmdqueryname=redirect+tunnelv6+tunnel-selector) *tunnel-selector-name*
       
       
       
       The device is allowed to recurse received routes with the next-hop IPv6 address, color, and prefix SID attributes to tunnels.
       
       
       
       ![](../../../../public_sys-resources/note_3.0-en-us.png) 
       
       To trigger route recursion to SRv6 TE Policies, you must run both the [**redirect tunnelv6 tunnel-selector**](cmdqueryname=redirect+tunnelv6+tunnel-selector) *tunnel-selector-name* command and the [**peer**](cmdqueryname=peer+redirect+tunnelv6) *ipv4-address* **redirect tunnelv6** command.
    5. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
13. (Optional) Configure the device to validate the redirection next-hop IPv6 address attribute carried in the routes that are received from an EBGP peer.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**bgp**](cmdqueryname=bgp) *as-number*
       
       
       
       The BGP view is displayed.
    3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
       
       
       
       The BGP-Flow address family view is displayed.
    4. Run [**peer**](cmdqueryname=peer+redirect+ipv6+validation) *ipv4-address* **redirect ipv6 validation**
       
       
       
       The device is configured to validate the redirection next-hop IPv6 address attribute carried in the routes that are received from an EBGP peer.
    5. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
14. (Optional) Configure BGP Flow Specification for the packets leaving the public network based on IP information.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**flowspec match-ip-layer mpls-pop**](cmdqueryname=flowspec+match-ip-layer+mpls-pop)
       
       
       
       BGP Flow Specification is configured for the packets leaving the public network based on IP information.
    3. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
15. (Optional) Enable CAR statistics collection and packet loss statistics collection for BGP Flow Specification.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**flowspec statistic enable**](cmdqueryname=flowspec+statistic+enable)
       
       
       
       CAR statistics collection and packet loss statistics collection for BGP Flow Specification are enabled.
    3. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
16. (Optional) Configure BGP Flow Specification for packets entering an IPv4 VXLAN tunnel.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**flowspec match vxlan-packet enable**](cmdqueryname=flowspec+match+vxlan-packet+enable)
       
       
       
       BGP Flow Specification is configured for packets entering an IPv4 VXLAN tunnel.
    3. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
17. (Optional) Enable BGP Flow Specification on a GRE tunnel interface.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**interface tunnel**](cmdqueryname=interface+tunnel) *interface-number*
       
       
       
       The tunnel interface view is displayed.
    3. Run [**tunnel-protocol**](cmdqueryname=tunnel-protocol+gre) **gre**
       
       
       
       The tunnel is encapsulated as a GRE tunnel.
    4. Run [**flowspec match tunnel-pop**](cmdqueryname=flowspec+match+tunnel-pop)
       
       
       
       BGP Flow Specification is enabled on the GRE tunnel interface.
    5. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
18. (Optional) Disable BGP Flow Specification protection.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**flowspec protocol-protect**](cmdqueryname=flowspec+protocol-protect+ipv4+ipv6+disable) { **ipv4** | **ipv6** } **disable**
       
       
       
       BGP Flow Specification protection is disabled.
    3. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
19. (Optional) Enable the device to follow RFC 5575 when dealing with BGP Flow Specification IPv4 fragmentation rules.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**flowspec ipv4-fragment-rule switch**](cmdqueryname=flowspec+ipv4-fragment-rule+switch)
       
       
       
       The device is enabled to follow RFC 5575 when dealing with BGP Flow Specification IPv4 fragmentation rules.
    3. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
20. (Optional) Enable the route policy distribution (RPD) capability for a BGP peer to support the BGP Flow Specification routes carrying the RPD attribute and delivered by the controller to forwarders.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**bgp**](cmdqueryname=bgp) *as-number*
       
       
       
       The BGP view is displayed.
    3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
       
       
       
       The BGP-Flow address family view is displayed.
    4. Run **peer** *peerIPv4Addr* **capability-advertise** **route-policy-distribute** **receive**
       
       
       
       The RPD capability is enabled for the BGP peer.
    5. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
21. (Optional) Enable BGP Flow Specification to match inner packet information about the packets that leave an SRv6 TE Policy or SRv6 BE egress.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**flowspec match srv6-inner-ip enable**](cmdqueryname=flowspec+match+srv6-inner-ip+enable)
       
       
       
       BGP Flow Specification is enabled to match inner packet information about the packets that leave an SRv6 TE Policy or SRv6 BE egress.
    3. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
22. (Optional) Disable the device from sending routes that carry the destination community attribute rule to a specified peer.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**bgp**](cmdqueryname=bgp) *as-number*
       
       
       
       The BGP view is displayed.
    3. Run [**ipv4-family flow**](cmdqueryname=ipv4-family+flow)
       
       
       
       The BGP-Flow address family view is displayed.
    4. Run **[**peer**](cmdqueryname=peer+advertise+destination-community+disable)** *peerIPv4Addr* [**advertise destination-community disable**](cmdqueryname=peer+advertise+destination-community+disable)
       
       
       
       The device is disabled from sending routes that carry the destination community attribute rule to a specified peer. Perform this step if you do not want the device to send routes that carry the destination community attribute rule to a specified BGP Flow Specification peer.
    5. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.
23. (Optional) Enable BGP Flow Specification to match an IPv4 destination community attribute-based traffic filtering rule.
    1. Run [**system-view**](cmdqueryname=system-view)
       
       
       
       The system view is displayed.
    2. Run [**flowspec match-rule enhance enable**](cmdqueryname=flowspec+match-rule+enhance+enable)
       
       
       
       BGP Flow Specification is enabled to match an IPv4 destination community attribute-based traffic filtering rule.
    3. Run [**commit**](cmdqueryname=commit)
       
       
       
       The configuration is committed.

#### Verifying the Configuration

After the configuration is complete, verify the configuration.

* Run the [**display bgp flow peer**](cmdqueryname=display+bgp+flow+peer+verbose) [ [ *ipv4-address* ] **verbose** ] command to check information about BGP Flow Specification peers.
* Run the [**display bgp flow routing-table**](cmdqueryname=display+bgp+flow+routing-table) command to check BGP Flow Specification routing information.
* Run the [**display bgp flow routing-table**](cmdqueryname=display+bgp+flow+routing-table+peer+advertised-routes) [ **peer** *ipv4-address* ] [ **advertised-routes** | **received-routes** [ **active** ] ] [**statistics**](cmdqueryname=statistics) command to check BGP Flow Specification route statistics.
* Run the [**display flowspec statistics**](cmdqueryname=display+flowspec+statistics) *reindex* command to check statistics about traffic transmitted over BGP Flow Specification routes.
* Run the [**display flowspec**](cmdqueryname=display+flowspec+rule+slot) **rule** *reindex-value* **slot** *slot-id* command to check information about combined rules in the local BGP Flow Specification rule table.
* Run the [**display flowspec**](cmdqueryname=display+flowspec+rule+statistics+slot) **rule statistics slot** *slot-id* command to check statistics about the rules for BGP Flow Specification routes to take effect.
* Run the [**display flowspec resource rule**](cmdqueryname=display+flowspec+resource+rule+ipv4+ipv6+slot) { **ipv4** | **ipv6** } [ **slot** *slot-id* ] command to check the resource usage information about BGP Flow Specification route rules.