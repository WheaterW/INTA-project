Example for Configuring Dynamic BGP Flow Specification with a BGP RR
====================================================================

Deploying BGP flow specification with a BGP RR can reduce the number of BGP flow specification peer connections.

#### Networking Requirements

BGP flow specification can be configured to defend against DoS/DDoS attacks. Generally, the characteristics of such attack traffic are unknown. Therefore, dynamic BGP flow specification needs to be deployed on a traffic analysis server. In an AS with multiple ingresses, a flow route reflector (Flow RR) can be configured to avoid unnecessary mesh connections between the ingresses and the traffic analysis server. The ingresses and the traffic analysis server function as clients, and the Flow RR reflects the BGP flow specification routes generated by the traffic analysis server to the ingresses.

On the network shown in [Figure 1](#EN-US_TASK_0172372363__fig_dc_vrp_flowspec_cfg_001301), AS 100 can communicate with other ASs through boundary devices DeviceA and DeviceB. If DoS/DDoS attack traffic enters AS 100 through DeviceA and DeviceB, it causes impacts such as congestion in AS 100. In this case, you can deploy BGP flow specification (dynamic BGP flow specification is used in this example) to eliminate the impact. In addition, to reduce resource consumption of the server and the number of BGP flow specification peer relationships maintained by the server, configure a Flow RR in AS 100. The Flow RR is used to reflect the BGP flow specification routes generated by the server to DeviceA and DeviceB for them to control attack traffic.

**Figure 1** Configuring BGP flow specification with a Flow RR![](../../../../public_sys-resources/note_3.0-en-us.png) 

In this example, interface1, interface2, and interface3 represent GE0/1/0, GE0/2/0, and GE0/3/0, respectively.


  
![](images/fig_dc_vrp_flowspec_cfg_001301.png)

#### Configuration Roadmap

The configuration roadmap is as follows:

1. Establish OSPF connections between the Flow RR and DeviceA, between the Flow RR and DeviceB, and between the Flow RR and the server for interworking.
2. Establish BGP flow specification peer relationships between the Flow RR and DeviceA, between the Flow RR and DeviceB, and between the Flow RR and the server.
   
   ![](../../../../public_sys-resources/note_3.0-en-us.png) 
   
   The traffic analysis server is a third-party device and must be able to establish BGP flow specification peer relationships.
3. Configure the Flow RR function on the Flow RR and specify DeviceA, DeviceB, and the server as clients so that the Flow RR can reflect the BGP flow specification routes generated by the server to DeviceA and DeviceB.

#### Data Preparation

To complete the configuration, you need the following data:

* Router IDs of DeviceA, DeviceB, and Flow RR: 1.1.1.1, 2.2.2.2, and 3.3.3.3
* Number of the AS where DeviceA, DeviceB, Flow RR, and the server reside: 100
* ID of the cluster to which the Flow RR belongs: 1


#### Procedure

1. Configure IP addresses for interfaces.
   
   
   
   For detailed configurations, see Configuration Files.
2. Configure OSPF.
   
   
   
   For detailed configurations, see Configuration Files.
3. Establish BGP flow specification peer relationships.
   
   
   
   # Configure DeviceA.
   
   ```
   [~DeviceA] bgp 100
   ```
   ```
   [*DeviceA-bgp] router-id 1.1.1.1
   ```
   ```
   [*DeviceA-bgp] peer 3.3.3.3 as-number 100
   ```
   ```
   [*DeviceA-bgp] peer 3.3.3.3 connect-interface LoopBack1
   ```
   ```
   [*DeviceA-bgp] ipv4-family flow
   ```
   ```
   [*DeviceA-bgp-af-ipv4-flow] peer 3.3.3.3 enable
   ```
   ```
   [*DeviceA-bgp-af-ipv4-flow] commit
   ```
   ```
   [~DeviceA-bgp-af-ipv4-flow] quit
   ```
   ```
   [~DeviceA-bgp] quit
   ```
   
   # Configure DeviceB.
   
   ```
   [~DeviceB] bgp 100
   ```
   ```
   [*DeviceB-bgp] router-id 2.2.2.2
   ```
   ```
   [*DeviceB-bgp] peer 3.3.3.3 as-number 100
   ```
   ```
   [*DeviceB-bgp] peer 3.3.3.3 connect-interface LoopBack1
   ```
   ```
   [*DeviceB-bgp] ipv4-family flow
   ```
   ```
   [*DeviceB-bgp-af-ipv4-flow] peer 3.3.3.3 enable
   ```
   ```
   [*DeviceB-bgp-af-ipv4-flow] commit
   ```
   ```
   [~DeviceB-bgp-af-ipv4-flow] quit
   ```
   ```
   [~DeviceB-bgp] quit
   ```
   
   # Configure the Flow RR.
   
   ```
   [~Flow RR] bgp 100
   ```
   ```
   [*Flow RR-bgp] router-id 3.3.3.3
   ```
   ```
   [*Flow RR-bgp] peer 1.1.1.1 as-number 100
   ```
   ```
   [*Flow RR-bgp] peer 1.1.1.1 connect-interface LoopBack1
   ```
   ```
   [*Flow RR-bgp] peer 2.2.2.2 as-number 100
   ```
   ```
   [*Flow RR-bgp] peer 2.2.2.2 connect-interface LoopBack1
   ```
   ```
   [*Flow RR-bgp] peer 10.2.1.2 as-number 100
   ```
   ```
   [*Flow RR-bgp] ipv4-family flow
   ```
   ```
   [*Flow RR-bgp-af-ipv4-flow] peer 1.1.1.1 enable
   ```
   ```
   [*Flow RR-bgp-af-ipv4-flow] peer 2.2.2.2 enable
   ```
   ```
   [*Flow RR-bgp-af-ipv4-flow] peer 10.2.1.2 enable
   ```
   ```
   [*Flow RR-bgp-af-ipv4-flow] peer 10.2.1.2 validation-disable
   ```
   ```
   [*Flow RR-bgp-af-ipv4-flow] commit
   ```
   ```
   [~Flow RR-bgp-af-ipv4-flow] quit
   ```
   ```
   [~Flow RR-bgp] quit
   ```
4. Configure the Flow RR.
   
   
   
   # Configure the Flow RR.
   
   ```
   [Flow RR]bgp 100
   ```
   ```
   [Flow RR-bgp] ipv4-family flow
   ```
   ```
   [Flow RR-bgp-af-ipv4-flow] reflector cluster-id 1
   ```
   ```
   [Flow RR-bgp-af-ipv4-flow] peer 1.1.1.1 reflect-client
   ```
   ```
   [Flow RR-bgp-af-ipv4-flow] peer 2.2.2.2 reflect-client
   ```
   ```
   [Flow RR-bgp-af-ipv4-flow] peer 10.2.1.2 reflect-client
   ```
   ```
   [Flow RR-bgp-af-ipv4-flow] commit
   ```
   ```
   [Flow RR-bgp-af-ipv4-flow] quit
   ```
   ```
   [Flow RR-bgp] quit
   ```
5. Verify the configuration.
   
   
   
   # Check information about the BGP flow specification route received by DeviceA.
   
   ```
   <DeviceA> display bgp flow routing-table
   ```
   ```
    BGP Local router ID is 1.1.1.1
    Status codes: * - valid, > - best, d - damped, x - best external, a - add path,
                  h - history,  i - internal, s - suppressed, S - Stale
                  Origin : i - IGP, e - EGP, ? - incomplete
    RPKI validation codes: V - valid, I - invalid, N - not-found
   
    Total Number of Routes: 1
   
    * >  ReIndex : 33
         Dissemination Rules:
          Port           : eq 100
          FragmentType   : match (Don't fragment)
   
          MED      : 0                   PrefVal  : 0
          LocalPref: 100
          Path/Ogn :  i
   ```
   
   # Check the traffic filtering rule carried in each BGP flow specification route based on the corresponding **ReIndex** shown in the preceding command output.
   
   ```
   <DeviceA> display bgp flow routing-table 33
   ```
   ```
    BGP local router ID : 1.1.1.1
    Local AS number : 100
    Paths:   1 available, 1 best
    ReIndex : 33
    Order   : 2147483647
    Dissemination Rules :
      Port           : eq 100
      FragmentType   : match (Don't fragment)
   
    BGP flow-ipv4 routing table entry information of 33:
    Match action :
      apply traffic-rate 9600 KBps
    From: 3.3.3.3 (3.3.3.3)
    Route Duration: 0d00h16m31s
    AS-path Nil, origin igp, MED 0, localpref 100, pref-val 0, valid, internal, best, pre 255
    Originator: 10.2.1.2
    Cluster list: 0.0.0.1
    Not advertised to any peer yet
   ```
   
   The command output shows that DeviceA has learned the route advertised by the server from the Flow RR. The Originator and Cluster\_ID attributes of the route are also displayed.

#### Configuration Files

* DeviceA configuration file
  
  ```
  #
  sysname DeviceA
  #
  interface GigabitEthernet0/1/0
   undo shutdown
   ip address 10.3.1.2 255.255.255.0
  #
  interface LoopBack1
   ip address 1.1.1.1 255.255.255.255
  #
  bgp 100
   router-id 1.1.1.1
   peer 3.3.3.3 as-number 100
   peer 3.3.3.3 connect-interface LoopBack1
   ipv4-family unicast
    undo synchronization 
    peer 3.3.3.3 enable
   ipv4-family flow
    peer 3.3.3.3 enable
  #
  ospf 1
   area 0.0.0.0
    network 1.1.1.1 0.0.0.0
    network 10.3.1.0 0.0.0.255
  #
  return
  ```
* DeviceB configuration file
  
  ```
  #
  sysname DeviceB
  #
  interface GigabitEthernet0/1/0
   undo shutdown
   ip address 10.1.1.2 255.255.255.0
  #
  interface LoopBack1
   ip address 2.2.2.2 255.255.255.255
  #
  bgp 100
   router-id 2.2.2.2
   peer 3.3.3.3 as-number 100
   peer 3.3.3.3 connect-interface LoopBack1
   #
   ipv4-family unicast
    undo synchronization 
    peer 3.3.3.3 enable
   #
   ipv4-family flow
    peer 3.3.3.3 enable
  #
  ospf 1
   area 0.0.0.0
    network 2.2.2.2 0.0.0.0
    network 10.1.1.0 0.0.0.255
  #
  return
  ```
* Flow RR configuration file
  
  ```
  #
  sysname Flow RR
  #
  interface GigabitEthernet0/1/0
   undo shutdown
   ip address 10.3.1.1 255.255.255.0
  #
  interface GigabitEthernet0/2/0
   undo shutdown
   ip address 10.2.1.1 255.255.255.0
  #
  interface GigabitEthernet0/3/0
   undo shutdown
   ip address 10.1.1.1 255.255.255.0
  #
  interface LoopBack1
   ip address 3.3.3.3 255.255.255.255
  #
  bgp 100
   router-id 3.3.3.3
   peer 1.1.1.1 as-number 100
   peer 1.1.1.1 connect-interface LoopBack1
   peer 2.2.2.2 as-number 100
   peer 2.2.2.2 connect-interface LoopBack1
   peer 10.2.1.2 as-number 100
   #
   ipv4-family unicast
    undo synchronization 
    peer 1.1.1.1 enable
    peer 2.2.2.2 enable
    peer 10.2.1.2 enable
   #
   ipv4-family flow
    reflector cluster-id 1
    peer 1.1.1.1 enable
    peer 1.1.1.1 reflect-client
    peer 2.2.2.2 enable
    peer 2.2.2.2 reflect-client
    peer 10.2.1.2 enable
    peer 10.2.1.2 reflect-client
    peer 10.2.1.2 validation-disable
  #
  ospf 1
   area 0.0.0.0
    network 3.3.3.3 0.0.0.0
    network 10.1.1.0 0.0.0.255
    network 10.2.1.0 0.0.0.255
    network 10.3.1.0 0.0.0.255
  #
  return
  ```
* Server configuration file
  
  ```
  #
  sysname Server
  #
  interface GigabitEthernet0/1/0
   undo shutdown
   ip address 10.2.1.2 255.255.255.0
  #
  interface LoopBack1
   ip address 4.4.4.4 255.255.255.255
  #
  bgp 100
   router-id 4.4.4.4
   peer 3.3.3.3 as-number 100
   ipv4-family unicast
    undo synchronization 
    peer 3.3.3.3 enable
   ipv4-family flow
    peer 3.3.3.3 enable
  #
  ospf 1
   area 0.0.0.0
    network 4.4.4.4 0.0.0.0
    network 10.2.1.0 0.0.0.255
  #
  return
  ```