
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Configuring MAC Duplication Suppression for EVPN">
<meta name="abstract" content="If PEs communicate through both network-side and access-side links in an EVPN scenario, MAC routes may flap. To resolve this issue, configure MAC duplication suppression.">
<meta name="description" content="If PEs communicate through both network-side and access-side links in an EVPN scenario, MAC routes may flap. To resolve this issue, configure MAC duplication suppression.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0000.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0009.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0091.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="p00915595,w00800033,w00556928,l00468467,w00606909,evpnvrp,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="p00915595">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00878323">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172370511">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Configuring MAC Duplication Suppression for EVPN</title>
</head>
<body><a name="EN-US_TASK_0172370511"></a><a name="EN-US_TASK_0172370511"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Configuring MAC Duplication Suppression for EVPN</h1>
<div class="taskbody"><p>If PEs communicate through both network-side and access-side links in an EVPN scenario, MAC routes may flap. To resolve this issue, configure MAC duplication suppression.</p>
<div class="context"><a name="EN-US_TASK_0172370511__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Usage Scenario</h4><p>On the EVPN E-LAN shown in <a href="#EN-US_TASK_0172370511__fig42411312194317">Figure 1</a>, the two PEs may be interconnected through both network-side and access-side links. If this is the case, a BUM traffic loop and MAC route flapping both occur, preventing devices from working properly. By default, MAC duplication suppression is enabled on a device. Also by default, the system checks the number of times a MAC entry flaps within a detection period. If the number of MAC flaps exceeds the upper threshold, the system considers MAC route flapping to be occurring on the network and consequently suppresses the flapping MAC routes. The suppressed MAC routes cannot be sent to a remote PE through a BGP EVPN peer relationship.</p>
<div class="fignone" id="EN-US_TASK_0172370511__fig42411312194317"><a name="EN-US_TASK_0172370511__fig42411312194317"></a><a name="fig42411312194317"></a><span class="figcap"><b>Figure 1 </b>MAC duplication suppression for a VPN</span><br><span><img class="vsd" src="figure/en-us_image_0000001193700090.png" width="NaN" height="NaN"></span></div>
<p>By default, EVPN MAC duplication suppression is enabled. In the scenario shown in the <a href="#EN-US_TASK_0172370511__fig18835536205217">figure</a>, you need to disable EVPN MAC duplication suppression on SLeaf nodes.</p>
<div class="fignone" id="EN-US_TASK_0172370511__fig18835536205217"><a name="EN-US_TASK_0172370511__fig18835536205217"></a><a name="fig18835536205217"></a><span class="figcap"><b>Figure 2 </b>MAC duplication suppression for a VPN</span><br><span><img class="vsd" src="figure/en-us_image_0000001281726621.png" width="NaN" height="NaN"></span></div>
<p>If you want to modify parameter configurations related to MAC duplication suppression, perform the following procedure.</p>
</div></div>
<div class="context"><a name="EN-US_TASK_0172370511__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Pre-configuration Tasks</h4><p>Before configuring MAC duplication suppression for EVPN, complete the following tasks:</p>
<ul><li>Deploy <a href="dc_vrp_srv6_cfg_all_0023_copy.html">EVPN VPLS over IS-IS SRv6 BE</a>, <a href="dc_vrp_evpn_cfg_0065.html">BD EVPN functions</a>, <a href="dc_vrp_evpn_cfg_0003.html">basic EVPN functions</a>,  or <a href="dc_vrp_cfg_evpn-vpls_over_srv6-te_policy_copy.html">EVPN VPLS over SRv6 TE Policy</a> on the network.</li></ul>
</div></div>
<div class="steps-unordered"><a name="EN-US_TASK_0172370511__1.4.3"></a><a name="1.4.3"></a><h4 class="sectiontitle">Procedure</h4>
<ul><li><span>Configure MAC duplication suppression for all EVPN instances.</span><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=evpn"><b><span class="cmdname">evpn</span></b></a></span><p><p>The EVPN global configuration view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=mac-duplication"><b><span class="cmdname">mac-duplication</span></b></a></span><p><p>The EVPN-mac-dup view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=detect+loop-times"><b><span class="cmdname">detect loop-times</span></b></a> <i><span class="varname">loop-times</span></i> <strong><span>detect-cycle</span></strong> <i><span class="varname">detect-cycle-time</span></i></span><p><p>Loop detection parameters for MAC duplication suppression are configured, including the detection period and the threshold for the number of MAC entry flaps within a detection period. The default detection period is 180s, and the default threshold is 5.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=retry-cycle"><b><span class="cmdname">retry-cycle</span></b></a> <i><span class="varname">retry-times</span></i></span><p><p>A timer for stopping MAC duplication suppression is configured.</p>
</p></li><li class="substepexpand"><span>(Optional) Perform the following steps to disable MAC duplication suppression globally (as shown in <a href="#EN-US_TASK_0172370511__fig18835536205217">Figure2 MAC duplication ...</a>):</span><p><ol type="a"><li>Run <a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a><p>Return to the EVPN global configuration view.</p>
</li><li>Run <a href="cmdqueryname=undo+mac-duplication"><b><span class="cmdname">undo mac-duplication</span></b></a><p>MAC duplication suppression is disabled globally.</p>
</li></ol>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li><li><span>Configure MAC duplication suppression for a specified EVPN instance.</span><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run either of the following commands to enter the EVPN instance view or BD EVPN instance view:</span><p><ul><li><p><a href="cmdqueryname=evpn+vpn-instance"><b><span class="cmdname">evpn vpn-instance</span></b></a> <i><span class="varname">vpn-instance-name</span></i></p>
</li><li><p><a href="cmdqueryname=evpn+vpn-instance"><b><span class="cmdname">evpn vpn-instance</span></b></a> <em>vpn-instance-name</em> <strong><span>bd-mode</span></strong></p>
</li></ul>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=mac-duplication"><b><span class="cmdname">mac-duplication</span></b></a></span><p><p>The EVPN-MAC-dup view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=detect+loop-times"><b><span class="cmdname">detect loop-times</span></b></a> <i><span class="varname">loop-times</span></i> <strong><span>detect-cycle</span></strong> <i><span class="varname">detect-cycle-time</span></i></span><p><p>Loop detection parameters for MAC duplication suppression are configured, including the detection period and the threshold for the number of MAC entry flaps within a detection period.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=retry-cycle"><b><span class="cmdname">retry-cycle</span></b></a> <i><span class="varname">retry-times</span></i></span><p><p>A timer for stopping MAC duplication suppression is configured.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=black-hole-dup-mac"><b><span class="cmdname">black-hole-dup-mac</span></b></a> [ <strong><span>block-source-interface</span></strong> ]</span><p><p>The flapping MAC routes are set to blackhole MAC routes. If the source or destination MAC address of the forwarded traffic is the same as the MAC address of the blackhole MAC route, the traffic is discarded.</p>
</p><p><p>The <strong><span>block-source-interface</span></strong> parameter enables AC interface blocking. This means that, if the traffic comes from a local AC interface and the source MAC address of the traffic is the same as the MAC address of a blackhole MAC route, the AC interface is blocked. In this way, a loop can be removed quickly. Only BD EVPN instances support AC interface blocking.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Only BD EVPN instances support AC interface blocking.</p>
<p>To enable AC interface blocking, first <a href="dc_vrp_mflp_cfg_0400.html">enable MAC flapping loop detection</a> in the BD.</p>
</div></div>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=filter-policy"><b><span class="cmdname">filter-policy</span></b></a> { <i><span class="varname">acl-number</span></i> | <strong><span>acl-name</span></strong> <i><span class="varname">acl-name-value</span></i> }</span><p><p>The device is configured to filter received MAC routes. MAC duplication suppression is not performed on MAC addresses that match a specified ACL rule.</p>
</p><p><p>If MAC duplication suppression is configured, to prevent the specified MAC address from being affected, perform this step to add the specified MAC address to the whitelist using an ACL rule.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Before performing this step, configure the ACL rule first.</p>
<p>If the <strong>rule</strong> command is used to configure a filtering rule for a named ACL, only the source address range specified by <strong>source</strong> and time period specified by <strong>time-range</strong> take effect.</p>
</div></div>
</p></li><li class="substepexpand"><span>(Optional) To disable MAC duplication suppression for the current EVPN instance (as shown in <a href="#EN-US_TASK_0172370511__fig18835536205217">Figure 2</a>), perform the following steps:</span><p><ol type="a"><li>Run the <a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a> command to return to the EVPN instance or BD EVPN instance view.</li><li>Run the <a href="cmdqueryname=mac-duplication+disable"><b><span class="cmdname">mac-duplication disable</span></b></a> command to disable MAC duplication suppression for the current EVPN instance.</li></ol>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li></ul></div>
<div class="postreq"><a name="EN-US_TASK_0172370511__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Follow-up Procedure</h4><p>When a MAC route to a specific MAC address or MAC routes in a specific BD have stopped flapping and you want to restore them before the configured hold-off timer expires, run the <a href="cmdqueryname=reset+evpn+vpn-instance"><b><span class="cmdname">reset evpn vpn-instance</span></b></a> <i><span class="varname">vpn-instance-name</span></i> <strong><span>mac-duplication</span></strong> [ <strong><span>bridge-domain</span></strong> <i><span class="varname">bd-id</span></i> ] [ <strong><span>mac-address</span></strong> <i><span class="varname">mac-address</span></i> ] command in the user view. This allows you to manually clear the suppression state of the MAC routes.</p>
<p>Under certain conditions, a MAC route is unsuppressed automatically. For this to take place, a static MAC address must be configured or an EVPN instance must receive a MAC address that carries the static flag. The MAC address must be the same as that of the suppressed MAC route.</p>
<h4 class="sectiontitle">Verifying the Configuration</h4><ul><li>Run the <a href="cmdqueryname=display+evpn+vpn-instance"><b><span class="cmdname">display evpn vpn-instance</span></b></a> <strong><span>name</span></strong> <i><span class="varname">vpn-instance-name</span></i> <strong><span>mac-duplication</span></strong> [ <strong><span>bridge-domain</span></strong> <i><span class="varname">bd-id</span></i> ] [ <strong><span>mac-address</span></strong> <i><span class="varname">mac-address</span></i> ] command to check information about MAC duplication suppression, including the involved parameters and information about the suppressed MAC routes.</li><li>Run the <a href="cmdqueryname=display+evpn+vpn-instance"><b><span class="cmdname">display evpn vpn-instance</span></b></a> <strong><span>name</span></strong> <i><span class="varname">vpn-instance-name</span></i> <strong><span>mac-duplication</span></strong> <a href="cmdqueryname=history"><b><span class="cmdname">history</span></b></a> command to check the historical records of MAC route duplication.</li></ul>
</div></div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0000.html">EVPN Configuration
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0009.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0091.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>