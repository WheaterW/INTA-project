
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring BGP4+ AS Number Substitution">
<meta name="abstract" content="If the AS numbers of different sites in a VPN are the same and EBGP peer relationships are set up between PEs and CEs, AS number substitution needs to be enabled on PEs. Otherwise, CEs will discard the VPN routes that carry the same AS information as their local AS information. As a result, users of the same VPN cannot communicate with each other.">
<meta name="description" content="If the AS numbers of different sites in a VPN are the same and EBGP peer relationships are set up between PEs and CEs, AS number substitution needs to be enabled on PEs. Otherwise, CEs will discard the VPN routes that carry the same AS information as their local AS information. As a result, users of the same VPN cannot communicate with each other.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v6_cfg_2039.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v6_cfg_2080.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v6_cfg_2042.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,l3vpnvrp,w00556928,w00606909,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="BGP/MPLS IPv6 VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="BGP/MPLS IPv6 VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IPv6 VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IPv6 VPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="h00847023">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="h00847023">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172369705">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring BGP4+ AS Number Substitution</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172369705"></a><a name="EN-US_TASK_0172369705"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring BGP4+ AS Number Substitution</h1>
<div class="taskbody"><p>If the AS numbers of different sites in a VPN are the same and EBGP peer relationships are set up between PEs and CEs, AS number substitution needs to be enabled on PEs. Otherwise, CEs will discard the VPN routes that carry the same AS information as their local AS information. As a result, users of the same VPN cannot communicate with each other.</p>
<div class="context"><a name="EN-US_TASK_0172369705__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>If different IPv6 VPN sites have the same AS number, and EBGP connections are established between PEs and CEs, you need to enable BGP4+ AS number substitution on the PEs that the VPN sites access.</p>
<p>On the network shown in <a href="#EN-US_TASK_0172369705__fig_dc_vrp_mpls-l3vpn-v6_cfg_204101">Figure 1</a>, the AS numbers of CE1 and CE2 are both 65410; EBGP is used to exchange routes between PE1 and CE1, and between PE2 and CE2.</p>
<p>The AS number 65410 is contained in the AS_Path attribute of the BGP routes learned by PE1 from CE1. PE2 learns BGP routes from PE1 and checks the AS_Path attribute of the routes before using EBGP to send them to CE2. Finding that the AS number 65410 in the AS_Path attribute of the routes is the same as the AS number of CE2, PE2 does not send the routes to CE2. As a result, CE1 and CE2 cannot communicate with each other.</p>
<p>If BGP4+ AS number substitution is configured, PE2 will replace the AS number (65410) in the AS_Path attribute of VPN routes with its own AS number (100). In this manner, the routes can pass the AS number check provided by BGP and reach CE2, and the two VPN sites can then access each other.</p>
<div class="fignone" id="EN-US_TASK_0172369705__fig_dc_vrp_mpls-l3vpn-v6_cfg_204101"><a name="EN-US_TASK_0172369705__fig_dc_vrp_mpls-l3vpn-v6_cfg_204101"></a><a name="fig_dc_vrp_mpls-l3vpn-v6_cfg_204101"></a><span class="figcap"><b>Figure 1 </b>Configuring BGP4+ AS number substitution</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 and 2 in this example represent GE<span>0/1/0</span> and GE<span>0/2/0</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="images/fig_dc_vrp_mpls-l3vpn-v6_cfg_204101.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369705__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure a basic BGP/MPLS IPv6 VPN.</p>
</li><li><p>Configure EBGP on CEs and PEs to exchange VPN routing information.</p>
</li><li><p>Configure BGP4+ AS number substitution on PEs.</p>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172369705__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li><p>MPLS LSR IDs of PEs and the P</p>
</li><li><p>VPN instances configured on PE1 and PE2</p>
</li><li><p>Same AS number of CE1 and CE2 (which differs from the AS number of the backbone network)</p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172369705__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure a basic BGP/MPLS IPv6 VPN.</span><p><p>For configuration details, see <a href="dc_vrp_mpls-l3vpn-v6_cfg_2040.html">Example for Configuring Basic BGP/MPLS IPv6 VPN</a>. The main configurations are listed as follows:</p>
<ul><li><p>Configure OSPF on the MPLS backbone network so that the PEs can learn the routes to each other's loopback interface.</p>
</li><li><p>Configure MPLS and MPLS LDP both globally and per interface on each node of the MPLS backbone network and establish LDP LSPs between PEs.</p>
</li><li><p>Establish a VPNv6 peer relationship between the PEs.</p>
</li><li><p>Configure an IPv6-address-family-supporting VPN instance on each PE and bind the interface that connects a PE to a CE to the VPN instance on that PE.</p>
</li><li><p>Configure BGP on CEs and PEs to exchange routing information.</p>
</li></ul>
<p>After completing the configurations, run the <strong>display ipv6 routing-table</strong> command on CE2. The command output shows that CE2 has learned a route to the network segment 2001:db8:1::1/64 where the interface that connects CE1 to PE1 resides, but CE2 does not have a route to 2001:db8:8::1/64, the loopback interface of CE1. CE1 is in a similar situation.</p>
<pre class="screen">&lt;CE2&gt;<strong> display ipv6 routing-table</strong></pre>
<pre class="screen">Routing Table : _public_
         Destinations : 9        Routes : 9

 Destination  : ::1                             PrefixLength : 128
 NextHop      : ::1                             Preference   : 0
 Cost         : 0                               Protocol     : Direct
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : InLoopBack0                     Flags        : D

 Destination  : ::FFFF:127.0.0.0                PrefixLength : 104
 NextHop      : ::FFFF:127.0.0.1                Preference   : 0
 Cost         : 0                               Protocol     : Direct
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : InLoopBack0                     Flags        : D
 
 Destination  : ::FFFF:127.0.0.1                PrefixLength : 128
 NextHop      : ::1                             Preference   : 0
 Cost         : 0                               Protocol     : Direct
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : InLoopBack0                     Flags        : D 

 Destination  : 2001:db8:9::                    PrefixLength : 64
 NextHop      : 2001:db8:9::1                   Preference   : 0
 Cost         : 0                               Protocol     : Direct
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : LoopBack1                       Flags        : D

 Destination  : 2001:db8:9::1                   PrefixLength : 128
 NextHop      : ::1                             Preference   : 0
 Cost         : 0                               Protocol     : Direct
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : LoopBack1                       Flags        : D

 <strong>Destination  : 2001:db8:1::</strong>                  PrefixLength : 64
 NextHop      : 2001:db8:2::2                   Preference   : 255
 Cost         : 0                               Protocol     : EBGP
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : GigabitEthernet<span>0/1/0</span>            Flags        : D

 Destination  : 2001:db8:2::                    PrefixLength : 64
 NextHop      : 2001:db8:2::1                   Preference   : 0
 Cost         : 0                               Protocol     : Direct
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : GigabitEthernet<span>0/1/0</span>          Flags        : D

 Destination  : 2001:db8:2::1                   PrefixLength : 128
 NextHop      : ::1                             Preference   : 0
 Cost         : 0                               Protocol     : Direct
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : GigabitEthernet<span>0/1/0</span>            Flags        : D

 Destination  : FE80::                          PrefixLength : 10
 NextHop      : ::                              Preference   : 0
 Cost         : 0                               Protocol     : Direct
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : NULL0                           Flags        : D </pre>
<p>Run the <strong>display ipv6 routing-table vpn-instance</strong> command on PE2. The command output shows that there is a route to 2001:db8:8::1/64, the loopback address of the remote CE, in the routing table of the VPN instance IPv6 address family.</p>
<pre class="screen">&lt;PE2&gt; <strong>display ipv6 routing-table vpn-instance vpna</strong></pre>
<pre class="screen">Routing Table : vpna
         Destinations : 6        Routes : 6

 <strong>Destination  : 2001:db8:8::</strong>                  PrefixLength : 64
 NextHop      : ::FFFF:1.1.1.9                  Preference   : 255
 Cost         : 0                               Protocol     : IBGP
 RelayNextHop : ::FFFF:192.168.2.1              TunnelID     : 0x800007
 Interface    : GigabitEthernet<span>0/2/0</span>            Flags        : RD

 Destination  : 2001:db8:9::                    PrefixLength : 64
 NextHop      : 2001:db8:2::1                   Preference   : 255
 Cost         : 0                               Protocol     : EBGP
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : GigabitEthernet<span>0/1/0</span>            Flags        : D

 Destination  : 2001:db8:1::                    PrefixLength : 64
 NextHop      : ::FFFF:1.1.1.9                  Preference   : 255
 Cost         : 0                               Protocol     : IBGP
 RelayNextHop : ::FFFF:192.168.2.1              TunnelID     : 0x800007
 Interface    : GigabitEthernet<span>0/2/0</span>            Flags        : RD

 Destination  : 2001:db8:2::                    PrefixLength : 64
 NextHop      : 2001:db8:2::2                   Preference   : 0
 Cost         : 0                               Protocol     : Direct
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : GigabitEthernet<span>0/1/0</span>            Flags        : D

 Destination  : 2001:db8:2::2                   PrefixLength : 128
 NextHop      : ::1                             Preference   : 0
 Cost         : 0                               Protocol     : Direct
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : GigabitEthernet<span>0/1/0</span>            Flags        : D

 Destination  : FE80::                          PrefixLength : 10
 NextHop      : ::                              Preference   : 0
 Cost         : 0                               Protocol     : Direct
 RelayNextHop : ::                              TunnelID     : 0x0
 Interface    : NULL0                           Flags        : D</pre>
<p>Run the <strong>display bgp ipv6 routing-table peer received-routes</strong> command on CE2. The command output shows that CE2 has not received a route with the prefix 2001:db8:8::1/64.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2]<strong> display bgp ipv6 routing-table peer 2001:db8:2::2 received-routes</strong></pre>
<pre class="screen"> BGP Local router ID is 30.30.30.30
 Status codes: * - valid, &gt; - best, d - damped,<span> x - best external,</span><span> a - add path,</span>
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete
<span> RPKI validation codes: V - valid, I - invalid, N - not-found</span>

 Total Number of Routes: 2
 *&gt;  Network  : 2001:db8:1::                             PrefixLen : 64
     NextHop  : 2001:db8:2::2                            LocPrf    :
     MED      :                                          PrefVal   : 0
     Label    :
     Path/Ogn : 100  ?
     Network  : 2001:db8:2::                             PrefixLen : 64
     NextHop  : 2001:db8:2::2                            LocPrf    :
     MED      : 0                                        PrefVal   : 0
     Label    :
     Path/Ogn : 100  ? </pre>
</p></li><li><span>Configure BGP4+ AS number substitution on PEs.</span><p><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2]<strong> bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp]<strong> ipv6-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp6-vpna]<strong> peer 2001:db8:2::1 substitute-as</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp6-vpna]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> commit</strong></pre>
<p>Run the <strong>display bgp ipv6 routing-table peer received-routes</strong> command on CE2 to check the routing information received from the EBGP peer. The command output shows that CE2 has received a route to 2001:db8:8::1/64 from PE2, and the value in the Path/Ogn field is 100 100. It indicates that the AS number has been replaced.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2]<strong> display bgp ipv6 routing-table peer 2001:db8:2::2 received-routes</strong></pre>
<pre class="screen"> BGP Local router ID is 30.30.30.30
 Status codes: * - valid, &gt; - best, d - damped,<span> x - best external,</span><span> a - add path,</span>
               h - history,  i - internal, s - suppressed, S - Stale
               Origin : i - IGP, e - EGP, ? - incomplete
<span> RPKI validation codes: V - valid, I - invalid, N - not-found</span>

 Total Number of Routes: 3
 *&gt;  <strong>Network  : 2001:db8:8::</strong>                           PrefixLen : 64
     NextHop  : 2001:db8:2::2                            LocPrf    :
     MED      :                                          PrefVal   : 0
     Label    :
     <strong>Path/Ogn : 100 100  i</strong>
 *&gt;  Network  : 2001:db8:1::                             PrefixLen : 64
     NextHop  : 2001:db8:2::2                            LocPrf    :
     MED      :                                          PrefVal   : 0
     Label    :
     Path/Ogn : 100  ?
     Network  : 2001:db8:2::                             PrefixLen : 64
     NextHop  : 2001:db8:2::2                            LocPrf    :
     MED      : 0                                        PrefVal   : 0
     Label    :
     Path/Ogn : 100  ?</pre>
<p>After BGP4+ AS number substitution is configured on PE1, the ping (with the source address specified in the <strong>ping</strong> command) between CE1 and CE2 succeeds.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>ping ipv6 -a 2001:db8:9::1 2001:db8:8::1</strong></pre>
<pre class="screen">  PING 2001:db8:8::1 : 56  data bytes, press CTRL_C to break
    Reply from 2001:db8:8::1
    bytes=56 Sequence=1 hop limit=62  time = 140 ms
    Reply from 2001:db8:8::1
    bytes=56 Sequence=2 hop limit=62  time = 140 ms
    Reply from 2001:db8:8::1
    bytes=56 Sequence=3 hop limit=62  time = 150 ms
    Reply from 2001:db8:8::1
    bytes=56 Sequence=4 hop limit=62  time = 170 ms
    Reply from 2001:db8:8::1
    bytes=56 Sequence=5 hop limit=62  time = 140 ms

  --- 2001:db8:8::1 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 140/148/170 ms</pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172369705__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>CE1 configuration file</p>
<pre class="screen">#
sysname CE1
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ipv6 enable
 ipv6 address 2001:db8:1::1 64
#
interface LoopBack1
 ipv6 enable
 ipv6 address 2001:db8:8::1/64
#
bgp 65410
 router-id 10.10.10.10
 peer 2001:db8:1::2 as-number 100
 #
 ipv6-family unicast
  undo synchronization
  import-route direct
  peer 2001:db8:1::2 enable
#
return</pre>
</li><li><p>PE1 configuration file</p>
<pre class="screen">#
sysname PE1
#
ip vpn-instance vpna
 ipv6-family
  route-distinguisher 100:1
  apply-label per-instance
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
mpls lsr-id 1.1.1.9
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ipv6 enable
 ip binding vpn-instance vpna
 ipv6 address 2001:db8:1::2 64
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 20.1.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 1.1.1.9 255.255.255.255
#
bgp 100
 peer 3.3.3.9 as-number 100
 peer 3.3.3.9 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 3.3.3.9 enable
 #
 ipv6-family vpnv6
  policy vpn-target
  peer 3.3.3.9 enable
#
 ipv6-family vpn-instance vpna
  peer 2001:db8:1::1 as-number 65410
  peer 2001:db8:1::1 substitute-as
  import-route direct
#
ospf 1
 area 0.0.0.0
  network 1.1.1.9 0.0.0.0
  network 20.1.1.0 0.0.0.255
#
return</pre>
</li><li><p>P configuration file</p>
<pre class="screen">#
sysname P
#
mpls lsr-id 2.2.2.9
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 20.1.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 30.1.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 2.2.2.9 255.255.255.255
#
ospf 1
 area 0.0.0.0
  network 2.2.2.9 0.0.0.0
  network 20.1.1.0 0.0.0.255
  network 30.1.1.0 0.0.0.255
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
ip vpn-instance vpna
 ipv6-family
  route-distinguisher 100:1
  apply-label per-instance
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
mpls lsr-id 3.3.3.9
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ipv6 enable
 ip binding vpn-instance vpna
 ipv6 address 2001:db8:2::2 64
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 30.1.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 3.3.3.9 255.255.255.255
#
bgp 100
 peer 1.1.1.9 as-number 100
 peer 1.1.1.9 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.9 enable
 #
 ipv6-family vpnv6
  policy vpn-target
  peer 1.1.1.9 enable
#
 ipv6-family vpn-instance vpna
  peer 2001:db8:2::1 as-number 65410
  peer 2001:db8:2::1 substitute-as
  import-route direct
#
ospf 1
 area 0.0.0.0
  network 3.3.3.9 0.0.0.0
  network 30.1.1.0 0.0.0.255
#
return</pre>
</li><li><p>CE2 configuration file</p>
<pre class="screen">#
sysname CE2
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ipv6 enable
 ipv6 address 2001:db8:2::1 64
#
interface LoopBack1
 ipv6 enable
 ipv6 address 2001:db8:9::1/64
#
bgp 65410
 router-id 30.30.30.30
 peer 2001:db8:2::2 as-number 100
 #
 ipv6-family unicast
  undo synchronization
  import-route direct
  peer 2001:db8:2::2 enable
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v6_cfg_2039.html">Configuration Examples for BGP/MPLS IPv6 VPN
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v6_cfg_2080.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v6_cfg_2042.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>