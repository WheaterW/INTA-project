
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring MCE DSVPN over IPsec">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_cfg_dsvpn_0015.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_cfg_dsvpn_0019.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,w00606909">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="DSVPN">
<meta name="featuretype" content="VPN">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="DSVPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="DSVPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="DSVPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="l00415692">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="z00545680">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0000001115219894">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring MCE DSVPN over IPsec</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0000001115219894"></a><a name="EN-US_TASK_0000001115219894"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring MCE DSVPN over IPsec</h1>
<div class="taskbody"><div class="context"><a name="EN-US_TASK_0000001115219894__1.3.1"></a><a name="1.3.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>For security purposes, you are advised not to use weak security algorithms in this feature. If you need to use such an algorithm, run the <a href="cmdqueryname=undo+crypto+weak-algorithm+disable"><b><span class="cmdname">undo crypto weak-algorithm disable</span></b></a> command to enable the weak security algorithm function.</p>
</div></div>
<p>In an enterprise, the HQ hub connects to branch spokes over the public network, and Spoke 1 and Spoke 2 also connect over the public network. Branch spokes connect to the public network through dynamic addresses. Data transmitted between the HQ and branches and between branches needs to be protected through encryption. The HQ hub and branch spokes are located in different areas, and the subnet environments of the HQ and branches change frequently. The enterprise wants to realize VPN communication and service isolation between branches and encrypt data exchanged between the HQ and branches and between branches. To meet this requirement, deploy dynamic routing (OSPF) based on the enterprise network planning and configure MCE DSVPN over IPsec to realize direct communication between Spoke 1 and Spoke 2, data encryption, and service isolation. <a href="#EN-US_TASK_0000001115219894__fig_dc_cfg_dsvpn_001901">Figure 1</a> shows the related networking.</p>
<div class="fignone" id="EN-US_TASK_0000001115219894__fig_dc_cfg_dsvpn_001901"><a name="EN-US_TASK_0000001115219894__fig_dc_cfg_dsvpn_001901"></a><a name="fig_dc_cfg_dsvpn_001901"></a><span class="figcap"><b>Figure 1 </b>Networking diagram for configuring MCE DSVPN over IPsec</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interface 1 in this example represents GE <span>0/1/0</span>.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0000001161779665.png" width="NaN" height="NaN"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001115219894__1.3.2"></a><a name="1.3.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><div class="p">The configuration roadmap is as follows:<ol><li><p>Because branches access the public network through dynamic IP addresses, branches are unaware of the public IP address of each other. Therefore, configure DSVPN to connect branches.</p>
</li><li><p>Because a large number of branches exist, configure DSVPN in shortcut mode.</p>
</li><li><p>Because the subnet environments of the HQ and branches frequently change, deploy OSPF based on enterprise network planning for communication between the HQ and branches to simplify maintenance.</p>
</li><li><p>Because data transmitted between organizations needs to be encrypted, configure DSVPN over IPsec. The authentication algorithms used in the IKE proposal, AH, and ESP are all SHA2-256.</p>
</li><li>Because MCE needs to be deployed for the subnet between the HQ and users to isolate services, plan the binding of different mGRE tunnel interfaces to different VPNs.</li><li>Because the HQ and branches each have only one physical link to the public network, you need to configure mGRE tunnels with the same source.</li></ol>
</div>
</div></div>
<div class="steps"><a name="EN-US_TASK_0000001115219894__1.3.3"></a><a name="1.3.3"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure interface IP addresses.</span><p><p>Configure interface IP addresses on each device.</p>
<p># Configure interface IP addresses on Hub. </p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname Hub</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>interface GigabitEthernet <span>0/1/0</span></strong>
[<span class="keyword">*</span>Hub-GigabitEthernet<span>0/1/0</span>] <strong>ip address 10.1.1.10 255.255.255.0</strong>
[<span class="keyword">*</span>Hub-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>ip vpn-instance vpna</strong>
[<span class="keyword">*</span>Hub-vpn-instance-vpna] <strong>ipv4-family</strong>
[<span class="keyword">*</span>Hub-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 100:1</strong>
[<span class="keyword">*</span>Hub-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong> 
[<span class="keyword">*</span>Hub-vpn-instance-vpna-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>Hub-vpn-instance-vpna] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>ip vpn-instance vpnb</strong>
[<span class="keyword">*</span>Hub-vpn-instance-vpnb] <strong>ipv4-family</strong>
[<span class="keyword">*</span>Hub-vpn-instance-vpnb-af-ipv4] <strong>route-distinguisher 100:2</strong>
[<span class="keyword">*</span>Hub-vpn-instance-vpnb-af-ipv4] <strong>vpn-target 222:2 both</strong> 
[<span class="keyword">*</span>Hub-vpn-instance-vpnb-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>Hub-vpn-instance-vpnb] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>interface tunnel 0</strong>
[<span class="keyword">*</span>Hub-Tunnel0] <strong>ip binding vpn-instance vpna</strong>
[<span class="keyword">*</span>Hub-Tunnel0] <strong>ip address 172.16.1.1 255.255.255.0</strong>
[<span class="keyword">*</span>Hub-Tunnel0] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>interface tunnel 1</strong>
[<span class="keyword">*</span>Hub-Tunnel1] <strong>ip binding vpn-instance vpnb</strong>
[<span class="keyword">*</span>Hub-Tunnel1] <strong>ip address 172.16.1.1 255.255.255.0</strong>
[<span class="keyword">*</span>Hub-Tunnel1] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>interface loopback 0</strong>
[<span class="keyword">*</span>Hub-LoopBack0] <strong>ip binding vpn-instance vpna</strong>
[<span class="keyword">*</span>Hub-LoopBack0] <strong>ip address 192.168.0.1 255.255.255.255</strong>
[<span class="keyword">*</span>Hub-LoopBack0] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>Hub-LoopBack1] <strong>ip binding vpn-instance vpnb</strong>
[<span class="keyword">*</span>Hub-LoopBack1] <strong>ip address 192.168.0.1 255.255.255.255</strong>
[<span class="keyword">*</span>Hub-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>commit</strong></pre>
<p>Assign an IP address to each interface on Spoke 1 and Spoke 2 according to <a href="#EN-US_TASK_0000001115219894__fig_dc_cfg_dsvpn_001901">Figure 1</a>. The configurations of the spokes are similar to the configuration of the hub.</p>
</p></li><li><span>Configure public network routes between devices.</span><p><p>Configure OSPF on each device to ensure that public network routes are available.</p>
<p># Configure OSPF on Hub.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>ospf 1 router-id 10.1.1.10</strong>
[<span class="keyword">*</span>Hub-ospf-1] <strong>area 0.0.0.1</strong>
[<span class="keyword">*</span>Hub-ospf-1-areHub-0.0.0.1] <strong>network 10.1.1.0 0.0.0.255</strong>
[<span class="keyword">*</span>Hub-ospf-1-areHub-0.0.0.1] <strong>quit</strong>
[<span class="keyword">*</span>Hub-ospf-1] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>commit</strong></pre>
<p># Configure OSPF on Spoke 1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke1] <strong>ospf 1 router-id 10.1.2.10</strong>
[<span class="keyword">*</span>Spoke1-ospf-1] <strong>area 0.0.0.1</strong>
[<span class="keyword">*</span>Spoke1-ospf-1-areHub-0.0.0.1] <strong>network 10.1.2.0 0.0.0.255</strong>
[<span class="keyword">*</span>Spoke1-ospf-1-areHub-0.0.0.1] <strong>quit</strong>
[<span class="keyword">*</span>Spoke1-ospf-1] <strong>quit</strong>
[<span class="keyword">*</span>Spoke1] <strong>commit</strong></pre>
<p># Configure OSPF on Spoke 2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke2] <strong>ospf 1 router-id 10.1.3.10</strong>
[<span class="keyword">*</span>Spoke2-ospf-1] <strong>area 0.0.0.1</strong>
[<span class="keyword">*</span>Spoke2-ospf-1-areHub-0.0.0.1] <strong>network 10.1.3.0 0.0.0.255</strong>
[<span class="keyword">*</span>Spoke2-ospf-1-areHub-0.0.0.1] <strong>quit</strong>
[<span class="keyword">*</span>Spoke2-ospf-1] <strong>quit</strong>
[<span class="keyword">*</span>Spoke2] <strong>commit</strong></pre>
</p></li><li><span>Configure basic OSPF functions.</span><p><p># Configure Hub.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>ospf 2 router-id 172.16.1.1</strong> <strong>vpn-instance vpna</strong>
[<span class="keyword">*</span>Hub-ospf-2] <strong>vpn-instance-capability simple</strong>
Warning: This operation may cause a routing loop. Continue? [Y/N]:Y
[<span class="keyword">*</span>Hub-ospf-2] <strong>area 0.0.0.0</strong>
[<span class="keyword">*</span>Hub-ospf-2-areHub-0.0.0.0] <strong>network 172.16.1.0 0.0.0.255</strong>
[<span class="keyword">*</span>Hub-ospf-2-areHub-0.0.0.0] <strong>network 192.168.0.0 0.0.0.255</strong>
[<span class="keyword">*</span>Hub-ospf-2-areHub-0.0.0.0] <strong>quit</strong>
[<span class="keyword">*</span>Hub-ospf-2] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>ospf 3 router-id 172.16.1.1</strong> <strong>vpn-instance vpnb</strong>
[<span class="keyword">*</span>Hub-ospf-3] <strong>area 0.0.0.0</strong>
[<span class="keyword">*</span>Hub-ospf-3-areHub-0.0.0.0] <strong>network 172.16.1.0 0.0.0.255</strong>
[<span class="keyword">*</span>Hub-ospf-3-areHub-0.0.0.0] <strong>network 192.168.0.0 0.0.0.255</strong>
[<span class="keyword">*</span>Hub-ospf-3-areHub-0.0.0.0] <strong>quit</strong>
[<span class="keyword">*</span>Hub-ospf-3] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>commit</strong></pre>
<p># Configure Spoke 1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke1] <strong>ospf 2 router-id 172.16.1.2</strong> <strong>vpn-instance vpna</strong>
[<span class="keyword">*</span>Spoke1-ospf-2] <strong>vpn-instance-capability simple</strong>
Warning: This operation may cause a routing loop. Continue? [Y/N]:Y
[<span class="keyword">*</span>Spoke1-ospf-2] <strong>area 0.0.0.0</strong>
[<span class="keyword">*</span>Spoke1-ospf-2-areHub-0.0.0.0] <strong>network 172.16.1.0 0.0.0.255</strong>
[<span class="keyword">*</span>Spoke1-ospf-2-areHub-0.0.0.0] <strong>network 192.168.1.0 0.0.0.255</strong>
[<span class="keyword">*</span>Spoke1-ospf-2-areHub-0.0.0.0] <strong>quit</strong>
[<span class="keyword">*</span>Spoke1-ospf-2] <strong>quit</strong>
[<span class="keyword">*</span>Spoke1] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke1] <strong>ospf 3 router-id 172.16.1.2</strong> <strong>vpn-instance vpnb</strong>
[<span class="keyword">*</span>Spoke1-ospf-3] <strong>area 0.0.0.0</strong>
[<span class="keyword">*</span>Spoke1-ospf-3-areHub-0.0.0.0] <strong>network 172.16.1.0 0.0.0.255</strong>
[<span class="keyword">*</span>Spoke1-ospf-3-areHub-0.0.0.0] <strong>network 192.168.1.0 0.0.0.255</strong>
[<span class="keyword">*</span>Spoke1-ospf-3-areHub-0.0.0.0] <strong>quit</strong>
[<span class="keyword">*</span>Spoke1-ospf-3] <strong>quit</strong>
[<span class="keyword">*</span>Spoke1] <strong>commit</strong></pre>
<p># Configure Spoke 2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke2] <strong>ospf 2 router-id 172.16.1.3</strong> <strong>vpn-instance vpna</strong>
[<span class="keyword">*</span>Spoke2-ospf-2] <strong>vpn-instance-capability simple</strong>
Warning: This operation may cause a routing loop. Continue? [Y/N]:Y
[<span class="keyword">*</span>Spoke2-ospf-2] <strong>area 0.0.0.0</strong>
[<span class="keyword">*</span>Spoke2-ospf-2-areHub-0.0.0.0] <strong>network 172.16.1.0 0.0.0.255</strong>
[<span class="keyword">*</span>Spoke2-ospf-2-areHub-0.0.0.0] <strong>network 192.168.2.0 0.0.0.255</strong>
[<span class="keyword">*</span>Spoke2-ospf-2-areHub-0.0.0.0] <strong>quit</strong>
[<span class="keyword">*</span>Spoke2-ospf-2] <strong>quit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke2] <strong>ospf 3 router-id 172.16.1.3</strong> <strong>vpn-instance vpnb</strong>
[<span class="keyword">*</span>Spoke2-ospf-3] <strong>area 0.0.0.0</strong>
[<span class="keyword">*</span>Spoke2-ospf-3-areHub-0.0.0.0] <strong>network 172.16.1.0 0.0.0.255</strong>
[<span class="keyword">*</span>Spoke2-ospf-3-areHub-0.0.0.0] <strong>network 192.168.2.0 0.0.0.255</strong>
[<span class="keyword">*</span>Spoke2-ospf-3-areHub-0.0.0.0] <strong>quit</strong>
[<span class="keyword">*</span>Spoke2-ospf-3] <strong>quit</strong>
[<span class="keyword">*</span>Spoke2] <strong>commit</strong></pre>
</p></li><li><span>Enable NHRP globally.</span><p><p id="EN-US_TASK_0000001115219894__en-us_task_0172369154_p1167536300214049"># Configure Hub.</p>
<pre class="screen" id="EN-US_TASK_0000001115219894__en-us_task_0172369154_screen1028335826214049">[<span class="keyword" id="EN-US_TASK_0000001115219894__en-us_task_0172369154_keyword43842734214049"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong id="EN-US_TASK_0000001115219894__en-us_task_0172369154_b550849294214049">nhrp enable</strong></pre>
<p id="EN-US_TASK_0000001115219894__en-us_task_0172369154_p587930736214049">The configurations of the spokes are similar to the configuration of the hub. For detailed configurations, see Configuration Files.</p>
</p></li><li><span>Configure an IKE proposal.</span><p><p>Configure an IKE proposal on Hub and spokes and select the same authentication mode.</p>
<p># Configure Hub.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>ike proposal 1</strong>
[<span class="keyword">*</span>Hub-ike-proposal-1] <strong>encryption-algorithm aes-cbc 256</strong>
[<span class="keyword">*</span>Hub-ike-proposal-1] <strong>dh group14</strong>
[<span class="keyword">*</span>Hub-ike-proposal-1] <strong>authentication-algorithm sha2-256</strong>
[<span class="keyword">*</span>Hub-ike-proposal-1] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>commit</strong></pre>
<p>The configurations of Spoke 1 and Spoke 2 are similar to the configuration of Hub. For configuration details, see Configuration Files in this section.</p>
</p></li><li><span>Configure an IKE peer.</span><p><p>Configure the IKE peer required for IKE negotiation on Hub and spokes.</p>
<p># Configure Hub.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>ike peer hub</strong>
[<span class="keyword">*</span>Hub-ike-peer-hub] <strong>ike-proposal 1</strong>
[<span class="keyword">*</span>Hub-ike-peer-hub] <strong>pre-shared-key gfdsa@1234</strong>
[<span class="keyword">*</span>Hub-ike-peer-hub] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>commit</strong></pre>
<p>The configurations of Spoke 1 and Spoke 2 are similar to the configuration of Hub. For configuration details, see Configuration Files in this section.</p>
</p></li><li><span>Create an IPsec proposal.</span><p><p>Create an IPsec proposal on Hub and spokes.</p>
<p># Configure Hub.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>ipsec proposal pro1</strong>
[<span class="keyword">*</span>Hub-ipsec-proposal-pro1] <strong>transform ah-esp</strong>
[<span class="keyword">*</span>Hub-ipsec-proposal-pro1] <strong>ah authentication-algorithm <span>sha2-256</span></strong>
[<span class="keyword">*</span>Hub-ipsec-proposal-pro1] <strong>esp authentication-algorithm <span>sha2-256</span></strong>
[<span class="keyword">*</span>Hub-ipsec-proposal-pro1] <strong>esp encryption-algorithm aes 192</strong>
[<span class="keyword">*</span>Hub-ipsec-proposal-pro1] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>commit</strong></pre>
<p>The configurations of Spoke 1 and Spoke 2 are similar to the configuration of Hub. For configuration details, see Configuration Files in this section.</p>
</p></li><li><span>Configure an IPsec profile. </span><p><p>Configure an IPsec profile on Hub and spokes. </p>
<p># Configure Hub.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>ipsec policy 1 profile</strong>
[<span class="keyword">*</span>Hub-ipsec-policy-profile-1] <strong>ike-peer hub</strong>
[<span class="keyword">*</span>Hub-ipsec-policy-profile-1] <strong>proposal pro1</strong>
[<span class="keyword">*</span>Hub-ipsec-policy-profile-1] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>commit</strong></pre>
<p>The configurations of Spoke 1 and Spoke 2 are similar to the configuration of Hub. For configuration details, see Configuration Files in this section.</p>
</p></li><li><span>Configure an IPsec service instance group.</span><p><p>Configure an IPsec service instance group on Hub and spokes.</p>
<p># Configure Hub.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>service-location 1</strong>
[<span class="keyword">*</span>Hub-service-location-1] <strong>location slot </strong><strong><span>1</span></strong>
[<span class="keyword">*</span>Hub-service-location-1] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub-service-location-1]<strong> quit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>service-instance-group group1</strong>
[<span class="keyword">*</span>Hub-service-instance-group-group1]<strong> service-location 1</strong>
[<span class="keyword">*</span>Hub-service-instance-group-group1] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub-service-instance-group-group1] <strong>quit</strong></pre>
<p>The configurations of Spoke 1 and Spoke 2 are similar to the configuration of Hub. For configuration details, see Configuration Files in this section.</p>
</p></li><li><span>Configure tunnel interfaces.</span><p><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Generally, one IPsec profile can be applied only to one interface. In a scenario where multiple mGRE tunnels of a DSVPN share the same source, if the same IPsec profile needs to be applied to multiple tunnel interfaces for IPsec tunnel sharing, specify the <strong><span>share</span></strong> parameter when running this command. The <strong><span>share</span></strong> parameter can be used only in this scenario. In addition, mGRE tunnels with the same source must be configured with different keys.</p>
</div></div>
<div class="p"># Configure tunnel interfaces and OSPF attributes and apply the IPsec profile on Hub.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>interface tunnel 0</strong>
[<span class="keyword">*</span>Hub-Tunnel0] <strong>tunnel-protocol gre p2mp</strong>
[<span class="keyword">*</span>Hub-Tunnel0] <strong>nhrp enable</strong>
[<span class="keyword">*</span>Hub-Tunnel0] <strong>source 10.1.1.10</strong>
[<span class="keyword">*</span>Hub-Tunnel0] <strong>gre key cipher 123</strong>
[<span class="keyword">*</span>Hub-Tunnel0] <strong>nhrp entry multicast dynamic</strong>
[<span class="keyword">*</span>Hub-Tunnel0] <strong>ospf network-type p2mp</strong>
[<span class="keyword">*</span>Hub-Tunnel0] <strong>nhrp redirect</strong>
[<span class="keyword">*</span>Hub-Tunnel0] <strong>ipsec policy 1<span> service-instance-group group1 share</span> </strong> 
[<span class="keyword">*</span>Hub-Tunnel0] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>interface tunnel 1</strong>
[<span class="keyword">*</span>Hub-Tunnel1] <strong>tunnel-protocol gre p2mp</strong>
[<span class="keyword">*</span>Hub-Tunnel1] <strong>nhrp enable</strong>
[<span class="keyword">*</span>Hub-Tunnel1] <strong>source 10.1.1.10</strong>
[<span class="keyword">*</span>Hub-Tunnel1] <strong>gre key cipher 456</strong>
[<span class="keyword">*</span>Hub-Tunnel1] <strong>nhrp entry multicast dynamic</strong>
[<span class="keyword">*</span>Hub-Tunnel1] <strong>ospf network-type p2mp</strong>
[<span class="keyword">*</span>Hub-Tunnel1] <strong>nhrp redirect</strong>
[<span class="keyword">*</span>Hub-Tunnel1] <strong>ipsec policy 1<span> service-instance-group group1 share</span> </strong> 
[<span class="keyword">*</span>Hub-Tunnel1] <strong>quit</strong>
[<span class="keyword">*</span>Hub] <strong>commit</strong></pre>
</div>
<div class="p"># Configure tunnel interfaces, OSPF route attributes, and Hub's static NHRP peer entry, and apply the IPsec profile on Spoke 1. <pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke1] <strong>interface tunnel 0</strong>
[<span class="keyword">*</span>Spoke1-Tunnel0] <strong>tunnel-protocol gre p2mp</strong>
[<span class="keyword">*</span>Spoke1-Tunnel0] <strong>nhrp enable</strong>
[<span class="keyword">*</span>Spoke1-Tunnel0] <strong>source 10.1.2.10</strong>
[<span class="keyword">*</span>Spoke1-Tunnel0] <strong>gre key cipher 123</strong>
[<span class="keyword">*</span>Spoke1-Tunnel0] <strong>nhrp entry 172.16.1.1 10.1.1.10 register</strong>
[<span class="keyword">*</span>Spoke1-Tunnel0] <strong>ospf network-type p2mp</strong>
[<span class="keyword">*</span>Spoke1-Tunnel0] <strong>nhrp shortcut</strong>
[<span class="keyword">*</span>Spoke1-Tunnel0] <strong>ipsec policy 1<span> service-instance-group group1 share</span></strong>
[<span class="keyword">*</span>Spoke1-Tunnel0] <strong>quit</strong>
[<span class="keyword">*</span>Spoke1] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke1] <strong>interface tunnel 1</strong>
[<span class="keyword">*</span>Spoke1-Tunnel1] <strong>tunnel-protocol gre p2mp</strong>
[<span class="keyword">*</span>Spoke1-Tunnel1] <strong>nhrp enable</strong>
[<span class="keyword">*</span>Spoke1-Tunnel1] <strong>source 10.1.2.10</strong>
[<span class="keyword">*</span>Spoke1-Tunnel1] <strong>gre key cipher 456</strong>
[<span class="keyword">*</span>Spoke1-Tunnel1] <strong>nhrp entry 172.16.1.1 10.1.1.10 register</strong>
[<span class="keyword">*</span>Spoke1-Tunnel1] <strong>ospf network-type p2mp</strong>
[<span class="keyword">*</span>Spoke1-Tunnel1] <strong>nhrp shortcut</strong>
[<span class="keyword">*</span>Spoke1-Tunnel1] <strong>ipsec policy 1<span> service-instance-group group1 share</span></strong>
[<span class="keyword">*</span>Spoke1-Tunnel1] <strong>quit</strong>
[<span class="keyword">*</span>Spoke1] <strong>commit</strong></pre>
</div>
<div class="p"># Configure tunnel interfaces, OSPF route attributes, and Hub's static NHRP peer entry, and apply the IPsec profile on Spoke 2. <pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke2] <strong>interface tunnel 0</strong>
[<span class="keyword">*</span>Spoke2-Tunnel0] <strong>tunnel-protocol gre p2mp</strong>
[<span class="keyword">*</span>Spoke2-Tunnel0] <strong>nhrp enable</strong>
[<span class="keyword">*</span>Spoke2-Tunnel0] <strong>source 10.1.3.10</strong>
[<span class="keyword">*</span>Spoke2-Tunnel0] <strong>gre key cipher 123</strong>
[<span class="keyword">*</span>Spoke2-Tunnel0] <strong>nhrp entry 172.16.1.1 10.1.1.10 register</strong>
[<span class="keyword">*</span>Spoke2-Tunnel0] <strong>ospf network-type p2mp</strong>
[<span class="keyword">*</span>Spoke2-Tunnel0] <strong>nhrp shortcut</strong>
[<span class="keyword">*</span>Spoke2-Tunnel0] <strong>ipsec policy 1<span> service-instance-group group1 share</span></strong>
[<span class="keyword">*</span>Spoke2-Tunnel0] <strong>quit</strong>
[<span class="keyword">*</span>Spoke2] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke2] <strong>interface tunnel 1</strong>
[<span class="keyword">*</span>Spoke2-Tunnel1] <strong>tunnel-protocol gre p2mp</strong>
[<span class="keyword">*</span>Spoke2-Tunnel1] <strong>nhrp enable</strong>
[<span class="keyword">*</span>Spoke2-Tunnel1] <strong>source 10.1.3.10</strong>
[<span class="keyword">*</span>Spoke2-Tunnel1] <strong>gre key cipher 456</strong>
[<span class="keyword">*</span>Spoke2-Tunnel1] <strong>nhrp entry 172.16.1.1 10.1.1.10 register</strong>
[<span class="keyword">*</span>Spoke2-Tunnel1] <strong>ospf network-type p2mp</strong>
[<span class="keyword">*</span>Spoke2-Tunnel1] <strong>nhrp shortcut</strong>
[<span class="keyword">*</span>Spoke2-Tunnel1] <strong>ipsec policy 1<span> service-instance-group group1 share</span></strong>
[<span class="keyword">*</span>Spoke2-Tunnel1] <strong>quit</strong>
[<span class="keyword">*</span>Spoke2] <strong>commit</strong></pre>
</div>
</p></li><li><span>Verify the DSVPN configuration.</span><p><p>After completing the configuration, verify the NHRP peer entry on spokes.</p>
<div class="p"># Run the <strong>display nhrp peer all</strong> command on Spoke 1. The command output is as follows.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke1] <strong>display nhrp peer all</strong>
------------------------------------------------------------------------------- 
Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type         Flag 
------------------------------------------------------------------------------- 
172.16.1.1      32    10.1.1.10      172.16.1.1       hub          up 
------------------------------------------------------------------------------- 
Tunnel interface: Tunnel0 (VPN instance: vpna) 
Created time    : 00:10:58 
Expire time     : -- 
------------------------------------------------------------------------------- 
Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type         Flag 
------------------------------------------------------------------------------- 
172.16.1.1      32    10.1.1.10      172.16.1.1       hub          up 
------------------------------------------------------------------------------- 
Tunnel interface: Tunnel1 (VPN instance: vpnb) 
Created time    : 00:10:59 
Expire time     : -- 
-------------------------- 
Number of nhrp peers: 2 </pre>
</div>
<div class="p"># Run the <strong>display nhrp peer all</strong> command on Spoke 2. The command output is as follows.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke2] <strong>display nhrp peer all</strong>
------------------------------------------------------------------------------- 
 Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type         Flag 
 ------------------------------------------------------------------------------- 
 172.16.1.1      32    10.1.1.10      172.16.1.1       hub          up 
 ------------------------------------------------------------------------------- 
 Tunnel interface: Tunnel0 (VPN instance: vpna) 
 Created time    : 00:07:55 
 Expire time     : -- 
 ------------------------------------------------------------------------------- 
 Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type         Flag 
 ------------------------------------------------------------------------------- 
 172.16.1.1      32    10.1.1.10      172.16.1.1       hub          up 
 ------------------------------------------------------------------------------- 
 Tunnel interface: Tunnel1 (VPN instance: vpnb) 
 Created time    : 00:07:56 
 Expire time     : -- 
 -------------------------- 
 Number of nhrp peers: 2 </pre>
</div>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>After the configuration is complete, the <strong>display nhrp peer all</strong> command output shows only the static NHRP peer entries mapped to Hub on Spoke 1 and Spoke 2.</p>
</div></div>
<p>On Hub, verify registration information about Spoke 1 and Spoke 2.</p>
<div class="p"># Run the <strong>display nhrp peer all</strong> command on Hub. The command output is as follows.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Hub] <strong>display nhrp peer all</strong>
------------------------------------------------------------------------------- 
Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type         Flag 
------------------------------------------------------------------------------- 
172.16.1.2      32    10.1.2.10      172.16.1.2      registered   up|unique 
------------------------------------------------------------------------------- 
Tunnel interface: Tunnel0 (VPN instance: vpna) 
Created time    : 00:02:02 
Expire time     : 01:57:58 
------------------------------------------------------------------------------- 
Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type         Flag 
------------------------------------------------------------------------------- 
172.16.1.3      32    10.1.3.10      172.16.1.3      registered   up|unique 
------------------------------------------------------------------------------- 
Tunnel interface: Tunnel0 (VPN instance: vpna) 
Created time    : 00:01:53 
Expire time     : 01:58:07 
------------------------------------------------------------------------------- 
Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type         Flag 
------------------------------------------------------------------------------- 
172.16.1.2      32    10.1.2.10      172.16.1.2      registered   up|unique 
------------------------------------------------------------------------------- 
Tunnel interface: Tunnel1 (VPN instance: vpnb) 
Created time    : 00:02:03 
Expire time     : 01:57:57 
------------------------------------------------------------------------------- 
Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type         Flag 
------------------------------------------------------------------------------- 
172.16.1.3      32    10.1.3.10      172.16.1.3      registered   up|unique 
------------------------------------------------------------------------------- 
Tunnel interface: Tunnel1 (VPN instance: vpnb) 
Created time    : 00:01:54 
Expire time     : 01:58:06 
-------------------------- 
Number of nhrp peers: 4 </pre>
</div>
</p></li><li><span>Run the <strong>ping</strong> command and check the configuration result.</span><p><p>Ping the subnet address 192.168.2.1 of Spoke 2 from the two VPN instances on Spoke 1. Then, verify the dynamic NHRP peer entries of Spoke 1 and Spoke 2.</p>
<p># Run the <strong>ping -vpn-instance-vpna -a 192.168.1.1 192.168.2.1</strong> and <strong>ping -vpn-instance-vpnb -a 192.168.1.1 192.168.2.1</strong> commands on Spoke 1. The command output is as follows.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke1] <strong>ping -vpn-instance-vpna -a 192.168.1.1 192.168.2.1</strong>
 PING 192.168.2.1: 56  data bytes, press CTRL_C to break 
    Reply from 192.168.2.1: bytes=56 Sequence=1 ttl=254 time=3 ms 
    Reply from 192.168.2.1: bytes=56 Sequence=2 ttl=255 time=2 ms 
    Reply from 192.168.2.1: bytes=56 Sequence=3 ttl=255 time=2 ms 
    Reply from 192.168.2.1: bytes=56 Sequence=4 ttl=255 time=2 ms 
    Reply from 192.168.2.1: bytes=56 Sequence=5 ttl=255 time=2 ms 
 
  --- 192.168.2.1 ping statistics --- 
    5 packet(s) transmitted 
    5 packet(s) received 
    0.00% packet loss 
    round-trip min/avg/max = 2/2/3 ms 

[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke1] <strong>ping -vpn-instance-vpnb -a 192.168.1.1 192.168.2.1</strong> 
  PING 192.168.2.1: 56  data bytes, press CTRL_C to break 
    Reply from 192.168.2.1: bytes=56 Sequence=1 ttl=254 time=3 ms 
    Reply from 192.168.2.1: bytes=56 Sequence=2 ttl=255 time=2 ms 
    Reply from 192.168.2.1: bytes=56 Sequence=3 ttl=255 time=2 ms 
    Reply from 192.168.2.1: bytes=56 Sequence=4 ttl=255 time=2 ms 
    Reply from 192.168.2.1: bytes=56 Sequence=5 ttl=255 time=2 ms 
 
  --- 192.168.2.1 ping statistics --- 
    5 packet(s) transmitted 
    5 packet(s) received 
    0.00% packet loss 
    round-trip min/avg/max = 2/2/3 ms </pre>
<p># Run the <strong>display nhrp peer all</strong> command on Spoke 1. The command output on Spoke 1 is used as an example.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke1] <strong>display nhrp peer all</strong>
 ------------------------------------------------------------------------------- 
 Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type            Flag 
 ------------------------------------------------------------------------------- 
 172.16.1.1      32    10.1.1.10      172.16.1.1      hub              up 
 ------------------------------------------------------------------------------- 
 Tunnel interface: Tunnel0 (VPN instance: vpna) 
 Created time    : 00:46:35 
 Expire time     : -- 
 ------------------------------------------------------------------------------- 
 Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type            Flag 
 ------------------------------------------------------------------------------- 
 192.168.2.1     32    10.1.3.10      172.16.1.3      remote-network  up 
 ------------------------------------------------------------------------------- 
 Tunnel interface: Tunnel0 (VPN instance: vpna) 
 Created time    : 00:00:28 
 Expire time     : 01:59:32 
 ------------------------------------------------------------------------------- 
 Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type            Flag 
 ------------------------------------------------------------------------------- 
 172.16.1.3      32    10.1.3.10      172.16.1.3      remote          up 
 ------------------------------------------------------------------------------- 
 Tunnel interface: Tunnel0 (VPN instance: vpna) 
 Created time    : 00:00:28 
 Expire time     : 01:59:32 
 ------------------------------------------------------------------------------- 
 Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type            Flag 
 ------------------------------------------------------------------------------- 
 172.16.1.2      32    10.1.2.10      172.16.1.2      local           up 
 ------------------------------------------------------------------------------- 
 Tunnel interface: Tunnel0 (VPN instance: vpna) 
 Created time    : 00:00:28 
 Expire time     : 01:59:32 
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>Spoke1] <strong>display nhrp peer all</strong>
 ------------------------------------------------------------------------------- 
 Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type            Flag 
 ------------------------------------------------------------------------------- 
 172.16.1.1      32    10.1.1.10      172.16.1.1      hub              up 
 ------------------------------------------------------------------------------- 
 Tunnel interface: Tunnel1 (VPN instance: vpnb) 
 Created time    : 00:46:36 
 Expire time     : -- 
 ------------------------------------------------------------------------------- 
 Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type            Flag 
 ------------------------------------------------------------------------------- 
 192.168.2.1     32    10.1.3.10      172.16.1.3      remote-network  up 
 ------------------------------------------------------------------------------- 
 Tunnel interface: Tunnel1 (VPN instance: vpnb) 
 Created time    : 00:00:22 
 Expire time     : 01:59:38 
 ------------------------------------------------------------------------------- 
 Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type            Flag 
 ------------------------------------------------------------------------------- 
 172.16.1.3      32    10.1.3.10      172.16.1.3      remote          up 
 ------------------------------------------------------------------------------- 
 Tunnel interface: Tunnel1 (VPN instance: vpnb) 
 Created time    : 00:00:22 
 Expire time     : 01:59:38 
 ------------------------------------------------------------------------------- 
 Protocol-addr   Mask  NBMA-addr       NextHop-addr    Type            Flag 
 ------------------------------------------------------------------------------- 
 172.16.1.2      32    10.1.2.10      172.16.1.2      local           up 
 ------------------------------------------------------------------------------- 
 Tunnel interface: Tunnel1 (VPN instance: vpnb) 
 Created time    : 00:00:22 
 Expire time     : 01:59:38 
 -------------------------- 
 Number of nhrp peers: 8 </pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0000001115219894__1.3.4"></a><a name="1.3.4"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>Hub configuration file</p>
<pre class="screen">#
sysname Hub
#
ike dpd 100
# 
ike proposal 1
 encryption-algorithm aes-cbc 256                                                   
 dh group14                                                                      
 authentication-algorithm sha2-256                                       
 authentication-method pre-share                                                
 integrity-algorithm hmac-sha2-256                                              
# 
ike peer hub
<strong> </strong>pre-shared-key cipher %^%#6n%Y;[:&gt;0T\w<font style="font-size:8pt" Face="Courier New" >~</font>V2nMW//EnxY@k;[q0/x<font style="font-size:8pt" Face="Courier New" >~</font>`.gjZ&gt;#%^%#
 ike-proposal 1
#
service-location 1
 location slot <span>1</span>
#
service-instance-group group1
 service-location 1
#
ipsec proposal pro1
 transform ah-esp
 ah authentication-algorithm <span>sha2-256</span>
 esp authentication-algorithm <span>sha2-256</span>
 esp encryption-algorithm <span>aes 192</span>
# 
ipsec policy 1 profile
 ike-peer hub
 proposal pro1
# 
nhrp enable
#
ip vpn-instance vpna 
  ipv4-family 
   route-distinguisher 100:1 
   apply-label per-instance
   vpn-target 111:1 export-extcommunity 
   vpn-target 111:1 import-extcommunity 
# 
ip vpn-instance vpnb 
 ipv4-family 
  route-distinguisher 100:2 
  apply-label per-instance
  vpn-target 222:2 export-extcommunity 
  vpn-target 222:2 import-extcommunity 
# 
interface GigabitEthernet<span>0/1/0</span>
 ip address 10.1.1.10 255.255.255.0
# 
interface LoopBack0
 ip binding vpn-instance vpna
 ip address 192.168.0.1 255.255.255.255
# 
interface LoopBack1 
 ip binding vpn-instance vpnb 
 ip address 192.168.0.1 255.255.255.255 
#
interface Tunnel0
 ip binding vpn-instance vpna
 ip address 172.16.1.1 255.255.255.0
 tunnel-protocol gre p2mp
 source 10.1.1.10
 gre key cipher %^%#GF3A:qC&lt;_7"nw=Hb'vv<font style="font-size:8pt" Face="Courier New" >~</font>S8l,.!(GB%)&amp;%]3NBmc*%^%#
 nhrp enable
 nhrp redirect
 nhrp entry multicast dynamic
 ipsec policy 1<span> service-instance-group group1 share</span>
 ospf network-type p2mp
# 
interface Tunnel1 
 ip binding vpn-instance vpnb 
 ip address 172.16.1.1 255.255.255.0 
 tunnel-protocol gre p2mp 
 source 10.1.1.10 
 gre key cipher %^%#8-'W16TBd:UJ-rHbf&amp;{P^Syv#i\Q!U`ukG&gt;uDul%%^%#
 nhrp enable 
 nhrp redirect 
 nhrp entry multicast dynamic 
 ipsec policy 1<span> service-instance-group group1 share</span> 
 ospf network-type p2mp 
#
ospf 1 router-id 10.1.1.10
 area 0.0.0.1
  network 10.1.1.0 0.0.0.255
#
ospf 2 router-id 172.16.1.1 vpn-instance vpna 
 vpn-instance-capability simple 
 area 0.0.0.0
  network 172.16.1.0 0.0.0.255
  network 192.168.0.0 0.0.0.255
# 
ospf 3 router-id 172.16.1.1 vpn-instance vpnb 
 vpn-instance-capability simple 
 area 0.0.0.0
  network 172.16.1.0 0.0.0.255
  network 192.168.0.0 0.0.0.255
#
return</pre>
</li><li><p>Spoke 1 configuration file</p>
<pre class="screen">#
sysname Spoke1
# 
nhrp enable
#
ike dpd 100
#
ike proposal 1
 encryption-algorithm aes-cbc 256                                                   
 dh group14                                                                      
 authentication-algorithm sha2-256                                       
 authentication-method pre-share                                                
 integrity-algorithm hmac-sha2-256                                              
# 
ike peer spoke1
 pre-shared-key cipher %^%#6n%Y;[:&gt;0T\w<font style="font-size:8pt" Face="Courier New" >~</font>V2nMW//EnxY@k;[q0/x<font style="font-size:8pt" Face="Courier New" >~</font>`.gjZ&gt;#%^%#
 ike-proposal 1
#
service-location 1
 location slot <span>1</span>
#
service-instance-group group1
 service-location 1
#
ipsec proposal pro1
 transform ah-esp
 ah authentication-algorithm <span>sha2-256</span>
 esp authentication-algorithm <span>sha2-256</span>
 esp encryption-algorithm <span>aes 192</span>
# 
ipsec policy 1 profile
 ike-peer spoke1
 proposal pro1
# 
ip vpn-instance vpna 
 ipv4-family 
  route-distinguisher 200:1 
  apply-label per-instance 
  vpn-target 111:1 export-extcommunity 
  vpn-target 111:1 import-extcommunity 
#
ip vpn-instance vpnb 
 ipv4-family 
  route-distinguisher 200:2 
  apply-label per-instance 
  vpn-target 222:2 export-extcommunity 
  vpn-target 222:2 import-extcommunity 
#
interface GigabitEthernet<span>0/1/0</span>
 ip address 10.1.2.10 255.255.255.0
# 
interface LoopBack0
 ip binding vpn-instance vpna
 ip address 192.168.1.1 255.255.255.255
# 
interface LoopBack1
 ip binding vpn-instance vpnb
 ip address 192.168.1.1 255.255.255.255
# 
interface Tunnel0
 ip binding vpn-instance vpna
 ip address 172.16.1.2 255.255.255.0
 tunnel-protocol gre p2mp
 source 10.1.2.10
 gre key cipher %^%#GF3A:qC&lt;_7"nw=Hb'vv<font style="font-size:8pt" Face="Courier New" >~</font>S8l,.!(GB%)&amp;%]3NBmc*%^%# 
 nhrp enable
 nhrp shortcut
 nhrp entry 172.16.1.1 10.1.1.10 register
 ipsec policy 1<span> service-instance-group group1 share</span>
 ospf network-type p2mp
# 
interface Tunnel1
 ip binding vpn-instance vpnb
 ip address 172.16.1.2 255.255.255.0
 tunnel-protocol gre p2mp
 source 10.1.2.10
 gre key cipher %^%#8-'W16TBd:UJ-rHbf&amp;{P^Syv#i\Q!U`ukG&gt;uDul%%^%# 
 nhrp enable
 nhrp shortcut
 nhrp entry 172.16.1.1 10.1.1.10 register
 ipsec policy 1<span> service-instance-group group1 share</span>
 ospf network-type p2mp
#
ospf 1 router-id 10.1.2.10
 area 0.0.0.1
  network 10.1.2.0 0.0.0.255
#
ospf 2 router-id 172.16.1.2 vpn-instance vpna
 vpn-instance-capability simple 
 area 0.0.0.0
  network 172.16.1.0 0.0.0.255
  network 192.168.1.0 0.0.0.255
#  
ospf 3 router-id 172.16.1.2 vpn-instance vpnb
 vpn-instance-capability simple 
 area 0.0.0.0
  network 172.16.1.0 0.0.0.255
  network 192.168.1.0 0.0.0.255
# 
return</pre>
</li><li><p>Spoke 2 configuration file</p>
<pre class="screen">#
sysname Spoke2
# 
nhrp enable
#
ike dpd 100
#
ike proposal 1
 encryption-algorithm aes-cbc 256                                                   
 dh group14                                                                      
 authentication-algorithm sha2-256                                       
 authentication-method pre-share                                                
 integrity-algorithm hmac-sha2-256                                              
# 
ike peer spoke2
 pre-shared-key <span>gfdsa@123</span>4
 ike-proposal 1
#
service-location 1
 location slot <span>1</span>
#
service-instance-group group1
 service-location 1
#
ipsec policy 1
 ike-peer spoke2
 proposal pro1
# 
ip vpn-instance vpna 
 ipv4-family 
  route-distinguisher 300:1 
  apply-label per-instance
  vpn-target 111:1 export-extcommunity 
  vpn-target 111:1 import-extcommunity 
#
ip vpn-instance vpnb
 ipv4-family 
  route-distinguisher 300:2
  apply-label per-instance
  vpn-target 222:2 export-extcommunity 
  vpn-target 222:2 import-extcommunity 
#
interface GigabitEthernet<span>0/1/0</span>
 ip address 10.1.3.10 255.255.255.0
# 
interface LoopBack0
 ip binding vpn-instance vpna
 ip address 192.168.2.1 255.255.255.255
# 
interface LoopBack1
 ip binding vpn-instance vpnb
 ip address 192.168.2.1 255.255.255.255
#
interface Tunnel0
 ip binding vpn-instance vpna
 ip address 172.16.1.3 255.255.255.0
 tunnel-protocol gre p2mp
 source 10.1.3.10
 gre key cipher %^%#GF3A:qC&lt;_7"nw=Hb'vv<font style="font-size:8pt" Face="Courier New" >~</font>S8l,.!(GB%)&amp;%]3NBmc*%^%# 
 nhrp enable
 nhrp shortcut
 nhrp entry 172.16.1.1 10.1.1.10 register
 ipsec policy 1<span> service-instance-group group1 share</span>
 ospf network-type p2mp
# 
interface Tunnel1
 ip binding vpn-instance vpnb
 ip address 172.16.1.3 255.255.255.0
 tunnel-protocol gre p2mp
 source 10.1.3.10
 gre key cipher %^%#8-'W16TBd:UJ-rHbf&amp;{P^Syv#i\Q!U`ukG&gt;uDul%%^%#  
 nhrp enable
 nhrp shortcut
 nhrp entry 172.16.1.1 10.1.1.10 register
 ipsec policy 1<span> service-instance-group group1 share</span>
 ospf network-type p2mp
#
ospf 1 router-id 10.1.3.10 
 area 0.0.0.1 
  network 10.1.3.0 0.0.0.255 
# 
ospf 2 router-id 172.16.1.3 vpn-instance vpna
 vpn-instance-capability simple
 area 0.0.0.0 
  network 172.16.1.0 0.0.0.255 
  network 192.168.2.0 0.0.0.255 
# 
ospf 3 router-id 172.16.1.3 vpn-instance vpnb 
 vpn-instance-capability simple
 area 0.0.0.0 
  network 172.16.1.0 0.0.0.255 
  network 192.168.2.0 0.0.0.255 
# 
return </pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_cfg_dsvpn_0015.html">Configuration Examples for DSVPN
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_cfg_dsvpn_0019.html"><span class="font-st">&lt; </span>Previous topic</a>
</div>
</div>
</body>
</html>