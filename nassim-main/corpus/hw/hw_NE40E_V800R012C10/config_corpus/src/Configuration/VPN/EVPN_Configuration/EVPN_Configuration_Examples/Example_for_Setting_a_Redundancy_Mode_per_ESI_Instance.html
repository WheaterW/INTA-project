
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Setting a Redundancy Mode per ESI Instance">
<meta name="abstract" content="This section provides an example for setting a redundancy mode per ESI instance. In scenarios where multiple CEs are dual-homed to PEs, if you want a remote PE to send unicast traffic to different CEs in different modes (load balancing and non-load balancing), you can set a redundancy mode per ESI instance.">
<meta name="description" content="This section provides an example for setting a redundancy mode per ESI instance. In scenarios where multiple CEs are dual-homed to PEs, if you want a remote PE to send unicast traffic to different CEs in different modes (load balancing and non-load balancing), you can set a redundancy mode per ESI instance.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0010.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0096.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0153.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00606909">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="l00425560">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00878323">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172370606">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Setting a Redundancy Mode per ESI Instance</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172370606"></a><a name="EN-US_TASK_0172370606"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Setting a Redundancy Mode per ESI Instance</h1>
<div class="taskbody"><p>This section provides an example for setting a redundancy mode per ESI instance. In scenarios where multiple CEs are dual-homed to PEs, if you want a remote PE to send unicast traffic to different CEs in different modes (load balancing and non-load balancing), you can set a redundancy mode per ESI instance.</p>
<div class="context"><a name="EN-US_TASK_0172370606__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>On the network shown in <a href="#EN-US_TASK_0172370606__fig62019292311">Figure 1</a>, a user wants to deploy an EVPN to transmit services. In this case, you must configure an EVPN instance (BD EVPN instance in this example) on each PE and configure each PE to establish a BGP EVPN peer relationship with its neighboring PE. CE1 and CE2 are each dual-homed to PE1 and PE2. Statically set ESI values on PE1's and PE2's interfaces connecting to CE1 and CE2. If you want unicast traffic from CE3 to CE1 and from CE3 to CE2 to be transmitted in load-balancing and non-load-balancing modes, respectively, you can set a redundancy mode per ESI instance. Specifically, you can set the redundancy mode of the ESI1 instance to all-active and that of the ESI2 instance to single-active.</p>
<div class="fignone" id="EN-US_TASK_0172370606__fig62019292311"><a name="EN-US_TASK_0172370606__fig62019292311"></a><a name="fig62019292311"></a><span class="figcap"><b>Figure 1 </b>Setting a redundancy mode per ESI instance</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>interface1, interface2, interface3, and interface4 in this example represent GigabitEthernet<span>0/1/1</span>, GigabitEthernet<span>0/1/2</span>, GigabitEthernet<span>0/1/3</span>, and GigabitEthernet<span>0/1/4</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0000001300989190.png" width="NaN" height="NaN"></span><br></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172370606__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Precautions </h4><p>During the configuration process, note the following:</p>
<ul><li><p>For the same EVPN instance, the export VPN target list of one site shares VPN targets with the import VPN target lists of the other sites. Conversely, the import VPN target list of one site shares VPN targets with the export VPN target lists of the other sites.</p>
</li><li><p>Using each PE's local loopback interface address as its EVPN source address is recommended.</p>
</li></ul>
</div></div>
<div class="context"><a name="EN-US_TASK_0172370606__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Assign an IP address to each PE interface, including the loopback interfaces.</p>
</li><li><p>Configure a routing protocol on each PE to ensure Layer 3 communication. OSPF is used in this example.</p>
</li><li><p>Configure MPLS LDP on each PE.</p>
</li><li><p>Create a BD EVPN instance and a BD on each PE, and bind the BD to the EVPN instance.</p>
</li><li><p>Configure E-Trunks on each PE and their interfaces connected to CEs, and configure ESIs for these interfaces. The E-Trunks use the default encryption mode <strong>enhanced-hmac-sha256</strong> for authentication.</p>
</li><li><p>Configure a source address on each PE.</p>
</li><li><p>Configure a BGP EVPN peer relationship between each PE and its neighboring PE.</p>
</li><li><p>Set a redundancy mode per ESI instance on each PE.</p>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172370606__1.4.4"></a><a name="1.4.4"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li><p>EVPN instance names: evrf1 and evrf2</p>
</li><li><p>RDs of evrf1 and evrf2: 10:1, 20:1, 10:2, 20:2, 10:3, and 20:3; RTs of evrf1 and evrf2: 11:1 and 22:2</p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172370606__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Assign an IP address to each PE interface, including the loopback interfaces.</span><p><p>For detailed configurations, see <a href="#EN-US_TASK_0172370606__file1">Configuration Files</a>.</p>
</p></li><li><span>Configure a routing protocol on each PE to ensure Layer 3 communication. OSPF is used in this example.</span><p><p>For detailed configurations, see <a href="#EN-US_TASK_0172370606__file1">Configuration Files</a>.</p>
</p></li><li><span>Configure MPLS LDP on each PE.</span><p><p>For detailed configurations, see <a href="#EN-US_TASK_0172370606__file1">Configuration Files</a>.</p>
</p></li><li><span>Create a BD EVPN instance and a BD on each PE, and bind the BD to the EVPN instance.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>evpn vpn-instance evrf1 bd-mode</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-instance-evrf1] <strong>route-distinguisher 10:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-instance-evrf1] <strong>vpn-target 11:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-instance-evrf1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>evpn vpn-instance evrf2 bd-mode</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-instance-evrf2] <strong>route-distinguisher 20:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-instance-evrf2] <strong>vpn-target 22:2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-instance-evrf2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>bridge-domain 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bd10] <strong>evpn binding vpn-instance evrf1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bd10] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>bridge-domain 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bd20] <strong>evpn binding vpn-instance evrf2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bd20] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p>The configurations of PE2 and PE3 are similar to that of PE1. For detailed configurations, see <a href="#EN-US_TASK_0172370606__file1">Configuration Files</a>.</p>
</p></li><li><span>Configure PE interfaces connected to CEs and configure an ESI for each interface.</span><p><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>For security purposes, you are not advised to use weak security algorithms in this feature. If you need to use such an algorithm, run the <a href="cmdqueryname=undo+crypto+weak-algorithm+disable"><b><span class="cmdname">undo crypto weak-algorithm disable</span></b></a> command to enable the weak security algorithm function.</p>
</div></div>
</p><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>lacp e-trunk system-id 00e0-fc00-0000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>e-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-e-trunk-1] <strong>priority 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-e-trunk-1] <strong>peer-address 2.2.2.2 source-address 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-e-trunk-1] <strong>security-key cipher YsHsjx_202206</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-e-trunk-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>e-trunk 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-e-trunk-2] <strong>priority 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-e-trunk-2] <strong>peer-address 2.2.2.2 source-address 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-e-trunk-2] <strong>security-key cipher YsHsjx_202207</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-e-trunk-2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface eth-trunk 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk10] <strong>mode lacp-static</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk10] <strong>e-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk10] <strong>e-trunk mode force-master</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk10] <strong>esi 0000.1111.2222.1111.1111</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk10] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface eth-trunk 10.1 mode l2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk10.1] <strong>encapsulation dot1q vid 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk10.1] <strong>rewrite pop single</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk10.1] <strong>bridge-domain 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk10.1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface eth-trunk 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk20] <strong>mode lacp-static</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk20] <strong>e-trunk 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk20] <strong>esi 0001.0002.0003.0004.0005</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk20] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface eth-trunk 20.1 mode l2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk20.1] <strong>encapsulation dot1q vid 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk20.1] <strong>rewrite pop single</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk20.1] <strong>bridge-domain 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk20.1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet <span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>eth-trunk 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet <span>0/1/4</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/4</span>] <strong>eth-trunk 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/4</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>lacp e-trunk system-id 00e0-fc00-0000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>e-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-e-trunk-1] <strong>priority 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-e-trunk-1] <strong>peer-address 1.1.1.1 source-address 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-e-trunk-1] <strong>security-key cipher YsHsjx_202206</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-e-trunk-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>e-trunk 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-e-trunk-2] <strong>priority 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-e-trunk-2] <strong>peer-address 1.1.1.1 source-address 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-e-trunk-2] <strong>security-key cipher YsHsjx_202207</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-e-trunk-2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface eth-trunk 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk10] <strong>mode lacp-static</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk10] <strong>e-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk10] <strong>e-trunk mode force-master</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk10] <strong>esi 0000.1111.2222.1111.1111</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk10] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface eth-trunk 10.1 mode l2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk10.1] <strong>encapsulation dot1q vid 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk10.1] <strong>rewrite pop single</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk10.1] <strong>bridge-domain 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk10.1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface eth-trunk 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk20] <strong>mode lacp-static</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk20] <strong>e-trunk 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk20] <strong>esi 0001.0002.0003.0004.0005</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk20] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface eth-trunk 20.1 mode l2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk20.1] <strong>encapsulation dot1q vid 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk20.1] <strong>rewrite pop single</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk20.1] <strong>bridge-domain 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk20.1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet <span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>eth-trunk 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet <span>0/1/4</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/4</span>] <strong>eth-trunk 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/4</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>interface gigabitethernet <span>0/3/0</span>.1 mode l2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>.1] <strong>encapsulation dot1q vid 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>.1] <strong>rewrite pop single</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>.1] <strong>bridge-domain 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>.1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface gigabitethernet <span>0/3/0</span>.2 mode l2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>.2] <strong>encapsulation dot1q vid 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>.2] <strong>rewrite pop single</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>.2] <strong>bridge-domain 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>.2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
<p>The configurations of PE2 and PE3 are similar to that of PE1. For detailed configurations, see <a href="#EN-US_TASK_0172370606__file1">Configuration Files</a>.</p>
</p></li><li><span>Configure a source address on each PE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>evpn source-address 1.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>evpn source-address 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>evpn source-address 3.3.3.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</p></li><li><span>Establish a BGP EVPN peer relationship between each PE and its neighboring PE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 2.2.2.2 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 3.3.3.3 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 3.3.3.3 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>l2vpn-family evpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-evpn] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-evpn] <strong>peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-evpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p>The configurations of PE2 and PE3 are similar to that of PE1. For detailed configurations, see <a href="#EN-US_TASK_0172370606__file1">Configuration Files</a>.</p>
</p></li><li><span>Set a redundancy mode per ESI instance on each PE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>evpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn] <strong>esi 0001.0002.0003.0004.0005</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-esi-0001.0002.0003.0004.0005] <strong>evpn redundancy-mode single-active</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-esi-0001.0002.0003.0004.0005] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn] <strong>esi </strong><strong>0000.1111.2222.1111.1111</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-esi-0000.1111.2222.1111.1111] <strong>evpn redundancy-mode all-active</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-esi-0000.1111.2222.1111.1111] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p>The configuration of PE2 is similar to that of PE1. For detailed configurations, see <a href="#EN-US_TASK_0172370606__file1">Configuration Files</a>.</p>
</p></li><li><span>Configuring CEs to Access PEs</span><p><p># Configure CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>vlan 10</strong>
[<span class="keyword">*</span>CE1-vlan10] <strong>quit</strong>
[<span class="keyword">*</span>CE1] <strong>interface vlanif10</strong>
[<span class="keyword">*</span>CE1-Vlanif10] <strong>ip address 192.168.1.11 24</strong>
[<span class="keyword">*</span>CE1-Vlanif10] <strong>quit</strong>
[<span class="keyword">*</span>CE1] <strong>interface eth-trunk10</strong>
[<span class="keyword">*</span>CE1-Eth-Trunk10] <strong>portswitch</strong>
[<span class="keyword">*</span>CE1-Eth-Trunk10] <strong>port link-type trunk</strong>
[<span class="keyword">*</span>CE1-Eth-Trunk10] <strong>port trunk allow-pass vlan 10</strong>
[<span class="keyword">*</span>CE1-Eth-Trunk10] <strong>mode lacp-static</strong>
[<span class="keyword">*</span>CE1-Eth-Trunk10] <strong>quit</strong>
[<span class="keyword">*</span>CE1] <strong>interface</strong> <strong>gigabitethernet</strong><span>0/1/1</span>
[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/1</span>] <strong>eth-trunk 10</strong>
[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong>
[<span class="keyword">*</span>CE1] <strong>interface</strong> <strong>gigabitethernet</strong><span>0/1/2</span>
[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/2</span>] <strong>eth-trunk 10</strong>
[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong>
[<span class="keyword">*</span>CE1] <strong>commit</strong></pre>
<p># Configure CE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>vlan 20</strong>
[<span class="keyword">*</span>CE2-vlan20] <strong>quit</strong>
[<span class="keyword">*</span>CE2] <strong>interface vlanif20</strong>
[<span class="keyword">*</span>CE2-Vlanif20] <strong>ip address 192.168.2.11 24</strong>
[<span class="keyword">*</span>CE2-Vlanif20] <strong>quit</strong>
[<span class="keyword">*</span>CE2] <strong>interface eth-trunk20</strong>
[<span class="keyword">*</span>CE2-Eth-Trunk20] <strong>portswitch</strong>
[<span class="keyword">*</span>CE2-Eth-Trunk20] <strong>port link-type trunk</strong>
[<span class="keyword">*</span>CE2-Eth-Trunk20] <strong>port trunk allow-pass vlan 20</strong>
[<span class="keyword">*</span>CE2-Eth-Trunk20] <strong>mode lacp-static</strong>
[<span class="keyword">*</span>CE2-Eth-Trunk20] <strong>lacp preempt enable</strong>
[<span class="keyword">*</span>CE2-Eth-Trunk20] <strong>max active-linknumber 1</strong>
[<span class="keyword">*</span>CE2-Eth-Trunk20] <strong>lacp preempt delay 180</strong>
[<span class="keyword">*</span>CE2-Eth-Trunk20] <strong>quit</strong>
[<span class="keyword">*</span>CE2] <strong>interface</strong> <strong>gigabitethernet</strong><span>0/1/1</span>
[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/1</span>] <strong>eth-trunk 20</strong>
[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong>
[<span class="keyword">*</span>CE2] <strong>interface</strong> <strong>gigabitethernet</strong><span>0/1/2</span>
[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/2</span>] <strong>eth-trunk 20</strong>
[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong>
[<span class="keyword">*</span>CE2] <strong>commit</strong></pre>
<p># Configure CE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE3] <strong>vlan 10</strong>
[<span class="keyword">*</span>CE3-vlan10] <strong>quit</strong>
[<span class="keyword">*</span>CE3] <strong>vlan 20</strong>
[<span class="keyword">*</span>CE3-vlan20] <strong>quit</strong>
[<span class="keyword">*</span>CE3] <strong>interface vlanif10</strong>
[<span class="keyword">*</span>CE3-Vlanif10] <strong>ip address 192.168.1.12 24</strong>
[<span class="keyword">*</span>CE3-Vlanif10] <strong>quit</strong>
[<span class="keyword">*</span>CE3] <strong>interface vlanif20</strong>
[<span class="keyword">*</span>CE3-Vlanif20] <strong>ip address 192.168.2.12 24</strong>
[<span class="keyword">*</span>CE3-Vlanif20] <strong>quit</strong>
[<span class="keyword">*</span>CE3] <strong>interface </strong><strong>gigabitethernet</strong><span>0/1/1</span>
[<span class="keyword">*</span>CE3-GigabitEthernet<span>0/1/1</span>] <strong>portswitch</strong>
[<span class="keyword">*</span>CE3-GigabitEthernet<span>0/1/1</span>] <strong>port link-type trunk</strong>
[<span class="keyword">*</span>CE3-GigabitEthernet<span>0/1/1</span>] <strong>port trunk allow-pass vlan 10 20</strong>
[<span class="keyword">*</span>CE3-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong>
[<span class="keyword">*</span>CE3] <strong>commit</strong></pre>
</p></li><li><span>Verify the configuration.</span><p><p>Run the <strong>display bgp evpn all esi</strong> command on PE1. The command output shows ESI information of the two EVPN instances and the redundancy modes of the ESI instances.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display bgp evpn all esi</strong></pre>
<pre class="screen">Number of ESI for EVPN address family: 2

 ESI                           IFName/Bridge-domain/PW    Redundancy-Mode    
 0000.1111.2222.1111.1111      Eth-Trunk10.1                   all-active
 0001.0002.0003.0004.0005      Eth-Trunk20.1                   single-active                 

Number of ESI for evpn-instance evrf1: 1

 ESI                           IFName/Bridge-domain/PW    Redundancy-Mode    
 0000.1111.2222.1111.1111      Eth-Trunk10.1                   all-active          

Number of ESI for evpn-instance evrf2: 1

 ESI                           IFName/Bridge-domain/PW    Redundancy-Mode    
 0001.0002.0003.0004.0005      Eth-Trunk20.1                   single-active </pre>
</p></li></ol></div>
<div class="example" id="EN-US_TASK_0172370606__file1"><a name="EN-US_TASK_0172370606__file1"></a><a name="file1"></a><a name="EN-US_TASK_0172370606__1.4.6"></a><a name="1.4.6"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>PE1 configuration file</p>
<pre class="screen">#
sysname PE1
#
lacp e-trunk system-id 00e0-fc00-0000
#
evpn
 #
 mac-duplication
 #
 esi 0000.1111.2222.1111.1111
  evpn redundancy-mode all-active
 #
 esi 0001.0002.0003.0004.0005
  evpn redundancy-mode single-active
#
evpn vpn-instance evrf1 bd-mode
 route-distinguisher 10:1
 vpn-target 11:1 export-extcommunity
 vpn-target 11:1 import-extcommunity
#
evpn vpn-instance evrf2 bd-mode
 route-distinguisher 20:1
 vpn-target 22:2 export-extcommunity
 vpn-target 22:2 import-extcommunity
#
mpls lsr-id 1.1.1.1
#
mpls
#
bridge-domain 10
 evpn binding vpn-instance evrf1
#
bridge-domain 20
 evpn binding vpn-instance evrf2
#
mpls ldp
#
e-trunk 1
 priority 10
 peer-address 2.2.2.2 source-address 1.1.1.1
 security-key cipher %^%#VQE;E!Dl&amp;Rr]if$F&gt;}w9uk5C&gt;y-4|MS$unQ!#Mb#%^%#
 authentication-mode enhanced-hmac-sha256
#
e-trunk 2
 priority 10
 peer-address 2.2.2.2 source-address 1.1.1.1
 security-key cipher %^%#F&amp;zi0c6x_2+SrLT_nm4,vfS$SCd]G:r<font style="font-size:8pt" Face="Courier New" >~</font>A_T!C&gt;A$%^%#
 authentication-mode enhanced-hmac-sha256
#
interface Eth-Trunk10
 mode lacp-static
 e-trunk 1
 e-trunk mode force-master
 esi 0000.1111.2222.1111.1111
#
interface Eth-Trunk10.1 mode l2
 encapsulation dot1q vid 10
 rewrite pop single
 bridge-domain 10
#
interface Eth-Trunk20
 mode lacp-static
 e-trunk 2
 esi 0001.0002.0003.0004.0005
#
interface Eth-Trunk20.1 mode l2
 encapsulation dot1q vid 20
 rewrite pop single
 bridge-domain 20
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 eth-trunk 10
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 10.2.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/4</span>
 undo shutdown
 eth-trunk 20
#
interface LoopBack1
 ip address 1.1.1.1 255.255.255.255
#
bgp 100
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack1
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 2.2.2.2 enable
  peer 3.3.3.3 enable
 #              
 l2vpn-family evpn
  undo policy vpn-target
  peer 2.2.2.2 enable
  peer 3.3.3.3 enable
#
ospf 1
 area 0.0.0.0
  network 1.1.1.1 0.0.0.0
  network 10.1.1.0 0.0.0.255
  network 10.2.1.0 0.0.0.255
#
evpn source-address 1.1.1.1
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
lacp e-trunk system-id 00e0-fc00-0000
#
evpn
 #
 mac-duplication
 #
 esi 0000.1111.2222.1111.1111
  evpn redundancy-mode all-active
 #
 esi 0001.0002.0003.0004.0005
  evpn redundancy-mode single-active
#               
evpn vpn-instance evrf1 bd-mode
 route-distinguisher 10:2
 vpn-target 11:1 export-extcommunity
 vpn-target 11:1 import-extcommunity
#
evpn vpn-instance evrf2 bd-mode
 route-distinguisher 20:2
 vpn-target 22:2 export-extcommunity
 vpn-target 22:2 import-extcommunity
#
mpls lsr-id 2.2.2.2
#
mpls
#
bridge-domain 10
 evpn binding vpn-instance evrf1
#
bridge-domain 20
 evpn binding vpn-instance evrf2
#               
mpls ldp
#
e-trunk 1
 priority 20
 peer-address 1.1.1.1 source-address 2.2.2.2
 security-key cipher %^%#!8C!"bAoc<font style="font-size:8pt" Face="Courier New" >~</font>O}UW2)%$HP4%.G9179.;&amp;Yr[GmV.PN%^%#
 authentication-mode enhanced-hmac-sha256
#
e-trunk 2
 priority 20
 peer-address 1.1.1.1 source-address 2.2.2.2
 security-key cipher %^%#GAG\Y-F%GY[GnwCkov7A&lt;e(m/cl}m86`jd6z[79<font style="font-size:8pt" Face="Courier New" >~</font>%^%#
 authentication-mode enhanced-hmac-sha256
#
interface Eth-Trunk10
 mode lacp-static
 e-trunk 1
 e-trunk mode force-master
 esi 0000.1111.2222.1111.1111
#
interface Eth-Trunk10.1 mode l2
 encapsulation dot1q vid 10
 rewrite pop single
 bridge-domain 10
#               
interface Eth-Trunk20
 mode lacp-static
 e-trunk 2
 esi 0001.0002.0003.0004.0005
#
interface Eth-Trunk20.1 mode l2
 encapsulation dot1q vid 20
 rewrite pop single
 bridge-domain 20
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 eth-trunk 20
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 10.2.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
 ip address 10.3.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/4</span>
 undo shutdown
 eth-trunk 10
#
interface LoopBack1
 ip address 2.2.2.2 255.255.255.255
#
bgp 100
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack1
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack1
 #              
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.1 enable
  peer 3.3.3.3 enable
 #
 l2vpn-family evpn
  undo policy vpn-target
  peer 1.1.1.1 enable
  peer 3.3.3.3 enable
#
ospf 1
 area 0.0.0.0
  network 2.2.2.2 0.0.0.0
  network 10.2.1.0 0.0.0.255
  network 10.3.1.0 0.0.0.255
#
evpn source-address 2.2.2.2
#               
return</pre>
</li><li><p>PE3 configuration file</p>
<pre class="screen">#
sysname PE3
#
evpn vpn-instance evrf1 bd-mode
 route-distinguisher 10:3
 vpn-target 11:1 export-extcommunity
 vpn-target 11:1 import-extcommunity
#
evpn vpn-instance evrf2 bd-mode
 route-distinguisher 20:3
 vpn-target 22:2 export-extcommunity
 vpn-target 22:2 import-extcommunity
#
mpls lsr-id 3.3.3.3
#
mpls
#
bridge-domain 10
 evpn binding vpn-instance evrf1
#
bridge-domain 20
 evpn binding vpn-instance evrf2
#
mpls ldp
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 10.1.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 10.3.1.2 255.255.255.0
 mpls           
 mpls ldp
#
interface GigabitEthernet<span>0/3/0</span>.1 mode l2
 encapsulation dot1q vid 10
 rewrite pop single
 bridge-domain 10
#
interface GigabitEthernet<span>0/3/0</span>.2 mode l2
 encapsulation dot1q vid 20
 rewrite pop single
 bridge-domain 20
#
interface LoopBack1
 ip address 3.3.3.3 255.255.255.255
#
bgp 100
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack1
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.1 enable
  peer 2.2.2.2 enable
 #
 l2vpn-family evpn
  undo policy vpn-target
  peer 1.1.1.1 enable
  peer 2.2.2.2 enable
#
ospf 1
 area 0.0.0.0
  network 3.3.3.3 0.0.0.0
  network 10.1.1.0 0.0.0.255
  network 10.3.1.0 0.0.0.255
#
evpn source-address 3.3.3.3
#
return</pre>
</li><li>CE1 configuration file<pre class="screen">#
sysname CE1
#
vlan batch 10
#
vlan 10
#
interface Vlanif10
 ip address 192.168.1.11 255.255.255.0
#
interface Eth-Trunk10
 portswitch
 port link-type trunk
 port trunk allow-pass vlan 10
 mode lacp-static
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 eth-trunk 10
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 eth-trunk 10
#
return</pre>
</li><li>CE2 configuration file<pre class="screen">#
sysname CE2
#
vlan batch 20
#
vlan 20
#
interface Vlanif20
 ip address 192.168.2.11 255.255.255.0
#
interface Eth-Trunk20
 portswitch
 port link-type trunk
 port trunk allow-pass vlan 20
 mode lacp-static
 lacp preempt enable
 max active-linknumber 1
 lacp preempt delay 180
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 eth-trunk 20
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 eth-trunk 20
#
return</pre>
</li><li>CE3 configuration file<pre class="screen">#
sysname CE3
#
vlan batch 10 20
#
vlan 10
#
vlan 20
#
interface Vlanif10
 ip address 192.168.1.12 255.255.255.0
#
interface Vlanif20
 ip address 192.168.2.12 255.255.255.0
#
interface GigabitEthernet<span>0/1/1</span>
 portswitch
 undo shutdown
 port link-type trunk
 port trunk allow-pass vlan 10 20
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0010.html">EVPN Configuration Examples
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0096.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0153.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>