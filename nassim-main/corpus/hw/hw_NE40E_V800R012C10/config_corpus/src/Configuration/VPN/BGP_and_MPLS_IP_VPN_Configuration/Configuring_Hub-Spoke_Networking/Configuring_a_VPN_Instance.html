
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Configuring a VPN Instance">
<meta name="abstract" content="A VPN instance can be configured on a PE to manage VPN routes.">
<meta name="description" content="A VPN instance can be configured on a PE to manage VPN routes.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0021.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0024.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,l3vpnvrp,w00556928,l00468467,w00606909,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="BGP/MPLS IP VPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="h00847023">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00415692">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172369274">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Configuring a VPN Instance</title>
</head>
<body><a name="EN-US_TASK_0172369274"></a><a name="EN-US_TASK_0172369274"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Configuring a VPN Instance</h1>
<div class="taskbody"><p>A VPN instance can be configured on a PE to manage VPN routes.</p>
<div class="context"><a name="EN-US_TASK_0172369274__1.4.1"></a><a name="1.4.1"></a><h4 class="sectiontitle">Context</h4>
<div class="p"><p>In the hub-spoke networking, a PE connected to a central site (hub site) is called a hub PE and a PE connected to a non-central site (spoke site) is called a spoke PE. The spoke and hub PEs must have VPN instances configured. If the hub CE is connected to the hub PE through two links, the hub PE must have two VPN instances configured, for example, <strong>vpn_in</strong> and <strong>vpn_out</strong>. If the hub CE is connected to the hub PE through a single link, the hub PE needs only one VPN instance configured, for example, <strong>vpnhub</strong>.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Steps 1 to 8 are performed to configure one VPN instance. Configurations of different VPN instances are similar. If different VPN instances are configured on the same device, each VPN instance must have a particular name, RD, and description.</p>
</div></div>
</div></div>
<div class="steps-unordered"><a name="EN-US_TASK_0172369274__1.4.2"></a><a name="1.4.2"></a><h4 class="sectiontitle">Procedure</h4>
<ul><li><span>Configure each spoke PE.</span><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ip+vpn-instance"><b><span class="cmdname">ip vpn-instance</span></b></a> <i><span class="varname">vpn-instance-name</span></i></span><p><p>The view of a VPN instance is displayed.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=description"><b><span class="cmdname">description</span></b></a> <i><span class="varname">description-information</span></i></span><p><p>The description of the VPN instance is configured.</p>
</p><p><p>The description is used to record the purpose of creating the VPN instance and the CEs connected to the VPN instance.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv4-family"><b><span class="cmdname">ipv4-family</span></b></a></span><p><p>The VPN instance IPv4 address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=route-distinguisher"><b><span class="cmdname">route-distinguisher</span></b></a> <i><span class="varname">route-distinguisher</span></i></span><p><p>An RD is set for the VPN instance<span> IPv4 address family</span>.</p>
</p><p><p>A VPN instance<span> IPv4 address family</span> takes effect only after being assigned an RD. Before setting an RD, you can configure only the description of the VPN instance, and no other parameters can be configured.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=vpn-target"><b><span class="cmdname">vpn-target</span></b></a> <i><span class="varname">vpn-target2</span></i> &amp;&lt;1-8&gt; <strong><span>import-extcommunity</span></strong></span><p><p>One or more import VPN targets are configured for the VPN instance so that the VPN instance can accept VPNv4 routes advertised by the hub PE.</p>
</p><p><p><i><span class="varname">vpn-target2</span></i> must be within the export VPN target list configured on the hub PE.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=vpn-target"><b><span class="cmdname">vpn-target</span></b></a> <i><span class="varname">vpn-target1</span></i> &amp;&lt;1-8&gt; <strong><span>export-extcommunity</span></strong></span><p><p>One or more export VPN targets are configured so that the routes of the sites that the spoke PE accesses carry the VPN target.</p>
</p><p><p><i><span class="varname">vpn-target1</span></i> must be within the import VPN target list configured on the hub PE.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=import+route-policy"><b><span class="cmdname">import route-policy</span></b></a> <i><span class="varname">policy-name</span></i></span><p><p>An import route-policy is applied to the VPN instance<span> IPv4 address family</span>.</p>
</p><p><p>In addition to using a VPN target to control the advertisement or acceptance of VPN routes, you can use an import route-policy to better control the acceptance of VPN routes. The import route-policy can be used to filter the routes to be imported to the VPN instance IPv4 address family or modify route attributes.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=export+route-policy"><b><span class="cmdname">export route-policy</span></b></a> <i><span class="varname">policy-name</span></i><span> [ <strong><span>add-ert-first</span></strong> ]</span></span><p><p>An export route-policy is applied to the VPN instance<span> IPv4 address family</span>.</p>
<p>In addition to using a VPN target to control the advertisement or acceptance of VPN routes, you can use an export route-policy to better control the advertisement of VPN routes. The export route-policy filters routes to be advertised to other PEs or modify route attributes.</p>
<p>By default, export VPN targets are added to VPN routes after these routes match an export route-policy. If the export route-policy contains VPN target-related filtering rules, the route-policy cannot apply to these routes. To prevent such rule-induced failures, configure the <strong><span>add-ert-first</span></strong> parameter to instruct the device to add export VPN targets to VPN routes before these routes are matched against the export route-policy.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=apply-label+per-instance"><b><span class="cmdname">apply-label per-instance</span></b></a></span><p><p>MPLS label allocation based on the VPN instance<span> IPv4 address family</span> (known as one label per instance) is configured. Then, all routes of the VPN instance<span> IPv4 address family</span> are assigned the same label.</p>
</p><p></p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li><li><span>Configure the hub PE (to which a hub CE is connected through two links).</span><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ip+vpn-instance"><b><span class="cmdname">ip vpn-instance</span></b></a> <i><span class="varname">vpn-instance-name1</span></i></span><p><p>The view of a VPN instance (named <strong>vpn_in</strong>) is displayed.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=description"><b><span class="cmdname">description</span></b></a> <i><span class="varname">description-information</span></i></span><p><p>The description of the VPN instance is configured.</p>
<p>The description is used to record the purpose of creating the VPN instance and the CEs connected to the VPN instance.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv4-family"><b><span class="cmdname">ipv4-family</span></b></a></span><p><p>The VPN instance IPv4 address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=route-distinguisher"><b><span class="cmdname">route-distinguisher</span></b></a> <i><span class="varname">route-distinguisher</span></i></span><p><p>An RD is set for the VPN instance<span> IPv4 address family</span>.</p>
<p>A VPN instance<span> IPv4 address family</span> takes effect only after being assigned an RD. Before setting an RD, you can configure only the description of the VPN instance, and no other parameters can be configured.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=vpn-target"><b><span class="cmdname">vpn-target</span></b></a> <i><span class="varname">vpn-target1</span></i> &amp;&lt;1-8&gt; <strong><span>import-extcommunity</span></strong></span><p><p>Import VPN targets are configured for the VPN instance<span> IPv4 address family</span> so that the VPN instance can accept VPNv4 routes advertised by all spoke PEs.</p>
</p><p><p>The <i><span class="varname">vpn-target1</span></i> list here must contain the export VPN targets configured on all spoke PEs.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=import+route-policy"><b><span class="cmdname">import route-policy</span></b></a> <i><span class="varname">policy-name</span></i></span><p><p>An import route-policy is applied to the VPN instance<span> IPv4 address family</span>.</p>
<p>In addition to using a VPN target to control the advertisement or acceptance of VPN routes, you can use an import route-policy to better control the acceptance of VPN routes. The import route-policy filters the routes to be imported to the VPN instance IPv4 address family or modify route attributes.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=export+route-policy"><b><span class="cmdname">export route-policy</span></b></a> <i><span class="varname">policy-name</span></i><span> [ <strong><span>add-ert-first</span></strong> ]</span></span><p><p>An export route-policy is applied to the VPN instance<span> IPv4 address family</span>.</p>
<p>In addition to using a VPN target to control the advertisement or acceptance of VPN routes, you can use an export route-policy to better control the advertisement of VPN routes. The export route-policy filters routes to be advertised to other PEs or modify route attributes.</p>
<p>By default, export VPN targets are added to VPN routes after these routes match an export route-policy. If the export route-policy contains VPN target-related filtering rules, the route-policy cannot apply to these routes. To prevent such rule-induced failures, configure the <strong><span>add-ert-first</span></strong> parameter to instruct the device to add export VPN targets to VPN routes before these routes are matched against the export route-policy.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a></span><p><p>Return to the system view.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ip+vpn-instance"><b><span class="cmdname">ip vpn-instance</span></b></a> <i><span class="varname">vpn-instance-name2</span></i></span><p><p>The view of a VPN instance (named <strong>vpn_out</strong>) is displayed.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=description"><b><span class="cmdname">description</span></b></a> <i><span class="varname">description-information</span></i></span><p><p>The description of the VPN instance is configured.</p>
<p>The description is used to record the purpose of creating the VPN instance and the CEs connected to the VPN instance.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv4-family"><b><span class="cmdname">ipv4-family</span></b></a></span><p><p>The VPN instance IPv4 address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=route-distinguisher"><b><span class="cmdname">route-distinguisher</span></b></a> <i><span class="varname">route-distinguisher</span></i></span><p><p>An RD is set for the VPN instance<span> IPv4 address family</span>.</p>
<p>A VPN instance<span> IPv4 address family</span> takes effect only after being assigned an RD. Before setting an RD, you can configure only the description of the VPN instance, and no other parameters can be configured.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=vpn-target"><b><span class="cmdname">vpn-target</span></b></a> <i><span class="varname">vpn-target2</span></i> &amp;&lt;1-8&gt; <strong><span>export-extcommunity</span></strong></span><p><p>Export VPN targets are configured to advertise the routes of the hub site and all spoke sites.</p>
</p><p><p>The <i><span class="varname">vpn-target2</span></i> list here must contain the import VPN targets configured on all spoke PEs.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=import+route-policy"><b><span class="cmdname">import route-policy</span></b></a> <i><span class="varname">policy-name</span></i></span><p><p>An import route-policy is applied to the VPN instance<span> IPv4 address family</span>.</p>
<p>In addition to using a VPN target to control the advertisement or acceptance of VPN routes, you can use an import route-policy to better control the acceptance of VPN routes. The import route-policy filters the routes to be imported to the VPN instance<span> IPv4 address family</span> or modify route attributes.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=export+route-policy"><b><span class="cmdname">export route-policy</span></b></a> <i><span class="varname">policy-name</span></i><span> [ <strong><span>add-ert-first</span></strong> ]</span></span><p><p>An export route-policy is applied to the VPN instance<span> IPv4 address family</span>.</p>
<p>In addition to using a VPN target to control the advertisement or acceptance of VPN routes, you can use an export route-policy to better control the advertisement of VPN routes. The export route-policy filters routes to be advertised to other PEs or modify route attributes.</p>
<p>By default, export VPN targets are added to VPN routes after these routes match an export route-policy. If the export route-policy contains VPN target-related filtering rules, the route-policy cannot apply to these routes. To prevent such rule-induced failures, configure the <strong><span>add-ert-first</span></strong> parameter to instruct the device to add export VPN targets to VPN routes before these routes are matched against the export route-policy.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=apply-label+per-instance"><b><span class="cmdname">apply-label per-instance</span></b></a></span><p><p>MPLS label distribution based on the VPN instance<span> IPv4 address family</span> (known as one label per instance) is configured. One label is assigned to all the routes of the VPN instance<span> IPv4 address family</span>.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li><li><span>Configure the hub PE (to which a hub CE is connected through a single link).</span><ol><li class="substepexpand"><span>Run <a href="cmdqueryname=system-view"><b><span class="cmdname">system-view</span></b></a></span><p><p>The system view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ip+vpn-instance"><b><span class="cmdname">ip vpn-instance</span></b></a> <i><span class="varname">vpn-instance-name1</span></i></span><p><p>The view of a VPN instance (named <strong>vpnhub</strong>) is displayed.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=description"><b><span class="cmdname">description</span></b></a> <i><span class="varname">description-information</span></i></span><p><p>The description of the VPN instance is configured.</p>
<p>The description is used to record the purpose of creating the VPN instance and the CEs connected to the VPN instance.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=ipv4-family"><b><span class="cmdname">ipv4-family</span></b></a></span><p><p>The VPN instance IPv4 address family view is displayed.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=route-distinguisher"><b><span class="cmdname">route-distinguisher</span></b></a> <i><span class="varname">route-distinguisher</span></i></span><p><p>An RD is set for the VPN instance<span> IPv4 address family</span>.</p>
<p>A VPN instance<span> IPv4 address family</span> takes effect only after being assigned an RD. Before setting an RD, you can configure only the description of the VPN instance, and no other parameters can be configured.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=vpn-target"><b><span class="cmdname">vpn-target</span></b></a> <i><span class="varname">vpn-target1</span></i> &amp;&lt;1-8&gt; <strong><span>import-extcommunity</span></strong></span><p><p>Import VPN targets are configured so that the VPN instance can accept the VPNv4 routes advertised by all spoke PEs.</p>
</p><p><p>The <i><span class="varname">vpn-target1</span></i> list here must contain the export VPN targets configured on all spoke PEs.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=vpn-target"><b><span class="cmdname">vpn-target</span></b></a> <i><span class="varname">vpn-target2</span></i> &amp;&lt;1-8&gt; <strong><span>export-extcommunity</span></strong></span><p><p>Export VPN targets are configured so that the routes advertised to all spoke sites carry this attribute.</p>
<p>The <i><span class="varname">vpn-target2</span></i> list here must contain the import VPN targets configured on all spoke PEs.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=import+route-policy"><b><span class="cmdname">import route-policy</span></b></a> <i><span class="varname">policy-name</span></i></span><p><p>An import route-policy is applied to the VPN instance<span> IPv4 address family</span>.</p>
<p>In addition to using a VPN target to control the advertisement or acceptance of VPN routes, you can use an import route-policy to better control the acceptance of VPN routes. The import route-policy filters the routes to be imported to the VPN instance<span> IPv4 address family</span> or modify route attributes.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=export+route-policy"><b><span class="cmdname">export route-policy</span></b></a> <i><span class="varname">policy-name</span></i><span> [ <strong><span>add-ert-first</span></strong> ]</span></span><p><p>An export route-policy is applied to the VPN instance<span> IPv4 address family</span>.</p>
<p>Before performing this step, you must create a route-policy that permits only default routes based on <a href="dc_vrp_route-policy_cfg_0001.html">Creating a Route-Policy</a>. Then perform this step to enable the hub PE to advertise only default routes to spoke PEs.</p>
<p>By default, export VPN targets are added to VPN routes after these routes match an export route-policy. If the export route-policy contains VPN target-related filtering rules, the route-policy cannot apply to these routes. To prevent such rule-induced failures, configure the <strong><span>add-ert-first</span></strong> parameter to instruct the device to add export VPN targets to VPN routes before these routes are matched against the export route-policy.</p>
</p></li><li class="substepexpand"><span>(Optional) Run <a href="cmdqueryname=apply-label+per-route+pop-go"><b><span class="cmdname">apply-label per-route pop-go</span></b></a></span><p><p>The device is configured to assign a label to each VPNv4 route to be sent to its BGP VPNv4 peer. Then, after the device receives a labeled data packet from its BGP VPNv4 peer, the device directly searches the ILM table for an outbound interface based on the label carried in the packet, removes the label, and forwards the packet through the found outbound interface.</p>
<p>After the <a href="cmdqueryname=apply-label+per-route+pop-go"><b><span class="cmdname">apply-label per-route pop-go</span></b></a> command is run, the hub PE records in the ILM table the mapping between the label assigned to each VPNv4 route and the outbound interface name in the route before sending a route to a spoke PE. After the hub PE receives a labeled data packet from a spoke PE, the hub PE directly searches the ILM table for an outbound interface based on the label carried in the packet, but no longer searches the IP forwarding table based on the longest-match rule. The hub PE then removes the label, and forwards the packet through the found outbound interface, therefore preventing the data packet from being forwarded to another spoke PE without passing through the hub CE.</p>
</p></li><li class="substepexpand"><span>Run <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a></span><p><p>The configuration is committed.</p>
</p></li></ol>
</li></ul></div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0021.html">Configuring Hub-Spoke Networking
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_mpls-l3vpn-v4_cfg_0024.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>