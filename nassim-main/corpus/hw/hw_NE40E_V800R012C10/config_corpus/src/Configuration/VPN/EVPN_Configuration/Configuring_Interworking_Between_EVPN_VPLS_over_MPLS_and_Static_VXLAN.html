
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Configuring Interworking Between EVPN VPLS over MPLS and Static VXLAN">
<meta name="abstract" content="In MetroFabric scenarios with CU separation deployed, interworking between EVPN VPLS over MPLS and static VXLAN must be deployed on metro edge function (MEF) devices.">
<meta name="description" content="In MetroFabric scenarios with CU separation deployed, interworking between EVPN VPLS over MPLS and static VXLAN must be deployed on metro edge function (MEF) devices.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0000.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_l2vpn_to_evpn_cfg_0000.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_dci_cfg_0033.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="p00915595,w00800033,w00556928,l00468467,w00606909,evpnvrp,l00455378">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="featurename" content="EVPN">
<meta name="featuretype" content="VPN">
<meta name="OWNER" content="p00915595">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00878323">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172370530">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Configuring Interworking Between EVPN VPLS over MPLS and Static VXLAN</title>
</head>
<body><a name="EN-US_TASK_0172370530"></a><a name="EN-US_TASK_0172370530"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Configuring Interworking Between EVPN VPLS over MPLS and Static VXLAN</h1>
<div class="taskbody"><p>In MetroFabric scenarios with CU separation deployed, interworking between EVPN VPLS over MPLS and static VXLAN must be deployed on metro edge function (MEF) devices.</p>
<div class="context"><a name="EN-US_TASK_0172370530__1.4.1"></a><a name="1.4.1"></a><h4 class="sectiontitle">Context</h4>
<div class="p"><p>In a MetroFabric scenario with CU separation deployed (as shown in <a href="#EN-US_TASK_0172370530__fig_dc_vrp_evpn_cfg_015401">Figure 1</a>), MPLS EVPN runs on the metro network, and static VXLAN tunnels are established between the MEF devices and vBRAS-UPs. Therefore, the MEF1 and MEF2 devices must support interworking between EVPN VPLS over MPLS and static VXLAN to establish E2E forwarding paths for traffic.</p>
<div class="fignone" id="EN-US_TASK_0172370530__fig_dc_vrp_evpn_cfg_015401"><a name="EN-US_TASK_0172370530__fig_dc_vrp_evpn_cfg_015401"></a><a name="fig_dc_vrp_evpn_cfg_015401"></a><span class="figcap"><b>Figure 1 </b>Interworking between EVPN VPLS over MPLS and static VXLAN</span><br><span><img class="vsd" src="images/fig_dc_vrp_evpn_cfg_015401.png"></span></div>
<p>This interworking scenario supports the following key functions:</p>
<ul><li><p>MEF1 and MEF2 learn MAC routes on the static VXLAN tunnel side.</p>
</li><li><p>A VXLAN EVPN peer relationship is established between MEF1 and MEF2. Both MEF1 and MEF2 can re-originate the MAC routes learned on the static VXLAN tunnel side and flood the MAC routes through BGP EVPN.</p>
</li><li><p>An MPLS EVPN peer relationship is established between MEF1 and MEF2. MEF1 and MEF2 flood ES routes to each other and support DF election.</p>
</li><li><p>MEF1 and MEF2 advertise the MAC routes (maybe the re-originated MAC routes) learned on the static VXLAN tunnel side to MEF3 (the BGP EVPN peer on the MPLS EVPN side) through EVPN. MAC load balancing is implemented on MEF3.</p>
</li><li><p>MAC mobility is supported between MEF1 and MEF2.</p>
</li></ul>
</div></div>
<div class="context"><a name="EN-US_TASK_0172370530__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Pre-configuration Tasks</h4><p>Before configuring interworking between EVPN VPLS over MPLS and static VXLAN, complete the following tasks:</p>
<ul><li><p>Configure <a href="dc_vrp_evpn_cfg_0065.html">EVPN VPLS over MPLS (BD EVPN instance)</a> between MEF1 and MEF3 and between MEF2 and MEF3.</p>
</li><li><p>Configure BD MPLS EVPN. To allow MEF1 and MEF2 to implement load balancing, configure the same ESI in the BDs on MEF1 and MEF2.</p>
</li><li><p>Configure VXLAN tunnels between MEF1, MEF2, and vBRAS-UPs. MEF1 and MEF2 function as aggregation devices, and vBRAS-UPs function as BRASs. Currently, only static VXLAN tunnels can be established.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>MEF1 and MEF2 form the anycast relationship. Therefore, the same source VTEP IP address must be configured for MEF1 and MEF2.</p>
</div></div>
</li></ul>
<p>After the pre-configuration tasks are complete, perform the following operations.</p>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172370530__1.4.3"></a><a name="1.4.3"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure a BGP EVPN peer relationship between MEF1 and MEF2.</span><ol type="a"><li class="substepexpand"><span>Run the <a href="cmdqueryname=bgp"><b><span class="cmdname">bgp</span></b></a> <i><span class="varname">as-number</span></i> command to enable BGP and enter its view.</span></li><li class="substepexpand"><span>(Optional) Run the <a href="cmdqueryname=router-id"><b><span class="cmdname">router-id</span></b></a> <i><span class="varname">ipv4-address</span></i> command to configure a BGP router ID.</span></li><li class="substepexpand"><span>Run the <a href="cmdqueryname=peer+as-number"><b><span class="cmdname">peer</span></b></a> <i><span class="varname">ipv4-address</span></i> <strong><span>as-number</span></strong> <i><span class="varname">as-number</span></i> command to configure the remote device as a peer.</span></li><li class="substepexpand"><span>(Optional) Run the <a href="cmdqueryname=peer+connect-interface"><b><span class="cmdname">peer</span></b></a> <i><span class="varname">ipv4-address</span></i> <strong><span>connect-interface</span></strong> <i><span class="varname">interface-type</span></i> <i><span class="varname">interface-number</span></i> [ <i><span class="varname">ipv4-source-address</span></i> ] command to specify the source interface and source address for the setup of a TCP connection with the BGP peer.</span><p><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If loopback interfaces are used to establish a BGP connection, it is recommended that the <a href="cmdqueryname=peer+connect-interface"><b><span class="cmdname">peer connect-interface</span></b></a> command be run on both ends to ensure correct connection. If this command is run on only one end, the BGP connection may fail to be established.</p>
</div></div>
</p></li><li class="substepexpand"><span>(Optional) Run the <a href="cmdqueryname=peer+ebgp-max-hop"><b><span class="cmdname">peer</span></b></a> <i><span class="varname">ipv4-address</span></i> <a href="cmdqueryname=ebgp-max-hop"><b><span class="cmdname">ebgp-max-hop</span></b></a> [ <i><span class="varname">hop-count</span></i> ] command to set the maximum number of hops allowed for an EBGP EVPN connection.</span><p><p>Generally, EBGP EVPN peers are directly connected. If they are not directly connected, run the <a href="cmdqueryname=peer+ebgp-max-hop"><b><span class="cmdname">peer ebgp-max-hop</span></b></a> command to allow the EBGP EVPN peers to establish a multi-hop TCP connection.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If loopback interfaces are used for an EBGP EVPN connection, the <a href="cmdqueryname=peer+ebgp-max-hop"><b><span class="cmdname">peer ebgp-max-hop</span></b></a> command must be run, with the <i><span class="varname">hop-count</span></i> value greater than or equal to 2. If this configuration is absent, the EBGP EVPN connection fails to be established.</p>
</div></div>
</p></li><li class="substepexpand"><span>Run the <a href="cmdqueryname=l2vpn-family+evpn"><b><span class="cmdname">l2vpn-family evpn</span></b></a> command to enter the BGP EVPN address family view.</span></li><li class="substepexpand"><span>Run the <a href="cmdqueryname=peer+enable"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv4-address</span></i> | <i><span class="varname">group-name</span></i> } <strong><span>enable</span></strong> command to enable the function to exchange EVPN routes with a specified peer or peer group.</span></li><li class="substepexpand"><span>Run the <a href="cmdqueryname=peer+advertise+encap-type"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv4-address</span></i> | <i><span class="varname">group-name</span></i> } <strong><span>advertise encap-type vxlan</span></strong> command to configure the function to advertise EVPN routes carrying the VXLAN encapsulation attribute to peers.</span></li><li class="substepexpand"><span>(Optional) Run the <a href="cmdqueryname=peer+route-policy"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">group-name</span></i> | <i><span class="varname">ipv4-address</span></i> } <strong><span>route-policy</span></strong> <i><span class="varname">route-policy-name</span></i> { <strong><span>import</span></strong> | <strong><span>export</span></strong> } command to specify a route-policy for the routes received from or to be advertised to a BGP EVPN peer or peer group.</span><p><p>After the route-policy is applied, the routes received from or to be advertised to a specified BGP EVPN peer or peer group will be filtered, ensuring that only desired routes are imported or advertised. This configuration helps manage routes and reduce required routing entries and system resources.</p>
</p></li><li class="substepexpand"><span>(Optional) Run the <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">group-name</span></i> | <i><span class="varname">ipv4-address</span></i> } <strong><span>next-hop-invariable</span></strong> command to enable the device to advertise routes to an EBGP EVPN peer without changing the next hop. If an EBGP EVPN peer relationship has been established between a spine node and a gateway, run the <a href="cmdqueryname=peer+next-hop-invariable"><b><span class="cmdname">peer next-hop-invariable</span></b></a> command on the spine node to ensure that the next hop of the routes received by this gateway is another gateway</span></li><li class="substepexpand"><span>(Optional) Run the <a href="cmdqueryname=peer+mac-limit"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">group-name</span></i> | <i><span class="varname">ipv4-address</span></i> } <a href="cmdqueryname=mac-limit"><b><span class="cmdname">mac-limit</span></b></a> <i><span class="varname">number</span></i> [ <i><span class="varname">percentage</span></i> ] [ <strong><span>alert-only</span></strong> | <strong><span>idle-forever</span></strong> | <strong><span>idle-timeout</span></strong> <i><span class="varname">times</span></i> ] command to configure the maximum number of MAC advertisement routes that can be received from a peer.</span><p><p>If an EVPN instance imports many invalid MAC advertisement routes from peers and these routes account for a large proportion of the total MAC advertisement routes, run the command to configure the maximum number of MAC advertisement routes that can be received from each peer. If the number of received MAC advertisement routes exceeds the specified maximum number, the system displays an alarm, instructing users to check the validity of the MAC advertisement routes received in the EVPN instance.</p>
</p></li></ol>
</li><li><span>Configure the function to re-originate EVPN routes between MEF1 and MEF2.</span><ol type="a"><li><span>Run the <a href="cmdqueryname=peer+import+reoriginate"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv4-address</span></i> | <i><span class="varname">group-name</span></i> } <strong><span>import</span></strong> <strong><span>reoriginate</span></strong> command to configure the device to add a re-origination flag to routes received from the BGP EVPN peer.</span></li><li><span>Run the <a href="cmdqueryname=peer+advertise+route-reoriginated"><b><span class="cmdname">peer</span></b></a> { <i><span class="varname">ipv4-address</span></i> | <i><span class="varname">group-name</span></i> } <strong><span>advertise</span></strong> <strong><span>route-reoriginated</span></strong> <strong><span>evpn</span></strong> <strong><span>mac</span></strong> command to configure the function to re-originate MAC routes through EVPN and send the re-originated MAC routes to a specified BGP EVPN peer.</span></li><li><span>Run the <a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a> command to exit the BGP EVPN address family view.</span></li><li><span>Run the <a href="cmdqueryname=quit"><b><span class="cmdname">quit</span></b></a> command to exit the BGP view.</span></li></ol>
</li><li><span>Enable MEF1 and MEF2 to advertise the MAC routes (maybe the re-originated MAC routes) learned on the static VXLAN tunnel side to the BGP EVPN peer on the MPLS EVPN side through EVPN.</span><ol type="a"><li><span>Run the <a href="cmdqueryname=evpn"><b><span class="cmdname">evpn</span></b></a> command to enter the global EVPN configuration view.</span></li><li><span>Run the <a href="cmdqueryname=advertise+vxlan-tunnel+mac"><b><span class="cmdname">advertise vxlan-tunnel mac</span></b></a> command to enable the device to advertise the MAC routes on the static VXLAN tunnel side to the BGP EVPN peers on the MPLS EVPN side through EVPN.</span></li></ol>
</li><li><span>Run the <a href="cmdqueryname=commit"><b><span class="cmdname">commit</span></b></a> command to commit the configuration.</span></li></ol></div>
<div class="postreq"><a name="EN-US_TASK_0172370530__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Verifying the Configuration</h4><p>Run the <a href="cmdqueryname=display+bgp+evpn+all+routing-table"><b><span class="cmdname">display bgp evpn all routing-table</span></b></a> <strong><span>mac-route</span></strong> [ <i><span class="varname">prefix</span></i> ] command on MEF1, MEF2, and MEF3 to view details about EVPN MAC routes.</p>
</div></div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_evpn_cfg_0000.html">EVPN Configuration
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_l2vpn_to_evpn_cfg_0000.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_dci_cfg_0033.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>