
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring GRE over IPsec">
<meta name="abstract" content="IPsec supports the transmission of unicast IP packets only. To support the transmission of multicast and broadcast packets on an IPsec-enabled network, you can configure GRE over IPsec.">
<meta name="description" content="IPsec supports the transmission of unicast IP packets only. To support the transmission of multicast and broadcast packets on an IPsec-enabled network, you can configure GRE over IPsec.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipsec_cfg_all_0040.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipsec_cfg_0042.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,z00603461,ipsec,w00556928,w00606909,h00522387,l00455378,z00805567">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="OWNER" content="z00485179">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="z00485179">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172372475">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/thickbox.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/imageResize.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery-migrate-1.2.1.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery-ui.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery.mousewheel.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/thickbox.js"></script>
<title>Example for Configuring GRE over IPsec</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172372475"></a><a name="EN-US_TASK_0172372475"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring GRE over IPsec</h1>
<div class="taskbody"><p>IPsec supports the transmission of unicast IP packets only. To support the transmission of multicast and broadcast packets on an IPsec-enabled network, you can configure GRE over IPsec.</p>
<div class="context"><a name="EN-US_TASK_0172372475__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p><a href="#EN-US_TASK_0172372475__fig1">Figure 1</a> shows the network.</p>
<div class="fignone" id="EN-US_TASK_0172372475__fig1"><a name="EN-US_TASK_0172372475__fig1"></a><a name="fig1"></a><span class="figcap"><b>Figure 1 </b>Networking diagram of GRE over IPsec</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>In this example, interface1 and interface2 represent GE<span>0/1/1</span> and GE<span>0/1/2</span>, respectively.</p>
</div></div>
<br><span><img class="imgResize" src="images/fig_dc_vrp_ipsec_cfg_003501.png" width="518.7" height="133.851333" title="Click to enlarge"></span><br></div>
<ul><li><p>Network A belongs to the subnet 10.1.1.0/24 and connects to <span class="keyword">Device</span>A through GE<span>0/1/1</span>.</p>
</li><li><p>Network B belongs to the subnet 10.1.2.0/24 and connects to <span class="keyword">Device</span>B through GE<span>0/1/1</span>.</p>
</li><li><p>Routes between <span class="keyword">Device</span>A and <span class="keyword">Device</span>B are reachable.</p>
</li></ul>
<div class="p">The network is required to implement the following functions:<ul><li><p>Transmits multicast and broadcast packets, which are not supported by IPsec, between PCA and PCB.</p>
</li><li><p>Encrypts the packets transmitted between PCA and PCB.</p>
</li></ul>
</div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172372475__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Establish a GRE tunnel between <span class="keyword">Device</span>A and <span class="keyword">Device</span>B to encapsulate multicast and broadcast packets through GRE.</p>
</li><li><div class="p">Establish an IPsec tunnel between <span class="keyword">Device</span>A and <span class="keyword">Device</span>B to encrypt GRE-encapsulated packets through IPsec.<ul><li>Configure ESP as the security protocol for an IPsec proposal. Specify the authentication algorithm SHA2-256 and the encryption algorithm AES-256 for ESP.</li><li>Configure an IKE proposal. Specify SHA2-256 and pre-shared key authentication as the authentication algorithm and authentication method, respectively. In addition, set the DH group identifier used for key negotiation to group14.</li></ul>
</div>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172372475__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li>IP addresses of interfaces</li><li>Tunnel modes and IP addresses of tunnel interfaces; tunnel source and destination addresses</li><li>IP address segment of each subnet</li><li>Pre-shared key</li><li>Security protocol, encryption algorithm, and authentication algorithm to be used for the IPsec proposals</li><li>Authentication algorithm to be used for the IKE proposals</li></ul>
</div></div>
<div class="steps-unordered"><a name="EN-US_TASK_0172372475__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ul><li><span>Configure <span class="keyword">Device</span>A.</span><ol><li class="substepexpand"><span>Configure IP addresses for interfaces.</span><p><ol type="a"><li><p>Configure an IP address for GE<span>0/1/1</span>.</p>
<pre class="screen">&lt;<span class="keyword">Device</span>A&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>interface GigabitEthernet <span>0/1/1</span></strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/1</span>] <strong>ip address 10.1.1.1 24</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</li><li><p>Configure an IP address for GE<span>0/1/2</span>.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>interface GigabitEthernet <span>0/1/2</span></strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/2</span>] <strong>ip address 172.16.163.1 24</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</li><li><p>Configure an IP address for Loopback1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>interface loopback1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Loopback1] <strong>ip address 1.1.1.1 255.255.255.255 </strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Loopback1] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</li></ol>
</p></li><li class="substepexpand"><span>Enable IPsec.</span><p><div class="note" id="EN-US_TASK_0172372475__en-us_task_0172372456_note1782843183112"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p id="EN-US_TASK_0172372475__en-us_task_0172372456_p117511759135415">Before configuring IPsec on the main control board, you do not need to enable IPsec. However, before configuring IPsec on the VSUP, run the <a href="cmdqueryname=undo+vsm+on-board-mode+disable"><b><span class="cmdname" id="EN-US_TASK_0172372475__en-us_task_0172372456_cmdname875120597541">vsm on-board-mode disable</span></b></a> command in the system view and then perform the following steps to enable this function. After the <a href="cmdqueryname=undo+vsm+on-board-mode+disable"><b><span class="cmdname" id="EN-US_TASK_0172372475__en-us_task_0172372456_cmdname170645338343411">vsm on-board-mode disable</span></b></a> command is run, IPsec cannot be configured on the main control board.</p>
<p id="EN-US_TASK_0172372475__en-us_task_0172372456_p139996451366">Only the following models support this configuration:</p>
<p id="EN-US_TASK_0172372475__en-us_task_0172372456_p18999144516617">NE40E-M2K</p>
<p id="EN-US_TASK_0172372475__en-us_task_0172372456_p8084616613">NE40E-M2K-B</p>
</div></div>
</p><p><pre class="screen" id="EN-US_TASK_0172372475__en-us_task_0172372456_screen782853183115">[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword6829931133113"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword2082973173110">Device</span>A] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b1282973118312">license</strong></pre>
<pre class="screen" id="EN-US_TASK_0172372475__en-us_task_0172372456_screen2829163116314">[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword1982993115311"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword178291931133117">Device</span>A-license] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b10829163183117">active ipsec bandwidth-enhance 40 slot </strong><strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b7829143143114"><span>1</span></strong></pre>
<pre class="screen" id="EN-US_TASK_0172372475__en-us_task_0172372456_screen1182933111315">[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword20829123120314">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword6829203163112">Device</span>A-license] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b1682903116315">quit</strong></pre>
<pre class="screen" id="EN-US_TASK_0172372475__en-us_task_0172372456_screen0829143113314">[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword148294313313">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword1682916312314">Device</span>A] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b7829193173114">commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure an IPsec service-instance group.</span><p><pre class="screen" id="EN-US_TASK_0172372475__en-us_task_0172372456_screen1955217205107">[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword18368112072915"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword203689202297">Device</span>A] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b174511145153516">service-location 1</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword67402020182319">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword1174012072316">Device</span>A-service-location-1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b17740420152317">location slot <span>1</span></strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword620412816254">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword620418289256">Device</span>A-service-location-1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b12204128152517">commit</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword10565183582515"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword19565435132513">Device</span>A-service-location-1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b6565173514253">quit</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword18171104111252"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword4172184110257">Device</span>A] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b141728413259">service-instance-group group1</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword5278104714252">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword1127834732511">Device</span>A-service-instance-group-group1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b17278447112512">service-location 1</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword568811528251">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword206881752172518">Device</span>A-service-instance-group-group1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b2688155215258">commit</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword15762645264"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword1176212402610">Device</span>A-service-instance-group-group1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b276210420264">quit</strong></pre>
</p></li><li class="substepexpand"><span>Create and configure a tunnel interface.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>interface loopback1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Loopback1] <strong>binding tunnel gre</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Loopback1] <strong>quit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>interface Tunnel 2</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel2] <strong>tunnel-protocol gre</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel2] <strong>ip address 172.21.1.1 24</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel2] <strong>source loopback1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel2] <strong>destination 2.2.2.2</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel2] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>interface Tunnel 1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel1] <strong>tunnel-protocol ipsec</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel1] <strong>ip address 172.19.1.1 24</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel1] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure a static route to network B. Assume that the next hop address of <span class="keyword">Device</span>A is 172.16.163.2/24.</span><p><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>When configuring a static route to steer IPsec traffic to an IPsec tunnel, you need to configure the IPsec tunnel interface as the outbound interface of the static route and specify the next hop address.</p>
</div></div>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>ip route-static 10.1.2.2 255.255.255.255 Tunnel 2 2.2.2.2</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>ip route-static 2.2.2.2 255.255.255.255 Tunnel 1 172.20.1.2</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>ip route-static 172.20.1.2 255.255.255.255 172.16.163.2</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure an advanced ACL numbered 3000 to define the data flows to be protected.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>acl 3000</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-acl-adv-3000] <strong>rule permit gre source 1.1.1.1 0.0.0.0 destination 2.2.2.2 0.0.0.0</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-acl-adv-3000] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure an IPsec proposal named <strong>tran1</strong>.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>ipsec proposal tran1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-proposal-tran1] <strong>encapsulation-mode tunnel</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-proposal-tran1] <strong>transform esp</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-proposal-tran1] <strong>esp authentication-algorithm sha2-256</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-proposal-tran1] <strong>esp encryption-algorithm aes 256</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-proposal-tran1] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure an IKE proposal numbered 10.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>ike proposal 10</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-proposal-10] <strong>authentication-method pre-share</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-proposal-10] <strong>authentication-algorithm sha2-256</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-proposal-10] <strong>integrity-algorithm hmac-sha2-256</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-proposal-10] <strong>dh group14</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-proposal-10] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure an IKE peer named <strong>b</strong>.</span><p><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The pre-shared key configured on the local device must be the same as that configured on the peer device.</p>
</div></div>
</p><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>ike peer b</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-peer-b] <strong>ike-proposal 10</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-peer-b] <strong>remote-address 172.20.1.2</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-peer-b] <strong>pre-shared-key abcde</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>A-ike-peer-b] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure an IPsec policy named <strong>map1</strong> and numbered 10.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>ipsec policy map1 10 isakmp</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-policy-isakmp-map1-10] <strong>security acl 3000</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-policy-isakmp-map1-10] <strong>proposal tran1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-policy-isakmp-map1-10] <strong>ike-peer b</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-ipsec-policy-isakmp-map1-10] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Apply the IPsec policy <strong>map1</strong> to the tunnel interface.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>A] <strong>interface Tunnel 1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel1] <strong>ipsec policy map1<span> service-instance-group group1</span></strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A-Tunnel1] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>A] <strong>commit</strong></pre>
</p></li></ol>
</li><li><span>Configure <span class="keyword">Device</span>B.</span><ol><li class="substepexpand"><span>Configure IP addresses for interfaces.</span><p><ol type="a"><li><p>Configure an IP address for GE<span>0/1/1</span>.</p>
<pre class="screen">&lt;<span class="keyword">Device</span>B&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>interface GigabitEthernet <span>0/1/1</span></strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/1</span>] <strong>ip address 10.1.2.1 24</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
</li><li><p>Configure an IP address for GE<span>0/1/2</span>.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>interface GigabitEthernet <span>0/1/2</span></strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/2</span>] <strong>ip address 172.16.169.1 24</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
</li><li><p>Configure an IP address for Loopback1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>interface loopback1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Loopback1] <strong>ip address 2.2.2.2 255.255.255.255 </strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Loopback1] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
</li></ol>
</p></li><li class="substepexpand"><span>Enable IPsec.</span><p><div class="note" id="EN-US_TASK_0172372475__en-us_task_0172372456_note20377361264"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p id="EN-US_TASK_0172372475__en-us_task_0172372456_p0951125712617">Before configuring IPsec on the main control board, you do not need to enable IPsec. However, before configuring IPsec on the VSUP, run the <a href="cmdqueryname=undo+vsm+on-board-mode+disable"><b><span class="cmdname" id="EN-US_TASK_0172372475__en-us_task_0172372456_cmdname595185712619">vsm on-board-mode disable</span></b></a> command in the system view and then perform the following steps to enable this function. After the <a href="cmdqueryname=undo+vsm+on-board-mode+disable"><b><span class="cmdname" id="EN-US_TASK_0172372475__en-us_task_0172372456_cmdname197159515443411">vsm on-board-mode disable</span></b></a> command is run, IPsec cannot be configured on the main control board.</p>
<p id="EN-US_TASK_0172372475__en-us_task_0172372456_p119522576614">Only the following models support this configuration:</p>
<p id="EN-US_TASK_0172372475__en-us_task_0172372456_p1195319571664">NE40E-M2K</p>
<p id="EN-US_TASK_0172372475__en-us_task_0172372456_p39541357563">NE40E-M2K-B</p>
</div></div>
</p><p><pre class="screen" id="EN-US_TASK_0172372475__en-us_task_0172372456_screen237336102617">[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword13783642610"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword33719361263">Device</span>B] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b2375368267">license</strong></pre>
<pre class="screen" id="EN-US_TASK_0172372475__en-us_task_0172372456_screen10371436182616">[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword14376366268"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword937336132612">Device</span>B-license] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b937236142617">active ipsec bandwidth-enhance 40 slot </strong><strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b10379362265"><span>1</span></strong></pre>
<pre class="screen" id="EN-US_TASK_0172372475__en-us_task_0172372456_screen113714368260">[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword1037173652614">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword337153692611">Device</span>B-license] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b1373366262">quit</strong></pre>
<pre class="screen" id="EN-US_TASK_0172372475__en-us_task_0172372456_screen73773612612">[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword937133615262">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword63753642610">Device</span>B] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b7376364268">commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure an IPsec service-instance group.</span><p><pre class="screen" id="EN-US_TASK_0172372475__en-us_task_0172372456_screen166436515162">[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword111029434572"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword16102154320576">Device</span>B] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b284612515345">service-location 1</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword310410271218">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword7104142718219">Device</span>B-service-location-1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b12104122715220">location slot <span>1</span></strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword101347471521">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword121344476218">Device</span>B-service-location-1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b1613415474219">commit</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword124521558329"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword14452115813216">Device</span>B-service-location-1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b84527581526">quit</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword146682129310"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword1766810125312">Device</span>B] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b2066811121738">service-instance-group group1</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword283911714316">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword118391817638">Device</span>B-service-instance-group-group1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b78392171033">service-location 1</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword75710231534">*</span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword185710231139">Device</span>B-service-instance-group-group1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b18571123335">commit</strong>
[<span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword75801230431"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword" id="EN-US_TASK_0172372475__en-us_task_0172372456_keyword458013017310">Device</span>B-service-instance-group-group1] <strong id="EN-US_TASK_0172372475__en-us_task_0172372456_b35801301310">quit</strong></pre>
</p></li><li class="substepexpand"><span>Create and configure a tunnel interface.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>interface loopback1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Loopback1] <strong>binding tunnel gre</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Loopback1] <strong>quit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>interface Tunnel 2</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Tunnel2] <strong>tunnel-protocol gre</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Tunnel2] <strong>ip address 172.21.1.2 24</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Tunnel2] <strong>source loopback1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Tunnel2] <strong>destination 1.1.1.1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Tunnel2] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>interface Tunnel 1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Tunnel1] <strong>tunnel-protocol ipsec</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Tunnel1] <strong>ip address 172.20.1.2 24</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Tunnel1] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure a static route to network A. Assume that the next hop address of <span class="keyword">Device</span>B is 172.16.169.2/24.</span><p><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>When configuring a static route to steer IPsec traffic to an IPsec tunnel, you need to configure the IPsec tunnel interface as the outbound interface of the static route and specify the next hop address.</p>
</div></div>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>ip route-static 10.1.1.2 255.255.255.255 Tunnel 2 1.1.1.1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>ip route-static 1.1.1.1 255.255.255.255 Tunnel 1 172.19.1.1 </strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>ip route-static 172.19.1.1 255.255.255.255 172.16.169.2</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure an advanced ACL numbered 3000 to define the data flows to be protected.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>acl 3000</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-acl-adv-3000] <strong>rule permit gre source 2.2.2.2 0.0.0.0 destination 1.1.1.1 0.0.0.0</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-acl-adv-3000] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure an IPsec proposal named <strong>tran1</strong>.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>ipsec proposal tran1</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-ipsec-proposal-tran1] <strong>encapsulation-mode tunnel</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-ipsec-proposal-tran1] <strong>transform esp</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-ipsec-proposal-tran1] <strong>esp authentication-algorithm sha2-256</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-ipsec-proposal-tran1] <strong>esp encryption-algorithm aes 256</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-ipsec-proposal-tran1] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure an IKE proposal numbered 10.</span><p><div class="p"><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>ike proposal 10</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-ike-proposal-10] <strong>authentication-method pre-share</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-ike-proposal-10] <strong>authentication-algorithm sha2-256</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-ike-proposal-10] <strong>integrity-algorithm hmac-sha2-256</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-ike-proposal-10] <strong>dh group14</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-ike-proposal-10] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
</div>
</p></li><li class="substepexpand"><span>Configure an IKE peer named <strong>a</strong>.</span><p><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The pre-shared key configured on the local device must be the same as that configured on the peer device.</p>
</div></div>
</p><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>ike peer a</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-ike-peer-a] <strong>ike-proposal 10</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-ike-peer-a] <strong>remote-address 172.19.1.1</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-ike-peer-a] <strong>pre-shared-key abcde</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-ike-peer-a] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Configure an IPsec policy named <strong>map1</strong> and numbered 10.</span><p><div class="p"><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>ipsec policy map1 10 isakmp</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-ipsec-policy-isakmp-map1-10] <strong>security acl 3000</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-ipsec-policy-isakmp-map1-10] <strong>proposal tran1</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-ipsec-policy-isakmp-map1-10] <strong>ike-peer a</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-ipsec-policy-isakmp-map1-10] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
</div>
</p></li><li class="substepexpand"><span>Apply the IPsec policy <strong>map1</strong> to the tunnel interface.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">Device</span>B] <strong>interface Tunnel1</strong> 
[<span class="keyword">*</span><span class="keyword">Device</span>B-Tunnel1] <strong>ipsec policy map1<span> service-instance-group group1</span></strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B-Tunnel1] <strong>quit</strong>
[<span class="keyword">*</span><span class="keyword">Device</span>B] <strong>commit</strong></pre>
</p></li></ol>
</li></ul></div>
<div class="example"><a name="EN-US_TASK_0172372475__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p><span class="keyword">Device</span>A configuration file</p>
<pre class="screen">#
 sysname <span class="keyword">Device</span>A</pre>
<pre class="screen">#
license
 active ipsec bandwidth-enhance 40 slot <span>1</span> //Perform this configuration for the VSUP.</pre>
<pre class="screen">#
service-location 1
 location slot <span>1</span>
#
service-instance-group group1
 service-location 1</pre>
<pre class="screen">#
acl number 3000
  rule 5 permit gre source 1.1.1.1 0 destination 2.2.2.2 0
#
ike proposal 10
 encryption-algorithm aes-cbc 256
 dh group14
 authentication-algorithm sha2-256
 integrity-algorithm hmac-sha2-256
#
ike peer b
 pre-shared-key %$%$THBGMJK2659z"C(T{J"-,.2n%$%$
 ike-proposal 10
 remote-address 172.20.1.2
#
ipsec proposal tran1
 esp authentication-algorithm sha2-256
 esp encryption-algorithm aes 256
#
ipsec policy map1 10 isakmp
 security acl 3000
 ike-peer b
 proposal tran1
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.0
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 172.16.163.1 255.255.255.0
#
interface loopback1
 ip address 1.1.1.1 255.255.255.255 
 binding tunnel gre
#
interface Tunnel1 
 ip address 172.19.1.1 255.255.255.0
 tunnel-protocol ipsec
 ipsec policy map1<span> service-instance-group group1</span>
#
interface Tunnel2 
 ip address 172.21.1.1 255.255.255.0
 tunnel-protocol gre
 source loopback1
 destination 2.2.2.2
#
 ip route-static 10.1.2.2 255.255.255.255 Tunnel 2 2.2.2.2
 ip route-static 2.2.2.2 255.255.255.255 Tunnel 1 172.20.1.2
 ip route-static 172.20.1.2 255.255.255.255 172.16.163.2
#
return</pre>
</li><li><span class="keyword">Device</span>B configuration file<pre class="screen">#
 sysname <span class="keyword">Device</span>B</pre>
<pre class="screen">#
license
 active ipsec bandwidth-enhance 40 slot <span>1</span> //Perform this configuration for the VSUP.</pre>
<pre class="screen">#
service-location 1
 location slot <span>1</span>
#
service-instance-group group1
 service-location 1</pre>
<pre class="screen">#
acl number 3000
  rule 5 permit gre source 2.2.2.2 0 destination 1.1.1.1 0
#
ike proposal 10
 encryption-algorithm aes-cbc 256
 dh group14
 authentication-algorithm sha2-256 
 integrity-algorithm hmac-sha2-256
#
ike peer a
 pre-shared-key %$%$THBGMJK2659z"C(T{J"-,.2n%$%$
 ike-proposal 10
 remote-address 172.19.1.1
#
ipsec proposal tran1
 esp authentication-algorithm sha2-256
 esp encryption-algorithm aes 256
#
ipsec policy map1 10 isakmp
 security acl 3000
 ike-peer a
 proposal tran1
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 10.1.2.1 255.255.255.0
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 172.16.169.1 255.255.255.0
#
interface loopback1
 ip address 2.2.2.2 255.255.255.255
 binding tunnel gre
#
interface Tunnel1 
 ip address 172.20.1.2 255.255.255.0
 tunnel-protocol ipsec 
 ipsec policy map1<span> service-instance-group group1</span>
#
interface Tunnel2 
 ip address 172.21.1.2 255.255.255.0
 tunnel-protocol gre 
 source loopback1
 destination 1.1.1.1
#
 ip route-static 10.1.1.2 255.255.255.255 Tunnel 2 1.1.1.1
 ip route-static 1.1.1.1 255.255.255.255 Tunnel 1 172.19.1.1
 ip route-static 172.19.1.1 255.255.255.255 172.16.169.2
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipsec_cfg_all_0040.html">GRE over IPsec Scenario
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipsec_cfg_0042.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>

<script language="JavaScript">
<!--
image_size('.imgResize');
var msg_imageMax = "view original image";
var msg_imageClose = "close";
//--></script></body>
</html>