
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring an IPsec Tunnel in a NAT Traversal Scenario">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipsec_cfg_all_0042.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_example_ipsec_0005.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,z00603461,ipsec,w00556928,w00606909,h00522387,l00455378,z00805567">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="featurename" content="IPSec">
<meta name="featuretype" content="Security">
<meta name="OWNER" content="z00485179">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="z00485179">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172372521">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring an IPsec Tunnel in a NAT Traversal Scenario</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172372521"></a><a name="EN-US_TASK_0172372521"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring an IPsec Tunnel in a NAT Traversal Scenario</h1>
<div class="taskbody"><div class="context"><a name="EN-US_TASK_0172372521__1.3.1"></a><a name="1.3.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>If a NAT gateway exists between the local and remote devices used for IPsec negotiation, NAT traversal capabilities need to be negotiated between the two ends of the IPsec tunnel to be established. This requires both devices to support NAT traversal.</p>
<p>On the network shown in <a href="#EN-US_TASK_0172372521__fig19433292615">Figure 1</a>, a NAT gateway (NATER) is deployed between <span class="keyword">Device</span>A (egress gateway of the headquarters network) and <span class="keyword">Device</span>B (egress gateway of the branch network). Configure NAT traversal on <span class="keyword">Device</span>A and <span class="keyword">Device</span>B to allow for IPsec tunnel-based communication between them.</p>
<p>Configure ESP as the security protocol for an IPsec proposal. Specify the authentication algorithm SHA2-256 and the encryption algorithm AES-256 for ESP. Configure an IKE proposal, and use the default authentication algorithm and authentication method in the IKE proposal, which are AES-CBC and key pre-share, respectively. In addition, set the DH group identifier used for key negotiation to group14.</p>
<div class="fignone" id="EN-US_TASK_0172372521__fig19433292615"><a name="EN-US_TASK_0172372521__fig19433292615"></a><a name="fig19433292615"></a><span class="figcap"><b>Figure 1 </b>Network diagram for configuring an IPsec tunnel in a NAT traversal scenario</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 and 2 in this example represent GE<span>0/1/1</span> and GE<span>0/1/2</span>, respectively.</p>
</div></div>
<br><span><img src="figure/en-us_image_0000002171890417.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172372521__1.3.2"></a><a name="1.3.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Notes</h4><ul><li>NATER must be configured to allow for the communication between <span class="keyword">Device</span>A and <span class="keyword">Device</span>B.</li><li><span class="keyword">Device</span>A, the responder of IPsec negotiation, must use an IPsec policy template.</li><li>NAT traversal must be enabled on both <span class="keyword">Device</span>A and <span class="keyword">Device</span>B.</li><li>The data encapsulation mode can be set to tunnel only.</li><li>IKEv2 negotiation in main mode supports IPsec NAT traversal.</li><li><p>Configuring DPD is recommended.</p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172372521__1.3.3"></a><a name="1.3.3"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure <span class="keyword">Device</span>A.</span><p><pre class="screen">#
 sysname <span class="keyword">Device</span>A //Configure a hostname for the device.</pre>
<pre class="screen">#</pre>
<pre class="screen">service-location 1</pre>
<pre class="screen"> location slot <span>1</span></pre>
<pre class="screen">#</pre>
<pre class="screen">service-instance-group group1</pre>
<pre class="screen"> service-location 1</pre>
<pre class="screen">#
ike dpd interval 10 10 //Deploying DPD is recommended.
#
acl number 3000 //Configure an ACL to define the data flows to be protected.
 rule 0 permit ip source 10.1.0.0 0.0.0.255 destination 10.2.0.0 0.0.0.255
# 
ipsec proposal rta //Create an IPsec proposal.
 esp authentication-algorithm sha2-256
 esp encryption-algorithm aes 256
#
ike proposal 1 //Configure an IKE proposal.
 dh group14
#
ike peer rta //Configure an IKE peer.
 ike-proposal 1
 pre-shared-key <span>cipher </span>%^%#JvZxR2g8c;a9<font style="font-size:8pt" Face="Courier New" >~</font>FPN<font style="font-size:8pt" Face="Courier New" >~</font>n'$7`DEV&amp;=G(=Et02P/%\*!%^%# //Set the pre-shared authentication key to <strong>device</strong> (displayed in ciphertext).
 local-id-type ip //Specify the IP address format for the IKE ID.
 nat traversal //Enable NAT traversal.
# 
ipsec policy-template rta_temp 1 //Create an IPsec policy template.
 ike-peer rta
 proposal rta
 security acl 3000
#
ipsec policy rta 1 isakmp template rta_temp //Use the IPsec policy template to create an SA.
# 
interface Tunnel1
ip address 1.1.1.1 24
tunnel-protocol ipsec
ipsec policy rta<span> service-instance-group 1</span>
#
interface gigabitethernet<span>0/1/1</span>
 ip address 1.1.2.1 255.255.255.0
#
interface gigabitethernet<span>0/1/2</span>
 ip address 10.1.0.1 255.255.255.0
#
ospf 1
area 0.0.0.0
  network 1.1.2.0 0.0.0.255
#
ip route-static 192.168.0.0 255.255.0.0 Tunnel1 192.168.0.2  //Configure a static route to the network segment 192.168.0.0.
ip route-static 192.168.0.2 255.255.255.255 1.1.2.2 //Configure a static route destined for the tunnel interface of <span class="keyword">Device</span>B.
#
return</pre>
</p></li><li><span>Configure <span class="keyword">Device</span>B.</span><p><pre class="screen">#
 sysname <span class="keyword">Device</span>B //Configure a hostname for the device.</pre>
<pre class="screen">#</pre>
<pre class="screen">service-location 1</pre>
<pre class="screen"> location slot <span>1</span></pre>
<pre class="screen">#</pre>
<pre class="screen">service-instance-group group1</pre>
<pre class="screen"> service-location 1</pre>
<pre class="screen">#
ike dpd interval 10 10 //Deploying DPD is recommended.
#
acl number 3000 //Configure an ACL to define the data flows to be protected.
 rule 0 permit ip source 10.2.0.0 0.0.0.255 destination 10.1.0.0 0.0.0.255
#
ipsec proposal rtb //Create an IPsec proposal.
 esp authentication-algorithm sha2-256
 esp encryption-algorithm aes 256
#
ike proposal 1 //Configure an IKE proposal.
 dh group14
#
ike peer rtb //Configure an IKE peer.
 ike-proposal 1
 pre-shared-key <span>cipher </span>%^%#JvZxR2g8c;a9<font style="font-size:8pt" Face="Courier New" >~</font>FPN<font style="font-size:8pt" Face="Courier New" >~</font>n'$7`DEV&amp;=G(=Et02P/%\*!%^%# //Set the pre-shared authentication key to <strong>device</strong> (displayed in ciphertext).
local-id-type ip //Specify the IP address format for the IKE ID.
 remote-address 1.1.1.1 //Specify the IKE peer address.
 nat traversal //Enable NAT traversal.
#
ipsec policy rtb 1 isakmp //Configure an IPsec policy.
 security acl 3000
 ike-peer rtb
 proposal rtb
#
interface Tunnel1
ip address 192.168.0.2 24
tunnel-protocol ipsec
ipsec policy rtb<span> service-instance-group 1</span>
#
interface gigabitethernet<span>0/1/1</span>
 ip address 192.168.1.2 255.255.255.0
#
interface gigabitethernet<span>0/1/2</span>
 ip address 10.2.0.1 255.255.255.0
#
ospf 1
area 0.0.0.0
  network 192.168.1.0 0.0.0.255
#
ip route-static 10.1.0.0 255.255.255.0 Tunnel1 1.1.1.1 //Configure a static route destined for the network segment 10.1.0.0.
ip route-static 1.1.1.1 255.255.255.255 192.168.1.1 //Configure a static route destined for the tunnel interface of <span class="keyword">Device</span>A.
#
return </pre>
</p></li><li><span>Configure NATER.</span><p><pre class="screen">#
 sysname NATER //Configure a hostname for the device.
#
 license
  active nat session-table size 2 slot 1 <strong></strong>
  active nat bandwidth-enhance 20 slot 1</pre>
<pre class="screen">#</pre>
<pre class="screen">service-location 1</pre>
<pre class="screen"> location slot <span>1</span></pre>
<pre class="screen">#</pre>
<pre class="screen">service-instance-group group1</pre>
<pre class="screen"> service-location 1</pre>
<pre class="screen">#
nat instance nat1 id 1
<span> service-instance-group 1
</span> nat address-group address-group1 group-id 1 10.34.160.101 10.34.160.105
 nat outbound any address-group address-group1
#
acl number 3000 //Configure an ACL to define the data flows to be processed by NAT.
 rule 0 permit ip source 192.168.0.0 0.0.0.255 destination 1.1.1.0 0.0.0.255
#
interface gigabitethernet<span>0/1/1</span>
 ip address 1.1.2.2 255.255.255.0
 nat bind acl 3000 instance nat1 //Configure an outbound NAT traffic diversion policy.
#
interface gigabitethernet<span>0/1/2</span>
 ip address 192.168.1.1 255.255.255.0
#
ospf 1
 import-route unr
 area 0.0.0.0
  network 1.1.2.0 0.0.0.255
  network 192.168.1.0 0.0.0.255
#
ip route-static 1.1.1.1 32 1.1.2.1 //Configure a static route destined for the tunnel interface of <span class="keyword">Device</span>A.
ip route-static 192.168.0.2 32 192.168.1.2 //Configure a static route destined for the tunnel interface of <span class="keyword">Device</span>B.
#
return</pre>
</p></li><li><span>Verify the configuration.</span><p><p>Perform a ping operation to trigger IPsec session establishment. Then, run the <strong>display ike sa verbose remote</strong> <i><span class="varname">ip-address</span></i> and <strong>display ipsec sa</strong> commands on <span class="keyword">Device</span>A to check the configuration of the established IPsec tunnel.</p>
</p></li></ol></div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_ipsec_cfg_all_0042.html">IPsec NAT Traversal Scenario
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_example_ipsec_0005.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>