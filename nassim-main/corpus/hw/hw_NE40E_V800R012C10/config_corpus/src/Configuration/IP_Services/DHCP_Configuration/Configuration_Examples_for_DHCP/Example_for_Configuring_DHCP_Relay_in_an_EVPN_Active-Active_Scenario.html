
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring DHCP Relay in an EVPN Active-Active Scenario">
<meta name="abstract" content="">
<meta name="description" content="">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_dhcp_relay_cfg_0010.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_dhcp_server_cfg_0022.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,z00485179,w00556928,w00606909">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="DHCP">
<meta name="featuretype" content="IP Services">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="DHCP">
<meta name="featuretype" content="IP Services">
<meta name="featurename" content="DHCP">
<meta name="featuretype" content="IP Services">
<meta name="featurename" content="DHCP">
<meta name="featuretype" content="IP Services">
<meta name="OWNER" content="z00485179,x00504385">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="x00504385">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0207660591">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/jquery.min.idp.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/RowOrColfreezeSupport.js"></script>

<script type="text/javascript">
setTimeout(function(){
	jQueryHW(document).ready(function(){
		jQueryHW("table[rowfreeze='yes']").rowfreeze();
		jQueryHW("table[colfreeze='yes']").colfreeze();
	});
},500);
</script>
<title>Example for Configuring DHCP Relay in an EVPN Active-Active Scenario</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0207660591"></a><a name="EN-US_TASK_0207660591"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring DHCP Relay in an EVPN Active-Active Scenario</h1>
<div class="taskbody"><p></p>
<div class="context"><a name="EN-US_TASK_0207660591__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>On the network shown in <a href="#EN-US_TASK_0207660591__fig_dc_vrp_evpn_cfg_001701">Figure 1</a>, to allow the CE and PEs to communicate, configure EVPN. DHCP needs to be deployed so that the DHCP server can assign an IP address to the DHCP client. PE1 and PE2 function as gateways, and DHCP relay needs to be deployed on them. PE3 is connected to the DHCP server.</p>
<div class="fignone" id="EN-US_TASK_0207660591__fig_dc_vrp_evpn_cfg_001701"><a name="EN-US_TASK_0207660591__fig_dc_vrp_evpn_cfg_001701"></a><a name="fig_dc_vrp_evpn_cfg_001701"></a><span class="figcap"><b>Figure 1 </b>EVPN networking</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 through 3 in this example represent GE <span>0/1/0</span>, GE <span>0/2/0</span>, and GE <span>0/3/0</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0207888427.png"></span></div>

<div class="tableBorder"><table cellpadding="4" cellspacing="0" summary="" rowfreeze="yes" frame="border" border="1" rules="all"><caption><b>Table 1 </b>Interface IP addresses</caption><thead align="left"><tr><th align="left" class="cellrowborder" valign="top" width="20.142014201420142%" id="mcps1.4.1.4.2.4.1.1" liSelected="liSelected"><p>Device</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="36.57365736573658%" id="mcps1.4.1.4.2.4.1.2" liSelected="liSelected"><p>Interface</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="43.28432843284328%" id="mcps1.4.1.4.2.4.1.3" liSelected="liSelected"><p>IP Address</p>
</th>
</tr>
</thead>
<tbody><tr><td class="cellrowborder" rowspan="4" valign="top" width="20.142014201420142%" headers="mcps1.4.1.4.2.4.1.1 "><p>PE1</p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="36.57365736573658%" headers="mcps1.4.1.4.2.4.1.2 "><p>GE <span>0/2/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="43.28432843284328%" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.2.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>GE <span>0/3/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>Loopback 1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>12.1.1.1/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>LoopBack2</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>14.1.1.1/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="4" valign="top" width="20.142014201420142%" headers="mcps1.4.1.4.2.4.1.1 "><p>PE2</p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="36.57365736573658%" headers="mcps1.4.1.4.2.4.1.2 "><p>GE <span>0/2/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="43.28432843284328%" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.2.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>GE <span>0/3/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>172.16.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>Loopback 1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>13.1.1.1/32</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>LoopBack2</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>15.1.1.1/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="4" valign="top" width="20.142014201420142%" headers="mcps1.4.1.4.2.4.1.1 "><p>PE3</p>
<p></p>
<p></p>
<p></p>
</td>
<td class="cellrowborder" valign="top" width="36.57365736573658%" headers="mcps1.4.1.4.2.4.1.2 "><p>GE <span>0/1/0</span></p>
</td>
<td class="cellrowborder" valign="top" width="43.28432843284328%" headers="mcps1.4.1.4.2.4.1.3 "><p>192.168.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>GE <span>0/2/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>172.16.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>GE <span>0/3/0</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>30.1.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.2 "><p>Loopback 1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.4.2.4.1.3 "><p>11.1.1.1/32</p>
</td>
</tr>
</tbody>
</table>
</div>
</div></div>
<div class="context"><a name="EN-US_TASK_0207660591__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li>Assign an IP address to each interface on the CE and PEs.</li><li><p>Configure an IGP on the backbone network to allow the PEs to communicate.</p>
</li><li><p>Configure basic MPLS functions, enable MPLS LDP, and establish LDP LSPs on the backbone network.</p>
</li><li><p>Configure an EVPN instance on each PE.</p>
</li><li>Bind the EVPN instance to a BD on each PE.</li><li>Configure a VPN instance on each PE, and bind the PE's loopback interface to the VPN instance to import loopback routes from the CE.</li><li>Configure a source address on each PE.</li><li><p>Configure an Eth-Trunk interface for connecting PE1 and PE2 to the CE.</p>
</li><li><p>Configure an ESI for the Eth-Trunk interface on PE1 and PE2.</p>
</li><li>Configure a service access point on PE1 and PE2.</li><li>Enable the BGP-EVPN address family, and configure peers on each PE.</li><li>Enable EVPN to generate and advertise IP prefix routes and IRB routes in a VPN instance.</li><li>Enable the VPN instance to advertise IP routes to the EVPN instance on each PE.</li><li><p>Establish a BGP EVPN peer relationship between the PEs.</p>
</li><li><p>Configure the CE, PE1, and PE2 to communicate.</p>
</li><li>Configure DHCP relay on PE1 and PE2.</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0207660591__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li><p>EVPN instance name: evpna</p>
</li><li><p>EVPN instance <strong>evpna</strong>'s RD and RT on each PE: 1:1</p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0207660591__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Assign an IP address to each interface according to <a href="#EN-US_TASK_0207660591__fig_dc_vrp_evpn_cfg_001701">Figure 1</a>. For configuration details, see <a href="#EN-US_TASK_0207660591__file1">Configuration Files</a> in this section.</span><p><p>Using the local loopback interface address of each PE as the source address is recommended.</p>
</p></li><li><span>Configure an IGP on the backbone network to allow the PEs to communicate. OSPF is used as an IGP in this example.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>network 12.1.1.1 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>network 20.1.1.1 0.0.0.0</strong></pre>
<pre class="screen">[*PE1-ospf-1-area-0.0.0.0] <strong>network 192.168.1.0 0.0.0.255</strong></pre>
<pre class="screen">[*PE1-ospf-1-area-0.0.0.0] <strong>network 192.168.2.0 0.0.0.255</strong> </pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-ospf-1] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>network 13.1.1.1 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>network 20.1.1.1 0.0.0.0</strong></pre>
<pre class="screen">[*PE2-ospf-1-area-0.0.0.0] <strong>network 172.16.1.0 0.0.0.255</strong></pre>
<pre class="screen">[*PE2-ospf-1-area-0.0.0.0] <strong>network 192.168.2.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-ospf-1] <strong>quit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-ospf-1-area-0.0.0.0] <strong>network 11.1.1.1 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-ospf-1-area-0.0.0.0] <strong>network 192.168.1.0 0.0.0.255</strong></pre>
<pre class="screen">[*PE3-ospf-1-area-0.0.0.0] <strong>network 172.16.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-ospf-1-area-0.0.0.0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3-ospf-1] <strong>quit</strong></pre>
</p></li><li><span>Configure basic MPLS functions, enable MPLS LDP, and establish LDP LSPs on the backbone network.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls lsr-id 12.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface </strong><strong>GigabitEthernet</strong> <span>0/2/0</span></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[*PE1]<strong> </strong><strong>interface GigabitEthernet </strong><span>0/3/0</span></pre>
<pre class="screen">[*PE1-GigabitEthernet<span>0/3/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[*PE1-GigabitEthernet<span>0/3/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[*PE1-GigabitEthernet<span>0/3/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE1-GigabitEthernet<span>0/3/0</span>] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls lsr-id 13.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls-ldp]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface GigabitEthernet </strong><span>0/2/0</span></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[*PE2] <strong>interface GigabitEthernet </strong><span>0/3/0</span></pre>
<pre class="screen">[*PE2-GigabitEthernet<span>0/3/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[*PE2-GigabitEthernet<span>0/3/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[*PE2-GigabitEthernet<span>0/3/0</span>] <strong>commit</strong></pre>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE2-GigabitEthernet<span>0/3/0</span>] <strong>quit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>mpls lsr-id 11.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface GigabitEthernet </strong><span>0/1/0</span></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>]<strong> mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface GigabitEthernet </strong><span>0/2/0</span></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/2/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/2/0</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
</p></li><li><span>Configure an EVPN instance on each PE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>evpn vpn-instance evpna bd-mode</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-instance-evpna] <strong>route-distinguisher 1:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-instance-evpna] <strong>vpn-target 1:1</strong> </pre>
<pre class="screen">[<span class="keyword">*</span>PE1-evpn-instance-evpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>evpn vpn-instance evpna</strong> <strong>bd-mode</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-evpn-instance-evpna] <strong>route-distinguisher 1:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-evpn-instance-evpna] <strong>vpn-target 1:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-evpn-instance-evpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>evpn vpn-instance evpna</strong> <strong>bd-mode</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-evpn-instance-evpna] <strong>route-distinguisher 1:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-evpn-instance-evpna] <strong>vpn-target 1:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-evpn-instance-evpna] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</p></li><li><span>Bind the EVPN instance to a BD on each PE.</span><p><p># Configure PE1.</p>
</p><p><pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE1] <strong>bridge-domain 1</strong></pre>
<pre class="screen">[*PE1-bd1] <strong>evpn binding vpn-instance evpna</strong></pre>
<pre class="screen">[*PE1-bd1] <strong>quit</strong></pre>
<pre class="screen">[*PE1] <strong>commit</strong></pre>
</p><p><p># Configure PE2.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE2] <strong>bridge-domain 1</strong></pre>
<pre class="screen">[*PE2-bd1] <strong>evpn binding vpn-instance evpna</strong></pre>
<pre class="screen">[*PE2-bd1] <strong>quit</strong></pre>
<pre class="screen">[*PE2] <strong>commit</strong></pre>
</p><p><p># Configure PE3.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE3] <strong>bridge-domain 1</strong></pre>
<pre class="screen">[*PE3-bd1] <strong>evpn binding vpn-instance evpna</strong></pre>
<pre class="screen">[*PE3-bd1] <strong>quit</strong></pre>
<pre class="screen">[*PE3] <strong>commit</strong></pre>
</p></li><li><span>Configure a VPN instance on each PE, and bind the PE's loopback interface to the VPN instance to import loopback routes from the CE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE1] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[*PE1-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[*PE1-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[*PE1-vpn-instance-vpna-af-ipv4] <strong>vpn-target 100:1 export-extcommunity</strong></pre>
<pre class="screen">[*PE1-vpn-instance-vpna-af-ipv4] <strong>vpn-target 100:1 export-extcommunity evpn</strong></pre>
<pre class="screen">[*PE1-vpn-instance-vpna-af-ipv4] <strong>vpn-target 100:1 import-extcommunity</strong></pre>
<pre class="screen">[*PE1-vpn-instance-vpna-af-ipv4] <strong>vpn-target 100:1 import-extcommunity evpn</strong></pre>
<pre class="screen">[*PE1-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[*PE1-vpn-instance-vpna] <strong>quit</strong></pre>
<pre class="screen">[*PE1] <strong>interface LoopBack2</strong></pre>
<pre class="screen">[*PE1-LoopBack2] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[*PE1-LoopBack2] <strong>ip address 14.1.1.1 255.255.255.255</strong></pre>
<pre class="screen">[*PE1-LoopBack2] <strong>commit</strong></pre>
<pre class="screen">[*PE1-LoopBack2] <strong>quit</strong></pre>
<pre class="screen">[*PE1] <strong>commit</strong></pre>
<p>The configurations of PE2 and PE3 are similar to the configuration of PE1.</p>
</p></li><li><span>Configure a source address on each PE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>evpn source-address 12.1.1.1</strong></pre>
<pre class="screen">[*PE1] <strong>evpn</strong></pre>
<pre class="screen">[*PE1-evpn] <strong>vlan-extend private enable</strong></pre>
<pre class="screen">[*PE1-evpn] <strong>vlan-extend redirect enable</strong></pre>
<pre class="screen">[*PE1-evpn] <strong>local-remote frr enable</strong></pre>
<pre class="screen">[*PE1-evpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>evpn source-address 13.1.1.1</strong></pre>
<pre class="screen">[*PE2] <strong>evpn</strong></pre>
<pre class="screen">[*PE2-evpn] <strong>vlan-extend private enable</strong></pre>
<pre class="screen">[*PE2-evpn] <strong>vlan-extend redirect enable</strong></pre>
<pre class="screen">[*PE2-evpn] <strong>local-remote frr enable</strong></pre>
<pre class="screen">[*PE2-evpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>evpn source-address 11.1.1.1</strong></pre>
<pre class="screen">[*PE3] <strong>evpn</strong></pre>
<pre class="screen">[*PE3-evpn] <strong>vlan-extend private enable</strong></pre>
<pre class="screen">[*PE3-evpn] <strong>vlan-extend redirect enable</strong></pre>
<pre class="screen">[*PE3-evpn] <strong>local-remote frr enable</strong></pre>
<pre class="screen">[*PE3-evpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</p></li><li><span>Configure an Eth-Trunk interface for connecting PE1 and PE2 to the CE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>lacp e-trunk system-id </strong><strong>00e0-fc12-3456</strong></pre>
<pre class="screen">[*PE1] <strong>e-trunk 1</strong></pre>
<pre class="screen">[*PE1-e-trunk-1] <strong>priority 50</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-e-trunk-1] <strong>peer-address 13.1.1.1 source-address 12.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-e-trunk-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface eth-trunk 1</strong></pre>
<pre class="screen">[*PE1-Eth-Trunk1] <strong>mode lacp-static</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk1] <strong>e-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk1] <strong>e-trunk mode force-master</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface GigabitEthernet </strong><span>0/1/0</span></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>eth-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>lacp e-trunk system-id </strong><strong>00e0-fc12-3456</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>e-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-e-trunk-1] <strong>priority 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-e-trunk-1] <strong>peer-address 12.1.1.1 source-address 13.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-e-trunk-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface eth-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk1] <strong>mode lacp-static</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk1] <strong>e-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk1] <strong>e-trunk mode force-master</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong><strong>interface GigabitEthernet </strong></strong><span>0/2/0</span></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>eth-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure the CE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE] <strong>interface eth-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Eth-Trunk1] <strong>mode lacp-static</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Eth-Trunk1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE] <strong><strong>interface Ethernet </strong></strong><span>0/1/0</span></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Ethernet<span>0/1/0</span>] <strong>eth-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Ethernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE] <strong>interface Ethernet </strong><span>0/2/0</span></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Ethernet<span>0/2/0</span>] <strong>eth-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Ethernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE] <strong>commit</strong></pre>
</p></li><li><span>Configure an ESI for the Eth-Trunk interface on PE1 and PE2.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface eth-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk1] <strong>esi 0000.0000.0000.0000.1111</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-Eth-Trunk1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface eth-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk1] <strong>esi 0000.0000.0000.0000.1111</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-Eth-Trunk1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</p></li><li><span>Configure a service access point on PE1 and PE2.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface Eth-Trunk1.1 mode l2</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-Eth-trunk1.1] <strong>encapsulation dot1q vid 100</strong></pre>
<pre class="screen">[*PE1-Eth-trunk1.1] <strong>rewrite pop single</strong></pre>
<pre class="screen">[*PE1-Eth-trunk1.1] <strong>bridge-domain 1</strong></pre>
<pre class="screen">[*PE1-Eth-trunk1.1] <strong>quit</strong></pre>
<pre class="screen">[*PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface Eth-Trunk1.1 mode l2</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-Eth-trunk1.1] <strong>encapsulation dot1q vid 100</strong></pre>
<pre class="screen">[*PE2-Eth-trunk1.1] <strong>rewrite pop single</strong></pre>
<pre class="screen">[*PE2-Eth-trunk1.1] <strong>bridge-domain 1</strong></pre>
<pre class="screen">[*PE2-Eth-trunk1.1] <strong>quit</strong></pre>
<pre class="screen">[*PE2] <strong>commit</strong></pre>
</p></li><li><span>Enable the BGP-EVPN address family, and configure peers on each PE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[*PE1-bgp] <strong>l2vpn-family evpn</strong></pre>
<pre class="screen">[*PE1-bgp-af-evpn] <strong>peer 11.1.1.1 enable</strong></pre>
<pre class="screen">[*PE1-bgp-af-evpn] <strong>peer 11.1.1.1 advertise irb</strong></pre>
<pre class="screen">[*PE1-bgp-af-evpn] <strong>peer 13.1.1.1 enable</strong></pre>
<pre class="screen">[*PE1-bgp-af-evpn] <strong>peer 13.1.1.1 advertise irb</strong></pre>
<pre class="screen">[*PE1-bgp-af-evpn] <strong>quit</strong></pre>
<pre class="screen">[*PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[*PE2-bgp] <strong>l2vpn-family evpn</strong></pre>
<pre class="screen">[*PE2-bgp-af-evpn] <strong>peer 11.1.1.1 enable</strong></pre>
<pre class="screen">[*PE2-bgp-af-evpn] <strong>peer 11.1.1.1 advertise irb</strong></pre>
<pre class="screen">[*PE2-bgp-af-evpn] <strong>peer 12.1.1.1 enable</strong></pre>
<pre class="screen">[*PE2-bgp-af-evpn] <strong>peer 12.1.1.1 advertise irb</strong></pre>
<pre class="screen">[*PE2-bgp-af-evpn] <strong>quit</strong></pre>
<pre class="screen">[*PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE3] <strong>bgp 100</strong></pre>
<pre class="screen">[*PE3-bgp] <strong>l2vpn-family evpn</strong></pre>
<pre class="screen">[*PE3-bgp-af-evpn] <strong>peer 12.1.1.1 enable</strong></pre>
<pre class="screen">[*PE3-bgp-af-evpn] <strong>peer 12.1.1.1 advertise irb</strong></pre>
<pre class="screen">[*PE3-bgp-af-evpn] <strong>peer 13.1.1.1 enable</strong></pre>
<pre class="screen">[*PE3-bgp-af-evpn] <strong>peer 13.1.1.1 advertise irb</strong></pre>
<pre class="screen">[*PE3-bgp-af-evpn] <strong>quit</strong></pre>
<pre class="screen">[*PE3] <strong>commit</strong></pre>
</p></li><li><span>Enable EVPN to generate and advertise IP prefix routes and IRB routes in a VPN instance.</span><p><p># Configure PE1.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE1] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE1-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE1-vpn-instance-vpna-af-ipv4] <strong>evpn mpls routing-enable</strong></pre>
<pre class="screen">[*PE1-vpn-instance-vpna-af-ipv4]<strong> quit</strong></pre>
<pre class="screen">[*PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE2] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE2-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE2-vpn-instance-vpna-af-ipv4] <strong>evpn mpls routing-enable</strong></pre>
<pre class="screen">[*PE2-vpn-instance-vpna-af-ipv4]<strong> quit</strong></pre>
<pre class="screen">[*PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE3] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE3-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE3-vpn-instance-vpna-af-ipv4] <strong>evpn mpls routing-enable</strong></pre>
<pre class="screen">[*PE3-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[*PE3] <strong>commit</strong></pre>
</p></li><li><span>Enable the VPN instance to advertise IP routes to the EVPN instance on each PE.</span><p><p># Configure PE1.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[*PE1-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[*PE1-bgp-vpna] <strong>import-route direct</strong></pre>
<pre class="screen">[*PE1-bgp-vpna] <strong>advertise l2vpn evpn</strong></pre>
<pre class="screen">[*PE1-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[*PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[*PE2-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[*PE2-bgp-vpna] <strong>import-route direct</strong></pre>
<pre class="screen">[*PE2-bgp-vpna] <strong>advertise l2vpn evpn</strong></pre>
<pre class="screen">[*PE2-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[*PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE3] <strong>bgp 100</strong></pre>
<pre class="screen">[*PE3-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[*PE3-bgp-vpna] <strong>import-route direct</strong></pre>
<pre class="screen">[*PE3-bgp-vpna] <strong>advertise l2vpn evpn</strong></pre>
<pre class="screen">[*PE3-bgp-vpna] <strong>quit</strong></pre>
<pre class="screen">[*PE3] <strong>commit</strong></pre>
</p></li><li><span>Establish a BGP EVPN peer relationship between the PEs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 11.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 11.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[*PE1-bgp] <strong>peer 13.1.1.1 as-number 100</strong></pre>
<pre class="screen">[*PE1-bgp] <strong>peer 13.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 192.168.1.1 as-number 100</strong></pre>
<pre class="screen">[*PE1-bgp] <strong>peer 192.168.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 11.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 11.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[*PE2-bgp] <strong>peer 12.1.1.1 as-number 100</strong></pre>
<pre class="screen">[*PE2-bgp] <strong>peer 12.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 172.16.1.2 as-number 100</strong></pre>
<pre class="screen">[*PE2-bgp] <strong>peer 192.168.2.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 12.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 12.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 13.1.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp]<strong> peer 13.1.1.1 connect-interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 192.168.1.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 172.16.1.1 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</p></li><li><span>Configure the CE, PE1, and PE2 to communicate.</span><p><p># Configure the CE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE] <strong>vlan batch 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE] <strong>interface Eth-Trunk1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Eth-Trunk20] <strong>portswitch</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Eth-Trunk20] <strong>port link-type trunk</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Eth-Trunk20] <strong>port trunk allow-pass vlan 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Eth-Trunk20] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE] <strong>interface ethernet</strong><span>0/3/0</span></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Ethernet<span>0/3/0</span>] <strong>portswitch</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Ethernet<span>0/3/0</span>] <strong>port link-type trunk</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Ethernet<span>0/3/0</span>] <strong>port trunk allow-pass vlan 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-Ethernet<span>0/3/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE] <strong>commit</strong></pre>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>vlan batch 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface GigabitEthernet</strong><span>0/1/0</span></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>eth-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</p><p><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>vlan batch 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface GigabitEthernet</strong><span>0/1/0</span></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>eth-trunk 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</p></li><li><span>Configure DHCP relay on PE1 and PE2.</span><p><p># Configure PE1.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE1] <strong>interface Vbdif 1</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>ip address 10.1.1.1 255.255.255.0</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>arp broadcast-detect enable</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>arp expire-time 86400</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>dhcp select relay</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>ip relay address 30.1.1.2</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>ip relay giaddr 10.1.1.1</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>dhcp option82 vendor-specific insert enable</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>dhcp option82 vendor-specific format vendor-sub-option 1 source-ip-address 14.1.1.1</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>anycast-gateway enable</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>arp collect host enable</strong></pre>
<pre class="screen">[*PE1-Vbdif1] <strong>quit</strong></pre>
<pre class="screen">[*PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<font style="font-size:8pt" Face="Courier New" >~</font>PE2]<strong> interface Vbdif 1</strong></pre>
<pre class="screen">[*PE2-Vbdif1] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[*PE2-Vbdif1] <strong>ip address 10.1.1.1 255.255.255.0</strong></pre>
<pre class="screen">[*PE2-Vbdif1] <strong>arp expire-time 86400</strong></pre>
<pre class="screen">[*PE2-Vbdif1] <strong>dhcp select relay</strong></pre>
<pre class="screen">[*PE2-Vbdif1] <strong>ip relay address 30.1.1.2</strong></pre>
<pre class="screen">[*PE2-Vbdif1] <strong>ip relay giaddr 10.1.1.1</strong></pre>
<pre class="screen">[*PE2-Vbdif1] <strong>dhcp option82 vendor-specific insert enable</strong></pre>
<pre class="screen">[*PE2-Vbdif1] <strong>dhcp option82 vendor-specific format vendor-sub-option 1 source-ip-address 15.1.1.1</strong></pre>
<pre class="screen">[*PE2-Vbdif1]<strong> anycast-gateway enable</strong></pre>
<pre class="screen">[*PE2-Vbdif1] <strong>arp collect host enable</strong></pre>
<pre class="screen">[*PE2-Vbdif1]<strong> quit</strong></pre>
<pre class="screen">[*PE2] <strong>commit</strong></pre>
</p></li><li><span>Verify the configuration.</span><p><p># Run the <strong>display dhcp relay address</strong> command on PE1 and PE2 to check the DHCP relay configuration on VBDIF 1. The following example uses the command output on PE1.</p>
<pre class="screen">[PE1] <strong>display dhcp relay address interface Vbdif 1</strong>  
    **  Vbdif1 DHCP Relay Address  ** 
 Dhcp Option          Relay Agent IP       Server IP             
 *                    10.1.1.1             30.1.1.2    </pre>
</p><p><p>The configuration succeeds if the DHCP client obtains an IP address from the DHCP server through the DHCP relay-enabled gateway and goes online successfully.</p>
</p></li></ol></div>
<div class="example" id="EN-US_TASK_0207660591__file1"><a name="EN-US_TASK_0207660591__file1"></a><a name="file1"></a><a name="EN-US_TASK_0207660591__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>PE1 configuration file</p>
<pre class="screen">#
sysname PE1
#
vlan batch 100
#
lacp e-trunk system-id 00e0-fc12-3456
#
evpn
 vlan-extend private enable
 vlan-extend redirect enable
 local-remote frr enable
 #
 mac-duplication
#
evpn vpn-instance evpna bd-mode
 route-distinguisher 1:1
 vpn-target 1:1
#
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 100:1
<span>  apply-label per-instance</span>
  vpn-target 100:1 export-extcommunity
  vpn-target 100:1 export-extcommunity evpn
  vpn-target 100:1 import-extcommunity
  vpn-target 100:1 import-extcommunity evpn
  evpn mpls routing-enable
#
mpls lsr-id 12.1.1.1
#
mpls
#
bridge-domain 1
 evpn binding vpn-instance evpna
#
mpls ldp
 #
 ipv4-family
#
e-trunk 1          
 priority 50
 peer-address 13.1.1.1 source-address 12.1.1.1
#
interface Vbdif1
 ip binding vpn-instance vpna
 ip address 10.1.1.1 255.255.255.0
 <span>arp broadcast-detect enable</span>
 arp expire-time 86400
 dhcp select relay
 ip relay address 30.1.1.2
 ip relay giaddr 10.1.1.1
 dhcp option82 vendor-specific insert enable
 dhcp option82 vendor-specific format vendor-sub-option 1 source-ip-address 14.1.1.1
 anycast-gateway enable
 <span>arp collect host enable</span>
#
interface Eth-Trunk1           
 mode lacp-static
 e-trunk 1
 e-trunk mode force-master
 esi 0000.0000.0000.0000.1111
#
interface Eth-Trunk1.1 mode l2
 encapsulation dot1q vid 100
 rewrite pop single
 bridge-domain 1
#
interface GigabitEthernet<span>0/2/0</span>                     
 ip address 192.168.2.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/3/0</span>                    
 ip address 192.168.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>                     
 eth-trunk 1
#
interface LoopBack1
 ip address 12.1.1.1 255.255.255.255
#
interface LoopBack2
 ip binding vpn-instance vpna
 ip address 14.1.1.1 255.255.255.255
#
bgp 100
 peer 11.1.1.1 as-number 100
 peer 11.1.1.1 connect-interface LoopBack 1
 peer 13.1.1.1 as-number 100
 peer 13.1.1.1 connect-interface LoopBack 1
 peer 192.168.1.1 as-number 100
 peer 192.168.2.2 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  peer 11.1.1.1 enable
  peer 13.1.1.1 enable
  peer 192.168.1.1 enable
  peer 192.168.2.2 enable
 #
 ipv4-family vpn-instance vpna
  import-route direct
  advertise l2vpn evpn
 #
 l2vpn-family evpn
  policy vpn-target
  peer 11.1.1.1 enable
  peer 11.1.1.1 advertise irb
  peer 13.1.1.1 enable
  peer 13.1.1.1 advertise irb
#
ospf 1
 area 0.0.0.0
  network 12.1.1.1 0.0.0.0
  network 20.1.1.1 0.0.0.0
  network 192.168.1.0 0.0.0.255
  network 192.168.2.0 0.0.0.255
#
evpn source-address 12.1.1.1
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
vlan batch 100
#
lacp e-trunk system-id 00e0-fc12-3456
#
evpn
 vlan-extend private enable
 vlan-extend redirect enable
 local-remote frr enable
 #
 mac-duplication
#
evpn vpn-instance evpna bd-mode
 route-distinguisher 1:1
 vpn-target 1:1
 #
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 100:1
<span>  apply-label per-instance</span>
  vpn-target 100:1 export-extcommunity
  vpn-target 100:1 export-extcommunity evpn
  vpn-target 100:1 import-extcommunity
  vpn-target 100:1 import-extcommunity evpn
  evpn mpls routing-enable
#
mpls lsr-id 13.1.1.1
#
mpls
#
bridge-domain 1
 evpn binding vpn-instance evpna
#
mpls ldp
 #
 ipv4-family
#
e-trunk 1       
 priority 10
 peer-address 12.1.1.1 source-address 13.1.1.1
#
interface Vbdif1
 ip binding vpn-instance vpna
 ip address 10.1.1.1 255.255.255.0
 arp expire-time 86400
 dhcp select relay
 ip relay address 30.1.1.2
 ip relay giaddr 10.1.1.1
 dhcp option82 vendor-specific insert enable
 dhcp option82 vendor-specific format vendor-sub-option 1 source-ip-address 15.1.1.1
 anycast-gateway enable
 <span>arp collect host enable</span>
#
interface Eth-Trunk1        
 mode lacp-static
 e-trunk 1
 e-trunk mode force-master
 esi 0000.0000.0000.0000.1111
#
interface Eth-Trunk1.1 mode l2
 encapsulation dot1q vid 100
 rewrite pop single
 bridge-domain 1
#
interface GigabitEthernet<span>0/2/0</span>                     
 ip address 192.168.2.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/3/0</span>                     
 ip address 172.16.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>                     
 eth-trunk 1
#
interface LoopBack1
 ip address 13.1.1.1 255.255.255.255
#
interface LoopBack2
 ip binding vpn-instance vpna
 ip address 15.1.1.1 255.255.255.255
#
bgp 100
 peer 11.1.1.1 as-number 100
 peer 11.1.1.1 connect-interface LoopBack 1
 peer 12.1.1.1 as-number 100
 peer 12.1.1.1 connect-interface LoopBack 1
 peer 172.16.1.2 as-number 100
 peer 192.168.2.1 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  peer 11.1.1.1 enable
  peer 12.1.1.1 enable
  peer 172.16.1.2 enable
  peer 192.168.2.1 enable
 #
 ipv4-family vpn-instance vpna
  import-route direct
  advertise l2vpn evpn
 #
 l2vpn-family evpn
  policy vpn-target
  peer 11.1.1.1 enable
  peer 11.1.1.1 advertise irb
  peer 12.1.1.1 enable
  peer 12.1.1.1 advertise irb
#
ospf 1
 area 0.0.0.0
  network 13.1.1.1 0.0.0.0
  network 20.1.1.1 0.0.0.0
  network 172.16.1.0 0.0.0.255
  network 192.168.2.0 0.0.0.255
#
evpn source-address 13.1.1.1
#
return</pre>
</li><li><p>PE3 configuration file</p>
<pre class="screen">#
sysname PE3
# 
evpn
 vlan-extend private enable
 vlan-extend redirect enable
 local-remote frr enable
#
evpn vpn-instance evpna bd-mode
 route-distinguisher 1:1
 vpn-target 1:1
#
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 100:1
<span>  apply-label per-instance</span>
  vpn-target 100:1 export-extcommunity
  vpn-target 100:1 export-extcommunity evpn
  vpn-target 100:1 import-extcommunity
  vpn-target 100:1 import-extcommunity evpn
  evpn mpls routing-enable
#
mpls lsr-id 11.1.1.1
#
mpls
#
bridge-domain 1
 evpn binding vpn-instance evpna
#
mpls ldp
 #
 ipv4-family
#
interface GigabitEthernet<span>0/2/0</span>                    
 ip address 172.16.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/3/0</span>                     
 ip binding vpn-instance vpna
 ip address 30.1.1.1 255.255.255.0
#
interface GigabitEthernet<span>0/1/0</span>                   
 ip address 192.168.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 11.1.1.1 255.255.255.255
#
bgp 100
 peer 12.1.1.1 as-number 100
 peer 12.1.1.1 connect-interface LoopBack 1
 peer 13.1.1.1 as-number 100
 peer 13.1.1.1 connect-interface LoopBack 1
 peer 192.168.1.2 as-number 100
 peer 172.16.1.1 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  peer 12.1.1.1 enable
  peer 13.1.1.1 enable
  peer 192.168.1.2 enable
  peer 172.16.1.1 enable
 #
 ipv4-family vpn-instance vpna
  import-route direct
  advertise l2vpn evpn
 #
 l2vpn-family evpn
  policy vpn-target
  peer 12.1.1.1 enable
  peer 12.1.1.1 advertise irb
  peer 13.1.1.1 enable
  peer 13.1.1.1 advertise irb
#
ospf 1
 area 0.0.0.0
  network 11.1.1.1 0.0.0.0
  network 192.168.1.0 0.0.0.255
  network 172.16.1.0 0.0.0.255
#
evpn source-address 11.1.1.1
#
return</pre>
</li><li><p>CE configuration file</p>
<pre class="screen">#
sysname CE
#
vlan batch 100
#
interface Eth-Trunk1
 portswitch
 port link-type trunk
 port trunk allow-pass vlan 100
 mode lacp-static
#
interface Ethernet<span>0/3/0</span>                   
 portswitch
 port link-type trunk
 port trunk allow-pass vlan 100
#
interface Ethernet<span>0/1/0</span>                  
 eth-trunk 1
#
interface Ethernet<span>0/2/0</span>                   
 eth-trunk 1
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_dhcp_relay_cfg_0010.html">Configuration Examples for DHCP
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_dhcp_server_cfg_0022.html"><span class="font-st">&lt; </span>Previous topic</a>
</div>
</div>
</body>
</html>