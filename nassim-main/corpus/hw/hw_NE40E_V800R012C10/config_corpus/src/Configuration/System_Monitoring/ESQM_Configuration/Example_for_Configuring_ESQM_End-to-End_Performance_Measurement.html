
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring ESQM End-to-End Performance Measurement">
<meta name="abstract" content="This section describes how to use ESQM to collect end-to-end packet loss and delay statistics on an L3VPN HoVPN with an L3EVPN.">
<meta name="description" content="This section describes how to use ESQM to collect end-to-end packet loss and delay statistics on an L3VPN HoVPN with an L3EVPN.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_esqm_cfg_0000.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_esqm_cfg_0002.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00800033,w00556928,w00606909">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="ESQM">
<meta name="featuretype" content="System Monitor">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="ESQM">
<meta name="featuretype" content="System Monitor">
<meta name="featurename" content="ESQM">
<meta name="featuretype" content="System Monitor">
<meta name="OWNER" content="l00799643">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00799643">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TOPIC_0191673696">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/jquery.min.idp.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/RowOrColfreezeSupport.js"></script>

<script type="text/javascript">
setTimeout(function(){
	jQueryHW(document).ready(function(){
		jQueryHW("table[rowfreeze='yes']").rowfreeze();
		jQueryHW("table[colfreeze='yes']").colfreeze();
	});
},500);
</script>
<title>Example for Configuring ESQM End-to-End Performance Measurement</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TOPIC_0191673696"></a><a name="EN-US_TOPIC_0191673696"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring ESQM End-to-End Performance Measurement</h1>
<div><p>This section describes how to use ESQM to collect end-to-end packet loss and delay statistics on an L3VPN HoVPN with an L3EVPN.</p>
<div class="section"><h4 class="sectiontitle">Networking Requirements</h4><p>As networks rapidly develop and applications become diversified, various value-added services are widely used. Link connectivity and network performance influence network quality. Therefore, performance monitoring is especially important for service transmission.</p>
<ul><li><p>For example, users will not sense any change in voice quality if the packet loss rate on voice links is lower than 5%. However, if the packet loss rate is higher than 10%, user experience obviously degrades.</p>
</li><li><p>The real-time services such as Voice over Internet Protocol (VoIP), online gaming, and online video require the delay lower than 100 ms. Some delay-sensitive services even require that the delay be lower than 50 ms. Otherwise, user experience will degrade.</p>
</li></ul>
<p>To meet high requirements for voice, online gaming, and online video on the network, carriers should be able to monitor the packet loss and delay of the links. They can adjust the links if service quality decreases.</p>
<p>As shown in <a href="#EN-US_TOPIC_0191673696__fig_dc_vrp_evpn_cfg_008701">Figure 1</a>, an access network is deployed between a UPE and an SPE, and an aggregation network is deployed between an SPE and an NPE. The forward service flow enters the network through the UPE, travels across the SPE, and leaves the network through the NPE. The backward service flow enters the network through the NPE, also travels across the SPE, and leaves the network through the UPE.</p>
<div class="fignone" id="EN-US_TOPIC_0191673696__fig_dc_vrp_evpn_cfg_008701"><a name="EN-US_TOPIC_0191673696__fig_dc_vrp_evpn_cfg_008701"></a><a name="fig_dc_vrp_evpn_cfg_008701"></a><span class="figcap"><b>Figure 1 </b>L3VPN HoVPN with an L3EVPN</span><br><span><img class="vsd" src="figure/en-us_image_0192890653.png"></span></div>

<div class="tableBorder"><a name="EN-US_TOPIC_0191673696__tab_dc_vrp_ifit_cfg_001301"></a><a name="tab_dc_vrp_ifit_cfg_001301"></a><table cellpadding="4" cellspacing="0" summary="" rowfreeze="yes" id="EN-US_TOPIC_0191673696__tab_dc_vrp_ifit_cfg_001301" frame="border" border="1" rules="all"><caption><b>Table 1 </b>Interfaces connecting devices and their IP addresses</caption><thead align="left"><tr><th align="left" class="cellrowborder" char="." valign="top" width="18.04819518048195%" id="mcps1.4.1.7.2.6.1.1" liSelected="liSelected"><p>Device (Role)</p>
</th>
<th align="left" class="cellrowborder" char="." valign="top" width="24.997500249975%" id="mcps1.4.1.7.2.6.1.2" liSelected="liSelected"><p>Interface Name</p>
</th>
<th align="left" class="cellrowborder" char="." valign="top" width="24.997500249975%" id="mcps1.4.1.7.2.6.1.3" liSelected="liSelected"><p>Interface</p>
</th>
<th align="left" class="cellrowborder" char="." valign="top" width="16.91830816918308%" id="mcps1.4.1.7.2.6.1.4" liSelected="liSelected"><p>Peer Device (Role)</p>
</th>
<th align="left" class="cellrowborder" char="." valign="top" width="15.038496150384962%" id="mcps1.4.1.7.2.6.1.5" liSelected="liSelected"><p>IP Address</p>
</th>
</tr>
</thead>
<tbody><tr><td class="cellrowborder" rowspan="3" char="." valign="top" width="18.04819518048195%" headers="mcps1.4.1.7.2.6.1.1 "><p>UPE</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.7.2.6.1.2 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.7.2.6.1.3 "><p>Loopback1</p>
</td>
<td class="cellrowborder" char="." valign="top" width="16.91830816918308%" headers="mcps1.4.1.7.2.6.1.4 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="15.038496150384962%" headers="mcps1.4.1.7.2.6.1.5 "><p>1.1.1.1/32</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.2 "><p>interface1</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.3 "><p>GE<span>0/1/0</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.4 "><p>SPE</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.5 "><p>10.1.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.2 "><p>interface2</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.3 "><p>GE<span>0/2/0</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.4 "><p>Site1</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.5 "><p>192.168.20.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" char="." valign="top" width="18.04819518048195%" headers="mcps1.4.1.7.2.6.1.1 "><p>SPE</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.7.2.6.1.2 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.7.2.6.1.3 "><p>Loopback1</p>
</td>
<td class="cellrowborder" char="." valign="top" width="16.91830816918308%" headers="mcps1.4.1.7.2.6.1.4 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="15.038496150384962%" headers="mcps1.4.1.7.2.6.1.5 "><p>2.2.2.2/32</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.2 "><p>interface1</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.3 "><p>GE<span>0/1/0</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.4 "><p>UPE</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.5 "><p>10.1.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.2 "><p>interface2</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.3 "><p>GE<span>0/2/0</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.4 "><p>NPE</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.5 "><p>10.2.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" char="." valign="top" width="18.04819518048195%" headers="mcps1.4.1.7.2.6.1.1 "><p>NPE</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.7.2.6.1.2 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="24.997500249975%" headers="mcps1.4.1.7.2.6.1.3 "><p>Loopback1</p>
</td>
<td class="cellrowborder" char="." valign="top" width="16.91830816918308%" headers="mcps1.4.1.7.2.6.1.4 "><p>-</p>
</td>
<td class="cellrowborder" char="." valign="top" width="15.038496150384962%" headers="mcps1.4.1.7.2.6.1.5 "><p>3.3.3.3/32</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.2 "><p>interface1</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.3 "><p>GE<span>0/1/0</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.4 "><p>SPE</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.5 "><p>10.2.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.2 "><p>interface2</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.3 "><p>GE<span>0/2/0</span></p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.4 "><p>Site2</p>
</td>
<td class="cellrowborder" char="." valign="top" headers="mcps1.4.1.7.2.6.1.5 "><p>192.168.30.1/24</p>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Deploy IGPs between the UPE and SPE and between the SPE and NPE. In this example, OSPF runs between the UPE and SPE, and IS-IS runs between the SPE and NPE.</p>
</li><li><p>Configure MPLS LDP on the UPE, SPE, and NPE.</p>
</li><li><p>Configure VPN instances on the UPE, SPE, and NPE.</p>
</li><li><p>Bind the access-side interfaces on the UPE and NPE to the VPN instances.</p>
</li><li><p>Configure VPN static default routes on the SPE.</p>
</li><li><p>Configure a route-policy on the NPE to disable the NPE from receiving the default routes.</p>
</li><li><p>Configure BGP EVPN on the SPE and NPE.</p>
</li><li><p>Configure a BGP-VPNv4 peer relationship between the UPE and SPE, specify the UPE as the lower-level PE of the SPE, and configure the SPE to import default VPN routes.</p>
</li><li><p>Configure route regeneration on the SPE.</p>
</li><li>Configure packet loss and delay measurement on the link between the UPE and NPE to monitor the link status in an end-to-end manner.</li></ol>
</div>
<div class="section"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li>IP address of each interface listed in <a href="#EN-US_TOPIC_0191673696__tab_dc_vrp_ifit_cfg_001301">Table 1</a></li><li>OSPF and IS-IS as IGP protocols</li><li><p>MPLS LSR IDs of UPE (1.1.1.1), SPE (2.2.2.2), and NPE (3.3.3.3)</p>
</li><li><p>VPN instance name <strong>vpn1</strong> and RD <strong>100:1</strong></p>
</li><li><p>VPN targets 1:1 (import and export) of vpn1 and 2:2 for EVPN</p>
</li><li>Measurement interval 10s for the ESQM instance</li><li>Target flow's source IP address (192.168.20.2) and destination IP address (192.168.30.2)</li></ul>
</div>
<div class="section"><h4 class="sectiontitle">Procedure</h4><ol><li><p>Configure an L3VPN HoVPN with an L3EVPN on the UPE, SPE, and NPE. For configuration details, see <a href="#EN-US_TOPIC_0191673696__section1625879194117">Configuration Files</a>.</p>
</li><li><p>Configure ESQM measurement on the UPE and NPE, and inject unidirectional traffic from the UPE to the NPE.</p>
<p># Configure inbound ESQM on the user side of the UPE.</p>
<pre class="screen">&lt;UPE&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE] <strong>esqm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPE-esqm] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPE-esqm]<strong> interface GigabitEthernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>UPEâGigabitEthernet<span>0/2/0</span>] <strong>esqm service-stream inbound</strong></pre>
<pre class="screen">[<span class="keyword">*</span>UPEâGigabitEthernet<span>0/2/0</span>] <strong>commit</strong></pre>
<p># Configure inbound ESQM on the user side of the NPE.</p>
<pre class="screen">&lt;NPE&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE] <strong>esqm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPE-esqm] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPE-esqm]<strong> interface GigabitEthernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>NPEâGigabitEthernet<span>0/1/0</span>] <strong>esqm service-stream inbound</strong></pre>
<pre class="screen">[<span class="keyword">*</span>NPEâGigabitEthernet<span>0/1/0</span>] <strong>commit</strong></pre>
</li></ol>
</div>
<div class="section" id="EN-US_TOPIC_0191673696__section1625879194117"><a name="EN-US_TOPIC_0191673696__section1625879194117"></a><a name="section1625879194117"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li>UPE configuration file<pre class="screen">#    
sysname UPE
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance
  vpn-target 2:2 export-extcommunity evpn
  vpn-target 2:2 import-extcommunity evpn
  evpn mpls routing-enable
#               
mpls lsr-id 1.1.1.1
#
mpls
#
mpls ldp
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 192.168.20.1 255.255.255.0
 esqm service-stream inbound
#
interface LoopBack1
 ip address 1.1.1.1 255.255.255.255
#
bgp 100
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 2.2.2.2 enable
 #
 ipv4-family vpn-instance vpn1
  import-route direct
  advertise l2vpn evpn
 #
 l2vpn-family evpn
  undo policy vpn-target
  peer 2.2.2.2 enable
#
ospf 1
 area 0.0.0.0
  network 1.1.1.1 0.0.0.0
  network 10.1.1.0 0.0.0.255
#
esqm
#
return</pre>
</li><li>SPE configuration file<pre class="screen"> #
sysname SPE
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance
  vpn-target 2:2 export-extcommunity evpn
  vpn-target 2:2 import-extcommunity evpn
  evpn mpls routing-enable
#
mpls lsr-id 2.2.2.2
#
mpls
#
mpls ldp
#
isis 1
 network-entity 10.0000.0000.0002.00
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown  
 ip address 10.1.1.2 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip address 10.2.1.1 255.255.255.0
 isis enable 1
 mpls
 mpls ldp
#               
interface LoopBack1
 ip address 2.2.2.2 255.255.255.255
 isis enable 1
#
bgp 100
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack1
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.1 enable
  peer 3.3.3.3 enable
 #
 ipv4-family vpn-instance vpn1
  network 0.0.0.0
  advertise l2vpn evpn
 #
 l2vpn-family evpn
  undo policy vpn-target
  peer 1.1.1.1 enable
  peer 1.1.1.1 upe
  peer 1.1.1.1 import reoriginate
  peer 3.3.3.3 enable
  peer 3.3.3.3 advertise route-reoriginated evpn ip
#
ospf 1
 area 0.0.0.0
  network 2.2.2.2 0.0.0.0
  network 10.1.1.0 0.0.0.255
#
ip route-static vpn-instance vpn1 0.0.0.0 0.0.0.0 NULL0
#
return</pre>
</li><li>NPE configuration file<pre class="screen">#
sysname NPE
#
ip vpn-instance vpn1
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance
  import route-policy SPE evpn
  vpn-target 2:2 export-extcommunity evpn
  vpn-target 2:2 import-extcommunity evpn
  evpn mpls routing-enable
#
mpls lsr-id 3.3.3.3
#
mpls
#
mpls ldp
#
isis 1
 network-entity 10.0000.0000.0003.00
#               
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.2.1.2 255.255.255.0
 isis enable 1
 mpls
 mpls ldp
 esqm service-stream inbound
#
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown
 ip binding vpn-instance vpn1
 ip address 192.168.30.1 255.255.255.0
#
interface LoopBack1
 ip address 3.3.3.3 255.255.255.255
 isis enable 1
#
bgp 100
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 2.2.2.2 enable
 #
 ipv4-family vpn-instance vpn1
  import-route direct
  advertise l2vpn evpn
 #
 l2vpn-family evpn
  undo policy vpn-target
  peer 2.2.2.2 enable
#
ip ip-prefix default index 10 permit 0.0.0.0 0
#
route-policy SPE deny node 10
 if-match ip-prefix default
#
route-policy SPE permit node 20
#
esqm
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_esqm_cfg_0000.html">ESQM Configuration
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_esqm_cfg_0002.html"><span class="font-st">&lt; </span>Previous topic</a>
</div>
</div>
</body>
</html>