
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Use VPN NAT to Implement User Access in an L3VPN Scenario">
<meta name="abstract" content="This section provides an example for configuring VPN NAT to allow VPN users on the same network segment to access one another in an L3VPN scenario and to allow the VPN users to access an internal server on the same network segment. A networking diagram is provided to help you understand the configuration procedure. The example provides the networking requirements, configuration roadmap, configuration procedure, and configuration files.">
<meta name="description" content="This section provides an example for configuring VPN NAT to allow VPN users on the same network segment to access one another in an L3VPN scenario and to allow the VPN users to access an internal server on the same network segment. A networking diagram is provided to help you understand the configuration procedure. The example provides the networking requirements, configuration roadmap, configuration procedure, and configuration files.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0056.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0156_1.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0157.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="c00549182">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="featurename" content="NAT">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="OWNER" content="c00549182">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="m00390128">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172374663">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Use VPN NAT to Implement User Access in an L3VPN Scenario</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172374663"></a><a name="EN-US_TASK_0172374663"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Use VPN NAT to Implement User Access in an L3VPN Scenario</h1>
<div class="taskbody"><p>This section provides an example for configuring VPN NAT to allow VPN users on the same network segment to access one another in an L3VPN scenario and to allow the VPN users to access an internal server on the same network segment. A networking diagram is provided to help you understand the configuration procedure. The example provides the networking requirements, configuration roadmap, configuration procedure, and configuration files.</p>
<div class="context"><a name="EN-US_TASK_0172374663__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>On the L3VPN shown in <a href="#EN-US_TASK_0172374663__fig_dc_ne_nat_cfg_015801">Figure 1</a>, CE1 and CE2 belong to VPN-A. VPN-A connected to PE1 has IP addresses on the network segment 10.1.0.0/16, and VPN-A connected to PE2 has IP addresses on the network segment 10.2.0.0/16. VPN NAT is required for communication between VPN users connected to CE1 and CE2. VPN NAT also needs to be configured on the internal FTP server so that the VPN users connected to CE2 can access the internal FTP server connected to CE1.</p>
<p></p>
<div class="fignone" id="EN-US_TASK_0172374663__fig_dc_ne_nat_cfg_015801"><a name="EN-US_TASK_0172374663__fig_dc_ne_nat_cfg_015801"></a><a name="fig_dc_ne_nat_cfg_015801"></a><span class="figcap"><b>Figure 1 </b>Networking for configuring VPN NAT</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 through 5 in this example represent GE <span>0/1/5</span>, GE <span>0/2/2</span>, GE <span>0/2/3</span>, GE <span>0/2/4</span>, and GE <span>0/2/5</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="images/fig_dc_ne_nat_cfg_015801.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172374663__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li>Configure MPLS/BGP IP VPN so that CE1 can communicate with CE2.</li><li>Create a service-location group and a service-instance group.</li><li>Create a NAT instance and bind it to the service-instance group.</li><li>Configure address and port mapping for an internal server.</li><li>Configure a NAT traffic diversion policy.</li><li>Configure a NAT address pool and a NAT traffic conversion policy.</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172374663__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li>IP addresses of interfaces</li><li>Service-location group's index (1), service-instance group's name (group1), and service boards' slot IDs (1 and 3)</li><li>NAT instance name (nat1) and index (1)</li><li>NAT address pool name (address-group1), address pool number (1), and a range of IP addresses</li><li>Internal server's private IP address (10.1.1.226) and public IP address (11.1.1.2)</li><li>ACL number (3001), traffic classifier (c1), traffic behavior (b1), and traffic policy (p1)</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172374663__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure an IGP on the MPLS backbone network to implement connectivity between the PEs and P.</span><p><p># Configure PE1.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname PE1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface gigabitEthernet <span>0/2/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/3</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/3</span>] <strong>ip address 172.16.2.2 255.255.255.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/3</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/2/3</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack0] <strong>ip address 1.1.1.9 255.255.255.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-LoopBack0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>network 172.16.2.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>network 1.1.1.9 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-ospf-1] <strong>quit</strong></pre>
<p># Configure the P.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname P</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>interface gigabitEthernet <span>0/2/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/3</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/3</span>] <strong>ip address 172.16.2.1 255.255.255.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/3</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/2/3</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>interface gigabitEthernet <span>0/2/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/2</span>] <strong>ip address 172.16.3.2 255.255.255.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/2</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/2/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-LoopBack0] <strong>ip address 2.2.2.9 255.255.255.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-LoopBack0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-LoopBack0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-ospf-1-area-0.0.0.0] <strong>network 172.16.2.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-ospf-1-area-0.0.0.0] <strong>network 172.16.3.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-ospf-1-area-0.0.0.0] <strong>network 2.2.2.9 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-ospf-1-area-0.0.0.0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-ospf-1] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname PE2</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface gigabitEthernet <span>0/2/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/2</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/2</span>] <strong>ip address 172.16.3.1 255.255.255.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/2</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/2/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack0] <strong>ip address 3.3.3.9 255.255.255.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-LoopBack0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>network 172.16.3.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>network 3.3.3.9 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-ospf-1] <strong>quit</strong></pre>
</p></li><li><span>Configure basic MPLS functions, enable MPLS LDP, and establish LDP LSPs on the MPLS backbone network.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls lsr-id 1.1.1.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>lsp-trigger all</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls-ldp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface gigabitEthernet <span>0/2/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/3</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/3</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/3</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/2/3</span>] <strong>quit</strong></pre>
<p># Configure the P.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>mpls lsr-id 2.2.2.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-mpls] <strong>lsp-trigger all</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-mpls] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-mpls-ldp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>interface gigabitEthernet <span>0/2/3</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/3</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/3</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/3</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/2/3</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P] <strong>interface gigabitEthernet <span>0/2/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/2</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/2</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P-GigabitEthernet<span>0/2/2</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P-GigabitEthernet<span>0/2/2</span>] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls lsr-id 3.3.3.9</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls] <strong>lsp-trigger all</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls-ldp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface gigabitEthernet <span>0/2/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/2</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/2</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/2</span>-mpls-ldp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/2/2</span>-mpls-ldp] <strong>quit</strong></pre>
</p></li><li><span>Configure VPN instances on PEs so that CEs can access PEs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface gigabitEthernet <span>0/2/4</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1âGigabitEthernet<span>0/2/4</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1âGigabitEthernet<span>0/2/4</span>] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/4</span>] <strong>ip address 172.16.1.2 255.255.255.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/4</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/2/4</span>] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 200:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpna-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface gigabitEthernet <span>0/2/5</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2âGigabitEthernet<span>0/2/5</span>] <strong>undo shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2âGigabitEthernet<span>0/2/5</span>] <strong>ip binding vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/5</span>] <strong>ip address 172.16.4.2 255.255.255.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/5</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/2/5</span>] <strong>quit</strong></pre>
</p></li><li><span>Establish EBGP peer relationships between PEs and CEs and import VPN routes.</span><p><p># Configure CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>peer 172.16.1.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-bgp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1-bgp] <strong>quit</strong></pre>
<p># Configure CE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>bgp 300</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-bgp] <strong>peer 172.16.4.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-bgp] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-bgp] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2-bgp] <strong>quit</strong></pre>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>peer 172.16.1.1 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>import-route unr</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-vpna] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-vpna] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpna] <strong>peer 172.16.4.1 as-number 300</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpna] <strong>import-route direct</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpna] <strong>import-route unr</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-vpna] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp-vpna] <strong>quit</strong></pre>
</p></li><li><span>Establish an MP-IBGP peer relationship between PEs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 3.3.3.9 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 3.3.3.9 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 3.3.3.9 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-vpnv4] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 1.1.1.9 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 1.1.1.9 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 1.1.1.9 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp-af-vpnv4] <strong>quit</strong></pre>
<p>After completing the configuration, run the <a href="cmdqueryname=display+bgp+peer"><b><span class="cmdname">display bgp peer</span></b></a> command on a PE to verify that the BGP peer relationship between PEs is in the <strong>Established</strong> state.</p>
</p></li><li><span>Create a service-location group and a service-instance group and bind a NAT service board to the service-location group. Create a NAT instance and bind it to the service-instance group.</span><p><pre class="screen">&lt;<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1&gt; <strong>system-view </strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>service-location 1 </strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-service-location-1] <strong>location<span> slot <span><span>3</span></span></span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-service-location-1] <strong>commit </strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-service-location-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>service-instance-group group1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-service-instance-group-group1] <strong>service-location 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-service-instance-group-group1] <strong>commit </strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-service-instance-group-group1] <strong>quit </strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>nat instance nat1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-nat-instance-nat1] <strong>service-instance-group group1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-nat-instance-nat1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-nat-instance-nat1] <strong>quit</strong></pre>
</p></li><li><span>Configure an internal server on PE1.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>nat instance nat1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-nat-instance-nat1] <strong>nat server protocol tcp global 11.1.1.2 ftp vpn-instance vpna inside 10.1.1.226 ftp vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-nat-instance-nat1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-nat-instance-nat1] <strong>quit</strong></pre>
</p></li><li><span>Configure ACL-based traffic classification rules and a traffic behavior on PE1.</span><ol type="a"><li class="substepexpand"><span>Configure traffic classification rules.</span><p><ul><li><p>Rule 1: Configure a NAT traffic diversion policy for diverting user traffic with the network segment address of 10.1.0.0/16 to the server board for NAT processing.</p>
</li><li><p>Rule 2: Configure a NAT traffic translation policy so that addresses in the NAT address pool can be assigned to user traffic during the NAT processing.</p>
</li></ul>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>acl 3001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-acl-adv-3001] <strong>rule 1 permit ip source 10.1.0.0 0.0.255.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-acl-adv-3001] <strong>rule 2 permit ip vpn-instance vpna source 10.1.0.0 0.0.255.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-acl-adv-3001] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-acl-adv-3001] <strong>quit</strong></pre>
</p></li><li class="substepexpand"><span>Configure a traffic classifier and define an ACL-based matching rule.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>traffic classifier c1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-classifier-c1] <strong>if-match acl 3001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-classifier-c1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-classifier-c1] <strong>quit</strong></pre>
</p></li><li class="substepexpand"><span>Configure a traffic behavior, which binds traffic to the NAT instance named <strong>nat1</strong>.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>traffic behavior b1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-behavior-b1] <strong>nat bind instance nat1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-behavior-b1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-behavior-b1] <strong>quit</strong></pre>
</p></li><li class="substepexpand"><span>Configure a traffic classification policy and associate the ACL rule with the traffic behavior.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>traffic policy p1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-trafficpolicy-p1] <strong>classifier c1 behavior b1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-trafficpolicy-p1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-trafficpolicy-p1] <strong>quit</strong></pre>
</p></li><li class="substepexpand"><span>Apply the ACL-based traffic policy in the interface view.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface gigabitEthernet <span>0/2/4</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/4</span>] <strong>traffic-policy p1 inbound</strong></pre>
</p></li></ol>
</li><li><span>On PE1, configure a NAT address pool and a NAT traffic conversion policy so that interface boards divert matching packets to the NAT service boards to use addresses in the address pool to perform NAT.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>nat instance nat1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-nat-instance-nat1] <strong>nat address-group address-group1 group-id 1 11.1.1.1 11.1.1.5 vpn-instance vpna</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-nat-instance-nat1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-nat-instance-nat1] <strong>quit</strong></pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172374663__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><p>PE1 configuration file</p>
<pre class="screen">#
 sysname PE1
#
service-location 1
 location<span> slot <span><span>3</span></span></span>
#
service-instance-group group1
 service-location 1
#
nat instance nat1
 service-instance-group group1
 nat address-group address-group1 group-id 1 11.1.1.1 11.1.1.5 vpn-instance vpna
 nat server protocol tcp global 11.1.1.2 ftp vpn-instance vpna inside 10.1.1.226 ftp vpn-instance vpna
#
acl 3001
 rule 1 permit ip source 10.1.0.0 0.0.255.255 
 rule 2 permit ip vpn-instance vpna source 10.1.0.0 0.0.255.255 
#
traffic classifier c1 operator or
 if-match acl 3001 precedence 1
#
traffic behavior b1
 nat bind instance nat1
#
traffic policy p1
 classifier c1 behavior b1 precedence 1
#
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 100:1
  apply-label per-instance 
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
mpls lsr-id 1.1.1.9
#
mpls
 lsp-trigger all
#
mpls ldp
 #
 ipv4-family
#
interface GigabitEthernet <span>0/2/4</span>
 undo shutdown
 ip binding vpn-instance vpna
 ip address 172.16.1.2 255.255.255.0
 traffic-policy p1 inbound
#
interface GigabitEthernet <span>0/2/3</span>
 undo shutdown
 ip address 172.16.2.2 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack0
 ip address 1.1.1.9 255.255.255.255
#
bgp 100
 peer 3.3.3.9 as-number 100
 peer 3.3.3.9 connect-interface LoopBack0
 #
 ipv4-family vpn-instance vpna
  peer 172.16.1.1 as-number 200
  import-route direct
  import-route unr
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 3.3.3.9 enable
#
ospf 1
 import-route static
 area 0.0.0.0
  network 172.16.2.0 0.0.0.255
  network 1.1.1.9 0.0.0.0
#
 return</pre>
<p>P configuration file</p>
<pre class="screen">#
 sysname P
#
mpls lsr-id 2.2.2.9
#
mpls
 lsp-trigger all
#
mpls ldp
 #
 ipv4-family
#
interface GigabitEthernet <span>0/2/3</span>
 ip address 172.16.2.1 255.255.255.0
 mpls
 mpls ldp
#
interface GigabitEthernet <span>0/2/2</span>
 ip address 172.16.3.2 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack0
 ip address 2.2.2.9 255.255.255.255
#
ospf 1
 area 0.0.0.0
  network 172.16.2.0 0.0.0.255
  network 172.16.3.0 0.0.0.255
  network 2.2.2.9 0.0.0.0
#
return</pre>
<p>PE2 configuration file</p>
<pre class="screen">#
 sysname PE2
#
ip vpn-instance vpna
 ipv4-family
 route-distinguisher 200:1
 apply-label per-instance 
 vpn-target 111:1 export-extcommunity
 vpn-target 111:1 import-extcommunity
#
mpls lsr-id 3.3.3.9
#
mpls
 lsp-trigger all
#
mpls ldp
 #
 ipv4-family
#
interface GigabitEthernet <span>0/2/5</span>
 undo shutdown
 ip binding vpn-instance vpna
 ip address 172.16.4.2 255.255.255.0
#
interface GigabitEthernet <span>0/2/2</span>
 undo shutdown
 ip address 172.16.3.1 255.255.255.0
 mpls
 mpls ldp
#
interface LoopBack0
 ip address 3.3.3.9 255.255.255.255
#
bgp 100
 peer 1.1.1.9 as-number 100
 peer 1.1.1.9 connect-interface LoopBack0
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.9 enable
 #
 ipv4-family vpn-instance vpna
  peer 172.16.4.1 as-number 300
  import-route direct
  import-route unr
#
ospf 1
 area 0.0.0.0
  network 172.16.3.0 0.0.0.255
  network 3.3.3.9 0.0.0.0
#
return</pre>
<p>CE1 configuration file</p>
<pre class="screen">#
 sysname CE1
#
interface GigabitEthernet <span>0/2/2</span>
 undo shutdown
 ip address 172.16.1.1 255.255.255.0
#
bgp 200
 peer 172.16.1.2 as-number 100
 import-route direct
#
return</pre>
<p>CE2 configuration file</p>
<pre class="screen">#
 sysname CE2
#
interface GigabitEthernet <span>0/1/5</span>
 undo shutdown
 ip address 172.16.4.1 255.255.255.0
#
bgp 300
 peer 172.16.4.2 as-number 100
 import-route direct
#
return</pre>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0056.html">Configuration Examples for NAT
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0156_1.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_nat_cfg_0157.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>