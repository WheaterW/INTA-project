
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring Centralized NAT Load Balancing Plus HA Inter-Chassis Hot Backup">
<meta name="abstract" content="This section provides an example for configuring centralized NAT load balancing plus HA inter-chassis hot backup.">
<meta name="description" content="This section provides an example for configuring centralized NAT load balancing plus HA inter-chassis hot backup.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_cgn-reliability_cfg_0043.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_cgn-reliability_cfg_0029.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_cgn-reliability_cfg_0026.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="c00549182">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="CGN Reliability">
<meta name="featuretype" content="NAT and IPv6 Transition">

<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="CGN Reliability">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="featurename" content="CGN Reliability">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="featurename" content="CGN Reliability">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="featurename" content="CGN Reliability">
<meta name="featuretype" content="NAT and IPv6 Transition">
<meta name="OWNER" content="c00549182">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="c00549182">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0279436213">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/jquery.min.idp.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/RowOrColfreezeSupport.js"></script>

<script type="text/javascript">
setTimeout(function(){
	jQueryHW(document).ready(function(){
		jQueryHW("table[rowfreeze='yes']").rowfreeze();
		jQueryHW("table[colfreeze='yes']").colfreeze();
	});
},500);
</script>
<title>Example for Configuring Centralized NAT Load Balancing Plus HA Inter-Chassis Hot Backup</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0279436213"></a><a name="EN-US_TASK_0279436213"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring Centralized NAT Load Balancing Plus HA Inter-Chassis Hot Backup</h1>
<div class="taskbody"><p>This section provides an example for configuring centralized NAT load balancing plus HA inter-chassis hot backup.</p>
<div class="context"><a name="EN-US_TASK_0279436213__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>In the centralized networking scenario shown in <a href="#EN-US_TASK_0279436213__fig19851104104917">figure1</a>, CGN1 and CGN2 are deployed close to the CR on the MAN core as standalone devices, and a NAT service board is installed in slot <span>1</span> on each CGN device. Load balancing needs to be implemented between the different CPUs on the NAT service boards on both CGN devices. A VRRP channel also needs to be established between the two devices through GE interfaces. In addition, the master/backup states of the CGN devices need to be determined through VRRP, and the states of service CPUs need to be consistent with the VRRP states.</p>
<div class="fignone" id="EN-US_TASK_0279436213__fig19851104104917"><a name="EN-US_TASK_0279436213__fig19851104104917"></a><a name="fig19851104104917"></a><span class="figcap"><b>Figure 1 </b>Networking for configuring centralized NAT load balancing plus HA inter-chassis hot backup</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 through 3 in this example represent GE <span>0/2/1</span>, GE <span>0/2/2</span>, and GE <span>0/2/3</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0279711999.png" width="NaN" height="NaN"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0279436213__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Set the number of sessions supported by the service board in slot <span>1</span> to 6M.</p>
</li><li><p>Enable HA hot backup.</p>
</li><li><p>Create a service-location group, configure members for HA dual-device inter-chassis backup, and configure a VRRP channel.</p>
</li><li><p>Create and configure VRRP groups.</p>
</li><li><p>Associate HA with the VRRP groups.</p>
</li><li><p>Bind the service-location groups to the VRRP groups.</p>
</li><li><p>Create service-instance groups and bind them to the service-location groups.</p>
</li><li><p>Create NAT instances and bind them to the service-instance groups.</p>
</li><li>Configure NAT traffic diversion policies and NAT conversion policies.</li><li>Import the desired default route.</li><li>Configure a route-policy on the user-side device.</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0279436213__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><div class="p">To complete the configuration, you need the following data:
<div class="tableBorder"><table cellpadding="4" cellspacing="0" summary="" rowfreeze="yes" frame="border" border="1" rules="all"><thead align="left"><tr><th align="left" class="cellrowborder" valign="top" width="11.87%" id="mcps1.4.3.2.1.1.3.1.1" liSelected="liSelected"><p>No.</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="88.13%" id="mcps1.4.3.2.1.1.3.1.2" liSelected="liSelected"><p>Data</p>
</th>
</tr>
</thead>
<tbody><tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>1</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>Index of the service-location group</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>2</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>Slot ID and CPU IDs of the service board on CGN1</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>3</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>Slot ID and CPU IDs of the service board on CGN2</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>4</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>Interfaces of the VRRP channel on the master and backup devices</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>5</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>IP address of the VRRP channel's interface on the master and backup devices</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>6</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>Indexes of the VRRP groups</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>7</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>Virtual IP addresses of the VRRP groups</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>8</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>Priorities of VRRP group members</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>9</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>VRRP preemption delay</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>10</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>Names of the service-instance groups</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>11</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>Names and indexes of the NAT instances</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>12</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>IDs of the NAT address pools and names of the global static address pools to be bound to the NAT address pools on the master and backup devices</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>13</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>Information about a NAT traffic diversion policy</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="11.87%" headers="mcps1.4.3.2.1.1.3.1.1 "><p>14</p>
</td>
<td class="cellrowborder" valign="top" width="88.13%" headers="mcps1.4.3.2.1.1.3.1.2 "><p>User-side route-policy</p>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div></div>
<div class="steps"><a name="EN-US_TASK_0279436213__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure IP addresses for device interfaces. For configuration details, see <a href="#EN-US_TASK_0279436213__li328531304214026">Configuration Files</a>.</span></li><li><span>Set the number of sessions supported by the service boards in slot <span>1</span> to 6M on master and backup devices.</span><p><p># Configure CGN1.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname CGN1</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>vsm on-board-mode disable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1] <strong>co</strong>m<strong>mit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>license</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-license] <strong>active nat session-table size 6 slot <span>1</span> 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-license] <strong>active nat session-table size 6 slot <span>1</span> </strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-license] <strong>active nat bandwidth-enhance 100 slot <span>1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-license] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-license] <strong>quit</strong></pre>
<p># Configure CGN2.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname CGN2</strong></pre>
<pre class="screen">[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>vsm on-board-mode disable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>license</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-license] <strong>active nat session-table size 6 slot <span>1</span> </strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-license] <strong>active nat session-table size 6 slot <span>1</span> </strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-license]<strong> active nat bandwidth-enhance 100 slot <span>1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-license] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-license] <strong>quit</strong></pre>
</p></li><li><span>Enable HA hot backup on the master and backup devices.</span><p><p># Configure CGN1.</p>
</p><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>service-ha hot-backup enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1]<strong> commit</strong></pre>
</p><p><p># Configure CGN2.</p>
</p><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>service-ha hot-backup enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2]<strong> commit</strong></pre>
</p></li><li><span>Create and configure VRRP groups on the master and backup devices.</span><p><p># On CGN1, enter the view of GE <span>0/2/1</span>.1, create VRRP group 1, and set the virtual IP address of the VRRP group to 10.1.1.3. Configure the VRRP group as an mVRRP group, set CGN1's priority in the VRRP group to 200, and set the VRRP preemption delay to 1500s.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>interface GigabitEthernet <span>0/2/1</span></strong><strong>.1</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>vlan-type dot1q 2001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>ip address 10.1.1.1 255.255.255.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>vrrp vrid 1 virtual-ip 10.1.1.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>admin-vrrp vrid 1 ignore-if-down</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>vrrp vrid 1 priority 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>vrrp vrid 1 preempt-mode timer delay 1500</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>vrrp recover-delay 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>quit</strong></pre>
<p># On CGN1, enter the view of GE <span>0/2/1</span>.2, create VRRP group 2, and set the virtual IP address of the VRRP group to 10.1.2.3. Configure the VRRP group as an mVRRP group, set CGN1's priority in the VRRP group to 200, and set the VRRP preemption delay to 1500s.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>interface GigabitEthernet <span>0/2/1</span></strong><strong>.2</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>vlan-type dot1q 2002</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>ip address 10.1.2.1 255.255.255.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>vrrp vrid 2 virtual-ip 10.1.2.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>admin-vrrp vrid 2 ignore-if-down</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>vrrp vrid 2 priority 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>vrrp vrid 2 preempt-mode timer delay 1500</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>vrrp recover-delay 20</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>quit</strong></pre>
<p># On CGN2, enter the view of GE <span>0/2/1</span>.1, create VRRP group 1, and set the virtual IP address of the VRRP group to 10.1.1.3. In addition, configure the VRRP group as an mVRRP group and set CGN2's priority in the VRRP group to 150.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>interface GigabitEthernet <span>0/2/1</span></strong><strong>.1</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-GigabitEthernet<span>0/2/1</span>.1] <strong>vlan-type dot1q 2001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-GigabitEthernet<span>0/2/1</span>.1] <strong>ip address 10.1.1.2 255.255.255.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-GigabitEthernet<span>0/2/1</span>.1] <strong>vrrp vrid 1 virtual-ip 10.1.1.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-GigabitEthernet<span>0/2/1</span>.1] <strong>admin-vrrp vrid 1 ignore-if-down</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-GigabitEthernet<span>0/2/1</span>.1] <strong>vrrp vrid 1 priority 150</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-GigabitEthernet<span>0/2/1</span>.1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-GigabitEthernet<span>0/2/1</span>.1] <strong>quit</strong></pre>
<p># On CGN2, enter the view of GE <span>0/2/1</span>.2, create VRRP group 2, and set the virtual IP address of the VRRP group to 10.1.2.3. In addition, configure the VRRP group as an mVRRP group and set CGN2's priority in the VRRP group to 150.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>interface GigabitEthernet <span>0/2/1</span></strong><strong>.2</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-GigabitEthernet<span>0/2/1</span>.2] <strong>vlan-type dot1q 2002</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-GigabitEthernet<span>0/2/1</span>.2] <strong>ip address 10.1.2.2 255.255.255.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-GigabitEthernet<span>0/2/1</span>.2] <strong>vrrp vrid 2 virtual-ip 10.1.2.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-GigabitEthernet<span>0/2/1</span>.2] <strong>admin-vrrp vrid 2 ignore-if-down</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-GigabitEthernet<span>0/2/1</span>.2] <strong>vrrp vrid 2 priority 150</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-GigabitEthernet<span>0/2/1</span>.2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-GigabitEthernet<span>0/2/1</span>.2] <strong>quit</strong></pre>
</p></li><li><span>On the master and backup devices, create a service-location group, configure members for HA dual-device inter-chassis backup, and configure a VRRP channel. Ensure that the direct link between the master and back devices is not interrupted. Otherwise, the backup channel cannot be established.</span><p><div class="note" id="EN-US_TASK_0279436213__en-us_task_0172362454_note111357234319"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p id="EN-US_TASK_0279436213__en-us_task_0172362454_p2135823431">Service-location IDs and the number of service-location groups configured on the master and backup devices must be the same. Otherwise, backup may fail, affecting services.</p>
</div></div>
</p><p><p># On CGN1, create service-location group 1, add CPU 0 in slot <span>1</span> as an HA dual-device inter-chassis backup member, and set the local VRRP outbound interface is GE <span>0/2/1</span>.1 and peer IP address is 10.1.1.2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>service-location 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-location-1] <strong>location slot <span>1</span> </strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-location-1] <strong>remote-backup interface GigabitEthernet<span>0/2/1</span>.1 peer 10.1.1.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-location-1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-service-location-1] <strong>quit</strong></pre>
<p># On CGN1, create service-location group 2, add CPU 1 in slot <span>1</span> as an HA dual-device inter-chassis backup member, and set the local VRRP outbound interface is GE <span>0/2/1</span>.2 and peer IP address is 10.1.2.2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>service-location 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-location-2] <strong>location slot <span>1</span> </strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-location-2] <strong>remote-backup interface GigabitEthernet<span>0/2/1</span>.2 peer 10.1.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-location-2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-service-location-2] <strong>quit</strong></pre>
<p># On CGN2, create service-location group 1, add CPU 0 in slot <span>1</span> as an HA dual-device inter-chassis backup member, and set the local VRRP outbound interface is GE <span>0/2/1</span>.1 and peer IP address is 10.1.1.1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>service-location 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-location-1] <strong>location slot <span>1</span> </strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-location-1] <strong>remote-backup interface GigabitEthernet<span>0/2/1</span>.1 peer 10.1.1.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-location-1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-service-location-1] <strong>quit</strong></pre>
<p># On CGN2, create service-location group 2, add CPU 1 in slot <span>1</span> as an HA dual-device inter-chassis backup member, and set the local VRRP outbound interface is GE <span>0/2/1</span>.2 and peer IP address is 10.1.2.1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>service-location 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-location-2] <strong>location slot <span>1</span> </strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-location-2] <strong>remote-backup interface GigabitEthernet<span>0/2/1</span>.2 peer 10.1.2.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-location-2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-service-location-2] <strong>quit</strong></pre>
</p></li><li><span>Associate HA with the VRRP groups on CGN1.</span><p><p># Enter the GE <span>0/2/1</span>.1 interface view and associate HA with VRRP group 1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>interface GigabitEthernet <span>0/2/1</span></strong><strong>.1</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>vrrp vrid 1 track service-location 1 reduced 60</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>vrrp vrid 1 track</strong> <strong>interface</strong> <strong>GigabitEthernet <span>0/2/2</span> </strong><strong>reduced 60</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>vrrp vrid 1 track interface GigabitEthernet <span>0/2/3</span> reduced 60</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-GigabitEthernet<span>0/2/1</span>.1] <strong>quit</strong></pre>
<p># Enter the GE <span>0/2/1</span>.2 interface view and associate HA with VRRP group 2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>interface GigabitEthernet <span>0/2/1</span></strong><strong>.2</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>vrrp vrid 2 track service-location 2 reduced 60</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>vrrp vrid 2 track</strong> <strong>interface</strong> <strong>GigabitEthernet <span>0/2/2</span> </strong><strong>reduced 60</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>vrrp vrid 2 track interface GigabitEthernet <span>0/2/3</span> reduced 60</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-GigabitEthernet<span>0/2/1</span>.2] <strong>quit</strong></pre>
<p># Run the <a href="cmdqueryname=display+vrrp+1"><b><span class="cmdname">display vrrp 1</span></b></a> and <a href="cmdqueryname=display+vrrp+2"><b><span class="cmdname">display vrrp 2</span></b></a> commands on both CGN1 and CGN2 to check the VRRP master/backup state. This state reflects the master/backup state of the service-location groups on the CGN devices.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>display vrrp 1</strong>
GigabitEthernet <span>0/2/1</span>.1 | Virtual Router 1                                                                                     
   <strong> State                  : Master </strong>
    Virtual IP                : 10.1.1.3  
    Master IP                 : 10.1.1.1
    Local IP                  : 10.1.1.1
    PriorityRun               : 200     
    PriorityConfig            : 200    
    MasterPriority            : 200     
    Preempt                   : YES     Delay Time            : 400 s  
    Hold Multiplier           : 3                                                                   
    TimerRun                  : 1 s 
    TimerConfig               : 1 s     
    Auth Type                 : NONE    
    Virtual MAC               : 00e0-fc12-3456   
    Check TTL                 : YES        
    Config Type               : admin-vrrp    
    Backup-forward            : disabled     
    Fast-resume               : disabled                                                               
    Create Time               : 2011-10-18 11:14:48 UTC+10:59     
    Last Change Time          : 2011-10-18 14:02:46 UTC+10:59
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>display vrrp 2</strong>
GigabitEthernet <span>0/2/1</span>.2 | Virtual Router 1                                                                                     
   <strong> State                  : Master</strong> 
    Virtual IP                : 10.1.2.3  
    Master IP                 : 10.1.2.1
    Local IP                  : 10.1.2.1
    PriorityRun               : 200     
    PriorityConfig            : 200    
    MasterPriority            : 200     
    Preempt                   : YES     Delay Time        : 400 s  
    Hold Multiplier           : 3                                                                     
    TimerRun                  : 1 s 
    TimerConfig               : 1 s     
    Auth Type                 : NONE    
    Virtual MAC               : 00e0-fc12-3456   
    Check TTL                 : YES        
    Config Type               : admin-vrrp    
    Backup-forward            : disabled     
    Fast-resume               : disabled                                                         
    Create Time               : 2011-10-18 11:14:48 UTC+10:59     
    Last Change Time          : 2011-10-18 14:02:46 UTC+10:59</pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>display vrrp 1</strong>
GigabitEthernet <span>0/2/1</span>.1 | Virtual Router 1                                                                                     
    <strong>State                  : Backup</strong>
    Virtual IP                : 10.1.1.3  
    Master IP                 : 10.1.1.1
    Local IP                  : 10.1.1.2
    PriorityRun               : 150     
    PriorityConfig            : 150    
    MasterPriority            : 200     
    Preempt                   : YES     Delay Time                : 0 s
    Hold Multiplier           : 3                                                                          
    TimerRun                  : 1 s 
    TimerConfig               : 1 s     
    Auth Type                 : NONE    
    Virtual MAC               : 00e0-fc12-3456   
    Check TTL                 : YES        
    Config Type               : admin-vrrp    
    Backup-forward            : disabled     
    Fast-resume               : disabled                                                                
    Create Time               : 2011-10-18 11:14:48 UTC+10:59     
    Last Change Time          : 2011-10-18 14:02:46 UTC+10:59
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>display vrrp 2</strong>
GigabitEthernet <span>0/2/1</span>.2 | Virtual Router 1                                                                                     
   <strong> State                  : Backup</strong>
    Virtual IP                : 10.1.2.3  
    Master IP                 : 10.1.2.1
    Local IP                  : 10.1.2.2
    PriorityRun               : 150     
    PriorityConfig            : 150    
    MasterPriority            : 200     
    Preempt                   : YES     Delay Time                : 0 s  
    Hold Multiplier           : 3                                                              
    TimerRun                  : 1 s 
    TimerConfig               : 1 s     
    Auth Type                 : NONE    
    Virtual MAC               : 00e0-fc12-3456   
    Check TTL                 : YES        
    Config Type               : admin-vrrp    
    Backup-forward            : disabled     
    Fast-resume               : disabled                                                                 
    Create Time               : 2011-10-18 11:14:48 UTC+10:59     
    Last Change Time          : 2011-10-18 14:02:46 UTC+10:59</pre>
</p></li><li><span>Bind the service-location group to the VRRP group on each CGN device.</span><p><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Corresponding one service-location group to one VRRP group is recommended.</p>
</div></div>
<p># Bind service-location group 1 to VRRP group 1 on CGN1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>service-location 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-location-1] <strong>vrrp vrid 1 interface GigabitEthernet <span>0/2/1</span></strong><strong>.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-location-1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-service-location-1] <strong>quit</strong></pre>
<p># Bind service-location group 2 to VRRP group 2 on CGN1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>service-location 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-location-2] <strong>vrrp vrid 2 interface GigabitEthernet <span>0/2/1</span></strong><strong>.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-location-2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-service-location-2] <strong>quit</strong></pre>
<p># Bind service-location group 1 to VRRP group 1 on CGN2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>service-location 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-location-1] <strong>vrrp vrid 1 interface GigabitEthernet <span>0/2/1</span>.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-location-1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-service-location-1] <strong>quit</strong></pre>
<p># Bind service-location group 2 to VRRP group 2 on CGN2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>service-location 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-location-2] <strong>vrrp vrid 2 interface GigabitEthernet <span>0/2/1</span></strong><strong>.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-location-2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-service-location-2] <strong>quit</strong></pre>
</p></li><li><span>Create a service-instance group on each of the master and backup devices and bind the service-instance group to the service-location group. (You must bind a service-instance group to an RBS. Otherwise, traffic is transmitted over the backup channel during a master/backup device switchover, affecting services.)</span><p><div class="p"># Configure CGN1.<ol type="a"><li><p>Configure an RBS named <strong>rbs</strong>.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>remote-backup-service rbs</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-rm-backup-srv-rbs] <strong>peer 10.1.1.2 source 10.1.1.1 port 7000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-rm-backup-srv-rbs] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-rm-backup-srv-rbs] <strong>quit</strong></pre>
</li><li><p>Create a service-instance group named <strong>group1</strong>, and bind it to service-location groups 1 and 2, and to RBS <strong>rbs</strong>.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>service-instance-group group1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-instance-group-group1] <strong>service-location 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-instance-group-group1] <strong>service-location 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-instance-group-group1] <strong>remote-backup-service rbs</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-service-instance-group-group1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-service-instance-group-group1] <strong>quit</strong></pre>
</li></ol>
</div>
<div class="p"># Configure CGN2.<ol type="a"><li><p>Configure an RBS named <strong>rbs</strong>.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>remote-backup-service rbs</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-rm-backup-srv-rbs] <strong>peer 10.1.1.1 source 10.1.1.2 port 7000</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-rm-backup-srv-rbs] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-rm-backup-srv-rbs] <strong>quit</strong></pre>
</li><li><p>Create a service-instance group named <strong>group1</strong>, and bind it to service-location groups 1 and 2, and to RBS <strong>rbs</strong>.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>service-instance-group group1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-instance-group-group1] <strong>service-location 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-instance-group-group1] <strong>service-location 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-instance-group-group1] <strong>remote-backup-service rbs</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-service-instance-group-group1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-service-instance-group-group1] <strong>quit</strong></pre>
</li></ol>
</div>
<p># Run the <a href="cmdqueryname=display+service-location"><b><span class="cmdname">display service-location</span></b></a> command on the two CGN devices to check HA information. In the command output, <strong>Vrrp state</strong> must be consistent with the HA state, and <strong>Batch-backup state</strong> indicates whether batch backup is completed.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>display service-location 1</strong>
service-location 1                                                                                             
 Backup scene type: inter-box                                                                                     
 Location slot ID: <span>1</span>                                                                                 
 Remote-backup interface: GigabitEthernet<span>0/2/1</span>.1                                                                   
 Peer: 10.1.1.2                                                                                           
 Vrrp ID: 1                                                                                       
 Vrrp bind interface: GigabitEthernet<span>0/2/1</span>.1                                                                    
 <strong>Vrrp state: master     </strong>                                                                                       
 Bound service-instance-group number: 1                                                                          
 <strong>Batch-backup state: finished</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>display service-location 2</strong>
service-location 2                                                                                              
 Backup scene type: inter-box                                                                                          
 Location slot ID: <span>1</span>                                                                                        
 Remote-backup interface: GigabitEthernet<span>0/2/1</span>.2                                                                              
 Peer: 10.1.2.2                                                                                                    
 Vrrp ID: 2                                                                                                           
 Vrrp bind interface: GigabitEthernet<span>0/2/1</span>.2                                                                                 
 <strong>Vrrp state: master</strong>                                                                                            
 Bound service-instance-group number: 1                                                                              
 <strong>Batch-backup state: finished</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>display service-location 1</strong>
service-location 1                                                                                               
 Backup scene type: inter-box 
 Location slot ID: <span>1</span>                                                                                       
 Remote-backup interface: GigabitEthernet<span>0/2/1</span>.1                                                                        
 Peer: 10.1.1.1                                                                                                   
 Vrrp ID: 1                                                                                                        
 Vrrp bind interface: GigabitEthernet<span>0/2/1</span>.1                                                                              
 <strong>Vrrp state: slave </strong>                                                                                              
 Bound service-instance-group number: 1                                                                              
 <strong>Batch-backup state: NA</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>display service-location 2</strong>
service-location 2                                                                                               
 Backup scene type: inter-box                                                                                          
 Location slot ID: <span>1</span>                                                                                        
 Remote-backup interface: GigabitEthernet<span>0/2/1</span>.2                                                                              
 Peer: 10.1.2.1                                                                                                     
 Vrrp ID: 2                                                                                                    
 Vrrp bind interface: GigabitEthernet<span>0/2/1</span>.2                                                                          
 <strong>Vrrp state: slave  </strong>                                                                                             
 Bound service-instance-group number: 1                                                                                  
 <strong>Batch-backup state: NA</strong></pre>
</p></li><li><span>Configure NAT instances.</span><p><p># Configure CGN1.</p>
<p>Configure a CGN global static address pool as the master address pool.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>nat ip-pool pool1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-nat-ip-pool-pool1] <strong>section 0 11.11.11.1 mask 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-nat-ip-pool-pool1] <strong>nat-instance subnet length initial 25 extend 27</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-nat-ip-pool-pool1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-nat-ip-pool-pool1] <strong>quit</strong></pre>
<p>Bind the NAT instance to the address pool.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>nat instance nat</strong><strong> id 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-nat-instance-nat] <strong>nat address-group group1 group-id 1 bind-ip-pool pool1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-nat-instance-nat] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-nat-instance-nat] <strong>quit</strong></pre>
<p># Configure CGN2.</p>
<p>Configure a CGN global static address pool. (You must configure the <strong>slave</strong> parameter. Otherwise, services will be affected.)</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>nat ip-pool pool1</strong><strong> slave</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-nat-ip-pool-pool1] <strong>section 0 11.11.11.1 mask 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-nat-ip-pool-pool1] <strong>nat-instance subnet length initial 25 extend 27</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-nat-ip-pool-pool1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-nat-ip-pool-pool1] <strong>quit</strong></pre>
<p>Bind the NAT instance to the address pool.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>nat instance nat</strong><strong> id 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-nat-instance-nat] <strong>nat address-group group1 group-id 1 bind-ip-pool pool1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-nat-instance-nat] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-nat-instance-nat] <strong>quit</strong></pre>
</p></li><li><span>Bind the NAT instance to the service-instance group on the master and backup devices.</span><p><p># On CGN1, bind the NAT instance named <strong>nat</strong> to the service-instance group named <strong>group1</strong>.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>nat instance nat id 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-nat-instance-nat] <strong>port-range 4096</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-nat-instance-nat] <strong>service-instance-group group1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-nat-instance-nat] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-nat-instance-nat] <strong>quit</strong></pre>
<p># On CGN2, bind the NAT instance named <strong>nat</strong> to the service-instance group named <strong>group1</strong>.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>nat instance nat id 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-nat-instance-nat] <strong>port-range 4096</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-nat-instance-nat] <strong>service-instance-group group1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-nat-instance-nat] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-nat-instance-nat] <strong>quit</strong></pre>
</p></li><li><span>Configure a traffic classification rule, a traffic behavior, and a NAT traffic diversion policy on the master and backup devices, and apply the NAT traffic diversion policy.</span><p><div class="p"># On CGN1, configure a NAT traffic diversion policy and a NAT conversion policy.<ol type="a"><li><p>Configure an ACL traffic classification rule.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>acl 3001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-acl4-advance-3001] <strong>rule 1 permit ip source 10.0.0.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-acl4-advance-3001] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-acl4-advance-3001] <strong>quit</strong></pre>
</li><li><p>Configure a traffic classifier.</p>
<pre class="screen">[<span class="keyword">*</span>CGN1] <strong>traffic classifier classifier1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-classifier-c1] <strong>if-match acl 3001</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-classifier-c1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-classifier-c1] <strong>quit</strong></pre>
</li><li><p>Define a traffic behavior, in which the action is configured as binding NAT instance <strong>nat</strong>.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>traffic behavior behavior1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-behavior-b1] <strong>nat bind instance nat</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-behavior-b1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-behavior-b1] <strong>quit</strong></pre>
</li><li><p>Define a NAT traffic diversion policy to associate the traffic classifier with the traffic behavior.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>traffic policy policy1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-trafficpolicy-p1] <strong>classifier classifier1 behavior behavior1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-trafficpolicy-p1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-trafficpolicy-p1] <strong>quit</strong></pre>
</li><li><p>Apply the NAT traffic diversion policy in the GE <span>0/2/2</span> interface view. <span>In VS mode, the <a href="cmdqueryname=traffic-policy"><b><span class="cmdname">traffic-policy</span></b></a> command is supported only by the admin VS.</span></p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>interface GigabitEthernet <span>0/2/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/2</span>] <strong>ip address 10.1.6.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/2</span>] <strong>traffic-policy policy1 inbound</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-GigabitEthernet<span>0/2/2</span>] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>quit</strong></pre>
</li><li><p>Configure a NAT traffic conversion policy.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>nat instance nat</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-nat-instance-nat] <strong>nat outbound any address-group group1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-nat-instance-nat] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-nat-instance-nat] <strong>quit</strong></pre>
</li></ol>
</div>
<p># The configuration of CGN2 is similar to the configuration of CGN1. For configuration details, see Configuration Files.</p>
</p><p><p># Run the <a href="cmdqueryname=display+nat+instance+nat"><b><span class="cmdname">display nat instance nat</span></b></a> command on the two CGN devices to check NAT configurations.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>display nat instance nat</strong>
nat instance nat id 1  
 port-range 4096                                                                                                   
 service-instance-group group1                                                                                             
 nat address-group group1 group-id 1 bind-ip-pool pool1                                                     
 nat outbound any address-group1</pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>display nat instance nat</strong>
nat instance nat id 1 
 port-range 4096                                                                                                   
 service-instance-group group1                                                                                             
 nat address-group group1 group-id 1 bind-ip-pool pool1                                                     
 nat outbound any address-group1</pre>
</p></li><li><span>Configure the master and backup devices to establish a BGP peer relationship with the user-side CE and import the default route advertised by the CR. Configure a local-preference-based route-policy on the user-side CE to allow the CE to preferentially select the default route from CGN1.</span><p><p># Configure CGN1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1] <strong>bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-bgp] <strong>peer 10.2.2.2 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-bgp] <strong>peer 10.2.2.2 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-bgp] <strong>ipv4-family unicast</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-bgp-af-ipv4] <strong>peer </strong><strong>10.2.2.2 default-route-advertise</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-bgp-af-ipv4]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-bgp-af-ipv4]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-bgp]<strong> import-route unr</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN1-bgp]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN1-bgp]<strong> quit</strong></pre>
<p># Configure CGN2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2] <strong>bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-bgp] <strong>peer 10.2.2.2 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-bgp] <strong>peer 10.2.</strong><strong>2.2</strong> <strong>connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-bgp] <strong>ipv4-family unicast</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-bgp-af-ipv4] <strong>peer </strong><strong>10.2.2.2 default-route-advertise</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-bgp-af-ipv4]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-bgp-af-ipv4]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-bgp]<strong> import-route unr</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CGN2-bgp]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CGN2-bgp]<strong> quit</strong></pre>
<p># Configure the user-side CE.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE] <strong>route-policy local_pre permit node 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-route-policy] <strong>apply local-preference 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-route-policy] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE-route-policy] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE] <strong>bgp 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp] <strong>peer 10.3.3.3 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp] <strong>peer 10.3.3.3 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp] <strong>peer 10.4.4.4 as-number 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp] <strong>peer 10.4.4.4 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp] <strong>ipv4-family unicast</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp-af-ipv4] <strong>peer 10.3.3.3 route-policy local_pre import</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp-af-ipv4]<strong> commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE-bgp-af-ipv4]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE-bgp]<strong> </strong><strong>import-route unr</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE-bgp]<strong> </strong><strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE-bgp]<strong> quit</strong></pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0279436213__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li id="EN-US_TASK_0279436213__li328531304214026"><p><a name="EN-US_TASK_0279436213__li328531304214026"></a><a name="li328531304214026"></a>CGN1 configuration file</p>
<pre class="screen">#
sysname CGN1
#
vsm on-board-mode disable
#
service-ha hot-backup enable
#
service-location 1
 location slot <span>1</span> 
 remote-backup interface GigabitEthernet <span>0/2/1</span>.1 peer 10.1.1.2
 vrrp vrid 1 interface GigabitEthernet <span>0/2/1</span>.1
#
service-location 2
 location slot <span>1</span> 
 remote-backup interface GigabitEthernet <span>0/2/1</span>.2 peer 10.1.2.2
 vrrp vrid 2 interface GigabitEthernet <span>0/2/1</span>.2
#
service-instance-group group1
 service-location 1
 service-location 2
 remote-backup-service rbs
#
nat ip-pool pool1
 nat-instance subnet length initial 25 extend 27
 section 0 11.11.11.1 mask 24
#
nat instance nat id 1
 port-range 4096
 service-instance-group group1
 nat address-group group1 group-id 1 bind-ip-pool pool1
 nat outbound any address-group group1
#
remote-backup-service rbs
 peer 10.1.1.2 source 10.1.1.1 port 7000
#
acl number 3001
 rule 1 permit ip source 10.0.0.0 0.0.0.255
#
traffic classifier classifier1 operator or
 if-match acl 3001 precedence 1
#
traffic behavior behavior1
 nat bind instance nat
#
traffic policy policy1
 share-mode
 classifier classifier1 behavior behavior1 precedence 1
#
license
 active nat session-table size 6 slot <span>1</span> 
 active nat session-table size 6 slot <span>1</span> 
 active nat bandwidth-enhance 100 slot <span>1</span>
#
interface GigabitEthernet<span>0/2/1</span>.1
 undo shutdown
 vlan-type dot1q 2001
 ip address 10.1.1.1 255.255.255.0
 vrrp vrid 1 virtual-ip 10.1.1.3
 admin-vrrp vrid 1 ignore-if-down
 vrrp vrid 1 priority 200
 vrrp vrid 1 track service-location 1 reduced 60
 vrrp vrid 1 track interface GigabitEthernet<span>0/2/2</span> reduced 60
 vrrp vrid 1 track interface GigabitEthernet<span>0/2/3</span> reduced 60
 vrrp vrid 1 preempt-mode timer delay 1500
 vrrp recover-delay 20
#
interface GigabitEthernet<span>0/2/1</span>.2
 undo shutdown
 vlan-type dot1q 2002
 ip address 10.1.2.1 255.255.255.0
 vrrp vrid 2 virtual-ip 10.1.2.3
 admin-vrrp vrid 2 ignore-if-down
 vrrp vrid 2 priority 200
 vrrp vrid 2 track service-location 2 reduced 60
 vrrp vrid 2 track interface GigabitEthernet<span>0/2/2</span> reduced 60
 vrrp vrid 2 track interface GigabitEthernet<span>0/2/3</span> reduced 60
 vrrp vrid 2 preempt-mode timer delay 1500
 vrrp recover-delay 20
#
interface GigabitEthernet<span>0/2/2</span>
 undo shutdown
 ip address 10.1.6.1 255.255.255.0
 traffic-policy policy1 inbound
#
interface GigabitEthernet<span>0/2/3</span>
 undo shutdown
 ip address 10.1.3.1 255.255.255.0
#
interface LoopBack0
 ip address 10.3.3.3 255.255.255.255
#
bgp 200
 peer 10.2.2.2 as-number 200
 peer 10.2.2.2 connect-interface Loopback0
 #
 ipv4-family unicast
  undo synchronization
  import-route unr
  peer 10.2.2.2 enable
  peer 10.2.2.2 default-route-advertise
#
return</pre>
</li><li><p>CGN2 configuration file</p>
<pre class="screen">#
sysname CGN2
#
vsm on-board-mode disable
#
service-ha hot-backup enable
#
service-location 1
 location slot <span>1</span> 
 remote-backup interface GigabitEthernet <span>0/2/1</span>.1 peer 10.1.1.1
 vrrp vrid 1 interface GigabitEthernet <span>0/2/1</span>.1
#
service-location 2
 location slot <span>1</span> 
 remote-backup interface GigabitEthernet <span>0/2/1</span>.2 peer 10.1.2.1
 vrrp vrid 2 interface GigabitEthernet <span>0/2/1</span>.2
#
service-instance-group group1
 service-location 1
 service-location 2
 remote-backup-service rbs
#
nat ip-pool pool1 slave
 nat-instance subnet length initial 25 extend 27
 section 0 11.11.11.1 mask 24
#
nat instance nat id 1
 port-range 4096
 service-instance-group group1
 nat address-group group1 group-id 1 bind-ip-pool pool1
 nat outbound any address-group group1
#
remote-backup-service natbras
 peer 10.1.1.1 source 10.1.1.2 port 7000
#
acl number 3001
 rule 1 permit ip source 10.0.0.0 0.0.0.255
#
traffic classifier classifier1 operator or
 if-match acl 3001 precedence 1
#
traffic behavior behavior1
 nat bind instance nat
#
traffic policy policy1
 share-mode
 classifier classifier1 behavior behavior1 precedence 1
#
license
 active nat session-table size 6 slot <span>1</span> 
 active nat session-table size 6 slot <span>1</span> 
 active nat bandwidth-enhance 100 slot <span>1</span> 
#
interface GigabitEthernet<span>0/2/1</span>.1
 undo shutdown
 vlan-type dot1q 2001
 ip address 10.1.1.2 255.255.255.0
 vrrp vrid 1 virtual-ip 10.1.1.3
 admin-vrrp vrid 1 ignore-if-down
 vrrp vrid 1 priority 150
 vrrp vrid 1 track service-location 1 reduced 60
 vrrp vrid 1 track interface GigabitEthernet<span>0/2/2</span> reduced 60
 vrrp vrid 1 track interface GigabitEthernet<span>0/2/3</span> reduced 60
#
interface GigabitEthernet<span>0/2/1</span>.2
 undo shutdown
 vlan-type dot1q 2002
 ip address 10.1.2.2 255.255.255.0
 vrrp vrid 2 virtual-ip 10.1.2.3
 admin-vrrp vrid 2 ignore-if-down
 vrrp vrid 2 priority 150
 vrrp vrid 2 track service-location 2 reduced 60
 vrrp vrid 2 track interface GigabitEthernet<span>0/2/2</span> reduced 60
 vrrp vrid 2 track interface GigabitEthernet<span>0/2/3</span> reduced 60
#
interface GigabitEthernet<span>0/2/2</span>
 undo shutdown
 ip address 10.1.4.1 255.255.255.0
 traffic-policy policy1 inbound
#
interface GigabitEthernet<span>0/2/3</span>
 undo shutdown
 ip address 10.1.5.1 255.255.255.0
#
interface LoopBack0
 ip address 10.4.4.4 255.255.255.255
#
bgp 200
 peer 10.2.2.2 as-number 200
 peer 10.2.2.2 connect-interface Loopback0
 #
 ipv4-family unicast
  undo synchronization
  import-route unr
  peer 10.2.2.2 enable
  peer 10.2.2.2 default-route-advertise
#
return</pre>
</li><li>CE configuration file<pre class="screen">#
sysname CE
#
interface GigabitEthernet<span>0/2/1</span>
 undo shutdown
 ip address 10.11.11.2 255.255.255.0
#
interface GigabitEthernet<span>0/2/2</span>
 undo shutdown
 ip address 10.11.12.2 255.255.255.0
#
interface LoopBack0
 ip address 10.2.2.2 255.255.255.255
#
route-policy local_pre permit node 10
 apply local-preference 200
#
bgp 200
 peer 10.3.3.3 as-number 200
 peer 10.3.3.3 connect-interface Loopback0
 peer 10.4.4.4 as-number 200
 peer 10.4.4.4 connect-interface Loopback0
 #
 ipv4-family unicast
  undo synchronization
  import-route unr
  peer 10.3.3.3 enable
  peer 10.3.3.3 route-policy local_pre import
  peer 10.4.4.4 enable
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_cgn-reliability_cfg_0043.html">Inter-Chassis Hot Backup
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_cgn-reliability_cfg_0029.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/ne/dc_ne_cgn-reliability_cfg_0026.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>