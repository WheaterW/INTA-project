
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring Path Calculation Based on Different Flex-Algos in L3VPN over OSPF SR-MPLS Flex-Algo LSP Scenarios">
<meta name="abstract" content="This section provides an example for configuring OSPF SR-MPLS Flex-Algo LSPs to meet the path customization requirements of L3VPN users.">
<meta name="description" content="This section provides an example for configuring OSPF SR-MPLS Flex-Algo LSPs to meet the path customization requirements of L3VPN users.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr-be_cfg_0007.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr-be_cfg_0015.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr_all_cfg_0161.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="w00606909,l00587852">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="Segment Routing MPLS">
<meta name="featuretype" content="Segment Routing">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="Segment Routing MPLS">
<meta name="featuretype" content="Segment Routing">
<meta name="featurename" content="Segment Routing MPLS">
<meta name="featuretype" content="Segment Routing">
<meta name="featurename" content="Segment Routing MPLS">
<meta name="featuretype" content="Segment Routing">
<meta name="OWNER" content="l00468467">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="l00468467">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0000001289965042">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<title>Example for Configuring Path Calculation Based on Different Flex-Algos in L3VPN over OSPF SR-MPLS Flex-Algo LSP Scenarios</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0000001289965042"></a><a name="EN-US_TASK_0000001289965042"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring Path Calculation Based on Different Flex-Algos in L3VPN over OSPF SR-MPLS Flex-Algo LSP Scenarios</h1>
<div class="taskbody"><p>This section provides an example for configuring OSPF SR-MPLS Flex-Algo LSPs to meet the path customization requirements of L3VPN users.</p>
<div class="context"><a name="EN-US_TASK_0000001289965042__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><div class="p">In <a href="#EN-US_TASK_0000001289965042__fig_dc_vrp_sr-be_cfg_000501">Figure 1</a>:<ul><li><p>CE1 and CE2 belong to a VPN instance named <strong>vpna</strong>.</p>
</li><li><p>The VPN target used by <strong>vpna</strong> is 111:1.</p>
</li></ul>
</div>
<p>To ensure secure communication between VPN users, configure L3VPN over OSPF SR-MPLS Flex-Algo LSP. Though PE1 and PE2 have multiple links in between, the service traffic needs to be forwarded over the specified link PE1 &lt;-&gt; P1 &lt;-&gt; PE2.</p>
<p>In this example, different Flex-Algos are defined to meet the service requirements of vpna.</p>
<div class="fignone" id="EN-US_TASK_0000001289965042__fig_dc_vrp_sr-be_cfg_000501"><a name="EN-US_TASK_0000001289965042__fig_dc_vrp_sr-be_cfg_000501"></a><a name="fig_dc_vrp_sr-be_cfg_000501"></a><span class="figcap"><b>Figure 1 </b>Networking for path calculation based on different Flex-Algos in L3VPN over OSPF SR-MPLS Flex-Algo LSP scenarios</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>Interfaces 1 through 3 in this example represent GE <span>0/1/0</span>, GE <span>0/2/0</span>, and GE <span>0/3/0</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0000001342524781.png"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001289965042__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Precautions</h4><p>During the configuration, note the following:</p>
<p>After a VPN instance is bound to a PE interface connected to a CE, Layer 3 configurations on this interface, such as IP address and routing protocol configurations, are automatically deleted. Add these configurations again if necessary.</p>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001289965042__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure IP addresses for interfaces.</p>
</li><li><p>Configure OSPF on the backbone network to ensure that PEs can interwork with each other.</p>
</li><li><p>Enable MPLS on the backbone network. </p>
</li><li>Configure FADs.</li><li><p>Configure SR and enable OSPF to advertise Flex-Algos for the establishment of Flex-Algo LSPs and common SR LSPs.</p>
</li><li>Configure the color extended community attribute for routes on PEs. This example uses the export policy to set the color extended community attribute for route advertisement, but you can alternatively use the import policy.</li><li><p>Configure MP-IBGP on PEs to exchange routing information.</p>
</li><li>Create a VPN instance and enable the IPv4 address family on each PE. Then, bind each PE's interface connected to a CE to the corresponding VPN instance.</li><li>Configure the mapping between the color extended community attribute and Flex-Algo.</li><li>Configure a tunnel policy for each PE to use Flex-Algo LSPs as the preferred tunnels.</li><li><p>Establish an EBGP peer relationship between each pair of a CE and a PE.</p>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001289965042__1.4.4"></a><a name="1.4.4"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li><p>MPLS LSR IDs on the PEs and Ps</p>
</li><li><p>VPN target and RD of vpna</p>
</li><li><p>SRGB ranges on PEs and Ps</p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0000001289965042__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure IP addresses for interfaces.</span><p><p># Configure PE1.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname PE1</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>PE1-LoopBack1] <strong>ip address 1.1.1.9 32</strong>
[<span class="keyword">*</span>PE1-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>PE1]<strong> interface gigabitethernet<span>0/1/0</span></strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>ip address 172.18.1.1 24</strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>PE1]<strong> interface gigabitethernet<span>0/3/0</span></strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>ip address 172.16.1.1 24</strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure P1.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname P1</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>P1-LoopBack1] <strong>ip address 2.2.2.9 32</strong>
[<span class="keyword">*</span>P1-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>P1]<strong> interface gigabitethernet<span>0/1/0</span></strong>
[<span class="keyword">*</span>P1-GigabitEthernet<span>0/1/0</span>] <strong>ip address 172.16.1.2 24</strong>
[<span class="keyword">*</span>P1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>P1]<strong> interface gigabitethernet<span>0/2/0</span></strong>
[<span class="keyword">*</span>P1-GigabitEthernet<span>0/2/0</span>] <strong>ip address 172.17.1.1 24</strong>
[<span class="keyword">*</span>P1-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>P1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname PE2</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>PE2-LoopBack1] <strong>ip address 3.3.3.9 32</strong>
[<span class="keyword">*</span>PE2-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>PE2]<strong> interface gigabitethernet<span>0/1/0</span></strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> ip address 172.19.1.2 24</strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> quit</strong>
[<span class="keyword">*</span>PE2]<strong> interface gigabitethernet<span>0/3/0</span></strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> ip address 172.17.1.2 24</strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> quit</strong>
[<span class="keyword">*</span>PE2]<strong> commit</strong></pre>
<p># Configure P2.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname P2</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>P2-LoopBack1] <strong>ip address 4.4.4.9 32</strong>
[<span class="keyword">*</span>P2-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>P2]<strong> interface gigabitethernet<span>0/1/0</span></strong>
[<span class="keyword">*</span>P2-GigabitEthernet<span>0/1/0</span>] <strong>ip address 172.18.1.2 24</strong>
[<span class="keyword">*</span>P2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>P2]<strong> interface gigabitethernet<span>0/2/0</span></strong>
[<span class="keyword">*</span>P2-GigabitEthernet<span>0/2/0</span>] <strong>ip address 172.19.1.1 24</strong>
[<span class="keyword">*</span>P2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>P2] <strong>commit</strong></pre>
</p></li><li><span>Configure an IGP on the backbone network for the PEs and Ps to communicate. OSPF is used as an example.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1] <strong>opaque-capability enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack1] <strong>ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1]<strong> interface gigabitethernet<span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/3/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure P1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-ospf-1] <strong>opaque-capability enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-ospf-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-LoopBack1] <strong>ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/1/0</span>] <strong>ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1]<strong> interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/2/0</span>] <strong>ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1] <strong>opaque-capability enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack1] <strong>ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> interface gigabitethernet<span>0/3/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/3/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>]<strong> quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2]<strong> commit</strong></pre>
<p># Configure P2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2] <strong>ospf 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-ospf-1] <strong>opaque-capability enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-ospf-1] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-ospf-1-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-ospf-1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2] <strong>interface loopback 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-LoopBack1] <strong>ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-LoopBack1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2]<strong> interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/1/0</span>] <strong>ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2]<strong> interface gigabitethernet<span>0/2/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/2/0</span>] <strong>ospf enable 1 area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>P2] <strong>commit</strong></pre>
</p></li><li><span>Configure basic MPLS functions on the backbone network.</span><p><p>Because MPLS is automatically enabled on the interface where OSPF has been enabled, you can ignore MPLS configuration on such an interface.</p>
</p><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls lsr-id 1.1.1.9</strong>
[<span class="keyword">*</span>PE1] <strong>mpls</strong>
[<span class="keyword">*</span>PE1-mpls] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-mpls] <strong>quit</strong></pre>
<p># Configure P1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1] <strong>mpls lsr-id 2.2.2.9</strong>
[<span class="keyword">*</span>P1] <strong>mpls</strong>
[<span class="keyword">*</span>P1-mpls] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1-mpls] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls lsr-id 3.3.3.9</strong>
[<span class="keyword">*</span>PE2] <strong>mpls</strong>
[<span class="keyword">*</span>PE2-mpls]<strong> commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-mpls]<strong> quit</strong></pre>
<p># Configure P2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2] <strong>mpls lsr-id 4.4.4.9</strong>
[<span class="keyword">*</span>P2] <strong>mpls</strong>
[<span class="keyword">*</span>P2-mpls] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2-mpls] <strong>quit</strong></pre>
</p></li><li><span>Configure FADs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>flex-algo identifier 128</strong> 
[<span class="keyword">*</span>PE1-flex-algo-128] <strong>priority 100</strong>   
[<span class="keyword">*</span>PE1-flex-algo-128] <strong>metric-type igp</strong>
[<span class="keyword">*</span>PE1-flex-algo-128] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>flex-algo identifier 129</strong>     
[<span class="keyword">*</span>PE1-flex-algo-129] <strong>priority 100</strong>
[<span class="keyword">*</span>PE1-flex-algo-129] <strong>metric-type igp</strong>
[<span class="keyword">*</span>PE1-flex-algo-129] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure P1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1] <strong>flex-algo identifier 128</strong> 
[<span class="keyword">*</span>P1-flex-algo-128] <strong>priority 100</strong>   
[<span class="keyword">*</span>P1-flex-algo-128] <strong>metric-type igp</strong>
[<span class="keyword">*</span>P1-flex-algo-128] <strong>quit</strong>
[<span class="keyword">*</span>P1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>flex-algo identifier 128</strong> 
[<span class="keyword">*</span>PE2-flex-algo-128] <strong>priority 100</strong>   
[<span class="keyword">*</span>PE2-flex-algo-128] <strong>metric-type igp</strong>
[<span class="keyword">*</span>PE2-flex-algo-128] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>flex-algo identifier 129</strong>     
[<span class="keyword">*</span>PE2-flex-algo-129] <strong>priority 100</strong>
[<span class="keyword">*</span>PE2-flex-algo-129] <strong>metric-type igp</strong>
[<span class="keyword">*</span>PE2-flex-algo-129] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure P2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2] <strong>flex-algo identifier 129</strong>     
[<span class="keyword">*</span>P2-flex-algo-129] <strong>priority 100</strong>
[<span class="keyword">*</span>P2-flex-algo-129] <strong>metric-type igp</strong>
[<span class="keyword">*</span>P2-flex-algo-129] <strong>quit</strong>
[<span class="keyword">*</span>P2] <strong>commit</strong></pre>
</p></li><li><span>Configure SR on the backbone network and enable OSPF to advertise Flex-Algos.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>segment-routing</strong>
[<span class="keyword">*</span>PE1-segment-routing] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>ospf 1</strong>
[<span class="keyword">*</span>PE1-ospf-1] <strong>segment-routing mpls</strong>
[<span class="keyword">*</span>PE1-ospf-1] <strong>segment-routing global-block 16000 23999</strong></pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The SRGB range varies according to the device. The configuration in this example is for reference only.</p>
</div></div>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-1] <strong>flex-algo 128</strong>
[<span class="keyword">*</span>PE1-ospf-1] <strong>flex-algo 129</strong>
[<span class="keyword">*</span>PE1-ospf-1] <strong>advertise link-attributes application flex-algo</strong>
[<span class="keyword">*</span>PE1-ospf-1] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>PE1-LoopBack1] <strong>ospf prefix-sid index 10</strong>
[<span class="keyword">*</span>PE1-LoopBack1] <strong>ospf prefix-sid index 110 flex-algo 128</strong>
[<span class="keyword">*</span>PE1-LoopBack1] <strong>ospf prefix-sid index 150 flex-algo 129</strong>
[<span class="keyword">*</span>PE1-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure P1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1] <strong>segment-routing</strong>
[<span class="keyword">*</span>P1-segment-routing] <strong>quit</strong>
[<span class="keyword">*</span>P1] <strong>ospf 1</strong>
[<span class="keyword">*</span>P1-ospf-1] <strong>segment-routing mpls</strong>
[<span class="keyword">*</span>P1-ospf-1] <strong>segment-routing global-block 16000 23999</strong></pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The SRGB range varies according to the device. The configuration in this example is for reference only.</p>
</div></div>
<pre class="screen">[<span class="keyword">*</span>P1-ospf-1] <strong>flex-algo 128</strong>
[<span class="keyword">*</span>P1-ospf-1] <strong>advertise link-attributes application flex-algo</strong>
[<span class="keyword">*</span>P1-ospf-1] <strong>quit</strong>
[<span class="keyword">*</span>P1] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>P1-LoopBack1] <strong>ospf prefix-sid index 20</strong>
[<span class="keyword">*</span>P1-LoopBack1] <strong>ospf prefix-sid index 220 flex-algo 128</strong>
[<span class="keyword">*</span>P1-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>P1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>segment-routing</strong>
[<span class="keyword">*</span>PE2-segment-routing] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>ospf 1</strong>
[<span class="keyword">*</span>PE2-ospf-1] <strong>segment-routing mpls</strong>
[<span class="keyword">*</span>PE2-ospf-1] <strong>segment-routing global-block 16000 23999</strong></pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The SRGB range varies according to the device. The configuration in this example is for reference only.</p>
</div></div>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-1] <strong>flex-algo 128</strong>
[<span class="keyword">*</span>PE2-ospf-1] <strong>flex-algo 129</strong>
[<span class="keyword">*</span>PE2-ospf-1] <strong>advertise link-attributes application flex-algo</strong>
[<span class="keyword">*</span>PE2-ospf-1] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>PE2-LoopBack1] <strong>ospf prefix-sid index 30</strong>
[<span class="keyword">*</span>PE2-LoopBack1] <strong>ospf prefix-sid index 330 flex-algo 128</strong>
[<span class="keyword">*</span>PE2-LoopBack1] <strong>ospf prefix-sid index 390 flex-algo 129</strong>
[<span class="keyword">*</span>PE2-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Configure P2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2] <strong>segment-routing</strong>
[<span class="keyword">*</span>P2-segment-routing] <strong>quit</strong>
[<span class="keyword">*</span>P2] <strong>ospf 1</strong>
[<span class="keyword">*</span>P2-ospf-1] <strong>segment-routing mpls</strong>
[<span class="keyword">*</span>P2-ospf-1] <strong>segment-routing global-block 16000 23999</strong></pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The SRGB range varies according to the device. The configuration in this example is for reference only.</p>
</div></div>
<pre class="screen">[<span class="keyword">*</span>P2-ospf-1] <strong>flex-algo 129</strong>
[<span class="keyword">*</span>P2-ospf-1] <strong>advertise link-attributes application flex-algo</strong>
[<span class="keyword">*</span>P2-ospf-1] <strong>quit</strong>
[<span class="keyword">*</span>P2] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>P2-LoopBack1] <strong>ospf prefix-sid index 40</strong>
[<span class="keyword">*</span>P2-LoopBack1] <strong>ospf prefix-sid index 440</strong><strong> flex-algo 129</strong>
[<span class="keyword">*</span>P2-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>P2] <strong>commit</strong></pre>
<p># After completing the configuration, run the <strong>display tunnel-info all</strong> command on each PE. The command output shows that SR LSPs have been established. The following example uses the command output on PE1 and PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display tunnel-info all</strong>
Tunnel ID            Type                Destination                             Status                                             
----------------------------------------------------------------------------------------                                            
0x000000002900000003 srbe-lsp            2.2.2.9                                 UP                                                 
0x000000002900000005 srbe-lsp            4.4.4.9                                 UP                                                 
0x000000002900000006 srbe-lsp            3.3.3.9                                 UP                                                 
0x000000009300000009 flex-algo-lsp       3.3.3.9                                 UP                                                 
0x00000000930000000a flex-algo-lsp       3.3.3.9                                 UP                                                 
0x00000000930000000b flex-algo-lsp       2.2.2.9                                 UP                                                 
0x00000000930000000c flex-algo-lsp       4.4.4.9                                 UP </pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>display tunnel-info all</strong>
Tunnel ID            Type                Destination                             Status                                             
----------------------------------------------------------------------------------------                                            
0x000000002900000004 srbe-lsp            2.2.2.9                                 UP                                                 
0x000000002900000005 srbe-lsp            1.1.1.9                                 UP                                                 
0x000000002900000006 srbe-lsp            4.4.4.9                                 UP                                                 
0x00000000930000000b flex-algo-lsp       2.2.2.9                                 UP                                                 
0x00000000930000000c flex-algo-lsp       4.4.4.9                                 UP                                                 
0x00000000930000000d flex-algo-lsp       1.1.1.9                                 UP                                                 
0x00000000930000000e flex-algo-lsp       1.1.1.9                                 UP </pre>
<p># Run the <a href="cmdqueryname=display+segment-routing+prefix+mpls+forwarding"><b><span class="cmdname">display segment-routing prefix mpls forwarding</span></b></a> <strong><span>flex-algo</span></strong> command to check the Flex-Algo-based SR label forwarding table.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display segment-routing prefix mpls forwarding flex-algo</strong>                                                                      

                   Segment Routing Prefix MPLS Forwarding Information                                                               
             --------------------------------------------------------------                                                         
             Role : I-Ingress, T-Transit, E-Egress, I&amp;T-Ingress And Transit                                                         

Prefix             Label      OutLabel   Interface         NextHop          Role  MPLSMtu   Mtu     State      Flexalgo             
-----------------------------------------------------------------------------------------------------------------------             
1.1.1.9/32         16110      NULL       Loop1             127.0.0.1        E     ---       1500    Active       128                
2.2.2.9/32         16220      3          GE<span>0/3/0</span>           172.16.1.2       I&amp;T   ---       1500    Active       128                
3.3.3.9/32         16330      16330      GE<span>0/3/0</span>           172.16.1.2       I&amp;T   ---       1500    Active       128                
1.1.1.9/32         16150      NULL       Loop1             127.0.0.1        E     ---       1500    Active       129                
3.3.3.9/32         16390      16390      GE<span>0/1/0</span>           172.18.1.2       I&amp;T   ---       1500    Active       129                
4.4.4.9/32         16440      3          GE<span>0/1/0</span>           172.18.1.2       I&amp;T   ---       1500    Active       129                

Total information(s): 6 </pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P1] <strong>display segment-routing prefix mpls forwarding flex-algo</strong>

                   Segment Routing Prefix MPLS Forwarding Information                                                               
             --------------------------------------------------------------                                                         
             Role : I-Ingress, T-Transit, E-Egress, I&amp;T-Ingress And Transit                                                         

Prefix             Label      OutLabel   Interface         NextHop          Role  MPLSMtu   Mtu     State      Flexalgo             
-----------------------------------------------------------------------------------------------------------------------             
1.1.1.9/32         16200      3          GE<span>0/1/0</span>           172.16.1.1       I&amp;T   ---       1500    Active       128                
2.2.2.9/32         16220      NULL       Loop1             127.0.0.1        E     ---       1500    Active       128                
3.3.3.9/32         16330      3          GE<span>0/2/0</span>           172.17.1.2       I&amp;T   ---       1500    Active       128                

Total information(s): 3 </pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>P2] <strong>display segment-routing prefix mpls forwarding flex-algo</strong>

                   Segment Routing Prefix MPLS Forwarding Information                                                               
             --------------------------------------------------------------                                                         
             Role : I-Ingress, T-Transit, E-Egress, I&amp;T-Ingress And Transit                                                         

Prefix             Label      OutLabel   Interface         NextHop          Role  MPLSMtu   Mtu     State      Flexalgo             
-----------------------------------------------------------------------------------------------------------------------             
1.1.1.9/32         16300      3          GE<span>0/1/0</span>           172.18.1.1       I&amp;T   ---       1500    Active       129                
3.3.3.9/32         16390      3          GE<span>0/2/0</span>           172.19.1.2       I&amp;T   ---       1500    Active       129                
4.4.4.9/32         16440      NULL       Loop1             127.0.0.1        E     ---       1500    Active       129                

Total information(s): 3  </pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>display segment-routing prefix mpls forwarding flex-algo</strong>

                   Segment Routing Prefix MPLS Forwarding Information                                                               
             --------------------------------------------------------------                                                         
             Role : I-Ingress, T-Transit, E-Egress, I&amp;T-Ingress And Transit                                                         

Prefix             Label      OutLabel   Interface         NextHop          Role  MPLSMtu   Mtu     State      Flexalgo             
-----------------------------------------------------------------------------------------------------------------------             
1.1.1.9/32         16110      16110      GE<span>0/3/0</span>           172.17.1.1       I&amp;T   ---       1500    Active       128                
2.2.2.9/32         16220      3          GE<span>0/3/0</span>           172.17.1.1       I&amp;T   ---       1500    Active       128                
3.3.3.9/32         16330      NULL       Loop1             127.0.0.1        E     ---       1500    Active       128                
1.1.1.9/32         16150      16150      GE<span>0/1/0</span>           172.19.1.1       I&amp;T   ---       1500    Active       129                
3.3.3.9/32         16390      NULL       Loop1             127.0.0.1        E     ---       1500    Active       129                
4.4.4.9/32         16440      3          GE<span>0/1/0</span>           172.19.1.1       I&amp;T   ---       1500    Active       129                

Total information(s): 6  </pre>
</p></li><li><span>Configure route-policies.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>route-policy color100 permit node 1</strong>
[<span class="keyword">*</span>PE1-route-policy] <strong>apply extcommunity color 0:100</strong>
[<span class="keyword">*</span>PE1-route-policy] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>route-policy color100 permit node 1</strong>
[<span class="keyword">*</span>PE2-route-policy] <strong>apply extcommunity color 0:100</strong>
[<span class="keyword">*</span>PE2-route-policy] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</p></li><li><span>Establish an MP-IBGP peer relationship between PEs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>peer 3.3.3.9 as-number 100</strong>
[<span class="keyword">*</span>PE1-bgp] <strong>peer 3.3.3.9 connect-interface loopback 1</strong>
[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpnv4</strong>
[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 3.3.3.9 enable</strong>
[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 3.3.3.9</strong><strong> route-policy color100 export</strong>
[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-af-vpnv4] <strong>quit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp] <strong>peer 1.1.1.9 as-number 100</strong>
[<span class="keyword">*</span>PE2-bgp] <strong>peer 1.1.1.9 connect-interface loopback 1</strong>
[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpnv4</strong>
[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 1.1.1.9 enable</strong>
[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 1.1.1.9</strong><strong> route-policy color100 export</strong>
[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp-af-vpnv4] <strong>quit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-bgp] <strong>quit</strong></pre>
<p>After completing the configuration, run the <strong>display bgp peer</strong> or <strong>display bgp vpnv4 all peer</strong> command on each PE to check whether a BGP peer relationship has been established between the PEs. If the <strong>Established</strong> state is displayed in the command output, the BGP peer relationship has been established successfully. The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display bgp peer</strong>

 BGP local router ID : 1.1.1.9
 Local AS number : 100
 Total number of peers : 1          Peers in established state : 1

  Peer            V    AS  MsgRcvd  MsgSent     OutQ  Up/Down    State        PrefRcv
  3.3.3.9         4   100        2        6     0     00:00:12   <strong>Established</strong>   0</pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display bgp vpnv4 all peer</strong>

 BGP local router ID : 1.1.1.9
 Local AS number : 100
 Total number of peers : 1                 Peers in established state : 1

  Peer            V    AS  MsgRcvd  MsgSent    OutQ  Up/Down    State        PrefRcv
  3.3.3.9         4   100   12      18         0     00:09:38   <strong>Established</strong>   0</pre>
</p></li><li><span>Create a VPN instance and enable the IPv4 address family on each PE. Then, bind each PE's interface connected to a CE to the corresponding VPN instance.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance vpna</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>ipv4-family</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 100:1</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet<span>0/2/0</span></strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpna</strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.1.1.2 24</strong>
[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance vpna</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>ipv4-family</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>route-distinguisher 200:1</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>vpn-target 111:1 both</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/2/0</span></strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>ip binding vpn-instance vpna</strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>ip address 10.2.1.2 24</strong>
[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/2/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
<p># Assign an IP address to each interface on CEs as shown in <a href="#EN-US_TASK_0000001289965042__fig_dc_vrp_sr-be_cfg_000501">Figure 1</a>. The detailed configuration procedure is not provided here. For configuration details, see the configuration files.</p>
<p>After completing the configuration, run the <strong>display ip vpn-instance verbose</strong> command on each PE to check the VPN instance configuration. The command output shows that each PE can ping its connected CE.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>If a PE has multiple interfaces bound to the same VPN instance, specify a source IP address using the <strong>-a</strong> <em>source-ip-address</em> parameter in the <strong>ping -vpn-instance</strong> <em>vpn-instance-name</em> <strong>-a</strong> <em>source-ip-address dest-ip-address</em> command to ping the CE that is connected to the remote PE. If the source IP address is not specified, the ping operation may fail.</p>
</div></div>
</p></li><li><span>Configure the mapping between the color extended community attribute and Flex-Algo.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>flex-algo color-mapping</strong>
[<span class="keyword">*</span>PE1-flex-algo-color-mapping] <strong>color 100 flex-algo 128 </strong>
[<span class="keyword">*</span>PE1-flex-algo-color-mapping] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</p><p><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>flex-algo color-mapping</strong>
[<span class="keyword">*</span>PE2-flex-algo-color-mapping] <strong>color 100 flex-algo 128 </strong>
[<span class="keyword">*</span>PE2-flex-algo-color-mapping] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</p></li><li><span>Configure a tunnel policy for each PE to use Flex-Algo LSPs as the preferred tunnels.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>tunnel-policy p1</strong>
[<span class="keyword">*</span>PE1-tunnel-policy-p1] <strong>tunnel select-seq flex-algo-lsp load-balance-number 1 unmix </strong>
[<span class="keyword">*</span>PE1-tunnel-policy-p1] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>ip vpn-instance vpna</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>ipv4-family</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>tnl-policy p1</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpna-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>PE1-vpn-instance-vpna] <strong>quit</strong>
[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>tunnel-policy p1</strong>
[<span class="keyword">*</span>PE2-tunnel-policy-p1] <strong>tunnel select-seq flex-algo-lsp load-balance-number 1 unmix</strong>
[<span class="keyword">*</span>PE2-tunnel-policy-p1] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>ip vpn-instance vpna</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>ipv4-family</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>tnl-policy p1</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpna-af-ipv4] <strong>quit</strong>
[<span class="keyword">*</span>PE2-vpn-instance-vpna] <strong>quit</strong>
[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</p></li><li><span>Establish an EBGP peer relationship between each CE-PE pair.</span><p><p># Configure CE1.</p>
<pre class="screen">&lt;<span class="keyword">HUAWEI</span>&gt; <strong>system-view</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span><span class="keyword">HUAWEI</span>] <strong>sysname CE1</strong>
[<span class="keyword">*</span><span class="keyword">HUAWEI</span>] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>interface loopback 1</strong>
[<span class="keyword">*</span>CE1-LoopBack1] <strong>ip address 10.11.1.1 32</strong>
[<span class="keyword">*</span>CE1-LoopBack1] <strong>quit</strong>
[<span class="keyword">*</span>CE1]<strong> interface gigabitethernet<span>0/1/0</span></strong>
[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/0</span>] <strong>ip address 10.1.1.1 24</strong>
[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong>
[<span class="keyword">*</span>CE1] <strong>bgp 65410</strong>
[<span class="keyword">*</span>CE1-bgp] <strong>peer 10.1.1.2 as-number 100</strong>
[<span class="keyword">*</span>CE1-bgp] <strong>network 10.11.1.1 32</strong>
[<span class="keyword">*</span>CE1-bgp] <strong>quit</strong>
[<span class="keyword">*</span>CE1] <strong>commit</strong></pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The configuration of CE2 is similar to the configuration of CE1. For detailed configurations, see Configuration Files.</p>
</div></div>
<p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>ipv4-family vpn-instance vpna</strong>
[<span class="keyword">*</span>PE1-bgp-vpna] <strong>peer 10.1.1.1 as-number 65410</strong>
[<span class="keyword">*</span>PE1-bgp-vpna] <strong>commit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp-vpna] <strong>quit</strong>
[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-bgp] <strong>quit</strong></pre>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>The configuration of PE2 is similar to the configuration of PE1. For detailed configurations, see Configuration Files.</p>
</div></div>
<p>After completing the configuration, run the <strong>display bgp vpnv4 vpn-instance peer</strong> command on the PEs to check whether BGP peer relationships have been established between the PEs and CEs. If the <strong>Established</strong> state is displayed in the command output, the BGP peer relationships have been established successfully.</p>
<p>The following example uses the command output on PE1 to show that a peer relationship has been established between PE1 and CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display bgp vpnv4 vpn-instance vpna peer</strong>

 BGP local router ID : 1.1.1.9
 Local AS number : 100

 VPN-Instance vpna, Router ID 1.1.1.9:
 Total number of peers : 1            Peers in established state : 1

  Peer            V    AS  MsgRcvd  MsgSent    OutQ  Up/Down    State        PrefRcv
  10.1.1.1        4   65410  11     9          0     00:06:37   <strong>Established</strong>  1</pre>
</p></li><li><span>Verify the configuration.</span><p><p>After completing the configuration, run the <strong>display ip routing-table vpn-instance</strong> command on each PE to check information about the loopback interface route toward a CE.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>display ip routing-table vpn-instance vpna</strong></pre>
<pre class="screen"><span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table: vpna
         Destinations : 7        Routes : 7
Destination/Mask    Proto  Pre  Cost     Flags NextHop         Interface
     10.1.1.0/24    Direct 0    0        D     10.1.1.2        GigabitEthernet<span>0/2/0</span>
     10.1.1.2/32    Direct 0    0        D     127.0.0.1       GigabitEthernet<span>0/2/0</span>
   10.1.1.255/32    Direct 0    0        D     127.0.0.1       GigabitEthernet<span>0/2/0</span>
   <strong>10.11.1.1/32</strong>     EBGP   255  0        RD    10.1.1.1        GigabitEthernet<span>0/2/0</span>
   <strong>10.22.2.2/32</strong>     IBGP   255  0        RD    3.3.3.9         GigabitEthernet<span>0/3/0</span>
     127.0.0.0/8    Direct 0    0        D     127.0.0.1       InLoopBack0 
255.255.255.255/32  Direct 0    0        D     127.0.0.1       InLoopBack0</pre>
<p>CEs in the same VPN can ping each other. For example, CE1 can ping CE2 at 10.22.2.2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>ping -a 10.11.1.1 10.22.2.2</strong>
  PING 10.22.2.2: 56  data bytes, press CTRL_C to break                                                                             
    Reply from 10.22.2.2: bytes=56 Sequence=1 ttl=252 time=5 ms                                                                     
    Reply from 10.22.2.2: bytes=56 Sequence=2 ttl=252 time=3 ms                                                                     
    Reply from 10.22.2.2: bytes=56 Sequence=3 ttl=252 time=3 ms                                                                     
    Reply from 10.22.2.2: bytes=56 Sequence=4 ttl=252 time=3 ms                                                                     
    Reply from 10.22.2.2: bytes=56 Sequence=5 ttl=252 time=4 ms                                                                     

  --- 10.22.2.2 ping statistics ---                                                                                                 
    5 packet(s) transmitted                                                                                                         
    5 packet(s) received                                                                                                            
    0.00% packet loss                                                                                                               
    round-trip min/avg/max = 3/3/5 ms</pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0000001289965042__1.4.6"></a><a name="1.4.6"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>PE1 configuration file</p>
<pre class="screen">#
sysname PE1
#
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 100:1
  tnl-policy p1
  apply-label per-instance
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
mpls lsr-id 1.1.1.9
#               
mpls            
#   
flex-algo identifier 128
 priority 100
#
flex-algo identifier 129
 priority 100
#
flex-algo color-mapping
 color 100 flex-algo 128
#            
segment-routing 
#               
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown  
 ip address 172.18.1.1 255.255.255.0
 ospf enable 1 area 0  
#               
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown  
 ip binding vpn-instance vpna
 ip address 10.1.1.2 255.255.255.0
#               
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown  
 ip address 172.16.1.1 255.255.255.0
 ospf enable 1 area 0   
#               
interface LoopBack1
 ip address 1.1.1.9 255.255.255.255
 ospf enable 1 area 0  
 ospf prefix-sid index 10
 ospf prefix-sid index 110 flex-algo 128
 ospf prefix-sid index 150 flex-algo 129
#               
bgp 100         
 peer 3.3.3.9 as-number 100
 peer 3.3.3.9 connect-interface LoopBack1
 #              
 ipv4-family unicast
  undo synchronization
  peer 3.3.3.9 enable
 #              
 ipv4-family vpnv4
  policy vpn-target
  peer 3.3.3.9 enable
  peer 3.3.3.9 route-policy color100 export
 #              
 ipv4-family vpn-instance vpna
  peer 10.1.1.1 as-number 65410
#               
ospf 1          
 opaque-capability enable
 segment-routing mpls
 segment-routing global-block 16000 23999
 advertise link-attributes application flex-algo
 flex-algo 128
 flex-algo 129
 area 0.0.0.0
#
route-policy color100 permit node 1                                                                                                 
 apply extcommunity color 0:100
#
tunnel-policy p1
 tunnel select-seq flex-algo-lsp load-balance-number 1 unmix 
#
return</pre>
</li><li><p>P1 configuration file</p>
<pre class="screen">#
sysname P1
#
mpls lsr-id 2.2.2.9
#               
mpls   
#                                                                                                                                   
flex-algo identifier 128                                                                                                            
 priority 100           
#               
segment-routing 
#               
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown  
 ip address 172.16.1.2 255.255.255.0
 ospf enable 1 area 0   
#               
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown  
 ip address 172.17.1.1 255.255.255.0
 ospf enable 1 area 0   
#               
interface LoopBack1
 ip address 2.2.2.9 255.255.255.255
 ospf enable 1 area 0  
 ospf prefix-sid index 20
 ospf prefix-sid index 220 flex-algo 128 
#               
ospf 1          
 opaque-capability enable
 segment-routing mpls
 segment-routing global-block 16000 23999
 advertise link-attributes application flex-algo
 flex-algo 128
 area 0.0.0.0
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
ip vpn-instance vpna
 ipv4-family
  route-distinguisher 200:1
  tnl-policy p1
  apply-label per-instance
  vpn-target 111:1 export-extcommunity
  vpn-target 111:1 import-extcommunity
#
mpls lsr-id 3.3.3.9
#               
mpls            
#               
flex-algo identifier 128
 priority 100
#
flex-algo identifier 129
 priority 100
#
flex-algo color-mapping
 color 100 flex-algo 128
#
segment-routing 
#               
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown  
 ip address 172.19.1.2 255.255.255.0
 ospf enable 1 area 0   
#               
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown  
 ip binding vpn-instance vpna
 ip address 10.2.1.2 255.255.255.0
#               
interface GigabitEthernet<span>0/3/0</span>
 undo shutdown  
 ip address 172.17.1.2 255.255.255.0
 ospf enable 1 area 0   
#               
interface LoopBack1
 ip address 3.3.3.9 255.255.255.255
 ospf enable 1 area 0  
 ospf prefix-sid index 30
 ospf prefix-sid index 330 flex-algo 128                                                                                            
 ospf prefix-sid index 390 flex-algo 129
#               
bgp 100         
 peer 1.1.1.9 as-number 100
 peer 1.1.1.9 connect-interface LoopBack1
 #              
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.9 enable
 #              
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.9 enable
  peer 1.1.1.9 route-policy color100 export
 #              
 ipv4-family vpn-instance vpna
  peer 10.2.1.1 as-number 65420
#               
ospf 1          
 opaque-capability enable
 segment-routing mpls
 segment-routing global-block 16000 23999
 advertise link-attributes application flex-algo
 flex-algo 128
 flex-algo 129
 area 0.0.0.0
#
route-policy color100 permit node 1                                                                                                 
 apply extcommunity color 0:100
#
tunnel-policy p1
 tunnel select-seq flex-algo-lsp load-balance-number 1 unmix 
#
return</pre>
</li><li><p>P2 configuration file</p>
<pre class="screen">#
sysname P2
#
mpls lsr-id 4.4.4.9
#               
mpls   
#                                                                                                                                   
flex-algo identifier 129                                                                                                            
 priority 100           
#               
segment-routing 
#               
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown  
 ip address 172.18.1.2 255.255.255.0
 ospf enable 1 area 0   
#               
interface GigabitEthernet<span>0/2/0</span>
 undo shutdown  
 ip address 172.19.1.1 255.255.255.0
 ospf enable 1 area 0   
#               
interface LoopBack1
 ip address 4.4.4.9 255.255.255.255
 ospf enable 1 area 0 
 ospf prefix-sid index 40
 ospf prefix-sid index 440 flex-algo 129 
#               
ospf 1          
 opaque-capability enable
 segment-routing mpls
 segment-routing global-block 16000 23999
 advertise link-attributes application flex-algo
 flex-algo 129
 area 0.0.0.0
#
return</pre>
</li><li><p>CE1 configuration file</p>
<pre class="screen">#
 sysname CE1
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.0
#
interface LoopBack1
 ip address 10.11.1.1 255.255.255.255
#
bgp 65410
 peer 10.1.1.2 as-number 100
 network 10.11.1.1 255.255.255.255
 #
 ipv4-family unicast
  peer 10.1.1.2 enable
#
return</pre>
</li><li><p>CE2 configuration file</p>
<pre class="screen">#
 sysname CE2
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.2.1.1 255.255.255.0
#
interface LoopBack1
 ip address 10.22.2.2 255.255.255.255
#
bgp 65420
 peer 10.2.1.2 as-number 100
 network 10.22.2.2 255.255.255.255
 #
 ipv4-family unicast
  peer 10.2.1.2 enable
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr-be_cfg_0007.html">Configuring Examples for SR-MPLS BE
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr-be_cfg_0015.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_sr_all_cfg_0161.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>
</body>
</html>