
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring Untagged+DSCP Policy-based L3VPN Access">
<meta name="abstract" content="This section provides an example of networking in which PE1 receives untagged packets carrying different differentiated services code point (DSCP) priorities. You can configure untagged+DSCP policies on the attachment circuit (AC)-side sub-interfaces of PE1 and bind these sub-interfaces to different virtual private network (VPN) instances. This configuration allows PE1 to forward packets to different VPN instances based on their DSCP priorities, differentiating services in VPN instances. In this example, the cell site gateway (CSG) transmits IP services.">
<meta name="description" content="This section provides an example of networking in which PE1 receives untagged packets carrying different differentiated services code point (DSCP) priorities. You can configure untagged+DSCP policies on the attachment circuit (AC)-side sub-interfaces of PE1 and bind these sub-interfaces to different virtual private network (VPN) instances. This configuration allows PE1 to forward packets to different VPN instances based on their DSCP priorities, differentiating services in VPN instances. In this example, the cell site gateway (CSG) transmits IP services.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_qinq_cfg_0023_1.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_qinq_cfg_0045.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="wwx1238417">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="QinQ">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="QinQ">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="featurename" content="QinQ">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="featurename" content="QinQ">
<meta name="featuretype" content="LAN Access and MAN Access">
<meta name="OWNER" content="c00648116,w00437000">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="wWX1238417">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0172363329">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/jquery.min.idp.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/RowOrColfreezeSupport.js"></script>

<script type="text/javascript">
setTimeout(function(){
	jQueryHW(document).ready(function(){
		jQueryHW("table[rowfreeze='yes']").rowfreeze();
		jQueryHW("table[colfreeze='yes']").colfreeze();
	});
},500);
</script>
<title>Example for Configuring Untagged+DSCP Policy-based L3VPN Access</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0172363329"></a><a name="EN-US_TASK_0172363329"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring Untagged+DSCP Policy-based L3VPN Access</h1>
<div class="taskbody"><p>This section provides an example of networking in which PE1 receives untagged packets carrying different differentiated services code point (DSCP) priorities. You can configure untagged+DSCP policies on the attachment circuit (AC)-side sub-interfaces of PE1 and bind these sub-interfaces to different virtual private network (VPN) instances. This configuration allows PE1 to forward packets to different VPN instances based on their DSCP priorities, differentiating services in VPN instances. In this example, the cell site gateway (CSG) transmits IP services.</p>
<div class="context"><a name="EN-US_TASK_0172363329__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>On a metro Ethernet (ME), virtual local area network (VLAN) IDs are usually used to differentiate services or users, and traffic is distributed to different virtual switching instances (VSIs), virtual private wire services (VPWSs), or VPN instances. When user or service packets do not carry VLAN tags, VLAN IDs cannot be used to differentiate the users or services, and traffic cannot be distributed based on the VLAN IDs. As a result, some high-priority traffic does not get scheduled properly when passing the carrier network, affecting user experience.</p>
<p>On the network shown in <a href="#EN-US_TASK_0172363329__fig_dc_vrp_qinq_cfg_005401">Figure 1</a>, packets forwarded by the CSG do not carry VLAN tags, so PE1 cannot differentiate the packets based on VLAN IDs. In this situation, traffic cannot be distributed to different VPN instances for transmission. To address this problem, deploy VLAN policies (untagged+DSCP) on PE1 so that PE1 can distribute packets to different VPN instances based on their DSCP priorities, ensuring that the packets get scheduled properly.</p>
<div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>In this example, PE1 parses the DSCP priorities in packets.</p>
<p>The DSCP field is carried in IP packets. To deploy VLAN policies (untagged+DSCP), ensure that the CSG transmits IP services.</p>
</div></div>
<div class="fignone" id="EN-US_TASK_0172363329__fig_dc_vrp_qinq_cfg_005401"><a name="EN-US_TASK_0172363329__fig_dc_vrp_qinq_cfg_005401"></a><a name="fig_dc_vrp_qinq_cfg_005401"></a><span class="figcap"><b>Figure 1 </b>Networking for untagged+DSCP for L3VPN access</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>In this example, interfaces 1 through 3 represent GE<span>0/1/1</span>, GE<span>0/1/2</span>, and GE<span>0/1/3</span>, respectively.</p>
</div></div>
<br><span><img class="vsd" src="figure/en-us_image_0000001640786477.png" width="NaN" height="NaN"></span></div>

<div class="tableBorder"><table cellpadding="4" cellspacing="0" summary="" rowfreeze="yes" frame="border" border="1" rules="all"><thead align="left"><tr><th align="left" class="cellrowborder" valign="top" width="14.05%" id="mcps1.4.1.6.1.4.1.1" liSelected="liSelected"><p>Device</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="56.52%" id="mcps1.4.1.6.1.4.1.2" liSelected="liSelected"><p>Interface</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="29.43%" id="mcps1.4.1.6.1.4.1.3" liSelected="liSelected"><p>IP Address</p>
</th>
</tr>
</thead>
<tbody><tr><td class="cellrowborder" rowspan="2" valign="top" width="14.05%" headers="mcps1.4.1.6.1.4.1.1 "><p>CE1</p>
</td>
<td class="cellrowborder" valign="top" width="56.52%" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/1</span>.1</p>
</td>
<td class="cellrowborder" valign="top" width="29.43%" headers="mcps1.4.1.6.1.4.1.3 "><p>192.168.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/1</span>.2</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.3 "><p>172.16.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="14.05%" headers="mcps1.4.1.6.1.4.1.1 "><p>CE2</p>
</td>
<td class="cellrowborder" valign="top" width="56.52%" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/1</span></p>
</td>
<td class="cellrowborder" valign="top" width="29.43%" headers="mcps1.4.1.6.1.4.1.3 "><p>192.168.2.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="14.05%" headers="mcps1.4.1.6.1.4.1.1 "><p>CE3</p>
</td>
<td class="cellrowborder" valign="top" width="56.52%" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/1</span></p>
</td>
<td class="cellrowborder" valign="top" width="29.43%" headers="mcps1.4.1.6.1.4.1.3 "><p>172.17.1.2/24</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="5" valign="top" width="14.05%" headers="mcps1.4.1.6.1.4.1.1 "><p>PE1</p>
</td>
<td class="cellrowborder" valign="top" width="56.52%" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/1</span>.1</p>
</td>
<td class="cellrowborder" valign="top" width="29.43%" headers="mcps1.4.1.6.1.4.1.3 "><p>192.168.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/1</span>.2</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.3 "><p>172.16.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/2</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.3 "><p>10.1.1.2/30</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/3</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.3 "><p>10.10.1.2/30</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.2 "><p>Loopback1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.3 "><p>1.1.1.9/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" valign="top" width="14.05%" headers="mcps1.4.1.6.1.4.1.1 "><p>PE2</p>
</td>
<td class="cellrowborder" valign="top" width="56.52%" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/1</span>.1</p>
</td>
<td class="cellrowborder" valign="top" width="29.43%" headers="mcps1.4.1.6.1.4.1.3 "><p>192.168.2.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/2</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.3 "><p>10.1.1.1/30</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.2 "><p>Loopback1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.3 "><p>2.2.2.9/32</p>
</td>
</tr>
<tr><td class="cellrowborder" rowspan="3" valign="top" width="14.05%" headers="mcps1.4.1.6.1.4.1.1 "><p>PE3</p>
</td>
<td class="cellrowborder" valign="top" width="56.52%" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/1</span>.1</p>
</td>
<td class="cellrowborder" valign="top" width="29.43%" headers="mcps1.4.1.6.1.4.1.3 "><p>172.17.1.1/24</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.2 "><p>GE<span>0/1/2</span></p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.3 "><p>10.10.1.1/30</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.2 "><p>Loopback1</p>
</td>
<td class="cellrowborder" valign="top" headers="mcps1.4.1.6.1.4.1.3 "><p>3.3.3.9/32</p>
</td>
</tr>
</tbody>
</table>
</div>
</div></div>
<div class="context"><a name="EN-US_TASK_0172363329__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure basic Layer 3 virtual private network (L3VPN) functions.</p>
<ol type="a"><li>Enable an Interior Gateway Protocol (IGP) on the backbone network for communication between <span class="keyword">Router</span>s on the backbone network.</li><li><p>Configure basic Multiprotocol Label Switching (MPLS) functions and MPLS Label Distribution Protocol (LDP), and set up MPLS label switched paths (LSPs) on the backbone network.</p>
</li><li><p>Set up LSPs between the provider edges (PEs).</p>
</li><li><p>Create VPN instances on the PEs.</p>
</li></ol>
</li><li><p>Configure VLAN policies (untagged+DSCP) and bind AC-side sub-interfaces of the PEs to the VPN instances.</p>
</li><li><p>Configure basic Layer 2 forwarding functions on the CSG.</p>
</li><li><p>Configure External Border Gateway Protocol (EBGP) on the customer edges (CEs) and PEs to exchange VPN routing information.</p>
</li><li><p>Establish Multiprotocol Internal Border Gateway Protocol (MP-IBGP) peer relationships between the PEs.</p>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0172363329__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li><p>IP address of each interface</p>
</li><li><p>Names of the VPN instances on the PEs</p>
</li><li><p>Route distinguishers (RDs) and VPN targets of the VPN instances</p>
</li><li><p>Numbers of the interfaces that are bound to the VPN instances</p>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0172363329__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure basic L3VPN functions.</span><p><ol type="a"><li><p>Configure an IP address for each interface of the CEs and PEs according to <a href="#EN-US_TASK_0172363329__fig_dc_vrp_qinq_cfg_005401">Figure 1</a>. For details, see configuration files in this example.</p>
</li><li><p>Configure an IGP on the MPLS backbone network. Open Shortest Path First (OSPF) is used in this example.</p>
<p>For details, see configuration files in this example.</p>
<p>After OSPF is configured, PE1 has an OSPF route to Loopback1 of PE2 and another OSPF route to Loopback1 of PE3. PE2 and PE3 each have an OSPF route to Loopback1 of PE1. In addition, the PEs can ping each other.</p>
<pre class="screen">&lt;PE1&gt; <strong>display ip routing-table</strong></pre>
<pre class="screen"><span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table: Public
         Destinations : 9        Routes : 9

Destination/Mask    Proto  Pre  Cost        Flags NextHop         Interface

      1.1.1.9/32    Direct 0    0             D   127.0.0.1       LoopBack1
      2.2.2.9/32    OSPF   10   1             D   10.1.1.1        GigabitEthernet<span>0/1/2</span>
      3.3.3.9/32    OSPF   10   1             D   10.10.1.1       GigabitEthernet<span>0/1/3</span>
     10.1.1.0/30    Direct 0    0             D   10.1.1.2        GigabitEthernet<span>0/1/2</span>
     10.1.1.2/32    Direct 0    0             D   127.0.0.1       GigabitEthernet<span>0/1/2</span>
    10.10.1.0/30    Direct 0    0             D   10.10.1.2       GigabitEthernet<span>0/1/3</span>
    10.10.1.2/32    Direct 0    0             D   127.0.0.1       GigabitEthernet<span>0/1/3</span>
     127.0.0.0/8    Direct 0    0             D   127.0.0.1       InLoopBack0
    127.0.0.1/32    Direct 0    0             D   127.0.0.1       InLoopBack0
                                                                             </pre>
<pre class="screen">&lt;PE1&gt; <strong>ping 2.2.2.9</strong></pre>
<pre class="screen">PING 2.2.2.9: 56  data bytes, press CTRL_C to break
    Reply from 2.2.2.9: bytes=56 Sequence=1 ttl=255 time=120 ms
    Reply from 2.2.2.9: bytes=56 Sequence=2 ttl=255 time=90 ms
    Reply from 2.2.2.9: bytes=56 Sequence=3 ttl=255 time=90 ms
    Reply from 2.2.2.9: bytes=56 Sequence=4 ttl=255 time=90 ms
    Reply from 2.2.2.9: bytes=56 Sequence=5 ttl=255 time=90 ms

  --- 2.2.2.9 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 90/96/120 ms</pre>
</li><li><p>Enable basic MPLS functions and LDP on the MPLS backbone network.</p>
<p>For details, see configuration files in this example.</p>
<p>After MPLS LSPs are set up, LDP sessions are set up between PE1 and PE2 and between PE1 and PE3. The <strong><span>display mpls ldp session</span></strong> command output shows that the <strong>Status</strong> field is <strong>Operational</strong>.</p>
<pre class="screen">&lt;PE1&gt; <strong>display mpls ldp session</strong></pre>
<pre class="screen"> LDP Session(s) in Public Network
 Codes: LAM(Label Advertisement Mode), SsnAge Unit(DDDD:HH:MM)
<span> An asterisk (*) before a session means the session is being deleted.</span>
 ------------------------------------------------------------------------------
 PeerID             Status      LAM  SsnRole  SsnAge      KASent/Rcv
 ------------------------------------------------------------------------------
 2.2.2.9:0          Operational DU   Passive  0000:00:00  3/3
 3.3.3.9:0          Operational DU   Passive  0000:00:00  2/2
 ------------------------------------------------------------------------------
 TOTAL: 2 session(s) Found.   </pre>
</li><li><p>Configure VPN instances.</p>
<p># Configure PE1.</p>
<pre class="screen">&lt;PE1&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 100:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>ip vpn-instance vpn2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn2] <strong>route-distinguisher 100:2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn2-af-ipv4] <strong>vpn-target 100:2 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-vpn2-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-vpn-instance-vpn2-af-ipv4] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">&lt;PE2&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>ip vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1] <strong>route-distinguisher 100:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1-af-ipv4] <strong>vpn-target 100:1 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-vpn1-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-vpn-instance-vpn1-af-ipv4] <strong>quit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">&lt;PE3&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>ip vpn-instance vpn2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn2] <strong>route-distinguisher 100:2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn2-af-ipv4] <strong>vpn-target 100:2 both</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-vpn2-af-ipv4] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3-vpn-instance-vpn2-af-ipv4] <strong>quit</strong></pre>
</li></ol>
</p></li><li><span>Configure VLAN policies (untagged+DSCP) and bind AC-side sub-interfaces of the PEs to the VPN instances.</span><p><p># Configure PE1.</p>
<pre class="screen">&lt;PE1&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet <span>0/1/1</span>.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>.1] <strong>untagged dscp 3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>.1] <strong>ip binding vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>.1] <strong>ip address 192.168.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>.1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet <span>0/1/1</span>.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>.2] <strong>untagged dscp 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>.2] <strong>ip binding vpn-instance vpn2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>.2] <strong>ip address 172.16.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>.2] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/1/1</span>.2] <strong>quit</strong></pre>
<p># Configure PE2.</p>
<pre class="screen">&lt;PE2&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet <span>0/1/1</span>.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>.1] <strong>ip binding vpn-instance vpn1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>.1] <strong>ip address 192.168.2.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>.1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2-GigabitEthernet<span>0/1/1</span>.1] <strong>quit</strong></pre>
<p># Configure PE3.</p>
<pre class="screen">&lt;PE3&gt; <strong>system-view</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface gigabitethernet <span>0/1/1</span>.1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>.1] <strong>ip binding vpn-instance vpn2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>.1] <strong>ip address 172.17.1.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>.1] <strong>commit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3-GigabitEthernet<span>0/1/1</span>.1] <strong>quit</strong></pre>
<p>After the configurations are complete, run the <strong><span>display ip vpn-instance verbose</span></strong> command on the PEs to view the configurations of VPN instances.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>display ip vpn-instance verbose</strong></pre>
<pre class="screen"> Total VPN-Instances configured : 2
 Total IPv4 VPN-Instances configured : 2
 Total IPv6 VPN-Instances configured : 0

  VPN-Instance Name and ID : vpn1, 1
  Address family ipv4
  Create date : 2009/09/01 17:22:49
  Up time : 0 days, 00 hours, 11 minutes and 46 seconds
  Vrf Status : UP
  Route Distinguisher : 100:1
  Export VPN Targets :  100:1
  Import VPN Targets :  100:1
  Label Policy : label per route
  The diffserv-mode Information is : uniform
  The ttl-mode Information is : pipe
  Log Interval : 5
  Interfaces : GigabitEthernet<span>0/1/1</span>.1

  VPN-Instance Name and ID : vpn2, 2
  Address family ipv4
  Create date : 2009/09/01 17:27:07
  Up time : 0 days, 00 hours, 07 minutes and 28 seconds
  Route Distinguisher : 100:2
  Export VPN Targets :  200:2
  Import VPN Targets :  200:2
  Label Policy : label per route
  The diffserv-mode Information is : uniform
  The ttl-mode Information is : pipe
  Log Interval : 5
  Interfaces : GigabitEthernet<span>0/1/1</span>.2  </pre>
</p></li><li><span>Configure basic functions on the CSG.</span><p><div class="p">The configuration details are not provided here. The CSG must meet the following conditions:<ul><li><p>Support for DSCP priority configuration using commands</p>
</li></ul>
</div>
</p></li><li><span>Establish EBGP peer relationships between the PEs and CEs and import VPN routes.</span><p><p>For details, see the chapter "BGP/MPLS IP VPN Configuration" in the <em><span class="keyword">NE40E</span> Configuration Guide - VPN</em> or configuration files in this example.</p>
</p></li><li><span>Establish MP-IBGP peer relationships between the PEs.</span><p><p>For details, see the chapter "BGP/MPLS IP VPN Configuration" in the <em><span class="keyword">NE40E</span> Configuration Guide - VPN</em> or configuration files in this example.</p>
</p></li><li><span>Verify the configuration.</span><p><p>After the configurations are complete, run the <strong><span>display bgp peer</span></strong> command on the PEs. The command outputs show that BGP peer relationships are established between the PEs and in the Established state.</p>
<div class="p">The command output on PE1 is used as an example.<pre class="screen">[<span class="keyword">*</span>PE1] <strong>display bgp peer</strong></pre>
<pre class="screen"> BGP local router ID : 1.1.1.9
 Local AS number : 100
 Total number of peers : 2                 Peers in established state : 2

  Peer        V      AS  MsgRcvd  MsgSent  OutQ  Up/Down    State       PrefRcv

  2.2.2.9     4      100    10     15       0    00:04:53   <strong><span>Established</span></strong>   0
  3.3.3.9     4      100    6      11       0    00:01:06   <strong><span>Established</span></strong>   2</pre>
</div>
<p>Run the <strong><span>display ip routing-table vpn-instance</span></strong> command on the PEs to view the routes to peer CEs.</p>
<div class="p">The following example uses the command output on PE1.<pre class="screen">[<span class="keyword">*</span>PE1] <strong>display ip routing-table vpn-instance vpn1</strong></pre>
<pre class="screen"><span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table: vpn1
         Destinations : 3        Routes : 3

Destination/Mask   Proto  Pre  Cost      Flags NextHop       Interface

  192.168.1.0/24   Direct 0    0         D     192.168.1.1   GigabitEthernet<span>0/1/1</span>.1
  192.168.1.1/32   Direct 0    0         D     127.0.0.1     GigabitEthernet<span>0/1/1</span>.1
  192.168.2.0/24   BGP    255  0         RD    2.2.2.9       GigabitEthernet<span>0/1/2</span></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>display ip routing-table vpn-instance vpn2</strong></pre>
<pre class="screen">Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Table: vpn1
         Destinations : 3        Routes : 3

Destination/Mask   Proto  Pre  Cost      Flags NextHop       Interface

   172.16.1.0/24   Direct 0    0         D     172.16.1.1    GigabitEthernet<span>0/1/1</span>.2
   172.16.1.1/32   Direct 0    0         D     127.0.0.1     InLoopBack0
   172.17.1.0/24   BGP    255  0         RD    3.3.3.9       GigabitEthernet<span>0/1/3</span></pre>
</div>
<p>Run the <strong><span>display interface vlan</span></strong> command to view the VLAN policy configured on a specified interface.</p>
<p>The following example uses the command output on PE1.</p>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>display interface gigabitethernet<span>0/1/1</span> vlan untagged</strong></pre>
<pre class="screen">Interface           VlanPolicy
-----------------------------------------------------------
GE<span>0/1/1</span>.2           dscp 2
GE<span>0/1/1</span>.1           dscp 3
-----------------------------------------------------------
Interface:GE<span>0/1/1</span> VLAN ID: UNTAGGED Sub-Interface num: 2  </pre>
</p></li></ol></div>
<div class="example"><a name="EN-US_TASK_0172363329__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>PE1 configuration file</p>
<pre class="screen">#
 sysname PE1
#
ip vpn-instance vpn1
 route-distinguisher 100:1
 apply-label per-instance
 vpn-target 100:1 export-extcommunity
 vpn-target 100:1 import-extcommunity
ip vpn-instance vpn2
 route-distinguisher 100:2
 apply-label per-instance
 vpn-target 100:2 export-extcommunity
 vpn-target 100:2 import-extcommunity
#
 mpls lsr-id 1.1.1.9
 mpls
#
 mpls l2vpn
#
mpls ldp
#
interface GigabitEthernet<span>0/1/1</span>.1
 untagged dscp 3
 ip binding vpn-instance vpn1
 ip address 192.168.1.1 255.255.255.0
#
interface GigabitEthernet<span>0/1/1</span>.2
 untagged dscp 2
 ip binding vpn-instance vpn2
 ip address 172.16.1.1 255.255.255.0
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 10.1.1.2 255.255.255.252
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/3</span>
 undo shutdown
 ip address 10.10.1.2 255.255.255.252
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 1.1.1.9 255.255.255.255
#
bgp 100
 peer 2.2.2.9 as-number 100
 peer 2.2.2.9 connect-interface LoopBack1
 peer 3.3.3.9 as-number 100
 peer 3.3.3.9 connect-interface LoopBack1
 #
 ipv4-family unicast
 undo synchronization
  peer 2.2.2.9 enable
  peer 3.3.3.9 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 2.2.2.9 enable
  peer 3.3.3.9 enable
 #
 ipv4-family vpn-instance vpn1
  import-route direct
  peer 192.168.1.2 as-number 65410
 #
 ipv4-family vpn-instance vpn2
  import-route direct
  peer 172.16.1.2 as-number 65410
#
ospf 1
 area 0.0.0.0
  network 1.1.1.9 0.0.0.0
  network 10.1.1.0 0.0.0.3
  network 10.10.1.0 0.0.0.3
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
 sysname PE2
#
ip vpn-instance vpn1
 route-distinguisher 100:1
 apply-label per-instance
 vpn-target 100:1 export-extcommunity
 vpn-target 100:1 import-extcommunity
#
 mpls lsr-id 2.2.2.9
 mpls
#
 mpls l2vpn
#
mpls ldp
#
interface GigabitEthernet<span>0/1/1</span>.1
 ip binding vpn-instance vpn1
 ip address 192.168.2.1 255.255.255.0
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.252
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 2.2.2.9 255.255.255.255
#
bgp 100
 peer 1.1.1.9 as-number 100
 peer 1.1.1.9 connect-interface LoopBack1
 #
 ipv4-family unicast
 undo synchronization
 peer 1.1.1.9 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.9 enable
 #
 ipv4-family vpn-instance vpn1
  import-route direct
  peer 192.168.2.2 as-number 65420
#
ospf 1
 area 0.0.0.0
  network 2.2.2.9 0.0.0.0
  network 10.1.1.0 0.0.0.3
#
return</pre>
</li><li><p>PE3 configuration file</p>
<pre class="screen">#
 sysname PE3
#
ip vpn-instance vpn2
 route-distinguisher 100:2
 apply-label per-instance
 vpn-target 100:2 export-extcommunity
 vpn-target 100:2 import-extcommunity
#
 mpls lsr-id 3.3.3.9
 mpls
#
 mpls l2vpn
#
mpls ldp
#
interface GigabitEthernet<span>0/1/1</span>.1
 ip binding vpn-instance vpn2
 ip address 172.17.1.1 255.255.255.0
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 10.10.1.1 255.255.255.252
 mpls
 mpls ldp
#
interface LoopBack1
 ip address 3.3.3.9 255.255.255.255
#
bgp 100
 peer 3.3.3.9 as-number 100
 peer 3.3.3.9 connect-interface LoopBack1
 #
 ipv4-family unicast
  undo synchronization
  peer 1.1.1.9 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 1.1.1.9 enable
 #
 ipv4-family vpn-instance vpn1
  import-route direct
  peer 172.17.1.2 as-number 65421
#
ospf 1
 area 0.0.0.0
  network 3.3.3.9 0.0.0.0
  network 10.10.1.0 0.0.0.3
#
return</pre>
</li><li><p>CE1 configuration file</p>
<pre class="screen">#
 sysname CE1
#
interface GigabitEthernet<span>0/1/1</span>.1
 undo shutdown
 ip address 192.168.1.2 255.255.255.0
bgp 65410
 peer 192.168.1.1 as-number 100
#
interface GigabitEthernet<span>0/1/2</span>.1
 undo shutdown
 ip address 172.16.1.2 255.255.255.0
bgp 65410
 peer 172.16.1.1 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 192.168.1.1 enable
  peer 172.16.1.1 enable
#
return</pre>
</li><li><p>CE2 configuration file</p>
<pre class="screen">#
 sysname CE2
#
interface GigabitEthernet<span>0/1/1</span>.1
 undo shutdown
 ip address 192.168.2.2 255.255.255.0
bgp 65420
 peer 192.168.2.1 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 192.168.2.1 enable
#
return</pre>
</li><li><p>CE3 configuration file</p>
<pre class="screen">#
 sysname CE3
#
interface GigabitEthernet<span>0/1/1</span>.1
 undo shutdown
 ip address 172.17.1.2 255.255.255.0
bgp 65421
 peer 172.17.1.1 as-number 100
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 172.17.1.1 enable
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_qinq_cfg_0023_1.html">Configuration Examples for QinQ
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_qinq_cfg_0045.html"><span class="font-st">&lt; </span>Previous topic</a>
</div>
</div>
</body>
</html>