
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-us" xml:lang="en-us">
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="DC.Type" content="task">
<meta name="DC.Title" content="Example for Configuring Dual-Root 1+1 Protection for Intra-AS Segmented Tunnels">
<meta name="abstract" content="This section provides an example for configuring dual-root 1+1 protection for NG MVPN in intra-AS segmented tunnel scenarios.">
<meta name="description" content="This section provides an example for configuring dual-root 1+1 protection for NG MVPN in intra-AS segmented tunnel scenarios.">
<meta name="product" content="">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0012.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0104.html">
<meta name="DC.Relation" scheme="URI" content="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0073.html">
<meta name="prodname" content="">
<meta name="version" content="">
<meta name="brand" content="Product Documentation-V8R23C00">
<meta name="DC.Creator" content="z00603461,w00606909,w00447999">
<meta name="DC.Publisher" content="20240229">
<meta name="featurename" content="IPv4 Multicast VPN_NG MVPN">
<meta name="featuretype" content="IP Multicast">
<meta name="DC.Audience.Job" content="Configuration">
<meta name="featurename" content="IPv4 Multicast VPN_NG MVPN">
<meta name="featuretype" content="IP Multicast">
<meta name="featurename" content="IPv4 Multicast VPN_NG MVPN">
<meta name="featuretype" content="IP Multicast">
<meta name="featurename" content="IPv4 Multicast VPN_NG MVPN">
<meta name="featuretype" content="IP Multicast">
<meta name="OWNER" content="w00447999">
<meta name="IA" content="">
<meta name="SE" content="">
<meta name="TE" content="">
<meta name="LASTMODIFIER" content="w00447999">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="EN-US_TASK_0000001270153593">
<meta name="DC.Language" content="en-us">
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/commonltr.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/browseVersion.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../public_sys-resources/thickbox.css">
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/imageResize.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery-migrate-1.2.1.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery-ui.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/jquery.mousewheel.min.js"></script>
<script language="javascript" type="text/javascript" src="../../../../public_sys-resources/thickbox.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/jquery.min.idp.js"></script>
<script type="text/javascript" src="../../../../public_sys-resources/RowOrColfreezeSupport.js"></script>

<script type="text/javascript">
setTimeout(function(){
	jQueryHW(document).ready(function(){
		jQueryHW("table[rowfreeze='yes']").rowfreeze();
		jQueryHW("table[colfreeze='yes']").colfreeze();
	});
},500);
</script>
<title>Example for Configuring Dual-Root 1+1 Protection for Intra-AS Segmented Tunnels</title>

<style type="text/css">
			<!--	pre.screen,pre.codeblock{
					word-wrap:break-word;
					word-break:break-all;
					white-space:pre-wrap !important;
				}-->
		</style>
</head>
<body><a name="EN-US_TASK_0000001270153593"></a><a name="EN-US_TASK_0000001270153593"></a>

<div class="articleBoxWithoutHead">
<h1 class="topicTitle-h1">Example for Configuring Dual-Root 1+1 Protection for Intra-AS Segmented Tunnels</h1>
<div class="taskbody"><p>This section provides an example for configuring dual-root 1+1 protection for NG MVPN in intra-AS segmented tunnel scenarios.</p>
<div class="context"><a name="EN-US_TASK_0000001270153593__1.4.1"></a><a name="1.4.1"></a>
<div class="p"><h4 class="sectiontitle">Networking Requirements</h4><p>In an NG MVPN scenario, if a sender PE on a P2MP tunnel fails, the C-multicast service will be interrupted. The network can rely only on unicast route convergence for recovery. However, unicast route convergence takes a long time and may fail to meet the high reliability requirements of some multicast services. To resolve this issue, configure dual-root 1+1 protection based on traffic detection. On the network shown in <a href="#EN-US_TASK_0000001270153593__fig_dc_vrp_cfg_ngmvpn_010101">Figure 1</a>, when links are working properly, the same multicast traffic is forwarded along both the primary and backup tunnels. Leaf node PE3 selects the multicast traffic from the primary tunnel (rooted at PE1) and discards the multicast traffic from the backup tunnel (rooted at PE2). If PE1 fails, the leaf nodes can use traffic detection technology to quickly detect the tunnel fault and choose to accept the multicast traffic received from the backup tunnel. This accelerates multicast service convergence and improves reliability.</p>
<div class="fignone" id="EN-US_TASK_0000001270153593__fig_dc_vrp_cfg_ngmvpn_010101"><a name="EN-US_TASK_0000001270153593__fig_dc_vrp_cfg_ngmvpn_010101"></a><a name="fig_dc_vrp_cfg_ngmvpn_010101"></a><span class="figcap"><b>Figure 1 </b>Configuring dual-root 1+1 protection for intra-AS segmented tunnels</span><div class="note"><img src="../../../../public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p>In this example, interface1, interface2, and interface3 represent GE <span>0/1/0</span>, GE <span>0/1/1</span>, and GE <span>0/1/2</span>, respectively.</p>
</div></div>
<br><span><img class="imgResize" src="figure/en-us_image_0000001225513856.png" width="522.69" height="209.076" title="Click to enlarge"></span></div>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001270153593__1.4.2"></a><a name="1.4.2"></a>
<div class="p"><h4 class="sectiontitle">Configuration Roadmap</h4><p>The configuration roadmap is as follows:</p>
<ol><li><p>Configure BGP/MPLS IP VPN to ensure that the unicast VPN is running properly.</p>
</li><li><p>Enable P2MP TE globally on PE1, PE2, ABR1, and ABR2, and configure a P2MP TE template so that PE1, PE2, ABR1, and ABR2 can use RSVP-TE to establish P2MP tunnels.</p>
</li><li><p>Enable mLDP globally on ABR1, ABR2, and PE3 so that ABR1, ABR2, and PE3 can use mLDP to establish P2MP tunnels.</p>
</li><li><p>Enable all PEs and ABRs to establish BGP MVPN peer relationships and configure BGP to transmit A-D and C-multicast routes.</p>
</li><li><p>Configure PE1 and PE2 as sender PEs. Configure P2MP TE on PE1 and PE2 so that two P2MP TE tunnels rooted at PE1 and PE2 can be established. Configure ABR1 and ABR2 as leaf nodes of the two tunnels.</p>
</li><li><p>Configure ABR1 and ABR2 to support segmented tunnels and configure tunnel stitching so that two mLDP P2MP tunnels are established, with one rooted at ABR1 and the other rooted at ABR2. Configure PE3 as a leaf node of both tunnels.</p>
</li><li><p>Configure VPN FRR on PE3 so that PE3 can have two routes to the multicast source. PE3 uses the route advertised by PE1 as the primary route and the route advertised by PE2 as the backup route.</p>
</li><li><p>Configure MVPN FRR on PE3, and set the detection mode to traffic-based detection.</p>
</li><li><p>Configure PIM on the PE interfaces bound to VPN instances and on the CEs' interfaces connected to PEs to allow a VPN multicast routing table to be established to guide multicast traffic forwarding.</p>
</li><li><p>Configure IGMP on the interfaces connecting a multicast device to a user network segment to allow the device to manage multicast group members on the network segment.</p>
</li></ol>
</div></div>
<div class="context"><a name="EN-US_TASK_0000001270153593__1.4.3"></a><a name="1.4.3"></a>
<div class="p"><h4 class="sectiontitle">Data Preparation</h4><p>To complete the configuration, you need the following data:</p>
<ul><li><p>IS-IS process ID of the public network: 1; OSPF process ID: 10; area ID: 0.0.0.1; OSPF multi-process ID: 2; area ID: 0.0.0.0</p>
</li><li><div class="p">VPN instance name on PE1, PE2, and PE3: VPNA; other data shown in <a href="#EN-US_TASK_0000001270153593__table_dc_vrp_cfg_ngmvpn_010101">Table 1</a>
<div class="tableBorder"><a name="EN-US_TASK_0000001270153593__table_dc_vrp_cfg_ngmvpn_010101"></a><a name="table_dc_vrp_cfg_ngmvpn_010101"></a><table cellpadding="4" cellspacing="0" summary="" rowfreeze="yes" id="EN-US_TASK_0000001270153593__table_dc_vrp_cfg_ngmvpn_010101" frame="border" border="1" rules="all"><caption><b>Table 1 </b>Data needed for each device</caption><thead align="left"><tr><th align="left" class="cellrowborder" valign="top" width="17.421731123388582%" id="mcps1.4.3.3.2.1.2.2.8.1.1" liSelected="liSelected"><p>Device</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="16.07734806629834%" id="mcps1.4.3.3.2.1.2.2.8.1.2" liSelected="liSelected"><p>Loopback 0 Interface Address</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="18.766114180478823%" id="mcps1.4.3.3.2.1.2.2.8.1.3" liSelected="liSelected"><p>MPLS LSR-ID</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="17.421731123388582%" id="mcps1.4.3.3.2.1.2.2.8.1.4" liSelected="liSelected"><p>MVPN ID</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="6.445672191528545%" id="mcps1.4.3.3.2.1.2.2.8.1.5" liSelected="liSelected"><p>RD</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="6.445672191528545%" id="mcps1.4.3.3.2.1.2.2.8.1.6" liSelected="liSelected"><p>VPN-Target</p>
</th>
<th align="left" class="cellrowborder" valign="top" width="17.421731123388582%" id="mcps1.4.3.3.2.1.2.2.8.1.7" liSelected="liSelected"><p>AS Number</p>
</th>
</tr>
</thead>
<tbody><tr><td class="cellrowborder" valign="middle" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.1 "><p>CE1</p>
</td>
<td class="cellrowborder" valign="middle" width="16.07734806629834%" headers="mcps1.4.3.3.2.1.2.2.8.1.2 "><p>1.1.1.1</p>
</td>
<td class="cellrowborder" valign="top" width="18.766114180478823%" headers="mcps1.4.3.3.2.1.2.2.8.1.3 "><p>-</p>
</td>
<td class="cellrowborder" valign="top" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.4 "><p>-</p>
</td>
<td class="cellrowborder" valign="top" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.5 "><p>-</p>
</td>
<td class="cellrowborder" valign="middle" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.6 "><p>-</p>
</td>
<td class="cellrowborder" valign="middle" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.7 "><p>AS100</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="middle" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.1 "><p>PE1</p>
</td>
<td class="cellrowborder" valign="middle" width="16.07734806629834%" headers="mcps1.4.3.3.2.1.2.2.8.1.2 "><p>2.2.2.2</p>
</td>
<td class="cellrowborder" valign="top" width="18.766114180478823%" headers="mcps1.4.3.3.2.1.2.2.8.1.3 "><p>2.2.2.2</p>
</td>
<td class="cellrowborder" valign="top" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.4 "><p>2.2.2.2</p>
</td>
<td class="cellrowborder" valign="top" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.5 "><p>200:1</p>
</td>
<td class="cellrowborder" valign="middle" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.6 "><p>3:3</p>
</td>
<td class="cellrowborder" valign="middle" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.7 "><p>AS100</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="middle" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.1 "><p>PE2</p>
</td>
<td class="cellrowborder" valign="middle" width="16.07734806629834%" headers="mcps1.4.3.3.2.1.2.2.8.1.2 "><p>3.3.3.3</p>
</td>
<td class="cellrowborder" valign="top" width="18.766114180478823%" headers="mcps1.4.3.3.2.1.2.2.8.1.3 "><p>3.3.3.3</p>
</td>
<td class="cellrowborder" valign="top" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.4 "><p>3.3.3.3</p>
</td>
<td class="cellrowborder" valign="top" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.5 "><p>300:1</p>
</td>
<td class="cellrowborder" valign="middle" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.6 "><p>3:3</p>
</td>
<td class="cellrowborder" valign="middle" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.7 "><p>AS100</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="middle" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.1 "><p>ABR1</p>
</td>
<td class="cellrowborder" valign="middle" width="16.07734806629834%" headers="mcps1.4.3.3.2.1.2.2.8.1.2 "><p>4.4.4.4</p>
</td>
<td class="cellrowborder" valign="top" width="18.766114180478823%" headers="mcps1.4.3.3.2.1.2.2.8.1.3 "><p>4.4.4.4</p>
</td>
<td class="cellrowborder" valign="top" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.4 "><p>4.4.4.4</p>
</td>
<td class="cellrowborder" valign="top" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.5 "><p>400:1</p>
</td>
<td class="cellrowborder" valign="middle" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.6 "><p>3:3</p>
</td>
<td class="cellrowborder" valign="middle" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.7 "><p>AS100</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="middle" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.1 "><p>ABR2</p>
</td>
<td class="cellrowborder" valign="middle" width="16.07734806629834%" headers="mcps1.4.3.3.2.1.2.2.8.1.2 "><p>5.5.5.5</p>
</td>
<td class="cellrowborder" valign="top" width="18.766114180478823%" headers="mcps1.4.3.3.2.1.2.2.8.1.3 "><p>5.5.5.5</p>
</td>
<td class="cellrowborder" valign="top" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.4 "><p>5.5.5.5</p>
</td>
<td class="cellrowborder" valign="top" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.5 "><p>500:1</p>
</td>
<td class="cellrowborder" valign="middle" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.6 "><p>3:3</p>
</td>
<td class="cellrowborder" valign="middle" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.7 "><p>AS100</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.1 "><p>PE3</p>
</td>
<td class="cellrowborder" valign="top" width="16.07734806629834%" headers="mcps1.4.3.3.2.1.2.2.8.1.2 "><p>6.6.6.6</p>
</td>
<td class="cellrowborder" valign="top" width="18.766114180478823%" headers="mcps1.4.3.3.2.1.2.2.8.1.3 "><p>6.6.6.6</p>
</td>
<td class="cellrowborder" valign="top" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.4 "><p>6.6.6.6</p>
</td>
<td class="cellrowborder" valign="top" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.5 "><p>600:1</p>
</td>
<td class="cellrowborder" valign="top" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.6 "><p>3:3</p>
</td>
<td class="cellrowborder" valign="top" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.7 "><p>AS100</p>
</td>
</tr>
<tr><td class="cellrowborder" valign="top" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.1 "><p>CE2</p>
</td>
<td class="cellrowborder" valign="top" width="16.07734806629834%" headers="mcps1.4.3.3.2.1.2.2.8.1.2 "><p>7.7.7.7</p>
</td>
<td class="cellrowborder" valign="top" width="18.766114180478823%" headers="mcps1.4.3.3.2.1.2.2.8.1.3 "><p>-</p>
</td>
<td class="cellrowborder" valign="top" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.4 "><p>-</p>
</td>
<td class="cellrowborder" valign="top" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.5 "><p>-</p>
</td>
<td class="cellrowborder" valign="top" width="6.445672191528545%" headers="mcps1.4.3.3.2.1.2.2.8.1.6 "><p>-</p>
</td>
<td class="cellrowborder" valign="top" width="17.421731123388582%" headers="mcps1.4.3.3.2.1.2.2.8.1.7 "><p>AS100</p>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</li></ul>
</div></div>
<div class="steps"><a name="EN-US_TASK_0000001270153593__1.4.4"></a><a name="1.4.4"></a><h4 class="sectiontitle">Procedure</h4>
<ol><li><span>Configure BGP/MPLS IP VPN.</span><ol type="a"><li class="substepexpand"><span>Assign an IP address to each interface of devices on the VPN backbone network and VPN sites.</span><p><p>Configure an IP address for each interface according to <a href="#EN-US_TASK_0000001270153593__fig_dc_vrp_cfg_ngmvpn_010101">Figure 1</a>. For configuration details, see <a href="#EN-US_TASK_0000001270153593__fig_dc_vrp_cfg_ngmvpn_010101">Figure 1</a> in this section.</p>
</p></li><li class="substepexpand"><span>Configure an IGP for interworking on the BGP/MPLS IP VPN backbone network.</span><p><p>OSPF and IS-IS are used in this example. For configuration details, see <a href="#EN-US_TASK_0000001270153593__example_dc_vrp_cfg_ngmvpn_010101">Configuration Files</a> in this section.</p>
</p></li><li class="substepexpand"><span>Configure basic MPLS functions and enable MPLS TE or MPLS LDP on the MPLS backbone network to establish MPLS TE tunnels or LDP LSPs.</span><p><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>mpls lsr-id 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>mpls te p2mp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>mpls te p2mp-template t1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-te-p2mp-template-t1] <strong>record-route label</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-te-p2mp-template-t1] <strong>bandwidth ct0 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-te-p2mp-template-t1] <strong>fast-reroute bandwidth</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-te-p2mp-template-t1] <strong>bypass-attributes bandwidth 10 priority 7 7</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-te-p2mp-template-t1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</p><p><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls lsr-id 3.3.3.3</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls] <strong>mpls te p2mp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>mpls te p2mp-template t1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-te-p2mp-template-t1] <strong>record-route label</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-te-p2mp-template-t1] <strong>bandwidth ct0 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-te-p2mp-template-t1] <strong>fast-reroute bandwidth</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-te-p2mp-template-t1] <strong>bypass-attributes bandwidth 10 priority 7 7</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-te-p2mp-template-t1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</p><p><p># Configure ABR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR1] <strong>mpls lsr-id 4.4.4.4</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR1] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-mpls] <strong>mpls te p2mp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-GigabitEthernet<span>0/1/0</span>] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-GigabitEthernet<span>0/1/0</span>] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-GigabitEthernet<span>0/1/1</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1] <strong>commit</strong></pre>
</p><p><p># Configure ABR2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR2] <strong>mpls lsr-id 5.5.5.5</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR2] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-mpls] <strong>mpls te p2mp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-GigabitEthernet<span>0/1/0</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-GigabitEthernet<span>0/1/0</span>] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-GigabitEthernet<span>0/1/0</span>] <strong>mpls rsvp-te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-GigabitEthernet<span>0/1/1</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2] <strong>commit</strong></pre>
</p><p><p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>mpls lsr-id 6.6.6.6</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-mpls] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-mpls-ldp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface gigabitethernet<span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/2</span>] <strong>mpls</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span><span>0/1/2</span></span>] <strong>mpls ldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</p></li><li class="substepexpand"><span>Establish a Multiprotocol Internal Border Gateway Protocol (MP-IBGP) peer relationship between PEs and ABRs.</span><p><ul><li><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 4.4.4.4 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 4.4.4.4 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 5.5.5.5 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>peer 5.5.5.5 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 4.4.4.4 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>peer 5.5.5.5 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</li><li><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 4.4.4.4 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 4.4.4.4 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 5.5.5.5 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>peer 5.5.5.5 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 4.4.4.4 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>peer 5.5.5.5 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</li><li><p># Configure ABR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>peer 2.2.2.2 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>peer 3.3.3.3 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>peer 3.3.3.3 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>peer 6.6.6.6 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>peer 6.6.6.6 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-vpnv4] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-vpnv4] <strong>peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-vpnv4] <strong>peer 6.6.6.6 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1] <strong>commit</strong></pre>
</li><li><p># Configure ABR2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>peer 2.2.2.2 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>peer 2.2.2.2 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>peer 3.3.3.3 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>peer 3.3.3.3 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>peer 6.6.6.6 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>peer 6.6.6.6 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-vpnv4] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-vpnv4] <strong>peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-vpnv4] <strong>peer 6.6.6.6 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2] <strong>commit</strong></pre>
</li><li><p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 4.4.4.4 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 4.4.4.4 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 5.5.5.5 as-number 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>peer 5.5.5.5 connect-interface LoopBack0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>ipv4-family vpnv4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-vpnv4] <strong>peer 4.4.4.4 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-vpnv4] <strong>peer 5.5.5.5 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-vpnv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</li></ul>
</p></li><li class="substepexpand"><span>Configure a VPN instance on the PEs and bind the VPN instance to interfaces.</span><p><ul><li><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ip vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4] <strong>route-distinguisher 200:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4] <strong>vpn-target 3:3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>ip binding vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>ip address 192.168.1.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</li><li><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ip vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4] <strong>route-distinguisher 300:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4] <strong>vpn-target 3:3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>ip binding vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>ip address 192.168.2.2 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</li><li><p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>ip vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA-af-ipv4] <strong>route-distinguisher 600:1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA-af-ipv4] <strong>vpn-target 3:3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>] <strong>ip binding vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>] <strong>ip address 192.168.3.1 24</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</li></ul>
</p></li><li class="substepexpand"><span>Configure OSPF multi-instance on each PE to import VPN routes.</span><p><ul><li><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>ospf 2 vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-2] <strong>import-route bgp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-2] <strong>area 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-2-area-0.0.0.0] <strong>network 192.168.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-2-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-ospf-2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-VPNA] <strong>import-route ospf 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</li><li><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>ospf 2 vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-2] <strong>import-route bgp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-2] <strong>area 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-2-area-0.0.0.0] <strong>network 192.168.2.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-2-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-ospf-2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-VPNA] <strong>import-route ospf 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</li><li><p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>ospf 2 vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-ospf-2] <strong>import-route bgp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-ospf-2] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-ospf-2-area-0.0.0.0] <strong>network 192.168.3.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-ospf-2-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-ospf-2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>ipv4-family vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-VPNA] <strong>import-route ospf 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</li></ul>
</p></li><li class="substepexpand"><span>Configure OSPF on each CE.</span><p><ul><li><p># Configure CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>ospf 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-ospf-2] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-ospf-2-area-0.0.0.0] <strong>network 192.168.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-ospf-2-area-0.0.0.0] <strong>network 10.1.3.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-ospf-2-area-0.0.0.0] <strong>network 1.1.1.1 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-ospf-2-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-ospf-2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1] <strong>commit</strong></pre>
</li><li><p># Configure CE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>ospf 2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-ospf-2] <strong>area 0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-ospf-2-area-0.0.0.0] <strong>network 192.168.3.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-ospf-2-area-0.0.0.0] <strong>network 10.1.4.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-ospf-2-area-0.0.0.0] <strong>network 7.7.7.7 0.0.0.0</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-ospf-2-area-0.0.0.0] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-ospf-2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2] <strong>commit</strong></pre>
</li></ul>
<p>After the preceding configurations are completed, run the <a href="cmdqueryname=display+ip+routing-table+vpn-instance+verbose"><b><span class="cmdname">display ip routing-table vpn-instance verbose</span></b></a> command on PE3. The command output shows a backup unicast route to the multicast source. Run the <a href="cmdqueryname=ping"><b><span class="cmdname">ping</span></b></a> command on CE2 to ping CE1. The command output shows that the ping operation is successful.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>display ip routing-table vpn-instance VPNA 10.1.3.0 verbose</strong></pre>
<pre class="screen"><span class="keyword">Route Flags: R - relay, D - download to fib, T - to vpn-instance, B - black hole route</span>
------------------------------------------------------------------------------
Routing Table : VPNA
Summary Count : 1

Destination: 10.1.3.0/24
     Protocol: IBGP            Process ID: 0
   Preference: 255                   Cost: 0
      NextHop: 4.4.4.4          Neighbour: 0.0.0.0
        State: Active Adv Relied      Age: 00h14m34s
          Tag: 0                 Priority: low
        Label: 32829              QoSInfo: 0x0
   IndirectID: 0xF60000B5       Instance:              
 RelayNextHop: 0.0.0.0          Interface: GigabitEthernet<span>0/1/1</span>
     TunnelID: 0x000000000300000001 Flags: RD
    <strong>BkNextHop: 5.5.5.5        BkInterface: GigabitEthernet<span>0/1/2</span></strong>
      <strong>BkLabel: 32829          SecTunnelID: 0x0</strong>
 <strong>BkPETunnelID: 0x000000000300000002 BkPESecTunnelID: 0x0</strong>
 <strong>BkIndirectID: 0xF60000B6                            </strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>ping 1.1.1.1</strong></pre>
<pre class="screen">  PING 1.1.1.1: 56  data bytes, press CTRL_C to break
    Reply from 1.1.1.1: bytes=56 Sequence=1 ttl=253 time=5 ms
    Reply from 1.1.1.1: bytes=56 Sequence=2 ttl=253 time=3 ms
    Reply from 1.1.1.1: bytes=56 Sequence=3 ttl=253 time=3 ms
    Reply from 1.1.1.1: bytes=56 Sequence=4 ttl=253 time=3 ms
    Reply from 1.1.1.1: bytes=56 Sequence=5 ttl=253 time=2 ms

  --- 1.1.1.1 ping statistics ---
    5 packet(s) transmitted
    5 packet(s) received
    0.00% packet loss
    round-trip min/avg/max = 2/3/5 ms</pre>
</p></li></ol>
</li><li><span>Establish BGP MVPN peer relationships on the PEs and ABRs.</span><p><ul><li><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>ipv4-family mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-mvpn] <strong>policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-mvpn] <strong>peer 4.4.4.4 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-mvpn] <strong>peer 5.5.5.5 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp-af-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</li><li><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>ipv4-family mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-mvpn] <strong>policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-mvpn] <strong>peer 4.4.4.4 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-mvpn] <strong>peer 5.5.5.5 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp-af-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</li><li><p># Configure ABR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR1] <strong>route-policy policy_name1 permit node 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-route-policy-rp1]<strong>apply stitch-pmsi mldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-route-policy-rp1]<strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>ipv4-family mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>reflect change-path-attribute</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>undo policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 2.2.2.2 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 3.3.3.3 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 6.6.6.6 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 6.6.6.6 route-policy policy_name1 export</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 6.6.6.6 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1] <strong>commit</strong></pre>
</li><li><p># Configure ABR2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR2] <strong>route-policy policy_name1 permit node 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-route-policy-rp1] <strong>apply stitch-pmsi mldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-route-policy-rp1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>ipv4-family mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>reflect change-path-attribute</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>undo policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 2.2.2.2 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 3.3.3.3 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 6.6.6.6 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 6.6.6.6 route-policy policy_name1 export</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 6.6.6.6 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2] <strong>commit</strong></pre>
</li><li><p># Configure PE3.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>ip ip-prefix PE1 index 10 permit 2.2.2.2 32</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>ip ip-prefix PE2 index 10 permit 3.3.3.3 32</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>ip extcommunity-list segmented-nh basic ABR1 index 10 permit 4.4.4.4:0</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>ip extcommunity-list segmented-nh basic ABR2 index 10 permit 5.5.5.5:0</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>route-policy rp1 permit node 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR1] <strong>if-match route-type mvpn 3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR1] <strong>if-match ip route-originator ip-prefix PE1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR1] <strong>if-match extcommunity-list segmented-nh ABR1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR1] <strong>apply local-preference 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>route-policy rp1 permit node 11</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR1] <strong>if-match route-type mvpn 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR1] <strong>if-match ip route-originator ip-prefix PE1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR1] <strong>if-match extcommunity-list segmented-nh ABR1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR1] <strong>apply local-preference 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR1] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>route-policy rp2 permit node 10</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR2] <strong>if-match route-type mvpn 3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR2] <strong>if-match ip route-originator ip-prefix PE2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR2] <strong>if-match extcommunity-list segmented-nh ABR2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR2] <strong>apply local-preference 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>route-policy rp2 permit node 11</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR2] <strong>if-match route-type mvpn 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR2] <strong>if-match ip route-originator ip-prefix PE2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR2] <strong>if-match extcommunity-list segmented-nh ABR2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR2] <strong>apply local-preference 200</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-route-policy-ABR2] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>ipv4-family mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-mvpn] <strong>policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-mvpn] <strong>peer 4.4.4.4 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-mvpn] <strong>peer 5.5.5.5 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-mvpn] <strong>peer 4.4.4.4 route-policy rp1 import</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-mvpn] <strong>peer 5.5.5.5 route-policy rp2 import</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-af-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</li></ul>
</p></li><li><span>Establish a BGP VPNv4 peer relationship between the ABRs.</span><p><ul><li><p># Configure ABR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR1] <strong>route-policy policy_name1 permit node 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-route-policy-rp1] <strong>apply stitch-pmsi mldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-route-policy-rp1]<strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>ipv4-family mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>reflect change-path-attribute</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>undo policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 2.2.2.2 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 3.3.3.3 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 6.6.6.6 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 6.6.6.6 route-policy policy_name1 export</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>peer 6.6.6.6 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp-af-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1] <strong>commit</strong></pre>
</li><li><p># Configure ABR2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR2] <strong>route-policy policy_name1 permit node 1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-route-policy-rp1]<strong>apply stitch-pmsi mldp</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-route-policy-rp1]<strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>ipv4-family mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>reflect change-path-attribute</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>undo policy vpn-target</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 2.2.2.2 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 2.2.2.2 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 3.3.3.3 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 3.3.3.3 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 6.6.6.6 enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 6.6.6.6 route-policy policy_name1 export</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>peer 6.6.6.6 reflect-client</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp-af-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2] <strong>commit</strong></pre>
</li></ul>
</p></li><li><span>Configure NG MVPN to support intra-AS inter-area segmented tunnels.</span><p><ul><li><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>ip vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4] <strong>mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn] <strong>inter-area-segmented enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</li><li><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>ip vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4] <strong>mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn] <strong>inter-area-segmented enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</li><li><p># Configure ABR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR1] <strong>multicast mvpn inter-area-segmented enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1] <strong>commit</strong></pre>
</li><li><p># Configure ABR2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR2] <strong>multicast mvpn inter-area-segmented enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2] <strong>commit</strong></pre>
</li></ul>
</p></li><li><span>Configure PE1, PE2, ARB1, and ABR2 to use RSVP-TE to establish I-PMSI tunnels.</span><p><ul><li><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>multicast mvpn 2.2.2.2</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>ip vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4] <strong>multicast routing-enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4] <strong>mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn] <strong>sender-enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn] <strong>ipmsi-tunnel</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi-mpls-te] <strong>p2mp-template t1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi-mpls-te] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</li><li><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>multicast mvpn 3.3.3.3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>ip vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4] <strong>multicast routing-enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4] <strong>mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn] <strong>sender-enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn] <strong>ipmsi-tunnel</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi] <strong>mpls te</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi-mpls-te] <strong>p2mp-template t1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi-mpls-te] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</li><li><p># Configure ABR1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR1] <strong>multicast mvpn 4.4.4.4</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR1] <strong>commit</strong></pre>
</li><li><p># Configure ABR2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>ABR2] <strong>multicast mvpn 5.5.5.5</strong></pre>
<pre class="screen">[<span class="keyword">*</span>ABR2] <strong>commit</strong></pre>
</li></ul>
</p></li><li><span>Configure S-PMSI tunnels on PE1 and PE2.</span><p><ul><li><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>ip vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4] <strong>mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn] <strong>spmsi-tunnel</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi-mpls-te] <strong>group 225.1.1.1 255.255.255.255 source 10.1.3.2 255.255.255.255 rsvp-te p2mp-template t1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn-spmsi-mpls-te] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-vpn-instance-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</li><li><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>ip vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4] <strong>mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn] <strong>spmsi-tunnel</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi-mpls-te] <strong>group 225.1.1.1 255.255.255.255 source 10.1.3.2 255.255.255.255 rsvp-te p2mp-template t1</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn-spmsi-mpls-te] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn-ipmsi] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-vpn-instance-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</li></ul>
</p></li><li><span>Configure VPN FRR on PE3.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>bgp 100</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>ipv4-family vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-VPNA] <strong>auto-frr</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-bgp] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</p></li><li><span>Enable C-multicast FRR on PE3.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>acl 2222</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-acl4-basic-2222] <strong>rule permit source 225.1.1.0 0.0.0.255</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-acl4-basic-2222] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>ip vpn-instance VPNA</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA] <strong>ipv4-family</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA-af-ipv4] <strong>mvpn</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA-af-ipv4-mvpn] <strong>c-multicast frr 2222</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA-af-ipv4-mvpn] <strong>c-multicast frr flow-detection-based 2222</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA-af-ipv4-mvpn] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA-af-ipv4] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-vpn-instance-VPNA] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</p></li><li><span>Configure PIM.</span><p><ul><li><p># Configure PE1.</p>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</li><li><p># Configure CE1.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>multicast routing-enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/0</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/1</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1] <strong>interface gigabitethernet<span>0/1/2</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/2</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1-GigabitEthernet<span>0/1/2</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE1] <strong>commit</strong></pre>
</li><li><p># Configure PE2.</p>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE2] <strong>commit</strong></pre>
</li><li><p># Configure PE3.</p>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE3] <strong>commit</strong></pre>
</li><li><p># Configure CE2.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>multicast routing-enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/0</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/1</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2] <strong>commit</strong></pre>
</li></ul>
</p></li><li><span>Configure IGMP.</span><p><pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>interface gigabitethernet<span>0/1/1</span></strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/1</span>] <strong>pim sm</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/1</span>] <strong>igmp enable</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/1</span>] <strong>igmp version 3</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2-GigabitEthernet<span>0/1/1</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>CE2] <strong>commit</strong></pre>
</p></li><li><span>Verify the configuration.</span><p><p>After the configurations are complete, mLDP P2MP tunnels have dual-root 1+1 protection. After users of CE2 send IGMPv3 Report messages and the multicast source at 10.1.3.2 sends multicast traffic, you can check multicast routing entries.</p>
<ul><li><p>When the links are working properly:</p>
<div class="p"># Display the PIM routing table on PE3. As dual-root 1+1 protection is configured for mLDP P2MP tunnels, the command output shows that a backup PIM entry has been generated.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>display pim vpn-instance VPNA routing-table</strong></pre>
<pre class="screen"> VPN-Instance: VPNA
 Total 0 (*, G) entry; 1 (S, G) entry

 (10.1.3.2, 225.1.1.1)
     RP: NULL
     Protocol: pim-sm, Flag: SPT ACT
     UpTime: 03:12:27
     Upstream interface: through-BGP, Refresh time: 03:12:27
         Upstream neighbor: 4.4.4.4
         RPF prime neighbor: 4.4.4.4
         <strong>Backup Upstream neighbor: 5.5.5.5</strong>
         <strong>Backup RPF prime neighbor: 5.5.5.5</strong>
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: GigabitEthernet<span>0/1/0</span>
             Protocol: pim-sm, UpTime: 03:12:27, Expires: 00:03:05 </pre>
</div>
</li><li><p>If a link fails:</p>
<div class="p"># Run the <strong>shutdown</strong> command on GE <span>0/1/0</span> of PE1 to simulate a link failure.<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1] <strong>interface gigabitethernet<span>0/1/0</span></strong></pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>shutdown</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1-GigabitEthernet<span>0/1/0</span>] <strong>quit</strong></pre>
<pre class="screen">[<span class="keyword">*</span>PE1] <strong>commit</strong></pre>
</div>
<p># Run the <a href="cmdqueryname=display+pim+routing-table"><b><span class="cmdname">display pim routing-table</span></b></a> command on receiver CE2 and sender CE1 to check their PIM routing tables. Run the <a href="cmdqueryname=display+pim+vpn-instance"><b><span class="cmdname">display pim vpn-instance</span></b></a> <strong><span>routing-table</span></strong> command on receiver PE3 and sender PE2 to check their PIM routing tables of the VPN instance.</p>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE2] <strong>display pim routing-table</strong></pre>
<pre class="screen"> VPN-Instance: public net
 Total 0 (*, G) entry; 1 (S, G) entry

 (10.1.3.2, 225.1.1.1)
     RP: NULL
     Protocol: pim-sm, Flag: SPT SG_RCVR ACT
     UpTime: 05:39:14
     Upstream interface: GigabitEthernet<span>0/1/0</span>, Refresh time: 05:39:14
         Upstream neighbor: 192.168.3.1
         RPF prime neighbor: 192.168.3.1
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: GigabitEthernet<span>0/1/1</span>
             Protocol: igmp, UpTime: 05:39:14, Expires: -  </pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE3] <strong>display pim vpn-instance VPNA routing-table</strong></pre>
<pre class="screen"> VPN-Instance: VPNA
 Total 0 (*, G) entry; 1 (S, G) entry

 (10.1.3.2, 225.1.1.1)
     RP: NULL
     Protocol: pim-sm, Flag: SPT ACT
     UpTime: 03:32:13
     Upstream interface: through-BGP, Refresh time: 03:32:13
         Upstream neighbor: 5.5.5.5
         RPF prime neighbor: 5.5.5.5
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: GigabitEthernet<span>0/1/0</span>
             Protocol: pim-sm, UpTime: 03:32:13, Expires: 00:03:19   </pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>PE2] <strong>display pim vpn-instance VPNA routing-table</strong></pre>
<pre class="screen"> VPN-Instance: VPNA
 Total 0 (*, G) entry; 1 (S, G) entry

 (10.1.3.2, 225.1.1.1)
     RP: NULL
     Protocol: pim-sm, Flag: SPT SG_RCVR ACT
     UpTime: 03:25:51
     Upstream interface: GigabitEthernet<span>0/1/1</span>, Refresh time: 03:25:51
         Upstream neighbor: 192.168.2.1
         RPF prime neighbor: 192.168.2.1
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: pseudo
             Protocol: BGP, UpTime: 03:25:51, Expires: -        </pre>
<pre class="screen">[<span class="keyword"><font style="font-size:8pt" Face="Courier New" >~</font></span>CE1] <strong>display pim routing-table</strong></pre>
<pre class="screen"> VPN-Instance: public net
 Total 0 (*, G) entry; 1 (S, G) entry

 (10.1.3.2, 225.1.1.1)
     RP: NULL
     Protocol: pim-sm, Flag: SPT LOC ACT
     UpTime: 03:35:37
     Upstream interface: GigabitEthernet<span>0/1/0</span>, Refresh time: 03:35:37
         Upstream neighbor: NULL
         RPF prime neighbor: NULL
     Downstream interface(s) information:
     Total number of downstreams: 1
        1: GigabitEthernet<span>0/1/2</span>
             Protocol: pim-sm, UpTime: 03:28:03, Expires: 00:03:28   </pre>
<p>The command outputs show that traffic exists in the backup tunnel because a backup upstream device is available. Therefore, multicast traffic in the backup tunnel can be forwarded to receivers immediately after the primary tunnel fault is detected through multicast traffic-based detection.</p>
</li></ul>
</p></li></ol></div>
<div class="example" id="EN-US_TASK_0000001270153593__example_dc_vrp_cfg_ngmvpn_010101"><a name="EN-US_TASK_0000001270153593__example_dc_vrp_cfg_ngmvpn_010101"></a><a name="example_dc_vrp_cfg_ngmvpn_010101"></a><a name="EN-US_TASK_0000001270153593__1.4.5"></a><a name="1.4.5"></a><h4 class="sectiontitle">Configuration Files</h4><ul><li><p>CE1 configuration file</p>
<pre class="screen">#
sysname CE1
#
multicast routing-enable
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.3.1 255.255.255.0
 pim sm
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 192.168.1.1 255.255.255.0
 pim sm
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 192.168.2.1 255.255.255.0
 pim sm
#
interface LoopBack0
 ip address 1.1.1.1 255.255.255.255
#
ospf 2
 area 0.0.0.0
  network 1.1.1.1 0.0.0.0
  network 10.1.3.0 0.0.0.255
  network 192.168.1.0 0.0.0.255
  network 192.168.2.0 0.0.0.255
#
return</pre>
</li><li><p>PE1 configuration file</p>
<pre class="screen">#
sysname PE1
#
multicast mvpn 2.2.2.2
#
ip vpn-instance VPNA
 ipv4-family
  route-distinguisher 200:1
  apply-label per-instance
  vpn-target 3:3 export-extcommunity
  vpn-target 3:3 import-extcommunity
  multicast routing-enable
  mvpn
   sender-enable
   c-multicast signaling bgp
   inter-area-segmented enable
   ipmsi-tunnel
    mpls-te
     p2mp-template t1
   spmsi-tunnel
    group 225.1.1.1 255.255.255.255 source 10.1.3.2 255.255.255.255 rsvp-te p2mp-template t1
#
mpls lsr-id 2.2.2.2
#
mpls
 mpls te
 mpls te p2mp-te
 mpls rsvp-te
 mpls te cspf
#
mpls te p2mp-template t1
 record-route label
 bandwidth ct0 100
 fast-reroute bandwidth
 bypass-attributes bandwidth 10 priority 7 7
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.15.2 255.255.255.0
 ospf enable 10 area 0.0.0.1
 mpls
 mpls te
 mpls rsvp-te
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 10.0.7.1 255.255.255.0
 ospf enable 10 area 0.0.0.1
 mpls
 mpls te
 mpls rsvp-te
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip binding vpn-instance VPNA
 ip address 192.168.1.2 255.255.255.0
 pim sm
#
interface LoopBack0
 ip address 2.2.2.2 255.255.255.255
 ospf enable 10 area 0.0.0.1
#
bgp 100
 peer 4.4.4.4 as-number 100
 peer 4.4.4.4 connect-interface LoopBack0
 peer 5.5.5.5 as-number 100
 peer 5.5.5.5 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo synchronization
  peer 4.4.4.4 enable
  peer 5.5.5.5 enable
 #
 ipv4-family mvpn
  policy vpn-target
  peer 4.4.4.4 enable
  peer 5.5.5.5 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 4.4.4.4 enable
  peer 5.5.5.5 enable
 #
 ipv4-family vpn-instance VPNA
  import-route ospf 2
#
ospf 2 vpn-instance VPNA
 import-route bgp
 area 0.0.0.0
  network 192.168.1.0 0.0.0.255
#
ospf 10
 opaque-capability enable
 area 0.0.0.1
  mpls-te enable
#
return</pre>
</li><li><p>ABR1 configuration file</p>
<pre class="screen">#
sysname ABR1
#
multicast mvpn 4.4.4.4
#
multicast mvpn inter-area-segmented enable
#
mpls lsr-id 4.4.4.4
#
mpls
 mpls te
 mpls te p2mp-te
 mpls rsvp-te
 mpls te cspf
 lsp-trigger all
#
mpls ldp
 mldp p2mp
 #
 ipv4-family
#
isis 1
 is-level level-2
 network-entity 46.0006.0006.0004.00
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.15.1 255.255.255.0
 ospf enable 10 area 0.0.0.1
 mpls
 mpls te
 mpls rsvp-te
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 10.1.1.1 255.255.255.0
 isis enable 1
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 10.1.7.3 255.255.255.0
 ospf enable 10 area 0.0.0.1
 mpls
 mpls te
 mpls rsvp-te
#
interface LoopBack0
 ip address 4.4.4.4 255.255.255.255
 ospf enable 10 area 0.0.0.1
 isis enable 1
#
bgp 100
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack0
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack0
 peer 6.6.6.6 as-number 100
 peer 6.6.6.6 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 2.2.2.2 enable
  peer 2.2.2.2 reflect-client
  peer 3.3.3.3 enable
  peer 3.3.3.3 reflect-client
  peer 6.6.6.6 enable
  peer 6.6.6.6 reflect-client
 #
 ipv4-family mvpn
  reflect change-path-attribute
  undo policy vpn-target
  peer 2.2.2.2 enable
  peer 2.2.2.2 reflect-client
  peer 3.3.3.3 enable
  peer 3.3.3.3 reflect-client
  peer 6.6.6.6 enable
  peer 6.6.6.6 route-policy policy_name1 export
  peer 6.6.6.6 reflect-client
 #
 ipv4-family vpnv4
  undo policy vpn-target
  peer 2.2.2.2 enable
  peer 2.2.2.2 reflect-client
  peer 2.2.2.2 next-hop-local
  peer 3.3.3.3 enable
  peer 3.3.3.3 reflect-client
  peer 3.3.3.3 next-hop-local
  peer 6.6.6.6 enable
  peer 6.6.6.6 reflect-client
  peer 6.6.6.6 next-hop-local
#
ospf 10
 opaque-capability enable
 area 0.0.0.1
  mpls-te enable
#
route-policy policy_name1 permit node 1
 apply stitch-pmsi mldp
#
ip ip-prefix 1 index 10 permit 2.2.2.2 32
#
return</pre>
</li><li><p>PE2 configuration file</p>
<pre class="screen">#
sysname PE2
#
multicast mvpn 3.3.3.3
#
ip vpn-instance VPNA
 ipv4-family
  route-distinguisher 300:1
  apply-label per-instance
  vpn-target 3:3 export-extcommunity
  vpn-target 3:3 import-extcommunity
  multicast routing-enable
  mvpn
   sender-enable
   c-multicast signaling bgp
   inter-area-segmented enable
   ipmsi-tunnel
    mpls-te
     p2mp-template t1
   spmsi-tunnel
    group 225.1.1.1 255.255.255.255 source 10.1.3.2 255.255.255.255 rsvp-te p2mp-template t1
#
mpls lsr-id 3.3.3.3
#
mpls
 mpls te
 mpls te p2mp-te
 mpls rsvp-te
 mpls te cspf
#
mpls te p2mp-template t1
 record-route label
 bandwidth ct0 100
 fast-reroute bandwidth
 bypass-attributes bandwidth 10 priority 7 7
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.16.2 255.255.255.0
 ospf enable 10 area 0.0.0.1
 mpls
 mpls te
 mpls rsvp-te
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 10.1.7.1 255.255.255.0
 ospf enable 10 area 0.0.0.1
 mpls
 mpls te
 mpls rsvp-te
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip binding vpn-instance VPNA
 ip address 192.168.2.2 255.255.255.0
 pim sm
#
interface LoopBack0
 ip address 3.3.3.3 255.255.255.255
 ospf enable 10 area 0.0.0.1
#
bgp 100
 peer 4.4.4.4 as-number 100
 peer 4.4.4.4 connect-interface LoopBack0
 peer 5.5.5.5 as-number 100
 peer 5.5.5.5 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo synchronization
  peer 4.4.4.4 enable
  peer 5.5.5.5 enable
 #
 ipv4-family mvpn
  policy vpn-target
  peer 5.5.5.5 enable
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 4.4.4.4 enable
  peer 5.5.5.5 enable
 #
 ipv4-family vpn-instance VPNA
  import-route ospf 2
#
ospf 2 vpn-instance VPNA
 import-route bgp
 area 0.0.0.0
  network 192.168.2.0 0.0.0.255
#
ospf 10
 opaque-capability enable
 area 0.0.0.1
  mpls-te enable
#
return</pre>
</li><li><p>ABR2 configuration file</p>
<pre class="screen">#
sysname ABR2
#
multicast mvpn 5.5.5.5
#
multicast mvpn inter-area-segmented enable
mpls lsr-id 5.5.5.5
#
mpls
 mpls te
 mpls te p2mp-te
 mpls rsvp-te
 mpls te cspf
 lsp-trigger all
#
mpls ldp
 mldp p2mp
 #
 ipv4-family
#
isis 1
 is-level level-2
 network-entity 46.0006.0006.0005.00
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 10.1.16.1 255.255.255.0
 ospf enable 10 area 0.0.0.1
 mpls
 mpls te
 mpls rsvp-te
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 10.1.2.1 255.255.255.0
 isis enable 1
 mpls
 mpls ldp
#
interface GigabitEthernet<span><span>0/1/2</span></span>
 undo shutdown
 ip address 10.0.7.3 255.255.255.0
 ospf enable 10 area 0.0.0.1
 mpls
 mpls te
 mpls rsvp-te
#
interface LoopBack0
 ip address 5.5.5.5 255.255.255.255
 ospf enable 10 area 0.0.0.1
 isis enable 1
#
bgp 100
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack0
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack0
 peer 6.6.6.6 as-number 100
 peer 6.6.6.6 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo synchronization
  import-route direct
  peer 2.2.2.2 enable
  peer 2.2.2.2 reflect-client
  peer 3.3.3.3 enable
  peer 3.3.3.3 reflect-client
  peer 6.6.6.6 enable
  peer 6.6.6.6 reflect-client
 #
 ipv4-family mvpn
  reflect change-path-attribute
  undo policy vpn-target
  peer 2.2.2.2 enable
  peer 2.2.2.2 reflect-client
  peer 3.3.3.3 enable
  peer 3.3.3.3 reflect-client
  peer 6.6.6.6 enable
  peer 6.6.6.6 route-policy policy_name1 export
  peer 6.6.6.6 reflect-client
 #
 ipv4-family vpnv4
  undo policy vpn-target
  peer 2.2.2.2 enable
  peer 2.2.2.2 reflect-client
  peer 2.2.2.2 next-hop-local
  peer 3.3.3.3 enable
  peer 3.3.3.3 reflect-client
  peer 3.3.3.3 next-hop-local
  peer 6.6.6.6 enable
  peer 6.6.6.6 reflect-client
  peer 6.6.6.6 next-hop-local
#
ospf 10
 opaque-capability enable
 area 0.0.0.1
  mpls-te enable
#
route-policy policy_name1 permit node 1
 apply stitch-pmsi mldp
#
ip ip-prefix 1 index 10 permit 3.3.3.3 32
#
return</pre>
</li><li><p>PE3 configuration file</p>
<pre class="screen">#
sysname PE3
#
multicast mvpn 6.6.6.6
#
ip vpn-instance VPNA
 ipv4-family
  route-distinguisher 600:1
  apply-label per-instance
  vpn-target 3:3 export-extcommunity
  vpn-target 3:3 import-extcommunity
  multicast routing-enable
  mvpn
   c-multicast signaling bgp
   c-multicast frr 2222
   c-multicast frr flow-detection-based 2222
#
acl 2222
 rule permit source 225.1.1.0 0.0.0.255
#
mpls lsr-id 6.6.6.6
#
mpls
#
mpls ldp
 mldp p2mp
#
isis 1
 is-level level-2
 cost-style wide
 network-entity 46.0006.0006.0006.00
 traffic-eng level-1-2
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip binding vpn-instance VPNA
 ip address 192.168.3.1 255.255.255.0
 pim sm
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 10.1.1.2 255.255.255.0
 isis enable 1
 mpls
 mpls ldp
#
interface GigabitEthernet<span>0/1/2</span>
 undo shutdown
 ip address 10.1.2.2 255.255.255.0
 isis enable 1
 mpls
 mpls ldp
#
interface LoopBack0
 ip address 6.6.6.6 255.255.255.255
 isis enable 1
#
bgp 100
 peer 4.4.4.4 as-number 100
 peer 4.4.4.4 connect-interface LoopBack0
 peer 5.5.5.5 as-number 100
 peer 5.5.5.5 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo synchronization
  peer 4.4.4.4 enable
  peer 5.5.5.5 enable
 #
 ipv4-family mvpn
  policy vpn-target
  peer 4.4.4.4 enable
  peer 4.4.4.4 route-policy rp1 import
  peer 5.5.5.5 enable
  peer 5.5.5.5 route-policy rp2 import
 #
 ipv4-family vpnv4
  policy vpn-target
  peer 4.4.4.4 enable
  peer 5.5.5.5 enable
 #
 ipv4-family vpn-instance VPNA
  import-route isis 1
  import-route ospf 2
  auto-frr
#
ospf 2 vpn-instance VPNA
 import-route bgp
 area 0.0.0.0
  network 192.168.3.0 0.0.0.255
#
route-policy rp1 permit node 10
 if-match route-type mvpn 3
 if-match ip route-originator ip-prefix PE1
 if-match extcommunity-list segmented-nh ABR1
 apply local-preference 200
#
route-policy rp1 permit node 11
 if-match route-type mvpn 1
 if-match ip route-originator ip-prefix PE1
 if-match extcommunity-list segmented-nh ABR1
 apply local-preference 200
#
route-policy rp2 permit node 10
 if-match route-type mvpn 3
 if-match ip route-originator ip-prefix PE2
 if-match extcommunity-list segmented-nh ABR2
 apply local-preference 200
#
route-policy rp2 permit node 11
 if-match route-type mvpn 1
 if-match ip route-originator ip-prefix PE2
 if-match extcommunity-list segmented-nh ABR2
 apply local-preference 200
#
ip ip-prefix PE1 index 10 permit 2.2.2.2 32
ip ip-prefix PE2 index 10 permit 3.3.3.3 32
ip extcommunity-list segmented-nh basic ABR1 index 10 permit 4.4.4.4:0
ip extcommunity-list segmented-nh basic ABR2 index 10 permit 5.5.5.5:0
#
return</pre>
</li><li><p>CE2 configuration file</p>
<pre class="screen">#
sysname CE2
#
multicast routing-enable
#
interface GigabitEthernet<span>0/1/0</span>
 undo shutdown
 ip address 192.168.3.2 255.255.255.0
 pim sm
#
interface GigabitEthernet<span>0/1/1</span>
 undo shutdown
 ip address 10.1.4.1 255.255.255.0
 pim sm
 igmp enable
 igmp version 3
 igmp static-group 225.1.1.1 source 10.1.3.2
#
interface LoopBack0
 ip address 7.7.7.7 255.255.255.255
#
ospf 2
 area 0.0.0.0
  network 7.7.7.7 0.0.0.0
  network 10.1.4.0 0.0.0.255
  network 192.168.3.0 0.0.0.255
#
return</pre>
</li></ul>
</div>
</div>

</div>
<div class="footerNavBar clearfix">

<div class="parentlink">
Parent Topic:
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0012.html">Configuration Examples for NG MVPN
</a>
</div>
<div class="copyrightBottomBar">
Copyright &copy; Huawei Technologies Co., Ltd.</div>
<div class="bottomNavBtn clearfix">
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0104.html"><span class="font-st">&lt; </span>Previous topic</a>
<a href="../../../../software/nev8r10_vrpv8r16/user/vrp/dc_vrp_cfg_ngmvpn_0073.html">Next topic<span class="font-st"> &gt;</span></a>
</div>
</div>

<script language="JavaScript">
<!--
image_size('.imgResize');
var msg_imageMax = "view original image";
var msg_imageClose = "close";
//--></script></body>
</html>